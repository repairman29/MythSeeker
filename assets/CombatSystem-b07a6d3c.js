import{j as e}from"./index-a1795f7b.js";import{r as s}from"./react-vendor-132e4a4f.js";import{N as t,$ as i,a0 as l,J as a,Z as n,d as r}from"./ui-vendor-c80f9872.js";import"./firebase-auth-7a9d2df2.js";import"./firebase-core-a7cb50f5.js";import"./firebase-firestore-e3da4556.js";import"./firebase-database-b022e4c6.js";import"./firebase-functions-7c25f05b.js";function o(e,s,t){let i=e.x,l=e.y,a=s.x,n=s.y;const r=Math.abs(a-i),o=Math.abs(n-l),c=i<a?1:-1,d=l<n?1:-1;let x=r-o;for(;i!==a||l!==n;){if("wall"===t.tiles[l][i].type||t.tiles[l][i].cover>=2)return!1;const e=2*x;e>-o&&(x-=o,i+=c),e<r&&(x+=r,l+=d)}return!0}function c(e,s,t){return t.tiles[e.y][e.x].cover}function d(e,s){const t=s.tiles[e.y][e.x];return"difficult"===t.type?2:"hazard"===t.type?3:1}const x=({combatants:x,battleMap:h,currentTurn:u,activeCombatantId:m,onAction:p,onEndCombat:b,isPlayerTurn:v})=>{const[f,j]=s.useState(null),[y,g]=s.useState(null),[w,N]=s.useState(null),[k,C]=s.useState(null),[$,M]=s.useState([]),[S,z]=s.useState([]);s.useState(!1);const[A,E]=s.useState(null),P=x.find(e=>e.id===m),H=s.useCallback(e=>{if(!e||e.currentActionPoints.move<=0)return[];const s=[],t=new Set,i=[{x:e.position.x,y:e.position.y,cost:0}];for(;i.length>0;){const l=i.shift(),a=`${l.x},${l.y}`;if(!t.has(a)&&(t.add(a),l.cost<=e.currentActionPoints.move)){s.push({x:l.x,y:l.y});const e=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const s of e){const e=l.x+s.dx,t=l.y+s.dy;if(e>=0&&e<h.width&&t>=0&&t<h.height){const s=h.tiles[t][e];if("wall"!==s.type&&!s.occupied){const a="difficult"===s.type?2:1;i.push({x:e,y:t,cost:l.cost+a})}}}}}return s},[h]),T=s.useCallback((e,s)=>{const t=[],i=s?e.skills[s]:null,l=(null==i?void 0:i.range)||e.reach;for(let a=0;a<h.height;a++)for(let s=0;s<h.width;s++)if(Math.abs(s-e.position.x)+Math.abs(a-e.position.y)<=l&&x.find(t=>t.position.x===s&&t.position.y===a&&t.id!==e.id)&&o(e.position,{x:s,y:a},h)){const i=c({x:s,y:a},e.position,h);t.push({x:s,y:a,cover:i})}return t},[x,h]);s.useEffect(()=>{P&&"move"===w?M(H(P)):!P||"attack"!==w&&"skill"!==w?(M([]),z([])):z(T(P,k||void 0))},[P,w,k,H,T]);const F=(e,s)=>{const t=h.tiles[s][e];let i="w-8 h-8 border border-gray-600 cursor-pointer transition-all relative";if((null==y?void 0:y.x)===e&&(null==y?void 0:y.y)===s)i+=" bg-blue-400/50";else if($.some(t=>t.x===e&&t.y===s))i+=" bg-green-400/30";else if(S.some(t=>t.x===e&&t.y===s))i+=" bg-red-400/30";else switch(t.type){case"floor":i+=" bg-gray-700";break;case"wall":i+=" bg-gray-900";break;case"difficult":i+=" bg-yellow-700";break;case"hazard":i+=" bg-red-700"}if("cover"===A&&t.cover>0)i+=` bg-orange-${1===t.cover?400:700}/30`;else if("elevation"===A&&t.elevation>0)i+=` bg-purple-${Math.min(20*t.elevation,60)}/30`;else if("movement"===A){const t=d({x:e,y:s},h);t>1&&(i+=` bg-yellow-${2===t?400:700}/30`)}return i},I=(e,s)=>{const t=h.tiles[s][e],i=x.find(t=>t.position.x===e&&t.position.y===s),l=[];l.push(`Tile: ${t.type}`),t.elevation>0&&l.push(`Elevation: +${t.elevation}`),t.cover>0&&l.push("Cover: "+(1===t.cover?"Partial":"Full"));const a=d({x:e,y:s},h);if(a>1&&l.push(`Movement Cost: ${a}`),i&&(l.push(`\n${i.name} (${i.type})`),l.push(`Health: ${i.health}/${i.maxHealth}`),l.push(`AC: ${i.stats.armorClass}`),P&&P.id!==i.id)){const t=o(P.position,{x:e,y:s},h),i=c({x:e,y:s},P.position,h),a=function(e,s,t){return t.tiles[e.y][e.x].elevation>t.tiles[s.y][s.x].elevation}({x:e,y:s},P.position,h);l.push("\nTactical:"),l.push("Line of Sight: "+(t?"Yes":"No")),i>0&&l.push("Cover from you: "+(1===i?"Partial":"Full")),a&&l.push("High Ground")}return l.join("\n")},G=e=>"player"===e.type?"ðŸ‘¤":"enemy"===e.type?"ðŸ‘¹":"ðŸ¤–";return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"bg-black/30 border-b border-white/20 p-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-white",children:[e.jsxs("h3",{className:"text-lg font-bold",children:["Combat - Turn ",u]}),P&&e.jsxs("p",{className:"text-blue-200",children:[P.name,"'s turn",!v&&" (AI thinking...)"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsxs("button",{onClick:()=>E("cover"===A?null:"cover"),className:`px-2 py-1 rounded text-xs flex items-center space-x-1 ${"cover"===A?"bg-orange-600 text-white hover:bg-orange-700":"bg-white/20 text-white hover:bg-white/30"} transition-all`,title:"Show Cover",children:[e.jsx(t,{size:12}),e.jsx("span",{children:"Cover"})]}),e.jsxs("button",{onClick:()=>E("elevation"===A?null:"elevation"),className:`px-2 py-1 rounded text-xs flex items-center space-x-1 ${"elevation"===A?"bg-purple-600 text-white hover:bg-purple-700":"bg-white/20 text-white hover:bg-white/30"} transition-all`,title:"Show Elevation",children:[e.jsx(i,{size:12}),e.jsx("span",{children:"Height"})]}),e.jsxs("button",{onClick:()=>E("movement"===A?null:"movement"),className:`px-2 py-1 rounded text-xs flex items-center space-x-1 ${"movement"===A?"bg-yellow-600 text-white hover:bg-yellow-700":"bg-white/20 text-white hover:bg-white/30"} transition-all`,title:"Show Movement Cost",children:[e.jsx(l,{size:12}),e.jsx("span",{children:"Move"})]})]}),e.jsx("button",{onClick:b,className:"px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-all",children:"End Combat"})]})]})}),e.jsxs("div",{className:"flex-1 flex",children:[e.jsx("div",{className:"flex-1 p-4",children:e.jsxs("div",{className:"bg-black/20 rounded-lg p-4 relative",children:[e.jsx("div",{className:"grid gap-1",style:{gridTemplateColumns:`repeat(${h.width}, 1fr)`,width:"fit-content"},children:h.tiles.map((s,t)=>s.map((s,i)=>e.jsxs("div",{className:F(i,t),onClick:()=>((e,s)=>{P&&v&&("move"===w&&$.some(t=>t.x===e&&t.y===s)?(p({type:"move",target:{x:e,y:s},path:[{x:P.position.x,y:P.position.y},{x:e,y:s}]}),N(null)):"attack"!==w&&"skill"!==w||!S.some(t=>t.x===e&&t.y===s)||(p({type:"attack"===w?"attack":"skill",target:{x:e,y:s},skillId:k||void 0}),N(null),C(null)))})(i,t),onMouseEnter:()=>g({x:i,y:t}),onMouseLeave:()=>g(null),title:I(i,t),children:[x.map(s=>s.position.x===i&&s.position.y===t?e.jsxs("div",{className:`w-full h-full flex items-center justify-center text-lg cursor-pointer relative ${s.id===m?"ring-2 ring-yellow-400":""} ${s.health<=0?"opacity-50":""}`,onClick:()=>(e=>{j(e)})(s),children:[G(s),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-black/50",children:e.jsx("div",{className:"h-full bg-green-500",style:{width:s.health/s.maxHealth*100+"%"}})}),s.statusEffects.length>0&&e.jsx("div",{className:"absolute -top-1 right-1 w-3 h-3 bg-red-500 rounded-full text-xs flex items-center justify-center text-white",children:s.statusEffects.length})]},s.id):null),A&&e.jsxs("div",{className:"absolute top-0 right-0 text-xs",children:["cover"===A&&s.cover>0&&e.jsx("div",{className:"bg-orange-500/30 text-white px-1 rounded",children:s.cover}),"elevation"===A&&s.elevation>0&&e.jsxs("div",{className:"bg-purple-500/30 text-white px-1 rounded",children:["+",s.elevation]}),"movement"===A&&d({x:i,y:t},h)>1&&e.jsx("div",{className:"bg-yellow-500/30 text-black px-1 rounded",children:d({x:i,y:t},h)})]})]},`${i}-${t}`)))}),A&&e.jsx("div",{className:"absolute top-2 right-2 bg-black/80 text-white text-xs p-2 rounded",children:e.jsxs("div",{className:"font-semibold mb-1",children:["cover"===A&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-3 h-3 border border-orange-500"}),e.jsx("span",{children:"Partial Cover"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-3 h-3 border border-orange-700"}),e.jsx("span",{children:"Full Cover"})]})]}),"elevation"===A&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-3 h-3 border border-purple-500"}),e.jsx("span",{children:"High Ground"})]}),"movement"===A&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-3 h-3 border border-yellow-500"}),e.jsx("span",{children:"Difficult Terrain"})]})]})})]})}),e.jsx("div",{className:"w-80 bg-black/20 border-l border-white/20 p-4",children:P&&v?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white/10 rounded-lg p-3",children:[e.jsx("h4",{className:"text-white font-semibold",children:P.name}),e.jsxs("div",{className:"text-sm text-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(a,{size:14}),e.jsxs("span",{children:["Health: ",P.health,"/",P.maxHealth]})]}),void 0!==P.mana&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{size:14}),e.jsxs("span",{children:["Mana: ",P.mana,"/",P.maxMana]})]}),e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(l,{size:14}),e.jsxs("span",{children:["Move: ",P.currentActionPoints.move]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(r,{size:14}),e.jsxs("span",{children:["Action: ",P.currentActionPoints.action]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(n,{size:14}),e.jsxs("span",{children:["Bonus: ",P.currentActionPoints.bonus]})]})]}),P.statusEffects.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-yellow-200 font-semibold",children:"Status Effects:"}),P.statusEffects.map((s,t)=>e.jsxs("div",{className:"text-xs text-red-200",children:[s.name," (",s.duration," turns)"]},t))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>N("move"),disabled:P.currentActionPoints.move<=0,className:`w-full px-3 py-2 rounded flex items-center space-x-2 ${"move"===w?"bg-blue-600 text-white":"bg-white/20 text-white hover:bg-white/30"} disabled:opacity-50 disabled:cursor-not-allowed transition-all`,children:[e.jsx(l,{size:16}),e.jsx("span",{children:"Move"})]}),e.jsxs("button",{onClick:()=>N("attack"),disabled:P.currentActionPoints.action<=0,className:`w-full px-3 py-2 rounded flex items-center space-x-2 ${"attack"===w?"bg-red-600 text-white":"bg-white/20 text-white hover:bg-white/30"} disabled:opacity-50 disabled:cursor-not-allowed transition-all`,children:[e.jsx(r,{size:16}),e.jsx("span",{children:"Attack"})]}),e.jsxs("button",{onClick:()=>N("skill"),disabled:P.currentActionPoints.action<=0,className:`w-full px-3 py-2 rounded flex items-center space-x-2 ${"skill"===w?"bg-purple-600 text-white":"bg-white/20 text-white hover:bg-white/30"} disabled:opacity-50 disabled:cursor-not-allowed transition-all`,children:[e.jsx(n,{size:16}),e.jsx("span",{children:"Skills"})]})]}),"skill"===w&&e.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:Object.entries(P.skills).map(([s,t])=>e.jsxs("button",{onClick:()=>C(s),className:`w-full text-left px-2 py-1 rounded text-sm ${k===s?"bg-purple-600 text-white":"bg-white/10 text-white hover:bg-white/20"} transition-all`,children:[e.jsx("div",{className:"font-semibold",children:t.name}),e.jsx("div",{className:"text-xs text-blue-200",children:t.description}),t.range&&e.jsxs("div",{className:"text-xs text-green-200",children:["Range: ",t.range]})]},s))}),e.jsx("button",{onClick:()=>{p({type:"end-turn"}),N(null),C(null)},className:"w-full px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-all",children:"End Turn"})]}):e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"}),e.jsx("p",{children:"Waiting for turn..."})]})})]})]})};export{x as default};
