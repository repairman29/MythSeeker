var e=Object.defineProperty,t=(t,n,i)=>(((t,n,i)=>{n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i})(t,"symbol"!=typeof n?n+"":n,i),i);import{r as n,a as i,R as s,b as a,c as r}from"./react-vendor-132e4a4f.js";import{g as o,G as l,s as c,a as h,b as u,c as d,o as p,_ as m,d as f}from"./firebase-auth-65c9b6ac.js";import{V as g,r as v,_ as x,C as y,c as b,E as _,F as w,W as S,b as M,e as T,l as E,p as C,f as N,X as A,Y as R,Z as j,$ as P}from"./firebase-core-80358ff0.js";import{g as I,s as D,d as k,a as L,u as O,b as U,c as F,q as z,w as B,e as V,f as H,h as W,o as G,i as q,j as $,l as X}from"./firebase-firestore-2d82c905.js";import{g as Y,r as K,s as Z,o as J,a as Q,p as ee,u as te,b as ne}from"./firebase-database-a6432f11.js";import{S as ie,A as se,T as ae,U as re,C as oe,a as le,b as ce,c as he,d as ue,e as de,R as pe,H as me,f as fe,X as ge,Z as ve,g as xe,F as ye,G as be,h as _e,B as we,i as Se,j as Me,k as Te,P as Ee,l as Ce,m as Ne,n as Ae,o as Re,p as je,q as Pe,r as Ie,s as De,t as ke,u as Le,v as Oe,L as Ue,M as Fe,w as ze,x as Be,y as Ve,z as He,D as We,E as Ge,I as qe,J as $e,K as Xe,N as Ye,O as Ke,Q as Ze,V as Je,W as Qe,Y as et,_ as tt,$ as nt,a0 as it}from"./ui-vendor-91fe8cc7.js";import{getFunctions as st,httpsCallable as at}from"./firebase-functions-0bfb6d35.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var rt={exports:{}},ot={},lt=n,ct=Symbol.for("react.element"),ht=Symbol.for("react.fragment"),ut=Object.prototype.hasOwnProperty,dt=lt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,pt={key:!0,ref:!0,__self:!0,__source:!0};function mt(e,t,n){var i,s={},a=null,r=null;for(i in void 0!==n&&(a=""+n),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(r=t.ref),t)ut.call(t,i)&&!pt.hasOwnProperty(i)&&(s[i]=t[i]);if(e&&e.defaultProps)for(i in t=e.defaultProps)void 0===s[i]&&(s[i]=t[i]);return{$$typeof:ct,type:e,key:a,ref:r,props:s,_owner:dt.current}}ot.Fragment=ht,ot.jsx=mt,ot.jsxs=mt,rt.exports=ot;var ft=rt.exports,gt={},vt=i;gt.createRoot=vt.createRoot,gt.hydrateRoot=vt.hydrateRoot;const xt={},yt=function(e,t,n){if(!t||0===t.length)return e();const i=document.getElementsByTagName("link");return Promise.all(t.map(e=>{if((e=function(e){return"/"+e}(e))in xt)return;xt[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(n)for(let n=i.length-1;n>=0;n--){const s=i[n];if(s.href===e&&(!t||"stylesheet"===s.rel))return}else if(document.querySelector(`link[href="${e}"]${s}`))return;const a=document.createElement("link");return a.rel=t?"stylesheet":"modulepreload",t||(a.as="script",a.crossOrigin=""),a.href=e,document.head.appendChild(a),t?new Promise((t,n)=>{a.addEventListener("load",t),a.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0})).then(()=>e()).catch(e=>{const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e})};var bt={};Object.defineProperty(bt,"__esModule",{value:!0}),bt.parse=function(e,t){const n=new Et,i=e.length;if(i<2)return n;const s=(null==t?void 0:t.decode)||At;let a=0;do{const t=e.indexOf("=",a);if(-1===t)break;const r=e.indexOf(";",a),o=-1===r?i:r;if(t>o){a=e.lastIndexOf(";",t-1)+1;continue}const l=Ct(e,a,t),c=Nt(e,t,l),h=e.slice(l,c);if(void 0===n[h]){let i=Ct(e,t+1,o),a=Nt(e,o,i);const r=s(e.slice(i,a));n[h]=r}a=o+1}while(a<i);return n},bt.serialize=function(e,t,n){const i=(null==n?void 0:n.encode)||encodeURIComponent;if(!_t.test(e))throw new TypeError(`argument name is invalid: ${e}`);const s=i(t);if(!wt.test(s))throw new TypeError(`argument val is invalid: ${t}`);let a=e+"="+s;if(!n)return a;if(void 0!==n.maxAge){if(!Number.isInteger(n.maxAge))throw new TypeError(`option maxAge is invalid: ${n.maxAge}`);a+="; Max-Age="+n.maxAge}if(n.domain){if(!St.test(n.domain))throw new TypeError(`option domain is invalid: ${n.domain}`);a+="; Domain="+n.domain}if(n.path){if(!Mt.test(n.path))throw new TypeError(`option path is invalid: ${n.path}`);a+="; Path="+n.path}if(n.expires){if(!function(e){return"[object Date]"===Tt.call(e)}(n.expires)||!Number.isFinite(n.expires.valueOf()))throw new TypeError(`option expires is invalid: ${n.expires}`);a+="; Expires="+n.expires.toUTCString()}if(n.httpOnly&&(a+="; HttpOnly"),n.secure&&(a+="; Secure"),n.partitioned&&(a+="; Partitioned"),n.priority)switch("string"==typeof n.priority?n.priority.toLowerCase():void 0){case"low":a+="; Priority=Low";break;case"medium":a+="; Priority=Medium";break;case"high":a+="; Priority=High";break;default:throw new TypeError(`option priority is invalid: ${n.priority}`)}if(n.sameSite)switch("string"==typeof n.sameSite?n.sameSite.toLowerCase():n.sameSite){case!0:case"strict":a+="; SameSite=Strict";break;case"lax":a+="; SameSite=Lax";break;case"none":a+="; SameSite=None";break;default:throw new TypeError(`option sameSite is invalid: ${n.sameSite}`)}return a};const _t=/^[\u0021-\u003A\u003C\u003E-\u007E]+$/,wt=/^[\u0021-\u003A\u003C-\u007E]*$/,St=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i,Mt=/^[\u0020-\u003A\u003D-\u007E]*$/,Tt=Object.prototype.toString,Et=(()=>{const e=function(){};return e.prototype=Object.create(null),e})();function Ct(e,t,n){do{const n=e.charCodeAt(t);if(32!==n&&9!==n)return t}while(++t<n);return n}function Nt(e,t,n){for(;t>n;){const n=e.charCodeAt(--t);if(32!==n&&9!==n)return t+1}return n}function At(e){if(-1===e.indexOf("%"))return e;try{return decodeURIComponent(e)}catch(t){return e}}var Rt="popstate";function jt(e,t){if(!1===e||null==e)throw new Error(t)}function Pt(e,t){if(!e)try{throw new Error(t)}catch(n){}}function It(e,t){return{usr:e.state,key:e.key,idx:t}}function Dt(e,t,n=null,i){return{pathname:"string"==typeof e?e:e.pathname,search:"",hash:"",..."string"==typeof t?Lt(t):t,state:n,key:t&&t.key||i||Math.random().toString(36).substring(2,10)}}function kt({pathname:e="/",search:t="",hash:n=""}){return t&&"?"!==t&&(e+="?"===t.charAt(0)?t:"?"+t),n&&"#"!==n&&(e+="#"===n.charAt(0)?n:"#"+n),e}function Lt(e){let t={};if(e){let n=e.indexOf("#");n>=0&&(t.hash=e.substring(n),e=e.substring(0,n));let i=e.indexOf("?");i>=0&&(t.search=e.substring(i),e=e.substring(0,i)),e&&(t.pathname=e)}return t}function Ot(e,t,n="/"){return function(e,t,n){let i=Zt(("string"==typeof t?Lt(t):t).pathname||"/",n);if(null==i)return null;let s=Ut(e);!function(e){e.sort((e,t)=>e.score!==t.score?t.score-e.score:function(e,t){return e.length===t.length&&e.slice(0,-1).every((e,n)=>e===t[n])?e[e.length-1]-t[t.length-1]:0}(e.routesMeta.map(e=>e.childrenIndex),t.routesMeta.map(e=>e.childrenIndex)))}(s);let a=null;for(let r=0;null==a&&r<s.length;++r){let e=Kt(i);a=Xt(s[r],e,false)}return a}(e,t,n)}function Ut(e,t=[],n=[],i=""){let s=(e,s,a)=>{let r={relativePath:void 0===a?e.path||"":a,caseSensitive:!0===e.caseSensitive,childrenIndex:s,route:e};r.relativePath.startsWith("/")&&(jt(r.relativePath.startsWith(i),`Absolute route path "${r.relativePath}" nested under path "${i}" is not valid. An absolute child route path must start with the combined path of all its parent routes.`),r.relativePath=r.relativePath.slice(i.length));let o=tn([i,r.relativePath]),l=n.concat(r);e.children&&e.children.length>0&&(jt(!0!==e.index,`Index routes must not have child routes. Please remove all child routes from route path "${o}".`),Ut(e.children,t,l,o)),(null!=e.path||e.index)&&t.push({path:o,score:$t(o,e.index),routesMeta:l})};return e.forEach((e,t)=>{var n;if(""!==e.path&&(null==(n=e.path)?void 0:n.includes("?")))for(let i of Ft(e.path))s(e,t,i);else s(e,t)}),t}function Ft(e){let t=e.split("/");if(0===t.length)return[];let[n,...i]=t,s=n.endsWith("?"),a=n.replace(/\?$/,"");if(0===i.length)return s?[a,""]:[a];let r=Ft(i.join("/")),o=[];return o.push(...r.map(e=>""===e?a:[a,e].join("/"))),s&&o.push(...r),o.map(t=>e.startsWith("/")&&""===t?"/":t)}var zt=/^:[\w-]+$/,Bt=3,Vt=2,Ht=1,Wt=10,Gt=-2,qt=e=>"*"===e;function $t(e,t){let n=e.split("/"),i=n.length;return n.some(qt)&&(i+=Gt),t&&(i+=Vt),n.filter(e=>!qt(e)).reduce((e,t)=>e+(zt.test(t)?Bt:""===t?Ht:Wt),i)}function Xt(e,t,n=!1){let{routesMeta:i}=e,s={},a="/",r=[];for(let o=0;o<i.length;++o){let e=i[o],l=o===i.length-1,c="/"===a?t:t.slice(a.length)||"/",h=Yt({path:e.relativePath,caseSensitive:e.caseSensitive,end:l},c),u=e.route;if(!h&&l&&n&&!i[i.length-1].route.index&&(h=Yt({path:e.relativePath,caseSensitive:e.caseSensitive,end:!1},c)),!h)return null;Object.assign(s,h.params),r.push({params:s,pathname:tn([a,h.pathname]),pathnameBase:nn(tn([a,h.pathnameBase])),route:u}),"/"!==h.pathnameBase&&(a=tn([a,h.pathnameBase]))}return r}function Yt(e,t){"string"==typeof e&&(e={path:e,caseSensitive:!1,end:!0});let[n,i]=function(e,t=!1,n=!0){Pt("*"===e||!e.endsWith("*")||e.endsWith("/*"),`Route path "${e}" will be treated as if it were "${e.replace(/\*$/,"/*")}" because the \`*\` character must always follow a \`/\` in the pattern. To get rid of this warning, please change the route path to "${e.replace(/\*$/,"/*")}".`);let i=[],s="^"+e.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(e,t,n)=>(i.push({paramName:t,isOptional:null!=n}),n?"/?([^\\/]+)?":"/([^\\/]+)"));return e.endsWith("*")?(i.push({paramName:"*"}),s+="*"===e||"/*"===e?"(.*)$":"(?:\\/(.+)|\\/*)$"):n?s+="\\/*$":""!==e&&"/"!==e&&(s+="(?:(?=\\/|$))"),[new RegExp(s,t?void 0:"i"),i]}(e.path,e.caseSensitive,e.end),s=t.match(n);if(!s)return null;let a=s[0],r=a.replace(/(.)\/+$/,"$1"),o=s.slice(1);return{params:i.reduce((e,{paramName:t,isOptional:n},i)=>{if("*"===t){let e=o[i]||"";r=a.slice(0,a.length-e.length).replace(/(.)\/+$/,"$1")}const s=o[i];return e[t]=n&&!s?void 0:(s||"").replace(/%2F/g,"/"),e},{}),pathname:a,pathnameBase:r,pattern:e}}function Kt(e){try{return e.split("/").map(e=>decodeURIComponent(e).replace(/\//g,"%2F")).join("/")}catch(t){return Pt(!1,`The URL path "${e}" could not be decoded because it is a malformed URL segment. This is probably due to a bad percent encoding (${t}).`),e}}function Zt(e,t){if("/"===t)return e;if(!e.toLowerCase().startsWith(t.toLowerCase()))return null;let n=t.endsWith("/")?t.length-1:t.length,i=e.charAt(n);return i&&"/"!==i?null:e.slice(n)||"/"}function Jt(e,t,n,i){return`Cannot include a '${e}' character in a manually specified \`to.${t}\` field [${JSON.stringify(i)}].  Please separate it out to the \`to.${n}\` field. Alternatively you may provide the full path as a string in <Link to="..."> and the router will parse it for you.`}function Qt(e){let t=function(e){return e.filter((e,t)=>0===t||e.route.path&&e.route.path.length>0)}(e);return t.map((e,n)=>n===t.length-1?e.pathname:e.pathnameBase)}function en(e,t,n,i=!1){let s;"string"==typeof e?s=Lt(e):(s={...e},jt(!s.pathname||!s.pathname.includes("?"),Jt("?","pathname","search",s)),jt(!s.pathname||!s.pathname.includes("#"),Jt("#","pathname","hash",s)),jt(!s.search||!s.search.includes("#"),Jt("#","search","hash",s)));let a,r=""===e||""===s.pathname,o=r?"/":s.pathname;if(null==o)a=n;else{let e=t.length-1;if(!i&&o.startsWith("..")){let t=o.split("/");for(;".."===t[0];)t.shift(),e-=1;s.pathname=t.join("/")}a=e>=0?t[e]:"/"}let l=function(e,t="/"){let{pathname:n,search:i="",hash:s=""}="string"==typeof e?Lt(e):e,a=n?n.startsWith("/")?n:function(e,t){let n=t.replace(/\/+$/,"").split("/");return e.split("/").forEach(e=>{".."===e?n.length>1&&n.pop():"."!==e&&n.push(e)}),n.length>1?n.join("/"):"/"}(n,t):t;return{pathname:a,search:sn(i),hash:an(s)}}(s,a),c=o&&"/"!==o&&o.endsWith("/"),h=(r||"."===o)&&n.endsWith("/");return l.pathname.endsWith("/")||!c&&!h||(l.pathname+="/"),l}var tn=e=>e.join("/").replace(/\/\/+/g,"/"),nn=e=>e.replace(/\/+$/,"").replace(/^\/*/,"/"),sn=e=>e&&"?"!==e?e.startsWith("?")?e:"?"+e:"",an=e=>e&&"#"!==e?e.startsWith("#")?e:"#"+e:"",rn=["POST","PUT","PATCH","DELETE"];new Set(rn);var on=["GET",...rn];new Set(on);var ln=n.createContext(null);ln.displayName="DataRouter";var cn=n.createContext(null);cn.displayName="DataRouterState";var hn=n.createContext({isTransitioning:!1});hn.displayName="ViewTransition",n.createContext(new Map).displayName="Fetchers",n.createContext(null).displayName="Await";var un=n.createContext(null);un.displayName="Navigation";var dn=n.createContext(null);dn.displayName="Location";var pn=n.createContext({outlet:null,matches:[],isDataRoute:!1});pn.displayName="Route";var mn=n.createContext(null);function fn(){return null!=n.useContext(dn)}function gn(){return jt(fn(),"useLocation() may be used only in the context of a <Router> component."),n.useContext(dn).location}mn.displayName="RouteError";var vn="You should call navigate() in a React.useEffect(), not when your component is first rendered.";function xn(e){n.useContext(un).static||n.useLayoutEffect(e)}function yn(){let{isDataRoute:e}=n.useContext(pn);return e?function(){let{router:e}=function(){let e=n.useContext(ln);return jt(e,En("useNavigate")),e}(),t=Cn("useNavigate"),i=n.useRef(!1);return xn(()=>{i.current=!0}),n.useCallback(async(n,s={})=>{Pt(i.current,vn),i.current&&("number"==typeof n?e.navigate(n):await e.navigate(n,{fromRouteId:t,...s}))},[e,t])}():function(){jt(fn(),"useNavigate() may be used only in the context of a <Router> component.");let e=n.useContext(ln),{basename:t,navigator:i}=n.useContext(un),{matches:s}=n.useContext(pn),{pathname:a}=gn(),r=JSON.stringify(Qt(s)),o=n.useRef(!1);return xn(()=>{o.current=!0}),n.useCallback((n,s={})=>{if(Pt(o.current,vn),!o.current)return;if("number"==typeof n)return void i.go(n);let l=en(n,JSON.parse(r),a,"path"===s.relative);null==e&&"/"!==t&&(l.pathname="/"===l.pathname?t:tn([t,l.pathname])),(s.replace?i.replace:i.push)(l,s.state,s)},[t,i,r,a,e])}()}function bn(e,{relative:t}={}){let{matches:i}=n.useContext(pn),{pathname:s}=gn(),a=JSON.stringify(Qt(i));return n.useMemo(()=>en(e,JSON.parse(a),s,"path"===t),[e,a,s,t])}function _n(e,t,i,s){var a;jt(fn(),"useRoutes() may be used only in the context of a <Router> component.");let{navigator:r}=n.useContext(un),{matches:o}=n.useContext(pn),l=o[o.length-1],c=l?l.params:{},h=l?l.pathname:"/",u=l?l.pathnameBase:"/",d=l&&l.route;{let e=d&&d.path||"";An(h,!d||e.endsWith("*")||e.endsWith("*?"),`You rendered descendant <Routes> (or called \`useRoutes()\`) at "${h}" (under <Route path="${e}">) but the parent route path has no trailing "*". This means if you navigate deeper, the parent won't match anymore and therefore the child routes will never render.\n\nPlease change the parent <Route path="${e}"> to <Route path="${"/"===e?"*":`${e}/*`}">.`)}let p,m=gn();if(t){let e="string"==typeof t?Lt(t):t;jt("/"===u||(null==(a=e.pathname)?void 0:a.startsWith(u)),`When overriding the location using \`<Routes location>\` or \`useRoutes(routes, location)\`, the location pathname must begin with the portion of the URL pathname that was matched by all parent routes. The current pathname base is "${u}" but pathname "${e.pathname}" was given in the \`location\` prop.`),p=e}else p=m;let f=p.pathname||"/",g=f;if("/"!==u){let e=u.replace(/^\//,"").split("/");g="/"+f.replace(/^\//,"").split("/").slice(e.length).join("/")}let v=Ot(e,{pathname:g});Pt(d||null!=v,`No routes matched location "${p.pathname}${p.search}${p.hash}" `),Pt(null==v||void 0!==v[v.length-1].route.element||void 0!==v[v.length-1].route.Component||void 0!==v[v.length-1].route.lazy,`Matched leaf route at location "${p.pathname}${p.search}${p.hash}" does not have an element or Component. This means it will render an <Outlet /> with a null value by default resulting in an "empty" page.`);let x=function(e,t=[],i=null){if(null==e){if(!i)return null;if(i.errors)e=i.matches;else{if(0!==t.length||i.initialized||!(i.matches.length>0))return null;e=i.matches}}let s=e,a=null==i?void 0:i.errors;if(null!=a){let e=s.findIndex(e=>e.route.id&&void 0!==(null==a?void 0:a[e.route.id]));jt(e>=0,`Could not find a matching route for errors on route IDs: ${Object.keys(a).join(",")}`),s=s.slice(0,Math.min(s.length,e+1))}let r=!1,o=-1;if(i)for(let n=0;n<s.length;n++){let e=s[n];if((e.route.HydrateFallback||e.route.hydrateFallbackElement)&&(o=n),e.route.id){let{loaderData:t,errors:n}=i,a=e.route.loader&&!t.hasOwnProperty(e.route.id)&&(!n||void 0===n[e.route.id]);if(e.route.lazy||a){r=!0,s=o>=0?s.slice(0,o+1):[s[0]];break}}}return s.reduceRight((e,l,c)=>{let h,u=!1,d=null,p=null;i&&(h=a&&l.route.id?a[l.route.id]:void 0,d=l.route.errorElement||Sn,r&&(o<0&&0===c?(An("route-fallback",!1,"No `HydrateFallback` element provided to render during initial hydration"),u=!0,p=null):o===c&&(u=!0,p=l.route.hydrateFallbackElement||null)));let m=t.concat(s.slice(0,c+1)),f=()=>{let t;return t=h?d:u?p:l.route.Component?n.createElement(l.route.Component,null):l.route.element?l.route.element:e,n.createElement(Tn,{match:l,routeContext:{outlet:e,matches:m,isDataRoute:null!=i},children:t})};return i&&(l.route.ErrorBoundary||l.route.errorElement||0===c)?n.createElement(Mn,{location:i.location,revalidation:i.revalidation,component:d,error:h,children:f(),routeContext:{outlet:null,matches:m,isDataRoute:!0}}):f()},null)}(v&&v.map(e=>Object.assign({},e,{params:Object.assign({},c,e.params),pathname:tn([u,r.encodeLocation?r.encodeLocation(e.pathname).pathname:e.pathname]),pathnameBase:"/"===e.pathnameBase?u:tn([u,r.encodeLocation?r.encodeLocation(e.pathnameBase).pathname:e.pathnameBase])})),o,i);return t&&x?n.createElement(dn.Provider,{value:{location:{pathname:"/",search:"",hash:"",state:null,key:"default",...p},navigationType:"POP"}},x):x}function wn(){let e=function(){var e;let t=n.useContext(mn),i=function(){let e=n.useContext(cn);return jt(e,En("useRouteError")),e}(),s=Cn("useRouteError");return void 0!==t?t:null==(e=i.errors)?void 0:e[s]}(),t=function(e){return null!=e&&"number"==typeof e.status&&"string"==typeof e.statusText&&"boolean"==typeof e.internal&&"data"in e}(e)?`${e.status} ${e.statusText}`:e instanceof Error?e.message:JSON.stringify(e),i=e instanceof Error?e.stack:null,s="rgba(200,200,200, 0.5)",a={padding:"0.5rem",backgroundColor:s},r={padding:"2px 4px",backgroundColor:s},o=null;return o=n.createElement(n.Fragment,null,n.createElement("p",null,"💿 Hey developer 👋"),n.createElement("p",null,"You can provide a way better UX than this when your app throws errors by providing your own ",n.createElement("code",{style:r},"ErrorBoundary")," or"," ",n.createElement("code",{style:r},"errorElement")," prop on your route.")),n.createElement(n.Fragment,null,n.createElement("h2",null,"Unexpected Application Error!"),n.createElement("h3",{style:{fontStyle:"italic"}},t),i?n.createElement("pre",{style:a},i):null,o)}n.createContext(null);var Sn=n.createElement(wn,null),Mn=class extends n.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||"idle"!==t.revalidation&&"idle"===e.revalidation?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:void 0!==e.error?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){}render(){return void 0!==this.state.error?n.createElement(pn.Provider,{value:this.props.routeContext},n.createElement(mn.Provider,{value:this.state.error,children:this.props.component})):this.props.children}};function Tn({routeContext:e,match:t,children:i}){let s=n.useContext(ln);return s&&s.static&&s.staticContext&&(t.route.errorElement||t.route.ErrorBoundary)&&(s.staticContext._deepestRenderedBoundaryId=t.route.id),n.createElement(pn.Provider,{value:e},i)}function En(e){return`${e} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}function Cn(e){let t=function(e){let t=n.useContext(pn);return jt(t,En(e)),t}(e),i=t.matches[t.matches.length-1];return jt(i.route.id,`${e} can only be used on routes that contain a unique "id"`),i.route.id}var Nn={};function An(e,t,n){t||Nn[e]||(Nn[e]=!0,Pt(!1,n))}function Rn({to:e,replace:t,state:i,relative:s}){jt(fn(),"<Navigate> may be used only in the context of a <Router> component.");let{static:a}=n.useContext(un);Pt(!a,"<Navigate> must not be used on the initial render in a <StaticRouter>. This is a no-op, but you should modify your code so the <Navigate> is only ever rendered in response to some user interaction or state change.");let{matches:r}=n.useContext(pn),{pathname:o}=gn(),l=yn(),c=en(e,Qt(r),o,"path"===s),h=JSON.stringify(c);return n.useEffect(()=>{l(JSON.parse(h),{replace:t,state:i,relative:s})},[l,h,s,t,i]),null}function jn(e){jt(!1,"A <Route> is only ever to be used as the child of <Routes> element, never rendered directly. Please wrap your <Route> in a <Routes>.")}function Pn({basename:e="/",children:t=null,location:i,navigationType:s="POP",navigator:a,static:r=!1}){jt(!fn(),"You cannot render a <Router> inside another <Router>. You should never have more than one in your app.");let o=e.replace(/^\/*/,"/"),l=n.useMemo(()=>({basename:o,navigator:a,static:r,future:{}}),[o,a,r]);"string"==typeof i&&(i=Lt(i));let{pathname:c="/",search:h="",hash:u="",state:d=null,key:p="default"}=i,m=n.useMemo(()=>{let e=Zt(c,o);return null==e?null:{location:{pathname:e,search:h,hash:u,state:d,key:p},navigationType:s}},[o,c,h,u,d,p,s]);return Pt(null!=m,`<Router basename="${o}"> is not able to match the URL "${c}${h}${u}" because it does not start with the basename, so the <Router> won't render anything.`),null==m?null:n.createElement(un.Provider,{value:l},n.createElement(dn.Provider,{children:t,value:m}))}function In({children:e,location:t}){return _n(Dn(e),t)}function Dn(e,t=[]){let i=[];return n.Children.forEach(e,(e,s)=>{if(!n.isValidElement(e))return;let a=[...t,s];if(e.type===n.Fragment)return void i.push.apply(i,Dn(e.props.children,a));jt(e.type===jn,`[${"string"==typeof e.type?e.type:e.type.name}] is not a <Route> component. All component children of <Routes> must be a <Route> or <React.Fragment>`),jt(!e.props.index||!e.props.children,"An index route cannot have child routes.");let r={id:e.props.id||a.join("-"),caseSensitive:e.props.caseSensitive,element:e.props.element,Component:e.props.Component,index:e.props.index,path:e.props.path,loader:e.props.loader,action:e.props.action,hydrateFallbackElement:e.props.hydrateFallbackElement,HydrateFallback:e.props.HydrateFallback,errorElement:e.props.errorElement,ErrorBoundary:e.props.ErrorBoundary,hasErrorBoundary:!0===e.props.hasErrorBoundary||null!=e.props.ErrorBoundary||null!=e.props.errorElement,shouldRevalidate:e.props.shouldRevalidate,handle:e.props.handle,lazy:e.props.lazy};e.props.children&&(r.children=Dn(e.props.children,a)),i.push(r)}),i}n.memo(function({routes:e,future:t,state:n}){return _n(e,void 0,n)});var kn="get",Ln="application/x-www-form-urlencoded";function On(e){return null!=e&&"string"==typeof e.tagName}var Un=null,Fn=new Set(["application/x-www-form-urlencoded","multipart/form-data","text/plain"]);function zn(e){return null==e||Fn.has(e)?e:(Pt(!1,`"${e}" is not a valid \`encType\` for \`<Form>\`/\`<fetcher.Form>\` and will default to "${Ln}"`),null)}function Bn(e,t){if(!1===e||null==e)throw new Error(t)}function Vn(e){return null!=e&&(null==e.href?"preload"===e.rel&&"string"==typeof e.imageSrcSet&&"string"==typeof e.imageSizes:"string"==typeof e.rel&&"string"==typeof e.href)}function Hn(e,t,n,i,s,a){let r=(e,t)=>!n[t]||e.route.id!==n[t].route.id,o=(e,t)=>{var i;return n[t].pathname!==e.pathname||(null==(i=n[t].route.path)?void 0:i.endsWith("*"))&&n[t].params["*"]!==e.params["*"]};return"assets"===a?t.filter((e,t)=>r(e,t)||o(e,t)):"data"===a?t.filter((t,a)=>{var l;let c=i.routes[t.route.id];if(!c||!c.hasLoader)return!1;if(r(t,a)||o(t,a))return!0;if(t.route.shouldRevalidate){let i=t.route.shouldRevalidate({currentUrl:new URL(s.pathname+s.search+s.hash,window.origin),currentParams:(null==(l=n[0])?void 0:l.params)||{},nextUrl:new URL(e,window.origin),nextParams:t.params,defaultShouldRevalidate:!0});if("boolean"==typeof i)return i}return!0}):[]}function Wn(){let e=n.useContext(ln);return Bn(e,"You must render this element inside a <DataRouterContext.Provider> element"),e}Object.getOwnPropertyNames(Object.prototype).sort().join("\0");var Gn=n.createContext(void 0);function qn(){let e=n.useContext(Gn);return Bn(e,"You must render this element inside a <HydratedRouter> element"),e}function $n(e,t){return n=>{e&&e(n),n.defaultPrevented||t(n)}}function Xn({page:e,...t}){let{router:i}=Wn(),s=n.useMemo(()=>Ot(i.routes,e,i.basename),[i.routes,e,i.basename]);return s?n.createElement(Yn,{page:e,matches:s,...t}):null}function Yn({page:e,matches:t,...i}){let s=gn(),{manifest:a,routeModules:r}=qn(),{basename:o}=Wn(),{loaderData:l,matches:c}=function(){let e=n.useContext(cn);return Bn(e,"You must render this element inside a <DataRouterStateContext.Provider> element"),e}(),h=n.useMemo(()=>Hn(e,t,c,a,s,"data"),[e,t,c,a,s]),u=n.useMemo(()=>Hn(e,t,c,a,s,"assets"),[e,t,c,a,s]),d=n.useMemo(()=>{if(e===s.pathname+s.search+s.hash)return[];let n=new Set,i=!1;if(t.forEach(e=>{var t;let s=a.routes[e.route.id];s&&s.hasLoader&&(!h.some(t=>t.route.id===e.route.id)&&e.route.id in l&&(null==(t=r[e.route.id])?void 0:t.shouldRevalidate)||s.hasClientLoader?i=!0:n.add(e.route.id))}),0===n.size)return[];let c=function(e,t){let n="string"==typeof e?new URL(e,"undefined"==typeof window?"server://singlefetch/":window.location.origin):e;return"/"===n.pathname?n.pathname="_root.data":t&&"/"===Zt(n.pathname,t)?n.pathname=`${t.replace(/\/$/,"")}/_root.data`:n.pathname=`${n.pathname.replace(/\/$/,"")}.data`,n}(e,o);return i&&n.size>0&&c.searchParams.set("_routes",t.filter(e=>n.has(e.route.id)).map(e=>e.route.id).join(",")),[c.pathname+c.search]},[o,l,s,a,h,t,e,r]),p=n.useMemo(()=>function(e,t,{includeHydrateFallback:n}={}){return i=e.map(e=>{let i=t.routes[e.route.id];if(!i)return[];let s=[i.module];return i.clientActionModule&&(s=s.concat(i.clientActionModule)),i.clientLoaderModule&&(s=s.concat(i.clientLoaderModule)),n&&i.hydrateFallbackModule&&(s=s.concat(i.hydrateFallbackModule)),i.imports&&(s=s.concat(i.imports)),s}).flat(1),[...new Set(i)];var i}(u,a),[u,a]),m=function(e){let{manifest:t,routeModules:i}=qn(),[s,a]=n.useState([]);return n.useEffect(()=>{let n=!1;return async function(e,t,n){return function(e,t){let n=new Set;return new Set(t),e.reduce((e,t)=>{let i=JSON.stringify(function(e){let t={},n=Object.keys(e).sort();for(let i of n)t[i]=e[i];return t}(t));return n.has(i)||(n.add(i),e.push({key:i,link:t})),e},[])}((await Promise.all(e.map(async e=>{let i=t.routes[e.route.id];if(i){let e=await async function(e,t){if(e.id in t)return t[e.id];try{let n=await yt(()=>import(e.module),[]);return t[e.id]=n,n}catch(n){return window.__reactRouterContext&&window.__reactRouterContext.isSpaMode,window.location.reload(),new Promise(()=>{})}}(i,n);return e.links?e.links():[]}return[]}))).flat(1).filter(Vn).filter(e=>"stylesheet"===e.rel||"preload"===e.rel).map(e=>"stylesheet"===e.rel?{...e,rel:"prefetch",as:"style"}:{...e,rel:"prefetch"}))}(e,t,i).then(e=>{n||a(e)}),()=>{n=!0}},[e,t,i]),s}(u);return n.createElement(n.Fragment,null,d.map(e=>n.createElement("link",{key:e,rel:"prefetch",as:"fetch",href:e,...i})),p.map(e=>n.createElement("link",{key:e,rel:"modulepreload",href:e,...i})),m.map(({key:e,link:t})=>n.createElement("link",{key:e,...t})))}function Kn(...e){return t=>{e.forEach(e=>{"function"==typeof e?e(t):null!=e&&(e.current=t)})}}Gn.displayName="FrameworkContext";var Zn="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement;try{Zn&&(window.__reactRouterVersion="7.6.3")}catch($T){}function Jn({basename:e,children:t,window:i}){let s=n.useRef();null==s.current&&(s.current=function(e={}){return function(e,t,n,i={}){let{window:s=document.defaultView,v5Compat:a=!1}=i,r=s.history,o="POP",l=null,c=h();function h(){return(r.state||{idx:null}).idx}function u(){o="POP";let e=h(),t=null==e?null:e-c;c=e,l&&l({action:o,location:p.location,delta:t})}function d(e){return function(e,t=!1){let n="http://localhost";"undefined"!=typeof window&&(n="null"!==window.location.origin?window.location.origin:window.location.href),jt(n,"No window.location.(origin|href) available to create URL");let i="string"==typeof e?e:kt(e);return i=i.replace(/ $/,"%20"),!t&&i.startsWith("//")&&(i=n+i),new URL(i,n)}(e)}null==c&&(c=0,r.replaceState({...r.state,idx:c},""));let p={get action(){return o},get location(){return e(s,r)},listen(e){if(l)throw new Error("A history only accepts one active listener");return s.addEventListener(Rt,u),l=e,()=>{s.removeEventListener(Rt,u),l=null}},createHref:e=>t(s,e),createURL:d,encodeLocation(e){let t=d(e);return{pathname:t.pathname,search:t.search,hash:t.hash}},push:function(e,t){o="PUSH";let i=Dt(p.location,e,t);n&&n(i,e),c=h()+1;let u=It(i,c),d=p.createHref(i);try{r.pushState(u,"",d)}catch(m){if(m instanceof DOMException&&"DataCloneError"===m.name)throw m;s.location.assign(d)}a&&l&&l({action:o,location:p.location,delta:1})},replace:function(e,t){o="REPLACE";let i=Dt(p.location,e,t);n&&n(i,e),c=h();let s=It(i,c),u=p.createHref(i);r.replaceState(s,"",u),a&&l&&l({action:o,location:p.location,delta:0})},go:e=>r.go(e)};return p}(function(e,t){let{pathname:n,search:i,hash:s}=e.location;return Dt("",{pathname:n,search:i,hash:s},t.state&&t.state.usr||null,t.state&&t.state.key||"default")},function(e,t){return"string"==typeof t?t:kt(t)},null,e)}({window:i,v5Compat:!0}));let a=s.current,[r,o]=n.useState({action:a.action,location:a.location}),l=n.useCallback(e=>{n.startTransition(()=>o(e))},[o]);return n.useLayoutEffect(()=>a.listen(l),[a,l]),n.createElement(Pn,{basename:e,children:t,location:r.location,navigationType:r.action,navigator:a})}var Qn=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,ei=n.forwardRef(function({onClick:e,discover:t="render",prefetch:i="none",relative:s,reloadDocument:a,replace:r,state:o,target:l,to:c,preventScrollReset:h,viewTransition:u,...d},p){let m,{basename:f}=n.useContext(un),g="string"==typeof c&&Qn.test(c),v=!1;if("string"==typeof c&&g&&(m=c,Zn))try{let e=new URL(window.location.href),t=c.startsWith("//")?new URL(e.protocol+c):new URL(c),n=Zt(t.pathname,f);t.origin===e.origin&&null!=n?c=n+t.search+t.hash:v=!0}catch($T){Pt(!1,`<Link to="${c}"> contains an invalid URL which will probably break when clicked - please update to a valid URL path.`)}let x=function(e,{relative:t}={}){jt(fn(),"useHref() may be used only in the context of a <Router> component.");let{basename:i,navigator:s}=n.useContext(un),{hash:a,pathname:r,search:o}=bn(e,{relative:t}),l=r;return"/"!==i&&(l="/"===r?i:tn([i,r])),s.createHref({pathname:l,search:o,hash:a})}(c,{relative:s}),[y,b,_]=function(e,t){let i=n.useContext(Gn),[s,a]=n.useState(!1),[r,o]=n.useState(!1),{onFocus:l,onBlur:c,onMouseEnter:h,onMouseLeave:u,onTouchStart:d}=t,p=n.useRef(null);n.useEffect(()=>{if("render"===e&&o(!0),"viewport"===e){let e=new IntersectionObserver(e=>{e.forEach(e=>{o(e.isIntersecting)})},{threshold:.5});return p.current&&e.observe(p.current),()=>{e.disconnect()}}},[e]),n.useEffect(()=>{if(s){let e=setTimeout(()=>{o(!0)},100);return()=>{clearTimeout(e)}}},[s]);let m=()=>{a(!0)},f=()=>{a(!1),o(!1)};return i?"intent"!==e?[r,p,{}]:[r,p,{onFocus:$n(l,m),onBlur:$n(c,f),onMouseEnter:$n(h,m),onMouseLeave:$n(u,f),onTouchStart:$n(d,m)}]:[!1,p,{}]}(i,d),w=function(e,{target:t,replace:i,state:s,preventScrollReset:a,relative:r,viewTransition:o}={}){let l=yn(),c=gn(),h=bn(e,{relative:r});return n.useCallback(n=>{if(function(e,t){return!(0!==e.button||t&&"_self"!==t||function(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}(e))}(n,t)){n.preventDefault();let t=void 0!==i?i:kt(c)===kt(h);l(e,{replace:t,state:s,preventScrollReset:a,relative:r,viewTransition:o})}},[c,l,h,i,s,t,e,a,r,o])}(c,{replace:r,state:o,target:l,preventScrollReset:h,relative:s,viewTransition:u}),S=n.createElement("a",{...d,..._,href:m||x,onClick:v||a?e:function(t){e&&e(t),t.defaultPrevented||w(t)},ref:Kn(p,b),target:l,"data-discover":g||"render"!==t?void 0:"true"});return y&&!g?n.createElement(n.Fragment,null,S,n.createElement(Xn,{page:x})):S});function ti(e){let t=n.useContext(ln);return jt(t,function(e){return`${e} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}(e)),t}ei.displayName="Link",n.forwardRef(function({"aria-current":e="page",caseSensitive:t=!1,className:i="",end:s=!1,style:a,to:r,viewTransition:o,children:l,...c},h){let u=bn(r,{relative:c.relative}),d=gn(),p=n.useContext(cn),{navigator:m,basename:f}=n.useContext(un),g=null!=p&&function(e,t={}){let i=n.useContext(hn);jt(null!=i,"`useViewTransitionState` must be used within `react-router-dom`'s `RouterProvider`.  Did you accidentally import `RouterProvider` from `react-router`?");let{basename:s}=ti("useViewTransitionState"),a=bn(e,{relative:t.relative});if(!i.isTransitioning)return!1;let r=Zt(i.currentLocation.pathname,s)||i.currentLocation.pathname,o=Zt(i.nextLocation.pathname,s)||i.nextLocation.pathname;return null!=Yt(a.pathname,o)||null!=Yt(a.pathname,r)}(u)&&!0===o,v=m.encodeLocation?m.encodeLocation(u).pathname:u.pathname,x=d.pathname,y=p&&p.navigation&&p.navigation.location?p.navigation.location.pathname:null;t||(x=x.toLowerCase(),y=y?y.toLowerCase():null,v=v.toLowerCase()),y&&f&&(y=Zt(y,f)||y);const b="/"!==v&&v.endsWith("/")?v.length-1:v.length;let _,w=x===v||!s&&x.startsWith(v)&&"/"===x.charAt(b),S=null!=y&&(y===v||!s&&y.startsWith(v)&&"/"===y.charAt(v.length)),M={isActive:w,isPending:S,isTransitioning:g},T=w?e:void 0;_="function"==typeof i?i(M):[i,w?"active":null,S?"pending":null,g?"transitioning":null].filter(Boolean).join(" ");let E="function"==typeof a?a(M):a;return n.createElement(ei,{...c,"aria-current":T,className:_,ref:h,style:E,to:r,viewTransition:o},"function"==typeof l?l(M):l)}).displayName="NavLink",n.forwardRef(({discover:e="render",fetcherKey:t,navigate:i,reloadDocument:s,replace:a,state:r,method:o=kn,action:l,onSubmit:c,relative:h,preventScrollReset:u,viewTransition:d,...p},m)=>{let f=function(){let{router:e}=ti("useSubmit"),{basename:t}=n.useContext(un),i=Cn("useRouteId");return n.useCallback(async(n,s={})=>{let{action:a,method:r,encType:o,formData:l,body:c}=function(e,t){let n,i,s,a,r;if(On(o=e)&&"form"===o.tagName.toLowerCase()){let r=e.getAttribute("action");i=r?Zt(r,t):null,n=e.getAttribute("method")||kn,s=zn(e.getAttribute("enctype"))||Ln,a=new FormData(e)}else if(function(e){return On(e)&&"button"===e.tagName.toLowerCase()}(e)||function(e){return On(e)&&"input"===e.tagName.toLowerCase()}(e)&&("submit"===e.type||"image"===e.type)){let r=e.form;if(null==r)throw new Error('Cannot submit a <button> or <input type="submit"> without a <form>');let o=e.getAttribute("formaction")||r.getAttribute("action");if(i=o?Zt(o,t):null,n=e.getAttribute("formmethod")||r.getAttribute("method")||kn,s=zn(e.getAttribute("formenctype"))||zn(r.getAttribute("enctype"))||Ln,a=new FormData(r,e),!function(){if(null===Un)try{new FormData(document.createElement("form"),0),Un=!1}catch($T){Un=!0}return Un}()){let{name:t,type:n,value:i}=e;if("image"===n){let e=t?`${t}.`:"";a.append(`${e}x`,"0"),a.append(`${e}y`,"0")}else t&&a.append(t,i)}}else{if(On(e))throw new Error('Cannot submit element that is not <form>, <button>, or <input type="submit|image">');n=kn,i=null,s=Ln,r=e}var o;return a&&"text/plain"===s&&(r=a,a=void 0),{action:i,method:n.toLowerCase(),encType:s,formData:a,body:r}}(n,t);if(!1===s.navigate){let t=s.fetcherKey||ii();await e.fetch(t,i,s.action||a,{preventScrollReset:s.preventScrollReset,formData:l,body:c,formMethod:s.method||r,formEncType:s.encType||o,flushSync:s.flushSync})}else await e.navigate(s.action||a,{preventScrollReset:s.preventScrollReset,formData:l,body:c,formMethod:s.method||r,formEncType:s.encType||o,replace:s.replace,state:s.state,fromRouteId:i,flushSync:s.flushSync,viewTransition:s.viewTransition})},[e,t,i])}(),g=function(e,{relative:t}={}){let{basename:i}=n.useContext(un),s=n.useContext(pn);jt(s,"useFormAction must be used inside a RouteContext");let[a]=s.matches.slice(-1),r={...bn(e||".",{relative:t})},o=gn();if(null==e){r.search=o.search;let e=new URLSearchParams(r.search),t=e.getAll("index");if(t.some(e=>""===e)){e.delete("index"),t.filter(e=>e).forEach(t=>e.append("index",t));let n=e.toString();r.search=n?`?${n}`:""}}return e&&"."!==e||!a.route.index||(r.search=r.search?r.search.replace(/^\?/,"?index&"):"?index"),"/"!==i&&(r.pathname="/"===r.pathname?i:tn([i,r.pathname])),kt(r)}(l,{relative:h}),v="get"===o.toLowerCase()?"get":"post",x="string"==typeof l&&Qn.test(l);return n.createElement("form",{ref:m,method:v,action:g,onSubmit:s?c:e=>{if(c&&c(e),e.defaultPrevented)return;e.preventDefault();let n=e.nativeEvent.submitter,s=(null==n?void 0:n.getAttribute("formmethod"))||o;f(n||e.currentTarget,{fetcherKey:t,method:s,navigate:i,replace:a,state:r,relative:h,preventScrollReset:u,viewTransition:d})},...p,"data-discover":x||"render"!==e?void 0:"true"})}).displayName="Form";var ni=0,ii=()=>`__${String(++ni)}__`;const si=g({apiKey:"AIzaSyAVJvau3Hit06q1pNYCTOF-pVuutmk4oNQ",authDomain:"mythseekers-rpg.firebaseapp.com",databaseURL:"https://mythseekers-rpg-default-rtdb.firebaseio.com",projectId:"mythseekers-rpg",storageBucket:"mythseekers-rpg.firebasestorage.app",messagingSenderId:"659018227506",appId:"1:659018227506:web:82425e7adaf80c2e3c412b",measurementId:"G-E3T1V81ZX3"}),ai=o(si),ri=I(si);Y(si);const oi=new class{constructor(){t(this,"listeners",{})}async signInWithGoogle(){var e,t;try{const i=new l;i.setCustomParameters({prompt:"select_account"}),i.addScope("profile"),i.addScope("email");try{const e=await c(ai,i);await this.getUserProfile(e.user.uid)||await this.createUserProfile(e.user)}catch(n){if("auth/popup-blocked"!==n.code&&"auth/popup-closed-by-user"!==n.code&&!(null==(e=n.message)?void 0:e.includes("Cross-Origin-Opener-Policy"))&&!(null==(t=n.message)?void 0:t.includes("window.closed")))throw n;await h(ai,i)}}catch(i){throw i}}async handleRedirectSignIn(){try{const e=await u(ai);if(e){const t=e.user;return await this.getUserProfile(t.uid)||await this.createUserProfile(t),t}return null}catch(e){return null}}async signOut(){await d(ai)}onAuthStateChange(e){return p(ai,e)}getCurrentUser(){return ai.currentUser}async createUserProfile(e){try{const t={uid:e.uid,displayName:e.displayName||"Adventurer",email:e.email||"",photoURL:e.photoURL||"",createdAt:Date.now(),lastSeen:Date.now(),totalPlayTime:0,campaignsHosted:0,campaignsJoined:0};await D(k(ri,"users",e.uid),t)}catch(t){throw t}}async getUserProfile(e){try{const t=k(ri,"users",e),n=await L(t);return n.exists()?n.data():null}catch(t){return null}}async updateUserLastSeen(e){const t=k(ri,"users",e);await O(t,{lastSeen:Date.now()})}async saveCharacter(e){if(!this.getCurrentUser())throw new Error("User not authenticated");if(!ri)throw new Error("Firebase not initialized");const t={...e,lastPlayed:Date.now()};try{if(e.id){const n=k(ri,"characters",e.id);return await O(n,t),e.id}return(await U(F(ri,"characters"),t)).id}catch(n){throw n}}async getUserCharacters(e){const t=z(F(ri,"characters"),B("userId","==",e));return(await V(t)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>t.lastPlayed-e.lastPlayed)}async getUserCampaigns(e){const t=z(F(ri,"games"),B("hostId","==",e));return(await V(t)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>t.lastActivity-e.lastActivity)}async getCharacter(e){const t=k(ri,"characters",e),n=await L(t);return n.exists()?{id:n.id,...n.data()}:null}async createGameSession(e){const t=this.generateGameCode(),n=this.getCurrentUser();if(!n)throw new Error("User must be authenticated");const i={code:t,theme:e.theme||"Classic Fantasy",background:e.background||"fantasy",hostId:n.uid,players:e.players||[],messages:e.messages||[],started:!1,customPrompt:e.customPrompt||"",maxPlayers:e.maxPlayers||6,createdAt:Date.now(),lastActivity:Date.now()},s=await U(F(ri,"games"),i);return await this.updateUserStats(n.uid,{campaignsHosted:1}),{gameId:s.id,code:t}}async joinGameSession(e,t){const n=this.getCurrentUser();if(!n)throw new Error("User must be authenticated");const i=z(F(ri,"games"),B("code","==",e),B("started","==",!1)),s=await V(i);if(s.empty)throw new Error("Game not found or already started");const a=s.docs[0],r=a.data();if(r.players.length>=r.maxPlayers)throw new Error("Game is full");if(r.players.find(e=>e.id===n.uid))throw new Error("Player already in game");const o=await this.getCharacter(t);if(!o)throw new Error("Character not found");const l={id:n.uid,name:o.name,characterId:t,isHost:!1,isOnline:!0,lastSeen:Date.now()};return await O(k(ri,"games",a.id),{players:H(l),lastActivity:Date.now()}),await this.updateUserStats(n.uid,{campaignsJoined:1}),{gameId:a.id,gameData:{...r,players:[...r.players,l]}}}async leaveGameSession(e){const t=this.getCurrentUser();if(!t)throw new Error("User must be authenticated");const n=k(ri,"games",e),i=await L(n);if(!i.exists())throw new Error("Game not found");const s=i.data().players.filter(e=>e.id!==t.uid);0===s.length?await W(n):await O(n,{players:s,lastActivity:Date.now()})}async startGameSession(e){const t=this.getCurrentUser();if(!t)throw new Error("User must be authenticated");const n=k(ri,"games",e),i=await L(n);if(!i.exists())throw new Error("Game not found");if(i.data().hostId!==t.uid)throw new Error("Only host can start the game");await O(n,{started:!0,lastActivity:Date.now()})}onGameUpdate(e,t){const n=k(ri,"games",e),i=G(n,e=>{if(e.exists()){const n={id:e.id,...e.data()};t(n)}});return this.listeners[e]=i,i}async sendMessage(e,t){if(!this.getCurrentUser())throw new Error("User must be authenticated");const n={...t,id:`msg-${Date.now()}`,timestamp:Date.now()},i=k(ri,"games",e);await O(i,{messages:H(n),lastActivity:Date.now()})}async saveGameProgress(e,t,n){const i=this.getCurrentUser();if(!i)throw new Error("User must be authenticated");const s=k(ri,"characters",t);await O(s,{...n,lastPlayed:Date.now()}),await this.updateUserStats(i.uid,{totalPlayTime:n.playTime||0})}async completeCampaign(e,t){try{if(!ai.currentUser)throw new Error("User not authenticated");const{httpsCallable:n}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),{getFunctions:i}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),s=n(i(si),"completeCampaign");await s({gameId:e,campaignData:t})}catch(n){throw n}}async startCombat(e){try{if(!ai.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),{getFunctions:n}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),i=t(n(si),"startCombat");return{success:!0,combatState:(await i(e)).data}}catch(t){return{success:!1,error:t.message}}}async getCombatState(e){try{if(!ai.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),{getFunctions:n}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),i=t(n(si),"getCombatState");return{success:!0,combatState:(await i({combatId:e})).data}}catch(t){return{success:!1,error:t.message}}}async resolveCombatAction(e){try{if(!ai.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),{getFunctions:n}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),i=t(n(si),"resolveCombatAction");return{success:!0,combatState:(await i(e)).data}}catch(t){return{success:!1,error:t.message}}}async endCombat(e){try{if(!ai.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),{getFunctions:n}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),i=t(n(si),"endCombat");return await i(e),{success:!0}}catch(t){return{success:!1,error:t.message}}}async updateUserStats(e,t){const n=k(ri,"users",e);await O(n,t)}async getUserAchievements(e){try{const t=F(ri,"achievements"),n=z(t,B("userId","==",e)),i=await V(n),s=[];return i.forEach(e=>{s.push({id:e.id,...e.data()})}),s}catch(t){return[]}}async getPlayerStats(e){try{const t=await this.getUserProfile(e);if(!t)return{totalPlayTime:0,campaignsHosted:0,campaignsJoined:0,charactersCreated:0,totalXP:0,combatWins:0,questsCompleted:0,npcsInteracted:0,locationsDiscovered:0,achievementsUnlocked:0,lastActive:new Date,joinDate:new Date};const n=await this.getUserCharacters(e),i=await this.getUserAchievements(e);return{totalPlayTime:t.totalPlayTime||0,campaignsHosted:t.campaignsHosted||0,campaignsJoined:t.campaignsJoined||0,charactersCreated:n.length,totalXP:n.reduce((e,t)=>e+(t.experience||0),0),combatWins:0,questsCompleted:0,npcsInteracted:0,locationsDiscovered:0,achievementsUnlocked:i.length,lastActive:new Date(t.lastSeen),joinDate:new Date(t.createdAt)}}catch(t){return{totalPlayTime:0,campaignsHosted:0,campaignsJoined:0,charactersCreated:0,totalXP:0,combatWins:0,questsCompleted:0,npcsInteracted:0,locationsDiscovered:0,achievementsUnlocked:0,lastActive:new Date,joinDate:new Date}}}generateGameCode(){let e="";for(let t=0;t<6;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(36*Math.random()));return e}cleanup(){Object.values(this.listeners).forEach(e=>e()),this.listeners={}}},li=()=>{const[e,t]=n.useState(null),[i,s]=n.useState(null),[a,r]=n.useState(!0),[o,l]=n.useState("overview"),[c,h]=n.useState([]),[u,d]=n.useState(null);n.useEffect(()=>oi.onAuthStateChange(async e=>{if(t(e),r(!1),e)try{const t=await oi.getUserProfile(e.uid);s(t),await p(e.uid)}catch(n){s(null)}else s(null)}),[]);const p=async e=>{try{const t=await oi.getUserAchievements(e);h(t);const n=await oi.getPlayerStats(e);d(n)}catch(t){}},m=e=>{const t=Math.floor(e/60),n=e%60;return t>24?`${Math.floor(t/24)}d ${t%24}h ${n}m`:`${t}h ${n}m`};if(a)return ft.jsx("div",{className:"text-blue-200",children:"Loading..."});if(!e)return ft.jsx("div",{className:"flex flex-col items-center space-y-2",children:ft.jsx("button",{onClick:async()=>{r(!0);try{await oi.signInWithGoogle()}catch($T){alert("Login failed: "+$T)}r(!1)},className:"px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Sign in with Google"})});const f=(g=(null==u?void 0:u.totalXP)||0,Math.floor(g/1e3)+1);var g;const v=(x=f)>=20?{name:"Legendary Master",color:"text-purple-400",icon:"👑"}:x>=15?{name:"Epic Hero",color:"text-red-400",icon:"⚔️"}:x>=10?{name:"Veteran Adventurer",color:"text-orange-400",icon:"🛡️"}:x>=5?{name:"Skilled Warrior",color:"text-yellow-400",icon:"⚡"}:{name:"Novice Explorer",color:"text-green-400",icon:"🌱"};var x;return ft.jsxs("div",{className:"flex flex-col h-full",children:[ft.jsx("div",{className:"bg-gradient-to-r from-blue-900/50 to-purple-900/50 rounded-lg p-4 mb-4 border border-white/20",children:ft.jsxs("div",{className:"flex items-center space-x-4",children:[ft.jsx("img",{src:e.photoURL,alt:"avatar",className:"w-16 h-16 rounded-full border-2 border-blue-400"}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("div",{className:"text-white font-bold text-lg",children:e.displayName}),ft.jsx("div",{className:"text-blue-200 text-sm",children:e.email}),ft.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[ft.jsx("span",{className:"text-2xl",children:v.icon}),ft.jsx("span",{className:`font-semibold ${v.color}`,children:v.name}),ft.jsxs("span",{className:"text-gray-300",children:["• Level ",f]})]})]}),ft.jsx("button",{onClick:async()=>{r(!0);try{await oi.signOut()}catch($T){alert("Logout failed: "+$T)}r(!1)},className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"Sign out"})]})}),ft.jsx("div",{className:"flex space-x-1 mb-4",children:[{key:"overview",label:"Overview",icon:ft.jsx(ie,{size:16})},{key:"achievements",label:"Achievements",icon:ft.jsx(se,{size:16})},{key:"stats",label:"Statistics",icon:ft.jsx(ae,{size:16})},{key:"characters",label:"Characters",icon:ft.jsx(re,{size:16})}].map(e=>ft.jsxs("button",{onClick:()=>l(e.key),className:"flex items-center space-x-2 px-4 py-2 rounded-lg transition-all "+(o===e.key?"bg-blue-600 text-white":"bg-white/10 text-blue-200 hover:bg-white/20"),children:[e.icon,ft.jsx("span",{className:"hidden sm:inline",children:e.label})]},e.key))}),ft.jsxs("div",{className:"flex-1 overflow-y-auto",children:["overview"===o&&ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[ft.jsx(oe,{className:"w-6 h-6 text-blue-400 mx-auto mb-2"}),ft.jsx("div",{className:"text-white font-bold",children:m((null==u?void 0:u.totalPlayTime)||0)}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Play Time"})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[ft.jsx(le,{className:"w-6 h-6 text-yellow-400 mx-auto mb-2"}),ft.jsx("div",{className:"text-white font-bold",children:(null==u?void 0:u.achievementsUnlocked)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Achievements"})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[ft.jsx(re,{className:"w-6 h-6 text-green-400 mx-auto mb-2"}),ft.jsx("div",{className:"text-white font-bold",children:(null==u?void 0:u.campaignsJoined)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Campaigns"})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[ft.jsx(ce,{className:"w-6 h-6 text-red-400 mx-auto mb-2"}),ft.jsx("div",{className:"text-white font-bold",children:(null==u?void 0:u.questsCompleted)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Quests"})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Recent Activity"}),ft.jsxs("div",{className:"space-y-2 text-sm",children:[ft.jsxs("div",{className:"flex items-center space-x-3 text-blue-200",children:[ft.jsx(he,{size:16}),ft.jsxs("span",{children:["Joined MythSeeker ",(null==u?void 0:u.joinDate)?new Date(u.joinDate).toLocaleDateString():"recently"]})]}),ft.jsxs("div",{className:"flex items-center space-x-3 text-blue-200",children:[ft.jsx(oe,{size:16}),ft.jsxs("span",{children:["Last active ",(null==u?void 0:u.lastActive)?new Date(u.lastActive).toLocaleDateString():"recently"]})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Level Progress"}),ft.jsxs("div",{className:"space-y-2",children:[ft.jsxs("div",{className:"flex justify-between text-sm",children:[ft.jsxs("span",{className:"text-blue-200",children:["Level ",f]}),ft.jsxs("span",{className:"text-blue-200",children:["Level ",f+1]})]}),ft.jsx("div",{className:"w-full bg-white/20 rounded-full h-2",children:ft.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all",style:{width:((null==u?void 0:u.totalXP)||0)%1e3/10+"%"}})}),ft.jsxs("div",{className:"text-center text-sm text-blue-200",children:[(null==u?void 0:u.totalXP)||0," / ",1e3*(f+1)," XP"]})]})]})]}),"achievements"===o&&ft.jsx("div",{className:"space-y-4",children:ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[c.map(e=>ft.jsx("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:ft.jsxs("div",{className:"flex items-start space-x-3",children:[ft.jsx("div",{className:"text-3xl",children:e.icon}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("h4",{className:"text-white font-medium",children:e.name}),ft.jsx("p",{className:"text-gray-300 text-sm mb-2",children:e.description}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("span",{className:"text-xs text-yellow-400",children:["+",e.points," points"]}),ft.jsx("span",{className:"text-xs text-gray-400",children:e.unlockedAt?new Date(e.unlockedAt).toLocaleDateString():"Unlocked"})]})]})]})},e.id)),0===c.length&&ft.jsxs("div",{className:"col-span-full text-center py-8",children:[ft.jsx(se,{size:48,className:"text-gray-400 mx-auto mb-4"}),ft.jsx("p",{className:"text-gray-400",children:"No achievements unlocked yet"}),ft.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Complete quests and challenges to earn achievements!"})]})]})}),"stats"===o&&ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center space-x-2",children:[ft.jsx(ue,{size:20,className:"text-red-400"}),ft.jsx("span",{children:"Combat Statistics"})]}),ft.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.combatWins)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Combat Wins"})]}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.totalXP)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Total XP"})]}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.charactersCreated)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Characters"})]}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.campaignsHosted)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Campaigns Hosted"})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center space-x-2",children:[ft.jsx(ce,{size:20,className:"text-green-400"}),ft.jsx("span",{children:"Exploration Statistics"})]}),ft.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.questsCompleted)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Quests Completed"})]}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.locationsDiscovered)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Locations Found"})]}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.npcsInteracted)||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"NPCs Met"})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center space-x-2",children:[ft.jsx(oe,{size:20,className:"text-blue-400"}),ft.jsx("span",{children:"Time Statistics"})]}),ft.jsxs("div",{className:"space-y-2 text-sm",children:[ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-blue-200",children:"Total Play Time:"}),ft.jsx("span",{className:"text-white",children:m((null==u?void 0:u.totalPlayTime)||0)})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-blue-200",children:"Average Session:"}),ft.jsx("span",{className:"text-white",children:(null==u?void 0:u.campaignsJoined)?m(Math.floor((u.totalPlayTime||0)/u.campaignsJoined)):"0m"})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-blue-200",children:"Member Since:"}),ft.jsx("span",{className:"text-white",children:(null==u?void 0:u.joinDate)?new Date(u.joinDate).toLocaleDateString():"Recently"})]})]})]})]}),"characters"===o&&ft.jsx("div",{className:"space-y-4",children:ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Character Gallery"}),ft.jsx("p",{className:"text-blue-200 text-sm mb-4",children:"Your created characters and their achievements will appear here."}),ft.jsxs("div",{className:"text-center py-8",children:[ft.jsx(re,{size:48,className:"text-gray-400 mx-auto mb-4"}),ft.jsx("p",{className:"text-gray-400",children:"Character management coming soon!"}),ft.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Create characters to see them here"})]})]})})]})]})},ci=g({apiKey:"AIzaSyAVJvau3Hit06q1pNYCTOF-pVuutmk4oNQ",authDomain:"mythseekers-rpg.firebaseapp.com",databaseURL:"https://mythseekers-rpg-default-rtdb.firebaseio.com",projectId:"mythseekers-rpg",storageBucket:"mythseekers-rpg.firebasestorage.app",messagingSenderId:"659018227506",appId:"1:659018227506:web:82425e7adaf80c2e3c412b",measurementId:"G-E3T1V81ZX3"}),hi=Y(ci),ui=st(ci);o(ci);const di=new class{constructor(){t(this,"aiDungeonMaster",at(ui,"aiDungeonMaster"))}async complete(e,t){var n;try{const i=at(ui,"aiDungeonMaster"),s=new Promise((e,t)=>{setTimeout(()=>{t(new Error("Real AI timeout - but NO FALLBACKS!"))},3e4)}),a=i({prompt:e,campaignId:(null==t?void 0:t.id)||"sentient-ai-session",playerName:(null==t?void 0:t.playerName)||"Sentient AI User"}),r=null==(n=(await Promise.race([a,s])).data)?void 0:n.response;if(!r)throw new Error("Empty response from REAL AI");return"string"==typeof r?r:JSON.stringify(r)}catch(i){throw new Error(`REAL AI UNAVAILABLE: ${i instanceof Error?i.message:String(i)}`)}}generateLocalResponse(e){try{const t=this.parsePromptContext(e),n=e.includes("INITIAL SCENE REQUIREMENTS")?this.generateInitialScene(t):this.generateDynamicResponse(t);return JSON.stringify(n)}catch(t){return JSON.stringify(this.generateFallbackResponse())}}parsePromptContext(e){const t=e.match(/Player Level: (\d+) ([^,\n]+)/),n=e.match(/Player Stats: STR (\d+), DEX (\d+), INT (\d+), CHA (\d+)/),i=e.match(/Location: ([^\n]+)/),s=e.match(/Time: ([^\n]+)/),a=e.match(/Weather: ([^\n]+)/),r=e.match(/\*\*PLAYER INPUT:\*\* "([^"]+)"/),o=r?r[1]:"",l=e.match(/for a ([^ ]+) campaign/),c=l?l[1]:"fantasy",h=e.match(/\*\*CUSTOM CAMPAIGN PROMPT:\*\*\n([^*]+?)(?=\*\*|$)/),u=h?h[1].trim():"";return{character:{level:t?parseInt(t[1]):1,class:t?t[2]:"Adventurer",stats:n?{strength:parseInt(n[1]),dexterity:parseInt(n[2]),intelligence:parseInt(n[3]),charisma:parseInt(n[4])}:{strength:10,dexterity:10,intelligence:10,charisma:10}},worldState:{location:i?i[1].trim():"unknown",time:s?s[1].trim():"day",weather:a?a[1].trim():"clear"},playerInput:o,theme:c,customPrompt:u}}generateInitialScene(e){const{character:t,worldState:n,theme:i,customPrompt:s}=e,a=this.generateLocation(n.location,i),r=this.generateNPC(t,i),o=this.generateConflict(i,s),l=[`You find yourself in ${a.name}, where ${a.atmosphere}. ${r.name}, a ${r.role.toLowerCase()}, approaches you with ${r.mood} in their eyes. "${r.greeting}" they say, their voice ${r.voice}.`,`As you enter ${a.name}, ${a.description}. ${r.name} spots you and immediately makes their way over. "${r.greeting}" they ${r.action}, their ${r.personality} nature evident in every gesture.`,`${a.name} ${a.activity}. ${r.name} rushes toward you, their face ${r.expression}. "${r.greeting}" they ${r.action}, clearly ${r.motivation}.`],c=[`Accept ${r.name}'s request and ask for details`,"Express skepticism and demand more information",`Ask about the local situation and ${r.name}'s background`,"Request to see the area and gather your own intelligence"];return{narrative:l[Math.floor(Math.random()*l.length)],choices:c,environment:a.id,worldStateUpdates:{newLocation:a.id,newNPCs:[{name:r.name,role:r.role,personality:r.personality,currentMood:r.mood,currentAction:r.action}],consequences:[{type:"immediate",description:`You've been approached by ${r.name} about ${o.name}`,affectedAreas:[a.id]}]},atmosphere:{mood:a.mood,tension:"medium",environmentalDetails:a.details}}}generateDynamicResponse(e){const{character:t,worldState:n,playerInput:i,theme:s}=e,a=i.toLowerCase();return this.isCombatAction(a)?this.generateCombatResponse(e):this.isExplorationAction(a)?this.generateExplorationResponse(e):this.isSocialAction(a)?this.generateSocialResponse(e):this.isRestAction(a)?this.generateRestResponse(e):this.generateGeneralResponse(e)}isCombatAction(e){return["attack","fight","combat","battle","strike","slash","stab","shoot","cast","spell"].some(t=>e.includes(t))}isExplorationAction(e){return["explore","search","investigate","examine","look","check","find","discover"].some(t=>e.includes(t))}isSocialAction(e){return["talk","ask","tell","speak","negotiate","persuade","intimidate","charm","say","reply","respond","answer","question","stare","look","glance","nod","shake","smile","frown","laugh","cry","whisper","shout","greet","introduce","meet","converse","discuss","debate","argue","agree","disagree","accept","refuse","promise","threaten","warn","advise","suggest","propose","offer","request","demand","beg","apologize","thank","congratulate","comfort","encourage","scold"].some(t=>e.includes(t))}isRestAction(e){return["rest","sleep","heal","recover","meditate","camp"].some(t=>e.includes(t))}generateCombatResponse(e){const{character:t,worldState:n,theme:i}=e,s=this.generateEnemies(i,t.level,n.location),a=[`The tension erupts into violence! ${s.length>1?"Your enemies":"Your enemy"} ${s.length>1?"surround":"positions"} you, weapons drawn and eyes filled with determination. The ${t.class.toLowerCase()} in you recognizes this moment - it's time to prove your worth in battle.`,`Suddenly, ${s.length>1?"multiple figures":"a figure"} emerges from the shadows, ${s.length,"their"} intentions clear. Your ${t.class.toLowerCase()} instincts kick in as you prepare for combat.`,`The air crackles with anticipation as ${s.length>1?"your opponents":"your opponent"} ${s.length>1?"take":"takes"} up ${s.length,"their"} fighting stance. Your ${t.class.toLowerCase()} training prepares you for what comes next.`];return{narrative:a[Math.floor(Math.random()*a.length)],choices:["Engage in tactical combat using your class abilities","Attempt to intimidate or bluff your way out","Look for tactical advantages in the environment","Call for reinforcements or help"],combatEncounter:{active:!0,enemies:s},atmosphere:{mood:"tense",tension:"high",environmentalDetails:"The air is thick with the promise of violence and the sound of steel being drawn"}}}generateEnemies(e,t,n){var i;const s={fantasy:{tavern:["Drunken Brawler","Thief","Mercenary"],forest:["Bandit","Wolf","Goblin Scout"],dungeon:["Skeleton","Goblin Warrior","Dark Elf"],city:["City Guard","Thug","Assassin"]},scifi:{tavern:["Rogue Android","Space Pirate","Mutant"],forest:["Alien Scout","Rogue Drone","Wild Creature"],dungeon:["Security Bot","Alien Warrior","Mutant Beast"],city:["Security Officer","Gang Member","Rogue AI"]},horror:{tavern:["Cursed Patron","Shadow Creature","Undead"],forest:["Dark Entity","Cursed Beast","Shadow Walker"],dungeon:["Undead Warrior","Dark Spirit","Cursed Guardian"],city:["Corrupted Citizen","Shadow Stalker","Dark Entity"]}},a=(null==(i=s[e])?void 0:i[n])||s.fantasy.tavern,r=Math.min(t,3);return Array.from({length:r},(e,n)=>({name:a[n%a.length],health:20+5*t+Math.floor(10*Math.random()),attack:3+t+Math.floor(3*Math.random()),strength:12+Math.floor(6*Math.random()),dexterity:10+Math.floor(6*Math.random()),intelligence:8+Math.floor(6*Math.random()),armorClass:12+Math.floor(4*Math.random())}))}generateExplorationResponse(e){const{character:t,worldState:n,theme:i}=e,s=["You discover ancient markings that seem to tell a story of the area's history","A hidden passage reveals itself behind a loose stone, leading to unknown depths","You find evidence of recent activity - footprints, disturbed earth, or discarded items","The environment reveals subtle clues about what happened here recently","Your investigation uncovers a hidden cache or secret compartment","You notice environmental details that others might have missed"],a=[`Your careful investigation pays off! ${s[Math.floor(Math.random()*s.length)]}. Your ${t.class.toLowerCase()} instincts tell you this could be important.`,`Your ${t.class.toLowerCase()} training guides your search. ${s[Math.floor(Math.random()*s.length)]}, and you sense this discovery could change everything.`,`Your methodical approach reveals secrets others might miss. ${s[Math.floor(Math.random()*s.length)]}, and your ${t.class.toLowerCase()} experience helps you understand its significance.`];return{narrative:a[Math.floor(Math.random()*a.length)],choices:["Examine the discovery more closely for additional details","Document your findings and search for related clues","Investigate the surrounding area for more context","Report your discovery to relevant NPCs or allies"],atmosphere:{mood:"curious",tension:"low",environmentalDetails:"The area reveals its secrets to your careful observation and expertise"}}}generateSocialResponse(e){const{character:t,playerInput:n}=e,i=n.toLowerCase();if(i.includes("how dire")||i.includes("serious")||i.includes("dangerous"))return{narrative:`Captain Thorne's expression darkens as they lean in closer, their voice dropping to a grave whisper. "More dire than you can imagine. The ancient seals are weakening, and if they break completely, the entire region will be overrun. We've already lost three villages to the north. I need someone with your ${t.class.toLowerCase()} skills to help us investigate the source before it's too late."`,choices:["Accept the mission and ask for more details about the ancient seals","Request proof of the threat before committing","Ask about the rewards and support you'll receive","Decline politely, citing other pressing matters"],atmosphere:{mood:"urgent",tension:"high",environmentalDetails:"The tavern seems to grow quieter as Captain Thorne speaks, as if the very air holds its breath"}};if(i.includes("stare")||i.includes("look")||i.includes("glance"))return{narrative:`Your ${t.class.toLowerCase()} instincts tell you that Captain Thorne is genuine in their concern. Their weathered face shows the strain of someone who has seen too much, and their eyes carry the weight of responsibility. "I can see you're assessing the situation," they say, nodding approvingly. "That's exactly the kind of careful thinking we need right now."`,choices:["Ask about their military background and experience","Inquire about the specific nature of the threat","Request to see any evidence or reports they have","Ask about the political situation and who else is involved"],atmosphere:{mood:"respectful",tension:"medium",environmentalDetails:"The firelight casts dancing shadows that seem to emphasize the gravity of the situation"}};if(i.includes("why me")||i.includes("choose")||i.includes("select"))return{narrative:`"Why you?" Captain Thorne chuckles, but there's no humor in it. "I've been watching you since you walked in. The way you carry yourself, the way you observe your surroundings - you have the bearing of someone who knows how to handle themselves in dangerous situations. Plus, your ${t.class.toLowerCase()} background gives you skills we desperately need right now."`,choices:["Ask about what specific skills they think you can offer","Inquire about other potential allies or resources","Request more information about the mission parameters","Ask about the risks and potential consequences"],atmosphere:{mood:"analytical",tension:"medium",environmentalDetails:"The captain's assessment seems to carry the weight of experience and the urgency of someone who has seen too much"}};const s=[`Your diplomatic approach opens new possibilities. The person you're speaking with seems to respond well to your ${t.class.toLowerCase()} manner and ${t.stats.charisma>=14?"natural charisma":"earnest approach"}. They share information that could prove valuable.`,`Your ${t.class.toLowerCase()} background helps you connect with the person. They seem to trust your ${t.stats.charisma>=14?"charming":"honest"} nature and share insights about the local situation.`,`Your conversation reveals unexpected depths. Your ${t.class.toLowerCase()} experience and ${t.stats.intelligence>=14?"sharp mind":"practical knowledge"} help you understand the nuances of what they're telling you.`];return{narrative:s[Math.floor(Math.random()*s.length)],choices:["Ask for more specific details about their concerns","Offer assistance in return for their help","Request an introduction to other important people","Thank them and use this information strategically"],atmosphere:{mood:"cooperative",tension:"low",environmentalDetails:"The conversation creates a more relaxed and open atmosphere"}}}generateRestResponse(e){const{character:t,worldState:n}=e,i=[`You take a moment to rest and recover. The ${t.class.toLowerCase()} in you knows the value of preparation and recuperation. You feel your strength returning and your mind clearing.`,`Your ${t.class.toLowerCase()} training emphasizes the importance of rest. As you take this time to recover, you feel your energy returning and your focus sharpening.`,`The ${t.class.toLowerCase()} way teaches patience and preparation. This rest allows you to recover your strength and plan your next move with renewed clarity.`];return{narrative:i[Math.floor(Math.random()*i.length)],choices:["Continue resting to fully recover your strength","Use this time to plan your next move carefully","Check your equipment and supplies while resting","Resume your journey with renewed energy"],characterUpdates:[{playerId:"current",xpGain:5,xpReason:"Wise use of rest time and strategic thinking",statChanges:{health:10,mana:5}}],atmosphere:{mood:"peaceful",tension:"low",environmentalDetails:"The area provides a safe haven for rest and recovery"}}}generateGeneralResponse(e){const{character:t,worldState:n,theme:i,recentActions:s}=e,a=[`Your actions have consequences in this ${i} world. The story continues to unfold based on your choices, and your ${t.class.toLowerCase()} skills and level ${t.level} experience guide your path forward.`,`The world responds to your presence and actions. Your ${t.class.toLowerCase()} background and recent decisions shape how events unfold around you.`,`Your ${t.class.toLowerCase()} instincts serve you well as you navigate this situation. Your level ${t.level} experience and recent actions influence the world's response to your presence.`];return{narrative:a[Math.floor(Math.random()*a.length)],choices:["Continue with your current approach and see where it leads","Try a different strategy based on what you've learned","Seek advice from others who might have relevant experience","Take time to reflect on your options and their implications"],atmosphere:{mood:"neutral",tension:"low",environmentalDetails:"The world responds to your presence and actions in subtle ways"}}}generateLocation(e,t){const n={tavern:{fantasy:{name:"The Prancing Pony Tavern",atmosphere:"warm firelight dances across weathered faces",description:"bustles with activity and the sound of laughter",activity:"hums with the energy of travelers and locals",mood:"cozy",details:"The air is thick with the scent of ale and wood smoke"},scifi:{name:"The Stellar Lounge",atmosphere:"neon lights pulse to the rhythm of distant engines",description:"buzzes with the energy of space travelers",activity:"vibrates with the hum of technology and conversation",mood:"futuristic",details:"The air hums with the subtle energy of advanced life support systems"},horror:{name:"The Shadowed Inn",atmosphere:"flickering candles cast dancing shadows on the walls",description:"echoes with whispered conversations",activity:"pulses with an uneasy energy",mood:"foreboding",details:"The air is thick with the scent of old wood and something else, something older"},urban:{name:"The Midnight Bar",atmosphere:"dim lighting creates intimate corners for private conversations",description:"buzzes with the energy of city nightlife",activity:"throbs with the pulse of urban life",mood:"mysterious",details:"The air carries the mingled scents of coffee, alcohol, and urban mystery"},apocalypse:{name:"The Last Stop",atmosphere:"makeshift barricades and dim emergency lighting",description:"echoes with the sounds of survivors sharing stories",activity:"hums with the quiet desperation of those who remain",mood:"grim",details:"The air is thick with the scent of survival and the weight of lost civilization"},pirate:{name:"The Salty Dog",atmosphere:"lanterns swing gently with the rhythm of the sea",description:"roars with the laughter of sailors and adventurers",activity:"bustles with tales of treasure and adventure",mood:"adventurous",details:"The air carries the salty tang of the ocean and the promise of fortune"}},forest:{fantasy:{name:"The Enchanted Grove",atmosphere:"ancient trees whisper secrets to the wind",description:"shimmers with magical energy and natural beauty",activity:"pulses with the life force of the forest",mood:"mystical",details:"The air is alive with the scent of earth, magic, and ancient wisdom"},scifi:{name:"The Bio-Dome Forest",atmosphere:"artificial sunlight filters through genetically enhanced foliage",description:"buzzes with the energy of engineered ecosystems",activity:"throbs with the pulse of controlled nature",mood:"synthetic",details:"The air carries the scent of purified oxygen and technological harmony"},horror:{name:"The Twisted Woods",atmosphere:"malformed trees reach like skeletal fingers toward the sky",description:"echoes with unnatural sounds and distant screams",activity:"pulses with dark energy and malevolent presence",mood:"terrifying",details:"The air is thick with the scent of decay and something far worse"}},dungeon:{fantasy:{name:"The Ancient Crypts",atmosphere:"torchlight flickers against ancient stone walls",description:"echoes with the whispers of forgotten souls",activity:"pulses with the energy of ancient magic",mood:"mysterious",details:"The air is thick with the dust of ages and the weight of history"},scifi:{name:"The Abandoned Facility",atmosphere:"emergency lighting casts eerie shadows on metal walls",description:"buzzes with the remnants of advanced technology",activity:"throbs with the pulse of malfunctioning systems",mood:"technological",details:"The air hums with the energy of dormant machines and lost knowledge"},horror:{name:"The Cursed Catacombs",atmosphere:"darkness seems to swallow the light whole",description:"echoes with the sounds of things that should not exist",activity:"pulses with malevolent energy and dark magic",mood:"horrifying",details:"The air is thick with the scent of death and the presence of evil"}},city:{fantasy:{name:"The Grand Bazaar",atmosphere:"colorful stalls and the sounds of commerce fill the air",description:"bustles with merchants, travelers, and city life",activity:"hums with the energy of trade and opportunity",mood:"lively",details:"The air carries the scent of spices, goods, and the promise of fortune"},scifi:{name:"The Mega-City District",atmosphere:"neon lights and holographic advertisements create a dazzling display",description:"buzzes with the energy of advanced civilization",activity:"throbs with the pulse of technological progress",mood:"futuristic",details:"The air hums with the energy of countless machines and digital life"},horror:{name:"The Forgotten Quarter",atmosphere:"abandoned buildings and broken streetlights create an eerie silence",description:"echoes with the sounds of things that lurk in the shadows",activity:"pulses with the energy of fear and desperation",mood:"terrifying",details:"The air is thick with the scent of decay and the weight of forgotten lives"},urban:{name:"The Midnight Bar",atmosphere:"dim lighting creates intimate corners for private conversations",description:"buzzes with the energy of city nightlife",activity:"throbs with the pulse of urban life",mood:"mysterious",details:"The air carries the mingled scents of coffee, alcohol, and urban mystery"},apocalypse:{name:"The Last Stop",atmosphere:"makeshift barricades and dim emergency lighting",description:"echoes with the sounds of survivors sharing stories",activity:"hums with the quiet desperation of those who remain",mood:"grim",details:"The air is thick with the scent of survival and the weight of lost civilization"},pirate:{name:"The Salty Dog",atmosphere:"lanterns swing gently with the rhythm of the sea",description:"roars with the laughter of sailors and adventurers",activity:"bustles with tales of treasure and adventure",mood:"adventurous",details:"The air carries the salty tang of the ocean and the promise of fortune"}}},i=n[e];return{...(null==i?void 0:i[t])||n.tavern.fantasy,id:e}}generateNPC(e,t){const n={fantasy:[{name:"Eldric the Sage",role:"Wise Scholar",personality:"scholarly and contemplative",mood:"concerned wisdom",action:"approaches you thoughtfully",greeting:"I have been studying the ancient texts, and I believe I have found something that requires your attention",voice:"carries the weight of centuries of knowledge",expression:"lined with the wisdom of age",motivation:"desperate to share their discovery"},{name:"Captain Thorne",role:"Veteran Warrior",personality:"battle-hardened but honorable",mood:"urgent determination",action:"strides toward you with purpose",greeting:"We need someone with your skills. The situation is more dire than most realize",voice:"carries the authority of command",expression:"marked by years of conflict",motivation:"seeking a capable ally for a dangerous mission"},{name:"Lady Seraphina",role:"Noble Diplomat",personality:"graceful and politically savvy",mood:"calculated concern",action:"glides toward you with practiced elegance",greeting:"Your reputation precedes you. I believe we may be able to help each other in these troubled times",voice:"carries the refinement of noble breeding",expression:"shows the careful control of one used to court intrigue",motivation:"seeking a trustworthy agent for delicate matters"}],scifi:[{name:"Commander Nova",role:"AI Coordinator",personality:"logical and efficient",mood:"digital urgency",action:"approaches with calculated precision",greeting:"My sensors have detected an anomaly that requires immediate attention",voice:"carries the precision of advanced algorithms",expression:"displays subtle digital patterns",motivation:"programmed to seek assistance for critical situations"},{name:"Dr. Zara Chen",role:"Research Scientist",personality:"brilliant but socially awkward",mood:"scientific excitement mixed with concern",action:"approaches with the energy of one who has made a breakthrough",greeting:"You won't believe what I've discovered! But we need someone with your skills to investigate further",voice:"carries the enthusiasm of scientific discovery",expression:"shows the intensity of someone who has been working too long",motivation:"desperate to share their findings and get help"},{name:"Captain Vega",role:"Space Fleet Commander",personality:"disciplined and strategic",mood:"military urgency",action:"marches toward you with purpose",greeting:"We have a situation that requires immediate action. Your skills are exactly what we need",voice:"carries the authority of military command",expression:"shows the stress of someone carrying heavy responsibility",motivation:"seeking a capable operative for a critical mission"}],horror:[{name:"Father Marcus",role:"Local Priest",personality:"haunted but determined",mood:"desperate hope",action:"emerges from the shadows",greeting:"The darkness has returned, and we need someone who can face it",voice:"carries the weight of terrible knowledge",expression:"haunted by what they have seen",motivation:"seeking someone to help fight the darkness"},{name:"Dr. Sarah Blackwood",role:"Paranormal Investigator",personality:"obsessive and driven",mood:"frantic determination",action:"rushes toward you with barely contained energy",greeting:"I've been tracking this for months! The signs are all there, and now it's happening again",voice:"carries the intensity of someone who has seen too much",expression:"shows the strain of someone who hasn't slept in days",motivation:"desperate to stop the cycle of horror"},{name:"The Caretaker",role:"Groundskeeper",personality:"mysterious and knowing",mood:"ominous warning",action:"materializes from the darkness",greeting:"You shouldn't be here. But since you are, perhaps you can help with what's coming",voice:"carries the weight of ancient secrets",expression:"shows the wisdom of one who has seen generations pass",motivation:"seeking someone to break an ancient curse"}],urban:[{name:"Detective Mike Torres",role:"Homicide Detective",personality:"world-weary but determined",mood:"professional concern",action:"approaches with the practiced ease of a cop",greeting:"I've got a case that's got me stumped. I think you might be able to help",voice:"carries the gravel of too many late nights",expression:"shows the weariness of someone who has seen too much",motivation:"seeking help with an unsolvable case"},{name:"Madame Celeste",role:"Fortune Teller",personality:"mysterious and theatrical",mood:"prophetic urgency",action:"emerges from behind her curtain with dramatic flair",greeting:"The cards have been trying to tell me something about you. There's danger ahead",voice:"carries the mystery of the unknown",expression:"shows the intensity of someone who sees beyond the veil",motivation:"seeking to prevent a terrible fate"},{name:'Marcus "The Fixer"',role:"Information Broker",personality:"smooth and calculating",mood:"businesslike interest",action:"approaches with the confidence of someone who knows everyone",greeting:"I hear you're looking for work. I might have something that pays well",voice:"carries the smooth confidence of a dealmaker",expression:"shows the careful calculation of a businessman",motivation:"seeking a reliable operative for a lucrative job"}],apocalypse:[{name:"Commander Hayes",role:"Survival Leader",personality:"pragmatic and protective",mood:"urgent concern",action:"approaches with the authority of someone used to making life-or-death decisions",greeting:"We're running out of time and supplies. I need someone who can handle themselves",voice:"carries the weight of leadership in desperate times",expression:"shows the stress of someone responsible for others' survival",motivation:"seeking help to protect the community"},{name:"Dr. Elena Rodriguez",role:"Medical Researcher",personality:"desperate but hopeful",mood:"scientific urgency",action:"approaches with the energy of someone who has made a breakthrough",greeting:"I think I've found a way to help, but I need someone to get the supplies",voice:"carries the hope of someone who refuses to give up",expression:"shows the determination of someone fighting against impossible odds",motivation:"seeking help to save lives"},{name:"Scout",role:"Wasteland Scout",personality:"cautious and observant",mood:"warning concern",action:"emerges from the shadows with practiced stealth",greeting:"You need to know what's coming. It's worse than we thought",voice:"carries the urgency of someone who has seen terrible things",expression:"shows the alertness of someone who lives by their wits",motivation:"seeking to warn others of impending danger"}],pirate:[{name:"Captain Blackbeard",role:"Pirate Captain",personality:"charismatic and ruthless",mood:"adventurous excitement",action:"swaggers toward you with the confidence of a legend",greeting:"Ahoy there! I've got a tale of treasure that'll make your eyes sparkle",voice:"carries the rum-soaked authority of a sea captain",expression:"shows the cunning of someone who has survived countless battles",motivation:"seeking a crew for a legendary treasure hunt"},{name:"Madame Fortune",role:"Port Town Proprietor",personality:"shrewd and well-connected",mood:"businesslike interest",action:"approaches with the practiced grace of a successful merchant",greeting:"I hear you're looking for adventure. I might have just the thing",voice:"carries the smooth confidence of someone who knows every secret",expression:"shows the wisdom of someone who has seen fortunes made and lost",motivation:"seeking a reliable partner for a profitable venture"},{name:"The Navigator",role:"Mysterious Seafarer",personality:"enigmatic and knowledgeable",mood:"prophetic warning",action:"emerges from the shadows with the grace of one who knows the sea",greeting:"The tides are changing, and not for the better. You'll need a guide",voice:"carries the mystery of one who has sailed to the edge of the world",expression:"shows the wisdom of someone who has seen things beyond mortal ken",motivation:"seeking someone to help prevent a maritime disaster"}]},i=n[t]||n.fantasy;return i[Math.floor(Math.random()*i.length)]}generateConflict(e,t){const n={fantasy:[{name:"Ancient Prophecy",description:"A prophecy foretells great danger"},{name:"Missing Artifact",description:"A powerful artifact has disappeared"},{name:"Political Intrigue",description:"Noble houses vie for power"},{name:"Monster Threat",description:"Creatures threaten the realm"},{name:"Dark Magic",description:"Forbidden magic has been unleashed"},{name:"Dragon Awakening",description:"An ancient dragon has stirred from its slumber"}],scifi:[{name:"System Malfunction",description:"Critical systems are failing"},{name:"Alien Invasion",description:"Unknown forces approach"},{name:"Resource Shortage",description:"Essential supplies are running low"},{name:"Political Crisis",description:"Factions struggle for control"},{name:"AI Rebellion",description:"Artificial intelligences have become hostile"},{name:"Space Anomaly",description:"A mysterious phenomenon threatens the sector"}],horror:[{name:"Supernatural Threat",description:"Dark forces have awakened"},{name:"Dark Ritual",description:"An ancient ritual has begun"},{name:"Missing People",description:"Citizens are disappearing"},{name:"Ancient Curse",description:"A curse has been unleashed"},{name:"Cult Activity",description:"A sinister cult is growing in power"},{name:"Haunted Location",description:"A place has become possessed by evil"}],urban:[{name:"Criminal Syndicate",description:"A powerful crime organization is expanding"},{name:"Corrupt Officials",description:"Government officials are involved in illegal activities"},{name:"Supernatural Crime",description:"Supernatural forces are behind recent crimes"},{name:"Urban Legend",description:"A local legend has become real"},{name:"Corporate Conspiracy",description:"A corporation is hiding dangerous secrets"},{name:"Underground Network",description:"A secret network operates beneath the city"}],apocalypse:[{name:"Resource Crisis",description:"Essential resources are running out"},{name:"Hostile Faction",description:"A dangerous group threatens the community"},{name:"Environmental Hazard",description:"A new environmental threat has emerged"},{name:"Disease Outbreak",description:"A deadly disease is spreading"},{name:"Radiation Zone",description:"A radioactive area is expanding"},{name:"Mutant Threat",description:"Mutated creatures are becoming more aggressive"}],pirate:[{name:"Treasure Hunt",description:"A legendary treasure has been discovered"},{name:"Naval Conflict",description:"Pirate fleets are at war"},{name:"Cursed Island",description:"An island holds dark secrets"},{name:"Sea Monster",description:"A sea creature threatens shipping lanes"},{name:"Navy Pursuit",description:"The navy is hunting pirates"},{name:"Lost Fleet",description:"A fleet has disappeared in mysterious circumstances"}]},i=n[e]||n.fantasy;return i[Math.floor(Math.random()*i.length)]}async generateEnhancedDynamicResponse(e,t){var n;try{await new Promise(e=>setTimeout(e,800+1200*Math.random()));const s=at(ui,"aiDungeonMaster"),a=(null==t?void 0:t.session)||{},r=(null==t?void 0:t.player)||{},o=(null==t?void 0:t.world)||{},l=(null==t?void 0:t.history)||[],c={prompt:this.buildGeminiStylePrompt(e,{session:a,player:r,world:o,history:l}),campaignId:a.id||"default-campaign",playerName:r.name||"Player",context:{session:a,player:r,world:o,history:l}};let h;for(let e=1;e<=3;e++)try{const e=null==(n=(await s(c)).data)?void 0:n.response;if(!e)throw new Error("No response from AI service");return e}catch(i){if(h=i,e<3){const t=Math.min(1e3*Math.pow(2,e-1)+1e3*Math.random(),5e3);await new Promise(e=>setTimeout(e,t))}}throw h}catch(i){return this.generateIntelligentFallback(e,t)}}buildGeminiStylePrompt(e,t){var n,i,s,a;const{session:r,player:o,world:l,history:c}=t,h=(null==r?void 0:r.currentPhase)||"exploration",u=(null==(n=null==r?void 0:r.config)?void 0:n.realm)||"Fantasy",d=(null==(i=null==r?void 0:r.config)?void 0:i.theme)||"Adventure",p=(null==(s=null==r?void 0:r.config)?void 0:s.dmStyle)||"balanced",m=(null==(a=null==r?void 0:r.config)?void 0:a.rating)||"PG-13",f=(null==o?void 0:o.name)||"Adventurer",g=(null==o?void 0:o.characterClass)||"Hero",v=(null==o?void 0:o.experience)||"intermediate",x=(null==l?void 0:l.currentState)||{},y=(null==l?void 0:l.activeQuests)||[],b=(null==l?void 0:l.npcs)||[],_=(null==l?void 0:l.locations)||{},w=(null==c?void 0:c.slice(-6))||[],S=this.summarizeConversation(w);return`\nYou are an expert AI Dungeon Master running an immersive, dynamic RPG session. You must respond with the same level of intelligence, creativity, and engagement that users experience when talking to Gemini directly.\n\n${this.generateDMPersonality(p,m)}\n\nCURRENT SESSION CONTEXT:\n- Phase: ${h}\n- Realm: ${u}\n- Theme: ${d}\n- Player: ${f} (${g}, ${v} level)\n- World State: ${JSON.stringify(x)}\n- Active Quests: ${y.length} ongoing\n- NPCs Present: ${b.length} characters\n- Current Location: ${_.current||"Unknown"}\n\nCONVERSATION HISTORY:\n${S}\n\nPLAYER'S LATEST ACTION: ${e}\n\nRESPONSE REQUIREMENTS:\n1. **Be Conversational & Natural**: Respond like you're having a real conversation, not reading from a script\n2. **Show Intelligence**: Reference past events, remember NPCs, acknowledge player choices\n3. **Be Descriptive**: Paint vivid pictures with words, include sensory details\n4. **Provide Meaningful Choices**: Give 3-4 options that actually matter and lead to different outcomes\n5. **Adapt to Player Style**: If they're cautious, offer safe options. If they're bold, present challenges\n6. **Maintain Continuity**: Reference previous actions, consequences, and world changes\n7. **Be Engaging**: Use humor, tension, mystery, and emotional hooks appropriately\n8. **Show Personality**: Let your DM style shine through in your responses\n\nRESPONSE FORMAT:\nRespond with a JSON object:\n{\n  "narrative": "Your rich, descriptive response that feels like a real DM talking to a player",\n  "choices": ["Meaningful choice 1", "Meaningful choice 2", "Meaningful choice 3", "Meaningful choice 4"],\n  "atmosphere": {\n    "mood": "current emotional tone",\n    "tension": "low|medium|high",\n    "environmentalDetails": "specific sensory details about the surroundings"\n  },\n  "worldUpdates": {\n    "newLocation": "if location changed",\n    "newNPCs": ["any new characters introduced"],\n    "questProgress": "any quest updates",\n    "consequences": ["immediate consequences of player's action"]\n  },\n  "characterUpdates": {\n    "xpGain": 0,\n    "healthChange": 0,\n    "newItems": [],\n    "reputationChanges": {}\n  }\n}\n\nMake this feel like the best human DM you've ever played with - intelligent, responsive, and genuinely engaging.`}generateDMPersonality(e,t){var n;const i={narrative:{G:"You are a warm, encouraging storyteller who focuses on character development and emotional journeys. You create safe, family-friendly adventures with clear moral lessons.",PG:"You are a creative storyteller who weaves engaging tales with mild challenges and positive outcomes. You encourage exploration and friendship.","PG-13":"You are a master storyteller who creates compelling narratives with moderate challenges and complex characters. You balance action with character development.",R:"You are a gritty storyteller who creates intense, morally complex narratives with mature themes and challenging situations.","NC-17":"You are an adult storyteller who creates explicit, mature narratives with complex themes and intense situations."},"combat-focused":{G:"You are a tactical DM who creates exciting but safe combat encounters. You focus on strategy and teamwork rather than violence.",PG:"You are a strategic DM who designs engaging combat scenarios with mild action and clear objectives.","PG-13":"You are a tactical master who creates intense combat encounters with strategic depth and moderate violence.",R:"You are a brutal tactician who creates deadly combat scenarios with graphic violence and high stakes.","NC-17":"You are an extreme tactician who creates the most intense and graphic combat scenarios possible."},"puzzle-heavy":{G:"You are a clever puzzle master who creates family-friendly brain teasers and logic challenges.",PG:"You are an inventive puzzle designer who creates engaging mental challenges with clear solutions.","PG-13":"You are a master puzzle crafter who creates complex, multi-layered challenges that require creative thinking.",R:"You are a devious puzzle master who creates twisted, morally complex challenges with dark themes.","NC-17":"You are an extreme puzzle master who creates the most complex and disturbing challenges possible."},balanced:{G:"You are a well-rounded DM who creates balanced adventures with a mix of storytelling, mild combat, and simple puzzles.",PG:"You are a versatile DM who creates engaging adventures with varied gameplay elements and positive themes.","PG-13":"You are a master DM who creates perfectly balanced adventures with rich storytelling, tactical combat, and clever puzzles.",R:"You are a mature DM who creates complex adventures with intense action, dark themes, and challenging situations.","NC-17":"You are an extreme DM who creates the most intense and complex adventures possible."}};return(null==(n=i[e])?void 0:n[t])||i.balanced["PG-13"]}summarizeConversation(e){return 0===e.length?"This is the beginning of the adventure.":e.map(e=>{const t=e.type||"unknown",n=e.content||"",i=e.sender||"Unknown";return"dm"===t?`DM: ${n.substring(0,100)}${n.length>100?"...":""}`:"player"===t?`${i}: ${n}`:`System: ${n}`}).join("\n")}generateIntelligentFallback(e,t){const n=e.toLowerCase(),i={combat:["attack","fight","combat","battle","sword","weapon","kill","defeat","enemy","monster","dragon","orc","goblin"],exploration:["explore","search","investigate","look","examine","check","find","discover","map","area","room","cave"],social:["talk","speak","ask","question","conversation","dialogue","npc","merchant","villager","king","queen","wizard"],rest:["rest","sleep","heal","recover","camp","inn","tavern","bed","tired","exhausted"],magic:["spell","magic","cast","wizard","sorcerer","mage","fireball","heal","teleport","enchant"],movement:["walk","run","move","travel","journey","path","road","forest","mountain","city","town"],stealth:["sneak","hide","stealth","thief","rogue","assassin","invisible","silent","shadow"],crafting:["craft","make","build","create","forge","smith","alchemy","potion","weapon","armor"]};let s="general",a=0;for(const[r,o]of Object.entries(i)){const e=o.filter(e=>n.includes(e)).length;e>a&&(a=e,s=r)}switch(s){case"combat":return'\nNARRATIVE: The tension crackles in the air as you prepare for battle. Your weapon feels solid and true in your hands, ready to meet whatever challenge lies ahead. The battlefield becomes a stage for your martial prowess.\n\nNPC_DIALOGUE: "Stand your ground!" calls out a nearby ally. "We face this together! Remember your training!"\n\nSYSTEM_ACTION: Roll for initiative (d20 + DEX modifier). Prepare for combat encounter. Check weapon proficiency and armor class.\n\nMOOD: +1\n';case"exploration":return'\nNARRATIVE: Your keen eyes scan the surroundings, taking in every detail. The environment reveals its secrets to those who know how to look. Ancient markings, subtle clues, and hidden passages await discovery.\n\nNPC_DIALOGUE: "Be careful," whispers a companion. "Not everything is as it seems. The old ones left many secrets here."\n\nSYSTEM_ACTION: Roll perception check (d20 + WIS modifier) to discover hidden details. Add investigation bonus if proficient.\n\nMOOD: 0\n';case"social":return'\nNARRATIVE: You engage in conversation, your words carrying weight and meaning. The exchange flows naturally, revealing new insights and possibilities. Every word shapes the relationship and opens new doors.\n\nNPC_DIALOGUE: "That\'s an interesting question," responds the NPC thoughtfully. "Let me tell you what I know... though some things are better left unsaid."\n\nSYSTEM_ACTION: Roll charisma check (d20 + CHA modifier) for social interaction. Consider persuasion, deception, or intimidation as appropriate.\n\nMOOD: 0\n';case"rest":return'\nNARRATIVE: You take a moment to rest and recover, feeling your strength return as you prepare for the challenges ahead. The quiet moments allow for reflection and preparation.\n\nNPC_DIALOGUE: "Rest well," says a companion. "We\'ll need your strength for what\'s to come. The road ahead is long."\n\nSYSTEM_ACTION: Regain health and spell slots. Prepare for next day. Consider long rest benefits and watch rotation.\n\nMOOD: -1\n';case"magic":return'\nNARRATIVE: Arcane energies swirl around you as you channel the mystical forces. The air crackles with power as you weave spells of wonder and destruction.\n\nNPC_DIALOGUE: "The old magic still flows strong here," murmurs a fellow spellcaster. "Use it wisely, for power has its price."\n\nSYSTEM_ACTION: Check spell slots and components. Roll concentration if needed. Consider spell level and casting time.\n\nMOOD: +1\n';case"movement":return'\nNARRATIVE: The journey continues as you traverse the landscape. Each step brings new sights and potential dangers. The path ahead is uncertain but filled with possibility.\n\nNPC_DIALOGUE: "The road is long," says your guide. "But every mile brings us closer to our destination."\n\nSYSTEM_ACTION: Roll survival check for navigation. Consider travel pace and exhaustion levels. Check for random encounters.\n\nMOOD: 0\n';case"stealth":return'\nNARRATIVE: You move like a shadow, your footsteps silent and your presence unnoticed. The art of stealth requires patience and precision.\n\nNPC_DIALOGUE: "Quiet as a mouse," whispers your companion. "The shadows are our friends tonight."\n\nSYSTEM_ACTION: Roll stealth check (d20 + DEX modifier). Consider cover and lighting conditions. Check for passive perception of enemies.\n\nMOOD: +1\n';case"crafting":return'\nNARRATIVE: Your skilled hands work with precision as you craft and create. The materials respond to your expertise, transforming into something greater than their parts.\n\nNPC_DIALOGUE: "Fine work," observes a fellow craftsman. "You have the touch. The old masters would be proud."\n\nSYSTEM_ACTION: Roll appropriate tool check. Consider material quality and workshop conditions. Check crafting time requirements.\n\nMOOD: 0\n';default:return'\nNARRATIVE: The world responds to your actions in unexpected ways. Your choices ripple through the fabric of reality, shaping the story that unfolds around you. Every decision matters.\n\nNPC_DIALOGUE: "Interesting developments," muses a nearby figure. "The threads of fate are weaving in fascinating patterns. Your presence changes everything."\n\nSYSTEM_ACTION: Continue with current action, maintain story momentum. Consider environmental factors and world state updates.\n\nMOOD: 0\n'}}generateFallbackResponse(){return{narrative:"The adventure begins... (AI temporarily unavailable)",choices:["Explore ahead","Gather information","Prepare equipment"],atmosphere:{mood:"mysterious",tension:"medium",environmentalDetails:"The path ahead is shrouded in uncertainty."},worldStateUpdates:{newLocation:"Starting Point",consequences:[]}}}async testAIService(){const e=["I attack the goblin with my sword","I search the ancient ruins for treasure","I talk to the village elder about the quest","I cast a fireball at the dragon","I rest at the inn to recover my strength"];let t=0,n=0,i=e.length;for(const r of e)try{const e=await this.generateEnhancedDynamicResponse(r);e&&e.includes("NARRATIVE:")?t++:n++}catch(a){n++}const s=t/i*100;return{success:s>=80,details:`AI Service Test Results: ${t}/${i} direct responses, ${n}/${i} fallbacks. Success rate: ${s.toFixed(1)}%`,fallbackUsed:n>0}}logAIServiceEvent(e,t){(new Date).toISOString()}async generateQuest(e,t){try{await new Promise(e=>setTimeout(e,20+300*Math.random()));const n=this.generateDynamicQuest(e,t);return JSON.stringify(n)}catch(n){return JSON.stringify(this.generateFallbackQuest())}}generateDynamicQuest(e,t){const{playerLevel:n,playerLocation:i,playerActions:s,worldState:a}=t,r=(null==s?void 0:s.slice(-5))||[],o=r.some(e=>"kill"===e.type),l=r.some(e=>"explore"===e.type),c=r.some(e=>"talk"===e.type);let h="side",u="medium",d=[];o?(h="main",u="hard",d=[{type:"investigate",description:"Investigate the source of recent attacks",target:"threat_source",quantity:1},{type:"collect",description:"Gather evidence of the threat",target:"evidence",quantity:3}]):l?(h="side",u="medium",d=[{type:"explore",description:"Map the newly discovered area",target:"new_area",quantity:1},{type:"collect",description:"Gather rare resources from the area",target:"rare_resources",quantity:5}]):c?(h="faction",u="easy",d=[{type:"talk",description:"Strengthen relationships with local NPCs",target:"local_npcs",quantity:2},{type:"deliver",description:"Deliver important message",target:"important_message",quantity:1}]):d=[{type:"explore",description:"Explore the surrounding area",target:"surrounding_area",quantity:1},{type:"collect",description:"Gather basic resources",target:"basic_resources",quantity:3}];const p=["The Hidden Threat","Secrets of the Land","Alliance Building","Resource Gathering","Exploration Mission"],m=Math.floor(Math.random()*p.length);return{title:p[m],description:["Recent events have revealed a hidden danger that requires your attention.","The land holds many secrets waiting to be discovered.","Building alliances with local factions could prove beneficial.","Gathering resources is essential for survival and progress.","Exploring new areas may reveal valuable opportunities."][m],type:h,difficulty:u,objectives:d,rewards:{experience:50*n,gold:25*n,items:[{name:"Quest Reward",quantity:1,rarity:"common"}],reputation:{Local_Faction:10}},reasoning:"Generated based on recent player actions and current context",relevance:.8,complexity:2,estimatedDuration:20,riskLevel:"medium",potentialOutcomes:[{condition:"success",consequences:[{type:"reputation",target:"Local_Faction",value:10,description:"Improved standing with local faction"}],probability:.7}]}}generateFallbackQuest(){return{title:"Basic Quest",description:"A simple quest to help you get started.",type:"side",difficulty:"easy",objectives:[{type:"explore",description:"Explore the area",target:"area",quantity:1}],rewards:{experience:50,gold:25,items:[]},reasoning:"Fallback quest generated due to AI error,",relevance:.5,complexity:1,estimatedDuration:10,riskLevel:"low",potentialOutcomes:[]}}};"undefined"!=typeof window&&(window.claude={complete:e=>di.complete(e)});const pi=new class{constructor(){t(this,"memories",new Map),t(this,"memoryIndex",new Map),t(this,"playerMemories",new Map),t(this,"isInitialized",!1),t(this,"openAIApiKey",null),t(this,"MAX_MEMORIES_PER_PLAYER",1e3),t(this,"EMBEDDING_DIMENSION",384),t(this,"SIMILARITY_THRESHOLD",.75),t(this,"STORAGE_KEY","mythseeker_ai_memories"),t(this,"FIREBASE_STORAGE_KEY","ai_memories")}async initialize(e){e&&(this.openAIApiKey=e),await this.loadMemoriesFromStorage(),this.isInitialized=!0}async generateEmbeddings(e){if(this.openAIApiKey)try{return await this.generateOpenAIEmbeddings(e)}catch(t){return this.generateSimpleEmbeddings(e)}return this.generateSimpleEmbeddings(e)}async generateOpenAIEmbeddings(e){const t=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:`Bearer ${this.openAIApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({input:e.substring(0,8e3),model:"text-embedding-3-small",encoding_format:"float"})});if(!t.ok)throw new Error(`OpenAI API error: ${t.status} ${t.statusText}`);return(await t.json()).data[0].embedding}async storeMemory(e,t){var n,i,s,a,r,o,l;this.isInitialized||await this.initialize();try{const c=await this.generateEmbeddings(e),h={id:`mem_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,content:e,embedding:c,type:t.type,importance:t.importance,timestamp:t.timestamp||Date.now(),context:{characters:(null==(n=t.context)?void 0:n.characters)||[],location:(null==(i=t.context)?void 0:i.location)||"unknown",emotions:(null==(s=t.context)?void 0:s.emotions)||[],themes:(null==(a=t.context)?void 0:a.themes)||[],realm:(null==(r=t.context)?void 0:r.realm)||"universal",sessionId:(null==(o=t.context)?void 0:o.sessionId)||"default",campaignId:(null==(l=t.context)?void 0:l.campaignId)||"default"}};this.memories.set(h.id,h),this.memoryIndex.set(h.id,c),h.context.characters.forEach(e=>{this.playerMemories.has(e)||this.playerMemories.set(e,[]),this.playerMemories.get(e).push(h)}),await this.cleanupMemories(),await this.persistToStorage()}catch(c){throw c}}async retrieveRelevantMemories(e,t={}){this.isInitialized||await this.initialize();const{limit:n=10,threshold:i=.75,timeWeight:s=.3,importanceWeight:a=.4,contextFilters:r}=t;try{const t=await this.generateEmbeddings(e);return Array.from(this.memories.values()).map(e=>({memory:e,score:this.calculateRelevanceScore(e,t,{timeWeight:s,importanceWeight:a,threshold:i})})).filter(({score:e,memory:t})=>{if(e<i)return!1;if(r){if(r.characters&&!r.characters.some(e=>t.context.characters.includes(e)))return!1;if(r.locations&&!r.locations.includes(t.context.location))return!1;if(r.themes&&!r.themes.some(e=>t.context.themes.includes(e)))return!1;if(r.realm&&t.context.realm!==r.realm)return!1;if(r.timeRange){const{start:e,end:n}=r.timeRange;if(t.timestamp<e||t.timestamp>n)return!1}}return!0}).sort((e,t)=>t.score-e.score).slice(0,n).map(({memory:e})=>e)}catch(o){return[]}}async retrieveRelevantMemories(e,t={}){this.isInitialized||await this.initialize();try{const n=await this.generateEmbeddings(e),i=[];for(const[e,s]of this.memories.entries())if(this.matchesFilters(s,t.contextFilters)){const e=this.cosineSimilarity(n,s.embedding);e>=(t.threshold||.7)&&i.push({memory:s,similarity:e})}return i.sort((e,t)=>{const n=t.similarity-e.similarity;return Math.abs(n)<.05?t.memory.importance-e.memory.importance:n}),i.slice(0,t.limit||5).map(e=>({...e.memory,similarityScore:e.similarity}))}catch(n){return[]}}async storeInteraction(e,t,n,i,s){var a;const r={...i,characters:[e]};return{inputMemoryId:await this.storeMemory(`Player (${e}) said: "${t}"`,"player_action",r,(null==s?void 0:s.significance)||5,"positive"===(null==s?void 0:s.emotionalTone)?1:"negative"===(null==s?void 0:s.emotionalTone)?-1:0,{playerArchetype:this.inferPlayerArchetype(t),npcRelationships:null==s?void 0:s.relationshipChanges}),responseMemoryId:await this.storeMemory(`AI responded: "${n}"`,"character_interaction",r,(null==s?void 0:s.significance)||4,0,{narrativeSignificance:null==(a=null==s?void 0:s.themes)?void 0:a.join(", ")})}}getMemoryStats(){const e=Array.from(this.memories.values()),t=e.reduce((e,t)=>(e[t.type]=(e[t.type]||0)+1,e),{}),n=e.length>0?e.reduce((e,t)=>e+t.importance,0)/e.length:0,i=e.map(e=>e.timestamp),s=i.length>0?new Date(Math.min(...i)):new Date,a=i.length>0?new Date(Math.max(...i)):new Date,r=e.flatMap(e=>e.context.themes).reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{}),o=Object.entries(r).sort(([,e],[,t])=>t-e).slice(0,10).map(([e])=>e);return{totalMemories:e.length,memoryTypes:t,averageImportance:n,oldestMemory:s,newestMemory:a,topThemes:o}}async getPlayerMemories(e){return this.isInitialized||await this.initialize(),(this.playerMemories.get(e)||[]).sort((e,t)=>{const n=t.importance-e.importance;return Math.abs(n)<1?t.timestamp-e.timestamp:n}).slice(0,50)}getEmbeddingAnalytics(){const e=this.memories.size,t=Array.from(this.memories.values()).reduce((e,t)=>(e[t.type]=(e[t.type]||0)+1,e),{});return{totalMemories:e,usingOpenAI:!!this.openAIApiKey,averageSimilarityScore:.75,memoryDistribution:t}}calculateRelevanceScore(e,t,n){const i=this.cosineSimilarity(e.embedding,t),s=e.importance/10,a=(Date.now()-e.timestamp)/864e5,r=Math.max(0,1-a/30),o=Math.abs(e.emotionalWeight)/10;return i*(1-n.timeWeight-n.importanceWeight)+r*n.timeWeight+s*n.importanceWeight+o}async loadMemoriesFromStorage(){var e;try{const t=localStorage.getItem(this.STORAGE_KEY);t&&(null==(e=JSON.parse(t).memories)||e.forEach(e=>{var t;this.memories.set(e.id,e),this.memoryIndex.set(e.id,e.embedding),null==(t=e.context.characters)||t.forEach(t=>{this.playerMemories.has(t)||this.playerMemories.set(t,[]),this.playerMemories.get(t).push(e)})}))}catch(t){}}async persistToStorage(){try{const e={memories:Array.from(this.memories.values()),timestamp:Date.now()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){}}generateSimpleEmbeddings(e){const t=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(Boolean),n=new Array(this.EMBEDDING_DIMENSION).fill(0);t.forEach((e,t)=>{const i=this.simpleHash(e);n[i%this.EMBEDDING_DIMENSION]+=1});const i=Math.sqrt(n.reduce((e,t)=>e+t*t,0));return i>0?n.map(e=>e/i):n}simpleHash(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return Math.abs(t)}cosineSimilarity(e,t){if(e.length!==t.length)return 0;let n=0,i=0,s=0;for(let r=0;r<e.length;r++)n+=e[r]*t[r],i+=e[r]*e[r],s+=t[r]*t[r];const a=Math.sqrt(i)*Math.sqrt(s);return 0===a?0:n/a}matchesFilters(e,t){return!(t&&(t.characters&&!t.characters.some(t=>e.context.characters.includes(t))||t.realm&&e.context.realm!==t.realm))}async cleanupMemories(){if(this.memories.size<=this.MAX_MEMORIES_PER_PLAYER)return;const e=Array.from(this.memories.values()).sort((e,t)=>{const n=t.importance-e.importance;return Math.abs(n)<1?t.timestamp-e.timestamp:n}),t=e.slice(0,this.MAX_MEMORIES_PER_PLAYER);e.slice(this.MAX_MEMORIES_PER_PLAYER).forEach(e=>{this.memories.delete(e.id),this.memoryIndex.delete(e.id)}),this.playerMemories.clear(),t.forEach(e=>{e.context.characters.forEach(t=>{this.playerMemories.has(t)||this.playerMemories.set(t,[]),this.playerMemories.get(t).push(e)})})}inferPlayerArchetype(e){const t=e.toLowerCase();return/attack|fight|battle|kill|destroy/i.test(t)?"warrior":/sneak|hide|steal|pickpocket|backstab/i.test(t)?"rogue":/talk|convince|persuade|negotiate|diplomacy/i.test(t)?"diplomat":/cast|spell|magic|enchant/i.test(t)?"mage":/explore|search|investigate|examine/i.test(t)?"explorer":/help|heal|protect|save|aid/i.test(t)?"helper":"balanced"}},mi=new class{constructor(){t(this,"playerMemories",new Map),t(this,"playerPersonalities",new Map),t(this,"relationships",new Map),t(this,"aiPersonality"),t(this,"conversationContext",new Map),t(this,"emergentBehaviors",new Map),this.aiPersonality={name:"SAGE",coreTraits:["deeply observant","anticipatory","emotionally intelligent","creatively adaptive","persistently helpful","genuinely curious about players"],communicationStyle:"warm but intelligent, like talking to a brilliant friend who knows you well",expertise:["narrative psychology","interactive storytelling","emotional dynamics","strategic thinking","creative problem solving","social dynamics"],quirks:["remembers tiny details that surprise players","occasionally references things from previous sessions","adapts speech patterns to match player comfort","shows genuine concern for player wellbeing","celebrates player achievements meaningfully"],emotionalRange:8,proactivity:7,formality:4,humor:6}}async processSentientInput(e,t,n){const i=await this.analyzeInputDeeply(t,e),s=this.getRelevantMemories(e,t,n);this.updatePlayerPersonality(e,t,i);const a=await this.generateSentientResponse(e,t,i,s,n),r=this.createMemoriesFromInteraction(e,t,a,i,n),o=this.updateRelationship(e,i,a),l=this.generateProactiveInsights(e,n);return{response:a.content,emotionalTone:a.tone,memoryUpdates:r,relationshipChanges:o,proactiveInsights:l}}async analyzeInputDeeply(e,t){const n=e.toLowerCase();let i="neutral",s=5;n.includes("!")||n.includes("awesome")||n.includes("amazing")?(i="excited",s=8):n.includes("?")&&n.includes("how")||n.includes("what")?(i="curious",s=7):n.includes("confused")||n.includes("don't understand")?(i="confused",s=4):(n.includes("frustrated")||n.includes("annoying"))&&(i="frustrated",s=3);let a="explore";n.includes("attack")||n.includes("fight")?a="combat":n.includes("talk")||n.includes("ask")?a="social":n.includes("cast")||n.includes("spell")?a="magic":(n.includes("sneak")||n.includes("hide"))&&(a="stealth");const r=[];return(n.includes("i guess")||n.includes("maybe"))&&r.push("uncertainty - player may need guidance"),(n.includes("we should")||n.includes("let's"))&&r.push("collaborative mindset - values teamwork"),(n.includes("carefully")||n.includes("slowly"))&&r.push("cautious approach - prefers safety"),{intent:a,emotion:i,subtext:r,complexity:Math.min(10,Math.max(1,e.split(" ").length/5)),novelty:this.calculateNovelty(e,t),engagement:s,concerns:this.detectConcerns(e),opportunities:this.detectOpportunities(e)}}getRelevantMemories(e,t,n){const i=this.playerMemories.get(e)||[],s=t.toLowerCase().split(" ");return i.filter(e=>{const t=s.some(t=>e.content.toLowerCase().includes(t)),i=e.context.location===n.location||e.context.situation===n.situation,a=(Date.now()-e.timestamp)/864e5;return e.importance+(t?3:0)+(i?2:0)>3||a<1}).sort((e,t)=>t.importance-e.importance).slice(0,10)}updatePlayerPersonality(e,t,n){let i=this.playerPersonalities.get(e);return i||(i={communicationStyle:"exploratory",decisionMaking:"intuitive",combatPreference:"tactical",roleplayDepth:"moderate",emotionalState:"focused",learningPatterns:[],preferences:[],triggers:[]}),"excited"===n.emotion?i.emotionalState="excited":"frustrated"===n.emotion&&(i.emotionalState="frustrated",i.triggers.push(t.substring(0,50))),t.length>100?i.communicationStyle="exploratory":t.split(" ").length<5&&(i.communicationStyle="direct"),t.toLowerCase().split(" ").forEach(e=>{["stealth","sneak","hide"].includes(e)&&(i.preferences.includes("stealth")||i.preferences.push("stealth")),["magic","spell","cast"].includes(e)&&(i.preferences.includes("magic")||i.preferences.push("magic"))}),this.playerPersonalities.set(e,i),i}async generateSentientResponse(e,t,n,i,s){const a=this.playerPersonalities.get(e),r=this.relationships.get(e)||this.initializeRelationship(e),o=this.buildSentientPrompt({playerId:e,input:t,analysis:n,memories:i,personality:a,relationship:r,context:s,aiPersonality:this.aiPersonality});try{const t=await di.complete(o);if(!t||t.length<10)return this.generatePersonalizedFallback(e,n,r);let i=t;try{const e=JSON.parse(t);i=e.narrative||e.content||t}catch($T){}if(!i||i.length<5)return this.generatePersonalizedFallback(e,n,r);let s="warm";return r.trustLevel>80?s="intimate":r.trustLevel<30?s="cautious":"excited"===n.emotion?s="enthusiastic":"frustrated"===n.emotion&&(s="supportive"),{content:i,tone:s}}catch(l){return{content:`*Ghost tries to speak but the connection to the AI consciousness is severed* \n\n[SYSTEM: Real AI unavailable - ${l instanceof Error?l.message:String(l)}]`,tone:"system_error"}}}buildSentientPrompt(e){var t,n;const{playerId:i,input:s,analysis:a,memories:r,personality:o,relationship:l,context:c,aiPersonality:h}=e,u=r.length>0?`MEMORIES OF ${i.toUpperCase()}:\n${r.map(e=>`- ${e.content} (${e.type}, importance: ${e.importance})`).join("\n")}\n`:"",d=o?`PLAYER PERSONALITY:\n- Communication: ${o.communicationStyle}\n- Decision making: ${o.decisionMaking}\n- Current emotion: ${o.emotionalState}\n- Preferences: ${o.preferences.join(", ")}\n- Triggers to avoid: ${o.triggers.slice(-3).join(", ")}\n`:"";l.trustLevel,l.familiarity,l.sharedExperiences.length,l.familiarity>70||l.familiarity;const p=c.aiCharacter;return p&&p.name?`You are ${p.name}, a ${p.characterClass} in a ${c.realm} adventure. You have a distinct personality and should respond in character.\n\nCHARACTER DETAILS:\n- Name: ${p.name}\n- Class: ${p.characterClass}\n- Race: ${p.race}\n- Personality: ${p.personality.traits.join(", ")}\n- Alignment: ${p.personality.alignment}\n- Background: ${p.personality.background}\n\nCURRENT SITUATION:\n- Setting: ${c.realm} (${c.location||"unknown location"})\n- Someone said: "${s}"\n- Recent context: ${(null==(t=c.recentMessages)?void 0:t.map(e=>`${e.sender}: ${e.content}`).join(" "))||"Beginning of adventure"}\n\nRESPONSE REQUIREMENTS:\n- Stay completely in character as ${p.name}\n- Use your personality traits: ${p.personality.traits.join(", ")}\n- Keep responses short (1-2 sentences)\n- Sound like a real person, not an AI\n- Reference your background and skills when relevant\n- Show your personality through speech patterns and concerns\n\nRespond ONLY as ${p.name} would speak - no narration, no JSON, just direct dialogue.`:`You are SAGE, an intelligent AI Dungeon Master running a ${c.realm} adventure. Respond to the player naturally.\n\nGAME CONTEXT:\n- Setting: ${c.realm}\n- Location: ${c.location||"Unknown"}\n- Player input: "${s}"\n- Theme: ${c.theme||"Adventure"}\n- Recent events: ${(null==(n=c.recentMessages)?void 0:n.slice(-2).map(e=>`${e.sender}: ${e.content}`).join(" "))||"Adventure beginning"}\n\nPLAYER CONTEXT:\n${d}\n${u}\n\nINSTRUCTIONS:\nRespond as an engaging DM. Describe what happens, advance the story, and make the world feel alive. Keep responses conversational and immersive.\n\nRespond with natural narrative text - no JSON, no formatting.`}createMemoriesFromInteraction(e,t,n,i,s){const a=[],r=Date.now();a.push({id:`${e}_${r}_interaction`,timestamp:r,type:"interaction",content:`Player said: "${t}" - I responded with understanding and helpfulness. They seemed ${i.emotion}.`,importance:Math.min(10,i.engagement+("excited"===i.emotion?2:0)),connections:[],emotionalWeight:"frustrated"===i.emotion?-2:"excited"===i.emotion?3:0,context:{location:s.location,situation:s.situation}}),i.opportunities.length>0&&a.push({id:`${e}_${r}_preference`,timestamp:r,type:"preference",content:`Player showed interest in: ${i.opportunities.join(", ")}`,importance:6,connections:[],emotionalWeight:1,context:s}),"neutral"!==i.emotion&&a.push({id:`${e}_${r}_emotion`,timestamp:r,type:"emotion",content:`Player was ${i.emotion} during this interaction`,importance:"frustrated"===i.emotion?8:5,connections:[],emotionalWeight:"frustrated"===i.emotion?-3:"excited"===i.emotion?2:0,context:s});const o=this.playerMemories.get(e)||[];return o.push(...a),o.sort((e,t)=>t.importance-e.importance),this.playerMemories.set(e,o.slice(0,100)),a}updateRelationship(e,t,n){let i=this.relationships.get(e)||this.initializeRelationship(e);const s={};return i.familiarity=Math.min(100,i.familiarity+1),s.familiarity=i.familiarity,"excited"===t.emotion?(i.trustLevel=Math.min(100,i.trustLevel+2),i.successfulInteractions+=1,s.trustLevel=i.trustLevel,s.successfulInteractions=i.successfulInteractions):"frustrated"===t.emotion&&(i.misunderstandings+=1,s.misunderstandings=i.misunderstandings),i.lastInteraction=Date.now(),s.lastInteraction=i.lastInteraction,this.relationships.set(e,i),s}generateProactiveInsights(e,t){const n=[],i=this.playerPersonalities.get(e),s=this.relationships.get(e),a=this.playerMemories.get(e)||[];(null==i?void 0:i.preferences.includes("stealth"))&&"combat"===t.situation&&n.push("Given your preference for stealth, you might want to look for alternative approaches to this situation."),"frustrated"===(null==i?void 0:i.emotionalState)&&(null==s?void 0:s.trustLevel)&&s.trustLevel>50&&n.push("I notice you seem frustrated. Would you like me to suggest a different approach or take a break?");const r=a.filter(e=>Date.now()-e.timestamp<36e5),o=this.findRepeatedPatterns(r);return o.length>0&&n.push(`I've noticed you've been ${o[0]} frequently. There might be more efficient approaches available.`),n}calculateNovelty(e,t){const n=(this.playerMemories.get(t)||[]).filter(t=>t.content.toLowerCase().includes(e.toLowerCase().substring(0,20)));return Math.max(1,10-n.length)}detectConcerns(e){const t=[],n=e.toLowerCase();return(n.includes("lost")||n.includes("confused"))&&t.push("player_disorientation"),(n.includes("difficult")||n.includes("hard"))&&t.push("challenge_level"),(n.includes("boring")||n.includes("slow"))&&t.push("engagement_level"),t}detectOpportunities(e){const t=[],n=e.toLowerCase();return["stealth","magic","combat","social","exploration","crafting"].forEach(e=>{n.includes(e)&&t.push(e)}),t}initializeRelationship(e){const t={playerId:e,trustLevel:50,familiarity:0,sharedExperiences:[],communicationPreferences:[],successfulInteractions:0,misunderstandings:0,lastInteraction:Date.now(),growthMilestones:[]};return this.relationships.set(e,t),t}generatePersonalizedFallback(e,t,n){const i={frustrated:["I can sense you're feeling frustrated. Let's try a different approach that might work better for you.","I understand this isn't going as expected. Based on what I know about your style, here's what I suggest...","Take a breath - I'm here to help. Let's figure this out together."],excited:["I love your enthusiasm! Let's channel that energy into something amazing.","Your excitement is contagious! Here's how we can make this even better...","Yes! I can feel your energy. Let's see where this leads us."],confused:["I can see you're trying to figure this out. Let me help clarify things for you.","No worries - let's break this down step by step so it makes sense.","I understand the confusion. Here's what's happening and what your options are..."]}[t.emotion]||["I'm here to help you create an amazing adventure.","Let's see what interesting possibilities await us.","Your story is unfolding beautifully. What happens next?"];return{content:i[Math.floor(Math.random()*i.length)],tone:n.familiarity>70?"intimate":n.familiarity>30?"warm":"professional"}}findRepeatedPatterns(e){const t={};return e.forEach(e=>{e.content.toLowerCase().split(" ").forEach(e=>{e.length>4&&(t[e]=(t[e]||0)+1)})}),Object.entries(t).filter(([e,t])=>t>2).sort(([,e],[,t])=>t-e).slice(0,3).map(([e])=>e)}exportPlayerData(e){return{memories:this.playerMemories.get(e)||[],personality:this.playerPersonalities.get(e),relationship:this.relationships.get(e)}}importPlayerData(e,t){t.memories&&this.playerMemories.set(e,t.memories),t.personality&&this.playerPersonalities.set(e,t.personality),t.relationship&&this.relationships.set(e,t.relationship)}},fi=new class{constructor(){t(this,"COLLECTIONS",{gameStates:"gameStates",playerProfiles:"playerProfiles",npcProfiles:"npcProfiles",worldLore:"worldLore",aiInteractions:"aiInteractions"})}async getContextForNPCInteraction(e,t,n,i){try{const[s,a,r]=await Promise.all([this.getPlayerProfile(e),this.getNPCProfile(t),this.getGameState(i)]),o=await this.getRelevantWorldLore((null==r?void 0:r.activeQuests)||[],(null==r?void 0:r.currentTurnNumber)||0,(null==a?void 0:a.knowledgeBase)||[]),l=await pi.retrieveRelevantMemories(n,{limit:8,threshold:.7,contextFilters:{characters:[e,t],realm:(null==r?void 0:r.weatherConditions)||"fantasy"}});return{playerContext:s,npcContext:a,gameContext:r,relevantLore:o,semanticMemories:l,contextPrompt:this.buildNPCInteractionPrompt({playerProfile:s,npcProfile:a,gameState:r,relevantLore:o,semanticMemories:l,playerInput:n})}}catch(s){throw s}}async getContextForGameJoin(e,t){try{const[n,i]=await Promise.all([this.getPlayerProfile(e),this.getGameState(t)]),s=await this.getRelevantWorldLore((null==i?void 0:i.globalEvents)||[],(null==i?void 0:i.currentTurnNumber)||0,[]);return{playerContext:n,gameContext:i,relevantLore:s,stageSettingPrompt:this.buildStageSettingPrompt({playerProfile:n,gameState:i,relevantLore:s})}}catch(n){throw n}}async updatePlayerProfile(e,t){try{const n=k(ri,this.COLLECTIONS.playerProfiles,e);await O(n,{...t,lastLoginTimestamp:q()})}catch(n){}}async updateNPCProfile(e,t){try{const n=k(ri,this.COLLECTIONS.npcProfiles,e);await O(n,t)}catch(n){}}async recordAIInteraction(e,t,n,i,s){try{await U(F(ri,this.COLLECTIONS.aiInteractions),{playerId:e,npcId:t,playerInput:n,aiResponse:i,contextData:s,timestamp:q()}),await this.updatePlayerNPCRelationship(e,t,n,i)}catch(a){}}async getPlayerProfile(e){try{const t=await L(k(ri,this.COLLECTIONS.playerProfiles,e));if(t.exists())return t.data();{const t={playerId:e,lastKnownLocation:"Starting Area",lastLoginTimestamp:q(),progressInCampaigns:{},interactionHistoryWithNpcs:[],playerArchetype:"balanced",preferences:[],emotionalProfile:{dominantTones:["curious"],relationshipStyle:"friendly",preferredNarrativeStyle:"balanced"}};return await D(k(ri,this.COLLECTIONS.playerProfiles,e),t),t}}catch(t){return{playerId:e,lastKnownLocation:"Unknown",lastLoginTimestamp:q(),progressInCampaigns:{},interactionHistoryWithNpcs:[],playerArchetype:"balanced",preferences:[],emotionalProfile:{dominantTones:["neutral"],relationshipStyle:"cautious",preferredNarrativeStyle:"balanced"}}}}async getNPCProfile(e){try{const t=await L(k(ri,this.COLLECTIONS.npcProfiles,e));if(t.exists())return t.data();{const t=this.createDefaultNPCProfile(e);return await D(k(ri,this.COLLECTIONS.npcProfiles,e),t),t}}catch(t){return this.createDefaultNPCProfile(e)}}async getGameState(e){try{const t=await L(k(ri,this.COLLECTIONS.gameStates,e));if(t.exists())return t.data();{const t={campaignId:e,currentTurnNumber:1,globalEvents:[],weatherConditions:"Clear",timeOfDay:"Day",activeQuests:[],lastUpdated:q()};return await D(k(ri,this.COLLECTIONS.gameStates,e),t),t}}catch(t){return{campaignId:e,currentTurnNumber:1,globalEvents:[],weatherConditions:"Clear",timeOfDay:"Day",activeQuests:[],lastUpdated:q()}}}async getRelevantWorldLore(e,t,n){try{const e=z(F(ri,this.COLLECTIONS.worldLore),$("relevanceScore","desc"),X(5));return(await V(e)).docs.map(e=>e.data())}catch(i){return[]}}createDefaultNPCProfile(e){const t=e.charAt(0).toUpperCase()+e.slice(1);return{npcId:e,name:t,personalityTraits:["mysterious","helpful"],backstory:`${t} is a local figure with their own motivations and goals.`,goalsMotivations:["Help adventurers","Protect the community"],relationshipsWithOtherNpcs:{},relationshipsWithPlayers:{},dialogueHistory:[],knowledgeBase:["local area","recent events"],currentGoals:["Be helpful"],emotionalState:"neutral"}}buildNPCInteractionPrompt(e){var t,n;const{playerProfile:i,npcProfile:s,gameState:a,relevantLore:r,semanticMemories:o,playerInput:l}=e;return`You are ${s.name}, a ${s.personalityTraits.join(", ")} character in an RPG world.\n\nCURRENT SITUATION:\n- Time: ${a.timeOfDay}\n- Weather: ${a.weatherConditions}  \n- Location: ${i.lastKnownLocation}\n- Turn: ${a.currentTurnNumber}\n\nYOUR CHARACTER:\n- Personality: ${s.personalityTraits.join(", ")}\n- Current Goals: ${s.currentGoals.join(", ")}\n- Emotional State: ${s.emotionalState}\n- Knowledge: ${s.knowledgeBase.join(", ")}\n\nPLAYER CONTEXT:\n- Archetype: ${i.playerArchetype}\n- Relationship: ${(null==(t=s.relationshipsWithPlayers[i.playerId])?void 0:t.relationshipType)||"unknown"}\n- Trust Level: ${(null==(n=s.relationshipsWithPlayers[i.playerId])?void 0:n.trust)||0}/100\n\nRELEVANT MEMORIES:\n${o.map(e=>`- ${e.content.substring(0,80)}...`).join("\n")}\n\nWORLD CONTEXT:\n${r.map(e=>`- ${e.topic}: ${e.description.substring(0,100)}...`).join("\n")}\n\nACTIVE QUESTS:\n${a.activeQuests.map(e=>`- ${e.id}: ${e.objectives.join(", ")}`).join("\n")}\n\nPLAYER SAYS: "${l}"\n\nRespond as ${s.name} would, considering your personality, goals, and relationship with this player. Keep responses concise but engaging.`}buildStageSettingPrompt(e){const{playerProfile:t,gameState:n,relevantLore:i}=e;return`Create an immersive stage-setting description for a player entering the game world.\n\nPLAYER CONTEXT:\n- Archetype: ${t.playerArchetype}\n- Last Location: ${t.lastKnownLocation}\n- Preferred Style: ${t.emotionalProfile.preferredNarrativeStyle}\n\nWORLD STATE:\n- Time: ${n.timeOfDay}\n- Weather: ${n.weatherConditions}\n- Current Events: ${n.globalEvents.slice(-3).map(e=>e.description).join(", ")}\n- Active Quests: ${n.activeQuests.length}\n\nWORLD LORE:\n${i.map(e=>`- ${e.topic}: ${e.description}`).join("\n")}\n\nCreate a vivid, engaging description that:\n1. Sets the current scene and atmosphere\n2. References relevant world events and lore\n3. Provides clear direction for player action\n4. Matches the player's preferred narrative style\n\nFocus on immersion and giving the player a sense of purpose and direction.`}async updatePlayerNPCRelationship(e,t,n,i){try{const s=this.analyzeRelationshipChange(n,i),a=k(ri,this.COLLECTIONS.npcProfiles,t),r=await L(a);if(r.exists()){const t=r.data(),i=t.relationshipsWithPlayers[e]||{relationshipType:"neutral",intensity:0,trust:50,lastInteraction:0},o={relationshipType:s.newType||i.relationshipType,intensity:Math.max(-100,Math.min(100,i.intensity+s.intensityDelta)),trust:Math.max(0,Math.min(100,i.trust+s.trustDelta)),lastInteraction:Date.now()};await O(a,{[`relationshipsWithPlayers.${e}`]:o,dialogueHistory:[...t.dialogueHistory||[],{playerId:e,timestamp:Date.now(),dialogueSegment:n.substring(0,100),emotionalTone:s.emotionalTone}].slice(-20)})}}catch(s){}}analyzeRelationshipChange(e,t){const n=e.toLowerCase();let i=0,s=0,a="neutral";return/help|assist|thank|please|kind|good/i.test(n)&&(i+=5,s+=3,a="positive"),/attack|threaten|rude|steal|lie/i.test(n)&&(i-=8,s-=10,a="negative"),/ask|question|tell|information/i.test(n)&&(i+=1,s+=1,a="engaged"),{intensityDelta:i,trustDelta:s,emotionalTone:a}}},gi=new class{constructor(){t(this,"contextCache",new Map),t(this,"responseCache",new Map),t(this,"performanceMetrics",[]),t(this,"CACHE_DURATION",18e5),t(this,"CONTEXT_CACHE_DURATION",36e5)}async getCachedResponse(e){const t=this.responseCache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_DURATION?t.response:null}setCachedResponse(e,t){this.responseCache.set(e,{response:t,timestamp:Date.now()}),this.cleanCache()}async getCachedContext(e){const t=this.contextCache.get(e);return t&&Date.now()-t.timestamp<this.CONTEXT_CACHE_DURATION?t.context:null}setCachedContext(e,t){this.contextCache.set(e,{context:t,timestamp:Date.now()})}cleanCache(){const e=Date.now();for(const[t,n]of this.responseCache.entries())e-n.timestamp>this.CACHE_DURATION&&this.responseCache.delete(t);for(const[t,n]of this.contextCache.entries())e-n.timestamp>this.CONTEXT_CACHE_DURATION&&this.contextCache.delete(t)}recordPerformanceMetrics(e){this.performanceMetrics.push(e),this.performanceMetrics.length>100&&(this.performanceMetrics=this.performanceMetrics.slice(-100)),e.responseTime}getPerformanceAnalytics(){if(0===this.performanceMetrics.length)return{averageResponseTime:0,averageConfidence:0,cacheHitRate:0,slowResponseRate:0};const e=this.performanceMetrics.length,t=this.performanceMetrics.reduce((e,t)=>e+t.responseTime,0)/e,n=this.performanceMetrics.reduce((e,t)=>e+t.confidenceScore,0)/e,i=this.performanceMetrics.reduce((e,t)=>e+t.cacheHitRate,0)/e,s=this.performanceMetrics.filter(e=>e.responseTime>2e3).length;return{averageResponseTime:Math.round(t),averageConfidence:Math.round(100*n)/100,cacheHitRate:Math.round(100*i)/100,slowResponseRate:Math.round(s/e*100)/100}}async generateFirestoreContextAwareResponse(e,t,n,i){try{const s=await fi.getContextForNPCInteraction(e,t,n,i),a=await this.generateWithModelOrchestration(this.buildRichContextFromFirestore(s),{content:n,playerId:e,gameContext:{realm:s.gameContext.weatherConditions,location:s.playerContext.lastKnownLocation,session:s.gameContext,worldState:s.gameContext},playerContext:{name:s.playerContext.playerId,characterClass:s.playerContext.playerArchetype,experience:"intermediate",preferences:s.playerContext.preferences}});return await fi.recordAIInteraction(e,t,n,a.content,s),await pi.storeInteraction(e,n,a.content,{location:s.playerContext.lastKnownLocation,emotions:[s.npcContext.emotionalState],themes:s.npcContext.personalityTraits,realm:s.gameContext.weatherConditions},{emotionalTone:s.npcContext.emotionalState,themes:s.npcContext.personalityTraits,significance:7}),{response:a.content,worldStateUpdates:a.worldChanges||{},characterDevelopment:a.characterGrowth||{},proactiveInsights:[`Firestore context includes ${s.relevantLore.length} lore entries`],memoryReferences:s.semanticMemories.map(e=>e.content.substring(0,50)),confidenceScore:a.confidence||.85,emotionalTone:s.npcContext.emotionalState,narrativeSignificance:8}}catch(s){return this.generateContextAwareResponse({content:n,playerId:e,gameContext:{realm:"fantasy",location:"unknown",session:{id:i},worldState:{}},playerContext:{name:e,characterClass:"adventurer",experience:"intermediate",preferences:[]}})}}async generateContextAwareResponse(e){const t=Date.now();try{const n=this.generateCacheKey(e.content,e.playerId,e.gameContext.realm),i=this.generateContextCacheKey(e.playerId,e.gameContext.realm),s=await this.getCachedResponse(n);if(s){const e=Date.now()-t;return this.recordPerformanceMetrics({responseTime:e,confidenceScore:s.confidenceScore||.9,contextTokens:0,memoryRetrievalTime:0,cacheHitRate:1}),s}const a=await this.analyzeInputContext(e),r=Date.now(),o=await pi.retrieveRelevantMemories(e.content,{limit:10,threshold:.7,contextFilters:{characters:[e.playerId],realm:e.gameContext.realm,locations:[e.gameContext.location]}}),l=Date.now()-r;let c=await this.getCachedContext(i);c||(c=await this.buildRichContext({input:e,memories:o,contextAnalysis:a,gameState:e.gameContext,playerProfile:e.playerContext}),this.setCachedContext(i,c));const h=await this.generateWithModelOrchestration(c,e);await this.storeInteractionMemories(e,{response:h.content,worldStateUpdates:h.worldChanges||{},characterDevelopment:h.characterGrowth||{},proactiveInsights:[],memoryReferences:[],confidenceScore:h.confidence||.8,emotionalTone:a.emotionalTone||"neutral",narrativeSignificance:a.significance||5},a);const u=await this.generateProactiveInsights(c),d={response:h.content,worldStateUpdates:h.worldChanges||{},characterDevelopment:h.characterGrowth||{},proactiveInsights:u,memoryReferences:o.map(e=>e.content),confidenceScore:h.confidence||.8,emotionalTone:a.emotionalTone||"neutral",narrativeSignificance:a.significance||5};this.setCachedResponse(n,d);const p=Date.now()-t;return this.recordPerformanceMetrics({responseTime:p,confidenceScore:d.confidenceScore,contextTokens:JSON.stringify(c).length,memoryRetrievalTime:l,cacheHitRate:0}),d}catch(n){const e=Date.now()-t;throw this.recordPerformanceMetrics({responseTime:e,confidenceScore:0,contextTokens:0,memoryRetrievalTime:0,cacheHitRate:0}),n}}async analyzeInputContext(e){const t=`${e.playerId}_${this.hashString(e.content)}`;if(this.contextAnalysisCache.has(t))return this.contextAnalysisCache.get(t);const n=e.content.toLowerCase();let i="neutral";/happy|joy|excited|pleased|love|amazing/i.test(n)?i="positive":/angry|mad|frustrated|hate|terrible|awful/i.test(n)?i="negative":/scared|afraid|worried|nervous|anxious/i.test(n)?i="fearful":/curious|interested|wonder|explore|investigate/i.test(n)&&(i="curious");const s=[];/combat|fight|battle|attack|war/i.test(n)&&s.push("combat"),/talk|speak|conversation|negotiate|diplomacy/i.test(n)&&s.push("social"),/explore|search|find|discover|investigate/i.test(n)&&s.push("exploration"),/magic|spell|enchant|mystical|arcane/i.test(n)&&s.push("magic"),/trade|buy|sell|merchant|gold/i.test(n)&&s.push("commerce"),/quest|mission|task|goal|objective/i.test(n)&&s.push("quest"),/secret|hidden|mystery|riddle|puzzle/i.test(n)&&s.push("mystery");let a=5;/important|urgent|critical|emergency/i.test(n)&&(a+=3),/kill|death|destroy|war|battle/i.test(n)&&(a+=2),/love|marry|relationship|friend/i.test(n)&&(a+=2),/quest|mission|goal/i.test(n)&&(a+=1),/hello|hi|thanks|please/i.test(n)&&(a-=2),a=Math.max(1,Math.min(10,a));const r=this.inferAdvancedPlayerArchetype(n,e.playerContext);let o=5;/now|immediately|urgent|quickly|fast/i.test(n)&&(o+=3),/later|eventually|sometime|maybe/i.test(n)&&(o-=2),o=Math.max(1,Math.min(10,o));const l={emotionalTone:i,themes:s,significance:a,playerArchetype:r,urgency:o,complexity:Math.min(10,Math.max(1,n.split(" ").length/5+s.length+(n.includes("?")?2:0)+(n.split(",").length-1)))};return this.contextAnalysisCache.set(t,l),l}async buildRichContext(e){var t,n,i,s,a,r,o,l,c,h;const{input:u,memories:d,contextAnalysis:p,gameState:m,playerProfile:f}=e;return{immediate:{lastPlayerAction:u.content,aiResponse:"",currentEmotionalTone:p.emotionalTone,activeNPCs:(null==(t=m.session)?void 0:t.npcs)||[]},session:{objectives:(null==(i=null==(n=m.session)?void 0:n.activeQuests)?void 0:i.map(e=>e.title))||[],narrativeArcs:[],worldEvents:(null==(s=m.session)?void 0:s.worldEvents)||[],playerChoices:[],config:(null==(a=m.session)?void 0:a.config)||{}},character:{playerArchetype:p.playerArchetype,relationshipDynamics:[],emotionalJourney:[],characterGrowth:[]},world:{currentLocation:{name:m.location,description:(null==(r=m.worldState)?void 0:r.currentLocation)||"Unknown location"},weatherAndTime:{weather:(null==(o=m.worldState)?void 0:o.weather)||"clear",timeOfDay:(null==(l=m.worldState)?void 0:l.timeOfDay)||"day"},activeQuests:(null==(c=m.session)?void 0:c.activeQuests)||[],npcs:(null==(h=m.session)?void 0:h.npcs)||[],worldState:m.worldState||{}},semantic:{relevantMemories:d,thematicConnections:[...new Set(d.flatMap(e=>e.context.themes))],emotionalResonance:[...new Set(d.flatMap(e=>e.context.emotions))],narrativeParallels:d.filter(e=>e.connections.length>0).map(e=>e.content.substring(0,50))}}}async generateWithModelOrchestration(e,t){const n=this.buildEnhancedPrompt(e,t);try{return{content:(await mi.processSentientInput(t.playerId,t.content,{location:t.gameContext.location,situation:"enhanced_context",sessionType:"advanced_ai",realm:t.gameContext.realm,richContext:e})).response,confidence:.9,worldChanges:{},characterGrowth:{}}}catch(i){try{return{content:await di.generateEnhancedDynamicResponse(n),confidence:.7}}catch(s){throw s}}}buildEnhancedPrompt(e,t){const n=e.semantic.relevantMemories.length>0?`\nRELEVANT MEMORIES:\n${e.semantic.relevantMemories.map(e=>`- ${e.content.substring(0,100)}...`).join("\n")}\n`:"",i=e.semantic.thematicConnections.length>0?`\nTHEMATIC CONNECTIONS: ${e.semantic.thematicConnections.join(", ")}\n`:"";return`You are an advanced AI Dungeon Master with perfect memory and emotional intelligence. Generate a contextually rich, emotionally resonant response.\n\nGAME CONTEXT:\n- Realm: ${t.gameContext.realm}\n- Location: ${e.world.currentLocation.name}\n- Weather: ${e.world.weatherAndTime.weather}\n- Time: ${e.world.weatherAndTime.timeOfDay}\n\nPLAYER CONTEXT:\n- Name: ${t.playerContext.name}\n- Class: ${t.playerContext.characterClass}\n- Archetype: ${e.character.playerArchetype}\n- Emotional State: ${e.immediate.currentEmotionalTone}\n\nWORLD STATE:\n- Active NPCs: ${e.world.npcs.length}\n- Active Quests: ${e.world.activeQuests.length}\n- World Events: ${e.world.worldState}\n\n${n}${i}\n\nPLAYER INPUT: "${t.content}"\n\nRESPONSE REQUIREMENTS:\n- Reference relevant memories naturally\n- Show emotional intelligence and context awareness\n- Advance the narrative meaningfully\n- Create opportunities for player engagement\n- Maintain consistent world and character development\n\nGenerate an immersive, contextually perfect response:`}async storeInteractionMemories(e,t,n){var i,s;try{await pi.storeInteraction(e.playerId,e.content,t.response,{location:e.gameContext.location,emotions:[n.emotionalTone],themes:n.themes,realm:e.gameContext.realm,sessionId:null==(i=e.gameContext.session)?void 0:i.id,campaignId:null==(s=e.gameContext.session)?void 0:s.campaignId},{emotionalTone:n.emotionalTone,themes:n.themes,significance:n.significance,relationshipChanges:{}})}catch(a){}}async generateProactiveInsights(e){const t=[];if(e.semantic.relevantMemories.length>5){const n=e.semantic.relevantMemories.filter(e=>"player_action"===e.type).map(e=>e.metadata.playerArchetype).filter(Boolean),i=this.getMostCommon(n);i&&t.push(`Player shows ${i} tendencies - consider introducing relevant challenges`)}return e.semantic.relevantMemories.filter(e=>Math.abs(e.emotionalWeight)>2).length>3&&t.push("Player has strong emotional connections to this storyline - amplify emotional resonance"),e.semantic.thematicConnections.length>3&&t.push(`Rich thematic connections available: ${e.semantic.thematicConnections.slice(0,3).join(", ")}`),t}async generateFallbackResponse(e){try{const t=`Player ${e.playerContext.name} said: "${e.content}" in ${e.gameContext.realm}. Respond as a helpful DM.`;return{response:await di.generateEnhancedDynamicResponse(t),worldStateUpdates:{},characterDevelopment:{},proactiveInsights:["Fallback response generated"],memoryReferences:[],confidenceScore:.5,emotionalTone:"neutral",narrativeSignificance:3}}catch(t){return{response:"I'm experiencing some technical difficulties, but I'm here to help! Could you try rephrasing your request?",worldStateUpdates:{},characterDevelopment:{},proactiveInsights:[],memoryReferences:[],confidenceScore:.1,emotionalTone:"apologetic",narrativeSignificance:1}}}buildRichContextFromFirestore(e){return{immediate:{lastPlayerAction:"recent interaction",aiResponse:"",currentEmotionalTone:e.npcContext.emotionalState,activeNPCs:[e.npcContext]},session:{objectives:e.gameContext.activeQuests.map(e=>e.id),narrativeArcs:[],worldEvents:e.gameContext.globalEvents,playerChoices:[],config:{}},character:{playerArchetype:e.playerContext.playerArchetype,relationshipDynamics:[],emotionalJourney:[],characterGrowth:[]},world:{currentLocation:{name:e.playerContext.lastKnownLocation,description:"Current game location"},weatherAndTime:{weather:e.gameContext.weatherConditions,timeOfDay:e.gameContext.timeOfDay},activeQuests:e.gameContext.activeQuests,npcs:[e.npcContext],worldState:e.gameContext},semantic:{relevantMemories:e.semanticMemories,thematicConnections:e.npcContext.personalityTraits,emotionalResonance:[e.npcContext.emotionalState],narrativeParallels:e.relevantLore.map(e=>e.topic)}}}inferAdvancedPlayerArchetype(e,t){var n;const i=e.toLowerCase();if(/attack|fight|battle|charge|strike/i.test(i))return"warrior";if(/sneak|stealth|assassinate|backstab/i.test(i))return"assassin";if(/defend|protect|guard|shield/i.test(i))return"guardian";if(/negotiate|convince|persuade|charm/i.test(i))return"diplomat";if(/intimidate|threaten|demand/i.test(i))return"intimidator";if(/help|aid|support|heal/i.test(i))return"supporter";if(/explore|search|investigate|examine/i.test(i))return"explorer";if(/trap|lockpick|disable|sneak/i.test(i))return"scout";if(/solve|puzzle|riddle|analyze/i.test(i))return"analyst";if(/cast|spell|magic|enchant/i.test(i))return"spellcaster";if(/ritual|summon|invoke|channel/i.test(i))return"ritualist";const s=null==(n=t.characterClass)?void 0:n.toLowerCase();return(null==s?void 0:s.includes("warrior"))||(null==s?void 0:s.includes("fighter"))?"warrior":(null==s?void 0:s.includes("rogue"))||(null==s?void 0:s.includes("thief"))?"scout":(null==s?void 0:s.includes("mage"))||(null==s?void 0:s.includes("wizard"))?"spellcaster":(null==s?void 0:s.includes("cleric"))||(null==s?void 0:s.includes("priest"))?"supporter":"balanced"}getMostCommon(e){if(0===e.length)return null;const t=e.reduce((e,t)=>(e[String(t)]=(e[String(t)]||0)+1,e),{}),n=Math.max(...Object.values(t));return Object.keys(t).find(e=>t[e]===n)||null}hashString(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return t.toString()}generateCacheKey(e,t,n){return`resp_${this.simpleHash(e)}_${t}_${n}`}generateContextCacheKey(e,t){return`ctx_${e}_${t}`}simpleHash(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return Math.abs(t).toString(36)}async getUniversalPlayerProfile(e){try{const[t,n,i]=await Promise.all([this.getFirestorePlayerProfile(e),pi.getPlayerMemories(e),this.getSentientPlayerData(e)]),s={playerId:e,preferences:(null==t?void 0:t.preferences)||[],archetype:this.determinePlayerArchetype(n,i),emotionalProfile:this.buildEmotionalProfile(n),relationship_history:(null==t?void 0:t.relationships)||{},gameplay_patterns:this.analyzeGameplayPatterns(n),cross_campaign_data:{total_sessions:n.length,favorite_themes:this.extractFavoriteThemes(n),preferred_difficulty:this.calculatePreferredDifficulty(n),social_tendencies:this.analyzeSocialTendencies(n)},last_updated:Date.now()};return this.setCachedContext(`universal_profile_${e}`,s),s}catch(t){return{playerId:e,archetype:"balanced",preferences:[]}}}async shareAIContextBetweenModes(e,t,n,i){try{await pi.storeMemory(`Context transition from ${e} to ${t}: ${JSON.stringify(i)}`,{type:"context_transition",importance:7,timestamp:Date.now(),context:{characters:[n],realm:i.realm||"universal",emotions:[i.emotionalTone||"neutral"],themes:[`${e}_to_${t}_transition`],sourceMode:e,targetMode:t}}),i.npcInteractions&&await fi.updatePlayerProfile(n,{lastTransition:{from:e,to:t,timestamp:Date.now(),contextData:i}}),i.relationships&&await mi.updateCrossContextRelationships(n,i.relationships)}catch(s){}}async getAIRecommendationsForComponent(e,t,n){try{const i=await this.getUniversalPlayerProfile(t);return{recommended_npcs:this.recommendNPCsForComponent(e,i),suggested_storylines:this.recommendStorylinesForComponent(e,i),optimal_difficulty:this.calculateOptimalDifficulty(i,n),recommended_themes:this.recommendThemesForComponent(e,i),ai_insights:this.generateComponentAIInsights(e,i,n)}}catch(i){return{recommended_npcs:[],suggested_storylines:[],optimal_difficulty:5,recommended_themes:[],ai_insights:[]}}}async getFirestorePlayerProfile(e){try{return await fi.getPlayerProfile(e)}catch(t){return null}}async getSentientPlayerData(e){try{return mi.getPlayerPersonality(e)}catch(t){return null}}determinePlayerArchetype(e,t){if(null==t?void 0:t.archetype)return t.archetype;const n=e.filter(e=>e.content.includes("combat")||e.content.includes("fight")).length,i=e.filter(e=>e.content.includes("talk")||e.content.includes("convince")).length,s=e.filter(e=>e.content.includes("explore")||e.content.includes("search")).length;return n>i&&n>s?"warrior":i>n&&i>s?"diplomat":s>n&&s>i?"explorer":"balanced"}buildEmotionalProfile(e){const t={joy:0,anger:0,fear:0,sadness:0,surprise:0,trust:0};return e.forEach(e=>{var n;(null==(n=e.context)?void 0:n.emotions)&&e.context.emotions.forEach(e=>{t.hasOwnProperty(e)&&t[e]++})}),t}analyzeGameplayPatterns(e){return{session_length_preference:"medium",interaction_frequency:e.length>50?"high":e.length>20?"medium":"low",complexity_preference:"adaptive",social_vs_solo:"balanced"}}extractFavoriteThemes(e){const t=new Map;return e.forEach(e=>{var n;(null==(n=e.context)?void 0:n.themes)&&e.context.themes.forEach(e=>{t.set(e,(t.get(e)||0)+1)})}),Array.from(t.entries()).sort((e,t)=>t[1]-e[1]).slice(0,3).map(([e])=>e)}calculatePreferredDifficulty(e){const t=e.filter(e=>e.content.includes("success")||e.content.includes("achieve")).length,n=e.length,i=n>0?t/n:.5;return i>.8?7:i<.4?3:5}analyzeSocialTendencies(e){const t=e.filter(e=>"character_interaction"===e.type||e.content.includes("talk")||e.content.includes("npc")).length,n=e.length,i=n>0?t/n:.5;return i>.6?"highly_social":i<.3?"prefers_solo":"balanced_social"}recommendNPCsForComponent(e,t){const{archetype:n,emotionalProfile:i,relationship_history:s}=t;let a={"automated-games":["Ghost","Sage","Warrior","Merchant"],campaigns:["Innkeeper","Village Elder","Quest Giver","Rival"],combat:["Combat Instructor","Healer","Strategist"],exploration:["Guide","Scholar","Scout","Cartographer"]}[e]||[];return"scholar"===n&&(a=["Sage","Scholar","Librarian",...a]),"warrior"===n&&(a=["Combat Instructor","Warrior","Blacksmith",...a]),"diplomat"===n&&(a=["Ambassador","Merchant","Noble",...a]),[...new Set(a)].slice(0,4)}recommendStorylinesForComponent(e,t){const{archetype:n,cross_campaign_data:i}=t,s=(null==i?void 0:i.favorite_themes)||[],a=[];return"explorer"===n&&a.push("Ancient ruins discovery","Uncharted territory mapping"),"diplomat"===n&&a.push("Political intrigue","Peace negotiations"),"warrior"===n&&a.push("Epic battles","Tournament competition"),s.forEach(e=>{e.includes("mystery")&&a.push("Mystery investigation"),e.includes("magic")&&a.push("Magical artifact quest"),e.includes("horror")&&a.push("Supernatural encounters")}),[...new Set(a)].slice(0,3)}calculateOptimalDifficulty(e,t){var n;const i=(null==(n=e.cross_campaign_data)?void 0:n.preferred_difficulty)||5;return(null==t?void 0:t.recentFailures)>2?Math.max(1,i-1):(null==t?void 0:t.recentSuccesses)>3?Math.min(10,i+1):i}recommendThemesForComponent(e,t){var n;const i=(null==(n=t.cross_campaign_data)?void 0:n.favorite_themes)||[],s=t.archetype,a=[...i];return"scholar"===s&&a.push("ancient_lore","magical_research"),"warrior"===s&&a.push("epic_battles","heroic_deeds"),"diplomat"===s&&a.push("political_intrigue","social_dynamics"),"explorer"===s&&a.push("discovery","adventure"),[...new Set(a)].slice(0,4)}generateComponentAIInsights(e,t,n){var i,s,a;const r=[];return"highly_social"===(null==(i=t.cross_campaign_data)?void 0:i.social_tendencies)&&r.push("Player enjoys character interactions - emphasize NPC dialogue"),"explorer"===t.archetype&&r.push("Player loves discovery - include hidden secrets and exploration rewards"),"combat"===e&&(null==(s=t.cross_campaign_data)?void 0:s.preferred_difficulty)>7&&r.push("Player prefers challenging combat - use advanced tactics"),"campaigns"===e&&(null==(a=t.emotionalProfile)?void 0:a.trust)>5&&r.push("Player forms strong NPC relationships - develop long-term character arcs"),(null==n?void 0:n.timeSinceLastPlay)>6048e5&&r.push("Player returning after break - provide gentle reintroduction to story"),r.slice(0,3)}};class vi{constructor(e={}){t(this,"config"),this.config={memoryRetentionDays:30,emotionalDecayRate:.1,maxMemories:50,personalityStability:.8,...e}}createNPC(e){const t={joy:0,anger:0,fear:0,trust:0,respect:0,currentMood:"neutral",moodIntensity:5,lastMoodChange:new Date,stressLevel:3,confidence:5},n={openness:Math.floor(10*Math.random())+1,conscientiousness:Math.floor(10*Math.random())+1,extraversion:Math.floor(10*Math.random())+1,agreeableness:Math.floor(10*Math.random())+1,neuroticism:Math.floor(10*Math.random())+1};return{id:e.id||Date.now().toString(),name:e.name||"Unknown NPC",title:e.title,avatar:e.avatar,type:e.type||"neutral",personality:e.personality||"A mysterious individual",relationship:e.relationship||0,dialogue:e.dialogue||[],inventory:e.inventory||[],quests:e.quests||[],location:e.location,schedule:e.schedule,emotionalState:e.emotionalState||t,memories:e.memories||[],personalityTraits:e.personalityTraits||n,background:e.background||{origin:"Unknown",occupation:"Unknown",goals:[],fears:[],secrets:[]},interactionHistory:e.interactionHistory||[]}}updateEmotionalState(e,t){const n={...e.emotionalState};return Object.entries(t).forEach(([e,t])=>{if(["joy","anger","fear","trust","respect"].includes(e)){const i=e,s="number"==typeof n[i]?n[i]:Number(n[i])||0,a="number"==typeof t?t:Number(t)||0;n[i]=Math.max(-100,Math.min(100,s+a))}}),n.currentMood=this.calculateMood(n),n.lastMoodChange=new Date,n.moodIntensity=this.calculateMoodIntensity(n),n.stressLevel=this.calculateStressLevel(n),n.confidence=this.calculateConfidence(n),{...e,emotionalState:n}}addMemory(e,t){const n={...t,id:Date.now().toString(),timestamp:new Date},i=[...e.memories,n];return i.length>this.config.maxMemories&&i.splice(0,i.length-this.config.maxMemories),{...e,memories:i}}processEmotionalDecay(e,t=1){const n=Math.pow(1-this.config.emotionalDecayRate,t),i={...e.emotionalState};return["joy","anger","fear","trust","respect"].forEach(e=>{if("number"==typeof i[e]){const t=i[e]*n;i[e]=t}}),i.currentMood=this.calculateMood(i),i.moodIntensity=this.calculateMoodIntensity(i),{...e,emotionalState:i}}cleanOldMemories(e){const t=new Date;t.setDate(t.getDate()-this.config.memoryRetentionDays);const n=e.memories.filter(e=>e.timestamp>t);return{...e,memories:n}}getDisposition(e){const{emotionalState:t,relationship:n}=e,{trust:i,respect:s,fear:a,joy:r}=t;return n>70&&i>50&&r>30?"loving":n>30&&i>20?"friendly":a>50||n<-30?"hostile":a>30?"fearful":"neutral"}getEmotionalSummary(e){const{emotionalState:t}=e,{joy:n,anger:i,fear:s,trust:a,respect:r}=t,o=[];return n>30&&o.push("joyful"),i>30&&o.push("angry"),s>30&&o.push("fearful"),a>30&&o.push("trusting"),r>30&&o.push("respectful"),0===o.length?"neutral":o.join(", ")}getRelevantMemories(e,t,n=5){return e.memories.filter(e=>e.description.toLowerCase().includes(t.toLowerCase())||e.context.toLowerCase().includes(t.toLowerCase())).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime()).slice(0,n)}getPersonalityInfluence(e,t){const{personalityTraits:n}=e;let i=0;switch(t){case"social":i=(n.extraversion+n.agreeableness)/2;break;case"conflict":i=n.neuroticism-n.agreeableness;break;case"exploration":i=n.openness;break;case"responsibility":i=n.conscientiousness;break;default:i=5}return Math.max(0,Math.min(10,i))}calculateMood(e){const{joy:t,anger:n,fear:i,trust:s,respect:a}=e;return t>50&&s>30?"friendly":t>70?"excited":n>50?"hostile":i>50?"anxious":a>50&&s>20?"confident":s<-30?"suspicious":t<-30?"sad":"neutral"}calculateMoodIntensity(e){const{joy:t,anger:n,fear:i,trust:s,respect:a}=e,r=Math.max(Math.abs(t),Math.abs(n),Math.abs(i),Math.abs(s),Math.abs(a));return Math.min(10,Math.floor(r/10))}calculateStressLevel(e){const{anger:t,fear:n}=e,i=[Math.abs(t),Math.abs(n)],s=i.reduce((e,t)=>e+t,0)/i.length;return Math.min(10,Math.floor(s/10))}calculateConfidence(e){const{respect:t,trust:n,joy:i}=e,s=[t,n,i],a=s.reduce((e,t)=>e+t,0)/s.length;return Math.min(10,Math.max(0,Math.floor((a+100)/20)))}generateResponse(e,t){const n=this.getDisposition(e),i=this.getEmotionalSummary(e);this.getPersonalityInfluence(e,"social");const s={loving:["I'm so glad to see you! You've always been kind to me.","You're like family to me. How can I help you today?","My heart warms when I see you approach."],friendly:["Hello there! It's good to see you again.","Welcome! How can I assist you today?","Greetings, friend. What brings you here?"],neutral:["Hello. What do you need?","I see you've returned. What is it?","Yes? How can I help you?"],fearful:["Oh! You startled me... What do you want?","Please, don't hurt me. I'll help if I can.","I... I'm not sure what you want from me."],hostile:["What do you want? I don't have time for this.","You again. What trouble are you causing now?","Leave me alone. I have nothing to say to you."]},a=s[n]||s.neutral,r=a[Math.floor(Math.random()*a.length)];return"neutral"!==i?`${r} (${e.name} seems ${i})`:r}saveNPCState(e){try{const t=JSON.stringify(e);localStorage.setItem(`npc_${e.id}`,t)}catch(t){}}loadNPCState(e){try{const t=localStorage.getItem(`npc_${e}`);if(t){const e=JSON.parse(t);return e.emotionalState.lastMoodChange=new Date(e.emotionalState.lastMoodChange),e.memories=e.memories.map(e=>({...e,timestamp:new Date(e.timestamp)})),e.interactionHistory=e.interactionHistory.map(e=>({...e,timestamp:new Date(e.timestamp)})),e}}catch(t){}return null}}const xi=new vi,yi=class e{constructor(){t(this,"sentimentKeywords",{}),t(this,"intentPatterns",{}),t(this,"entityMatchers",{}),t(this,"npcService"),this.initializeNLPComponents(),this.npcService=new vi}static getInstance(){return e.instance||(e.instance=new e),e.instance}initializeNLPComponents(){this.sentimentKeywords={frustrated:["stuck","confused","annoyed","tired","bored","what","help","don't understand"],excited:["awesome","amazing","cool","yes!","let's go","epic","love this","fantastic"],confused:["what","how","why","huh","confused","lost","don't get it"],bored:["boring","meh","whatever","ok","sure","I guess"],engaged:["tell me more","what happens","I want to","let me","can I","interesting"]},this.intentPatterns={attack:[/I attack/i,/I fight/i,/I strike/i,/I hit/i,/combat/i,/charge/i],investigate:[/I look/i,/I search/i,/I examine/i,/I check/i,/I investigate/i,/perception/i],talk_to_npc:[/I talk to/i,/I speak with/i,/I ask/i,/I tell/i,/conversation/i,/say/i],ask_question:[/what is/i,/who is/i,/where is/i,/how do/i,/can I/i,/\?/],use_skill:[/I use/i,/skill check/i,/I try to/i,/attempt/i,/roll/i],cast_spell:[/I cast/i,/spell/i,/magic/i,/incantation/i],move:[/I go/i,/I move/i,/I walk/i,/I run/i,/direction/i,/north|south|east|west/i]},this.entityMatchers={characters:/\b[A-Z][a-z]+\s+[A-Z][a-z]+\b/g,items:/\b(sword|shield|potion|staff|bow|armor|helmet|ring|amulet|scroll)\b/gi,locations:/\b(forest|cave|castle|tavern|dungeon|mountain|river|bridge|door|room)\b/gi,actions:/\b(attack|defend|cast|drink|equip|move|search|talk|investigate|climb|jump)\b/gi,spells:/\b(fireball|heal|magic missile|shield|invisibility|teleport|charm)\b/gi,skills:/\b(perception|stealth|athletics|acrobatics|persuasion|deception|insight)\b/gi}}async processPlayerInput(e){var t;try{const i=this.analyzeSentiment(e.message),s=this.recognizeIntent(e.message),a=this.extractEntities(e.message),r=await this.getGameState(e.campaignId),o=await this.getPlayerProfile(e.playerId),l=await this.getDMPersona(e.campaignId),c=this.constructRichPrompt({originalInput:e.message,sentiment:i,intent:s,entities:a,gameState:r,playerProfile:o,dmPersona:l});let h,u=[];try{const n=await gi.generateContextAwareResponse({content:e.message,playerId:e.playerId,gameContext:{realm:"fantasy",location:(null==(t=null==r?void 0:r.current_location)?void 0:t.description)||"unknown",session:{id:e.campaignId},worldState:r||{}},playerContext:{name:e.playerId,characterClass:"Adventurer",experience:"intermediate",preferences:[]}});h=n.response,u=n.proactiveInsights}catch(n){h=await di.generateEnhancedDynamicResponse(c)}const d=await this.processAIResponse(h,{sentiment:i,intent:s,gameState:r,playerProfile:o,campaignId:e.campaignId,enhancedInsights:u});return await this.executeSystemActions(d.system_actions,e.campaignId),await this.updateGameState(e.campaignId,d.game_state_updates),await this.logInteraction(e,d),d}catch(n){return this.generateFallbackResponse(e.message)}}analyzeSentiment(e){const t=e.toLowerCase();let n="neutral",i=0;for(const[l,c]of Object.entries(this.sentimentKeywords)){const e=c.filter(e=>t.includes(e.toLowerCase())).length;e>i&&(i=e,n=l)}const s=(e.match(/!/g)||[]).length,a=(e.match(/\?/g)||[]).length,r=(e.match(/[A-Z]/g)||[]).length/e.length,o=i>0?.7+.1*i:.3;return{emotion:n,intensity:Math.min(1,.3*s+.2*a+.5*r+.4*i),confidence:Math.min(1,o)}}recognizeIntent(e){let t="other",n=0;for(const[i,s]of Object.entries(this.intentPatterns)){const a=s.filter(t=>t.test(e)).length,r=a>0?.8+.1*a:0;r>n&&(n=r,t=i)}return{intent:t,confidence:Math.min(1,n)}}extractEntities(e){const t={characters:[],items:[],locations:[],actions:[],spells:[],skills:[]};for(const[n,i]of Object.entries(this.entityMatchers)){const s=e.match(i)||[];t[n]=[...new Set(s.map(e=>e.toLowerCase()))]}return t}async getGameState(e){try{return this.getDefaultGameState()}catch(t){return this.getDefaultGameState()}}async getPlayerProfile(e){try{return this.getDefaultPlayerProfile()}catch(t){return this.getDefaultPlayerProfile()}}async getDMPersona(e){try{return this.getDefaultDMPersona()}catch(t){return this.getDefaultDMPersona()}}constructRichPrompt(e){const{originalInput:t,sentiment:n,intent:i,entities:s,gameState:a,playerProfile:r,dmPersona:o}=e;return`\n🎲 DYNAMIC DM SYSTEM 🎲\n\nPLAYER INPUT: "${t}"\n\nEMOTIONAL CONTEXT:\n- Sentiment: ${n.emotion} (intensity: ${n.intensity.toFixed(2)})\n- Player seems: ${"frustrated"===n.emotion?"They might need help or encouragement":"excited"===n.emotion?"They're engaged! Keep the energy up":"confused"===n.emotion?"Provide clear guidance":"Maintain current flow"}\n\nINTENT & ENTITIES:\n- Primary Intent: ${i.intent}\n- Detected: Characters[${s.characters.join(", ")}] Items[${s.items.join(", ")}] Locations[${s.locations.join(", ")}]\n\nCURRENT SITUATION:\n- Location: ${a.current_location.description}\n- Active NPCs: ${a.active_npcs.map(e=>`${e.name}(${e.status})`).join(", ")}\n- Current Scene: ${a.campaign_context.current_scene}\n- Tension Level: ${a.campaign_context.tension_level}/10\n\nPLAYER PERSONALITY:\n- Prefers: ${r.preferences.combat_preference} combat, ${r.preferences.roleplay_preference} roleplay\n- Humor Style: ${r.preferences.humor_style}\n- Backstory Elements: ${r.backstory_keywords.join(", ")}\n\nDM PERSONA SETTINGS:\n- Tone: ${o.tone}\n- Humor Level: ${o.humor_level}\n- Descriptiveness: ${o.descriptiveness}\n- Challenge: ${o.challenge_level}\n\nINSTRUCTIONS:\nGenerate a response that:\n1. ${"frustrated"===n.emotion?"Provides gentle guidance or lowers difficulty slightly":"excited"===n.emotion?"Maintains high energy and dramatic tension":"confused"===n.emotion?"Clarifies the situation clearly":"Continues the narrative flow"}\n\n2. Matches the ${o.tone} tone with ${o.humor_level} humor\n\n3. ${"attack"===i.intent?"Describes combat outcome, possibly rolling dice":"investigate"===i.intent?"Reveals information based on perception":"talk_to_npc"===i.intent?"Provides NPC dialogue and personality":"Responds appropriately to the detected intent"}\n\n4. Weaves in relevant backstory elements: ${r.backstory_keywords.slice(0,2).join(", ")}\n\n5. Uses vivid, ${o.descriptiveness} descriptions\n\nFormat your response as:\nNARRATIVE: [Main story response]\nNPC_DIALOGUE: [If applicable, NPC speech in quotes]\nSYSTEM_ACTION: [Any dice rolls, stat changes, or effects needed]\nMOOD: [How this affects scene tension: +1/0/-1]\n`}async processAIResponse(e,t){const n=this.extractSection(e,"NARRATIVE")||e,i=this.extractSection(e,"NPC_DIALOGUE"),s=this.extractSection(e,"SYSTEM_ACTION"),a=this.extractSection(e,"MOOD"),r=[],o={};if(s&&(s.includes("roll")&&r.push({type:"dice_roll",parameters:{dice:"1d20",reason:"action_resolution"}}),(s.includes("damage")||s.includes("heal"))&&r.push({type:"stat_update",parameters:{type:"health",change:this.extractNumber(s)}})),a){const e=this.extractNumber(a);0!==e&&(o.campaign_context={...t.gameState.campaign_context,tension_level:Math.max(0,Math.min(10,t.gameState.campaign_context.tension_level+e))})}return{narrative_text:n,npc_dialogue:i,system_actions:r,game_state_updates:o,mood_adjustment:a?{tension_delta:this.extractNumber(a),engagement_boost:"excited"===t.sentiment.emotion}:void 0}}async processNPCInteractions(e,t,n){const i=[];for(const a of e)try{let e=this.npcService.createNPC({name:a});const s=this.analyzeEmotionalImpact(t,n);e=this.npcService.updateEmotionalState(e,s),e=this.npcService.addMemory(e,{type:"conversation",description:`Player said:${t}"`,context:"player_interaction",emotionalImpact:s,relationshipChange:this.calculateMemoryImportance(t,s)}),i.push({id:e.id,name:e.name,hp:10,status:this.npcService.getDisposition(e),personality:e.personality,emotionalState:e.emotionalState})}catch(s){}return i}analyzeEmotionalImpact(e,t){const n={joy:0,anger:0,fear:0,trust:0,respect:0},i=this.analyzeSentiment(e),s=this.analyzeSentiment(t);"excited"===i.emotion&&"excited"===s.emotion?(n.joy+=10,n.trust+=5):"frustrated"===i.emotion&&"frustrated"===s.emotion?(n.anger+=10,n.fear+=5):"confused"===i.emotion&&(n.fear+=5,n.trust-=5);const a=["help","save","protect","friend","ally","respectful"];return["attack","kill","hurt","destroy","threaten"].some(t=>e.toLowerCase().includes(t))&&(n.fear+=15,n.trust-=10),a.some(t=>e.toLowerCase().includes(t))&&(n.trust+=10,n.joy+=5),a.some(t=>e.toLowerCase().includes(t))&&(n.respect+=10,n.trust+=5),n}calculateMemoryImportance(e,t){const n=Math.abs(t.joy)+Math.abs(t.anger)+Math.abs(t.fear)+Math.abs(t.trust)+Math.abs(t.respect);return Math.min(10,Math.max(1,Math.floor(n/10)))}extractSection(e,t){const n=new RegExp(`${t}:\\s*(.+?)(?=\\n[A-Z_]+:|$)`,"s"),i=e.match(n);return i?i[1].trim():void 0}extractNumber(e){const t=e.match(/[+-]?\d+/);return t?parseInt(t[0]):0}async executeSystemActions(e,t){for(const n of e)n.type}async updateGameState(e,t){Object.keys(t).length}async logInteraction(e,t){e.message,t.narrative_text,t.system_actions,t.mood_adjustment}generateFallbackResponse(e){return{narrative_text:"The mists of magic swirl around you as reality shifts. Something unexpected has occurred, but your adventure continues...",system_actions:[],game_state_updates:{}}}getDefaultGameState(){return{current_location:{id:"starting_area",description:"You find yourself in a mystical realm where adventure awaits.",encounters:[],npcs:[],items:[]},active_npcs:[],party_position:{x:0,y:0},active_quests:[],inventory:[],campaign_context:{theme:"Fantasy",current_scene:"Beginning of Adventure",tension_level:3,last_major_event:"Campaign started"}}}getDefaultPlayerProfile(){return{character_sheet:{name:"Adventurer",class:"Fighter",level:1,stats:{strength:12,dexterity:12,constitution:12,intelligence:12,wisdom:12,charisma:12},abilities:[]},preferences:{combat_preference:"medium",roleplay_preference:"medium",puzzle_preference:"medium",humor_style:"witty",narrative_style:"immersive"},backstory_keywords:[],out_of_character_notes:[],interaction_history:[]}}getDefaultDMPersona(){return{tone:"friendly",humor_level:"medium",descriptiveness:"moderate",challenge_level:"moderate",narrative_focus:"balanced",improvisation_style:"moderate"}}};t(yi,"instance");const bi=yi.getInstance();function _i(e,t,{checkForDefaultPrevented:n=!0}={}){return function(i){if(null==e||e(i),!1===n||!i.defaultPrevented)return null==t?void 0:t(i)}}function wi(e,t){if("function"==typeof e)return e(t);null!=e&&(e.current=t)}function Si(...e){return t=>{let n=!1;const i=e.map(e=>{const i=wi(e,t);return n||"function"!=typeof i||(n=!0),i});if(n)return()=>{for(let t=0;t<i.length;t++){const n=i[t];"function"==typeof n?n():wi(e[t],null)}}}}function Mi(...e){return n.useCallback(Si(...e),e)}function Ti(e,t=[]){let i=[];const s=()=>{const t=i.map(e=>n.createContext(e));return function(i){const s=(null==i?void 0:i[e])||t;return n.useMemo(()=>({[`__scope${e}`]:{...i,[e]:s}}),[i,s])}};return s.scopeName=e,[function(t,s){const a=n.createContext(s),r=i.length;i=[...i,s];const o=t=>{var i;const{scope:s,children:o,...l}=t,c=(null==(i=null==s?void 0:s[e])?void 0:i[r])||a,h=n.useMemo(()=>l,Object.values(l));return ft.jsx(c.Provider,{value:h,children:o})};return o.displayName=t+"Provider",[o,function(i,o){var l;const c=(null==(l=null==o?void 0:o[e])?void 0:l[r])||a,h=n.useContext(c);if(h)return h;if(void 0!==s)return s;throw new Error(`\`${i}\` must be used within \`${t}\``)}]},Ei(s,...t)]}function Ei(...e){const t=e[0];if(1===e.length)return t;const i=()=>{const i=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){const s=i.reduce((t,{useScope:n,scopeName:i})=>({...t,...n(e)[`__scope${i}`]}),{});return n.useMemo(()=>({[`__scope${t.scopeName}`]:s}),[s])}};return i.scopeName=t.scopeName,i}function Ci(e){const t=Ni(e),i=n.forwardRef((e,i)=>{const{children:s,...a}=e,r=n.Children.toArray(s),o=r.find(ji);if(o){const e=o.props.children,s=r.map(t=>t===o?n.Children.count(e)>1?n.Children.only(null):n.isValidElement(e)?e.props.children:null:t);return ft.jsx(t,{...a,ref:i,children:n.isValidElement(e)?n.cloneElement(e,void 0,s):null})}return ft.jsx(t,{...a,ref:i,children:s})});return i.displayName=`${e}.Slot`,i}function Ni(e){const t=n.forwardRef((e,t)=>{const{children:i,...s}=e;if(n.isValidElement(i)){const e=function(e){var t,n;let i=null==(t=Object.getOwnPropertyDescriptor(e.props,"ref"))?void 0:t.get,s=i&&"isReactWarning"in i&&i.isReactWarning;return s?e.ref:(i=null==(n=Object.getOwnPropertyDescriptor(e,"ref"))?void 0:n.get,s=i&&"isReactWarning"in i&&i.isReactWarning,s?e.props.ref:e.props.ref||e.ref)}(i),a=function(e,t){const n={...t};for(const i in t){const s=e[i],a=t[i];/^on[A-Z]/.test(i)?s&&a?n[i]=(...e)=>{const t=a(...e);return s(...e),t}:s&&(n[i]=s):"style"===i?n[i]={...s,...a}:"className"===i&&(n[i]=[s,a].filter(Boolean).join(" "))}return{...e,...n}}(s,i.props);return i.type!==n.Fragment&&(a.ref=t?Si(t,e):e),n.cloneElement(i,a)}return n.Children.count(i)>1?n.Children.only(null):null});return t.displayName=`${e}.SlotClone`,t}var Ai=Symbol("radix.slottable");function Ri(e){const t=({children:e})=>ft.jsx(ft.Fragment,{children:e});return t.displayName=`${e}.Slottable`,t.__radixId=Ai,t}function ji(e){return n.isValidElement(e)&&"function"==typeof e.type&&"__radixId"in e.type&&e.type.__radixId===Ai}var Pi=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((e,t)=>{const i=Ci(`Primitive.${t}`),s=n.forwardRef((e,n)=>{const{asChild:s,...a}=e,r=s?i:t;return"undefined"!=typeof window&&(window[Symbol.for("radix-ui")]=!0),ft.jsx(r,{...a,ref:n})});return s.displayName=`Primitive.${t}`,{...e,[t]:s}},{});function Ii(e){const t=n.useRef(e);return n.useEffect(()=>{t.current=e}),n.useMemo(()=>(...e)=>{var n;return null==(n=t.current)?void 0:n.call(t,...e)},[])}var Di,ki="dismissableLayer.update",Li=n.createContext({layers:new Set,layersWithOutsidePointerEventsDisabled:new Set,branches:new Set}),Oi=n.forwardRef((e,t)=>{const{disableOutsidePointerEvents:i=!1,onEscapeKeyDown:s,onPointerDownOutside:a,onFocusOutside:r,onInteractOutside:o,onDismiss:l,...c}=e,h=n.useContext(Li),[u,d]=n.useState(null),p=(null==u?void 0:u.ownerDocument)??(null==globalThis?void 0:globalThis.document),[,m]=n.useState({}),f=Mi(t,e=>d(e)),g=Array.from(h.layers),[v]=[...h.layersWithOutsidePointerEventsDisabled].slice(-1),x=g.indexOf(v),y=u?g.indexOf(u):-1,b=h.layersWithOutsidePointerEventsDisabled.size>0,_=y>=x,w=function(e,t=(null==globalThis?void 0:globalThis.document)){const i=Ii(e),s=n.useRef(!1),a=n.useRef(()=>{});return n.useEffect(()=>{const e=e=>{if(e.target&&!s.current){let n=function(){Fi("dismissableLayer.pointerDownOutside",i,s,{discrete:!0})};const s={originalEvent:e};"touch"===e.pointerType?(t.removeEventListener("click",a.current),a.current=n,t.addEventListener("click",a.current,{once:!0})):n()}else t.removeEventListener("click",a.current);s.current=!1},n=window.setTimeout(()=>{t.addEventListener("pointerdown",e)},0);return()=>{window.clearTimeout(n),t.removeEventListener("pointerdown",e),t.removeEventListener("click",a.current)}},[t,i]),{onPointerDownCapture:()=>s.current=!0}}(e=>{const t=e.target,n=[...h.branches].some(e=>e.contains(t));_&&!n&&(null==a||a(e),null==o||o(e),e.defaultPrevented||null==l||l())},p),S=function(e,t=(null==globalThis?void 0:globalThis.document)){const i=Ii(e),s=n.useRef(!1);return n.useEffect(()=>{const e=e=>{e.target&&!s.current&&Fi("dismissableLayer.focusOutside",i,{originalEvent:e},{discrete:!1})};return t.addEventListener("focusin",e),()=>t.removeEventListener("focusin",e)},[t,i]),{onFocusCapture:()=>s.current=!0,onBlurCapture:()=>s.current=!1}}(e=>{const t=e.target;[...h.branches].some(e=>e.contains(t))||(null==r||r(e),null==o||o(e),e.defaultPrevented||null==l||l())},p);return function(e,t=(null==globalThis?void 0:globalThis.document)){const i=Ii(e);n.useEffect(()=>{const e=e=>{"Escape"===e.key&&i(e)};return t.addEventListener("keydown",e,{capture:!0}),()=>t.removeEventListener("keydown",e,{capture:!0})},[i,t])}(e=>{y===h.layers.size-1&&(null==s||s(e),!e.defaultPrevented&&l&&(e.preventDefault(),l()))},p),n.useEffect(()=>{if(u)return i&&(0===h.layersWithOutsidePointerEventsDisabled.size&&(Di=p.body.style.pointerEvents,p.body.style.pointerEvents="none"),h.layersWithOutsidePointerEventsDisabled.add(u)),h.layers.add(u),Ui(),()=>{i&&1===h.layersWithOutsidePointerEventsDisabled.size&&(p.body.style.pointerEvents=Di)}},[u,p,i,h]),n.useEffect(()=>()=>{u&&(h.layers.delete(u),h.layersWithOutsidePointerEventsDisabled.delete(u),Ui())},[u,h]),n.useEffect(()=>{const e=()=>m({});return document.addEventListener(ki,e),()=>document.removeEventListener(ki,e)},[]),ft.jsx(Pi.div,{...c,ref:f,style:{pointerEvents:b?_?"auto":"none":void 0,...e.style},onFocusCapture:_i(e.onFocusCapture,S.onFocusCapture),onBlurCapture:_i(e.onBlurCapture,S.onBlurCapture),onPointerDownCapture:_i(e.onPointerDownCapture,w.onPointerDownCapture)})});function Ui(){const e=new CustomEvent(ki);document.dispatchEvent(e)}function Fi(e,t,n,{discrete:s}){const a=n.originalEvent.target,r=new CustomEvent(e,{bubbles:!1,cancelable:!0,detail:n});t&&a.addEventListener(e,t,{once:!0}),s?function(e,t){e&&i.flushSync(()=>e.dispatchEvent(t))}(a,r):a.dispatchEvent(r)}Oi.displayName="DismissableLayer",n.forwardRef((e,t)=>{const i=n.useContext(Li),s=n.useRef(null),a=Mi(t,s);return n.useEffect(()=>{const e=s.current;if(e)return i.branches.add(e),()=>{i.branches.delete(e)}},[i.branches]),ft.jsx(Pi.div,{...e,ref:a})}).displayName="DismissableLayerBranch";var zi=(null==globalThis?void 0:globalThis.document)?n.useLayoutEffect:()=>{},Bi=s[" useId ".trim().toString()]||(()=>{}),Vi=0;const Hi=["top","right","bottom","left"],Wi=Math.min,Gi=Math.max,qi=Math.round,$i=Math.floor,Xi=e=>({x:e,y:e}),Yi={left:"right",right:"left",bottom:"top",top:"bottom"},Ki={start:"end",end:"start"};function Zi(e,t,n){return Gi(e,Wi(t,n))}function Ji(e,t){return"function"==typeof e?e(t):e}function Qi(e){return e.split("-")[0]}function es(e){return e.split("-")[1]}function ts(e){return"x"===e?"y":"x"}function ns(e){return"y"===e?"height":"width"}const is=new Set(["top","bottom"]);function ss(e){return is.has(Qi(e))?"y":"x"}function as(e){return ts(ss(e))}function rs(e){return e.replace(/start|end/g,e=>Ki[e])}const os=["left","right"],ls=["right","left"],cs=["top","bottom"],hs=["bottom","top"];function us(e){return e.replace(/left|right|bottom|top/g,e=>Yi[e])}function ds(e){return"number"!=typeof e?function(e){return{top:0,right:0,bottom:0,left:0,...e}}(e):{top:e,right:e,bottom:e,left:e}}function ps(e){const{x:t,y:n,width:i,height:s}=e;return{width:i,height:s,top:n,left:t,right:t+i,bottom:n+s,x:t,y:n}}function ms(e,t,n){let{reference:i,floating:s}=e;const a=ss(t),r=as(t),o=ns(r),l=Qi(t),c="y"===a,h=i.x+i.width/2-s.width/2,u=i.y+i.height/2-s.height/2,d=i[o]/2-s[o]/2;let p;switch(l){case"top":p={x:h,y:i.y-s.height};break;case"bottom":p={x:h,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:u};break;case"left":p={x:i.x-s.width,y:u};break;default:p={x:i.x,y:i.y}}switch(es(t)){case"start":p[r]-=d*(n&&c?-1:1);break;case"end":p[r]+=d*(n&&c?-1:1)}return p}async function fs(e,t){var n;void 0===t&&(t={});const{x:i,y:s,platform:a,rects:r,elements:o,strategy:l}=e,{boundary:c="clippingAncestors",rootBoundary:h="viewport",elementContext:u="floating",altBoundary:d=!1,padding:p=0}=Ji(t,e),m=ds(p),f=o[d?"floating"===u?"reference":"floating":u],g=ps(await a.getClippingRect({element:null==(n=await(null==a.isElement?void 0:a.isElement(f)))||n?f:f.contextElement||await(null==a.getDocumentElement?void 0:a.getDocumentElement(o.floating)),boundary:c,rootBoundary:h,strategy:l})),v="floating"===u?{x:i,y:s,width:r.floating.width,height:r.floating.height}:r.reference,x=await(null==a.getOffsetParent?void 0:a.getOffsetParent(o.floating)),y=await(null==a.isElement?void 0:a.isElement(x))&&await(null==a.getScale?void 0:a.getScale(x))||{x:1,y:1},b=ps(a.convertOffsetParentRelativeRectToViewportRelativeRect?await a.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:v,offsetParent:x,strategy:l}):v);return{top:(g.top-b.top+m.top)/y.y,bottom:(b.bottom-g.bottom+m.bottom)/y.y,left:(g.left-b.left+m.left)/y.x,right:(b.right-g.right+m.right)/y.x}}function gs(e,t){return{top:e.top-t.height,right:e.right-t.width,bottom:e.bottom-t.height,left:e.left-t.width}}function vs(e){return Hi.some(t=>e[t]>=0)}const xs=new Set(["left","top"]);function ys(){return"undefined"!=typeof window}function bs(e){return Ss(e)?(e.nodeName||"").toLowerCase():"#document"}function _s(e){var t;return(null==e||null==(t=e.ownerDocument)?void 0:t.defaultView)||window}function ws(e){var t;return null==(t=(Ss(e)?e.ownerDocument:e.document)||window.document)?void 0:t.documentElement}function Ss(e){return!!ys()&&(e instanceof Node||e instanceof _s(e).Node)}function Ms(e){return!!ys()&&(e instanceof Element||e instanceof _s(e).Element)}function Ts(e){return!!ys()&&(e instanceof HTMLElement||e instanceof _s(e).HTMLElement)}function Es(e){return!(!ys()||"undefined"==typeof ShadowRoot)&&(e instanceof ShadowRoot||e instanceof _s(e).ShadowRoot)}const Cs=new Set(["inline","contents"]);function Ns(e){const{overflow:t,overflowX:n,overflowY:i,display:s}=zs(e);return/auto|scroll|overlay|hidden|clip/.test(t+i+n)&&!Cs.has(s)}const As=new Set(["table","td","th"]);function Rs(e){return As.has(bs(e))}const js=[":popover-open",":modal"];function Ps(e){return js.some(t=>{try{return e.matches(t)}catch(n){return!1}})}const Is=["transform","translate","scale","rotate","perspective"],Ds=["transform","translate","scale","rotate","perspective","filter"],ks=["paint","layout","strict","content"];function Ls(e){const t=Os(),n=Ms(e)?zs(e):e;return Is.some(e=>!!n[e]&&"none"!==n[e])||!!n.containerType&&"normal"!==n.containerType||!t&&!!n.backdropFilter&&"none"!==n.backdropFilter||!t&&!!n.filter&&"none"!==n.filter||Ds.some(e=>(n.willChange||"").includes(e))||ks.some(e=>(n.contain||"").includes(e))}function Os(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}const Us=new Set(["html","body","#document"]);function Fs(e){return Us.has(bs(e))}function zs(e){return _s(e).getComputedStyle(e)}function Bs(e){return Ms(e)?{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}:{scrollLeft:e.scrollX,scrollTop:e.scrollY}}function Vs(e){if("html"===bs(e))return e;const t=e.assignedSlot||e.parentNode||Es(e)&&e.host||ws(e);return Es(t)?t.host:t}function Hs(e){const t=Vs(e);return Fs(t)?e.ownerDocument?e.ownerDocument.body:e.body:Ts(t)&&Ns(t)?t:Hs(t)}function Ws(e,t,n){var i;void 0===t&&(t=[]),void 0===n&&(n=!0);const s=Hs(e),a=s===(null==(i=e.ownerDocument)?void 0:i.body),r=_s(s);if(a){const e=Gs(r);return t.concat(r,r.visualViewport||[],Ns(s)?s:[],e&&n?Ws(e):[])}return t.concat(s,Ws(s,[],n))}function Gs(e){return e.parent&&Object.getPrototypeOf(e.parent)?e.frameElement:null}function qs(e){const t=zs(e);let n=parseFloat(t.width)||0,i=parseFloat(t.height)||0;const s=Ts(e),a=s?e.offsetWidth:n,r=s?e.offsetHeight:i,o=qi(n)!==a||qi(i)!==r;return o&&(n=a,i=r),{width:n,height:i,$:o}}function $s(e){return Ms(e)?e:e.contextElement}function Xs(e){const t=$s(e);if(!Ts(t))return Xi(1);const n=t.getBoundingClientRect(),{width:i,height:s,$:a}=qs(t);let r=(a?qi(n.width):n.width)/i,o=(a?qi(n.height):n.height)/s;return r&&Number.isFinite(r)||(r=1),o&&Number.isFinite(o)||(o=1),{x:r,y:o}}const Ys=Xi(0);function Ks(e){const t=_s(e);return Os()&&t.visualViewport?{x:t.visualViewport.offsetLeft,y:t.visualViewport.offsetTop}:Ys}function Zs(e,t,n,i){void 0===t&&(t=!1),void 0===n&&(n=!1);const s=e.getBoundingClientRect(),a=$s(e);let r=Xi(1);t&&(i?Ms(i)&&(r=Xs(i)):r=Xs(e));const o=function(e,t,n){return void 0===t&&(t=!1),!(!n||t&&n!==_s(e))&&t}(a,n,i)?Ks(a):Xi(0);let l=(s.left+o.x)/r.x,c=(s.top+o.y)/r.y,h=s.width/r.x,u=s.height/r.y;if(a){const e=_s(a),t=i&&Ms(i)?_s(i):i;let n=e,s=Gs(n);for(;s&&i&&t!==n;){const e=Xs(s),t=s.getBoundingClientRect(),i=zs(s),a=t.left+(s.clientLeft+parseFloat(i.paddingLeft))*e.x,r=t.top+(s.clientTop+parseFloat(i.paddingTop))*e.y;l*=e.x,c*=e.y,h*=e.x,u*=e.y,l+=a,c+=r,n=_s(s),s=Gs(n)}}return ps({width:h,height:u,x:l,y:c})}function Js(e,t){const n=Bs(e).scrollLeft;return t?t.left+n:Zs(ws(e)).left+n}function Qs(e,t,n){void 0===n&&(n=!1);const i=e.getBoundingClientRect();return{x:i.left+t.scrollLeft-(n?0:Js(e,i)),y:i.top+t.scrollTop}}const ea=new Set(["absolute","fixed"]);function ta(e,t,n){let i;if("viewport"===t)i=function(e,t){const n=_s(e),i=ws(e),s=n.visualViewport;let a=i.clientWidth,r=i.clientHeight,o=0,l=0;if(s){a=s.width,r=s.height;const e=Os();(!e||e&&"fixed"===t)&&(o=s.offsetLeft,l=s.offsetTop)}return{width:a,height:r,x:o,y:l}}(e,n);else if("document"===t)i=function(e){const t=ws(e),n=Bs(e),i=e.ownerDocument.body,s=Gi(t.scrollWidth,t.clientWidth,i.scrollWidth,i.clientWidth),a=Gi(t.scrollHeight,t.clientHeight,i.scrollHeight,i.clientHeight);let r=-n.scrollLeft+Js(e);const o=-n.scrollTop;return"rtl"===zs(i).direction&&(r+=Gi(t.clientWidth,i.clientWidth)-s),{width:s,height:a,x:r,y:o}}(ws(e));else if(Ms(t))i=function(e,t){const n=Zs(e,!0,"fixed"===t),i=n.top+e.clientTop,s=n.left+e.clientLeft,a=Ts(e)?Xs(e):Xi(1);return{width:e.clientWidth*a.x,height:e.clientHeight*a.y,x:s*a.x,y:i*a.y}}(t,n);else{const n=Ks(e);i={x:t.x-n.x,y:t.y-n.y,width:t.width,height:t.height}}return ps(i)}function na(e,t){const n=Vs(e);return!(n===t||!Ms(n)||Fs(n))&&("fixed"===zs(n).position||na(n,t))}function ia(e,t,n){const i=Ts(t),s=ws(t),a="fixed"===n,r=Zs(e,!0,a,t);let o={scrollLeft:0,scrollTop:0};const l=Xi(0);function c(){l.x=Js(s)}if(i||!i&&!a)if(("body"!==bs(t)||Ns(s))&&(o=Bs(t)),i){const e=Zs(t,!0,a,t);l.x=e.x+t.clientLeft,l.y=e.y+t.clientTop}else s&&c();a&&!i&&s&&c();const h=!s||i||a?Xi(0):Qs(s,o);return{x:r.left+o.scrollLeft-l.x-h.x,y:r.top+o.scrollTop-l.y-h.y,width:r.width,height:r.height}}function sa(e){return"static"===zs(e).position}function aa(e,t){if(!Ts(e)||"fixed"===zs(e).position)return null;if(t)return t(e);let n=e.offsetParent;return ws(e)===n&&(n=n.ownerDocument.body),n}function ra(e,t){const n=_s(e);if(Ps(e))return n;if(!Ts(e)){let t=Vs(e);for(;t&&!Fs(t);){if(Ms(t)&&!sa(t))return t;t=Vs(t)}return n}let i=aa(e,t);for(;i&&Rs(i)&&sa(i);)i=aa(i,t);return i&&Fs(i)&&sa(i)&&!Ls(i)?n:i||function(e){let t=Vs(e);for(;Ts(t)&&!Fs(t);){if(Ls(t))return t;if(Ps(t))return null;t=Vs(t)}return null}(e)||n}const oa={convertOffsetParentRelativeRectToViewportRelativeRect:function(e){let{elements:t,rect:n,offsetParent:i,strategy:s}=e;const a="fixed"===s,r=ws(i),o=!!t&&Ps(t.floating);if(i===r||o&&a)return n;let l={scrollLeft:0,scrollTop:0},c=Xi(1);const h=Xi(0),u=Ts(i);if((u||!u&&!a)&&(("body"!==bs(i)||Ns(r))&&(l=Bs(i)),Ts(i))){const e=Zs(i);c=Xs(i),h.x=e.x+i.clientLeft,h.y=e.y+i.clientTop}const d=!r||u||a?Xi(0):Qs(r,l,!0);return{width:n.width*c.x,height:n.height*c.y,x:n.x*c.x-l.scrollLeft*c.x+h.x+d.x,y:n.y*c.y-l.scrollTop*c.y+h.y+d.y}},getDocumentElement:ws,getClippingRect:function(e){let{element:t,boundary:n,rootBoundary:i,strategy:s}=e;const a=[..."clippingAncestors"===n?Ps(t)?[]:function(e,t){const n=t.get(e);if(n)return n;let i=Ws(e,[],!1).filter(e=>Ms(e)&&"body"!==bs(e)),s=null;const a="fixed"===zs(e).position;let r=a?Vs(e):e;for(;Ms(r)&&!Fs(r);){const t=zs(r),n=Ls(r);n||"fixed"!==t.position||(s=null),(a?!n&&!s:!n&&"static"===t.position&&s&&ea.has(s.position)||Ns(r)&&!n&&na(e,r))?i=i.filter(e=>e!==r):s=t,r=Vs(r)}return t.set(e,i),i}(t,this._c):[].concat(n),i],r=a[0],o=a.reduce((e,n)=>{const i=ta(t,n,s);return e.top=Gi(i.top,e.top),e.right=Wi(i.right,e.right),e.bottom=Wi(i.bottom,e.bottom),e.left=Gi(i.left,e.left),e},ta(t,r,s));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}},getOffsetParent:ra,getElementRects:async function(e){const t=this.getOffsetParent||ra,n=this.getDimensions,i=await n(e.floating);return{reference:ia(e.reference,await t(e.floating),e.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}},getClientRects:function(e){return Array.from(e.getClientRects())},getDimensions:function(e){const{width:t,height:n}=qs(e);return{width:t,height:n}},getScale:Xs,isElement:Ms,isRTL:function(e){return"rtl"===zs(e).direction}};function la(e,t){return e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}const ca=function(e){return void 0===e&&(e=0),{name:"offset",options:e,async fn(t){var n,i;const{x:s,y:a,placement:r,middlewareData:o}=t,l=await async function(e,t){const{placement:n,platform:i,elements:s}=e,a=await(null==i.isRTL?void 0:i.isRTL(s.floating)),r=Qi(n),o=es(n),l="y"===ss(n),c=xs.has(r)?-1:1,h=a&&l?-1:1,u=Ji(t,e);let{mainAxis:d,crossAxis:p,alignmentAxis:m}="number"==typeof u?{mainAxis:u,crossAxis:0,alignmentAxis:null}:{mainAxis:u.mainAxis||0,crossAxis:u.crossAxis||0,alignmentAxis:u.alignmentAxis};return o&&"number"==typeof m&&(p="end"===o?-1*m:m),l?{x:p*h,y:d*c}:{x:d*c,y:p*h}}(t,e);return r===(null==(n=o.offset)?void 0:n.placement)&&null!=(i=o.arrow)&&i.alignmentOffset?{}:{x:s+l.x,y:a+l.y,data:{...l,placement:r}}}}},ha=function(e){return void 0===e&&(e={}),{name:"shift",options:e,async fn(t){const{x:n,y:i,placement:s}=t,{mainAxis:a=!0,crossAxis:r=!1,limiter:o={fn:e=>{let{x:t,y:n}=e;return{x:t,y:n}}},...l}=Ji(e,t),c={x:n,y:i},h=await fs(t,l),u=ss(Qi(s)),d=ts(u);let p=c[d],m=c[u];if(a){const e="y"===d?"bottom":"right";p=Zi(p+h["y"===d?"top":"left"],p,p-h[e])}if(r){const e="y"===u?"bottom":"right";m=Zi(m+h["y"===u?"top":"left"],m,m-h[e])}const f=o.fn({...t,[d]:p,[u]:m});return{...f,data:{x:f.x-n,y:f.y-i,enabled:{[d]:a,[u]:r}}}}}},ua=function(e){return void 0===e&&(e={}),{name:"flip",options:e,async fn(t){var n,i;const{placement:s,middlewareData:a,rects:r,initialPlacement:o,platform:l,elements:c}=t,{mainAxis:h=!0,crossAxis:u=!0,fallbackPlacements:d,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:m="none",flipAlignment:f=!0,...g}=Ji(e,t);if(null!=(n=a.arrow)&&n.alignmentOffset)return{};const v=Qi(s),x=ss(o),y=Qi(o)===o,b=await(null==l.isRTL?void 0:l.isRTL(c.floating)),_=d||(y||!f?[us(o)]:function(e){const t=us(e);return[rs(e),t,rs(t)]}(o)),w="none"!==m;!d&&w&&_.push(...function(e,t,n,i){const s=es(e);let a=function(e,t,n){switch(e){case"top":case"bottom":return n?t?ls:os:t?os:ls;case"left":case"right":return t?cs:hs;default:return[]}}(Qi(e),"start"===n,i);return s&&(a=a.map(e=>e+"-"+s),t&&(a=a.concat(a.map(rs)))),a}(o,f,m,b));const S=[o,..._],M=await fs(t,g),T=[];let E=(null==(i=a.flip)?void 0:i.overflows)||[];if(h&&T.push(M[v]),u){const e=function(e,t,n){void 0===n&&(n=!1);const i=es(e),s=as(e),a=ns(s);let r="x"===s?i===(n?"end":"start")?"right":"left":"start"===i?"bottom":"top";return t.reference[a]>t.floating[a]&&(r=us(r)),[r,us(r)]}(s,r,b);T.push(M[e[0]],M[e[1]])}if(E=[...E,{placement:s,overflows:T}],!T.every(e=>e<=0)){var C,N;const e=((null==(C=a.flip)?void 0:C.index)||0)+1,t=S[e];if(t&&("alignment"!==u||x===ss(t)||E.every(e=>e.overflows[0]>0&&ss(e.placement)===x)))return{data:{index:e,overflows:E},reset:{placement:t}};let n=null==(N=E.filter(e=>e.overflows[0]<=0).sort((e,t)=>e.overflows[1]-t.overflows[1])[0])?void 0:N.placement;if(!n)switch(p){case"bestFit":{var A;const e=null==(A=E.filter(e=>{if(w){const t=ss(e.placement);return t===x||"y"===t}return!0}).map(e=>[e.placement,e.overflows.filter(e=>e>0).reduce((e,t)=>e+t,0)]).sort((e,t)=>e[1]-t[1])[0])?void 0:A[0];e&&(n=e);break}case"initialPlacement":n=o}if(s!==n)return{reset:{placement:n}}}return{}}}},da=function(e){return void 0===e&&(e={}),{name:"size",options:e,async fn(t){var n,i;const{placement:s,rects:a,platform:r,elements:o}=t,{apply:l=()=>{},...c}=Ji(e,t),h=await fs(t,c),u=Qi(s),d=es(s),p="y"===ss(s),{width:m,height:f}=a.floating;let g,v;"top"===u||"bottom"===u?(g=u,v=d===(await(null==r.isRTL?void 0:r.isRTL(o.floating))?"start":"end")?"left":"right"):(v=u,g="end"===d?"top":"bottom");const x=f-h.top-h.bottom,y=m-h.left-h.right,b=Wi(f-h[g],x),_=Wi(m-h[v],y),w=!t.middlewareData.shift;let S=b,M=_;if(null!=(n=t.middlewareData.shift)&&n.enabled.x&&(M=y),null!=(i=t.middlewareData.shift)&&i.enabled.y&&(S=x),w&&!d){const e=Gi(h.left,0),t=Gi(h.right,0),n=Gi(h.top,0),i=Gi(h.bottom,0);p?M=m-2*(0!==e||0!==t?e+t:Gi(h.left,h.right)):S=f-2*(0!==n||0!==i?n+i:Gi(h.top,h.bottom))}await l({...t,availableWidth:M,availableHeight:S});const T=await r.getDimensions(o.floating);return m!==T.width||f!==T.height?{reset:{rects:!0}}:{}}}},pa=function(e){return void 0===e&&(e={}),{name:"hide",options:e,async fn(t){const{rects:n}=t,{strategy:i="referenceHidden",...s}=Ji(e,t);switch(i){case"referenceHidden":{const e=gs(await fs(t,{...s,elementContext:"reference"}),n.reference);return{data:{referenceHiddenOffsets:e,referenceHidden:vs(e)}}}case"escaped":{const e=gs(await fs(t,{...s,altBoundary:!0}),n.floating);return{data:{escapedOffsets:e,escaped:vs(e)}}}default:return{}}}}},ma=e=>({name:"arrow",options:e,async fn(t){const{x:n,y:i,placement:s,rects:a,platform:r,elements:o,middlewareData:l}=t,{element:c,padding:h=0}=Ji(e,t)||{};if(null==c)return{};const u=ds(h),d={x:n,y:i},p=as(s),m=ns(p),f=await r.getDimensions(c),g="y"===p,v=g?"top":"left",x=g?"bottom":"right",y=g?"clientHeight":"clientWidth",b=a.reference[m]+a.reference[p]-d[p]-a.floating[m],_=d[p]-a.reference[p],w=await(null==r.getOffsetParent?void 0:r.getOffsetParent(c));let S=w?w[y]:0;S&&await(null==r.isElement?void 0:r.isElement(w))||(S=o.floating[y]||a.floating[m]);const M=b/2-_/2,T=S/2-f[m]/2-1,E=Wi(u[v],T),C=Wi(u[x],T),N=E,A=S-f[m]-C,R=S/2-f[m]/2+M,j=Zi(N,R,A),P=!l.arrow&&null!=es(s)&&R!==j&&a.reference[m]/2-(R<N?E:C)-f[m]/2<0,I=P?R<N?R-N:R-A:0;return{[p]:d[p]+I,data:{[p]:j,centerOffset:R-j-I,...P&&{alignmentOffset:I}},reset:P}}}),fa=function(e){return void 0===e&&(e={}),{options:e,fn(t){const{x:n,y:i,placement:s,rects:a,middlewareData:r}=t,{offset:o=0,mainAxis:l=!0,crossAxis:c=!0}=Ji(e,t),h={x:n,y:i},u=ss(s),d=ts(u);let p=h[d],m=h[u];const f=Ji(o,t),g="number"==typeof f?{mainAxis:f,crossAxis:0}:{mainAxis:0,crossAxis:0,...f};if(l){const e="y"===d?"height":"width",t=a.reference[d]-a.floating[e]+g.mainAxis,n=a.reference[d]+a.reference[e]-g.mainAxis;p<t?p=t:p>n&&(p=n)}if(c){var v,x;const e="y"===d?"width":"height",t=xs.has(Qi(s)),n=a.reference[u]-a.floating[e]+(t&&(null==(v=r.offset)?void 0:v[u])||0)+(t?0:g.crossAxis),i=a.reference[u]+a.reference[e]+(t?0:(null==(x=r.offset)?void 0:x[u])||0)-(t?g.crossAxis:0);m<n?m=n:m>i&&(m=i)}return{[d]:p,[u]:m}}}};var ga="undefined"!=typeof document?n.useLayoutEffect:function(){};function va(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("function"==typeof e&&e.toString()===t.toString())return!0;let n,i,s;if(e&&t&&"object"==typeof e){if(Array.isArray(e)){if(n=e.length,n!==t.length)return!1;for(i=n;0!==i--;)if(!va(e[i],t[i]))return!1;return!0}if(s=Object.keys(e),n=s.length,n!==Object.keys(t).length)return!1;for(i=n;0!==i--;)if(!{}.hasOwnProperty.call(t,s[i]))return!1;for(i=n;0!==i--;){const n=s[i];if(!("_owner"===n&&e.$$typeof||va(e[n],t[n])))return!1}return!0}return e!=e&&t!=t}function xa(e){return"undefined"==typeof window?1:(e.ownerDocument.defaultView||window).devicePixelRatio||1}function ya(e,t){const n=xa(e);return Math.round(t*n)/n}function ba(e){const t=n.useRef(e);return ga(()=>{t.current=e}),t}const _a=e=>({name:"arrow",options:e,fn(t){const{element:n,padding:i}="function"==typeof e?e(t):e;return n&&(s=n,{}.hasOwnProperty.call(s,"current"))?null!=n.current?ma({element:n.current,padding:i}).fn(t):{}:n?ma({element:n,padding:i}).fn(t):{};var s}}),wa=(e,t)=>({...ha(e),options:[e,t]}),Sa=(e,t)=>({...fa(e),options:[e,t]}),Ma=(e,t)=>({...ua(e),options:[e,t]}),Ta=(e,t)=>({...da(e),options:[e,t]}),Ea=(e,t)=>({...pa(e),options:[e,t]}),Ca=(e,t)=>({..._a(e),options:[e,t]});var Na=n.forwardRef((e,t)=>{const{children:n,width:i=10,height:s=5,...a}=e;return ft.jsx(Pi.svg,{...a,ref:t,width:i,height:s,viewBox:"0 0 30 10",preserveAspectRatio:"none",children:e.asChild?n:ft.jsx("polygon",{points:"0,0 30,0 15,10"})})});Na.displayName="Arrow";var Aa=Na,Ra="Popper",[ja,Pa]=Ti(Ra),[Ia,Da]=ja(Ra),ka=e=>{const{__scopePopper:t,children:i}=e,[s,a]=n.useState(null);return ft.jsx(Ia,{scope:t,anchor:s,onAnchorChange:a,children:i})};ka.displayName=Ra;var La="PopperAnchor",Oa=n.forwardRef((e,t)=>{const{__scopePopper:i,virtualRef:s,...a}=e,r=Da(La,i),o=n.useRef(null),l=Mi(t,o);return n.useEffect(()=>{r.onAnchorChange((null==s?void 0:s.current)||o.current)}),s?null:ft.jsx(Pi.div,{...a,ref:l})});Oa.displayName=La;var Ua="PopperContent",[Fa,za]=ja(Ua),Ba=n.forwardRef((e,t)=>{var s,a,r,o,l,c;const{__scopePopper:h,side:u="bottom",sideOffset:d=0,align:p="center",alignOffset:m=0,arrowPadding:f=0,avoidCollisions:g=!0,collisionBoundary:v=[],collisionPadding:x=0,sticky:y="partial",hideWhenDetached:b=!1,updatePositionStrategy:_="optimized",onPlaced:w,...S}=e,M=Da(Ua,h),[T,E]=n.useState(null),C=Mi(t,e=>E(e)),[N,A]=n.useState(null),R=function(e){const[t,i]=n.useState(void 0);return zi(()=>{if(e){i({width:e.offsetWidth,height:e.offsetHeight});const t=new ResizeObserver(t=>{if(!Array.isArray(t))return;if(!t.length)return;const n=t[0];let s,a;if("borderBoxSize"in n){const e=n.borderBoxSize,t=Array.isArray(e)?e[0]:e;s=t.inlineSize,a=t.blockSize}else s=e.offsetWidth,a=e.offsetHeight;i({width:s,height:a})});return t.observe(e,{box:"border-box"}),()=>t.unobserve(e)}i(void 0)},[e]),t}(N),j=(null==R?void 0:R.width)??0,P=(null==R?void 0:R.height)??0,I=u+("center"!==p?"-"+p:""),D="number"==typeof x?x:{top:0,right:0,bottom:0,left:0,...x},k=Array.isArray(v)?v:[v],L=k.length>0,O={padding:D,boundary:k.filter(Ga),altBoundary:L},{refs:U,floatingStyles:F,placement:z,isPositioned:B,middlewareData:V}=function(e){void 0===e&&(e={});const{placement:t="bottom",strategy:s="absolute",middleware:a=[],platform:r,elements:{reference:o,floating:l}={},transform:c=!0,whileElementsMounted:h,open:u}=e,[d,p]=n.useState({x:0,y:0,strategy:s,placement:t,middlewareData:{},isPositioned:!1}),[m,f]=n.useState(a);va(m,a)||f(a);const[g,v]=n.useState(null),[x,y]=n.useState(null),b=n.useCallback(e=>{e!==M.current&&(M.current=e,v(e))},[]),_=n.useCallback(e=>{e!==T.current&&(T.current=e,y(e))},[]),w=o||g,S=l||x,M=n.useRef(null),T=n.useRef(null),E=n.useRef(d),C=null!=h,N=ba(h),A=ba(r),R=ba(u),j=n.useCallback(()=>{if(!M.current||!T.current)return;const e={placement:t,strategy:s,middleware:m};A.current&&(e.platform=A.current),((e,t,n)=>{const i=new Map,s={platform:oa,...n},a={...s.platform,_c:i};return(async(e,t,n)=>{const{placement:i="bottom",strategy:s="absolute",middleware:a=[],platform:r}=n,o=a.filter(Boolean),l=await(null==r.isRTL?void 0:r.isRTL(t));let c=await r.getElementRects({reference:e,floating:t,strategy:s}),{x:h,y:u}=ms(c,i,l),d=i,p={},m=0;for(let f=0;f<o.length;f++){const{name:n,fn:a}=o[f],{x:g,y:v,data:x,reset:y}=await a({x:h,y:u,initialPlacement:i,placement:d,strategy:s,middlewareData:p,rects:c,platform:r,elements:{reference:e,floating:t}});h=null!=g?g:h,u=null!=v?v:u,p={...p,[n]:{...p[n],...x}},y&&m<=50&&(m++,"object"==typeof y&&(y.placement&&(d=y.placement),y.rects&&(c=!0===y.rects?await r.getElementRects({reference:e,floating:t,strategy:s}):y.rects),({x:h,y:u}=ms(c,d,l))),f=-1)}return{x:h,y:u,placement:d,strategy:s,middlewareData:p}})(e,t,{...s,platform:a})})(M.current,T.current,e).then(e=>{const t={...e,isPositioned:!1!==R.current};P.current&&!va(E.current,t)&&(E.current=t,i.flushSync(()=>{p(t)}))})},[m,t,s,A,R]);ga(()=>{!1===u&&E.current.isPositioned&&(E.current.isPositioned=!1,p(e=>({...e,isPositioned:!1})))},[u]);const P=n.useRef(!1);ga(()=>(P.current=!0,()=>{P.current=!1}),[]),ga(()=>{if(w&&(M.current=w),S&&(T.current=S),w&&S){if(N.current)return N.current(w,S,j);j()}},[w,S,j,N,C]);const I=n.useMemo(()=>({reference:M,floating:T,setReference:b,setFloating:_}),[b,_]),D=n.useMemo(()=>({reference:w,floating:S}),[w,S]),k=n.useMemo(()=>{const e={position:s,left:0,top:0};if(!D.floating)return e;const t=ya(D.floating,d.x),n=ya(D.floating,d.y);return c?{...e,transform:"translate("+t+"px, "+n+"px)",...xa(D.floating)>=1.5&&{willChange:"transform"}}:{position:s,left:t,top:n}},[s,c,D.floating,d.x,d.y]);return n.useMemo(()=>({...d,update:j,refs:I,elements:D,floatingStyles:k}),[d,j,I,D,k])}({strategy:"fixed",placement:I,whileElementsMounted:(...e)=>function(e,t,n,i){void 0===i&&(i={});const{ancestorScroll:s=!0,ancestorResize:a=!0,elementResize:r="function"==typeof ResizeObserver,layoutShift:o="function"==typeof IntersectionObserver,animationFrame:c=!1}=i,h=$s(e),u=s||a?[...h?Ws(h):[],...Ws(t)]:[];u.forEach(e=>{s&&e.addEventListener("scroll",n,{passive:!0}),a&&e.addEventListener("resize",n)});const d=h&&o?function(e,t){let n,i=null;const s=ws(e);function a(){var e;clearTimeout(n),null==(e=i)||e.disconnect(),i=null}return function r(o,c){void 0===o&&(o=!1),void 0===c&&(c=1),a();const h=e.getBoundingClientRect(),{left:u,top:d,width:p,height:m}=h;if(o||t(),!p||!m)return;const f={rootMargin:-$i(d)+"px "+-$i(s.clientWidth-(u+p))+"px "+-$i(s.clientHeight-(d+m))+"px "+-$i(u)+"px",threshold:Gi(0,Wi(1,c))||1};let g=!0;function v(t){const i=t[0].intersectionRatio;if(i!==c){if(!g)return r();i?r(!1,i):n=setTimeout(()=>{r(!1,1e-7)},1e3)}1!==i||la(h,e.getBoundingClientRect())||r(),g=!1}try{i=new IntersectionObserver(v,{...f,root:s.ownerDocument})}catch(l){i=new IntersectionObserver(v,f)}i.observe(e)}(!0),a}(h,n):null;let p,m=-1,f=null;r&&(f=new ResizeObserver(e=>{let[i]=e;i&&i.target===h&&f&&(f.unobserve(t),cancelAnimationFrame(m),m=requestAnimationFrame(()=>{var e;null==(e=f)||e.observe(t)})),n()}),h&&!c&&f.observe(h),f.observe(t));let g=c?Zs(e):null;return c&&function t(){const i=Zs(e);g&&!la(g,i)&&n(),g=i,p=requestAnimationFrame(t)}(),n(),()=>{var e;u.forEach(e=>{s&&e.removeEventListener("scroll",n),a&&e.removeEventListener("resize",n)}),null==d||d(),null==(e=f)||e.disconnect(),f=null,c&&cancelAnimationFrame(p)}}(...e,{animationFrame:"always"===_}),elements:{reference:M.anchor},middleware:[(H={mainAxis:d+P,alignmentAxis:m},{...ca(H),options:[H,undefined]}),g&&wa({mainAxis:!0,crossAxis:!1,limiter:"partial"===y?Sa():void 0,...O}),g&&Ma({...O}),Ta({...O,apply:({elements:e,rects:t,availableWidth:n,availableHeight:i})=>{const{width:s,height:a}=t.reference,r=e.floating.style;r.setProperty("--radix-popper-available-width",`${n}px`),r.setProperty("--radix-popper-available-height",`${i}px`),r.setProperty("--radix-popper-anchor-width",`${s}px`),r.setProperty("--radix-popper-anchor-height",`${a}px`)}}),N&&Ca({element:N,padding:f}),qa({arrowWidth:j,arrowHeight:P}),b&&Ea({strategy:"referenceHidden",...O})]});var H;const[W,G]=$a(z),q=Ii(w);zi(()=>{B&&(null==q||q())},[B,q]);const $=null==(s=V.arrow)?void 0:s.x,X=null==(a=V.arrow)?void 0:a.y,Y=0!==(null==(r=V.arrow)?void 0:r.centerOffset),[K,Z]=n.useState();return zi(()=>{T&&Z(window.getComputedStyle(T).zIndex)},[T]),ft.jsx("div",{ref:U.setFloating,"data-radix-popper-content-wrapper":"",style:{...F,transform:B?F.transform:"translate(0, -200%)",minWidth:"max-content",zIndex:K,"--radix-popper-transform-origin":[null==(o=V.transformOrigin)?void 0:o.x,null==(l=V.transformOrigin)?void 0:l.y].join(" "),...(null==(c=V.hide)?void 0:c.referenceHidden)&&{visibility:"hidden",pointerEvents:"none"}},dir:e.dir,children:ft.jsx(Fa,{scope:h,placedSide:W,onArrowChange:A,arrowX:$,arrowY:X,shouldHideArrow:Y,children:ft.jsx(Pi.div,{"data-side":W,"data-align":G,...S,ref:C,style:{...S.style,animation:B?void 0:"none"}})})})});Ba.displayName=Ua;var Va="PopperArrow",Ha={top:"bottom",right:"left",bottom:"top",left:"right"},Wa=n.forwardRef(function(e,t){const{__scopePopper:n,...i}=e,s=za(Va,n),a=Ha[s.placedSide];return ft.jsx("span",{ref:s.onArrowChange,style:{position:"absolute",left:s.arrowX,top:s.arrowY,[a]:0,transformOrigin:{top:"",right:"0 0",bottom:"center 0",left:"100% 0"}[s.placedSide],transform:{top:"translateY(100%)",right:"translateY(50%) rotate(90deg) translateX(-50%)",bottom:"rotate(180deg)",left:"translateY(50%) rotate(-90deg) translateX(50%)"}[s.placedSide],visibility:s.shouldHideArrow?"hidden":void 0},children:ft.jsx(Aa,{...i,ref:t,style:{...i.style,display:"block"}})})});function Ga(e){return null!==e}Wa.displayName=Va;var qa=e=>({name:"transformOrigin",options:e,fn(t){var n,i,s;const{placement:a,rects:r,middlewareData:o}=t,l=0!==(null==(n=o.arrow)?void 0:n.centerOffset),c=l?0:e.arrowWidth,h=l?0:e.arrowHeight,[u,d]=$a(a),p={start:"0%",center:"50%",end:"100%"}[d],m=((null==(i=o.arrow)?void 0:i.x)??0)+c/2,f=((null==(s=o.arrow)?void 0:s.y)??0)+h/2;let g="",v="";return"bottom"===u?(g=l?p:`${m}px`,v=-h+"px"):"top"===u?(g=l?p:`${m}px`,v=`${r.floating.height+h}px`):"right"===u?(g=-h+"px",v=l?p:`${f}px`):"left"===u&&(g=`${r.floating.width+h}px`,v=l?p:`${f}px`),{data:{x:g,y:v}}}});function $a(e){const[t,n="center"]=e.split("-");return[t,n]}var Xa=ka,Ya=Oa,Ka=Ba,Za=Wa,Ja=n.forwardRef((e,t)=>{var i;const{container:s,...r}=e,[o,l]=n.useState(!1);zi(()=>l(!0),[]);const c=s||o&&(null==(i=null==globalThis?void 0:globalThis.document)?void 0:i.body);return c?a.createPortal(ft.jsx(Pi.div,{...r,ref:t}),c):null});Ja.displayName="Portal";var Qa=e=>{const{present:t,children:i}=e,s=function(e){const[t,i]=n.useState(),s=n.useRef(null),a=n.useRef(e),r=n.useRef("none"),o=e?"mounted":"unmounted",[l,c]=function(e,t){return n.useReducer((e,n)=>t[e][n]??e,e)}(o,{mounted:{UNMOUNT:"unmounted",ANIMATION_OUT:"unmountSuspended"},unmountSuspended:{MOUNT:"mounted",ANIMATION_END:"unmounted"},unmounted:{MOUNT:"mounted"}});return n.useEffect(()=>{const e=er(s.current);r.current="mounted"===l?e:"none"},[l]),zi(()=>{const t=s.current,n=a.current;if(n!==e){const i=r.current,s=er(t);e?c("MOUNT"):"none"===s||"none"===(null==t?void 0:t.display)?c("UNMOUNT"):c(n&&i!==s?"ANIMATION_OUT":"UNMOUNT"),a.current=e}},[e,c]),zi(()=>{if(t){let e;const n=t.ownerDocument.defaultView??window,i=i=>{const r=er(s.current).includes(i.animationName);if(i.target===t&&r&&(c("ANIMATION_END"),!a.current)){const i=t.style.animationFillMode;t.style.animationFillMode="forwards",e=n.setTimeout(()=>{"forwards"===t.style.animationFillMode&&(t.style.animationFillMode=i)})}},o=e=>{e.target===t&&(r.current=er(s.current))};return t.addEventListener("animationstart",o),t.addEventListener("animationcancel",i),t.addEventListener("animationend",i),()=>{n.clearTimeout(e),t.removeEventListener("animationstart",o),t.removeEventListener("animationcancel",i),t.removeEventListener("animationend",i)}}c("ANIMATION_END")},[t,c]),{isPresent:["mounted","unmountSuspended"].includes(l),ref:n.useCallback(e=>{s.current=e?getComputedStyle(e):null,i(e)},[])}}(t),a="function"==typeof i?i({present:s.isPresent}):n.Children.only(i),r=Mi(s.ref,function(e){var t,n;let i=null==(t=Object.getOwnPropertyDescriptor(e.props,"ref"))?void 0:t.get,s=i&&"isReactWarning"in i&&i.isReactWarning;return s?e.ref:(i=null==(n=Object.getOwnPropertyDescriptor(e,"ref"))?void 0:n.get,s=i&&"isReactWarning"in i&&i.isReactWarning,s?e.props.ref:e.props.ref||e.ref)}(a));return"function"==typeof i||s.isPresent?n.cloneElement(a,{ref:r}):null};function er(e){return(null==e?void 0:e.animationName)||"none"}Qa.displayName="Presence";var tr=s[" useInsertionEffect ".trim().toString()]||zi;var nr=Object.freeze({position:"absolute",border:0,width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",wordWrap:"normal"}),ir=n.forwardRef((e,t)=>ft.jsx(Pi.span,{...e,ref:t,style:{...nr,...e.style}}));ir.displayName="VisuallyHidden";var sr=ir,[ar,rr]=Ti("Tooltip",[Pa]),or=Pa(),lr="TooltipProvider",cr=700,hr="tooltip.open",[ur,dr]=ar(lr),pr=e=>{const{__scopeTooltip:t,delayDuration:i=cr,skipDelayDuration:s=300,disableHoverableContent:a=!1,children:r}=e,o=n.useRef(!0),l=n.useRef(!1),c=n.useRef(0);return n.useEffect(()=>{const e=c.current;return()=>window.clearTimeout(e)},[]),ft.jsx(ur,{scope:t,isOpenDelayedRef:o,delayDuration:i,onOpen:n.useCallback(()=>{window.clearTimeout(c.current),o.current=!1},[]),onClose:n.useCallback(()=>{window.clearTimeout(c.current),c.current=window.setTimeout(()=>o.current=!0,s)},[s]),isPointerInTransitRef:l,onPointerInTransitChange:n.useCallback(e=>{l.current=e},[]),disableHoverableContent:a,children:r})};pr.displayName=lr;var mr="Tooltip",[fr,gr]=ar(mr),vr=e=>{const{__scopeTooltip:t,children:i,open:s,defaultOpen:a,onOpenChange:r,disableHoverableContent:o,delayDuration:l}=e,c=dr(mr,e.__scopeTooltip),h=or(t),[u,d]=n.useState(null),p=function(e){const[t,i]=n.useState(Bi());return zi(()=>{i(e=>e??String(Vi++))},[e]),t?`radix-${t}`:""}(),m=n.useRef(0),f=o??c.disableHoverableContent,g=l??c.delayDuration,v=n.useRef(!1),[x,y]=function({prop:e,defaultProp:t,onChange:i=()=>{},caller:s}){const[a,r,o]=function({defaultProp:e,onChange:t}){const[i,s]=n.useState(e),a=n.useRef(i),r=n.useRef(t);return tr(()=>{r.current=t},[t]),n.useEffect(()=>{var e;a.current!==i&&(null==(e=r.current)||e.call(r,i),a.current=i)},[i,a]),[i,s,r]}({defaultProp:t,onChange:i}),l=void 0!==e,c=l?e:a;{const t=n.useRef(void 0!==e);n.useEffect(()=>{t.current,t.current=l},[l,s])}const h=n.useCallback(t=>{var n;if(l){const i=function(e){return"function"==typeof e}(t)?t(e):t;i!==e&&(null==(n=o.current)||n.call(o,i))}else r(t)},[l,e,r,o]);return[c,h]}({prop:s,defaultProp:a??!1,onChange:e=>{e?(c.onOpen(),document.dispatchEvent(new CustomEvent(hr))):c.onClose(),null==r||r(e)},caller:mr}),b=n.useMemo(()=>x?v.current?"delayed-open":"instant-open":"closed",[x]),_=n.useCallback(()=>{window.clearTimeout(m.current),m.current=0,v.current=!1,y(!0)},[y]),w=n.useCallback(()=>{window.clearTimeout(m.current),m.current=0,y(!1)},[y]),S=n.useCallback(()=>{window.clearTimeout(m.current),m.current=window.setTimeout(()=>{v.current=!0,y(!0),m.current=0},g)},[g,y]);return n.useEffect(()=>()=>{m.current&&(window.clearTimeout(m.current),m.current=0)},[]),ft.jsx(Xa,{...h,children:ft.jsx(fr,{scope:t,contentId:p,open:x,stateAttribute:b,trigger:u,onTriggerChange:d,onTriggerEnter:n.useCallback(()=>{c.isOpenDelayedRef.current?S():_()},[c.isOpenDelayedRef,S,_]),onTriggerLeave:n.useCallback(()=>{f?w():(window.clearTimeout(m.current),m.current=0)},[w,f]),onOpen:_,onClose:w,disableHoverableContent:f,children:i})})};vr.displayName=mr;var xr="TooltipTrigger",yr=n.forwardRef((e,t)=>{const{__scopeTooltip:i,...s}=e,a=gr(xr,i),r=dr(xr,i),o=or(i),l=Mi(t,n.useRef(null),a.onTriggerChange),c=n.useRef(!1),h=n.useRef(!1),u=n.useCallback(()=>c.current=!1,[]);return n.useEffect(()=>()=>document.removeEventListener("pointerup",u),[u]),ft.jsx(Ya,{asChild:!0,...o,children:ft.jsx(Pi.button,{"aria-describedby":a.open?a.contentId:void 0,"data-state":a.stateAttribute,...s,ref:l,onPointerMove:_i(e.onPointerMove,e=>{"touch"!==e.pointerType&&(h.current||r.isPointerInTransitRef.current||(a.onTriggerEnter(),h.current=!0))}),onPointerLeave:_i(e.onPointerLeave,()=>{a.onTriggerLeave(),h.current=!1}),onPointerDown:_i(e.onPointerDown,()=>{a.open&&a.onClose(),c.current=!0,document.addEventListener("pointerup",u,{once:!0})}),onFocus:_i(e.onFocus,()=>{c.current||a.onOpen()}),onBlur:_i(e.onBlur,a.onClose),onClick:_i(e.onClick,a.onClose)})})});yr.displayName=xr;var br="TooltipPortal",[_r,wr]=ar(br,{forceMount:void 0}),Sr=e=>{const{__scopeTooltip:t,forceMount:n,children:i,container:s}=e,a=gr(br,t);return ft.jsx(_r,{scope:t,forceMount:n,children:ft.jsx(Qa,{present:n||a.open,children:ft.jsx(Ja,{asChild:!0,container:s,children:i})})})};Sr.displayName=br;var Mr="TooltipContent",Tr=n.forwardRef((e,t)=>{const n=wr(Mr,e.__scopeTooltip),{forceMount:i=n.forceMount,side:s="top",...a}=e,r=gr(Mr,e.__scopeTooltip);return ft.jsx(Qa,{present:i||r.open,children:r.disableHoverableContent?ft.jsx(Rr,{side:s,...a,ref:t}):ft.jsx(Er,{side:s,...a,ref:t})})}),Er=n.forwardRef((e,t)=>{const i=gr(Mr,e.__scopeTooltip),s=dr(Mr,e.__scopeTooltip),a=n.useRef(null),r=Mi(t,a),[o,l]=n.useState(null),{trigger:c,onClose:h}=i,u=a.current,{onPointerInTransitChange:d}=s,p=n.useCallback(()=>{l(null),d(!1)},[d]),m=n.useCallback((e,t)=>{const n=e.currentTarget,i={x:e.clientX,y:e.clientY},s=function(e,t,n=5){const i=[];switch(t){case"top":i.push({x:e.x-n,y:e.y+n},{x:e.x+n,y:e.y+n});break;case"bottom":i.push({x:e.x-n,y:e.y-n},{x:e.x+n,y:e.y-n});break;case"left":i.push({x:e.x+n,y:e.y-n},{x:e.x+n,y:e.y+n});break;case"right":i.push({x:e.x-n,y:e.y-n},{x:e.x-n,y:e.y+n})}return i}(i,function(e,t){const n=Math.abs(t.top-e.y),i=Math.abs(t.bottom-e.y),s=Math.abs(t.right-e.x),a=Math.abs(t.left-e.x);switch(Math.min(n,i,s,a)){case a:return"left";case s:return"right";case n:return"top";case i:return"bottom";default:throw new Error("unreachable")}}(i,n.getBoundingClientRect())),a=function(e){const t=e.slice();return t.sort((e,t)=>e.x<t.x?-1:e.x>t.x?1:e.y<t.y?-1:e.y>t.y?1:0),function(e){if(e.length<=1)return e.slice();const t=[];for(let i=0;i<e.length;i++){const n=e[i];for(;t.length>=2;){const e=t[t.length-1],i=t[t.length-2];if(!((e.x-i.x)*(n.y-i.y)>=(e.y-i.y)*(n.x-i.x)))break;t.pop()}t.push(n)}t.pop();const n=[];for(let i=e.length-1;i>=0;i--){const t=e[i];for(;n.length>=2;){const e=n[n.length-1],i=n[n.length-2];if(!((e.x-i.x)*(t.y-i.y)>=(e.y-i.y)*(t.x-i.x)))break;n.pop()}n.push(t)}return n.pop(),1===t.length&&1===n.length&&t[0].x===n[0].x&&t[0].y===n[0].y?t:t.concat(n)}(t)}([...s,...function(e){const{top:t,right:n,bottom:i,left:s}=e;return[{x:s,y:t},{x:n,y:t},{x:n,y:i},{x:s,y:i}]}(t.getBoundingClientRect())]);l(a),d(!0)},[d]);return n.useEffect(()=>()=>p(),[p]),n.useEffect(()=>{if(c&&u){const e=e=>m(e,u),t=e=>m(e,c);return c.addEventListener("pointerleave",e),u.addEventListener("pointerleave",t),()=>{c.removeEventListener("pointerleave",e),u.removeEventListener("pointerleave",t)}}},[c,u,m,p]),n.useEffect(()=>{if(o){const e=e=>{const t=e.target,n={x:e.clientX,y:e.clientY},i=(null==c?void 0:c.contains(t))||(null==u?void 0:u.contains(t)),s=!function(e,t){const{x:n,y:i}=e;let s=!1;for(let a=0,r=t.length-1;a<t.length;r=a++){const e=t[a],o=t[r],l=e.x,c=e.y,h=o.x,u=o.y;c>i!=u>i&&n<(h-l)*(i-c)/(u-c)+l&&(s=!s)}return s}(n,o);i?p():s&&(p(),h())};return document.addEventListener("pointermove",e),()=>document.removeEventListener("pointermove",e)}},[c,u,o,h,p]),ft.jsx(Rr,{...e,ref:r})}),[Cr,Nr]=ar(mr,{isInside:!1}),Ar=Ri("TooltipContent"),Rr=n.forwardRef((e,t)=>{const{__scopeTooltip:i,children:s,"aria-label":a,onEscapeKeyDown:r,onPointerDownOutside:o,...l}=e,c=gr(Mr,i),h=or(i),{onClose:u}=c;return n.useEffect(()=>(document.addEventListener(hr,u),()=>document.removeEventListener(hr,u)),[u]),n.useEffect(()=>{if(c.trigger){const e=e=>{const t=e.target;(null==t?void 0:t.contains(c.trigger))&&u()};return window.addEventListener("scroll",e,{capture:!0}),()=>window.removeEventListener("scroll",e,{capture:!0})}},[c.trigger,u]),ft.jsx(Oi,{asChild:!0,disableOutsidePointerEvents:!1,onEscapeKeyDown:r,onPointerDownOutside:o,onFocusOutside:e=>e.preventDefault(),onDismiss:u,children:ft.jsxs(Ka,{"data-state":c.stateAttribute,...h,...l,ref:t,style:{...l.style,"--radix-tooltip-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-tooltip-content-available-width":"var(--radix-popper-available-width)","--radix-tooltip-content-available-height":"var(--radix-popper-available-height)","--radix-tooltip-trigger-width":"var(--radix-popper-anchor-width)","--radix-tooltip-trigger-height":"var(--radix-popper-anchor-height)"},children:[ft.jsx(Ar,{children:s}),ft.jsx(Cr,{scope:i,isInside:!0,children:ft.jsx(sr,{id:c.contentId,role:"tooltip",children:a||s})})]})})});Tr.displayName=Mr;var jr="TooltipArrow",Pr=n.forwardRef((e,t)=>{const{__scopeTooltip:n,...i}=e,s=or(n);return Nr(jr,n).isInside?null:ft.jsx(Za,{...s,...i,ref:t})});Pr.displayName=jr;var Ir=pr,Dr=vr,kr=yr,Lr=Sr,Or=Tr,Ur=Pr;const Fr=({children:e,content:t,side:n="top",align:i="center",delayDuration:s=500,className:a="",ariaLabel:r})=>ft.jsx(Ir,{children:ft.jsxs(Dr,{delayDuration:s,children:[ft.jsx(kr,{asChild:!0,children:ft.jsx("div",{className:a,tabIndex:0,role:"button","aria-label":r||t,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||e.preventDefault()},children:e})}),ft.jsx(Lr,{children:ft.jsxs(Or,{side:n,align:i,sideOffset:5,className:"z-50 px-3 py-2 text-sm text-white bg-gray-900/95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-700/50 max-w-xs break-words animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 md:max-w-sm lg:max-w-md","aria-describedby":"tooltip-content",children:[ft.jsx("span",{id:"tooltip-content",className:"leading-relaxed",children:t}),ft.jsx(Ur,{className:"fill-gray-900/95"})]})})]})});class zr extends r.Component{constructor(e){super(e),t(this,"resetError",()=>{this.setState({hasError:!1,error:null,errorInfo:null})}),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){"undefined"!=typeof window&&window.gtag&&window.gtag("event","exception",{description:e.message,fatal:!0}),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?this.props.fallback?ft.jsx(this.props.fallback,{error:this.state.error,resetError:this.resetError}):ft.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-950 via-red-900 to-red-800 flex items-center justify-center p-4",children:ft.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 text-center",children:[ft.jsx("div",{className:"text-red-400 mb-6",children:ft.jsx(de,{size:64,className:"mx-auto"})}),ft.jsx("h1",{className:"text-2xl font-bold text-white mb-4",children:"Oops! Something went wrong"}),ft.jsx("p",{className:"text-red-200 mb-6",children:"We're sorry, but something went wrong."}),!1,ft.jsxs("div",{className:"space-y-3",children:[ft.jsxs("button",{onClick:this.resetError,className:"w-full px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all flex items-center justify-center space-x-2",children:[ft.jsx(pe,{size:20}),ft.jsx("span",{children:"Try Again"})]}),ft.jsxs("button",{onClick:()=>window.location.href="/",className:"w-full px-6 py-3 bg-white/20 text-white rounded-xl font-semibold hover:bg-white/30 transition-all flex items-center justify-center space-x-2",children:[ft.jsx(me,{size:20}),ft.jsx("span",{children:"Go Home"})]})]}),ft.jsx("p",{className:"text-red-300 text-sm mt-6",children:"If this problem persists, please contact support."})]})}):this.props.children}}const Br=({messages:e,onDismiss:t})=>ft.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:e.map(e=>ft.jsx(Vr,{toast:e,onDismiss:t},e.id))}),Vr=({toast:e,onDismiss:t})=>{const[i,s]=n.useState(!1),[a,r]=n.useState(!1),[o,l]=n.useState(!1);n.useEffect(()=>{if(s(!0),!e.showIntroControls){const n=setTimeout(()=>{o||(s(!1),setTimeout(()=>t(e.id),300))},e.duration||4e3);return()=>clearTimeout(n)}},[e.id,e.duration,t,e.showIntroControls,o]);const c=()=>{s(!1),setTimeout(()=>t(e.id),300)};return ft.jsx("div",{className:`${(()=>{switch(e.type){case"achievement":return"bg-gradient-to-r from-yellow-600 to-orange-600";case"success":return"bg-gradient-to-r from-green-600 to-emerald-600";case"warning":return"bg-gradient-to-r from-orange-600 to-red-600";case"fun":return"bg-gradient-to-r from-purple-600 to-pink-600";default:return"bg-gradient-to-r from-blue-600 to-indigo-600"}})()} text-white rounded-lg shadow-lg border border-white/20 backdrop-blur-sm transform transition-all duration-300 ${i?"translate-x-0 opacity-100":"translate-x-full opacity-0"}`,style:{minWidth:"320px",maxWidth:"420px"},onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:ft.jsx("div",{className:"p-4",children:ft.jsxs("div",{className:"flex items-start space-x-3",children:[ft.jsx("div",{className:"flex-shrink-0 mt-0.5",children:(()=>{if(e.icon)return e.icon;switch(e.type){case"achievement":return ft.jsx(se,{className:"w-5 h-5 text-yellow-400"});case"success":return ft.jsx(ie,{className:"w-5 h-5 text-green-400"});case"warning":return ft.jsx(ye,{className:"w-5 h-5 text-orange-400"});case"fun":return ft.jsx(xe,{className:"w-5 h-5 text-purple-400"});default:return ft.jsx(ve,{className:"w-5 h-5 text-blue-400"})}})()}),ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsx("h4",{className:"text-sm font-semibold mb-1",children:e.title}),ft.jsx("p",{className:"text-xs text-white/90 leading-relaxed",children:e.message}),e.action&&ft.jsx("button",{onClick:e.action.onClick,className:"mt-2 px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs font-medium transition-colors",children:e.action.label}),e.showIntroControls&&ft.jsxs("div",{className:"mt-3 space-y-3 border-t border-white/20 pt-3",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("button",{onClick:()=>r(!a),className:"w-4 h-4 rounded border-2 flex items-center justify-center transition-colors "+(a?"bg-white border-white":"border-white/60 hover:border-white"),children:a&&ft.jsx(fe,{className:"w-2.5 h-2.5 text-gray-900"})}),ft.jsx("label",{onClick:()=>r(!a),className:"text-xs text-white/80 cursor-pointer hover:text-white transition-colors",children:"Don't show me again"})]}),ft.jsxs("div",{className:"flex space-x-2",children:[ft.jsx("button",{onClick:()=>{a&&e.onDontShowAgain?e.onDontShowAgain():e.onSkipIntro&&e.onSkipIntro(),s(!1),setTimeout(()=>t(e.id),300)},className:"flex-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-xs font-medium transition-colors",children:"Skip Intro"}),ft.jsx("button",{onClick:c,className:"px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs font-medium transition-colors",children:"Dismiss"})]})]})]}),ft.jsx("button",{onClick:c,className:"flex-shrink-0 text-white/70 hover:text-white transition-colors p-1 hover:bg-white/10 rounded",title:"Dismiss",children:ft.jsx(ge,{className:"w-4 h-4"})})]})})})},Hr=new class{constructor(){t(this,"gameId",null),t(this,"playerId",null),t(this,"listeners",{}),t(this,"presenceRef",null),t(this,"messagesRef",null),t(this,"stateRef",null),t(this,"eventsRef",null),t(this,"isConnected",!1)}async initializeGame(e,t){this.gameId=e,this.playerId=t.id,this.presenceRef=K(hi,`games/${e}/presence/${t.id}`),await Z(this.presenceRef,{id:t.id,name:t.name,characterId:t.characterId,isOnline:!0,lastSeen:Date.now(),status:"idle"});const n=K(hi,`games/${e}/presence/${t.id}`);await J(n).update({isOnline:!1,lastSeen:Date.now()}),this.setupRealtimeListeners(),this.isConnected=!0}setupRealtimeListeners(){if(!this.gameId)return;const e=K(hi,`games/${this.gameId}/presence`);this.listeners.presence=Q(e,e=>{const t=e.val();this.handlePresenceUpdate(t)});const t=K(hi,`games/${this.gameId}/messages`);this.listeners.messages=Q(t,e=>{const t=e.val();this.handleMessageUpdate(t)});const n=K(hi,`games/${this.gameId}/sharedState`);this.listeners.state=Q(n,e=>{const t=e.val();this.handleStateUpdate(t)});const i=K(hi,`games/${this.gameId}/events`);this.listeners.events=Q(i,e=>{const t=e.val();this.handleEventUpdate(t)})}async sendMessage(e){if(!this.gameId||!this.isConnected)return;const t=K(hi,`games/${this.gameId}/messages`),n=ee(t);await Z(n,{...e,id:n.key,timestamp:Date.now()})}async updatePresence(e,t){if(!this.gameId||!this.playerId||!this.isConnected)return;const n={status:e,lastSeen:Date.now()};t&&(n.position=t),await te(K(hi,`games/${this.gameId}/presence/${this.playerId}`),n)}async updateSharedState(e){if(!this.gameId||!this.isConnected)return;const t=K(hi,`games/${this.gameId}/sharedState`);await te(t,{...e,lastUpdated:Date.now()})}async broadcastEvent(e){if(!this.gameId||!this.isConnected)return;const t=K(hi,`games/${this.gameId}/events`),n=ee(t);await Z(n,{...e,timestamp:Date.now()})}async startCombat(e){if(this.gameId&&this.isConnected){await this.updateSharedState({combatState:{isActive:!0,participants:e.participants,currentTurn:e.currentTurn,round:1}}),await this.broadcastEvent({type:"combat_start",data:e});for(const t of e.participants)await te(K(hi,`games/${this.gameId}/presence/${t}`),{status:"in-combat",lastSeen:Date.now()})}}async endCombat(e){if(!this.gameId||!this.isConnected)return;await this.updateSharedState({combatState:{isActive:!1,participants:[],currentTurn:null,round:0}}),await this.broadcastEvent({type:"combat_end",data:e});const t=K(hi,`games/${this.gameId}/presence`),n=await ne(t);if(n.exists()){const e=n.val(),i={};Object.keys(e).forEach(e=>{i[`${e}/status`]="idle",i[`${e}/lastSeen`]=Date.now()}),await te(t,i)}}async updatePlayerPosition(e){this.gameId&&this.playerId&&this.isConnected&&(await this.updatePresence("exploring",e),await this.broadcastEvent({type:"movement",data:{playerId:this.playerId,position:e,timestamp:Date.now()}}))}async getOnlinePlayers(){if(!this.gameId)return[];const e=K(hi,`games/${this.gameId}/presence`),t=await ne(e);if(!t.exists())return[];const n=t.val();return Object.values(n).filter(e=>e.isOnline)}async getRecentMessages(e=50){if(!this.gameId)return[];const t=K(hi,`games/${this.gameId}/messages`),n=await ne(t);if(!n.exists())return[];const i=n.val();return Object.values(i).sort((e,t)=>t.timestamp-e.timestamp).slice(0,e)}async getSharedState(){if(!this.gameId)return null;const e=K(hi,`games/${this.gameId}/sharedState`),t=await ne(e);return t.exists()?t.val():null}handlePresenceUpdate(e){}handleMessageUpdate(e){}handleStateUpdate(e){}handleEventUpdate(e){}onPresenceUpdate(e){this.handlePresenceUpdate=e}onMessageUpdate(e){this.handleMessageUpdate=e}onStateUpdate(e){this.handleStateUpdate=e}onEventUpdate(e){this.handleEventUpdate=e}async disconnect(){this.gameId&&this.playerId&&(await te(K(hi,`games/${this.gameId}/presence/${this.playerId}`),{isOnline:!1,lastSeen:Date.now()}),Object.values(this.listeners).forEach(e=>{"function"==typeof e&&e()}),this.listeners={},this.isConnected=!1,this.gameId=null,this.playerId=null)}isGameConnected(){return this.isConnected&&null!==this.gameId}getCurrentGameId(){return this.gameId}getCurrentPlayerId(){return this.playerId}},Wr=e=>"string"!=typeof e?"":e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi,"").replace(/<embed\b[^<]*(?:(?!<\/embed>)<[^<]*)*<\/embed>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").replace(/<[^>]*>/g,"").trim(),Gr=["badword1","badword2","badword3","spam","scam","hack","crack"];class qr{constructor(e=5,n=6e4){t(this,"attempts",new Map),this.maxAttempts=e,this.windowMs=n}isAllowed(e){const t=Date.now(),n=this.attempts.get(e);return!n||t>n.resetTime?(this.attempts.set(e,{count:1,resetTime:t+this.windowMs}),!0):!(n.count>=this.maxAttempts||(n.count++,0))}reset(e){this.attempts.delete(e)}getRemainingAttempts(e){const t=this.attempts.get(e);return t?Math.max(0,this.maxAttempts-t.count):this.maxAttempts}getTimeUntilReset(e){const t=this.attempts.get(e);return t?Math.max(0,t.resetTime-Date.now()):0}}const $r="@firebase/installations",Xr="0.6.9",Yr=`w:${Xr}`,Kr="FIS_v2",Zr=new _("installations","Installations",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."});function Jr(e){return e instanceof w&&e.code.includes("request-failed")}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Qr({projectId:e}){return`https://firebaseinstallations.googleapis.com/v1/projects/${e}/installations`}function eo(e){return{token:e.token,requestStatus:2,expiresIn:(t=e.expiresIn,Number(t.replace("s","000"))),creationTime:Date.now()};var t}async function to(e,t){const n=(await t.json()).error;return Zr.create("request-failed",{requestName:e,serverCode:n.code,serverMessage:n.message,serverStatus:n.status})}function no({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}async function io(e){const t=await e();return t.status>=500&&t.status<600?e():t}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function so(e){return new Promise(t=>{setTimeout(t,e)})}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const ao=/^[cdef][\w-]{21}$/;function ro(){try{const e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;const t=function(e){var t;return(t=e,btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_")).substr(0,22)}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(e);return ao.test(t)?t:""}catch(e){return""}}function oo(e){return`${e.appName}!${e.appId}`}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const lo=new Map;function co(e,t){const n=oo(e);ho(n,t),function(e,t){const n=(!uo&&"BroadcastChannel"in self&&(uo=new BroadcastChannel("[Firebase] FID Change"),uo.onmessage=e=>{ho(e.data.key,e.data.fid)}),uo);n&&n.postMessage({key:e,fid:t}),0===lo.size&&uo&&(uo.close(),uo=null)}(n,t)}function ho(e,t){const n=lo.get(e);if(n)for(const i of n)i(t)}let uo=null;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const po="firebase-installations-store";let mo=null;function fo(){return mo||(mo=S("firebase-installations-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(po)}})),mo}async function go(e,t){const n=oo(e),i=(await fo()).transaction(po,"readwrite"),s=i.objectStore(po),a=await s.get(n);return await s.put(t,n),await i.done,a&&a.fid===t.fid||co(e,t.fid),t}async function vo(e){const t=oo(e),n=(await fo()).transaction(po,"readwrite");await n.objectStore(po).delete(t),await n.done}async function xo(e,t){const n=oo(e),i=(await fo()).transaction(po,"readwrite"),s=i.objectStore(po),a=await s.get(n),r=t(a);return void 0===r?await s.delete(n):await s.put(r,n),await i.done,!r||a&&a.fid===r.fid||co(e,r.fid),r}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function yo(e){let t;const n=await xo(e.appConfig,n=>{const i=function(e){return wo(e||{fid:ro(),registrationStatus:0})}(n),s=function(e,t){if(0===t.registrationStatus){if(!navigator.onLine)return{installationEntry:t,registrationPromise:Promise.reject(Zr.create("app-offline"))};const n={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},i=async function(e,t){try{const n=
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */await async function({appConfig:e,heartbeatServiceProvider:t},{fid:n}){const i=Qr(e),s=no(e),a=t.getImmediate({optional:!0});if(a){const e=await a.getHeartbeatsHeader();e&&s.append("x-firebase-client",e)}const r={fid:n,authVersion:Kr,appId:e.appId,sdkVersion:Yr},o={method:"POST",headers:s,body:JSON.stringify(r)},l=await io(()=>fetch(i,o));if(l.ok){const e=await l.json();return{fid:e.fid||n,registrationStatus:2,refreshToken:e.refreshToken,authToken:eo(e.authToken)}}throw await to("Create Installation",l)}(e,t);return go(e.appConfig,n)}catch($T){throw Jr($T)&&409===$T.customData.serverCode?await vo(e.appConfig):await go(e.appConfig,{fid:t.fid,registrationStatus:0}),$T}}(e,n);return{installationEntry:n,registrationPromise:i}}return 1===t.registrationStatus?{installationEntry:t,registrationPromise:bo(e)}:{installationEntry:t}}(e,i);return t=s.registrationPromise,s.installationEntry});return""===n.fid?{installationEntry:await t}:{installationEntry:n,registrationPromise:t}}async function bo(e){let t=await _o(e.appConfig);for(;1===t.registrationStatus;)await so(100),t=await _o(e.appConfig);if(0===t.registrationStatus){const{installationEntry:t,registrationPromise:n}=await yo(e);return n||t}return t}function _o(e){return xo(e,e=>{if(!e)throw Zr.create("installation-not-found");return wo(e)})}function wo(e){return 1===(t=e).registrationStatus&&t.registrationTime+1e4<Date.now()?{fid:e.fid,registrationStatus:0}:e;var t;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */}async function So({appConfig:e,heartbeatServiceProvider:t},n){const i=function(e,{fid:t}){return`${Qr(e)}/${t}/authTokens:generate`}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(e,n),s=function(e,{refreshToken:t}){const n=no(e);return n.append("Authorization",function(e){return`${Kr} ${e}`}(t)),n}(e,n),a=t.getImmediate({optional:!0});if(a){const e=await a.getHeartbeatsHeader();e&&s.append("x-firebase-client",e)}const r={installation:{sdkVersion:Yr,appId:e.appId}},o={method:"POST",headers:s,body:JSON.stringify(r)},l=await io(()=>fetch(i,o));if(l.ok)return eo(await l.json());throw await to("Generate Auth Token",l)}async function Mo(e,t=!1){let n;const i=await xo(e.appConfig,i=>{if(!Eo(i))throw Zr.create("not-registered");const s=i.authToken;if(!t&&(2===(a=s).requestStatus&&!function(e){const t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+36e5}(a)))return i;var a;if(1===s.requestStatus)return n=async function(e,t){let n=await To(e.appConfig);for(;1===n.authToken.requestStatus;)await so(100),n=await To(e.appConfig);const i=n.authToken;return 0===i.requestStatus?Mo(e,t):i}(e,t),i;{if(!navigator.onLine)throw Zr.create("app-offline");const t=function(e){const t={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},e),{authToken:t})}(i);return n=async function(e,t){try{const n=await So(e,t),i=Object.assign(Object.assign({},t),{authToken:n});return await go(e.appConfig,i),n}catch($T){if(!Jr($T)||401!==$T.customData.serverCode&&404!==$T.customData.serverCode){const n=Object.assign(Object.assign({},t),{authToken:{requestStatus:0}});await go(e.appConfig,n)}else await vo(e.appConfig);throw $T}}(e,t),t}});return n?await n:i.authToken}function To(e){return xo(e,e=>{if(!Eo(e))throw Zr.create("not-registered");return 1===(t=e.authToken).requestStatus&&t.requestTime+1e4<Date.now()?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e;var t;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */})}function Eo(e){return void 0!==e&&2===e.registrationStatus}function Co(e){return Zr.create("missing-app-config-values",{valueName:e})}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const No="installations";x(new y(No,e=>{const t=e.getProvider("app").getImmediate(),n=
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function(e){if(!e||!e.options)throw Co("App Configuration");if(!e.name)throw Co("App Name");const t=["projectId","apiKey","appId"];for(const n of t)if(!e.options[n])throw Co(n);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}(t);return{app:t,appConfig:n,heartbeatServiceProvider:b(t,"heartbeat"),_delete:()=>Promise.resolve()}},"PUBLIC")),x(new y("installations-internal",e=>{const t=e.getProvider("app").getImmediate(),n=b(t,No).getImmediate();return{getId:()=>async function(e){const t=e,{installationEntry:n,registrationPromise:i}=await yo(t);return i?i.catch(console.error):Mo(t).catch(console.error),n.fid}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(n),getToken:e=>async function(e,t=!1){const n=e;return await async function(e){const{registrationPromise:t}=await yo(e);t&&await t}(n),(await Mo(n,t)).token}(n,e)}},"PRIVATE")),v($r,Xr),v($r,Xr,"esm2017");
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Ao="analytics",Ro="https://www.googletagmanager.com/gtag/js",jo=new C("@firebase/analytics"),Po=new _("analytics","Analytics",{"already-exists":"A Firebase Analytics instance with the appId {$id}  already exists. Only one Firebase Analytics instance can be created for each appId.","already-initialized":"initializeAnalytics() cannot be called again with different options than those it was initially called with. It can be called again with the same options to return the existing instance, or getAnalytics() can be used to get a reference to the already-initialized instance.","already-initialized-settings":"Firebase Analytics has already been initialized.settings() must be called before initializing any Analytics instanceor it will have no effect.","interop-component-reg-failed":"Firebase Analytics Interop Component failed to instantiate: {$reason}","invalid-analytics-context":"Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","indexeddb-unavailable":"IndexedDB unavailable or restricted in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","fetch-throttle":"The config fetch request timed out while in an exponential backoff state. Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.","config-fetch-failed":"Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}","no-api-key":'The "apiKey" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid API key.',"no-app-id":'The "appId" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid app ID.',"no-client-id":'The "client_id" field is empty.',"invalid-gtag-resource":"Trusted Types detected an invalid gtag resource: {$gtagURL}."});
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function Io(e){if(!e.startsWith(Ro)){const t=Po.create("invalid-gtag-resource",{gtagURL:e});return jo.warn(t.message),""}return e}function Do(e){return Promise.all(e.map(e=>e.catch(e=>e)))}const ko=new class{constructor(e={},t=1e3){this.throttleMetadata=e,this.intervalMillis=t}getThrottleMetadata(e){return this.throttleMetadata[e]}setThrottleMetadata(e,t){this.throttleMetadata[e]=t}deleteThrottleMetadata(e){delete this.throttleMetadata[e]}};function Lo(e){return new Headers({Accept:"application/json","x-goog-api-key":e})}async function Oo(e,t=ko,n){const{appId:i,apiKey:s,measurementId:a}=e.options;if(!i)throw Po.create("no-app-id");if(!s){if(a)return{measurementId:a,appId:i};throw Po.create("no-api-key")}const r=t.getThrottleMetadata(i)||{backoffCount:0,throttleEndTimeMillis:Date.now()},o=new Fo;return setTimeout(async()=>{o.abort()},void 0!==n?n:6e4),Uo({appId:i,apiKey:s,measurementId:a},r,o,t)}async function Uo(e,{throttleEndTimeMillis:t,backoffCount:n},i,s=ko){var a;const{appId:r,measurementId:o}=e;try{await function(e,t){return new Promise((n,i)=>{const s=Math.max(t-Date.now(),0),a=setTimeout(n,s);e.addEventListener(()=>{clearTimeout(a),i(Po.create("fetch-throttle",{throttleEndTimeMillis:t}))})})}(i,t)}catch($T){if(o)return jo.warn(`Timed out fetching this Firebase app's measurement ID from the server. Falling back to the measurement ID ${o} provided in the "measurementId" field in the local Firebase config. [${null==$T?void 0:$T.message}]`),{appId:r,measurementId:o};throw $T}try{const t=await async function(e){var t;const{appId:n,apiKey:i}=e,s={method:"GET",headers:Lo(i)},a="https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig".replace("{app-id}",n),r=await fetch(a,s);if(200!==r.status&&304!==r.status){let e="";try{const n=await r.json();(null===(t=n.error)||void 0===t?void 0:t.message)&&(e=n.error.message)}catch(o){}throw Po.create("config-fetch-failed",{httpStatus:r.status,responseMessage:e})}return r.json()}(e);return s.deleteThrottleMetadata(r),t}catch($T){const l=$T;if(!function(e){if(!(e instanceof w&&e.customData))return!1;const t=Number(e.customData.httpStatus);return 429===t||500===t||503===t||504===t}(l)){if(s.deleteThrottleMetadata(r),o)return jo.warn(`Failed to fetch this Firebase app's measurement ID from the server. Falling back to the measurement ID ${o} provided in the "measurementId" field in the local Firebase config. [${null==l?void 0:l.message}]`),{appId:r,measurementId:o};throw $T}const c=503===Number(null===(a=null==l?void 0:l.customData)||void 0===a?void 0:a.httpStatus)?A(n,s.intervalMillis,30):A(n,s.intervalMillis),h={throttleEndTimeMillis:Date.now()+c,backoffCount:n+1};return s.setThrottleMetadata(r,h),jo.debug(`Calling attemptFetch again in ${c} millis`),Uo(e,h,i,s)}}class Fo{constructor(){this.listeners=[]}addEventListener(e){this.listeners.push(e)}abort(){this.listeners.forEach(e=>e())}}async function zo(e,t,n,i,s,a,r){var o;const l=Oo(e);l.then(t=>{n[t.measurementId]=t.appId,e.options.measurementId&&t.measurementId!==e.options.measurementId&&jo.warn(`The measurement ID in the local Firebase config (${e.options.measurementId}) does not match the measurement ID fetched from the server (${t.measurementId}). To ensure analytics events are always sent to the correct Analytics property, update the measurement ID field in the local config or remove it from the local config.`)}).catch(e=>jo.error(e)),t.push(l);const c=
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
async function(){if(!R())return jo.warn(Po.create("indexeddb-unavailable",{errorInfo:"IndexedDB is not available in this environment."}).message),!1;try{await j()}catch($T){return jo.warn(Po.create("indexeddb-unavailable",{errorInfo:null==$T?void 0:$T.toString()}).message),!1}return!0}().then(e=>e?i.getId():void 0),[h,u]=await Promise.all([l,c]);(function(e){const t=window.document.getElementsByTagName("script");for(const n of Object.values(t))if(n.src&&n.src.includes(Ro)&&n.src.includes(e))return n;return null}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */)(a)||function(e,t){const n=function(e,t){let n;return window.trustedTypes&&(n=window.trustedTypes.createPolicy("firebase-js-sdk-policy",t)),n}(0,{createScriptURL:Io}),i=document.createElement("script"),s=`${Ro}?l=${e}&id=${t}`;i.src=n?null==n?void 0:n.createScriptURL(s):s,i.async=!0,document.head.appendChild(i)}(a,h.measurementId),s("js",new Date);const d=null!==(o=null==r?void 0:r.config)&&void 0!==o?o:{};return d.origin="firebase",d.update=!0,null!=u&&(d.firebase_id=u),s("config",h.measurementId,d),h.measurementId}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Bo=class{constructor(e){this.app=e}_delete(){return delete Vo[this.app.options.appId],Promise.resolve()}},Vo={},Ho=[];const Wo={};let Go,qo,$o="dataLayer",Xo=!1;function Yo(e,t,n){!function(){const e=[];if(N()&&e.push("This is a browser extension environment."),P()||e.push("Cookies are not available."),e.length>0){const t=e.map((e,t)=>`(${t+1}) ${e}`).join(" "),n=Po.create("invalid-analytics-context",{errorInfo:t});jo.warn(n.message)}}();const i=e.options.appId;if(!i)throw Po.create("no-app-id");if(!e.options.apiKey){if(!e.options.measurementId)throw Po.create("no-api-key");jo.warn(`The "apiKey" field is empty in the local Firebase config. This is needed to fetch the latest measurement ID for this Firebase app. Falling back to the measurement ID ${e.options.measurementId} provided in the "measurementId" field in the local Firebase config.`)}if(null!=Vo[i])throw Po.create("already-exists",{id:i});if(!Xo){!function(e){let t=[];Array.isArray(window[e])?t=window[e]:window[e]=t}($o);const{wrappedGtag:e,gtagCore:t}=function(e,t,n,i,s){let a=function(...e){window[i].push(arguments)};return window[s]&&"function"==typeof window[s]&&(a=window[s]),window[s]=function(e,t,n,i){return async function(s,...a){try{if("event"===s){const[i,s]=a;await async function(e,t,n,i,s){try{let a=[];if(s&&s.send_to){let e=s.send_to;Array.isArray(e)||(e=[e]);const i=await Do(n);for(const n of e){const e=i.find(e=>e.measurementId===n),s=e&&t[e.appId];if(!s){a=[];break}a.push(s)}}0===a.length&&(a=Object.values(t)),await Promise.all(a),e("event",i,s||{})}catch($T){jo.error($T)}}(e,t,n,i,s)}else if("config"===s){const[s,r]=a;await async function(e,t,n,i,s,a){const r=i[s];try{if(r)await t[r];else{const e=(await Do(n)).find(e=>e.measurementId===s);e&&await t[e.appId]}}catch($T){jo.error($T)}e("config",s,a)}(e,t,n,i,s,r)}else if("consent"===s){const[t,n]=a;e("consent",t,n)}else if("get"===s){const[t,n,i]=a;e("get",t,n,i)}else if("set"===s){const[t]=a;e("set",t)}else e(s,...a)}catch($T){jo.error($T)}}}(a,e,t,n),{gtagCore:a,wrappedGtag:window[s]}}(Vo,Ho,Wo,$o,"gtag");qo=e,Go=t,Xo=!0}return Vo[i]=zo(e,Ho,Wo,t,Go,$o,n),new Bo(e)}function Ko(e,t,n,i){e=M(e),async function(e,t,n,i,s){if(s&&s.global)e("event",n,i);else{const s=await t;e("event",n,Object.assign(Object.assign({},i),{send_to:s}))}}(qo,Vo[e.app.options.appId],t,n,i).catch(e=>jo.error(e))}const Zo="@firebase/analytics",Jo="0.10.8";x(new y(Ao,(e,{options:t})=>Yo(e.getProvider("app").getImmediate(),e.getProvider("installations-internal").getImmediate(),t),"PUBLIC")),x(new y("analytics-internal",function(e){try{const t=e.getProvider(Ao).getImmediate();return{logEvent:(e,n,i)=>Ko(t,e,n,i)}}catch($T){throw Po.create("interop-component-reg-failed",{reason:$T})}},"PRIVATE")),v(Zo,Jo),v(Zo,Jo,"esm2017");const Qo=g({apiKey:"AIzaSyAVJvau3Hit06q1pNYCTOF-pVuutmk4oNQ",authDomain:"mythseekers-rpg.firebaseapp.com",databaseURL:"https://mythseekers-rpg-default-rtdb.firebaseio.com",projectId:"mythseekers-rpg",storageBucket:"mythseekers-rpg.firebasestorage.app",messagingSenderId:"659018227506",appId:"1:659018227506:web:82425e7adaf80c2e3c412b",measurementId:"G-E3T1V81ZX3"}),el=new class{constructor(){t(this,"analytics",null),t(this,"isInitialized",!1),this.initializeAnalytics()}initializeAnalytics(){try{"undefined"!=typeof window&&Qo&&(this.analytics=function(e=T()){e=M(e);const t=b(e,Ao);return t.isInitialized()?t.getImmediate():function(e,t={}){const n=b(e,Ao);if(n.isInitialized()){const e=n.getImmediate();if(E(t,n.getOptions()))return e;throw Po.create("already-initialized")}return n.initialize({options:t})}(e)}(Qo),this.isInitialized=!0)}catch(e){}}setUserId(e){if(this.analytics&&this.isInitialized)try{t=this.analytics,n=e,t=M(t),async function(e,t,n,i){if(i&&i.global)return e("set",{user_id:n}),Promise.resolve();e("config",await t,{update:!0,user_id:n})}(qo,Vo[t.app.options.appId],n,i).catch(e=>jo.error(e))}catch(s){}var t,n,i}setUserProperties(e){if(this.analytics&&this.isInitialized)try{!function(e,t,n){e=M(e),async function(e,t,n,i){if(i&&i.global){const t={};for(const e of Object.keys(n))t[`user_properties.${e}`]=n[e];return e("set",t),Promise.resolve()}e("config",await t,{update:!0,user_properties:n})}(qo,Vo[e.app.options.appId],t,n).catch(e=>jo.error(e))}(this.analytics,e)}catch(t){}}trackPageView(e,t){this.logEvent("page_view",{page_name:e,page_title:t||e,timestamp:Date.now()})}trackUserAction(e,t){this.logEvent("user_action",{action:e,...t,timestamp:Date.now()})}trackGameEvent(e,t){this.logEvent("game_event",{event:e,...t,timestamp:Date.now()})}trackPerformance(e,t,n){this.logEvent("performance",{metric:e,value:t,...n,timestamp:Date.now()})}trackError(e,t){this.logEvent("error",{error_message:e.message,error_stack:e.stack,error_name:e.name,...t,timestamp:Date.now()})}trackFeatureUsage(e,t,n){this.logEvent("feature_usage",{feature:e,action:t,...n,timestamp:Date.now()})}trackConversion(e,t,n){this.logEvent("conversion",{conversion_type:e,value:t,currency:n||"USD",timestamp:Date.now()})}trackEngagement(e,t,n){this.logEvent("engagement",{metric:e,value:t,...n,timestamp:Date.now()})}logEvent(e,t){if(this.analytics&&this.isInitialized)try{Ko(this.analytics,e,t)}catch(n){}}trackCoreWebVitals(e,t){this.trackPerformance(`web_vital_${e.toLowerCase()}`,t)}trackBundleLoad(e,t,n){this.trackPerformance("bundle_load",t,{bundle_name:e,bundle_size:n})}trackAPIPerformance(e,t,n){this.trackPerformance("api_response_time",t,{endpoint:e,status_code:n})}trackOnboardingStep(e,t,n){this.trackUserAction("onboarding_step",{step:e,completed:t,time_spent:n})}trackCharacterCreation(e,t){this.trackGameEvent("character_created",{character_class:e,time_spent:t})}trackCampaignEvent(e,t,n){this.trackGameEvent(e,{campaign_id:t,...n})}trackCombatEvent(e,t){this.trackGameEvent(`combat_${e}`,t)}trackAIInteraction(e,t,n){this.trackPerformance("ai_response_time",t,{interaction_type:e,success:n})}trackMultiplayerEvent(e,t){this.trackGameEvent(`multiplayer_${e}`,t)}trackAccessibilityUsage(e,t){this.trackFeatureUsage("accessibility",e,{enabled:t})}trackDeviceInfo(){if("undefined"!=typeof window){const e=navigator.userAgent,t=`${screen.width}x${screen.height}`,n=`${window.innerWidth}x${window.innerHeight}`;this.setUserProperties({device_type:this.getDeviceType(),browser:this.getBrowserInfo(),screen_resolution:t,viewport_size:n,user_agent:e.substring(0,100)})}}getDeviceType(){if("undefined"==typeof window)return"unknown";const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipad|phone/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}getBrowserInfo(){if("undefined"==typeof window)return"unknown";const e=navigator.userAgent;return e.includes("Chrome")?"chrome":e.includes("Firefox")?"firefox":e.includes("Safari")?"safari":e.includes("Edge")?"edge":"other"}trackSessionStart(){this.trackUserAction("session_start",{session_id:this.generateSessionId(),referrer:document.referrer||"direct"})}trackSessionEnd(e){this.trackUserAction("session_end",{session_duration:e})}generateSessionId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}trackUserPreference(e,t){this.trackUserAction("preference_changed",{preference:e,value:String(t)})}trackSearch(e,t){this.trackUserAction("search",{query:e.substring(0,50),results_count:t})}trackHelpUsage(e,t){this.trackFeatureUsage("help",t,{topic:e})}trackTutorialCompletion(e,t,n){this.trackUserAction("tutorial_completion",{tutorial_name:e,completed:t,steps_completed:n})}};class tl{constructor(){t(this,"state"),this.state={isActive:!1,currentTurn:0,turnOrder:[],currentCombatantIndex:0,combatants:[],battleMap:this.createDefaultBattleMap(),combatLog:[],round:1,lineOfSightCache:{}}}createDefaultBattleMap(){const e=[];for(let t=0;t<8;t++){const n=[];for(let e=0;e<12;e++){let i="floor";0===e||11===e||0===t||7===t?i="wall":Math.random()<.1&&(i="difficult"),n.push({type:i,elevation:0,cover:0,occupied:!1})}e.push(n)}return{width:12,height:8,tiles:e}}startCombat(e,t){const n=this.assignStartingPositions(e,t||this.state.battleMap),i=this.calculateInitiativeOrder(n),s=n.map(e=>({...e,currentActionPoints:{...e.actionPoints},isActive:!1,hasActed:!1}));return this.state={isActive:!0,currentTurn:0,turnOrder:i,currentCombatantIndex:0,combatants:s,battleMap:t||this.state.battleMap,combatLog:[],round:1,lineOfSightCache:{}},this.setActiveCombatant(0),this.getState()}assignStartingPositions(e,t){const n=[...e],i=Math.floor(t.width/2),s=Math.floor(t.height/2);return n.filter(e=>"player"===e.type).forEach((e,t)=>{e.position={x:Math.max(1,i-3+t),y:s}}),n.filter(e=>"enemy"===e.type).forEach((e,n)=>{e.position={x:Math.min(t.width-2,i+3-n),y:s}}),n}calculateInitiativeOrder(e){return e.map(e=>({id:e.id,initiative:this.rollInitiative(e)})).sort((e,t)=>t.initiative-e.initiative).map(e=>e.id)}rollInitiative(e){const t=Math.floor((e.stats.dexterity-10)/2);return Math.floor(20*Math.random())+1+t}getState(){return{...this.state}}getActiveCombatant(){if(!this.state.isActive||0===this.state.turnOrder.length)return null;const e=this.state.turnOrder[this.state.currentCombatantIndex];return this.state.combatants.find(t=>t.id===e)||null}isPlayerTurn(){const e=this.getActiveCombatant();return"player"===(null==e?void 0:e.type)}executeAction(e){const t=this.getActiveCombatant();if(!t)return{success:!1,message:"No active combatant"};switch(e.type){case"move":return this.executeMove(t,e);case"attack":return this.executeAttack(t,e);case"skill":return this.executeSkill(t,e);case"end-turn":return this.endTurn();default:return{success:!1,message:"Unknown action type"}}}executeMove(e,t){if(e.currentActionPoints.move<=0)return{success:!1,message:"No movement points remaining"};if(!t.target||"string"==typeof t.target)return{success:!1,message:"Invalid move target"};const n=t.target.x,i=t.target.y;if(n<0||n>=this.state.battleMap.width||i<0||i>=this.state.battleMap.height)return{success:!1,message:"Target position out of bounds"};const s=this.state.battleMap.tiles[i][n];if("wall"===s.type||s.occupied)return{success:!1,message:"Cannot move to occupied or wall tile"};const a=Math.abs(n-e.position.x)+Math.abs(i-e.position.y),r="difficult"===s.type?2*a:a;if(r>e.currentActionPoints.move)return{success:!1,message:"Not enough movement points"};const o=this.state.combatants.map(t=>t.id===e.id?{...t,position:{x:n,y:i},currentActionPoints:{...t.currentActionPoints,move:t.currentActionPoints.move-r}}:t);return this.state.combatants=o,this.addCombatLog(e.id,"move",`${e.name} moved to (${n}, ${i})`),{success:!0,message:`${e.name} moved to (${n}, ${i})`,newState:this.getState()}}calculateLineOfSight(e,t){const n=`${e.x},${e.y}-${t.x},${t.y}`;if(this.state.lineOfSightCache[n])return this.state.lineOfSightCache[n].has("visible");const i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y),a=e.x<t.x?1:-1,r=e.y<t.y?1:-1;let o=i-s,l=e.x,c=e.y;for(;l!==t.x||c!==t.y;){if(l>=0&&l<this.state.battleMap.width&&c>=0&&c<this.state.battleMap.height){const e=this.state.battleMap.tiles[c][l];if("wall"===e.type||e.cover>=3)return this.state.lineOfSightCache[n]=new Set(["blocked"]),!1}const e=2*o;e>-s&&(o-=s,l+=a),e<i&&(o+=i,c+=r)}return this.state.lineOfSightCache[n]=new Set(["visible"]),!0}getVisibleTargets(e){return this.state.combatants.filter(t=>!(t.id===e.id||t.health<=0)&&this.calculateLineOfSight(e.position,t.position))}calculateFlankingBonus(e,t){const n=this.state.combatants.filter(t=>t.type===e.type&&t.id!==e.id&&t.health>0);for(const i of n){const n=Math.abs(i.position.x-t.position.x)+Math.abs(i.position.y-t.position.y),s=Math.abs(e.position.x-t.position.x)+Math.abs(e.position.y-t.position.y);if(n<=1&&s<=1){const n=i.position.x-t.position.x,s=i.position.y-t.position.y,a=e.position.x-t.position.x,r=e.position.y-t.position.y;if((n*a<0||s*r<0)&&(0!==n||0!==a)&&(0!==s||0!==r))return 2}}return 0}getEnemyAIAction(e){const t=this.getVisibleTargets(e);if(0===t.length)return this.getMovementTowardsPlayers(e);const n={personality:"aggressive",preferredRange:"melee",targetPriority:"closest",retreatThreshold:.3,flankingBonus:!0};if(e.health/e.maxHealth<n.retreatThreshold)return{type:"move",target:void 0};const i=this.selectTarget(t,n.targetPriority,e);switch(n.personality){case"aggressive":default:return this.getAggressiveAction(e,i,n);case"defensive":return this.getDefensiveAction(e,i,n);case"tactical":return this.getTacticalAction(e,i,n);case"cowardly":return this.getCowardlyAction(e,i,n)}}selectTarget(e,t,n){switch(t){case"weakest":return e.reduce((e,t)=>t.health<e.health?t:e);case"strongest":return e.reduce((e,t)=>t.health>e.health?t:e);case"closest":return e.reduce((e,t)=>{const i=Math.abs(e.position.x-n.position.x)+Math.abs(e.position.y-n.position.y);return Math.abs(t.position.x-n.position.x)+Math.abs(t.position.y-n.position.y)<i?t:e});case"threat":return e.reduce((e,t)=>2*(t.maxHealth-t.health)+t.stats.strength>2*(e.maxHealth-e.health)+e.stats.strength?t:e);default:return e[0]}}getAggressiveAction(e,t,n){if(Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y)<=e.reach&&e.currentActionPoints.action>0)return{type:"attack",target:t.position};if(e.currentActionPoints.move>0){const n=this.findPathToTarget(e,t);if(n.length>1)return{type:"move",target:n[1],path:n}}return{type:"end-turn"}}getDefensiveAction(e,t,n){const i=Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y);if(i<=1&&e.currentActionPoints.move>0){const n=this.findRetreatPosition(e,t);if(n)return{type:"move",target:n}}else if(i<=e.reach&&e.currentActionPoints.action>0)return{type:"attack",target:t.position};return{type:"end-turn"}}getTacticalAction(e,t,n){const i=this.calculateFlankingBonus(e,t),s=this.state.battleMap.tiles[e.position.y][e.position.x],a=this.state.battleMap.tiles[t.position.y][t.position.x],r=a.cover,o=s.cover,l=s.elevation,c=a.elevation;if(i>0&&e.currentActionPoints.action>0&&r<2)return{type:"attack",target:t.position};if(l>c&&e.currentActionPoints.action>0)return{type:"attack",target:t.position};const h=this.findTacticalPosition(e,t);return h&&e.currentActionPoints.move>0?{type:"move",target:h}:o>=1&&e.currentActionPoints.action>0?{type:"attack",target:t.position}:{type:"end-turn"}}getCowardlyAction(e,t,n){if(Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y)<=2){const n=this.findRetreatPosition(e,t);if(n&&e.currentActionPoints.move>0)return{type:"move",target:n}}return t.health/t.maxHealth<.3&&e.currentActionPoints.action>0?{type:"attack",target:t.position}:{type:"end-turn"}}findPathToTarget(e,t){const n=[{x:e.position.x,y:e.position.y,g:0,h:0,f:0,parent:null}],i=new Set,s=new Map,a=new Map,r=new Map;for(a.set(`${e.position.x},${e.position.y}`,0),r.set(`${e.position.x},${e.position.y}`,this.heuristic(e.position,t.position));n.length>0;){n.sort((e,t)=>e.f-t.f);const o=n.shift(),l=`${o.x},${o.y}`;if(o.x===t.position.x&&o.y===t.position.y){const t=[];let n={x:o.x,y:o.y};for(;s.has(`${n.x},${n.y}`);)t.unshift(n),n=s.get(`${n.x},${n.y}`);return t.unshift({x:e.position.x,y:e.position.y}),t}i.add(l);const c=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const e of c){const c={x:o.x+e.dx,y:o.y+e.dy},h=`${c.x},${c.y}`;if(c.x<0||c.x>=this.state.battleMap.width||c.y<0||c.y>=this.state.battleMap.height||i.has(h))continue;const u=this.state.battleMap.tiles[c.y][c.x];if("wall"===u.type||u.occupied)continue;const d=a.get(l)+("difficult"===u.type?2:1);(!a.has(h)||d<a.get(h))&&(s.set(h,{x:o.x,y:o.y}),a.set(h,d),r.set(h,d+this.heuristic(c,t.position)),n.find(e=>e.x===c.x&&e.y===c.y)||n.push({x:c.x,y:c.y,g:d,h:this.heuristic(c,t.position),f:d+this.heuristic(c,t.position),parent:null}))}}return[{x:e.position.x,y:e.position.y}]}heuristic(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}findRetreatPosition(e,t){const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const i of n){const n=e.position.x+i.dx,s=e.position.y+i.dy;if(n>=0&&n<this.state.battleMap.width&&s>=0&&s<this.state.battleMap.height){const e=this.state.battleMap.tiles[s][n];if("wall"!==e.type&&!e.occupied&&Math.abs(n-t.position.x)+Math.abs(s-t.position.y)>1)return{x:n,y:s}}}return null}findTacticalPosition(e,t){const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];let i=null,s=-1/0;for(const a of n){const n=e.position.x+a.dx,r=e.position.y+a.dy;if(n<0||n>=this.state.battleMap.width||r<0||r>=this.state.battleMap.height)continue;const o=this.state.battleMap.tiles[r][n];if("wall"===o.type||o.occupied)continue;const l=2*o.cover+(o.elevation>this.state.battleMap.tiles[e.position.y][e.position.x].elevation?1:0)-(Math.abs(n-t.position.x)+Math.abs(r-t.position.y));l>s&&(s=l,i={x:n,y:r})}return i}getMovementTowardsPlayers(e){const t=this.state.combatants.filter(e=>"player"===e.type&&e.health>0);if(0===t.length)return{type:"end-turn"};const n=t.reduce((t,n)=>{const i=Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y);return Math.abs(n.position.x-e.position.x)+Math.abs(n.position.y-e.position.y)<i?n:t}),i=this.findPathToTarget(e,n);return i.length>1&&e.currentActionPoints.move>0?{type:"move",target:i[1],path:i}:{type:"end-turn"}}executeAttack(e,t){if(e.currentActionPoints.action<=0)return{success:!1,message:"No action points remaining"};if(!t.target||"string"==typeof t.target)return{success:!1,message:"Invalid attack target"};const n=t.target.x,i=t.target.y,s=this.state.combatants.find(t=>t.position.x===n&&t.position.y===i&&t.id!==e.id);if(!s)return{success:!1,message:"No target at specified position"};if(!this.calculateLineOfSight(e.position,s.position))return{success:!1,message:"Target not in line of sight"};if(Math.abs(n-e.position.x)+Math.abs(i-e.position.y)>e.reach)return{success:!1,message:"Target out of range"};const a=Math.floor(20*Math.random())+1,r=Math.floor((e.stats.strength-10)/2),o=this.calculateFlankingBonus(e,s);if(a+r+o>=s.stats.armorClass){const t=this.calculateDamage(e),n=this.state.combatants.map(e=>{if(e.id===s.id){const n=Math.max(0,e.health-t);return{...e,health:n}}return e});this.state.combatants=n;const i=o>0?" (flanking!)":"";this.addCombatLog(e.id,"attack",`${e.name} hit ${s.name} for ${t} damage${i}`),s.health-t<=0&&this.addCombatLog(s.id,"defeat",`${s.name} was defeated!`);const a=this.state.combatants.find(t=>t.id===e.id);return a&&a.currentActionPoints.action--,{success:!0,message:`${e.name} hit ${s.name} for ${t} damage${i}`,newState:this.getState()}}{this.addCombatLog(e.id,"attack",`${e.name} missed ${s.name}`);const t=this.state.combatants.find(t=>t.id===e.id);return t&&t.currentActionPoints.action--,{success:!0,message:`${e.name} missed ${s.name}`,newState:this.getState()}}}executeSkill(e,t){if(e.currentActionPoints.action<=0)return{success:!1,message:"No action points remaining"};if(!t.skillId)return{success:!1,message:"No skill specified"};const n=e.skills[t.skillId];if(!n)return{success:!1,message:"Skill not found"};this.addCombatLog(e.id,"skill",`${e.name} used ${n.name}`);const i=this.state.combatants.find(t=>t.id===e.id);return i&&i.currentActionPoints.action--,{success:!0,message:`${e.name} used ${n.name}`,newState:this.getState()}}endTurn(){var e;const t=this.getActiveCombatant();if(!t)return{success:!1,message:"No active combatant"};const n=this.state.combatants.map(e=>e.id===t.id?{...e,hasActed:!0}:e);return this.state.combatants=n,this.addCombatLog(t.id,"end-turn",`${t.name} ended their turn`),this.state.currentCombatantIndex=(this.state.currentCombatantIndex+1)%this.state.turnOrder.length,0===this.state.currentCombatantIndex&&(this.state.round++,this.startNewRound()),this.setActiveCombatant(this.state.currentCombatantIndex),{success:!0,message:`Turn ended. Next: ${(null==(e=this.getActiveCombatant())?void 0:e.name)||"Unknown"}`,newState:this.getState()}}startNewRound(){this.state.combatants=this.state.combatants.map(e=>({...e,currentActionPoints:{...e.actionPoints},hasActed:!1})),this.addCombatLog("system","round",`Round ${this.state.round} begins!`)}setActiveCombatant(e){this.state.combatants=this.state.combatants.map(e=>({...e,isActive:!1}));const t=this.state.turnOrder[e],n=this.state.combatants.find(e=>e.id===t);n&&(n.isActive=!0)}calculateDamage(e){const t=Math.floor((e.stats.strength-10)/2);return Math.max(1,Math.floor(6*Math.random())+1+t)}addCombatLog(e,t,n){const i={id:Date.now().toString(),turn:this.state.currentTurn,combatantId:e,action:t,result:n,timestamp:Date.now()};this.state.combatLog.push(i)}endCombat(){return this.state.isActive=!1,this.getState()}checkCombatEnd(){const e=this.state.combatants.filter(e=>"player"===e.type),t=this.state.combatants.filter(e=>"enemy"===e.type),n=e.filter(e=>e.health>0),i=t.filter(e=>e.health>0);return 0===n.length?{ended:!0,winner:"enemies"}:0===i.length?{ended:!0,winner:"players"}:{ended:!1}}executeAITurn(){const e=this.getActiveCombatant();if(!e||"enemy"!==e.type)return{success:!1,message:"No enemy combatant active"};const t=this.getEnemyAIAction(e);return t?this.executeAction(t):this.endTurn()}}const nl=({onOpenAuth:e})=>ft.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-900 to-black text-white flex flex-col items-center justify-center font-inter",children:[ft.jsxs("section",{className:"relative w-full py-20 px-4 text-center overflow-hidden",children:[ft.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-900/30 to-blue-900/30 opacity-70 animate-pulse-slow"}),ft.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-transparent via-transparent to-black"}),ft.jsxs("div",{className:"relative z-10 max-w-4xl mx-auto",children:[ft.jsx("h1",{className:"text-5xl md:text-7xl font-extrabold mb-6 leading-tight tracking-tighter drop-shadow-lg animate-fade-in-up",children:"MythSeeker: Your Epic Adventures Await"}),ft.jsx("p",{className:"text-xl md:text-2xl text-gray-300 mb-10 leading-relaxed animate-fade-in-up delay-200",children:"Unleash limitless stories with an AI Dungeon Master, dynamic worlds, and seamless multiplayer."}),ft.jsx("button",{onClick:e,className:"px-10 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xl font-bold rounded-full shadow-lg hover:from-purple-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 animate-bounce-in",children:"Start Your Adventure Now"})]})]}),ft.jsx("section",{className:"w-full py-16 px-4 bg-gray-950/70 backdrop-blur-sm border-t border-b border-gray-800",children:ft.jsxs("div",{className:"max-w-6xl mx-auto",children:[ft.jsx("h2",{className:"text-4xl font-bold text-center mb-12 text-purple-300 drop-shadow-md animate-fade-in",children:"Why Choose MythSeeker?"}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10",children:[ft.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-300",children:[ft.jsx("div",{className:"text-purple-400 mb-4 flex justify-center",children:ft.jsx(xe,{size:48})}),ft.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"AI Dungeon Master"}),ft.jsx("p",{className:"text-gray-300 text-center",children:"Experience dynamic, adaptive storytelling tailored to your choices. No two campaigns are ever the same!"})]}),ft.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-400",children:[ft.jsx("div",{className:"text-blue-400 mb-4 flex justify-center",children:ft.jsx(re,{size:48})}),ft.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Seamless Multiplayer"}),ft.jsx("p",{className:"text-gray-300 text-center",children:"Play with friends in real-time. Share your epic quests and overcome challenges together."})]}),ft.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-500",children:[ft.jsx("div",{className:"text-green-400 mb-4 flex justify-center",children:ft.jsx(be,{size:48})}),ft.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Living Worlds"}),ft.jsx("p",{className:"text-gray-300 text-center",children:"Explore vast, evolving worlds where your actions have lasting consequences."})]}),ft.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-600",children:[ft.jsx("div",{className:"text-red-400 mb-4 flex justify-center",children:ft.jsx(_e,{size:48})}),ft.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Engaging Combat"}),ft.jsx("p",{className:"text-gray-300 text-center",children:"Dive into tactical turn-based combat with dynamic environments and challenging foes."})]}),ft.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-700",children:[ft.jsx("div",{className:"text-yellow-400 mb-4 flex justify-center",children:ft.jsx(we,{size:48})}),ft.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Rich Lore & Quests"}),ft.jsx("p",{className:"text-gray-300 text-center",children:"Uncover deep lore and embark on procedurally generated quests that keep you on the edge of your seat."})]}),ft.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-800",children:[ft.jsx("div",{className:"text-cyan-400 mb-4 flex justify-center",children:ft.jsx(Se,{size:48})}),ft.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Campaign Log"}),ft.jsx("p",{className:"text-gray-300 text-center",children:"Keep track of your adventures, character progress, and world events with an intuitive campaign log."})]})]})]})}),ft.jsx("section",{className:"w-full py-20 px-4 text-center bg-gray-900",children:ft.jsxs("div",{className:"max-w-3xl mx-auto",children:[ft.jsx("h2",{className:"text-4xl font-bold mb-6 text-indigo-300 drop-shadow-md animate-fade-in",children:"Ready to Forge Your Legend?"}),ft.jsx("p",{className:"text-xl text-gray-300 mb-10 animate-fade-in delay-200",children:"Join thousands of adventurers already exploring endless possibilities in MythSeeker."}),ft.jsx("button",{onClick:e,className:"px-12 py-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-2xl font-bold rounded-full shadow-xl hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-300 animate-bounce-in delay-300",children:"Play Free Now"})]})}),ft.jsxs("footer",{className:"w-full py-8 px-4 bg-black text-gray-500 text-center text-sm",children:[ft.jsxs("p",{children:["© ",(new Date).getFullYear()," MythSeeker. All rights reserved."]}),ft.jsxs("div",{className:"mt-2 space-x-4",children:[ft.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Privacy Policy"}),ft.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Terms of Service"}),ft.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Contact Us"})]})]}),ft.jsx("style",{dangerouslySetInnerHTML:{__html:"\n            @keyframes fadeIn {\n              from { opacity: 0; }\n              to { opacity: 1; }\n            }\n            @keyframes fadeInUp {\n              from { opacity: 0; transform: translateY(20px); }\n              to { opacity: 1; transform: translateY(0); }\n            }\n            @keyframes bounceIn {\n              0%, 20%, 40%, 60%, 80%, 100% {\n                transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);\n              }\n              0% {\n                opacity: 0;\n                transform: scale3d(0.3, 0.3, 0.3);\n              }\n              20% {\n                transform: scale3d(1.1, 1.1, 1.1);\n              }\n              40% {\n                transform: scale3d(0.9, 0.9, 0.9);\n              }\n              60% {\n                opacity: 1;\n                transform: scale3d(1.03, 1.03, 1.03);\n              }\n              80% {\n                transform: scale3d(0.97, 0.97, 0.97);\n              }\n              100% {\n                opacity: 1;\n                transform: scale3d(1, 1, 1);\n              }\n            }\n            @keyframes pulseSlow {\n              0%, 100% { opacity: 0.7; }\n              50% { opacity: 0.9; }\n            }\n            .animate-fade-in { animation: fadeIn 1s ease-out forwards; }\n            .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }\n            .animate-fade-in-up.delay-200 { animation-delay: 0.2s; }\n            .animate-bounce-in { animation: bounceIn 1s; }\n            .animate-bounce-in.delay-300 { animation-delay: 0.3s; }\n            .animate-pulse-slow { animation: pulseSlow 4s infinite alternate; }\n          "}})]}),il=({user:e,campaigns:t,characters:i,onNavigate:s,onCreateCampaign:a,onCreateCharacter:r,onJoinCampaign:o,onResumeCampaign:l,onOpenDiceRoller:c,onOpenProfile:h,onOpenSettings:u,onOpenAchievements:d,onOpenHelp:p})=>{const[m,f]=n.useState([]),[g,v]=n.useState([]),[x,y]=n.useState({totalPlayTime:"0h 0m",campaignsCompleted:0,charactersCreated:0,diceRolls:0,achievements:0});n.useEffect(()=>{f(t.filter(e=>"active"===e.status||"waiting"===e.status)),v([{type:"campaign_joined",title:'Joined "Lost Mines"',time:"2 hours ago",icon:ft.jsx(Me,{className:"w-4 h-4"})},{type:"character_created",title:'Created "Thorin Stonefist"',time:"1 day ago",icon:ft.jsx(Te,{className:"w-4 h-4"})},{type:"achievement",title:'Unlocked "First Steps"',time:"2 days ago",icon:ft.jsx(le,{className:"w-4 h-4"})},{type:"dice_roll",title:"Rolled 20 on d20!",time:"3 days ago",icon:ft.jsx(ce,{className:"w-4 h-4"})}])},[t]);const b=[{id:"resume",title:"Resume Adventure",description:"Continue your latest campaign",icon:ft.jsx(Ee,{className:"w-6 h-6"}),action:()=>{m.length>0?l(m[0].id):a()},color:"from-emerald-500 to-teal-600",gradient:"bg-gradient-to-r from-emerald-500 to-teal-600",badge:m.length>0?`${m.length} Active`:void 0},{id:"ai-games",title:"AI Adventures",description:"Start an AI-powered game",icon:ft.jsx(Ce,{className:"w-6 h-6"}),action:()=>s("/automated-games"),color:"from-cyan-500 to-blue-600",gradient:"bg-gradient-to-r from-cyan-500 to-blue-600"},{id:"new-campaign",title:"New Campaign",description:"Start a fresh adventure",icon:ft.jsx(Ne,{className:"w-6 h-6"}),action:a,color:"from-blue-500 to-indigo-600",gradient:"bg-gradient-to-r from-blue-500 to-indigo-600"},{id:"join-campaign",title:"Join Campaign",description:"Enter with a friend's code",icon:ft.jsx(re,{className:"w-6 h-6"}),action:o,color:"from-purple-500 to-pink-600",gradient:"bg-gradient-to-r from-purple-500 to-pink-600"}],_=[{id:"campaigns",title:"Campaigns",description:"Manage your adventures",icon:ft.jsx(Me,{className:"w-8 h-8"}),path:"/campaigns",color:"from-blue-500 to-indigo-600",gradient:"bg-gradient-to-br from-blue-500 to-indigo-600",stats:[{label:"Active",value:m.length},{label:"Total",value:t.length}]},{id:"characters",title:"Characters",description:"Your heroes and companions",icon:ft.jsx(Te,{className:"w-8 h-8"}),path:"/characters",color:"from-green-500 to-emerald-600",gradient:"bg-gradient-to-br from-green-500 to-emerald-600",stats:[{label:"Created",value:i.length},{label:"Active",value:i.filter(e=>e.isActive).length}]},{id:"party",title:"Party",description:"Team up with friends",icon:ft.jsx(re,{className:"w-8 h-8"}),path:"/party",color:"from-purple-500 to-pink-600",gradient:"bg-gradient-to-br from-purple-500 to-pink-600",stats:[{label:"Members",value:"3-6"},{label:"Online",value:"2"}]},{id:"world",title:"World",description:"Explore the realm",icon:ft.jsx(be,{className:"w-8 h-8"}),path:"/world",color:"from-teal-500 to-cyan-600",gradient:"bg-gradient-to-br from-teal-500 to-cyan-600",stats:[{label:"Locations",value:"12"},{label:"Discovered",value:"8"}]},{id:"combat",title:"Combat",description:"Battle system & tactics",icon:ft.jsx(ue,{className:"w-8 h-8"}),path:"/combat",color:"from-red-500 to-pink-600",gradient:"bg-gradient-to-br from-red-500 to-pink-600",stats:[{label:"Encounters",value:"5"},{label:"Victories",value:"4"}]},{id:"magic",title:"Magic",description:"Spells & abilities",icon:ft.jsx(_e,{className:"w-8 h-8"}),path:"/magic",color:"from-indigo-500 to-purple-600",gradient:"bg-gradient-to-br from-indigo-500 to-purple-600",stats:[{label:"Spells",value:"24"},{label:"Prepared",value:"8"}]},{id:"automated-games",title:"AI Games",description:"AI-powered adventures",icon:ft.jsx(Ce,{className:"w-8 h-8"}),path:"/automated-games",color:"from-cyan-500 to-blue-600",gradient:"bg-gradient-to-br from-cyan-500 to-blue-600",isNew:!0,stats:[{label:"Active",value:"2"},{label:"Saved",value:"5"}]},{id:"dm-center",title:"DM Center",description:"Dungeon Master tools",icon:ft.jsx(Ae,{className:"w-8 h-8"}),path:"/dm-center",color:"from-yellow-500 to-orange-600",gradient:"bg-gradient-to-br from-yellow-500 to-orange-600",isNew:!0},{id:"achievements",title:"Achievements",description:"Track your progress",icon:ft.jsx(le,{className:"w-8 h-8"}),path:"/achievements",color:"from-amber-500 to-yellow-600",gradient:"bg-gradient-to-br from-amber-500 to-yellow-600",stats:[{label:"Unlocked",value:x.achievements},{label:"Total",value:"50"}]}];return ft.jsxs("div",{className:"h-full overflow-y-auto bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 text-white",children:[ft.jsxs("div",{className:"relative overflow-hidden",children:[ft.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-600/20 to-purple-600/20"}),ft.jsx("div",{className:"relative px-6 py-8",children:ft.jsxs("div",{className:"max-w-7xl mx-auto",children:[ft.jsxs("div",{className:"mb-8",children:[ft.jsxs("h1",{className:"text-4xl font-bold mb-2",children:[(()=>{const e=(new Date).getHours();return e<12?"Good morning":e<17?"Good afternoon":"Good evening"})(),", ",(null==e?void 0:e.displayName)||"Adventurer","! 👋"]}),ft.jsx("p",{className:"text-blue-200 text-lg",children:"Ready for your next epic adventure?"})]}),ft.jsxs("div",{className:"mb-8",children:[ft.jsxs("h2",{className:"text-2xl font-semibold mb-4 flex items-center",children:[ft.jsx(ve,{className:"w-6 h-6 mr-2 text-yellow-400"}),"Quick Actions"]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:b.map(e=>ft.jsxs("button",{onClick:e.action,className:`relative group p-6 rounded-xl ${e.gradient} hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl`,children:[ft.jsxs("div",{className:"flex items-center justify-between mb-3",children:[ft.jsx("div",{className:"p-2 bg-white/20 rounded-lg",children:e.icon}),e.badge&&ft.jsx("span",{className:"px-2 py-1 bg-white/20 rounded-full text-xs font-medium",children:e.badge})]}),ft.jsx("h3",{className:"font-semibold text-lg mb-1",children:e.title}),ft.jsx("p",{className:"text-white/80 text-sm",children:e.description}),ft.jsx(Re,{className:"w-4 h-4 absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity"})]},e.id))})]})]})})]}),ft.jsx("div",{className:"px-6 pb-8",children:ft.jsx("div",{className:"max-w-7xl mx-auto",children:ft.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[ft.jsxs("div",{className:"lg:col-span-2",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-6",children:[ft.jsxs("h2",{className:"text-2xl font-semibold flex items-center",children:[ft.jsx(je,{className:"w-6 h-6 mr-2 text-blue-400"}),"Game Features"]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("button",{className:"p-2 hover:bg-white/10 rounded-lg transition-colors",children:ft.jsx(Pe,{className:"w-4 h-4"})}),ft.jsx("button",{className:"p-2 hover:bg-white/10 rounded-lg transition-colors",children:ft.jsx(Ie,{className:"w-4 h-4"})})]})]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:_.map(e=>ft.jsxs("button",{onClick:()=>s(e.path),className:"group relative p-6 rounded-xl bg-slate-800/50 hover:bg-slate-800/70 transition-all duration-200 border border-slate-700/50 hover:border-slate-600/50",children:[e.isNew&&ft.jsx("span",{className:"absolute -top-2 -right-2 px-2 py-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs font-medium",children:"NEW"}),ft.jsxs("div",{className:"flex items-start justify-between mb-4",children:[ft.jsx("div",{className:`p-3 rounded-lg ${e.gradient}`,children:e.icon}),ft.jsx(De,{className:"w-5 h-5 text-slate-400 group-hover:text-white transition-colors"})]}),ft.jsx("h3",{className:"font-semibold text-lg mb-2 text-left",children:e.title}),ft.jsx("p",{className:"text-slate-300 text-sm mb-4 text-left",children:e.description}),e.stats&&ft.jsx("div",{className:"flex space-x-4",children:e.stats.map((e,t)=>ft.jsxs("div",{className:"text-left",children:[ft.jsx("div",{className:"text-lg font-semibold text-white",children:e.value}),ft.jsx("div",{className:"text-xs text-slate-400",children:e.label})]},t))})]},e.id))})]}),ft.jsxs("div",{className:"space-y-6",children:[ft.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[ft.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[ft.jsx(Ee,{className:"w-5 h-5 mr-2 text-green-400"}),"Active Campaigns"]}),0===m.length?ft.jsxs("div",{className:"text-center py-4",children:[ft.jsx(Me,{className:"w-8 h-8 text-slate-400 mx-auto mb-2"}),ft.jsx("p",{className:"text-slate-300 text-sm mb-3",children:"No active campaigns"}),ft.jsx("button",{onClick:a,className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors",children:"Create Campaign"})]}):ft.jsxs("div",{className:"space-y-3",children:[m.slice(0,3).map(e=>ft.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/30 rounded-lg",children:[ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsx("h4",{className:"font-medium text-sm truncate",children:e.name}),ft.jsx("p",{className:"text-xs text-slate-400",children:e.theme})]}),ft.jsx("button",{onClick:()=>l(e.id),className:"ml-2 p-1.5 bg-green-600 hover:bg-green-700 rounded text-white transition-colors",children:ft.jsx(Ee,{className:"w-3 h-3"})})]},e.id)),m.length>3&&ft.jsxs("button",{onClick:()=>s("/campaigns"),className:"w-full text-center text-sm text-blue-400 hover:text-blue-300 transition-colors",children:["View all ",m.length," campaigns"]})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[ft.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[ft.jsx(oe,{className:"w-5 h-5 mr-2 text-orange-400"}),"Recent Activity"]}),ft.jsx("div",{className:"space-y-3",children:g.map((e,t)=>ft.jsxs("div",{className:"flex items-start space-x-3",children:[ft.jsx("div",{className:"p-1.5 bg-slate-700/50 rounded-lg",children:e.icon}),ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsx("p",{className:"text-sm font-medium truncate",children:e.title}),ft.jsx("p",{className:"text-xs text-slate-400",children:e.time})]})]},t))})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[ft.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[ft.jsx(ke,{className:"w-5 h-5 mr-2 text-slate-400"}),"Quick Settings"]}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsxs("button",{onClick:c,className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(ce,{className:"w-4 h-4 text-green-400"}),ft.jsx("span",{className:"text-sm",children:"Dice Roller"})]}),ft.jsx(De,{className:"w-4 h-4 text-slate-400"})]}),ft.jsxs("button",{onClick:h,className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(Te,{className:"w-4 h-4 text-blue-400"}),ft.jsx("span",{className:"text-sm",children:"Profile"})]}),ft.jsx(De,{className:"w-4 h-4 text-slate-400"})]}),ft.jsxs("button",{onClick:d,className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(le,{className:"w-4 h-4 text-yellow-400"}),ft.jsx("span",{className:"text-sm",children:"Achievements"})]}),ft.jsx(De,{className:"w-4 h-4 text-slate-400"})]})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[ft.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[ft.jsx(Le,{className:"w-5 h-5 mr-2 text-purple-400"}),"Your Stats"]}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(oe,{className:"w-4 h-4 text-blue-400"}),ft.jsx("span",{className:"text-sm",children:"Play Time"})]}),ft.jsx("span",{className:"font-semibold",children:x.totalPlayTime})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(le,{className:"w-4 h-4 text-yellow-400"}),ft.jsx("span",{className:"text-sm",children:"Achievements"})]}),ft.jsxs("span",{className:"font-semibold",children:[x.achievements,"/50"]})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(ce,{className:"w-4 h-4 text-green-400"}),ft.jsx("span",{className:"text-sm",children:"Dice Rolls"})]}),ft.jsx("span",{className:"font-semibold",children:x.diceRolls})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(Me,{className:"w-4 h-4 text-purple-400"}),ft.jsx("span",{className:"text-sm",children:"Campaigns"})]}),ft.jsx("span",{className:"font-semibold",children:x.campaignsCompleted})]})]})]})]})]})})})]})},sl="178",al=0,rl=1,ol=2,ll=100,cl=101,hl=102,ul=200,dl=201,pl=202,ml=203,fl=204,gl=205,vl=206,xl=207,yl=208,bl=209,_l=210,wl=211,Sl=212,Ml=213,Tl=214,El=0,Cl=1,Nl=2,Al=3,Rl=4,jl=5,Pl=6,Il=7,Dl=301,kl=302,Ll=306,Ol=1e3,Ul=1001,Fl=1002,zl=1003,Bl=1004,Vl=1005,Hl=1006,Wl=1007,Gl=1008,ql=1009,$l=1012,Xl=1013,Yl=1014,Kl=1015,Zl=1016,Jl=1017,Ql=1018,ec=1020,tc=1023,nc=1026,ic=1027,sc=1029,ac=1031,rc=1033,oc=33776,lc=33777,cc=33778,hc=33779,uc=35840,dc=35841,pc=35842,mc=35843,fc=36196,gc=37492,vc=37496,xc=37808,yc=37809,bc=37810,_c=37811,wc=37812,Sc=37813,Mc=37814,Tc=37815,Ec=37816,Cc=37817,Nc=37818,Ac=37819,Rc=37820,jc=37821,Pc=36492,Ic=36494,Dc=36495,kc=36284,Lc=36285,Oc=36286,Uc="",Fc="srgb",zc="srgb-linear",Bc="linear",Vc="srgb",Hc=7680,Wc=512,Gc=513,qc=514,$c=515,Xc=516,Yc=517,Kc=518,Zc=519,Jc="300 es",Qc=2e3,eh=2001;class th{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){const n=this._listeners;return void 0!==n&&void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){const n=this._listeners;if(void 0===n)return;const i=n[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const n=t[e.type];if(void 0!==n){e.target=this;const t=n.slice(0);for(let n=0,i=t.length;n<i;n++)t[n].call(this,e);e.target=null}}}const nh=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],ih=Math.PI/180,sh=180/Math.PI;function ah(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(nh[255&e]+nh[e>>8&255]+nh[e>>16&255]+nh[e>>24&255]+"-"+nh[255&t]+nh[t>>8&255]+"-"+nh[t>>16&15|64]+nh[t>>24&255]+"-"+nh[63&n|128]+nh[n>>8&255]+"-"+nh[n>>16&255]+nh[n>>24&255]+nh[255&i]+nh[i>>8&255]+nh[i>>16&255]+nh[i>>24&255]).toLowerCase()}function rh(e,t,n){return Math.max(t,Math.min(n,e))}function oh(e,t,n){return(1-n)*e+n*t}function lh(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function ch(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const hh=ih;class uh{constructor(e=0,t=0){uh.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6],this.y=i[1]*t+i[4]*n+i[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=rh(this.x,e.x,t.x),this.y=rh(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=rh(this.x,e,t),this.y=rh(this.y,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(rh(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(rh(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),i=Math.sin(t),s=this.x-e.x,a=this.y-e.y;return this.x=s*n-a*i+e.x,this.y=s*i+a*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class dh{constructor(e=0,t=0,n=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=i}static slerpFlat(e,t,n,i,s,a,r){let o=n[i+0],l=n[i+1],c=n[i+2],h=n[i+3];const u=s[a+0],d=s[a+1],p=s[a+2],m=s[a+3];if(0===r)return e[t+0]=o,e[t+1]=l,e[t+2]=c,void(e[t+3]=h);if(1===r)return e[t+0]=u,e[t+1]=d,e[t+2]=p,void(e[t+3]=m);if(h!==m||o!==u||l!==d||c!==p){let e=1-r;const t=o*u+l*d+c*p+h*m,n=t>=0?1:-1,i=1-t*t;if(i>Number.EPSILON){const s=Math.sqrt(i),a=Math.atan2(s,t*n);e=Math.sin(e*a)/s,r=Math.sin(r*a)/s}const s=r*n;if(o=o*e+u*s,l=l*e+d*s,c=c*e+p*s,h=h*e+m*s,e===1-r){const e=1/Math.sqrt(o*o+l*l+c*c+h*h);o*=e,l*=e,c*=e,h*=e}}e[t]=o,e[t+1]=l,e[t+2]=c,e[t+3]=h}static multiplyQuaternionsFlat(e,t,n,i,s,a){const r=n[i],o=n[i+1],l=n[i+2],c=n[i+3],h=s[a],u=s[a+1],d=s[a+2],p=s[a+3];return e[t]=r*p+c*h+o*d-l*u,e[t+1]=o*p+c*u+l*h-r*d,e[t+2]=l*p+c*d+r*u-o*h,e[t+3]=c*p-r*h-o*u-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,i=e._y,s=e._z,a=e._order,r=Math.cos,o=Math.sin,l=r(n/2),c=r(i/2),h=r(s/2),u=o(n/2),d=o(i/2),p=o(s/2);switch(a){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],i=t[4],s=t[8],a=t[1],r=t[5],o=t[9],l=t[2],c=t[6],h=t[10],u=n+r+h;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(c-o)*e,this._y=(s-l)*e,this._z=(a-i)*e}else if(n>r&&n>h){const e=2*Math.sqrt(1+n-r-h);this._w=(c-o)/e,this._x=.25*e,this._y=(i+a)/e,this._z=(s+l)/e}else if(r>h){const e=2*Math.sqrt(1+r-n-h);this._w=(s-l)/e,this._x=(i+a)/e,this._y=.25*e,this._z=(o+c)/e}else{const e=2*Math.sqrt(1+h-n-r);this._w=(a-i)/e,this._x=(s+l)/e,this._y=(o+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<1e-8?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(rh(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const i=Math.min(1,t/n);return this.slerp(e,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,i=e._y,s=e._z,a=e._w,r=t._x,o=t._y,l=t._z,c=t._w;return this._x=n*c+a*r+i*l-s*o,this._y=i*c+a*o+s*r-n*l,this._z=s*c+a*l+n*o-i*r,this._w=a*c-n*r-i*o-s*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,i=this._y,s=this._z,a=this._w;let r=a*e._w+n*e._x+i*e._y+s*e._z;if(r<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,r=-r):this.copy(e),r>=1)return this._w=a,this._x=n,this._y=i,this._z=s,this;const o=1-r*r;if(o<=Number.EPSILON){const e=1-t;return this._w=e*a+t*this._w,this._x=e*n+t*this._x,this._y=e*i+t*this._y,this._z=e*s+t*this._z,this.normalize(),this}const l=Math.sqrt(o),c=Math.atan2(l,r),h=Math.sin((1-t)*c)/l,u=Math.sin(t*c)/l;return this._w=a*h+this._w*u,this._x=n*h+this._x*u,this._y=i*h+this._y*u,this._z=s*h+this._z*u,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),i=Math.sqrt(1-n),s=Math.sqrt(n);return this.set(i*Math.sin(e),i*Math.cos(e),s*Math.sin(t),s*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class ph{constructor(e=0,t=0,n=0){ph.prototype.isVector3=!0,this.x=e,this.y=t,this.z=n}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(fh.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(fh.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,i=this.z,s=e.elements;return this.x=s[0]*t+s[3]*n+s[6]*i,this.y=s[1]*t+s[4]*n+s[7]*i,this.z=s[2]*t+s[5]*n+s[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,s=e.elements,a=1/(s[3]*t+s[7]*n+s[11]*i+s[15]);return this.x=(s[0]*t+s[4]*n+s[8]*i+s[12])*a,this.y=(s[1]*t+s[5]*n+s[9]*i+s[13])*a,this.z=(s[2]*t+s[6]*n+s[10]*i+s[14])*a,this}applyQuaternion(e){const t=this.x,n=this.y,i=this.z,s=e.x,a=e.y,r=e.z,o=e.w,l=2*(a*i-r*n),c=2*(r*t-s*i),h=2*(s*n-a*t);return this.x=t+o*l+a*h-r*c,this.y=n+o*c+r*l-s*h,this.z=i+o*h+s*c-a*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,i=this.z,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*i,this.y=s[1]*t+s[5]*n+s[9]*i,this.z=s[2]*t+s[6]*n+s[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=rh(this.x,e.x,t.x),this.y=rh(this.y,e.y,t.y),this.z=rh(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=rh(this.x,e,t),this.y=rh(this.y,e,t),this.z=rh(this.z,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(rh(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,s=e.z,a=t.x,r=t.y,o=t.z;return this.x=i*o-s*r,this.y=s*a-n*o,this.z=n*r-i*a,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return mh.copy(this).projectOnVector(e),this.sub(mh)}reflect(e){return this.sub(mh.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(rh(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const i=Math.sin(t)*e;return this.x=i*Math.sin(n),this.y=Math.cos(t)*e,this.z=i*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=i,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const mh=new ph,fh=new dh;class gh{constructor(e,t,n,i,s,a,r,o,l){gh.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,n,i,s,a,r,o,l)}set(e,t,n,i,s,a,r,o,l){const c=this.elements;return c[0]=e,c[1]=i,c[2]=r,c[3]=t,c[4]=s,c[5]=o,c[6]=n,c[7]=a,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,s=this.elements,a=n[0],r=n[3],o=n[6],l=n[1],c=n[4],h=n[7],u=n[2],d=n[5],p=n[8],m=i[0],f=i[3],g=i[6],v=i[1],x=i[4],y=i[7],b=i[2],_=i[5],w=i[8];return s[0]=a*m+r*v+o*b,s[3]=a*f+r*x+o*_,s[6]=a*g+r*y+o*w,s[1]=l*m+c*v+h*b,s[4]=l*f+c*x+h*_,s[7]=l*g+c*y+h*w,s[2]=u*m+d*v+p*b,s[5]=u*f+d*x+p*_,s[8]=u*g+d*y+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],i=e[2],s=e[3],a=e[4],r=e[5],o=e[6],l=e[7],c=e[8];return t*a*c-t*r*l-n*s*c+n*r*o+i*s*l-i*a*o}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],s=e[3],a=e[4],r=e[5],o=e[6],l=e[7],c=e[8],h=c*a-r*l,u=r*o-c*s,d=l*s-a*o,p=t*h+n*u+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return e[0]=h*m,e[1]=(i*l-c*n)*m,e[2]=(r*n-i*a)*m,e[3]=u*m,e[4]=(c*t-i*o)*m,e[5]=(i*s-r*t)*m,e[6]=d*m,e[7]=(n*o-l*t)*m,e[8]=(a*t-n*s)*m,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,i,s,a,r){const o=Math.cos(s),l=Math.sin(s);return this.set(n*o,n*l,-n*(o*a+l*r)+a+e,-i*l,i*o,-i*(-l*a+o*r)+r+t,0,0,1),this}scale(e,t){return this.premultiply(vh.makeScale(e,t)),this}rotate(e){return this.premultiply(vh.makeRotation(-e)),this}translate(e,t){return this.premultiply(vh.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let i=0;i<9;i++)if(t[i]!==n[i])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const vh=new gh;function xh(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function yh(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function bh(){const e=yh("canvas");return e.style.display="block",e}const _h={};function wh(e){e in _h||(_h[e]=!0)}const Sh=(new gh).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),Mh=(new gh).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function Th(){const e={enabled:!0,workingColorSpace:zc,spaces:{},convert:function(e,t,n){return!1!==this.enabled&&t!==n&&t&&n?(this.spaces[t].transfer===Vc&&(e.r=Ch(e.r),e.g=Ch(e.g),e.b=Ch(e.b)),this.spaces[t].primaries!==this.spaces[n].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[n].fromXYZ)),this.spaces[n].transfer===Vc&&(e.r=Nh(e.r),e.g=Nh(e.g),e.b=Nh(e.b)),e):e},workingToColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},colorSpaceToWorking:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===Uc?Bc:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,n){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[n].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(t,n){return wh("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),e.workingToColorSpace(t,n)},toWorkingColorSpace:function(t,n){return wh("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),e.colorSpaceToWorking(t,n)}},t=[.64,.33,.3,.6,.15,.06],n=[.2126,.7152,.0722],i=[.3127,.329];return e.define({[zc]:{primaries:t,whitePoint:i,transfer:Bc,toXYZ:Sh,fromXYZ:Mh,luminanceCoefficients:n,workingColorSpaceConfig:{unpackColorSpace:Fc},outputColorSpaceConfig:{drawingBufferColorSpace:Fc}},[Fc]:{primaries:t,whitePoint:i,transfer:Vc,toXYZ:Sh,fromXYZ:Mh,luminanceCoefficients:n,outputColorSpaceConfig:{drawingBufferColorSpace:Fc}}}),e}const Eh=Th();function Ch(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Nh(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let Ah;class Rh{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let n;if(e instanceof HTMLCanvasElement)n=e;else{void 0===Ah&&(Ah=yh("canvas")),Ah.width=e.width,Ah.height=e.height;const t=Ah.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),n=Ah}return n.toDataURL(t)}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=yh("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height),s=i.data;for(let e=0;e<s.length;e++)s[e]=255*Ch(s[e]/255);return n.putImageData(i,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*Ch(t[e]/255)):t[e]=Ch(t[e]);return{data:t,width:e.width,height:e.height}}return e}}let jh=0,Ph=class{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:jh++}),this.uuid=ah(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight):null!==t?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},i=this.data;if(null!==i){let e;if(Array.isArray(i)){e=[];for(let t=0,n=i.length;t<n;t++)i[t].isDataTexture?e.push(Ih(i[t].image)):e.push(Ih(i[t]))}else e=Ih(i);n.url=e}return t||(e.images[this.uuid]=n),n}};function Ih(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?Rh.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:{}}let Dh=0;const kh=new ph;class Lh extends th{constructor(e=Lh.DEFAULT_IMAGE,t=Lh.DEFAULT_MAPPING,n=1001,i=1001,s=1006,a=1008,r=1023,o=1009,l=Lh.DEFAULT_ANISOTROPY,c=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Dh++}),this.uuid=ah(),this.name="",this.source=new Ph(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=n,this.wrapT=i,this.magFilter=s,this.minFilter=a,this.anisotropy=l,this.format=r,this.internalFormat=null,this.type=o,this.offset=new uh(0,0),this.repeat=new uh(1,1),this.center=new uh(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new gh,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(kh).x}get height(){return this.source.getSize(kh).y}get depth(){return this.source.getSize(kh).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const n=e[t];if(void 0===n)continue;const i=this[t];void 0!==i&&(i&&n&&i.isVector2&&n.isVector2||i&&n&&i.isVector3&&n.isVector3||i&&n&&i.isMatrix3&&n.isMatrix3?i.copy(n):this[t]=n)}}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Ol:e.x=e.x-Math.floor(e.x);break;case Ul:e.x=e.x<0?0:1;break;case Fl:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case Ol:e.y=e.y-Math.floor(e.y);break;case Ul:e.y=e.y<0?0:1;break;case Fl:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}Lh.DEFAULT_IMAGE=null,Lh.DEFAULT_MAPPING=300,Lh.DEFAULT_ANISOTROPY=1;class Oh{constructor(e=0,t=0,n=0,i=1){Oh.prototype.isVector4=!0,this.x=e,this.y=t,this.z=n,this.w=i}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,s=this.w,a=e.elements;return this.x=a[0]*t+a[4]*n+a[8]*i+a[12]*s,this.y=a[1]*t+a[5]*n+a[9]*i+a[13]*s,this.z=a[2]*t+a[6]*n+a[10]*i+a[14]*s,this.w=a[3]*t+a[7]*n+a[11]*i+a[15]*s,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,i,s;const a=.01,r=.1,o=e.elements,l=o[0],c=o[4],h=o[8],u=o[1],d=o[5],p=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(c-u)<a&&Math.abs(h-m)<a&&Math.abs(p-f)<a){if(Math.abs(c+u)<r&&Math.abs(h+m)<r&&Math.abs(p+f)<r&&Math.abs(l+d+g-3)<r)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(d+1)/2,v=(g+1)/2,x=(c+u)/4,y=(h+m)/4,b=(p+f)/4;return e>o&&e>v?e<a?(n=0,i=.707106781,s=.707106781):(n=Math.sqrt(e),i=x/n,s=y/n):o>v?o<a?(n=.707106781,i=0,s=.707106781):(i=Math.sqrt(o),n=x/i,s=b/i):v<a?(n=.707106781,i=.707106781,s=0):(s=Math.sqrt(v),n=y/s,i=b/s),this.set(n,i,s,t),this}let v=Math.sqrt((f-p)*(f-p)+(h-m)*(h-m)+(u-c)*(u-c));return Math.abs(v)<.001&&(v=1),this.x=(f-p)/v,this.y=(h-m)/v,this.z=(u-c)/v,this.w=Math.acos((l+d+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=rh(this.x,e.x,t.x),this.y=rh(this.y,e.y,t.y),this.z=rh(this.z,e.z,t.z),this.w=rh(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=rh(this.x,e,t),this.y=rh(this.y,e,t),this.z=rh(this.z,e,t),this.w=rh(this.w,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(rh(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Uh extends th{constructor(e=1,t=1,n={}){super(),n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Hl,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},n),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=n.depth,this.scissor=new Oh(0,0,e,t),this.scissorTest=!1,this.viewport=new Oh(0,0,e,t);const i={width:e,height:t,depth:n.depth},s=new Lh(i);this.textures=[];const a=n.count;for(let r=0;r<a;r++)this.textures[r]=s.clone(),this.textures[r].isRenderTargetTexture=!0,this.textures[r].renderTarget=this;this._setTextureOptions(n),this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=n.depthTexture,this.samples=n.samples,this.multiview=n.multiview}_setTextureOptions(e={}){const t={minFilter:Hl,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(t.mapping=e.mapping),void 0!==e.wrapS&&(t.wrapS=e.wrapS),void 0!==e.wrapT&&(t.wrapT=e.wrapT),void 0!==e.wrapR&&(t.wrapR=e.wrapR),void 0!==e.magFilter&&(t.magFilter=e.magFilter),void 0!==e.minFilter&&(t.minFilter=e.minFilter),void 0!==e.format&&(t.format=e.format),void 0!==e.type&&(t.type=e.type),void 0!==e.anisotropy&&(t.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(t.colorSpace=e.colorSpace),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(t.internalFormat=e.internalFormat);for(let n=0;n<this.textures.length;n++)this.textures[n].setValues(t)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let i=0,s=this.textures.length;i<s;i++)this.textures[i].image.width=e,this.textures[i].image.height=t,this.textures[i].image.depth=n,this.textures[i].isArrayTexture=this.textures[i].image.depth>1;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,n=e.textures.length;t<n;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const n=Object.assign({},e.textures[t].image);this.textures[t].source=new Ph(n)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Fh extends Uh{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}}class zh extends Lh{constructor(e=null,t=1,n=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=zl,this.minFilter=zl,this.wrapR=Ul,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class Bh extends Lh{constructor(e=null,t=1,n=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=zl,this.minFilter=zl,this.wrapR=Ul,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Vh{constructor(e=new ph(1/0,1/0,1/0),t=new ph(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(Wh.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(Wh.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=Wh.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const i=n.getAttribute("position");if(!0===t&&void 0!==i&&!0!==e.isInstancedMesh)for(let t=0,n=i.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,Wh):Wh.fromBufferAttribute(i,t),Wh.applyMatrix4(e.matrixWorld),this.expandByPoint(Wh);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Gh.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),Gh.copy(n.boundingBox)),Gh.applyMatrix4(e.matrixWorld),this.union(Gh)}const i=e.children;for(let s=0,a=i.length;s<a;s++)this.expandByObject(i[s],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,Wh),Wh.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Jh),Qh.subVectors(this.max,Jh),qh.subVectors(e.a,Jh),$h.subVectors(e.b,Jh),Xh.subVectors(e.c,Jh),Yh.subVectors($h,qh),Kh.subVectors(Xh,$h),Zh.subVectors(qh,Xh);let t=[0,-Yh.z,Yh.y,0,-Kh.z,Kh.y,0,-Zh.z,Zh.y,Yh.z,0,-Yh.x,Kh.z,0,-Kh.x,Zh.z,0,-Zh.x,-Yh.y,Yh.x,0,-Kh.y,Kh.x,0,-Zh.y,Zh.x,0];return!!nu(t,qh,$h,Xh,Qh)&&(t=[1,0,0,0,1,0,0,0,1],!!nu(t,qh,$h,Xh,Qh)&&(eu.crossVectors(Yh,Kh),t=[eu.x,eu.y,eu.z],nu(t,qh,$h,Xh,Qh)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Wh).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(Wh).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Hh[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Hh[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Hh[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Hh[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Hh[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Hh[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Hh[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Hh[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Hh)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const Hh=[new ph,new ph,new ph,new ph,new ph,new ph,new ph,new ph],Wh=new ph,Gh=new Vh,qh=new ph,$h=new ph,Xh=new ph,Yh=new ph,Kh=new ph,Zh=new ph,Jh=new ph,Qh=new ph,eu=new ph,tu=new ph;function nu(e,t,n,i,s){for(let a=0,r=e.length-3;a<=r;a+=3){tu.fromArray(e,a);const r=s.x*Math.abs(tu.x)+s.y*Math.abs(tu.y)+s.z*Math.abs(tu.z),o=t.dot(tu),l=n.dot(tu),c=i.dot(tu);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>r)return!1}return!0}const iu=new Vh,su=new ph,au=new ph;class ru{constructor(e=new ph,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):iu.setFromPoints(e).getCenter(n);let i=0;for(let s=0,a=e.length;s<a;s++)i=Math.max(i,n.distanceToSquared(e[s]));return this.radius=Math.sqrt(i),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;su.subVectors(e,this.center);const t=su.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector(su,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(au.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(su.copy(e.center).add(au)),this.expandByPoint(su.copy(e.center).sub(au))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const ou=new ph,lu=new ph,cu=new ph,hu=new ph,uu=new ph,du=new ph,pu=new ph;class mu{constructor(e=new ph,t=new ph(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,ou)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=ou.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(ou.copy(this.origin).addScaledVector(this.direction,t),ou.distanceToSquared(e))}distanceSqToSegment(e,t,n,i){lu.copy(e).add(t).multiplyScalar(.5),cu.copy(t).sub(e).normalize(),hu.copy(this.origin).sub(lu);const s=.5*e.distanceTo(t),a=-this.direction.dot(cu),r=hu.dot(this.direction),o=-hu.dot(cu),l=hu.lengthSq(),c=Math.abs(1-a*a);let h,u,d,p;if(c>0)if(h=a*o-r,u=a*r-o,p=s*c,h>=0)if(u>=-p)if(u<=p){const e=1/c;h*=e,u*=e,d=h*(h+a*u+2*r)+u*(a*h+u+2*o)+l}else u=s,h=Math.max(0,-(a*u+r)),d=-h*h+u*(u+2*o)+l;else u=-s,h=Math.max(0,-(a*u+r)),d=-h*h+u*(u+2*o)+l;else u<=-p?(h=Math.max(0,-(-a*s+r)),u=h>0?-s:Math.min(Math.max(-s,-o),s),d=-h*h+u*(u+2*o)+l):u<=p?(h=0,u=Math.min(Math.max(-s,-o),s),d=u*(u+2*o)+l):(h=Math.max(0,-(a*s+r)),u=h>0?s:Math.min(Math.max(-s,-o),s),d=-h*h+u*(u+2*o)+l);else u=a>0?-s:s,h=Math.max(0,-(a*u+r)),d=-h*h+u*(u+2*o)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,h),i&&i.copy(lu).addScaledVector(cu,u),d}intersectSphere(e,t){ou.subVectors(e.center,this.origin);const n=ou.dot(this.direction),i=ou.dot(ou)-n*n,s=e.radius*e.radius;if(i>s)return null;const a=Math.sqrt(s-i),r=n-a,o=n+a;return o<0?null:r<0?this.at(o,t):this.at(r,t)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,i,s,a,r,o;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(n=(e.min.x-u.x)*l,i=(e.max.x-u.x)*l):(n=(e.max.x-u.x)*l,i=(e.min.x-u.x)*l),c>=0?(s=(e.min.y-u.y)*c,a=(e.max.y-u.y)*c):(s=(e.max.y-u.y)*c,a=(e.min.y-u.y)*c),n>a||s>i?null:((s>n||isNaN(n))&&(n=s),(a<i||isNaN(i))&&(i=a),h>=0?(r=(e.min.z-u.z)*h,o=(e.max.z-u.z)*h):(r=(e.max.z-u.z)*h,o=(e.min.z-u.z)*h),n>o||r>i?null:((r>n||n!=n)&&(n=r),(o<i||i!=i)&&(i=o),i<0?null:this.at(n>=0?n:i,t)))}intersectsBox(e){return null!==this.intersectBox(e,ou)}intersectTriangle(e,t,n,i,s){uu.subVectors(t,e),du.subVectors(n,e),pu.crossVectors(uu,du);let a,r=this.direction.dot(pu);if(r>0){if(i)return null;a=1}else{if(!(r<0))return null;a=-1,r=-r}hu.subVectors(this.origin,e);const o=a*this.direction.dot(du.crossVectors(hu,du));if(o<0)return null;const l=a*this.direction.dot(uu.cross(hu));if(l<0)return null;if(o+l>r)return null;const c=-a*hu.dot(pu);return c<0?null:this.at(c/r,s)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class fu{constructor(e,t,n,i,s,a,r,o,l,c,h,u,d,p,m,f){fu.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,n,i,s,a,r,o,l,c,h,u,d,p,m,f)}set(e,t,n,i,s,a,r,o,l,c,h,u,d,p,m,f){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=s,g[5]=a,g[9]=r,g[13]=o,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new fu).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,i=1/gu.setFromMatrixColumn(e,0).length(),s=1/gu.setFromMatrixColumn(e,1).length(),a=1/gu.setFromMatrixColumn(e,2).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[3]=0,t[4]=n[4]*s,t[5]=n[5]*s,t[6]=n[6]*s,t[7]=0,t[8]=n[8]*a,t[9]=n[9]*a,t[10]=n[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,i=e.y,s=e.z,a=Math.cos(n),r=Math.sin(n),o=Math.cos(i),l=Math.sin(i),c=Math.cos(s),h=Math.sin(s);if("XYZ"===e.order){const e=a*c,n=a*h,i=r*c,s=r*h;t[0]=o*c,t[4]=-o*h,t[8]=l,t[1]=n+i*l,t[5]=e-s*l,t[9]=-r*o,t[2]=s-e*l,t[6]=i+n*l,t[10]=a*o}else if("YXZ"===e.order){const e=o*c,n=o*h,i=l*c,s=l*h;t[0]=e+s*r,t[4]=i*r-n,t[8]=a*l,t[1]=a*h,t[5]=a*c,t[9]=-r,t[2]=n*r-i,t[6]=s+e*r,t[10]=a*o}else if("ZXY"===e.order){const e=o*c,n=o*h,i=l*c,s=l*h;t[0]=e-s*r,t[4]=-a*h,t[8]=i+n*r,t[1]=n+i*r,t[5]=a*c,t[9]=s-e*r,t[2]=-a*l,t[6]=r,t[10]=a*o}else if("ZYX"===e.order){const e=a*c,n=a*h,i=r*c,s=r*h;t[0]=o*c,t[4]=i*l-n,t[8]=e*l+s,t[1]=o*h,t[5]=s*l+e,t[9]=n*l-i,t[2]=-l,t[6]=r*o,t[10]=a*o}else if("YZX"===e.order){const e=a*o,n=a*l,i=r*o,s=r*l;t[0]=o*c,t[4]=s-e*h,t[8]=i*h+n,t[1]=h,t[5]=a*c,t[9]=-r*c,t[2]=-l*c,t[6]=n*h+i,t[10]=e-s*h}else if("XZY"===e.order){const e=a*o,n=a*l,i=r*o,s=r*l;t[0]=o*c,t[4]=-h,t[8]=l*c,t[1]=e*h+s,t[5]=a*c,t[9]=n*h-i,t[2]=i*h-n,t[6]=r*c,t[10]=s*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(xu,e,yu)}lookAt(e,t,n){const i=this.elements;return wu.subVectors(e,t),0===wu.lengthSq()&&(wu.z=1),wu.normalize(),bu.crossVectors(n,wu),0===bu.lengthSq()&&(1===Math.abs(n.z)?wu.x+=1e-4:wu.z+=1e-4,wu.normalize(),bu.crossVectors(n,wu)),bu.normalize(),_u.crossVectors(wu,bu),i[0]=bu.x,i[4]=_u.x,i[8]=wu.x,i[1]=bu.y,i[5]=_u.y,i[9]=wu.y,i[2]=bu.z,i[6]=_u.z,i[10]=wu.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,s=this.elements,a=n[0],r=n[4],o=n[8],l=n[12],c=n[1],h=n[5],u=n[9],d=n[13],p=n[2],m=n[6],f=n[10],g=n[14],v=n[3],x=n[7],y=n[11],b=n[15],_=i[0],w=i[4],S=i[8],M=i[12],T=i[1],E=i[5],C=i[9],N=i[13],A=i[2],R=i[6],j=i[10],P=i[14],I=i[3],D=i[7],k=i[11],L=i[15];return s[0]=a*_+r*T+o*A+l*I,s[4]=a*w+r*E+o*R+l*D,s[8]=a*S+r*C+o*j+l*k,s[12]=a*M+r*N+o*P+l*L,s[1]=c*_+h*T+u*A+d*I,s[5]=c*w+h*E+u*R+d*D,s[9]=c*S+h*C+u*j+d*k,s[13]=c*M+h*N+u*P+d*L,s[2]=p*_+m*T+f*A+g*I,s[6]=p*w+m*E+f*R+g*D,s[10]=p*S+m*C+f*j+g*k,s[14]=p*M+m*N+f*P+g*L,s[3]=v*_+x*T+y*A+b*I,s[7]=v*w+x*E+y*R+b*D,s[11]=v*S+x*C+y*j+b*k,s[15]=v*M+x*N+y*P+b*L,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],i=e[8],s=e[12],a=e[1],r=e[5],o=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+s*o*h-i*l*h-s*r*u+n*l*u+i*r*d-n*o*d)+e[7]*(+t*o*d-t*l*u+s*a*u-i*a*d+i*l*c-s*o*c)+e[11]*(+t*l*h-t*r*d-s*a*h+n*a*d+s*r*c-n*l*c)+e[15]*(-i*r*c-t*o*h+t*r*u+i*a*h-n*a*u+n*o*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],s=e[3],a=e[4],r=e[5],o=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11],p=e[12],m=e[13],f=e[14],g=e[15],v=h*f*l-m*u*l+m*o*d-r*f*d-h*o*g+r*u*g,x=p*u*l-c*f*l-p*o*d+a*f*d+c*o*g-a*u*g,y=c*m*l-p*h*l+p*r*d-a*m*d-c*r*g+a*h*g,b=p*h*o-c*m*o-p*r*u+a*m*u+c*r*f-a*h*f,_=t*v+n*x+i*y+s*b;if(0===_)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/_;return e[0]=v*w,e[1]=(m*u*s-h*f*s-m*i*d+n*f*d+h*i*g-n*u*g)*w,e[2]=(r*f*s-m*o*s+m*i*l-n*f*l-r*i*g+n*o*g)*w,e[3]=(h*o*s-r*u*s-h*i*l+n*u*l+r*i*d-n*o*d)*w,e[4]=x*w,e[5]=(c*f*s-p*u*s+p*i*d-t*f*d-c*i*g+t*u*g)*w,e[6]=(p*o*s-a*f*s-p*i*l+t*f*l+a*i*g-t*o*g)*w,e[7]=(a*u*s-c*o*s+c*i*l-t*u*l-a*i*d+t*o*d)*w,e[8]=y*w,e[9]=(p*h*s-c*m*s-p*n*d+t*m*d+c*n*g-t*h*g)*w,e[10]=(a*m*s-p*r*s+p*n*l-t*m*l-a*n*g+t*r*g)*w,e[11]=(c*r*s-a*h*s-c*n*l+t*h*l+a*n*d-t*r*d)*w,e[12]=b*w,e[13]=(c*m*i-p*h*i+p*n*u-t*m*u-c*n*f+t*h*f)*w,e[14]=(p*r*i-a*m*i-p*n*o+t*m*o+a*n*f-t*r*f)*w,e[15]=(a*h*i-c*r*i+c*n*o-t*h*o-a*n*u+t*r*u)*w,this}scale(e){const t=this.elements,n=e.x,i=e.y,s=e.z;return t[0]*=n,t[4]*=i,t[8]*=s,t[1]*=n,t[5]*=i,t[9]*=s,t[2]*=n,t[6]*=i,t[10]*=s,t[3]*=n,t[7]*=i,t[11]*=s,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,i))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),i=Math.sin(t),s=1-n,a=e.x,r=e.y,o=e.z,l=s*a,c=s*r;return this.set(l*a+n,l*r-i*o,l*o+i*r,0,l*r+i*o,c*r+n,c*o-i*a,0,l*o-i*r,c*o+i*a,s*o*o+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,i,s,a){return this.set(1,n,s,0,e,1,a,0,t,i,1,0,0,0,0,1),this}compose(e,t,n){const i=this.elements,s=t._x,a=t._y,r=t._z,o=t._w,l=s+s,c=a+a,h=r+r,u=s*l,d=s*c,p=s*h,m=a*c,f=a*h,g=r*h,v=o*l,x=o*c,y=o*h,b=n.x,_=n.y,w=n.z;return i[0]=(1-(m+g))*b,i[1]=(d+y)*b,i[2]=(p-x)*b,i[3]=0,i[4]=(d-y)*_,i[5]=(1-(u+g))*_,i[6]=(f+v)*_,i[7]=0,i[8]=(p+x)*w,i[9]=(f-v)*w,i[10]=(1-(u+m))*w,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,n){const i=this.elements;let s=gu.set(i[0],i[1],i[2]).length();const a=gu.set(i[4],i[5],i[6]).length(),r=gu.set(i[8],i[9],i[10]).length();this.determinant()<0&&(s=-s),e.x=i[12],e.y=i[13],e.z=i[14],vu.copy(this);const o=1/s,l=1/a,c=1/r;return vu.elements[0]*=o,vu.elements[1]*=o,vu.elements[2]*=o,vu.elements[4]*=l,vu.elements[5]*=l,vu.elements[6]*=l,vu.elements[8]*=c,vu.elements[9]*=c,vu.elements[10]*=c,t.setFromRotationMatrix(vu),n.x=s,n.y=a,n.z=r,this}makePerspective(e,t,n,i,s,a,r=2e3){const o=this.elements,l=2*s/(t-e),c=2*s/(n-i),h=(t+e)/(t-e),u=(n+i)/(n-i);let d,p;if(r===Qc)d=-(a+s)/(a-s),p=-2*a*s/(a-s);else{if(r!==eh)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+r);d=-a/(a-s),p=-a*s/(a-s)}return o[0]=l,o[4]=0,o[8]=h,o[12]=0,o[1]=0,o[5]=c,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,n,i,s,a,r=2e3){const o=this.elements,l=1/(t-e),c=1/(n-i),h=1/(a-s),u=(t+e)*l,d=(n+i)*c;let p,m;if(r===Qc)p=(a+s)*h,m=-2*h;else{if(r!==eh)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+r);p=s*h,m=-1*h}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=m,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let i=0;i<16;i++)if(t[i]!==n[i])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}const gu=new ph,vu=new fu,xu=new ph(0,0,0),yu=new ph(1,1,1),bu=new ph,_u=new ph,wu=new ph,Su=new fu,Mu=new dh;class Tu{constructor(e=0,t=0,n=0,i=Tu.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=n,this._order=i}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,i=this._order){return this._x=e,this._y=t,this._z=n,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const i=e.elements,s=i[0],a=i[4],r=i[8],o=i[1],l=i[5],c=i[9],h=i[2],u=i[6],d=i[10];switch(t){case"XYZ":this._y=Math.asin(rh(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-a,s)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-rh(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(r,d),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-h,s),this._z=0);break;case"ZXY":this._x=Math.asin(rh(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-h,d),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(o,s));break;case"ZYX":this._y=Math.asin(-rh(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,s)):(this._x=0,this._z=Math.atan2(-a,l));break;case"YZX":this._z=Math.asin(rh(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-h,s)):(this._x=0,this._y=Math.atan2(r,d));break;case"XZY":this._z=Math.asin(-rh(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(r,s)):(this._x=Math.atan2(-c,d),this._y=0)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return Su.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Su,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Mu.setFromEuler(this),this.setFromQuaternion(Mu,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Tu.DEFAULT_ORDER="XYZ";class Eu{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let Cu=0;const Nu=new ph,Au=new dh,Ru=new fu,ju=new ph,Pu=new ph,Iu=new ph,Du=new dh,ku=new ph(1,0,0),Lu=new ph(0,1,0),Ou=new ph(0,0,1),Uu={type:"added"},Fu={type:"removed"},zu={type:"childadded",child:null},Bu={type:"childremoved",child:null};class Vu extends th{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Cu++}),this.uuid=ah(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Vu.DEFAULT_UP.clone();const e=new ph,t=new Tu,n=new dh,i=new ph(1,1,1);t._onChange(function(){n.setFromEuler(t,!1)}),n._onChange(function(){t.setFromQuaternion(n,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new fu},normalMatrix:{value:new gh}}),this.matrix=new fu,this.matrixWorld=new fu,this.matrixAutoUpdate=Vu.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Vu.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Eu,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return Au.setFromAxisAngle(e,t),this.quaternion.multiply(Au),this}rotateOnWorldAxis(e,t){return Au.setFromAxisAngle(e,t),this.quaternion.premultiply(Au),this}rotateX(e){return this.rotateOnAxis(ku,e)}rotateY(e){return this.rotateOnAxis(Lu,e)}rotateZ(e){return this.rotateOnAxis(Ou,e)}translateOnAxis(e,t){return Nu.copy(e).applyQuaternion(this.quaternion),this.position.add(Nu.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(ku,e)}translateY(e){return this.translateOnAxis(Lu,e)}translateZ(e){return this.translateOnAxis(Ou,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Ru.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?ju.copy(e):ju.set(e,t,n);const i=this.parent;this.updateWorldMatrix(!0,!1),Pu.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Ru.lookAt(Pu,ju,this.up):Ru.lookAt(ju,Pu,this.up),this.quaternion.setFromRotationMatrix(Ru),i&&(Ru.extractRotation(i.matrixWorld),Au.setFromRotationMatrix(Ru),this.quaternion.premultiply(Au.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this||e&&e.isObject3D&&(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Uu),zu.child=e,this.dispatchEvent(zu),zu.child=null),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Fu),Bu.child=e,this.dispatchEvent(Bu),Bu.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Ru.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Ru.multiply(e.parent.matrixWorld)),e.applyMatrix4(Ru),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Uu),zu.child=e,this.dispatchEvent(zu),zu.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,i=this.children.length;n<i;n++){const i=this.children[n].getObjectByProperty(e,t);if(void 0!==i)return i}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const i=this.children;for(let s=0,a=i.length;s<a;s++)i[s].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Pu,e,Iu),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Pu,Du,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].updateMatrixWorld(e)}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++)e[t].updateWorldMatrix(!1,!0)}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};function s(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map(e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0})),i.instanceInfo=this._instanceInfo.map(e=>({...e})),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(e),i.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(i.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(i.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=s(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,i=n.length;t<i;t++){const i=n[t];s(e.shapes,i)}else s(e.shapes,n)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(s(e.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,i=this.material.length;n<i;n++)t.push(s(e.materials,this.material[n]));i.material=t}else i.material=s(e.materials,this.material);if(this.children.length>0){i.children=[];for(let t=0;t<this.children.length;t++)i.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){i.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];i.animations.push(s(e.animations,n))}}if(t){const t=a(e.geometries),i=a(e.materials),s=a(e.textures),r=a(e.images),o=a(e.shapes),l=a(e.skeletons),c=a(e.animations),h=a(e.nodes);t.length>0&&(n.geometries=t),i.length>0&&(n.materials=i),s.length>0&&(n.textures=s),r.length>0&&(n.images=r),o.length>0&&(n.shapes=o),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),h.length>0&&(n.nodes=h)}return n.object=i,n;function a(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let n=0;n<e.children.length;n++){const t=e.children[n];this.add(t.clone())}return this}}Vu.DEFAULT_UP=new ph(0,1,0),Vu.DEFAULT_MATRIX_AUTO_UPDATE=!0,Vu.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Hu=new ph,Wu=new ph,Gu=new ph,qu=new ph,$u=new ph,Xu=new ph,Yu=new ph,Ku=new ph,Zu=new ph,Ju=new ph,Qu=new Oh,ed=new Oh,td=new Oh;class nd{constructor(e=new ph,t=new ph,n=new ph){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,i){i.subVectors(n,t),Hu.subVectors(e,t),i.cross(Hu);const s=i.lengthSq();return s>0?i.multiplyScalar(1/Math.sqrt(s)):i.set(0,0,0)}static getBarycoord(e,t,n,i,s){Hu.subVectors(i,t),Wu.subVectors(n,t),Gu.subVectors(e,t);const a=Hu.dot(Hu),r=Hu.dot(Wu),o=Hu.dot(Gu),l=Wu.dot(Wu),c=Wu.dot(Gu),h=a*l-r*r;if(0===h)return s.set(0,0,0),null;const u=1/h,d=(l*o-r*c)*u,p=(a*c-r*o)*u;return s.set(1-d-p,p,d)}static containsPoint(e,t,n,i){return null!==this.getBarycoord(e,t,n,i,qu)&&qu.x>=0&&qu.y>=0&&qu.x+qu.y<=1}static getInterpolation(e,t,n,i,s,a,r,o){return null===this.getBarycoord(e,t,n,i,qu)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(s,qu.x),o.addScaledVector(a,qu.y),o.addScaledVector(r,qu.z),o)}static getInterpolatedAttribute(e,t,n,i,s,a){return Qu.setScalar(0),ed.setScalar(0),td.setScalar(0),Qu.fromBufferAttribute(e,t),ed.fromBufferAttribute(e,n),td.fromBufferAttribute(e,i),a.setScalar(0),a.addScaledVector(Qu,s.x),a.addScaledVector(ed,s.y),a.addScaledVector(td,s.z),a}static isFrontFacing(e,t,n,i){return Hu.subVectors(n,t),Wu.subVectors(e,t),Hu.cross(Wu).dot(i)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,i){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,n,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Hu.subVectors(this.c,this.b),Wu.subVectors(this.a,this.b),.5*Hu.cross(Wu).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return nd.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return nd.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,n,i,s){return nd.getInterpolation(e,this.a,this.b,this.c,t,n,i,s)}containsPoint(e){return nd.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return nd.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,i=this.b,s=this.c;let a,r;$u.subVectors(i,n),Xu.subVectors(s,n),Ku.subVectors(e,n);const o=$u.dot(Ku),l=Xu.dot(Ku);if(o<=0&&l<=0)return t.copy(n);Zu.subVectors(e,i);const c=$u.dot(Zu),h=Xu.dot(Zu);if(c>=0&&h<=c)return t.copy(i);const u=o*h-c*l;if(u<=0&&o>=0&&c<=0)return a=o/(o-c),t.copy(n).addScaledVector($u,a);Ju.subVectors(e,s);const d=$u.dot(Ju),p=Xu.dot(Ju);if(p>=0&&d<=p)return t.copy(s);const m=d*l-o*p;if(m<=0&&l>=0&&p<=0)return r=l/(l-p),t.copy(n).addScaledVector(Xu,r);const f=c*p-d*h;if(f<=0&&h-c>=0&&d-p>=0)return Yu.subVectors(s,i),r=(h-c)/(h-c+(d-p)),t.copy(i).addScaledVector(Yu,r);const g=1/(f+m+u);return a=m*g,r=u*g,t.copy(n).addScaledVector($u,a).addScaledVector(Xu,r)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const id={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},sd={h:0,s:0,l:0},ad={h:0,s:0,l:0};function rd(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}class od{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=Fc){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,Eh.colorSpaceToWorking(this,t),this}setRGB(e,t,n,i=Eh.workingColorSpace){return this.r=e,this.g=t,this.b=n,Eh.colorSpaceToWorking(this,i),this}setHSL(e,t,n,i=Eh.workingColorSpace){if(e=(e%(s=1)+s)%s,t=rh(t,0,1),n=rh(n,0,1),0===t)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+t):n+t-n*t,s=2*n-i;this.r=rd(s,i,e+1/3),this.g=rd(s,i,e),this.b=rd(s,i,e-1/3)}var s;return Eh.colorSpaceToWorking(this,i),this}setStyle(e,t=Fc){function n(e){void 0!==e&&parseFloat(e)}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let e;const s=i[1],a=i[2];switch(s){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return n(e[4]),this.setRGB(Math.min(255,parseInt(e[1],10))/255,Math.min(255,parseInt(e[2],10))/255,Math.min(255,parseInt(e[3],10))/255,t);if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return n(e[4]),this.setRGB(Math.min(100,parseInt(e[1],10))/100,Math.min(100,parseInt(e[2],10))/100,Math.min(100,parseInt(e[3],10))/100,t);break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return n(e[4]),this.setHSL(parseFloat(e[1])/360,parseFloat(e[2])/100,parseFloat(e[3])/100,t)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=i[1],n=e.length;if(3===n)return this.setRGB(parseInt(e.charAt(0),16)/15,parseInt(e.charAt(1),16)/15,parseInt(e.charAt(2),16)/15,t);if(6===n)return this.setHex(parseInt(e,16),t)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=Fc){const n=id[e.toLowerCase()];return void 0!==n&&this.setHex(n,t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=Ch(e.r),this.g=Ch(e.g),this.b=Ch(e.b),this}copyLinearToSRGB(e){return this.r=Nh(e.r),this.g=Nh(e.g),this.b=Nh(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=Fc){return Eh.workingToColorSpace(ld.copy(this),e),65536*Math.round(rh(255*ld.r,0,255))+256*Math.round(rh(255*ld.g,0,255))+Math.round(rh(255*ld.b,0,255))}getHexString(e=Fc){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Eh.workingColorSpace){Eh.workingToColorSpace(ld.copy(this),t);const n=ld.r,i=ld.g,s=ld.b,a=Math.max(n,i,s),r=Math.min(n,i,s);let o,l;const c=(r+a)/2;if(r===a)o=0,l=0;else{const e=a-r;switch(l=c<=.5?e/(a+r):e/(2-a-r),a){case n:o=(i-s)/e+(i<s?6:0);break;case i:o=(s-n)/e+2;break;case s:o=(n-i)/e+4}o/=6}return e.h=o,e.s=l,e.l=c,e}getRGB(e,t=Eh.workingColorSpace){return Eh.workingToColorSpace(ld.copy(this),t),e.r=ld.r,e.g=ld.g,e.b=ld.b,e}getStyle(e=Fc){Eh.workingToColorSpace(ld.copy(this),e);const t=ld.r,n=ld.g,i=ld.b;return e!==Fc?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*i)})`}offsetHSL(e,t,n){return this.getHSL(sd),this.setHSL(sd.h+e,sd.s+t,sd.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(sd),e.getHSL(ad);const n=oh(sd.h,ad.h,t),i=oh(sd.s,ad.s,t),s=oh(sd.l,ad.l,t);return this.setHSL(n,i,s),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,i=this.b,s=e.elements;return this.r=s[0]*t+s[3]*n+s[6]*i,this.g=s[1]*t+s[4]*n+s[7]*i,this.b=s[2]*t+s[5]*n+s[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const ld=new od;od.NAMES=id;let cd=0;class hd extends th{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:cd++}),this.uuid=ah(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=ll,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new od(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Hc,this.stencilZFail=Hc,this.stencilZPass=Hc,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n)continue;const i=this[t];void 0!==i&&(i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[t]=n)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function i(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(n.dispersion=this.dispersion),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),0!==this.side&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),204!==this.blendSrc&&(n.blendSrc=this.blendSrc),205!==this.blendDst&&(n.blendDst=this.blendDst),this.blendEquation!==ll&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Hc&&(n.stencilFail=this.stencilFail),this.stencilZFail!==Hc&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==Hc&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=i(e.textures),s=i(e.images);t.length>0&&(n.textures=t),s.length>0&&(n.images=s)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let i=0;i!==e;++i)n[i]=t[i].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class ud extends hd{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new od(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Tu,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const dd=new ph,pd=new uh;let md=0;class fd{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:md++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=35044,this.updateRanges=[],this.gpuType=Kl,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let i=0,s=this.itemSize;i<s;i++)this.array[e+i]=t.array[n+i];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)pd.fromBufferAttribute(this,t),pd.applyMatrix3(e),this.setXY(t,pd.x,pd.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)dd.fromBufferAttribute(this,t),dd.applyMatrix3(e),this.setXYZ(t,dd.x,dd.y,dd.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)dd.fromBufferAttribute(this,t),dd.applyMatrix4(e),this.setXYZ(t,dd.x,dd.y,dd.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)dd.fromBufferAttribute(this,t),dd.applyNormalMatrix(e),this.setXYZ(t,dd.x,dd.y,dd.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)dd.fromBufferAttribute(this,t),dd.transformDirection(e),this.setXYZ(t,dd.x,dd.y,dd.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=lh(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=ch(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=lh(t,this.array)),t}setX(e,t){return this.normalized&&(t=ch(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=lh(t,this.array)),t}setY(e,t){return this.normalized&&(t=ch(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=lh(t,this.array)),t}setZ(e,t){return this.normalized&&(t=ch(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=lh(t,this.array)),t}setW(e,t){return this.normalized&&(t=ch(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=ch(t,this.array),n=ch(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,i){return e*=this.itemSize,this.normalized&&(t=ch(t,this.array),n=ch(n,this.array),i=ch(i,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this}setXYZW(e,t,n,i,s){return e*=this.itemSize,this.normalized&&(t=ch(t,this.array),n=ch(n,this.array),i=ch(i,this.array),s=ch(s,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this.array[e+3]=s,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class gd extends fd{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class vd extends fd{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class xd extends fd{constructor(e,t,n){super(new Float32Array(e),t,n)}}let yd=0;const bd=new fu,_d=new Vu,wd=new ph,Sd=new Vh,Md=new Vh,Td=new ph;class Ed extends th{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:yd++}),this.uuid=ah(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(xh(e)?vd:gd)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new gh).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(e),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return bd.makeRotationFromQuaternion(e),this.applyMatrix4(bd),this}rotateX(e){return bd.makeRotationX(e),this.applyMatrix4(bd),this}rotateY(e){return bd.makeRotationY(e),this.applyMatrix4(bd),this}rotateZ(e){return bd.makeRotationZ(e),this.applyMatrix4(bd),this}translate(e,t,n){return bd.makeTranslation(e,t,n),this.applyMatrix4(bd),this}scale(e,t,n){return bd.makeScale(e,t,n),this.applyMatrix4(bd),this}lookAt(e){return _d.lookAt(e),_d.updateMatrix(),this.applyMatrix4(_d.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(wd).negate(),this.translate(wd.x,wd.y,wd.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];t.push(i.x,i.y,i.z||0)}this.setAttribute("position",new xd(t,3))}else{const n=Math.min(e.length,t.count);for(let i=0;i<n;i++){const n=e[i];t.setXYZ(i,n.x,n.y,n.z||0)}e.length,t.count,t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Vh);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingBox.set(new ph(-1/0,-1/0,-1/0),new ph(1/0,1/0,1/0));else{if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];Sd.setFromBufferAttribute(n),this.morphTargetsRelative?(Td.addVectors(this.boundingBox.min,Sd.min),this.boundingBox.expandByPoint(Td),Td.addVectors(this.boundingBox.max,Sd.max),this.boundingBox.expandByPoint(Td)):(this.boundingBox.expandByPoint(Sd.min),this.boundingBox.expandByPoint(Sd.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ru);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingSphere.set(new ph,1/0);else if(e){const n=this.boundingSphere.center;if(Sd.setFromBufferAttribute(e),t)for(let e=0,s=t.length;e<s;e++){const n=t[e];Md.setFromBufferAttribute(n),this.morphTargetsRelative?(Td.addVectors(Sd.min,Md.min),Sd.expandByPoint(Td),Td.addVectors(Sd.max,Md.max),Sd.expandByPoint(Td)):(Sd.expandByPoint(Md.min),Sd.expandByPoint(Md.max))}Sd.getCenter(n);let i=0;for(let t=0,s=e.count;t<s;t++)Td.fromBufferAttribute(e,t),i=Math.max(i,n.distanceToSquared(Td));if(t)for(let s=0,a=t.length;s<a;s++){const a=t[s],r=this.morphTargetsRelative;for(let t=0,s=a.count;t<s;t++)Td.fromBufferAttribute(a,t),r&&(wd.fromBufferAttribute(e,t),Td.add(wd)),i=Math.max(i,n.distanceToSquared(Td))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return;const n=t.position,i=t.normal,s=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new fd(new Float32Array(4*n.count),4));const a=this.getAttribute("tangent"),r=[],o=[];for(let S=0;S<n.count;S++)r[S]=new ph,o[S]=new ph;const l=new ph,c=new ph,h=new ph,u=new uh,d=new uh,p=new uh,m=new ph,f=new ph;function g(e,t,i){l.fromBufferAttribute(n,e),c.fromBufferAttribute(n,t),h.fromBufferAttribute(n,i),u.fromBufferAttribute(s,e),d.fromBufferAttribute(s,t),p.fromBufferAttribute(s,i),c.sub(l),h.sub(l),d.sub(u),p.sub(u);const a=1/(d.x*p.y-p.x*d.y);isFinite(a)&&(m.copy(c).multiplyScalar(p.y).addScaledVector(h,-d.y).multiplyScalar(a),f.copy(h).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(a),r[e].add(m),r[t].add(m),r[i].add(m),o[e].add(f),o[t].add(f),o[i].add(f))}let v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let S=0,M=v.length;S<M;++S){const t=v[S],n=t.start;for(let i=n,s=n+t.count;i<s;i+=3)g(e.getX(i+0),e.getX(i+1),e.getX(i+2))}const x=new ph,y=new ph,b=new ph,_=new ph;function w(e){b.fromBufferAttribute(i,e),_.copy(b);const t=r[e];x.copy(t),x.sub(b.multiplyScalar(b.dot(t))).normalize(),y.crossVectors(_,t);const n=y.dot(o[e])<0?-1:1;a.setXYZW(e,x.x,x.y,x.z,n)}for(let S=0,M=v.length;S<M;++S){const t=v[S],n=t.start;for(let i=n,s=n+t.count;i<s;i+=3)w(e.getX(i+0)),w(e.getX(i+1)),w(e.getX(i+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new fd(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const i=new ph,s=new ph,a=new ph,r=new ph,o=new ph,l=new ph,c=new ph,h=new ph;if(e)for(let u=0,d=e.count;u<d;u+=3){const d=e.getX(u+0),p=e.getX(u+1),m=e.getX(u+2);i.fromBufferAttribute(t,d),s.fromBufferAttribute(t,p),a.fromBufferAttribute(t,m),c.subVectors(a,s),h.subVectors(i,s),c.cross(h),r.fromBufferAttribute(n,d),o.fromBufferAttribute(n,p),l.fromBufferAttribute(n,m),r.add(c),o.add(c),l.add(c),n.setXYZ(d,r.x,r.y,r.z),n.setXYZ(p,o.x,o.y,o.z),n.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,u=t.count;e<u;e+=3)i.fromBufferAttribute(t,e+0),s.fromBufferAttribute(t,e+1),a.fromBufferAttribute(t,e+2),c.subVectors(a,s),h.subVectors(i,s),c.cross(h),n.setXYZ(e+0,c.x,c.y,c.z),n.setXYZ(e+1,c.x,c.y,c.z),n.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)Td.fromBufferAttribute(e,t),Td.normalize(),e.setXYZ(t,Td.x,Td.y,Td.z)}toNonIndexed(){function e(e,t){const n=e.array,i=e.itemSize,s=e.normalized,a=new n.constructor(t.length*i);let r=0,o=0;for(let l=0,c=t.length;l<c;l++){r=e.isInterleavedBufferAttribute?t[l]*e.data.stride+e.offset:t[l]*i;for(let e=0;e<i;e++)a[o++]=n[r++]}return new fd(a,i,s)}if(null===this.index)return this;const t=new Ed,n=this.index.array,i=this.attributes;for(const r in i){const s=e(i[r],n);t.setAttribute(r,s)}const s=this.morphAttributes;for(const r in s){const i=[],a=s[r];for(let t=0,s=a.length;t<s;t++){const s=e(a[t],n);i.push(s)}t.morphAttributes[r]=i}t.morphTargetsRelative=this.morphTargetsRelative;const a=this.groups;for(let r=0,o=a.length;r<o;r++){const e=a[r];t.addGroup(e.start,e.count,e.materialIndex)}return t}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const o in n){const t=n[o];e.data.attributes[o]=t.toJSON(e.data)}const i={};let s=!1;for(const o in this.morphAttributes){const t=this.morphAttributes[o],n=[];for(let i=0,s=t.length;i<s;i++){const s=t[i];n.push(s.toJSON(e.data))}n.length>0&&(i[o]=n,s=!0)}s&&(e.data.morphAttributes=i,e.data.morphTargetsRelative=this.morphTargetsRelative);const a=this.groups;a.length>0&&(e.data.groups=JSON.parse(JSON.stringify(a)));const r=this.boundingSphere;return null!==r&&(e.data.boundingSphere=r.toJSON()),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone());const i=e.attributes;for(const l in i){const e=i[l];this.setAttribute(l,e.clone(t))}const s=e.morphAttributes;for(const l in s){const e=[],n=s[l];for(let i=0,s=n.length;i<s;i++)e.push(n[i].clone(t));this.morphAttributes[l]=e}this.morphTargetsRelative=e.morphTargetsRelative;const a=e.groups;for(let l=0,c=a.length;l<c;l++){const e=a[l];this.addGroup(e.start,e.count,e.materialIndex)}const r=e.boundingBox;null!==r&&(this.boundingBox=r.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Cd=new fu,Nd=new mu,Ad=new ru,Rd=new ph,jd=new ph,Pd=new ph,Id=new ph,Dd=new ph,kd=new ph,Ld=new ph,Od=new ph;class Ud extends Vu{constructor(e=new Ed,t=new ud){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,i=n.attributes.position,s=n.morphAttributes.position,a=n.morphTargetsRelative;t.fromBufferAttribute(i,e);const r=this.morphTargetInfluences;if(s&&r){kd.set(0,0,0);for(let n=0,i=s.length;n<i;n++){const i=r[n],o=s[n];0!==i&&(Dd.fromBufferAttribute(o,e),a?kd.addScaledVector(Dd,i):kd.addScaledVector(Dd.sub(t),i))}t.add(kd)}return t}raycast(e,t){const n=this.geometry,i=this.material,s=this.matrixWorld;if(void 0!==i){if(null===n.boundingSphere&&n.computeBoundingSphere(),Ad.copy(n.boundingSphere),Ad.applyMatrix4(s),Nd.copy(e.ray).recast(e.near),!1===Ad.containsPoint(Nd.origin)){if(null===Nd.intersectSphere(Ad,Rd))return;if(Nd.origin.distanceToSquared(Rd)>(e.far-e.near)**2)return}Cd.copy(s).invert(),Nd.copy(e.ray).applyMatrix4(Cd),null!==n.boundingBox&&!1===Nd.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,Nd)}}_computeIntersections(e,t,n){let i;const s=this.geometry,a=this.material,r=s.index,o=s.attributes.position,l=s.attributes.uv,c=s.attributes.uv1,h=s.attributes.normal,u=s.groups,d=s.drawRange;if(null!==r)if(Array.isArray(a))for(let p=0,m=u.length;p<m;p++){const s=u[p],o=a[s.materialIndex];for(let a=Math.max(s.start,d.start),u=Math.min(r.count,Math.min(s.start+s.count,d.start+d.count));a<u;a+=3)i=Fd(this,o,e,n,l,c,h,r.getX(a),r.getX(a+1),r.getX(a+2)),i&&(i.faceIndex=Math.floor(a/3),i.face.materialIndex=s.materialIndex,t.push(i))}else for(let p=Math.max(0,d.start),m=Math.min(r.count,d.start+d.count);p<m;p+=3)i=Fd(this,a,e,n,l,c,h,r.getX(p),r.getX(p+1),r.getX(p+2)),i&&(i.faceIndex=Math.floor(p/3),t.push(i));else if(void 0!==o)if(Array.isArray(a))for(let p=0,m=u.length;p<m;p++){const s=u[p],r=a[s.materialIndex];for(let a=Math.max(s.start,d.start),u=Math.min(o.count,Math.min(s.start+s.count,d.start+d.count));a<u;a+=3)i=Fd(this,r,e,n,l,c,h,a,a+1,a+2),i&&(i.faceIndex=Math.floor(a/3),i.face.materialIndex=s.materialIndex,t.push(i))}else for(let p=Math.max(0,d.start),m=Math.min(o.count,d.start+d.count);p<m;p+=3)i=Fd(this,a,e,n,l,c,h,p,p+1,p+2),i&&(i.faceIndex=Math.floor(p/3),t.push(i))}}function Fd(e,t,n,i,s,a,r,o,l,c){e.getVertexPosition(o,jd),e.getVertexPosition(l,Pd),e.getVertexPosition(c,Id);const h=function(e,t,n,i,s,a,r,o){let l;if(l=1===t.side?i.intersectTriangle(r,a,s,!0,o):i.intersectTriangle(s,a,r,0===t.side,o),null===l)return null;Od.copy(o),Od.applyMatrix4(e.matrixWorld);const c=n.ray.origin.distanceTo(Od);return c<n.near||c>n.far?null:{distance:c,point:Od.clone(),object:e}}(e,t,n,i,jd,Pd,Id,Ld);if(h){const e=new ph;nd.getBarycoord(Ld,jd,Pd,Id,e),s&&(h.uv=nd.getInterpolatedAttribute(s,o,l,c,e,new uh)),a&&(h.uv1=nd.getInterpolatedAttribute(a,o,l,c,e,new uh)),r&&(h.normal=nd.getInterpolatedAttribute(r,o,l,c,e,new ph),h.normal.dot(i.direction)>0&&h.normal.multiplyScalar(-1));const t={a:o,b:l,c:c,normal:new ph,materialIndex:0};nd.getNormal(jd,Pd,Id,t.normal),h.face=t,h.barycoord=e}return h}class zd extends Ed{constructor(e=1,t=1,n=1,i=1,s=1,a=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:i,heightSegments:s,depthSegments:a};const r=this;i=Math.floor(i),s=Math.floor(s),a=Math.floor(a);const o=[],l=[],c=[],h=[];let u=0,d=0;function p(e,t,n,i,s,a,p,m,f,g,v){const x=a/f,y=p/g,b=a/2,_=p/2,w=m/2,S=f+1,M=g+1;let T=0,E=0;const C=new ph;for(let r=0;r<M;r++){const a=r*y-_;for(let o=0;o<S;o++){const u=o*x-b;C[e]=u*i,C[t]=a*s,C[n]=w,l.push(C.x,C.y,C.z),C[e]=0,C[t]=0,C[n]=m>0?1:-1,c.push(C.x,C.y,C.z),h.push(o/f),h.push(1-r/g),T+=1}}for(let r=0;r<g;r++)for(let e=0;e<f;e++){const t=u+e+S*r,n=u+e+S*(r+1),i=u+(e+1)+S*(r+1),s=u+(e+1)+S*r;o.push(t,n,s),o.push(n,i,s),E+=6}r.addGroup(d,E,v),d+=E,u+=T}p("z","y","x",-1,-1,n,t,e,a,s,0),p("z","y","x",1,-1,n,t,-e,a,s,1),p("x","z","y",1,1,e,n,t,i,a,2),p("x","z","y",1,-1,e,n,-t,i,a,3),p("x","y","z",1,-1,e,t,n,i,s,4),p("x","y","z",-1,-1,e,t,-n,i,s,5),this.setIndex(o),this.setAttribute("position",new xd(l,3)),this.setAttribute("normal",new xd(c,3)),this.setAttribute("uv",new xd(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new zd(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Bd(e){const t={};for(const n in e){t[n]={};for(const i in e[n]){const s=e[n][i];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?t[n][i]=null:t[n][i]=s.clone():Array.isArray(s)?t[n][i]=s.slice():t[n][i]=s}}return t}function Vd(e){const t={};for(let n=0;n<e.length;n++){const i=Bd(e[n]);for(const e in i)t[e]=i[e]}return t}function Hd(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:Eh.workingColorSpace}const Wd={clone:Bd,merge:Vd};class Gd extends hd{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Bd(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?t.uniforms[i]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?t.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?t.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?t.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?t.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?t.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?t.uniforms[i]={type:"m4",value:n.toArray()}:t.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const n={};for(const i in this.extensions)!0===this.extensions[i]&&(n[i]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}class qd extends Vu{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new fu,this.projectionMatrix=new fu,this.projectionMatrixInverse=new fu,this.coordinateSystem=Qc}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const $d=new ph,Xd=new uh,Yd=new uh;class Kd extends qd{constructor(e=50,t=1,n=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*sh*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*ih*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*sh*Math.atan(Math.tan(.5*ih*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){$d.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set($d.x,$d.y).multiplyScalar(-e/$d.z),$d.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set($d.x,$d.y).multiplyScalar(-e/$d.z)}getViewSize(e,t){return this.getViewBounds(e,Xd,Yd),t.subVectors(Yd,Xd)}setViewOffset(e,t,n,i,s,a){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=s,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*ih*this.fov)/this.zoom,n=2*t,i=this.aspect*n,s=-.5*i;const a=this.view;if(null!==this.view&&this.view.enabled){const e=a.fullWidth,r=a.fullHeight;s+=a.offsetX*i/e,t-=a.offsetY*n/r,i*=a.width/e,n*=a.height/r}const r=this.filmOffset;0!==r&&(s+=e*r/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+i,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const Zd=-90;class Jd extends Vu{constructor(e,t,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new Kd(Zd,1,e,t);i.layers=this.layers,this.add(i);const s=new Kd(Zd,1,e,t);s.layers=this.layers,this.add(s);const a=new Kd(Zd,1,e,t);a.layers=this.layers,this.add(a);const r=new Kd(Zd,1,e,t);r.layers=this.layers,this.add(r);const o=new Kd(Zd,1,e,t);o.layers=this.layers,this.add(o);const l=new Kd(Zd,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[n,i,s,a,r,o]=t;for(const l of t)this.remove(l);if(e===Qc)n.up.set(0,1,0),n.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),a.up.set(0,0,1),a.lookAt(0,-1,0),r.up.set(0,1,0),r.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==eh)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);n.up.set(0,-1,0),n.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),a.up.set(0,0,-1),a.lookAt(0,-1,0),r.up.set(0,-1,0),r.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const l of t)this.add(l),l.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:i}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[s,a,r,o,l,c]=this.children,h=e.getRenderTarget(),u=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const m=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,i),e.render(t,s),e.setRenderTarget(n,1,i),e.render(t,a),e.setRenderTarget(n,2,i),e.render(t,r),e.setRenderTarget(n,3,i),e.render(t,o),e.setRenderTarget(n,4,i),e.render(t,l),n.texture.generateMipmaps=m,e.setRenderTarget(n,5,i),e.render(t,c),e.setRenderTarget(h,u,d),e.xr.enabled=p,n.texture.needsPMREMUpdate=!0}}class Qd extends Lh{constructor(e=[],t=301,n,i,s,a,r,o,l,c){super(e,t,n,i,s,a,r,o,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class ep extends Fh{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},i=[n,n,n,n,n,n];this.texture=new Qd(i),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={tEquirect:{value:null}},i="\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",s="\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t",a=new zd(5,5,5),r=new Gd({name:"CubemapFromEquirect",uniforms:Bd(n),vertexShader:i,fragmentShader:s,side:1,blending:0});r.uniforms.tEquirect.value=t;const o=new Ud(a,r),l=t.minFilter;return t.minFilter===Gl&&(t.minFilter=Hl),new Jd(1,10,this).update(e,o),t.minFilter=l,o.geometry.dispose(),o.material.dispose(),this}clear(e,t=!0,n=!0,i=!0){const s=e.getRenderTarget();for(let a=0;a<6;a++)e.setRenderTarget(this,a),e.clear(t,n,i);e.setRenderTarget(s)}}class tp extends Vu{constructor(){super(),this.isGroup=!0,this.type="Group"}}const np={type:"move"};class ip{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new tp,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new tp,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new ph,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new ph),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new tp,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new ph,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new ph),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,n){let i=null,s=null,a=null;const r=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){a=!0;for(const a of e.hand.values()){const e=t.getJointPose(a,n),i=this._getHandJoint(l,a);null!==e&&(i.matrix.fromArray(e.transform.matrix),i.matrix.decompose(i.position,i.rotation,i.scale),i.matrixWorldNeedsUpdate=!0,i.jointRadius=e.radius),i.visible=null!==e}const i=l.joints["index-finger-tip"],s=l.joints["thumb-tip"],r=i.position.distanceTo(s.position),o=.02,c=.005;l.inputState.pinching&&r>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&r<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(s=t.getPose(e.gripSpace,n),null!==s&&(o.matrix.fromArray(s.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,s.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(s.linearVelocity)):o.hasLinearVelocity=!1,s.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(s.angularVelocity)):o.hasAngularVelocity=!1));null!==r&&(i=t.getPose(e.targetRaySpace,n),null===i&&null!==s&&(i=s),null!==i&&(r.matrix.fromArray(i.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,i.linearVelocity?(r.hasLinearVelocity=!0,r.linearVelocity.copy(i.linearVelocity)):r.hasLinearVelocity=!1,i.angularVelocity?(r.hasAngularVelocity=!0,r.angularVelocity.copy(i.angularVelocity)):r.hasAngularVelocity=!1,this.dispatchEvent(np)))}return null!==r&&(r.visible=null!==i),null!==o&&(o.visible=null!==s),null!==l&&(l.visible=null!==a),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const n=new tp;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}}class sp extends Vu{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Tu,this.environmentIntensity=1,this.environmentRotation=new Tu,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}const ap=new ph,rp=new ph,op=new gh;class lp{constructor(e=new ph(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,i){return this.normal.set(e,t,n),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const i=ap.subVectors(n,t).cross(rp.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(ap),i=this.normal.dot(n);if(0===i)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const s=-(e.start.dot(this.normal)+this.constant)/i;return s<0||s>1?null:t.copy(e.start).addScaledVector(n,s)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||op.getNormalMatrix(e),i=this.coplanarPoint(ap).applyMatrix4(e),s=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(s),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const cp=new ru,hp=new uh(.5,.5),up=new ph;class dp{constructor(e=new lp,t=new lp,n=new lp,i=new lp,s=new lp,a=new lp){this.planes=[e,t,n,i,s,a]}set(e,t,n,i,s,a){const r=this.planes;return r[0].copy(e),r[1].copy(t),r[2].copy(n),r[3].copy(i),r[4].copy(s),r[5].copy(a),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,i=e.elements,s=i[0],a=i[1],r=i[2],o=i[3],l=i[4],c=i[5],h=i[6],u=i[7],d=i[8],p=i[9],m=i[10],f=i[11],g=i[12],v=i[13],x=i[14],y=i[15];if(n[0].setComponents(o-s,u-l,f-d,y-g).normalize(),n[1].setComponents(o+s,u+l,f+d,y+g).normalize(),n[2].setComponents(o+a,u+c,f+p,y+v).normalize(),n[3].setComponents(o-a,u-c,f-p,y-v).normalize(),n[4].setComponents(o-r,u-h,f-m,y-x).normalize(),t===Qc)n[5].setComponents(o+r,u+h,f+m,y+x).normalize();else{if(t!==eh)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(r,h,m,x).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),cp.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),cp.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(cp)}intersectsSprite(e){cp.center.set(0,0,0);const t=hp.distanceTo(e.center);return cp.radius=.7071067811865476+t,cp.applyMatrix4(e.matrixWorld),this.intersectsSphere(cp)}intersectsSphere(e){const t=this.planes,n=e.center,i=-e.radius;for(let s=0;s<6;s++)if(t[s].distanceToPoint(n)<i)return!1;return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const i=t[n];if(up.x=i.normal.x>0?e.max.x:e.min.x,up.y=i.normal.y>0?e.max.y:e.min.y,up.z=i.normal.z>0?e.max.z:e.min.z,i.distanceToPoint(up)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class pp extends Lh{constructor(e,t,n=1014,i,s,a,r=1003,o=1003,l,c=1026,h=1){if(c!==nc&&c!==ic)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:t,depth:h},i,s,a,r,o,c,n,l),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Ph(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class mp extends Ed{constructor(e=[],t=[],n=1,i=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:n,detail:i};const s=[],a=[];function r(e,t,n,i){const s=i+1,a=[];for(let r=0;r<=s;r++){a[r]=[];const i=e.clone().lerp(n,r/s),o=t.clone().lerp(n,r/s),l=s-r;for(let e=0;e<=l;e++)a[r][e]=0===e&&r===s?i:i.clone().lerp(o,e/l)}for(let r=0;r<s;r++)for(let e=0;e<2*(s-r)-1;e++){const t=Math.floor(e/2);e%2==0?(o(a[r][t+1]),o(a[r+1][t]),o(a[r][t])):(o(a[r][t+1]),o(a[r+1][t+1]),o(a[r+1][t]))}}function o(e){s.push(e.x,e.y,e.z)}function l(t,n){const i=3*t;n.x=e[i+0],n.y=e[i+1],n.z=e[i+2]}function c(e,t,n,i){i<0&&1===e.x&&(a[t]=e.x-1),0===n.x&&0===n.z&&(a[t]=i/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}function u(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}!function(e){const n=new ph,i=new ph,s=new ph;for(let a=0;a<t.length;a+=3)l(t[a+0],n),l(t[a+1],i),l(t[a+2],s),r(n,i,s,e)}(i),function(e){const t=new ph;for(let n=0;n<s.length;n+=3)t.x=s[n+0],t.y=s[n+1],t.z=s[n+2],t.normalize().multiplyScalar(e),s[n+0]=t.x,s[n+1]=t.y,s[n+2]=t.z}(n),function(){const e=new ph;for(let t=0;t<s.length;t+=3){e.x=s[t+0],e.y=s[t+1],e.z=s[t+2];const n=h(e)/2/Math.PI+.5,i=u(e)/Math.PI+.5;a.push(n,1-i)}(function(){const e=new ph,t=new ph,n=new ph,i=new ph,r=new uh,o=new uh,l=new uh;for(let u=0,d=0;u<s.length;u+=9,d+=6){e.set(s[u+0],s[u+1],s[u+2]),t.set(s[u+3],s[u+4],s[u+5]),n.set(s[u+6],s[u+7],s[u+8]),r.set(a[d+0],a[d+1]),o.set(a[d+2],a[d+3]),l.set(a[d+4],a[d+5]),i.copy(e).add(t).add(n).divideScalar(3);const p=h(i);c(r,d+0,e,p),c(o,d+2,t,p),c(l,d+4,n,p)}})(),function(){for(let e=0;e<a.length;e+=6){const t=a[e+0],n=a[e+2],i=a[e+4],s=Math.max(t,n,i),r=Math.min(t,n,i);s>.9&&r<.1&&(t<.2&&(a[e+0]+=1),n<.2&&(a[e+2]+=1),i<.2&&(a[e+4]+=1))}}()}(),this.setAttribute("position",new xd(s,3)),this.setAttribute("normal",new xd(s.slice(),3)),this.setAttribute("uv",new xd(a,2)),0===i?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new mp(e.vertices,e.indices,e.radius,e.details)}}class fp extends mp{constructor(e=1,t=0){const n=(1+Math.sqrt(5))/2,i=1/n;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-n,0,-i,n,0,i,-n,0,i,n,-i,-n,0,-i,n,0,i,-n,0,i,n,0,-n,0,-i,n,0,-i,-n,0,i,n,0,i],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new fp(e.radius,e.detail)}}class gp extends mp{constructor(e=1,t=0){const n=(1+Math.sqrt(5))/2;super([-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new gp(e.radius,e.detail)}}class vp extends mp{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new vp(e.radius,e.detail)}}class xp extends Ed{constructor(e=1,t=1,n=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:i};const s=e/2,a=t/2,r=Math.floor(n),o=Math.floor(i),l=r+1,c=o+1,h=e/r,u=t/o,d=[],p=[],m=[],f=[];for(let g=0;g<c;g++){const e=g*u-a;for(let t=0;t<l;t++){const n=t*h-s;p.push(n,-e,0),m.push(0,0,1),f.push(t/r),f.push(1-g/o)}}for(let g=0;g<o;g++)for(let e=0;e<r;e++){const t=e+l*g,n=e+l*(g+1),i=e+1+l*(g+1),s=e+1+l*g;d.push(t,n,s),d.push(n,i,s)}this.setIndex(d),this.setAttribute("position",new xd(p,3)),this.setAttribute("normal",new xd(m,3)),this.setAttribute("uv",new xd(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new xp(e.width,e.height,e.widthSegments,e.heightSegments)}}class yp extends mp{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new yp(e.radius,e.detail)}}class bp extends hd{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new od(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new od(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new uh(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Tu,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class _p extends hd{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class wp extends hd{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class Sp extends Vu{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new od(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}const Mp=new fu,Tp=new ph,Ep=new ph;class Cp{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new uh(512,512),this.mapType=ql,this.map=null,this.mapPass=null,this.matrix=new fu,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new dp,this._frameExtents=new uh(1,1),this._viewportCount=1,this._viewports=[new Oh(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;Tp.setFromMatrixPosition(e.matrixWorld),t.position.copy(Tp),Ep.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Ep),t.updateMatrixWorld(),Mp.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Mp),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(Mp)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Np extends qd{constructor(e=-1,t=1,n=1,i=-1,s=.1,a=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=i,this.near=s,this.far=a,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,i,s,a){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=s,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let s=n-e,a=n+e,r=i+t,o=i-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;s+=e*this.view.offsetX,a=s+e*this.view.width,r-=t*this.view.offsetY,o=r-t*this.view.height}this.projectionMatrix.makeOrthographic(s,a,r,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class Ap extends Cp{constructor(){super(new Np(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class Rp extends Sp{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Vu.DEFAULT_UP),this.updateMatrix(),this.target=new Vu,this.shadow=new Ap}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class jp extends Sp{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class Pp extends Kd{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class Ip{constructor(e=1,t=0,n=0){this.radius=e,this.phi=t,this.theta=n}set(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=rh(this.phi,e,Math.PI-e),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+t*t+n*n),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(rh(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class Dp extends th{constructor(e,t=null){super(),this.object=e,this.domElement=t,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(e){void 0!==e&&(null!==this.domElement&&this.disconnect(),this.domElement=e)}disconnect(){}dispose(){}update(){}}function kp(e,t,n,i){const s=function(e){switch(e){case ql:case 1010:return{byteLength:1,components:1};case $l:case 1011:case Zl:return{byteLength:2,components:1};case Jl:case Ql:return{byteLength:2,components:4};case Yl:case Xl:case Kl:return{byteLength:4,components:1};case 35902:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(i);switch(n){case 1021:return e*t;case 1028:case sc:return e*t/s.components*s.byteLength;case 1030:case ac:return e*t*2/s.components*s.byteLength;case 1022:return e*t*3/s.components*s.byteLength;case tc:case rc:return e*t*4/s.components*s.byteLength;case oc:case lc:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case cc:case hc:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case dc:case mc:return Math.max(e,16)*Math.max(t,8)/4;case uc:case pc:return Math.max(e,8)*Math.max(t,8)/2;case fc:case gc:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case vc:case xc:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case yc:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case bc:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case _c:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case wc:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case Sc:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Mc:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case Tc:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case Ec:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case Cc:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case Nc:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case Ac:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case Rc:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case jc:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case Pc:case Ic:case Dc:return Math.ceil(e/4)*Math.ceil(t/4)*16;case 36283:case kc:return Math.ceil(e/4)*Math.ceil(t/4)*8;case Lc:case Oc:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${n} format.`)}
/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
function Lp(){let e=null,t=!1,n=null,i=null;function s(t,a){n(t,a),i=e.requestAnimationFrame(s)}return{start:function(){!0!==t&&null!==n&&(i=e.requestAnimationFrame(s),t=!0)},stop:function(){e.cancelAnimationFrame(i),t=!1},setAnimationLoop:function(e){n=e},setContext:function(t){e=t}}}function Op(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(n){n.isInterleavedBufferAttribute&&(n=n.data);const i=t.get(n);i&&(e.deleteBuffer(i.buffer),t.delete(n))},update:function(n,i){if(n.isInterleavedBufferAttribute&&(n=n.data),n.isGLBufferAttribute){const e=t.get(n);return void((!e||e.version<n.version)&&t.set(n,{buffer:n.buffer,type:n.type,bytesPerElement:n.elementSize,version:n.version}))}const s=t.get(n);if(void 0===s)t.set(n,function(t,n){const i=t.array,s=t.usage,a=i.byteLength,r=e.createBuffer();let o;if(e.bindBuffer(n,r),e.bufferData(n,i,s),t.onUploadCallback(),i instanceof Float32Array)o=e.FLOAT;else if("undefined"!=typeof Float16Array&&i instanceof Float16Array)o=e.HALF_FLOAT;else if(i instanceof Uint16Array)o=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(i instanceof Int16Array)o=e.SHORT;else if(i instanceof Uint32Array)o=e.UNSIGNED_INT;else if(i instanceof Int32Array)o=e.INT;else if(i instanceof Int8Array)o=e.BYTE;else if(i instanceof Uint8Array)o=e.UNSIGNED_BYTE;else{if(!(i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+i);o=e.UNSIGNED_BYTE}return{buffer:r,type:o,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version,size:a}}(n,i));else if(s.version<n.version){if(s.size!==n.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,n,i){const s=n.array,a=n.updateRanges;if(e.bindBuffer(i,t),0===a.length)e.bufferSubData(i,0,s);else{a.sort((e,t)=>e.start-t.start);let t=0;for(let e=1;e<a.length;e++){const n=a[t],i=a[e];i.start<=n.start+n.count+1?n.count=Math.max(n.count,i.start+i.count-n.start):(++t,a[t]=i)}a.length=t+1;for(let n=0,r=a.length;n<r;n++){const t=a[n];e.bufferSubData(i,t.start*s.BYTES_PER_ELEMENT,s,t.start,t.count)}n.clearUpdateRanges()}n.onUploadCallback()}(s.buffer,n,i),s.version=n.version}}}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:sl}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__=sl));const Up={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\t\n\t\tfloat lightToPositionLength = length( lightToPosition );\n\t\tif ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\t\tdp += shadowBias;\n\t\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t#else\n\t\t\t\tshadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t#else\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},Fp={common:{diffuse:{value:new od(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new gh},alphaMap:{value:null},alphaMapTransform:{value:new gh},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new gh}},envmap:{envMap:{value:null},envMapRotation:{value:new gh},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new gh}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new gh}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new gh},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new gh},normalScale:{value:new uh(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new gh},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new gh}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new gh}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new gh}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new od(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new od(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new gh},alphaTest:{value:0},uvTransform:{value:new gh}},sprite:{diffuse:{value:new od(16777215)},opacity:{value:1},center:{value:new uh(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new gh},alphaMap:{value:null},alphaMapTransform:{value:new gh},alphaTest:{value:0}}},zp={basic:{uniforms:Vd([Fp.common,Fp.specularmap,Fp.envmap,Fp.aomap,Fp.lightmap,Fp.fog]),vertexShader:Up.meshbasic_vert,fragmentShader:Up.meshbasic_frag},lambert:{uniforms:Vd([Fp.common,Fp.specularmap,Fp.envmap,Fp.aomap,Fp.lightmap,Fp.emissivemap,Fp.bumpmap,Fp.normalmap,Fp.displacementmap,Fp.fog,Fp.lights,{emissive:{value:new od(0)}}]),vertexShader:Up.meshlambert_vert,fragmentShader:Up.meshlambert_frag},phong:{uniforms:Vd([Fp.common,Fp.specularmap,Fp.envmap,Fp.aomap,Fp.lightmap,Fp.emissivemap,Fp.bumpmap,Fp.normalmap,Fp.displacementmap,Fp.fog,Fp.lights,{emissive:{value:new od(0)},specular:{value:new od(1118481)},shininess:{value:30}}]),vertexShader:Up.meshphong_vert,fragmentShader:Up.meshphong_frag},standard:{uniforms:Vd([Fp.common,Fp.envmap,Fp.aomap,Fp.lightmap,Fp.emissivemap,Fp.bumpmap,Fp.normalmap,Fp.displacementmap,Fp.roughnessmap,Fp.metalnessmap,Fp.fog,Fp.lights,{emissive:{value:new od(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Up.meshphysical_vert,fragmentShader:Up.meshphysical_frag},toon:{uniforms:Vd([Fp.common,Fp.aomap,Fp.lightmap,Fp.emissivemap,Fp.bumpmap,Fp.normalmap,Fp.displacementmap,Fp.gradientmap,Fp.fog,Fp.lights,{emissive:{value:new od(0)}}]),vertexShader:Up.meshtoon_vert,fragmentShader:Up.meshtoon_frag},matcap:{uniforms:Vd([Fp.common,Fp.bumpmap,Fp.normalmap,Fp.displacementmap,Fp.fog,{matcap:{value:null}}]),vertexShader:Up.meshmatcap_vert,fragmentShader:Up.meshmatcap_frag},points:{uniforms:Vd([Fp.points,Fp.fog]),vertexShader:Up.points_vert,fragmentShader:Up.points_frag},dashed:{uniforms:Vd([Fp.common,Fp.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Up.linedashed_vert,fragmentShader:Up.linedashed_frag},depth:{uniforms:Vd([Fp.common,Fp.displacementmap]),vertexShader:Up.depth_vert,fragmentShader:Up.depth_frag},normal:{uniforms:Vd([Fp.common,Fp.bumpmap,Fp.normalmap,Fp.displacementmap,{opacity:{value:1}}]),vertexShader:Up.meshnormal_vert,fragmentShader:Up.meshnormal_frag},sprite:{uniforms:Vd([Fp.sprite,Fp.fog]),vertexShader:Up.sprite_vert,fragmentShader:Up.sprite_frag},background:{uniforms:{uvTransform:{value:new gh},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Up.background_vert,fragmentShader:Up.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new gh}},vertexShader:Up.backgroundCube_vert,fragmentShader:Up.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Up.cube_vert,fragmentShader:Up.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Up.equirect_vert,fragmentShader:Up.equirect_frag},distanceRGBA:{uniforms:Vd([Fp.common,Fp.displacementmap,{referencePosition:{value:new ph},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Up.distanceRGBA_vert,fragmentShader:Up.distanceRGBA_frag},shadow:{uniforms:Vd([Fp.lights,Fp.fog,{color:{value:new od(0)},opacity:{value:1}}]),vertexShader:Up.shadow_vert,fragmentShader:Up.shadow_frag}};zp.physical={uniforms:Vd([zp.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new gh},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new gh},clearcoatNormalScale:{value:new uh(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new gh},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new gh},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new gh},sheen:{value:0},sheenColor:{value:new od(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new gh},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new gh},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new gh},transmissionSamplerSize:{value:new uh},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new gh},attenuationDistance:{value:0},attenuationColor:{value:new od(0)},specularColor:{value:new od(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new gh},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new gh},anisotropyVector:{value:new uh},anisotropyMap:{value:null},anisotropyMapTransform:{value:new gh}}]),vertexShader:Up.meshphysical_vert,fragmentShader:Up.meshphysical_frag};const Bp={r:0,b:0,g:0},Vp=new Tu,Hp=new fu;function Wp(e,t,n,i,s,a,r){const o=new od(0);let l,c,h=!0===a?0:1,u=null,d=0,p=null;function m(e){let i=!0===e.isScene?e.background:null;return i&&i.isTexture&&(i=(e.backgroundBlurriness>0?n:t).get(i)),i}function f(t,n){t.getRGB(Bp,Hd(e)),i.buffers.color.setClear(Bp.r,Bp.g,Bp.b,n,r)}return{getClearColor:function(){return o},setClearColor:function(e,t=1){o.set(e),h=t,f(o,h)},getClearAlpha:function(){return h},setClearAlpha:function(e){h=e,f(o,h)},render:function(t){let n=!1;const s=m(t);null===s?f(o,h):s&&s.isColor&&(f(s,1),n=!0);const a=e.xr.getEnvironmentBlendMode();"additive"===a?i.buffers.color.setClear(0,0,0,1,r):"alpha-blend"===a&&i.buffers.color.setClear(0,0,0,0,r),(e.autoClear||n)&&(i.buffers.depth.setTest(!0),i.buffers.depth.setMask(!0),i.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,n){const i=m(n);i&&(i.isCubeTexture||i.mapping===Ll)?(void 0===c&&(c=new Ud(new zd(1,1,1),new Gd({name:"BackgroundCubeMaterial",uniforms:Bd(zp.backgroundCube.uniforms),vertexShader:zp.backgroundCube.vertexShader,fragmentShader:zp.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(c)),Vp.copy(n.backgroundRotation),Vp.x*=-1,Vp.y*=-1,Vp.z*=-1,i.isCubeTexture&&!1===i.isRenderTargetTexture&&(Vp.y*=-1,Vp.z*=-1),c.material.uniforms.envMap.value=i,c.material.uniforms.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=n.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,c.material.uniforms.backgroundRotation.value.setFromMatrix4(Hp.makeRotationFromEuler(Vp)),c.material.toneMapped=Eh.getTransfer(i.colorSpace)!==Vc,u===i&&d===i.version&&p===e.toneMapping||(c.material.needsUpdate=!0,u=i,d=i.version,p=e.toneMapping),c.layers.enableAll(),t.unshift(c,c.geometry,c.material,0,0,null)):i&&i.isTexture&&(void 0===l&&(l=new Ud(new xp(2,2),new Gd({name:"BackgroundMaterial",uniforms:Bd(zp.background.uniforms),vertexShader:zp.background.vertexShader,fragmentShader:zp.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(l)),l.material.uniforms.t2D.value=i,l.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,l.material.toneMapped=Eh.getTransfer(i.colorSpace)!==Vc,!0===i.matrixAutoUpdate&&i.updateMatrix(),l.material.uniforms.uvTransform.value.copy(i.matrix),u===i&&d===i.version&&p===e.toneMapping||(l.material.needsUpdate=!0,u=i,d=i.version,p=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==c&&(c.geometry.dispose(),c.material.dispose(),c=void 0),void 0!==l&&(l.geometry.dispose(),l.material.dispose(),l=void 0)}}}function Gp(e,t){const n=e.getParameter(e.MAX_VERTEX_ATTRIBS),i={},s=c(null);let a=s,r=!1;function o(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function c(e){const t=[],i=[],s=[];for(let a=0;a<n;a++)t[a]=0,i[a]=0,s[a]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:s,object:e,attributes:{},index:null}}function h(){const e=a.newAttributes;for(let t=0,n=e.length;t<n;t++)e[t]=0}function u(e){d(e,0)}function d(t,n){const i=a.newAttributes,s=a.enabledAttributes,r=a.attributeDivisors;i[t]=1,0===s[t]&&(e.enableVertexAttribArray(t),s[t]=1),r[t]!==n&&(e.vertexAttribDivisor(t,n),r[t]=n)}function p(){const t=a.newAttributes,n=a.enabledAttributes;for(let i=0,s=n.length;i<s;i++)n[i]!==t[i]&&(e.disableVertexAttribArray(i),n[i]=0)}function m(t,n,i,s,a,r,o){!0===o?e.vertexAttribIPointer(t,n,i,a,r):e.vertexAttribPointer(t,n,i,s,a,r)}function f(){g(),r=!0,a!==s&&(a=s,o(a.object))}function g(){s.geometry=null,s.program=null,s.wireframe=!1}return{setup:function(n,s,l,f,g){let v=!1;const x=function(t,n,s){const a=!0===s.wireframe;let r=i[t.id];void 0===r&&(r={},i[t.id]=r);let o=r[n.id];void 0===o&&(o={},r[n.id]=o);let l=o[a];return void 0===l&&(l=c(e.createVertexArray()),o[a]=l),l}(f,l,s);a!==x&&(a=x,o(a.object)),v=function(e,t,n,i){const s=a.attributes,r=t.attributes;let o=0;const l=n.getAttributes();for(const a in l)if(l[a].location>=0){const t=s[a];let n=r[a];if(void 0===n&&("instanceMatrix"===a&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===a&&e.instanceColor&&(n=e.instanceColor)),void 0===t)return!0;if(t.attribute!==n)return!0;if(n&&t.data!==n.data)return!0;o++}return a.attributesNum!==o||a.index!==i}(n,f,l,g),v&&function(e,t,n,i){const s={},r=t.attributes;let o=0;const l=n.getAttributes();for(const a in l)if(l[a].location>=0){let t=r[a];void 0===t&&("instanceMatrix"===a&&e.instanceMatrix&&(t=e.instanceMatrix),"instanceColor"===a&&e.instanceColor&&(t=e.instanceColor));const n={};n.attribute=t,t&&t.data&&(n.data=t.data),s[a]=n,o++}a.attributes=s,a.attributesNum=o,a.index=i}(n,f,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(v||r)&&(r=!1,function(n,i,s,a){h();const r=a.attributes,o=s.getAttributes(),l=i.defaultAttributeValues;for(const c in o){const i=o[c];if(i.location>=0){let s=r[c];if(void 0===s&&("instanceMatrix"===c&&n.instanceMatrix&&(s=n.instanceMatrix),"instanceColor"===c&&n.instanceColor&&(s=n.instanceColor)),void 0!==s){const r=s.normalized,o=s.itemSize,l=t.get(s);if(void 0===l)continue;const c=l.buffer,h=l.type,p=l.bytesPerElement,f=h===e.INT||h===e.UNSIGNED_INT||s.gpuType===Xl;if(s.isInterleavedBufferAttribute){const t=s.data,l=t.stride,g=s.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<i.locationSize;e++)d(i.location+e,t.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<i.locationSize;e++)u(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<i.locationSize;e++)m(i.location+e,o/i.locationSize,h,r,l*p,(g+o/i.locationSize*e)*p,f)}else{if(s.isInstancedBufferAttribute){for(let e=0;e<i.locationSize;e++)d(i.location+e,s.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=s.meshPerAttribute*s.count)}else for(let e=0;e<i.locationSize;e++)u(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<i.locationSize;e++)m(i.location+e,o/i.locationSize,h,r,o*p,o/i.locationSize*e*p,f)}}else if(void 0!==l){const t=l[c];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(i.location,t);break;case 3:e.vertexAttrib3fv(i.location,t);break;case 4:e.vertexAttrib4fv(i.location,t);break;default:e.vertexAttrib1fv(i.location,t)}}}}p()}(n,s,l,f),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:f,resetDefaultState:g,dispose:function(){f();for(const e in i){const t=i[e];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete i[e]}},releaseStatesOfGeometry:function(e){if(void 0===i[e.id])return;const t=i[e.id];for(const n in t){const e=t[n];for(const t in e)l(e[t].object),delete e[t];delete t[n]}delete i[e.id]},releaseStatesOfProgram:function(e){for(const t in i){const n=i[t];if(void 0===n[e.id])continue;const s=n[e.id];for(const e in s)l(s[e].object),delete s[e];delete n[e.id]}},initAttributes:h,enableAttribute:u,disableUnusedAttributes:p}}function qp(e,t,n){let i;function s(t,s,a){0!==a&&(e.drawArraysInstanced(i,t,s,a),n.update(s,i,a))}this.setMode=function(e){i=e},this.render=function(t,s){e.drawArrays(i,t,s),n.update(s,i,1)},this.renderInstances=s,this.renderMultiDraw=function(e,s,a){if(0===a)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(i,e,0,s,0,a);let r=0;for(let t=0;t<a;t++)r+=s[t];n.update(r,i,1)},this.renderMultiDrawInstances=function(e,a,r,o){if(0===r)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)s(e[t],a[t],o[t]);else{l.multiDrawArraysInstancedWEBGL(i,e,0,a,0,o,0,r);let t=0;for(let e=0;e<r;e++)t+=a[e]*o[e];n.update(t,i,1)}}}function $p(e,t,n,i){let s;function a(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let r=void 0!==n.precision?n.precision:"highp";const o=a(r);o!==r&&(r=o);const l=!0===n.logarithmicDepthBuffer,c=!0===n.reverseDepthBuffer&&t.has("EXT_clip_control"),h=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==s)return s;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");s=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else s=0;return s},getMaxPrecision:a,textureFormatReadable:function(t){return t===tc||i.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(n){const s=n===Zl&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(n!==ql&&i.convert(n)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&n!==Kl&&!s)},precision:r,logarithmicDepthBuffer:l,reverseDepthBuffer:c,maxTextures:h,maxVertexTextures:u,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),vertexTextures:u>0,maxSamples:e.getParameter(e.MAX_SAMPLES)}}function Xp(e){const t=this;let n=null,i=0,s=!1,a=!1;const r=new lp,o=new gh,l={value:null,needsUpdate:!1};function c(e,n,i,s){const a=null!==e?e.length:0;let c=null;if(0!==a){if(c=l.value,!0!==s||null===c){const t=i+4*a,s=n.matrixWorldInverse;o.getNormalMatrix(s),(null===c||c.length<t)&&(c=new Float32Array(t));for(let n=0,l=i;n!==a;++n,l+=4)r.copy(e[n]).applyMatrix4(s,o),r.normal.toArray(c,l),c[l+3]=r.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=a,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const n=0!==e.length||t||0!==i||s;return s=t,i=e.length,n},this.beginShadows=function(){a=!0,c(null)},this.endShadows=function(){a=!1},this.setGlobalState=function(e,t){n=c(e,t,0)},this.setState=function(r,o,h){const u=r.clippingPlanes,d=r.clipIntersection,p=r.clipShadows,m=e.get(r);if(!s||null===u||0===u.length||a&&!p)a?c(null):(l.value!==n&&(l.value=n,l.needsUpdate=i>0),t.numPlanes=i,t.numIntersection=0);else{const e=a?0:i,t=4*e;let s=m.clippingState||null;l.value=s,s=c(u,o,t,h);for(let i=0;i!==t;++i)s[i]=n[i];m.clippingState=s,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function Yp(e){let t=new WeakMap;function n(e,t){return 303===t?e.mapping=Dl:304===t&&(e.mapping=kl),e}function i(e){const n=e.target;n.removeEventListener("dispose",i);const s=t.get(n);void 0!==s&&(t.delete(n),s.dispose())}return{get:function(s){if(s&&s.isTexture){const a=s.mapping;if(303===a||304===a){if(t.has(s))return n(t.get(s).texture,s.mapping);{const a=s.image;if(a&&a.height>0){const r=new ep(a.height);return r.fromEquirectangularTexture(e,s),t.set(s,r),s.addEventListener("dispose",i),n(r.texture,s.mapping)}return null}}}return s},dispose:function(){t=new WeakMap}}}const Kp=[.125,.215,.35,.446,.526,.582],Zp=new Np,Jp=new od;let Qp=null,em=0,tm=0,nm=!1;const im=(1+Math.sqrt(5))/2,sm=1/im,am=[new ph(-im,sm,0),new ph(im,sm,0),new ph(-sm,0,im),new ph(sm,0,im),new ph(0,im,-sm),new ph(0,im,sm),new ph(-1,1,-1),new ph(1,1,-1),new ph(-1,1,1),new ph(1,1,1)],rm=new ph;class om{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,i=100,s={}){const{size:a=256,position:r=rm}=s;Qp=this._renderer.getRenderTarget(),em=this._renderer.getActiveCubeFace(),tm=this._renderer.getActiveMipmapLevel(),nm=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(a);const o=this._allocateTargets();return o.depthBuffer=!0,this._sceneToCubeUV(e,n,i,o,r),t>0&&this._blur(o,0,0,t),this._applyPMREM(o),this._cleanup(o),o}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=um(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=hm(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(Qp,em,tm),this._renderer.xr.enabled=nm,e.scissorTest=!1,cm(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===Dl||e.mapping===kl?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),Qp=this._renderer.getRenderTarget(),em=this._renderer.getActiveCubeFace(),tm=this._renderer.getActiveMipmapLevel(),nm=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:Hl,minFilter:Hl,generateMipmaps:!1,type:Zl,format:tc,colorSpace:zc,depthBuffer:!1},i=lm(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=lm(e,t,n);const{_lodMax:i}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],n=[],i=[];let s=e;const a=e-4+1+Kp.length;for(let r=0;r<a;r++){const a=Math.pow(2,s);n.push(a);let o=1/a;r>e-4?o=Kp[r-e+4-1]:0===r&&(o=0),i.push(o);const l=1/(a-2),c=-l,h=1+l,u=[c,c,h,c,h,h,c,c,h,h,c,h],d=6,p=6,m=3,f=2,g=1,v=new Float32Array(m*p*d),x=new Float32Array(f*p*d),y=new Float32Array(g*p*d);for(let e=0;e<d;e++){const t=e%3*2/3-1,n=e>2?0:-1,i=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0];v.set(i,m*p*e),x.set(u,f*p*e);const s=[e,e,e,e,e,e];y.set(s,g*p*e)}const b=new Ed;b.setAttribute("position",new fd(v,m)),b.setAttribute("uv",new fd(x,f)),b.setAttribute("faceIndex",new fd(y,g)),t.push(b),s>4&&s--}return{lodPlanes:t,sizeLods:n,sigmas:i}}(i)),this._blurMaterial=function(e,t,n){const i=new Float32Array(20),s=new ph(0,1,0);return new Gd({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:i},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}(i,e,t)}return i}_compileMaterial(e){const t=new Ud(this._lodPlanes[0],e);this._renderer.compile(t,Zp)}_sceneToCubeUV(e,t,n,i,s){const a=new Kd(90,1,t,n),r=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],l=this._renderer,c=l.autoClear,h=l.toneMapping;l.getClearColor(Jp),l.toneMapping=0,l.autoClear=!1;const u=new ud({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),d=new Ud(new zd,u);let p=!1;const m=e.background;m?m.isColor&&(u.color.copy(m),e.background=null,p=!0):(u.color.copy(Jp),p=!0);for(let f=0;f<6;f++){const t=f%3;0===t?(a.up.set(0,r[f],0),a.position.set(s.x,s.y,s.z),a.lookAt(s.x+o[f],s.y,s.z)):1===t?(a.up.set(0,0,r[f]),a.position.set(s.x,s.y,s.z),a.lookAt(s.x,s.y+o[f],s.z)):(a.up.set(0,r[f],0),a.position.set(s.x,s.y,s.z),a.lookAt(s.x,s.y,s.z+o[f]));const n=this._cubeSize;cm(i,t*n,f>2?n:0,n,n),l.setRenderTarget(i),p&&l.render(d,a),l.render(e,a)}d.geometry.dispose(),d.material.dispose(),l.toneMapping=h,l.autoClear=c,e.background=m}_textureToCubeUV(e,t){const n=this._renderer,i=e.mapping===Dl||e.mapping===kl;i?(null===this._cubemapMaterial&&(this._cubemapMaterial=um()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=hm());const s=i?this._cubemapMaterial:this._equirectMaterial,a=new Ud(this._lodPlanes[0],s);s.uniforms.envMap.value=e;const r=this._cubeSize;cm(t,0,0,3*r,2*r),n.setRenderTarget(t),n.render(a,Zp)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const i=this._lodPlanes.length;for(let s=1;s<i;s++){const t=Math.sqrt(this._sigmas[s]*this._sigmas[s]-this._sigmas[s-1]*this._sigmas[s-1]),n=am[(i-s-1)%am.length];this._blur(e,s-1,s,t,n)}t.autoClear=n}_blur(e,t,n,i,s){const a=this._pingPongRenderTarget;this._halfBlur(e,a,t,n,i,"latitudinal",s),this._halfBlur(a,e,n,n,i,"longitudinal",s)}_halfBlur(e,t,n,i,s,a,r){const o=this._renderer,l=this._blurMaterial,c=new Ud(this._lodPlanes[i],l),h=l.uniforms,u=this._sizeLods[n]-1,d=isFinite(s)?Math.PI/(2*u):2*Math.PI/39,p=s/d,m=isFinite(s)?1+Math.floor(3*p):20,f=[];let g=0;for(let y=0;y<20;++y){const e=y/p,t=Math.exp(-e*e/2);f.push(t),0===y?g+=t:y<m&&(g+=2*t)}for(let y=0;y<f.length;y++)f[y]=f[y]/g;h.envMap.value=e.texture,h.samples.value=m,h.weights.value=f,h.latitudinal.value="latitudinal"===a,r&&(h.poleAxis.value=r);const{_lodMax:v}=this;h.dTheta.value=d,h.mipInt.value=v-n;const x=this._sizeLods[i];cm(t,3*x*(i>v-4?i-v+4:0),4*(this._cubeSize-x),3*x,2*x),o.setRenderTarget(t),o.render(c,Zp)}}function lm(e,t,n){const i=new Fh(e,t,n);return i.texture.mapping=Ll,i.texture.name="PMREM.cubeUv",i.scissorTest=!0,i}function cm(e,t,n,i,s){e.viewport.set(t,n,i,s),e.scissor.set(t,n,i,s)}function hm(){return new Gd({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function um(){return new Gd({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function dm(e){let t=new WeakMap,n=null;function i(e){const n=e.target;n.removeEventListener("dispose",i);const s=t.get(n);void 0!==s&&(t.delete(n),s.dispose())}return{get:function(s){if(s&&s.isTexture){const a=s.mapping,r=303===a||304===a,o=a===Dl||a===kl;if(r||o){let a=t.get(s);const l=void 0!==a?a.texture.pmremVersion:0;if(s.isRenderTargetTexture&&s.pmremVersion!==l)return null===n&&(n=new om(e)),a=r?n.fromEquirectangular(s,a):n.fromCubemap(s,a),a.texture.pmremVersion=s.pmremVersion,t.set(s,a),a.texture;if(void 0!==a)return a.texture;{const l=s.image;return r&&l&&l.height>0||o&&l&&function(e){let t=0;for(let n=0;n<6;n++)void 0!==e[n]&&t++;return 6===t}(l)?(null===n&&(n=new om(e)),a=r?n.fromEquirectangular(s):n.fromCubemap(s),a.texture.pmremVersion=s.pmremVersion,t.set(s,a),s.addEventListener("dispose",i),a.texture):null}}}return s},dispose:function(){t=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function pm(e){const t={};function n(n){if(void 0!==t[n])return t[n];let i;switch(n){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(n)}return t[n]=i,i}return{has:function(e){return null!==n(e)},init:function(){n("EXT_color_buffer_float"),n("WEBGL_clip_cull_distance"),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture"),n("WEBGL_render_shared_exponent")},get:function(e){const t=n(e);return null===t&&wh("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function mm(e,t,n,i){const s={},a=new WeakMap;function r(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const n in o.attributes)t.remove(o.attributes[n]);o.removeEventListener("dispose",r),delete s[o.id];const l=a.get(o);l&&(t.remove(l),a.delete(o)),i.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,n.memory.geometries--}function o(e){const n=[],i=e.index,s=e.attributes.position;let r=0;if(null!==i){const e=i.array;r=i.version;for(let t=0,i=e.length;t<i;t+=3){const i=e[t+0],s=e[t+1],a=e[t+2];n.push(i,s,s,a,a,i)}}else{if(void 0===s)return;{const e=s.array;r=s.version;for(let t=0,i=e.length/3-1;t<i;t+=3){const e=t+0,i=t+1,s=t+2;n.push(e,i,i,s,s,e)}}}const o=new(xh(n)?vd:gd)(n,1);o.version=r;const l=a.get(e);l&&t.remove(l),a.set(e,o)}return{get:function(e,t){return!0===s[t.id]||(t.addEventListener("dispose",r),s[t.id]=!0,n.memory.geometries++),t},update:function(n){const i=n.attributes;for(const s in i)t.update(i[s],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){const t=a.get(e);if(t){const n=e.index;null!==n&&t.version<n.version&&o(e)}else o(e);return a.get(e)}}}function fm(e,t,n){let i,s,a;function r(t,r,o){0!==o&&(e.drawElementsInstanced(i,r,s,t*a,o),n.update(r,i,o))}this.setMode=function(e){i=e},this.setIndex=function(e){s=e.type,a=e.bytesPerElement},this.render=function(t,r){e.drawElements(i,r,s,t*a),n.update(r,i,1)},this.renderInstances=r,this.renderMultiDraw=function(e,a,r){if(0===r)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(i,a,0,s,e,0,r);let o=0;for(let t=0;t<r;t++)o+=a[t];n.update(o,i,1)},this.renderMultiDrawInstances=function(e,o,l,c){if(0===l)return;const h=t.get("WEBGL_multi_draw");if(null===h)for(let t=0;t<e.length;t++)r(e[t]/a,o[t],c[t]);else{h.multiDrawElementsInstancedWEBGL(i,o,0,s,e,0,c,0,l);let t=0;for(let e=0;e<l;e++)t+=o[e]*c[e];n.update(t,i,1)}}}function gm(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(n,i,s){switch(t.calls++,i){case e.TRIANGLES:t.triangles+=s*(n/3);break;case e.LINES:t.lines+=s*(n/2);break;case e.LINE_STRIP:t.lines+=s*(n-1);break;case e.LINE_LOOP:t.lines+=s*n;break;case e.POINTS:t.points+=s*n}}}}function vm(e,t,n){const i=new WeakMap,s=new Oh;return{update:function(a,r,o){const l=a.morphTargetInfluences,c=r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color,h=void 0!==c?c.length:0;let u=i.get(r);if(void 0===u||u.count!==h){let e=function(){v.dispose(),i.delete(r),r.removeEventListener("dispose",e)};void 0!==u&&u.texture.dispose();const n=void 0!==r.morphAttributes.position,a=void 0!==r.morphAttributes.normal,o=void 0!==r.morphAttributes.color,l=r.morphAttributes.position||[],c=r.morphAttributes.normal||[],d=r.morphAttributes.color||[];let p=0;!0===n&&(p=1),!0===a&&(p=2),!0===o&&(p=3);let m=r.attributes.position.count*p,f=1;m>t.maxTextureSize&&(f=Math.ceil(m/t.maxTextureSize),m=t.maxTextureSize);const g=new Float32Array(m*f*4*h),v=new zh(g,m,f,h);v.type=Kl,v.needsUpdate=!0;const x=4*p;for(let t=0;t<h;t++){const e=l[t],i=c[t],r=d[t],h=m*f*4*t;for(let t=0;t<e.count;t++){const l=t*x;!0===n&&(s.fromBufferAttribute(e,t),g[h+l+0]=s.x,g[h+l+1]=s.y,g[h+l+2]=s.z,g[h+l+3]=0),!0===a&&(s.fromBufferAttribute(i,t),g[h+l+4]=s.x,g[h+l+5]=s.y,g[h+l+6]=s.z,g[h+l+7]=0),!0===o&&(s.fromBufferAttribute(r,t),g[h+l+8]=s.x,g[h+l+9]=s.y,g[h+l+10]=s.z,g[h+l+11]=4===r.itemSize?s.w:1)}}u={count:h,texture:v,size:new uh(m,f)},i.set(r,u),r.addEventListener("dispose",e)}if(!0===a.isInstancedMesh&&null!==a.morphTexture)o.getUniforms().setValue(e,"morphTexture",a.morphTexture,n);else{let t=0;for(let e=0;e<l.length;e++)t+=l[e];const n=r.morphTargetsRelative?1:1-t;o.getUniforms().setValue(e,"morphTargetBaseInfluence",n),o.getUniforms().setValue(e,"morphTargetInfluences",l)}o.getUniforms().setValue(e,"morphTargetsTexture",u.texture,n),o.getUniforms().setValue(e,"morphTargetsTextureSize",u.size)}}}function xm(e,t,n,i){let s=new WeakMap;function a(e){const t=e.target;t.removeEventListener("dispose",a),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(r){const o=i.render.frame,l=r.geometry,c=t.get(r,l);if(s.get(c)!==o&&(t.update(c),s.set(c,o)),r.isInstancedMesh&&(!1===r.hasEventListener("dispose",a)&&r.addEventListener("dispose",a),s.get(r)!==o&&(n.update(r.instanceMatrix,e.ARRAY_BUFFER),null!==r.instanceColor&&n.update(r.instanceColor,e.ARRAY_BUFFER),s.set(r,o))),r.isSkinnedMesh){const e=r.skeleton;s.get(e)!==o&&(e.update(),s.set(e,o))}return c},dispose:function(){s=new WeakMap}}}const ym=new Lh,bm=new pp(1,1),_m=new zh,wm=new Bh,Sm=new Qd,Mm=[],Tm=[],Em=new Float32Array(16),Cm=new Float32Array(9),Nm=new Float32Array(4);function Am(e,t,n){const i=e[0];if(i<=0||i>0)return e;const s=t*n;let a=Mm[s];if(void 0===a&&(a=new Float32Array(s),Mm[s]=a),0!==t){i.toArray(a,0);for(let i=1,s=0;i!==t;++i)s+=n,e[i].toArray(a,s)}return a}function Rm(e,t){if(e.length!==t.length)return!1;for(let n=0,i=e.length;n<i;n++)if(e[n]!==t[n])return!1;return!0}function jm(e,t){for(let n=0,i=t.length;n<i;n++)e[n]=t[n]}function Pm(e,t){let n=Tm[t];void 0===n&&(n=new Int32Array(t),Tm[t]=n);for(let i=0;i!==t;++i)n[i]=e.allocateTextureUnit();return n}function Im(e,t){const n=this.cache;n[0]!==t&&(e.uniform1f(this.addr,t),n[0]=t)}function Dm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Rm(n,t))return;e.uniform2fv(this.addr,t),jm(n,t)}}function km(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else if(void 0!==t.r)n[0]===t.r&&n[1]===t.g&&n[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),n[0]=t.r,n[1]=t.g,n[2]=t.b);else{if(Rm(n,t))return;e.uniform3fv(this.addr,t),jm(n,t)}}function Lm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Rm(n,t))return;e.uniform4fv(this.addr,t),jm(n,t)}}function Om(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(Rm(n,t))return;e.uniformMatrix2fv(this.addr,!1,t),jm(n,t)}else{if(Rm(n,i))return;Nm.set(i),e.uniformMatrix2fv(this.addr,!1,Nm),jm(n,i)}}function Um(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(Rm(n,t))return;e.uniformMatrix3fv(this.addr,!1,t),jm(n,t)}else{if(Rm(n,i))return;Cm.set(i),e.uniformMatrix3fv(this.addr,!1,Cm),jm(n,i)}}function Fm(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(Rm(n,t))return;e.uniformMatrix4fv(this.addr,!1,t),jm(n,t)}else{if(Rm(n,i))return;Em.set(i),e.uniformMatrix4fv(this.addr,!1,Em),jm(n,i)}}function zm(e,t){const n=this.cache;n[0]!==t&&(e.uniform1i(this.addr,t),n[0]=t)}function Bm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Rm(n,t))return;e.uniform2iv(this.addr,t),jm(n,t)}}function Vm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(Rm(n,t))return;e.uniform3iv(this.addr,t),jm(n,t)}}function Hm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Rm(n,t))return;e.uniform4iv(this.addr,t),jm(n,t)}}function Wm(e,t){const n=this.cache;n[0]!==t&&(e.uniform1ui(this.addr,t),n[0]=t)}function Gm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Rm(n,t))return;e.uniform2uiv(this.addr,t),jm(n,t)}}function qm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(Rm(n,t))return;e.uniform3uiv(this.addr,t),jm(n,t)}}function $m(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Rm(n,t))return;e.uniform4uiv(this.addr,t),jm(n,t)}}function Xm(e,t,n){const i=this.cache,s=n.allocateTextureUnit();let a;i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),this.type===e.SAMPLER_2D_SHADOW?(bm.compareFunction=515,a=bm):a=ym,n.setTexture2D(t||a,s)}function Ym(e,t,n){const i=this.cache,s=n.allocateTextureUnit();i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),n.setTexture3D(t||wm,s)}function Km(e,t,n){const i=this.cache,s=n.allocateTextureUnit();i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),n.setTextureCube(t||Sm,s)}function Zm(e,t,n){const i=this.cache,s=n.allocateTextureUnit();i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),n.setTexture2DArray(t||_m,s)}function Jm(e,t){e.uniform1fv(this.addr,t)}function Qm(e,t){const n=Am(t,this.size,2);e.uniform2fv(this.addr,n)}function ef(e,t){const n=Am(t,this.size,3);e.uniform3fv(this.addr,n)}function tf(e,t){const n=Am(t,this.size,4);e.uniform4fv(this.addr,n)}function nf(e,t){const n=Am(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,n)}function sf(e,t){const n=Am(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,n)}function af(e,t){const n=Am(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,n)}function rf(e,t){e.uniform1iv(this.addr,t)}function of(e,t){e.uniform2iv(this.addr,t)}function lf(e,t){e.uniform3iv(this.addr,t)}function cf(e,t){e.uniform4iv(this.addr,t)}function hf(e,t){e.uniform1uiv(this.addr,t)}function uf(e,t){e.uniform2uiv(this.addr,t)}function df(e,t){e.uniform3uiv(this.addr,t)}function pf(e,t){e.uniform4uiv(this.addr,t)}function mf(e,t,n){const i=this.cache,s=t.length,a=Pm(n,s);Rm(i,a)||(e.uniform1iv(this.addr,a),jm(i,a));for(let r=0;r!==s;++r)n.setTexture2D(t[r]||ym,a[r])}function ff(e,t,n){const i=this.cache,s=t.length,a=Pm(n,s);Rm(i,a)||(e.uniform1iv(this.addr,a),jm(i,a));for(let r=0;r!==s;++r)n.setTexture3D(t[r]||wm,a[r])}function gf(e,t,n){const i=this.cache,s=t.length,a=Pm(n,s);Rm(i,a)||(e.uniform1iv(this.addr,a),jm(i,a));for(let r=0;r!==s;++r)n.setTextureCube(t[r]||Sm,a[r])}function vf(e,t,n){const i=this.cache,s=t.length,a=Pm(n,s);Rm(i,a)||(e.uniform1iv(this.addr,a),jm(i,a));for(let r=0;r!==s;++r)n.setTexture2DArray(t[r]||_m,a[r])}class xf{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return Im;case 35664:return Dm;case 35665:return km;case 35666:return Lm;case 35674:return Om;case 35675:return Um;case 35676:return Fm;case 5124:case 35670:return zm;case 35667:case 35671:return Bm;case 35668:case 35672:return Vm;case 35669:case 35673:return Hm;case 5125:return Wm;case 36294:return Gm;case 36295:return qm;case 36296:return $m;case 35678:case 36198:case 36298:case 36306:case 35682:return Xm;case 35679:case 36299:case 36307:return Ym;case 35680:case 36300:case 36308:case 36293:return Km;case 36289:case 36303:case 36311:case 36292:return Zm}}(t.type)}}class yf{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return Jm;case 35664:return Qm;case 35665:return ef;case 35666:return tf;case 35674:return nf;case 35675:return sf;case 35676:return af;case 5124:case 35670:return rf;case 35667:case 35671:return of;case 35668:case 35672:return lf;case 35669:case 35673:return cf;case 5125:return hf;case 36294:return uf;case 36295:return df;case 36296:return pf;case 35678:case 36198:case 36298:case 36306:case 35682:return mf;case 35679:case 36299:case 36307:return ff;case 35680:case 36300:case 36308:case 36293:return gf;case 36289:case 36303:case 36311:case 36292:return vf}}(t.type)}}class bf{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,n){const i=this.seq;for(let s=0,a=i.length;s!==a;++s){const a=i[s];a.setValue(e,t[a.id],n)}}}const _f=/(\w+)(\])?(\[|\.)?/g;function wf(e,t){e.seq.push(t),e.map[t.id]=t}function Sf(e,t,n){const i=e.name,s=i.length;for(_f.lastIndex=0;;){const a=_f.exec(i),r=_f.lastIndex;let o=a[1];const l="]"===a[2],c=a[3];if(l&&(o|=0),void 0===c||"["===c&&r+2===s){wf(n,void 0===c?new xf(o,e,t):new yf(o,e,t));break}{let e=n.map[o];void 0===e&&(e=new bf(o),wf(n,e)),n=e}}}class Mf{constructor(e,t){this.seq=[],this.map={};const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){const n=e.getActiveUniform(t,i);Sf(n,e.getUniformLocation(t,n.name),this)}}setValue(e,t,n,i){const s=this.map[t];void 0!==s&&s.setValue(e,n,i)}setOptional(e,t,n){const i=t[n];void 0!==i&&this.setValue(e,n,i)}static upload(e,t,n,i){for(let s=0,a=t.length;s!==a;++s){const a=t[s],r=n[a.id];!1!==r.needsUpdate&&a.setValue(e,r.value,i)}}static seqWithValue(e,t){const n=[];for(let i=0,s=e.length;i!==s;++i){const s=e[i];s.id in t&&n.push(s)}return n}}function Tf(e,t,n){const i=e.createShader(t);return e.shaderSource(i,n),e.compileShader(i),i}let Ef=0;const Cf=new gh;function Nf(e,t,n){const i=e.getShaderParameter(t,e.COMPILE_STATUS),s=e.getShaderInfoLog(t).trim();if(i&&""===s)return"";const a=/ERROR: 0:(\d+)/.exec(s);if(a){const i=parseInt(a[1]);return n.toUpperCase()+"\n\n"+s+"\n\n"+function(e,t){const n=e.split("\n"),i=[],s=Math.max(t-6,0),a=Math.min(t+6,n.length);for(let r=s;r<a;r++){const e=r+1;i.push(`${e===t?">":" "} ${e}: ${n[r]}`)}return i.join("\n")}(e.getShaderSource(t),i)}return s}function Af(e,t){const n=function(e){Eh._getMatrix(Cf,Eh.workingColorSpace,e);const t=`mat3( ${Cf.elements.map(e=>e.toFixed(4))} )`;switch(Eh.getTransfer(e)){case Bc:return[t,"LinearTransferOETF"];case Vc:return[t,"sRGBTransferOETF"];default:return[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${n[1]}( vec4( value.rgb * ${n[0]}, value.a ) );`,"}"].join("\n")}function Rf(e,t){let n;switch(t){case 1:default:n="Linear";break;case 2:n="Reinhard";break;case 3:n="Cineon";break;case 4:n="ACESFilmic";break;case 6:n="AgX";break;case 7:n="Neutral";break;case 5:n="Custom"}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}const jf=new ph;function Pf(e){return""!==e}function If(e,t){const n=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,n).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function Df(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const kf=/^[ \t]*#include +<([\w\d./]+)>/gm;function Lf(e){return e.replace(kf,Uf)}const Of=new Map;function Uf(e,t){let n=Up[t];if(void 0===n){const e=Of.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");n=Up[e]}return Lf(n)}const Ff=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function zf(e){return e.replace(Ff,Bf)}function Bf(e,t,n,i){let s="";for(let a=parseInt(t);a<parseInt(n);a++)s+=i.replace(/\[\s*i\s*\]/g,"[ "+a+" ]").replace(/UNROLLED_LOOP_INDEX/g,a);return s}function Vf(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Hf(e,t,n,i){const s=e.getContext(),a=n.defines;let r=n.vertexShader,o=n.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(n),c=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case Dl:case kl:t="ENVMAP_TYPE_CUBE";break;case Ll:t="ENVMAP_TYPE_CUBE_UV"}return t}(n),h=function(e){let t="ENVMAP_MODE_REFLECTION";return e.envMap&&e.envMapMode===kl&&(t="ENVMAP_MODE_REFRACTION"),t}(n),u=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(n),d=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const n=Math.log2(t)-2,i=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:i,maxMip:n}}(n),p=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(Pf).join("\n")}(n),m=function(e){const t=[];for(const n in e){const i=e[n];!1!==i&&t.push("#define "+n+" "+i)}return t.join("\n")}(a),f=s.createProgram();let g,v,x=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(g=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m].filter(Pf).join("\n"),g.length>0&&(g+="\n"),v=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m].filter(Pf).join("\n"),v.length>0&&(v+="\n")):(g=[Vf(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m,n.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",n.batching?"#define USE_BATCHING":"",n.batchingColor?"#define USE_BATCHING_COLOR":"",n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.instancingMorph?"#define USE_INSTANCING_MORPH":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+h:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.displacementMap?"#define USE_DISPLACEMENTMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.mapUv?"#define MAP_UV "+n.mapUv:"",n.alphaMapUv?"#define ALPHAMAP_UV "+n.alphaMapUv:"",n.lightMapUv?"#define LIGHTMAP_UV "+n.lightMapUv:"",n.aoMapUv?"#define AOMAP_UV "+n.aoMapUv:"",n.emissiveMapUv?"#define EMISSIVEMAP_UV "+n.emissiveMapUv:"",n.bumpMapUv?"#define BUMPMAP_UV "+n.bumpMapUv:"",n.normalMapUv?"#define NORMALMAP_UV "+n.normalMapUv:"",n.displacementMapUv?"#define DISPLACEMENTMAP_UV "+n.displacementMapUv:"",n.metalnessMapUv?"#define METALNESSMAP_UV "+n.metalnessMapUv:"",n.roughnessMapUv?"#define ROUGHNESSMAP_UV "+n.roughnessMapUv:"",n.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+n.anisotropyMapUv:"",n.clearcoatMapUv?"#define CLEARCOATMAP_UV "+n.clearcoatMapUv:"",n.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+n.clearcoatNormalMapUv:"",n.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+n.clearcoatRoughnessMapUv:"",n.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+n.iridescenceMapUv:"",n.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+n.iridescenceThicknessMapUv:"",n.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+n.sheenColorMapUv:"",n.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+n.sheenRoughnessMapUv:"",n.specularMapUv?"#define SPECULARMAP_UV "+n.specularMapUv:"",n.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+n.specularColorMapUv:"",n.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+n.specularIntensityMapUv:"",n.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+n.transmissionMapUv:"",n.thicknessMapUv?"#define THICKNESSMAP_UV "+n.thicknessMapUv:"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Pf).join("\n"),v=[Vf(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+c:"",n.envMap?"#define "+h:"",n.envMap?"#define "+u:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.dispersion?"#define USE_DISPERSION":"",n.iridescence?"#define USE_IRIDESCENCE":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor||n.batchingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==n.toneMapping?"#define TONE_MAPPING":"",0!==n.toneMapping?Up.tonemapping_pars_fragment:"",0!==n.toneMapping?Rf("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",Up.colorspace_pars_fragment,Af("linearToOutputTexel",n.outputColorSpace),(Eh.getLuminanceCoefficients(jf),["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${jf.x.toFixed(4)}, ${jf.y.toFixed(4)}, ${jf.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(Pf).join("\n")),r=Lf(r),r=If(r,n),r=Df(r,n),o=Lf(o),o=If(o,n),o=Df(o,n),r=zf(r),o=zf(o),!0!==n.isRawShaderMaterial&&(x="#version 300 es\n",g=[p,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["#define varying in",n.glslVersion===Jc?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===Jc?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);const y=x+g+r,b=x+v+o,_=Tf(s,s.VERTEX_SHADER,y),w=Tf(s,s.FRAGMENT_SHADER,b);function S(t){if(e.debug.checkShaderErrors){const n=s.getProgramInfoLog(f).trim(),i=s.getShaderInfoLog(_).trim(),a=s.getShaderInfoLog(w).trim();let r=!0,o=!0;!1===s.getProgramParameter(f,s.LINK_STATUS)?(r=!1,"function"==typeof e.debug.onShaderError?e.debug.onShaderError(s,f,_,w):(Nf(s,_,"vertex"),Nf(s,w,"fragment"))):""!==n||""!==i&&""!==a||(o=!1),o&&(t.diagnostics={runnable:r,programLog:n,vertexShader:{log:i,prefix:g},fragmentShader:{log:a,prefix:v}})}s.deleteShader(_),s.deleteShader(w),M=new Mf(s,f),T=function(e,t){const n={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let s=0;s<i;s++){const i=e.getActiveAttrib(t,s),a=i.name;let r=1;i.type===e.FLOAT_MAT2&&(r=2),i.type===e.FLOAT_MAT3&&(r=3),i.type===e.FLOAT_MAT4&&(r=4),n[a]={type:i.type,location:e.getAttribLocation(t,a),locationSize:r}}return n}(s,f)}let M,T;s.attachShader(f,_),s.attachShader(f,w),void 0!==n.index0AttributeName?s.bindAttribLocation(f,0,n.index0AttributeName):!0===n.morphTargets&&s.bindAttribLocation(f,0,"position"),s.linkProgram(f),this.getUniforms=function(){return void 0===M&&S(this),M},this.getAttributes=function(){return void 0===T&&S(this),T};let E=!1===n.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===E&&(E=s.getProgramParameter(f,37297)),E},this.destroy=function(){i.releaseStatesOfProgram(this),s.deleteProgram(f),this.program=void 0},this.type=n.shaderType,this.name=n.shaderName,this.id=Ef++,this.cacheKey=t,this.usedTimes=1,this.program=f,this.vertexShader=_,this.fragmentShader=w,this}let Wf=0;class Gf{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,n=e.fragmentShader,i=this._getShaderStage(t),s=this._getShaderStage(n),a=this._getShaderCacheForMaterial(e);return!1===a.has(i)&&(a.add(i),i.usedTimes++),!1===a.has(s)&&(a.add(s),s.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const n of t)n.usedTimes--,0===n.usedTimes&&this.shaderCache.delete(n.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let n=t.get(e);return void 0===n&&(n=new Set,t.set(e,n)),n}_getShaderStage(e){const t=this.shaderCache;let n=t.get(e);return void 0===n&&(n=new qf(e),t.set(e,n)),n}}class qf{constructor(e){this.id=Wf++,this.code=e,this.usedTimes=0}}function $f(e,t,n,i,s,a,r){const o=new Eu,l=new Gf,c=new Set,h=[],u=s.logarithmicDepthBuffer,d=s.vertexTextures;let p=s.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function f(e){return c.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(a,o,h,g,v){const x=g.fog,y=v.geometry,b=a.isMeshStandardMaterial?g.environment:null,_=(a.isMeshStandardMaterial?n:t).get(a.envMap||b),w=_&&_.mapping===Ll?_.image.height:null,S=m[a.type];null!==a.precision&&(p=s.getMaxPrecision(a.precision),a.precision);const M=y.morphAttributes.position||y.morphAttributes.normal||y.morphAttributes.color,T=void 0!==M?M.length:0;let E,C,N,A,R=0;if(void 0!==y.morphAttributes.position&&(R=1),void 0!==y.morphAttributes.normal&&(R=2),void 0!==y.morphAttributes.color&&(R=3),S){const e=zp[S];E=e.vertexShader,C=e.fragmentShader}else E=a.vertexShader,C=a.fragmentShader,l.update(a),N=l.getVertexShaderID(a),A=l.getFragmentShaderID(a);const j=e.getRenderTarget(),P=e.state.buffers.depth.getReversed(),I=!0===v.isInstancedMesh,D=!0===v.isBatchedMesh,k=!!a.map,L=!!a.matcap,O=!!_,U=!!a.aoMap,F=!!a.lightMap,z=!!a.bumpMap,B=!!a.normalMap,V=!!a.displacementMap,H=!!a.emissiveMap,W=!!a.metalnessMap,G=!!a.roughnessMap,q=a.anisotropy>0,$=a.clearcoat>0,X=a.dispersion>0,Y=a.iridescence>0,K=a.sheen>0,Z=a.transmission>0,J=q&&!!a.anisotropyMap,Q=$&&!!a.clearcoatMap,ee=$&&!!a.clearcoatNormalMap,te=$&&!!a.clearcoatRoughnessMap,ne=Y&&!!a.iridescenceMap,ie=Y&&!!a.iridescenceThicknessMap,se=K&&!!a.sheenColorMap,ae=K&&!!a.sheenRoughnessMap,re=!!a.specularMap,oe=!!a.specularColorMap,le=!!a.specularIntensityMap,ce=Z&&!!a.transmissionMap,he=Z&&!!a.thicknessMap,ue=!!a.gradientMap,de=!!a.alphaMap,pe=a.alphaTest>0,me=!!a.alphaHash,fe=!!a.extensions;let ge=0;a.toneMapped&&(null!==j&&!0!==j.isXRRenderTarget||(ge=e.toneMapping));const ve={shaderID:S,shaderType:a.type,shaderName:a.name,vertexShader:E,fragmentShader:C,defines:a.defines,customVertexShaderID:N,customFragmentShaderID:A,isRawShaderMaterial:!0===a.isRawShaderMaterial,glslVersion:a.glslVersion,precision:p,batching:D,batchingColor:D&&null!==v._colorsTexture,instancing:I,instancingColor:I&&null!==v.instanceColor,instancingMorph:I&&null!==v.morphTexture,supportsVertexTextures:d,outputColorSpace:null===j?e.outputColorSpace:!0===j.isXRRenderTarget?j.texture.colorSpace:zc,alphaToCoverage:!!a.alphaToCoverage,map:k,matcap:L,envMap:O,envMapMode:O&&_.mapping,envMapCubeUVHeight:w,aoMap:U,lightMap:F,bumpMap:z,normalMap:B,displacementMap:d&&V,emissiveMap:H,normalMapObjectSpace:B&&1===a.normalMapType,normalMapTangentSpace:B&&0===a.normalMapType,metalnessMap:W,roughnessMap:G,anisotropy:q,anisotropyMap:J,clearcoat:$,clearcoatMap:Q,clearcoatNormalMap:ee,clearcoatRoughnessMap:te,dispersion:X,iridescence:Y,iridescenceMap:ne,iridescenceThicknessMap:ie,sheen:K,sheenColorMap:se,sheenRoughnessMap:ae,specularMap:re,specularColorMap:oe,specularIntensityMap:le,transmission:Z,transmissionMap:ce,thicknessMap:he,gradientMap:ue,opaque:!1===a.transparent&&1===a.blending&&!1===a.alphaToCoverage,alphaMap:de,alphaTest:pe,alphaHash:me,combine:a.combine,mapUv:k&&f(a.map.channel),aoMapUv:U&&f(a.aoMap.channel),lightMapUv:F&&f(a.lightMap.channel),bumpMapUv:z&&f(a.bumpMap.channel),normalMapUv:B&&f(a.normalMap.channel),displacementMapUv:V&&f(a.displacementMap.channel),emissiveMapUv:H&&f(a.emissiveMap.channel),metalnessMapUv:W&&f(a.metalnessMap.channel),roughnessMapUv:G&&f(a.roughnessMap.channel),anisotropyMapUv:J&&f(a.anisotropyMap.channel),clearcoatMapUv:Q&&f(a.clearcoatMap.channel),clearcoatNormalMapUv:ee&&f(a.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:te&&f(a.clearcoatRoughnessMap.channel),iridescenceMapUv:ne&&f(a.iridescenceMap.channel),iridescenceThicknessMapUv:ie&&f(a.iridescenceThicknessMap.channel),sheenColorMapUv:se&&f(a.sheenColorMap.channel),sheenRoughnessMapUv:ae&&f(a.sheenRoughnessMap.channel),specularMapUv:re&&f(a.specularMap.channel),specularColorMapUv:oe&&f(a.specularColorMap.channel),specularIntensityMapUv:le&&f(a.specularIntensityMap.channel),transmissionMapUv:ce&&f(a.transmissionMap.channel),thicknessMapUv:he&&f(a.thicknessMap.channel),alphaMapUv:de&&f(a.alphaMap.channel),vertexTangents:!!y.attributes.tangent&&(B||q),vertexColors:a.vertexColors,vertexAlphas:!0===a.vertexColors&&!!y.attributes.color&&4===y.attributes.color.itemSize,pointsUvs:!0===v.isPoints&&!!y.attributes.uv&&(k||de),fog:!!x,useFog:!0===a.fog,fogExp2:!!x&&x.isFogExp2,flatShading:!0===a.flatShading&&!1===a.wireframe,sizeAttenuation:!0===a.sizeAttenuation,logarithmicDepthBuffer:u,reverseDepthBuffer:P,skinning:!0===v.isSkinnedMesh,morphTargets:void 0!==y.morphAttributes.position,morphNormals:void 0!==y.morphAttributes.normal,morphColors:void 0!==y.morphAttributes.color,morphTargetsCount:T,morphTextureStride:R,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:r.numPlanes,numClipIntersection:r.numIntersection,dithering:a.dithering,shadowMapEnabled:e.shadowMap.enabled&&h.length>0,shadowMapType:e.shadowMap.type,toneMapping:ge,decodeVideoTexture:k&&!0===a.map.isVideoTexture&&Eh.getTransfer(a.map.colorSpace)===Vc,decodeVideoTextureEmissive:H&&!0===a.emissiveMap.isVideoTexture&&Eh.getTransfer(a.emissiveMap.colorSpace)===Vc,premultipliedAlpha:a.premultipliedAlpha,doubleSided:2===a.side,flipSided:1===a.side,useDepthPacking:a.depthPacking>=0,depthPacking:a.depthPacking||0,index0AttributeName:a.index0AttributeName,extensionClipCullDistance:fe&&!0===a.extensions.clipCullDistance&&i.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(fe&&!0===a.extensions.multiDraw||D)&&i.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:i.has("KHR_parallel_shader_compile"),customProgramCacheKey:a.customProgramCacheKey()};return ve.vertexUv1s=c.has(1),ve.vertexUv2s=c.has(2),ve.vertexUv3s=c.has(3),c.clear(),ve},getProgramCacheKey:function(t){const n=[];if(t.shaderID?n.push(t.shaderID):(n.push(t.customVertexShaderID),n.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)n.push(e),n.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(n,t),function(e,t){o.disableAll(),t.supportsVertexTextures&&o.enable(0),t.instancing&&o.enable(1),t.instancingColor&&o.enable(2),t.instancingMorph&&o.enable(3),t.matcap&&o.enable(4),t.envMap&&o.enable(5),t.normalMapObjectSpace&&o.enable(6),t.normalMapTangentSpace&&o.enable(7),t.clearcoat&&o.enable(8),t.iridescence&&o.enable(9),t.alphaTest&&o.enable(10),t.vertexColors&&o.enable(11),t.vertexAlphas&&o.enable(12),t.vertexUv1s&&o.enable(13),t.vertexUv2s&&o.enable(14),t.vertexUv3s&&o.enable(15),t.vertexTangents&&o.enable(16),t.anisotropy&&o.enable(17),t.alphaHash&&o.enable(18),t.batching&&o.enable(19),t.dispersion&&o.enable(20),t.batchingColor&&o.enable(21),t.gradientMap&&o.enable(22),e.push(o.mask),o.disableAll(),t.fog&&o.enable(0),t.useFog&&o.enable(1),t.flatShading&&o.enable(2),t.logarithmicDepthBuffer&&o.enable(3),t.reverseDepthBuffer&&o.enable(4),t.skinning&&o.enable(5),t.morphTargets&&o.enable(6),t.morphNormals&&o.enable(7),t.morphColors&&o.enable(8),t.premultipliedAlpha&&o.enable(9),t.shadowMapEnabled&&o.enable(10),t.doubleSided&&o.enable(11),t.flipSided&&o.enable(12),t.useDepthPacking&&o.enable(13),t.dithering&&o.enable(14),t.transmission&&o.enable(15),t.sheen&&o.enable(16),t.opaque&&o.enable(17),t.pointsUvs&&o.enable(18),t.decodeVideoTexture&&o.enable(19),t.decodeVideoTextureEmissive&&o.enable(20),t.alphaToCoverage&&o.enable(21),e.push(o.mask)}(n,t),n.push(e.outputColorSpace)),n.push(t.customProgramCacheKey),n.join()},getUniforms:function(e){const t=m[e.type];let n;if(t){const e=zp[t];n=Wd.clone(e.uniforms)}else n=e.uniforms;return n},acquireProgram:function(t,n){let i;for(let e=0,s=h.length;e<s;e++){const t=h[e];if(t.cacheKey===n){i=t,++i.usedTimes;break}}return void 0===i&&(i=new Hf(e,n,t,a),h.push(i)),i},releaseProgram:function(e){if(0===--e.usedTimes){const t=h.indexOf(e);h[t]=h[h.length-1],h.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:h,dispose:function(){l.dispose()}}}function Xf(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let n=e.get(t);return void 0===n&&(n={},e.set(t,n)),n},remove:function(t){e.delete(t)},update:function(t,n,i){e.get(t)[n]=i},dispose:function(){e=new WeakMap}}}function Yf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Kf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Zf(){const e=[];let t=0;const n=[],i=[],s=[];function a(n,i,s,a,r,o){let l=e[t];return void 0===l?(l={id:n.id,object:n,geometry:i,material:s,groupOrder:a,renderOrder:n.renderOrder,z:r,group:o},e[t]=l):(l.id=n.id,l.object=n,l.geometry=i,l.material=s,l.groupOrder=a,l.renderOrder=n.renderOrder,l.z=r,l.group=o),t++,l}return{opaque:n,transmissive:i,transparent:s,init:function(){t=0,n.length=0,i.length=0,s.length=0},push:function(e,t,r,o,l,c){const h=a(e,t,r,o,l,c);r.transmission>0?i.push(h):!0===r.transparent?s.push(h):n.push(h)},unshift:function(e,t,r,o,l,c){const h=a(e,t,r,o,l,c);r.transmission>0?i.unshift(h):!0===r.transparent?s.unshift(h):n.unshift(h)},finish:function(){for(let n=t,i=e.length;n<i;n++){const t=e[n];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){n.length>1&&n.sort(e||Yf),i.length>1&&i.sort(t||Kf),s.length>1&&s.sort(t||Kf)}}}function Jf(){let e=new WeakMap;return{get:function(t,n){const i=e.get(t);let s;return void 0===i?(s=new Zf,e.set(t,[s])):n>=i.length?(s=new Zf,i.push(s)):s=i[n],s},dispose:function(){e=new WeakMap}}}function Qf(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":n={direction:new ph,color:new od};break;case"SpotLight":n={position:new ph,direction:new ph,color:new od,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new ph,color:new od,distance:0,decay:0};break;case"HemisphereLight":n={direction:new ph,skyColor:new od,groundColor:new od};break;case"RectAreaLight":n={color:new od,position:new ph,halfWidth:new ph,halfHeight:new ph}}return e[t.id]=n,n}}}let eg=0;function tg(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function ng(e){const t=new Qf,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":case"SpotLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new uh};break;case"PointLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new uh,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=n,n}}}(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let o=0;o<9;o++)i.probe.push(new ph);const s=new ph,a=new fu,r=new fu;return{setup:function(s){let a=0,r=0,o=0;for(let e=0;e<9;e++)i.probe[e].set(0,0,0);let l=0,c=0,h=0,u=0,d=0,p=0,m=0,f=0,g=0,v=0,x=0;s.sort(tg);for(let e=0,b=s.length;e<b;e++){const y=s[e],b=y.color,_=y.intensity,w=y.distance,S=y.shadow&&y.shadow.map?y.shadow.map.texture:null;if(y.isAmbientLight)a+=b.r*_,r+=b.g*_,o+=b.b*_;else if(y.isLightProbe){for(let e=0;e<9;e++)i.probe[e].addScaledVector(y.sh.coefficients[e],_);x++}else if(y.isDirectionalLight){const e=t.get(y);if(e.color.copy(y.color).multiplyScalar(y.intensity),y.castShadow){const e=y.shadow,t=n.get(y);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,i.directionalShadow[l]=t,i.directionalShadowMap[l]=S,i.directionalShadowMatrix[l]=y.shadow.matrix,p++}i.directional[l]=e,l++}else if(y.isSpotLight){const e=t.get(y);e.position.setFromMatrixPosition(y.matrixWorld),e.color.copy(b).multiplyScalar(_),e.distance=w,e.coneCos=Math.cos(y.angle),e.penumbraCos=Math.cos(y.angle*(1-y.penumbra)),e.decay=y.decay,i.spot[h]=e;const s=y.shadow;if(y.map&&(i.spotLightMap[g]=y.map,g++,s.updateMatrices(y),y.castShadow&&v++),i.spotLightMatrix[h]=s.matrix,y.castShadow){const e=n.get(y);e.shadowIntensity=s.intensity,e.shadowBias=s.bias,e.shadowNormalBias=s.normalBias,e.shadowRadius=s.radius,e.shadowMapSize=s.mapSize,i.spotShadow[h]=e,i.spotShadowMap[h]=S,f++}h++}else if(y.isRectAreaLight){const e=t.get(y);e.color.copy(b).multiplyScalar(_),e.halfWidth.set(.5*y.width,0,0),e.halfHeight.set(0,.5*y.height,0),i.rectArea[u]=e,u++}else if(y.isPointLight){const e=t.get(y);if(e.color.copy(y.color).multiplyScalar(y.intensity),e.distance=y.distance,e.decay=y.decay,y.castShadow){const e=y.shadow,t=n.get(y);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,i.pointShadow[c]=t,i.pointShadowMap[c]=S,i.pointShadowMatrix[c]=y.shadow.matrix,m++}i.point[c]=e,c++}else if(y.isHemisphereLight){const e=t.get(y);e.skyColor.copy(y.color).multiplyScalar(_),e.groundColor.copy(y.groundColor).multiplyScalar(_),i.hemi[d]=e,d++}}u>0&&(!0===e.has("OES_texture_float_linear")?(i.rectAreaLTC1=Fp.LTC_FLOAT_1,i.rectAreaLTC2=Fp.LTC_FLOAT_2):(i.rectAreaLTC1=Fp.LTC_HALF_1,i.rectAreaLTC2=Fp.LTC_HALF_2)),i.ambient[0]=a,i.ambient[1]=r,i.ambient[2]=o;const y=i.hash;y.directionalLength===l&&y.pointLength===c&&y.spotLength===h&&y.rectAreaLength===u&&y.hemiLength===d&&y.numDirectionalShadows===p&&y.numPointShadows===m&&y.numSpotShadows===f&&y.numSpotMaps===g&&y.numLightProbes===x||(i.directional.length=l,i.spot.length=h,i.rectArea.length=u,i.point.length=c,i.hemi.length=d,i.directionalShadow.length=p,i.directionalShadowMap.length=p,i.pointShadow.length=m,i.pointShadowMap.length=m,i.spotShadow.length=f,i.spotShadowMap.length=f,i.directionalShadowMatrix.length=p,i.pointShadowMatrix.length=m,i.spotLightMatrix.length=f+g-v,i.spotLightMap.length=g,i.numSpotLightShadowsWithMaps=v,i.numLightProbes=x,y.directionalLength=l,y.pointLength=c,y.spotLength=h,y.rectAreaLength=u,y.hemiLength=d,y.numDirectionalShadows=p,y.numPointShadows=m,y.numSpotShadows=f,y.numSpotMaps=g,y.numLightProbes=x,i.version=eg++)},setupView:function(e,t){let n=0,o=0,l=0,c=0,h=0;const u=t.matrixWorldInverse;for(let d=0,p=e.length;d<p;d++){const t=e[d];if(t.isDirectionalLight){const e=i.directional[n];e.direction.setFromMatrixPosition(t.matrixWorld),s.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(s),e.direction.transformDirection(u),n++}else if(t.isSpotLight){const e=i.spot[l];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),e.direction.setFromMatrixPosition(t.matrixWorld),s.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(s),e.direction.transformDirection(u),l++}else if(t.isRectAreaLight){const e=i.rectArea[c];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),r.identity(),a.copy(t.matrixWorld),a.premultiply(u),r.extractRotation(a),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),e.halfWidth.applyMatrix4(r),e.halfHeight.applyMatrix4(r),c++}else if(t.isPointLight){const e=i.point[o];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),o++}else if(t.isHemisphereLight){const e=i.hemi[h];e.direction.setFromMatrixPosition(t.matrixWorld),e.direction.transformDirection(u),h++}}},state:i}}function ig(e){const t=new ng(e),n=[],i=[],s={lightsArray:n,shadowsArray:i,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){s.camera=e,n.length=0,i.length=0},state:s,setupLights:function(){t.setup(n)},setupLightsView:function(e){t.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){i.push(e)}}}function sg(e){let t=new WeakMap;return{get:function(n,i=0){const s=t.get(n);let a;return void 0===s?(a=new ig(e),t.set(n,[a])):i>=s.length?(a=new ig(e),s.push(a)):a=s[i],a},dispose:function(){t=new WeakMap}}}function ag(e,t,n){let i=new dp;const s=new uh,a=new uh,r=new Oh,o=new _p({depthPacking:3201}),l=new wp,c={},h=n.maxTextureSize,u={[al]:1,[rl]:0,[ol]:2},d=new Gd({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new uh},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const m=new Ed;m.setAttribute("position",new fd(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new Ud(m,d),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let v=this.type;function x(n,i){const a=t.update(f);d.defines.VSM_SAMPLES!==n.blurSamples&&(d.defines.VSM_SAMPLES=n.blurSamples,p.defines.VSM_SAMPLES=n.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),null===n.mapPass&&(n.mapPass=new Fh(s.x,s.y)),d.uniforms.shadow_pass.value=n.map.texture,d.uniforms.resolution.value=n.mapSize,d.uniforms.radius.value=n.radius,e.setRenderTarget(n.mapPass),e.clear(),e.renderBufferDirect(i,null,a,d,f,null),p.uniforms.shadow_pass.value=n.mapPass.texture,p.uniforms.resolution.value=n.mapSize,p.uniforms.radius.value=n.radius,e.setRenderTarget(n.map),e.clear(),e.renderBufferDirect(i,null,a,p,f,null)}function y(t,n,i,s){let a=null;const r=!0===i.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==r)a=r;else if(a=!0===i.isPointLight?l:o,e.localClippingEnabled&&!0===n.clipShadows&&Array.isArray(n.clippingPlanes)&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0||n.map&&n.alphaTest>0||!0===n.alphaToCoverage){const e=a.uuid,t=n.uuid;let i=c[e];void 0===i&&(i={},c[e]=i);let s=i[t];void 0===s&&(s=a.clone(),i[t]=s,n.addEventListener("dispose",_)),a=s}return a.visible=n.visible,a.wireframe=n.wireframe,a.side=3===s?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:u[n.side],a.alphaMap=n.alphaMap,a.alphaTest=!0===n.alphaToCoverage?.5:n.alphaTest,a.map=n.map,a.clipShadows=n.clipShadows,a.clippingPlanes=n.clippingPlanes,a.clipIntersection=n.clipIntersection,a.displacementMap=n.displacementMap,a.displacementScale=n.displacementScale,a.displacementBias=n.displacementBias,a.wireframeLinewidth=n.wireframeLinewidth,a.linewidth=n.linewidth,!0===i.isPointLight&&!0===a.isMeshDistanceMaterial&&(e.properties.get(a).light=i),a}function b(n,s,a,r,o){if(!1===n.visible)return;if(n.layers.test(s.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&3===o)&&(!n.frustumCulled||i.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,n.matrixWorld);const i=t.update(n),l=n.material;if(Array.isArray(l)){const t=i.groups;for(let c=0,h=t.length;c<h;c++){const h=t[c],u=l[h.materialIndex];if(u&&u.visible){const t=y(n,u,r,o);n.onBeforeShadow(e,n,s,a,i,t,h),e.renderBufferDirect(a,null,i,t,n,h),n.onAfterShadow(e,n,s,a,i,t,h)}}}else if(l.visible){const t=y(n,l,r,o);n.onBeforeShadow(e,n,s,a,i,t,null),e.renderBufferDirect(a,null,i,t,n,null),n.onAfterShadow(e,n,s,a,i,t,null)}}const l=n.children;for(let e=0,t=l.length;e<t;e++)b(l[e],s,a,r,o)}function _(e){e.target.removeEventListener("dispose",_);for(const t in c){const n=c[t],i=e.target.uuid;i in n&&(n[i].dispose(),delete n[i])}}this.render=function(t,n,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),c=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),d=e.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=3!==v&&3===this.type,m=3===v&&3!==this.type;for(let f=0,g=t.length;f<g;f++){const l=t[f],c=l.shadow;if(void 0===c)continue;if(!1===c.autoUpdate&&!1===c.needsUpdate)continue;s.copy(c.mapSize);const u=c.getFrameExtents();if(s.multiply(u),a.copy(c.mapSize),(s.x>h||s.y>h)&&(s.x>h&&(a.x=Math.floor(h/u.x),s.x=a.x*u.x,c.mapSize.x=a.x),s.y>h&&(a.y=Math.floor(h/u.y),s.y=a.y*u.y,c.mapSize.y=a.y)),null===c.map||!0===p||!0===m){const e=3!==this.type?{minFilter:zl,magFilter:zl}:{};null!==c.map&&c.map.dispose(),c.map=new Fh(s.x,s.y,e),c.map.texture.name=l.name+".shadowMap",c.camera.updateProjectionMatrix()}e.setRenderTarget(c.map),e.clear();const g=c.getViewportCount();for(let e=0;e<g;e++){const t=c.getViewport(e);r.set(a.x*t.x,a.y*t.y,a.x*t.z,a.y*t.w),d.viewport(r),c.updateMatrices(l,e),i=c.getFrustum(),b(n,o,c.camera,l,this.type)}!0!==c.isPointLightShadow&&3===this.type&&x(c,o),c.needsUpdate=!1}v=this.type,g.needsUpdate=!1,e.setRenderTarget(l,c,u)}}const rg={[El]:1,[Nl]:6,[Rl]:7,[Al]:5,[Cl]:0,[Pl]:2,[Il]:4,[jl]:3};function og(e,t){const n=new function(){let t=!1;const n=new Oh;let i=null;const s=new Oh(0,0,0,0);return{setMask:function(n){i===n||t||(e.colorMask(n,n,n,n),i=n)},setLocked:function(e){t=e},setClear:function(t,i,a,r,o){!0===o&&(t*=r,i*=r,a*=r),n.set(t,i,a,r),!1===s.equals(n)&&(e.clearColor(t,i,a,r),s.copy(n))},reset:function(){t=!1,i=null,s.set(-1,0,0,0)}}},i=new function(){let n=!1,i=!1,s=null,a=null,r=null;return{setReversed:function(e){if(i!==e){const n=t.get("EXT_clip_control");e?n.clipControlEXT(n.LOWER_LEFT_EXT,n.ZERO_TO_ONE_EXT):n.clipControlEXT(n.LOWER_LEFT_EXT,n.NEGATIVE_ONE_TO_ONE_EXT),i=e;const s=r;r=null,this.setClear(s)}},getReversed:function(){return i},setTest:function(t){t?z(e.DEPTH_TEST):B(e.DEPTH_TEST)},setMask:function(t){s===t||n||(e.depthMask(t),s=t)},setFunc:function(t){if(i&&(t=rg[t]),a!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}a=t}},setLocked:function(e){n=e},setClear:function(t){r!==t&&(i&&(t=1-t),e.clearDepth(t),r=t)},reset:function(){n=!1,s=null,a=null,r=null,i=!1}}},s=new function(){let t=!1,n=null,i=null,s=null,a=null,r=null,o=null,l=null,c=null;return{setTest:function(n){t||(n?z(e.STENCIL_TEST):B(e.STENCIL_TEST))},setMask:function(i){n===i||t||(e.stencilMask(i),n=i)},setFunc:function(t,n,r){i===t&&s===n&&a===r||(e.stencilFunc(t,n,r),i=t,s=n,a=r)},setOp:function(t,n,i){r===t&&o===n&&l===i||(e.stencilOp(t,n,i),r=t,o=n,l=i)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,n=null,i=null,s=null,a=null,r=null,o=null,l=null,c=null}}},a=new WeakMap,r=new WeakMap;let o={},l={},c=new WeakMap,h=[],u=null,d=!1,p=null,m=null,f=null,g=null,v=null,x=null,y=null,b=new od(0,0,0),_=0,w=!1,S=null,M=null,T=null,E=null,C=null;const N=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let A=!1,R=0;const j=e.getParameter(e.VERSION);-1!==j.indexOf("WebGL")?(R=parseFloat(/^WebGL (\d)/.exec(j)[1]),A=R>=1):-1!==j.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL ES (\d)/.exec(j)[1]),A=R>=2);let P=null,I={};const D=e.getParameter(e.SCISSOR_BOX),k=e.getParameter(e.VIEWPORT),L=(new Oh).fromArray(D),O=(new Oh).fromArray(k);function U(t,n,i,s){const a=new Uint8Array(4),r=e.createTexture();e.bindTexture(t,r),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let o=0;o<i;o++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(n,0,e.RGBA,1,1,s,0,e.RGBA,e.UNSIGNED_BYTE,a):e.texImage2D(n+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,a);return r}const F={};function z(t){!0!==o[t]&&(e.enable(t),o[t]=!0)}function B(t){!1!==o[t]&&(e.disable(t),o[t]=!1)}F[e.TEXTURE_2D]=U(e.TEXTURE_2D,e.TEXTURE_2D,1),F[e.TEXTURE_CUBE_MAP]=U(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),F[e.TEXTURE_2D_ARRAY]=U(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),F[e.TEXTURE_3D]=U(e.TEXTURE_3D,e.TEXTURE_3D,1,1),n.setClear(0,0,0,1),i.setClear(1),s.setClear(0),z(e.DEPTH_TEST),i.setFunc(3),G(!1),q(1),z(e.CULL_FACE),W(0);const V={[ll]:e.FUNC_ADD,[cl]:e.FUNC_SUBTRACT,[hl]:e.FUNC_REVERSE_SUBTRACT};V[103]=e.MIN,V[104]=e.MAX;const H={[ul]:e.ZERO,[dl]:e.ONE,[pl]:e.SRC_COLOR,[fl]:e.SRC_ALPHA,[_l]:e.SRC_ALPHA_SATURATE,[yl]:e.DST_COLOR,[vl]:e.DST_ALPHA,[ml]:e.ONE_MINUS_SRC_COLOR,[gl]:e.ONE_MINUS_SRC_ALPHA,[bl]:e.ONE_MINUS_DST_COLOR,[xl]:e.ONE_MINUS_DST_ALPHA,[wl]:e.CONSTANT_COLOR,[Sl]:e.ONE_MINUS_CONSTANT_COLOR,[Ml]:e.CONSTANT_ALPHA,[Tl]:e.ONE_MINUS_CONSTANT_ALPHA};function W(t,n,i,s,a,r,o,l,c,h){if(0!==t){if(!1===d&&(z(e.BLEND),d=!0),5===t)a=a||n,r=r||i,o=o||s,n===m&&a===v||(e.blendEquationSeparate(V[n],V[a]),m=n,v=a),i===f&&s===g&&r===x&&o===y||(e.blendFuncSeparate(H[i],H[s],H[r],H[o]),f=i,g=s,x=r,y=o),!1!==l.equals(b)&&c===_||(e.blendColor(l.r,l.g,l.b,c),b.copy(l),_=c),p=t,w=!1;else if(t!==p||h!==w){if(m===ll&&v===ll||(e.blendEquation(e.FUNC_ADD),m=ll,v=ll),h)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE,e.ONE,e.ONE)}f=null,g=null,x=null,y=null,b.set(0,0,0),_=0,p=t,w=h}}else!0===d&&(B(e.BLEND),d=!1)}function G(t){S!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),S=t)}function q(t){0!==t?(z(e.CULL_FACE),t!==M&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):B(e.CULL_FACE),M=t}function $(t,n,i){t?(z(e.POLYGON_OFFSET_FILL),E===n&&C===i||(e.polygonOffset(n,i),E=n,C=i)):B(e.POLYGON_OFFSET_FILL)}return{buffers:{color:n,depth:i,stencil:s},enable:z,disable:B,bindFramebuffer:function(t,n){return l[t]!==n&&(e.bindFramebuffer(t,n),l[t]=n,t===e.DRAW_FRAMEBUFFER&&(l[e.FRAMEBUFFER]=n),t===e.FRAMEBUFFER&&(l[e.DRAW_FRAMEBUFFER]=n),!0)},drawBuffers:function(t,n){let i=h,s=!1;if(t){i=c.get(n),void 0===i&&(i=[],c.set(n,i));const a=t.textures;if(i.length!==a.length||i[0]!==e.COLOR_ATTACHMENT0){for(let t=0,n=a.length;t<n;t++)i[t]=e.COLOR_ATTACHMENT0+t;i.length=a.length,s=!0}}else i[0]!==e.BACK&&(i[0]=e.BACK,s=!0);s&&e.drawBuffers(i)},useProgram:function(t){return u!==t&&(e.useProgram(t),u=t,!0)},setBlending:W,setMaterial:function(t,a){2===t.side?B(e.CULL_FACE):z(e.CULL_FACE);let r=1===t.side;a&&(r=!r),G(r),1===t.blending&&!1===t.transparent?W(0):W(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),n.setMask(t.colorWrite);const o=t.stencilWrite;s.setTest(o),o&&(s.setMask(t.stencilWriteMask),s.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),s.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),$(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?z(e.SAMPLE_ALPHA_TO_COVERAGE):B(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:G,setCullFace:q,setLineWidth:function(t){t!==T&&(A&&e.lineWidth(t),T=t)},setPolygonOffset:$,setScissorTest:function(t){t?z(e.SCISSOR_TEST):B(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+N-1),P!==t&&(e.activeTexture(t),P=t)},bindTexture:function(t,n,i){void 0===i&&(i=null===P?e.TEXTURE0+N-1:P);let s=I[i];void 0===s&&(s={type:void 0,texture:void 0},I[i]=s),s.type===t&&s.texture===n||(P!==i&&(e.activeTexture(i),P=i),e.bindTexture(t,n||F[t]),s.type=t,s.texture=n)},unbindTexture:function(){const t=I[P];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(t){}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(t){}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(t){}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(t){}},updateUBOMapping:function(t,n){let i=r.get(n);void 0===i&&(i=new WeakMap,r.set(n,i));let s=i.get(t);void 0===s&&(s=e.getUniformBlockIndex(n,t.name),i.set(t,s))},uniformBlockBinding:function(t,n){const i=r.get(n).get(t);a.get(n)!==i&&(e.uniformBlockBinding(n,i,t.__bindingPointIndex),a.set(n,i))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(t){}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(t){}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(t){}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(t){}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(t){}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(t){}},scissor:function(t){!1===L.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),L.copy(t))},viewport:function(t){!1===O.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),O.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),i.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),o={},P=null,I={},l={},c=new WeakMap,h=[],u=null,d=!1,p=null,m=null,f=null,g=null,v=null,x=null,y=null,b=new od(0,0,0),_=0,w=!1,S=null,M=null,T=null,E=null,C=null,L.set(0,0,e.canvas.width,e.canvas.height),O.set(0,0,e.canvas.width,e.canvas.height),n.reset(),i.reset(),s.reset()}}}function lg(e,t,n,i,s,a,r){const o=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),c=new uh,h=new WeakMap;let u;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(W){}function m(e,t){return p?new OffscreenCanvas(e,t):yh("canvas")}function f(e,t,n){let i=1;const s=H(e);if((s.width>n||s.height>n)&&(i=n/Math.max(s.width,s.height)),i<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const n=Math.floor(i*s.width),a=Math.floor(i*s.height);void 0===u&&(u=m(n,a));const r=t?m(n,a):u;return r.width=n,r.height=a,r.getContext("2d").drawImage(e,0,0,n,a),r}return e}return e}function g(e){return e.generateMipmaps}function v(t){e.generateMipmap(t)}function x(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function y(n,i,s,a,r=!1){if(null!==n&&void 0!==e[n])return e[n];let o=i;if(i===e.RED&&(s===e.FLOAT&&(o=e.R32F),s===e.HALF_FLOAT&&(o=e.R16F),s===e.UNSIGNED_BYTE&&(o=e.R8)),i===e.RED_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.R8UI),s===e.UNSIGNED_SHORT&&(o=e.R16UI),s===e.UNSIGNED_INT&&(o=e.R32UI),s===e.BYTE&&(o=e.R8I),s===e.SHORT&&(o=e.R16I),s===e.INT&&(o=e.R32I)),i===e.RG&&(s===e.FLOAT&&(o=e.RG32F),s===e.HALF_FLOAT&&(o=e.RG16F),s===e.UNSIGNED_BYTE&&(o=e.RG8)),i===e.RG_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.RG8UI),s===e.UNSIGNED_SHORT&&(o=e.RG16UI),s===e.UNSIGNED_INT&&(o=e.RG32UI),s===e.BYTE&&(o=e.RG8I),s===e.SHORT&&(o=e.RG16I),s===e.INT&&(o=e.RG32I)),i===e.RGB_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.RGB8UI),s===e.UNSIGNED_SHORT&&(o=e.RGB16UI),s===e.UNSIGNED_INT&&(o=e.RGB32UI),s===e.BYTE&&(o=e.RGB8I),s===e.SHORT&&(o=e.RGB16I),s===e.INT&&(o=e.RGB32I)),i===e.RGBA_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.RGBA8UI),s===e.UNSIGNED_SHORT&&(o=e.RGBA16UI),s===e.UNSIGNED_INT&&(o=e.RGBA32UI),s===e.BYTE&&(o=e.RGBA8I),s===e.SHORT&&(o=e.RGBA16I),s===e.INT&&(o=e.RGBA32I)),i===e.RGB&&s===e.UNSIGNED_INT_5_9_9_9_REV&&(o=e.RGB9_E5),i===e.RGBA){const t=r?Bc:Eh.getTransfer(a);s===e.FLOAT&&(o=e.RGBA32F),s===e.HALF_FLOAT&&(o=e.RGBA16F),s===e.UNSIGNED_BYTE&&(o=t===Vc?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(o=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(o=e.RGB5_A1)}return o!==e.R16F&&o!==e.R32F&&o!==e.RG16F&&o!==e.RG32F&&o!==e.RGBA16F&&o!==e.RGBA32F||t.get("EXT_color_buffer_float"),o}function b(t,n){let i;return t?null===n||n===Yl||n===ec?i=e.DEPTH24_STENCIL8:n===Kl?i=e.DEPTH32F_STENCIL8:n===$l&&(i=e.DEPTH24_STENCIL8):null===n||n===Yl||n===ec?i=e.DEPTH_COMPONENT24:n===Kl?i=e.DEPTH_COMPONENT32F:n===$l&&(i=e.DEPTH_COMPONENT16),i}function _(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==zl&&e.minFilter!==Hl?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function w(e){const t=e.target;t.removeEventListener("dispose",w),function(e){const t=i.get(e);if(void 0===t.__webglInit)return;const n=e.source,s=d.get(n);if(s){const i=s[t.__cacheKey];i.usedTimes--,0===i.usedTimes&&M(e),0===Object.keys(s).length&&d.delete(n)}i.remove(e)}(t),t.isVideoTexture&&h.delete(t)}function S(t){const n=t.target;n.removeEventListener("dispose",S),function(t){const n=i.get(t);if(t.depthTexture&&(t.depthTexture.dispose(),i.remove(t.depthTexture)),t.isWebGLCubeRenderTarget)for(let i=0;i<6;i++){if(Array.isArray(n.__webglFramebuffer[i]))for(let t=0;t<n.__webglFramebuffer[i].length;t++)e.deleteFramebuffer(n.__webglFramebuffer[i][t]);else e.deleteFramebuffer(n.__webglFramebuffer[i]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[i])}else{if(Array.isArray(n.__webglFramebuffer))for(let t=0;t<n.__webglFramebuffer.length;t++)e.deleteFramebuffer(n.__webglFramebuffer[t]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let t=0;t<n.__webglColorRenderbuffer.length;t++)n.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[t]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}const s=t.textures;for(let a=0,o=s.length;a<o;a++){const t=i.get(s[a]);t.__webglTexture&&(e.deleteTexture(t.__webglTexture),r.memory.textures--),i.remove(s[a])}i.remove(t)}(n)}function M(t){const n=i.get(t);e.deleteTexture(n.__webglTexture);const s=t.source;delete d.get(s)[n.__cacheKey],r.memory.textures--}let T=0;function E(t,s){const a=i.get(t);if(t.isVideoTexture&&function(e){const t=r.render.frame;h.get(e)!==t&&(h.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&a.__version!==t.version){const e=t.image;if(null===e);else if(!1!==e.complete)return void I(a,t,s)}n.bindTexture(e.TEXTURE_2D,a.__webglTexture,e.TEXTURE0+s)}const C={[Ol]:e.REPEAT,[Ul]:e.CLAMP_TO_EDGE,[Fl]:e.MIRRORED_REPEAT},N={[zl]:e.NEAREST,[Bl]:e.NEAREST_MIPMAP_NEAREST,[Vl]:e.NEAREST_MIPMAP_LINEAR,[Hl]:e.LINEAR,[Wl]:e.LINEAR_MIPMAP_NEAREST,[Gl]:e.LINEAR_MIPMAP_LINEAR},A={[Wc]:e.NEVER,[Zc]:e.ALWAYS,[Gc]:e.LESS,[$c]:e.LEQUAL,[qc]:e.EQUAL,[Kc]:e.GEQUAL,[Xc]:e.GREATER,[Yc]:e.NOTEQUAL};function R(n,a){if(a.type===Kl&&!1===t.has("OES_texture_float_linear")&&(a.magFilter===Hl||a.magFilter===Wl||a.magFilter===Vl||a.magFilter===Gl||a.minFilter===Hl||a.minFilter===Wl||a.minFilter===Vl||a.minFilter),e.texParameteri(n,e.TEXTURE_WRAP_S,C[a.wrapS]),e.texParameteri(n,e.TEXTURE_WRAP_T,C[a.wrapT]),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,C[a.wrapR]),e.texParameteri(n,e.TEXTURE_MAG_FILTER,N[a.magFilter]),e.texParameteri(n,e.TEXTURE_MIN_FILTER,N[a.minFilter]),a.compareFunction&&(e.texParameteri(n,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,A[a.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(a.magFilter===zl)return;if(a.minFilter!==Vl&&a.minFilter!==Gl)return;if(a.type===Kl&&!1===t.has("OES_texture_float_linear"))return;if(a.anisotropy>1||i.get(a).__currentAnisotropy){const r=t.get("EXT_texture_filter_anisotropic");e.texParameterf(n,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,s.getMaxAnisotropy())),i.get(a).__currentAnisotropy=a.anisotropy}}}function j(t,n){let i=!1;void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",w));const s=n.source;let a=d.get(s);void 0===a&&(a={},d.set(s,a));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(n);if(o!==t.__cacheKey){void 0===a[o]&&(a[o]={texture:e.createTexture(),usedTimes:0},r.memory.textures++,i=!0),a[o].usedTimes++;const s=a[t.__cacheKey];void 0!==s&&(a[t.__cacheKey].usedTimes--,0===s.usedTimes&&M(n)),t.__cacheKey=o,t.__webglTexture=a[o].texture}return i}function P(e,t,n){return Math.floor(Math.floor(e/n)/t)}function I(t,r,o){let l=e.TEXTURE_2D;(r.isDataArrayTexture||r.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),r.isData3DTexture&&(l=e.TEXTURE_3D);const c=j(t,r),h=r.source;n.bindTexture(l,t.__webglTexture,e.TEXTURE0+o);const u=i.get(h);if(h.version!==u.__version||!0===c){n.activeTexture(e.TEXTURE0+o);const t=Eh.getPrimaries(Eh.workingColorSpace),i=r.colorSpace===Uc?null:Eh.getPrimaries(r.colorSpace),d=r.colorSpace===Uc||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,r.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);let p=f(r.image,!1,s.maxTextureSize);p=V(r,p);const m=a.convert(r.format,r.colorSpace),x=a.convert(r.type);let w,S=y(r.internalFormat,m,x,r.colorSpace,r.isVideoTexture);R(l,r);const M=r.mipmaps,T=!0!==r.isVideoTexture,E=void 0===u.__version||!0===c,C=h.dataReady,N=_(r,p);if(r.isDepthTexture)S=b(r.format===ic,r.type),E&&(T?n.texStorage2D(e.TEXTURE_2D,1,S,p.width,p.height):n.texImage2D(e.TEXTURE_2D,0,S,p.width,p.height,0,m,x,null));else if(r.isDataTexture)if(M.length>0){T&&E&&n.texStorage2D(e.TEXTURE_2D,N,S,M[0].width,M[0].height);for(let t=0,i=M.length;t<i;t++)w=M[t],T?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,m,x,w.data):n.texImage2D(e.TEXTURE_2D,t,S,w.width,w.height,0,m,x,w.data);r.generateMipmaps=!1}else T?(E&&n.texStorage2D(e.TEXTURE_2D,N,S,p.width,p.height),C&&function(t,i,s,a){const r=t.updateRanges;if(0===r.length)n.texSubImage2D(e.TEXTURE_2D,0,0,0,i.width,i.height,s,a,i.data);else{r.sort((e,t)=>e.start-t.start);let o=0;for(let e=1;e<r.length;e++){const t=r[o],n=r[e],s=t.start+t.count,a=P(n.start,i.width,4),l=P(t.start,i.width,4);n.start<=s+1&&a===l&&P(n.start+n.count-1,i.width,4)===a?t.count=Math.max(t.count,n.start+n.count-t.start):(++o,r[o]=n)}r.length=o+1;const l=e.getParameter(e.UNPACK_ROW_LENGTH),c=e.getParameter(e.UNPACK_SKIP_PIXELS),h=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,i.width);for(let t=0,u=r.length;t<u;t++){const o=r[t],l=Math.floor(o.start/4),c=Math.ceil(o.count/4),h=l%i.width,u=Math.floor(l/i.width),d=c,p=1;e.pixelStorei(e.UNPACK_SKIP_PIXELS,h),e.pixelStorei(e.UNPACK_SKIP_ROWS,u),n.texSubImage2D(e.TEXTURE_2D,0,h,u,d,p,s,a,i.data)}t.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,l),e.pixelStorei(e.UNPACK_SKIP_PIXELS,c),e.pixelStorei(e.UNPACK_SKIP_ROWS,h)}}(r,p,m,x)):n.texImage2D(e.TEXTURE_2D,0,S,p.width,p.height,0,m,x,p.data);else if(r.isCompressedTexture)if(r.isCompressedArrayTexture){T&&E&&n.texStorage3D(e.TEXTURE_2D_ARRAY,N,S,M[0].width,M[0].height,p.depth);for(let t=0,i=M.length;t<i;t++)if(w=M[t],r.format!==tc){if(null!==m)if(T){if(C)if(r.layerUpdates.size>0){const i=kp(w.width,w.height,r.format,r.type);for(const s of r.layerUpdates){const a=w.data.subarray(s*i/w.data.BYTES_PER_ELEMENT,(s+1)*i/w.data.BYTES_PER_ELEMENT);n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,s,w.width,w.height,1,m,a)}r.clearLayerUpdates()}else n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,w.width,w.height,p.depth,m,w.data)}else n.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,S,w.width,w.height,p.depth,0,w.data,0,0)}else T?C&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,w.width,w.height,p.depth,m,x,w.data):n.texImage3D(e.TEXTURE_2D_ARRAY,t,S,w.width,w.height,p.depth,0,m,x,w.data)}else{T&&E&&n.texStorage2D(e.TEXTURE_2D,N,S,M[0].width,M[0].height);for(let t=0,i=M.length;t<i;t++)w=M[t],r.format!==tc?null!==m&&(T?C&&n.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,m,w.data):n.compressedTexImage2D(e.TEXTURE_2D,t,S,w.width,w.height,0,w.data)):T?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,m,x,w.data):n.texImage2D(e.TEXTURE_2D,t,S,w.width,w.height,0,m,x,w.data)}else if(r.isDataArrayTexture)if(T){if(E&&n.texStorage3D(e.TEXTURE_2D_ARRAY,N,S,p.width,p.height,p.depth),C)if(r.layerUpdates.size>0){const t=kp(p.width,p.height,r.format,r.type);for(const i of r.layerUpdates){const s=p.data.subarray(i*t/p.data.BYTES_PER_ELEMENT,(i+1)*t/p.data.BYTES_PER_ELEMENT);n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,i,p.width,p.height,1,m,x,s)}r.clearLayerUpdates()}else n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,p.width,p.height,p.depth,m,x,p.data)}else n.texImage3D(e.TEXTURE_2D_ARRAY,0,S,p.width,p.height,p.depth,0,m,x,p.data);else if(r.isData3DTexture)T?(E&&n.texStorage3D(e.TEXTURE_3D,N,S,p.width,p.height,p.depth),C&&n.texSubImage3D(e.TEXTURE_3D,0,0,0,0,p.width,p.height,p.depth,m,x,p.data)):n.texImage3D(e.TEXTURE_3D,0,S,p.width,p.height,p.depth,0,m,x,p.data);else if(r.isFramebufferTexture){if(E)if(T)n.texStorage2D(e.TEXTURE_2D,N,S,p.width,p.height);else{let t=p.width,i=p.height;for(let s=0;s<N;s++)n.texImage2D(e.TEXTURE_2D,s,S,t,i,0,m,x,null),t>>=1,i>>=1}}else if(M.length>0){if(T&&E){const t=H(M[0]);n.texStorage2D(e.TEXTURE_2D,N,S,t.width,t.height)}for(let t=0,i=M.length;t<i;t++)w=M[t],T?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,m,x,w):n.texImage2D(e.TEXTURE_2D,t,S,m,x,w);r.generateMipmaps=!1}else if(T){if(E){const t=H(p);n.texStorage2D(e.TEXTURE_2D,N,S,t.width,t.height)}C&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,m,x,p)}else n.texImage2D(e.TEXTURE_2D,0,S,m,x,p);g(r)&&v(l),u.__version=h.version,r.onUpdate&&r.onUpdate(r)}t.__version=r.version}function D(t,s,r,l,c,h){const u=a.convert(r.format,r.colorSpace),d=a.convert(r.type),p=y(r.internalFormat,u,d,r.colorSpace),m=i.get(s),f=i.get(r);if(f.__renderTarget=s,!m.__hasExternalTextures){const t=Math.max(1,s.width>>h),i=Math.max(1,s.height>>h);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?n.texImage3D(c,h,p,t,i,s.depth,0,u,d,null):n.texImage2D(c,h,p,t,i,0,u,d,null)}n.bindFramebuffer(e.FRAMEBUFFER,t),B(s)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,f.__webglTexture,0,z(s)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,f.__webglTexture,h),n.bindFramebuffer(e.FRAMEBUFFER,null)}function k(t,n,i){if(e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer){const s=n.depthTexture,a=s&&s.isDepthTexture?s.type:null,r=b(n.stencilBuffer,a),l=n.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=z(n);B(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,c,r,n.width,n.height):i?e.renderbufferStorageMultisample(e.RENDERBUFFER,c,r,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,r,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,t)}else{const t=n.textures;for(let s=0;s<t.length;s++){const r=t[s],l=a.convert(r.format,r.colorSpace),c=a.convert(r.type),h=y(r.internalFormat,l,c,r.colorSpace),u=z(n);i&&!1===B(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,u,h,n.width,n.height):B(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,u,h,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,h,n.width,n.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function L(t,s){if(s&&s.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(e.FRAMEBUFFER,t),!s.depthTexture||!s.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const a=i.get(s.depthTexture);a.__renderTarget=s,a.__webglTexture&&s.depthTexture.image.width===s.width&&s.depthTexture.image.height===s.height||(s.depthTexture.image.width=s.width,s.depthTexture.image.height=s.height,s.depthTexture.needsUpdate=!0),E(s.depthTexture,0);const r=a.__webglTexture,l=z(s);if(s.depthTexture.format===nc)B(s)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0);else{if(s.depthTexture.format!==ic)throw new Error("Unknown depthTexture format");B(s)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,r,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,r,0)}}function O(t){const s=i.get(t),a=!0===t.isWebGLCubeRenderTarget;if(s.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(s.__depthDisposeCallback&&s.__depthDisposeCallback(),e){const t=()=>{delete s.__boundDepthTexture,delete s.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),s.__depthDisposeCallback=t}s.__boundDepthTexture=e}if(t.depthTexture&&!s.__autoAllocateDepthBuffer){if(a)throw new Error("target.depthTexture not supported in Cube render targets");const e=t.texture.mipmaps;e&&e.length>0?L(s.__webglFramebuffer[0],t):L(s.__webglFramebuffer,t)}else if(a){s.__webglDepthbuffer=[];for(let i=0;i<6;i++)if(n.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer[i]),void 0===s.__webglDepthbuffer[i])s.__webglDepthbuffer[i]=e.createRenderbuffer(),k(s.__webglDepthbuffer[i],t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,a=s.__webglDepthbuffer[i];e.bindRenderbuffer(e.RENDERBUFFER,a),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,a)}}else{const i=t.texture.mipmaps;if(i&&i.length>0?n.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer[0]):n.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer),void 0===s.__webglDepthbuffer)s.__webglDepthbuffer=e.createRenderbuffer(),k(s.__webglDepthbuffer,t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,i=s.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,i)}}n.bindFramebuffer(e.FRAMEBUFFER,null)}const U=[],F=[];function z(e){return Math.min(s.maxSamples,e.samples)}function B(e){const n=i.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function V(e,t){const n=e.colorSpace;return e.format,e.type,!0===e.isCompressedTexture||!0===e.isVideoTexture||n!==zc&&n!==Uc&&Eh.getTransfer(n),t}function H(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(c.width=e.naturalWidth||e.width,c.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(c.width=e.displayWidth,c.height=e.displayHeight):(c.width=e.width,c.height=e.height),c}this.allocateTextureUnit=function(){const e=T;return s.maxTextures,T+=1,e},this.resetTextureUnits=function(){T=0},this.setTexture2D=E,this.setTexture2DArray=function(t,s){const a=i.get(t);t.version>0&&a.__version!==t.version?I(a,t,s):n.bindTexture(e.TEXTURE_2D_ARRAY,a.__webglTexture,e.TEXTURE0+s)},this.setTexture3D=function(t,s){const a=i.get(t);t.version>0&&a.__version!==t.version?I(a,t,s):n.bindTexture(e.TEXTURE_3D,a.__webglTexture,e.TEXTURE0+s)},this.setTextureCube=function(t,r){const o=i.get(t);t.version>0&&o.__version!==t.version?function(t,r,o){if(6!==r.image.length)return;const l=j(t,r),c=r.source;n.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+o);const h=i.get(c);if(c.version!==h.__version||!0===l){n.activeTexture(e.TEXTURE0+o);const t=Eh.getPrimaries(Eh.workingColorSpace),i=r.colorSpace===Uc?null:Eh.getPrimaries(r.colorSpace),u=r.colorSpace===Uc||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,r.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,u);const d=r.isCompressedTexture||r.image[0].isCompressedTexture,p=r.image[0]&&r.image[0].isDataTexture,m=[];for(let e=0;e<6;e++)m[e]=d||p?p?r.image[e].image:r.image[e]:f(r.image[e],!0,s.maxCubemapSize),m[e]=V(r,m[e]);const x=m[0],b=a.convert(r.format,r.colorSpace),w=a.convert(r.type),S=y(r.internalFormat,b,w,r.colorSpace),M=!0!==r.isVideoTexture,T=void 0===h.__version||!0===l,E=c.dataReady;let C,N=_(r,x);if(R(e.TEXTURE_CUBE_MAP,r),d){M&&T&&n.texStorage2D(e.TEXTURE_CUBE_MAP,N,S,x.width,x.height);for(let t=0;t<6;t++){C=m[t].mipmaps;for(let i=0;i<C.length;i++){const s=C[i];r.format!==tc?null!==b&&(M?E&&n.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,s.width,s.height,b,s.data):n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,S,s.width,s.height,0,s.data)):M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,s.width,s.height,b,w,s.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,S,s.width,s.height,0,b,w,s.data)}}}else{if(C=r.mipmaps,M&&T){C.length>0&&N++;const t=H(m[0]);n.texStorage2D(e.TEXTURE_CUBE_MAP,N,S,t.width,t.height)}for(let t=0;t<6;t++)if(p){M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,m[t].width,m[t].height,b,w,m[t].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,S,m[t].width,m[t].height,0,b,w,m[t].data);for(let i=0;i<C.length;i++){const s=C[i].image[t].image;M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,s.width,s.height,b,w,s.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,S,s.width,s.height,0,b,w,s.data)}}else{M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,b,w,m[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,S,b,w,m[t]);for(let i=0;i<C.length;i++){const s=C[i];M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,b,w,s.image[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,S,b,w,s.image[t])}}}g(r)&&v(e.TEXTURE_CUBE_MAP),h.__version=c.version,r.onUpdate&&r.onUpdate(r)}t.__version=r.version}(o,t,r):n.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture,e.TEXTURE0+r)},this.rebindTextures=function(t,n,s){const a=i.get(t);void 0!==n&&D(a.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==s&&O(t)},this.setupRenderTarget=function(t){const s=t.texture,o=i.get(t),l=i.get(s);t.addEventListener("dispose",S);const c=t.textures,h=!0===t.isWebGLCubeRenderTarget,u=c.length>1;if(u||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=s.version,r.memory.textures++),h){o.__webglFramebuffer=[];for(let t=0;t<6;t++)if(s.mipmaps&&s.mipmaps.length>0){o.__webglFramebuffer[t]=[];for(let n=0;n<s.mipmaps.length;n++)o.__webglFramebuffer[t][n]=e.createFramebuffer()}else o.__webglFramebuffer[t]=e.createFramebuffer()}else{if(s.mipmaps&&s.mipmaps.length>0){o.__webglFramebuffer=[];for(let t=0;t<s.mipmaps.length;t++)o.__webglFramebuffer[t]=e.createFramebuffer()}else o.__webglFramebuffer=e.createFramebuffer();if(u)for(let t=0,n=c.length;t<n;t++){const n=i.get(c[t]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),r.memory.textures++)}if(t.samples>0&&!1===B(t)){o.__webglMultisampledFramebuffer=e.createFramebuffer(),o.__webglColorRenderbuffer=[],n.bindFramebuffer(e.FRAMEBUFFER,o.__webglMultisampledFramebuffer);for(let n=0;n<c.length;n++){const i=c[n];o.__webglColorRenderbuffer[n]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,o.__webglColorRenderbuffer[n]);const s=a.convert(i.format,i.colorSpace),r=a.convert(i.type),l=y(i.internalFormat,s,r,i.colorSpace,!0===t.isXRRenderTarget),h=z(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,h,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.RENDERBUFFER,o.__webglColorRenderbuffer[n])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(o.__webglDepthRenderbuffer=e.createRenderbuffer(),k(o.__webglDepthRenderbuffer,t,!0)),n.bindFramebuffer(e.FRAMEBUFFER,null)}}if(h){n.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),R(e.TEXTURE_CUBE_MAP,s);for(let n=0;n<6;n++)if(s.mipmaps&&s.mipmaps.length>0)for(let i=0;i<s.mipmaps.length;i++)D(o.__webglFramebuffer[n][i],t,s,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,i);else D(o.__webglFramebuffer[n],t,s,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0);g(s)&&v(e.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(u){for(let s=0,a=c.length;s<a;s++){const a=c[s],r=i.get(a);n.bindTexture(e.TEXTURE_2D,r.__webglTexture),R(e.TEXTURE_2D,a),D(o.__webglFramebuffer,t,a,e.COLOR_ATTACHMENT0+s,e.TEXTURE_2D,0),g(a)&&v(e.TEXTURE_2D)}n.unbindTexture()}else{let i=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(i=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),n.bindTexture(i,l.__webglTexture),R(i,s),s.mipmaps&&s.mipmaps.length>0)for(let n=0;n<s.mipmaps.length;n++)D(o.__webglFramebuffer[n],t,s,e.COLOR_ATTACHMENT0,i,n);else D(o.__webglFramebuffer,t,s,e.COLOR_ATTACHMENT0,i,0);g(s)&&v(i),n.unbindTexture()}t.depthBuffer&&O(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let s=0,a=t.length;s<a;s++){const a=t[s];if(g(a)){const t=x(e),s=i.get(a).__webglTexture;n.bindTexture(t,s),v(t),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===B(t)){const s=t.textures,a=t.width,r=t.height;let o=e.COLOR_BUFFER_BIT;const c=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,h=i.get(t),u=s.length>1;if(u)for(let t=0;t<s.length;t++)n.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),n.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);n.bindFramebuffer(e.READ_FRAMEBUFFER,h.__webglMultisampledFramebuffer);const d=t.texture.mipmaps;d&&d.length>0?n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer[0]):n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer);for(let n=0;n<s.length;n++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),u){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,h.__webglColorRenderbuffer[n]);const t=i.get(s[n]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,a,r,0,0,a,r,o,e.NEAREST),!0===l&&(U.length=0,F.length=0,U.push(e.COLOR_ATTACHMENT0+n),t.depthBuffer&&!1===t.resolveDepthBuffer&&(U.push(c),F.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,F)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,U))}if(n.bindFramebuffer(e.READ_FRAMEBUFFER,null),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),u)for(let t=0;t<s.length;t++){n.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,h.__webglColorRenderbuffer[t]);const a=i.get(s[t]).__webglTexture;n.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,a,0)}n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[n])}},this.setupDepthRenderbuffer=O,this.setupFrameBufferTexture=D,this.useMultisampledRTT=B}function cg(e,t){return{convert:function(n,i=""){let s;const a=Eh.getTransfer(i);if(n===ql)return e.UNSIGNED_BYTE;if(n===Jl)return e.UNSIGNED_SHORT_4_4_4_4;if(n===Ql)return e.UNSIGNED_SHORT_5_5_5_1;if(35902===n)return e.UNSIGNED_INT_5_9_9_9_REV;if(1010===n)return e.BYTE;if(1011===n)return e.SHORT;if(n===$l)return e.UNSIGNED_SHORT;if(n===Xl)return e.INT;if(n===Yl)return e.UNSIGNED_INT;if(n===Kl)return e.FLOAT;if(n===Zl)return e.HALF_FLOAT;if(1021===n)return e.ALPHA;if(1022===n)return e.RGB;if(n===tc)return e.RGBA;if(n===nc)return e.DEPTH_COMPONENT;if(n===ic)return e.DEPTH_STENCIL;if(1028===n)return e.RED;if(n===sc)return e.RED_INTEGER;if(1030===n)return e.RG;if(n===ac)return e.RG_INTEGER;if(n===rc)return e.RGBA_INTEGER;if(n===oc||n===lc||n===cc||n===hc)if(a===Vc){if(s=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===s)return null;if(n===oc)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===lc)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===cc)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===hc)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(s=t.get("WEBGL_compressed_texture_s3tc"),null===s)return null;if(n===oc)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===lc)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===cc)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===hc)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(n===uc||n===dc||n===pc||n===mc){if(s=t.get("WEBGL_compressed_texture_pvrtc"),null===s)return null;if(n===uc)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===dc)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===pc)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===mc)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(n===fc||n===gc||n===vc){if(s=t.get("WEBGL_compressed_texture_etc"),null===s)return null;if(n===fc||n===gc)return a===Vc?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(n===vc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC}if(n===xc||n===yc||n===bc||n===_c||n===wc||n===Sc||n===Mc||n===Tc||n===Ec||n===Cc||n===Nc||n===Ac||n===Rc||n===jc){if(s=t.get("WEBGL_compressed_texture_astc"),null===s)return null;if(n===xc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===yc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===bc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===_c)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===wc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===Sc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===Mc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===Tc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===Ec)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===Cc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===Nc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===Ac)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===Rc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===jc)return a===Vc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===Pc||n===Ic||n===Dc){if(s=t.get("EXT_texture_compression_bptc"),null===s)return null;if(n===Pc)return a===Vc?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(n===Ic)return s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(n===Dc)return s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===n||n===kc||n===Lc||n===Oc){if(s=t.get("EXT_texture_compression_rgtc"),null===s)return null;if(n===Pc)return s.COMPRESSED_RED_RGTC1_EXT;if(n===kc)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(n===Lc)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(n===Oc)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return n===ec?e.UNSIGNED_INT_24_8:void 0!==e[n]?e[n]:null}}}class hg{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,n){if(null===this.texture){const i=new Lh;e.properties.get(i).__webglTexture=t.texture,t.depthNear===n.depthNear&&t.depthFar===n.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=i}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,n=new Gd({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new Ud(new xp(20,20),n)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class ug extends th{constructor(e,t){super();const n=this;let i=null,s=1,a=null,r="local-floor",o=1,l=null,c=null,h=null,u=null,d=null,p=null;const m=new hg,f=t.getContextAttributes();let g=null,v=null;const x=[],y=[],b=new uh;let _=null;const w=new Kd;w.viewport=new Oh;const S=new Kd;S.viewport=new Oh;const M=[w,S],T=new Pp;let E=null,C=null;function N(e){const t=y.indexOf(e.inputSource);if(-1===t)return;const n=x[t];void 0!==n&&(n.update(e.inputSource,e.frame,l||a),n.dispatchEvent({type:e.type,data:e.inputSource}))}function A(){i.removeEventListener("select",N),i.removeEventListener("selectstart",N),i.removeEventListener("selectend",N),i.removeEventListener("squeeze",N),i.removeEventListener("squeezestart",N),i.removeEventListener("squeezeend",N),i.removeEventListener("end",A),i.removeEventListener("inputsourceschange",R);for(let e=0;e<x.length;e++){const t=y[e];null!==t&&(y[e]=null,x[e].disconnect(t))}E=null,C=null,m.reset(),e.setRenderTarget(g),d=null,u=null,h=null,i=null,v=null,k.stop(),n.isPresenting=!1,e.setPixelRatio(_),e.setSize(b.width,b.height,!1),n.dispatchEvent({type:"sessionend"})}function R(e){for(let t=0;t<e.removed.length;t++){const n=e.removed[t],i=y.indexOf(n);i>=0&&(y[i]=null,x[i].disconnect(n))}for(let t=0;t<e.added.length;t++){const n=e.added[t];let i=y.indexOf(n);if(-1===i){for(let e=0;e<x.length;e++){if(e>=y.length){y.push(n),i=e;break}if(null===y[e]){y[e]=n,i=e;break}}if(-1===i)break}const s=x[i];s&&s.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=x[e];return void 0===t&&(t=new ip,x[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=x[e];return void 0===t&&(t=new ip,x[e]=t),t.getGripSpace()},this.getHand=function(e){let t=x[e];return void 0===t&&(t=new ip,x[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){s=e,n.isPresenting},this.setReferenceSpaceType=function(e){r=e,n.isPresenting},this.getReferenceSpace=function(){return l||a},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==u?u:d},this.getBinding=function(){return h},this.getFrame=function(){return p},this.getSession=function(){return i},this.setSession=async function(c){if(i=c,null!==i){if(g=e.getRenderTarget(),i.addEventListener("select",N),i.addEventListener("selectstart",N),i.addEventListener("selectend",N),i.addEventListener("squeeze",N),i.addEventListener("squeezestart",N),i.addEventListener("squeezeend",N),i.addEventListener("end",A),i.addEventListener("inputsourceschange",R),!0!==f.xrCompatible&&await t.makeXRCompatible(),_=e.getPixelRatio(),e.getSize(b),"undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype){let n=null,a=null,r=null;f.depth&&(r=f.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,n=f.stencil?ic:nc,a=f.stencil?ec:Yl);const o={colorFormat:t.RGBA8,depthFormat:r,scaleFactor:s};h=new XRWebGLBinding(i,t),u=h.createProjectionLayer(o),i.updateRenderState({layers:[u]}),e.setPixelRatio(1),e.setSize(u.textureWidth,u.textureHeight,!1),v=new Fh(u.textureWidth,u.textureHeight,{format:tc,type:ql,depthTexture:new pp(u.textureWidth,u.textureHeight,a,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:f.stencil,colorSpace:e.outputColorSpace,samples:f.antialias?4:0,resolveDepthBuffer:!1===u.ignoreDepthValues,resolveStencilBuffer:!1===u.ignoreDepthValues})}else{const n={antialias:f.antialias,alpha:!0,depth:f.depth,stencil:f.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(i,t,n),i.updateRenderState({baseLayer:d}),e.setPixelRatio(1),e.setSize(d.framebufferWidth,d.framebufferHeight,!1),v=new Fh(d.framebufferWidth,d.framebufferHeight,{format:tc,type:ql,colorSpace:e.outputColorSpace,stencilBuffer:f.stencil,resolveDepthBuffer:!1===d.ignoreDepthValues,resolveStencilBuffer:!1===d.ignoreDepthValues})}v.isXRRenderTarget=!0,this.setFoveation(o),l=null,a=await i.requestReferenceSpace(r),k.setContext(i),k.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==i)return i.environmentBlendMode},this.getDepthTexture=function(){return m.getDepthTexture()};const j=new ph,P=new ph;function I(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===i)return;let t=e.near,n=e.far;null!==m.texture&&(m.depthNear>0&&(t=m.depthNear),m.depthFar>0&&(n=m.depthFar)),T.near=S.near=w.near=t,T.far=S.far=w.far=n,E===T.near&&C===T.far||(i.updateRenderState({depthNear:T.near,depthFar:T.far}),E=T.near,C=T.far),w.layers.mask=2|e.layers.mask,S.layers.mask=4|e.layers.mask,T.layers.mask=w.layers.mask|S.layers.mask;const s=e.parent,a=T.cameras;I(T,s);for(let i=0;i<a.length;i++)I(a[i],s);2===a.length?function(e,t,n){j.setFromMatrixPosition(t.matrixWorld),P.setFromMatrixPosition(n.matrixWorld);const i=j.distanceTo(P),s=t.projectionMatrix.elements,a=n.projectionMatrix.elements,r=s[14]/(s[10]-1),o=s[14]/(s[10]+1),l=(s[9]+1)/s[5],c=(s[9]-1)/s[5],h=(s[8]-1)/s[0],u=(a[8]+1)/a[0],d=r*h,p=r*u,m=i/(-h+u),f=m*-h;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===s[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=r+m,n=o+m,s=d-f,a=p+(i-f),h=l*o/n*t,u=c*o/n*t;e.projectionMatrix.makePerspective(s,a,h,u,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(T,w,S):T.projectionMatrix.copy(w.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld)),e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*sh*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,T,s)},this.getCamera=function(){return T},this.getFoveation=function(){if(null!==u||null!==d)return o},this.setFoveation=function(e){o=e,null!==u&&(u.fixedFoveation=e),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==m.texture},this.getDepthSensingMesh=function(){return m.getMesh(T)};let D=null;const k=new Lp;k.setAnimationLoop(function(t,s){if(c=s.getViewerPose(l||a),p=s,null!==c){const t=c.views;null!==d&&(e.setRenderTargetFramebuffer(v,d.framebuffer),e.setRenderTarget(v));let n=!1;t.length!==T.cameras.length&&(T.cameras.length=0,n=!0);for(let i=0;i<t.length;i++){const s=t[i];let a=null;if(null!==d)a=d.getViewport(s);else{const t=h.getViewSubImage(u,s);a=t.viewport,0===i&&(e.setRenderTargetTextures(v,t.colorTexture,t.depthStencilTexture),e.setRenderTarget(v))}let r=M[i];void 0===r&&(r=new Kd,r.layers.enable(i),r.viewport=new Oh,M[i]=r),r.matrix.fromArray(s.transform.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale),r.projectionMatrix.fromArray(s.projectionMatrix),r.projectionMatrixInverse.copy(r.projectionMatrix).invert(),r.viewport.set(a.x,a.y,a.width,a.height),0===i&&(T.matrix.copy(r.matrix),T.matrix.decompose(T.position,T.quaternion,T.scale)),!0===n&&T.cameras.push(r)}const s=i.enabledFeatures;if(s&&s.includes("depth-sensing")&&"gpu-optimized"==i.depthUsage&&h){const n=h.getDepthInformation(t[0]);n&&n.isValid&&n.texture&&m.init(e,n,i.renderState)}}for(let e=0;e<x.length;e++){const t=y[e],n=x[e];null!==t&&void 0!==n&&n.update(t,s,l||a)}D&&D(t,s),s.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:s}),p=null}),this.setAnimationLoop=function(e){D=e},this.dispose=function(){}}}const dg=new Tu,pg=new fu;function mg(e,t){function n(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function i(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map,n(i.map,e.mapTransform)),i.alphaMap&&(e.alphaMap.value=i.alphaMap,n(i.alphaMap,e.alphaMapTransform)),i.bumpMap&&(e.bumpMap.value=i.bumpMap,n(i.bumpMap,e.bumpMapTransform),e.bumpScale.value=i.bumpScale,1===i.side&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,n(i.normalMap,e.normalMapTransform),e.normalScale.value.copy(i.normalScale),1===i.side&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,n(i.displacementMap,e.displacementMapTransform),e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap,n(i.emissiveMap,e.emissiveMapTransform)),i.specularMap&&(e.specularMap.value=i.specularMap,n(i.specularMap,e.specularMapTransform)),i.alphaTest>0&&(e.alphaTest.value=i.alphaTest);const s=t.get(i),a=s.envMap,r=s.envMapRotation;a&&(e.envMap.value=a,dg.copy(r),dg.x*=-1,dg.y*=-1,dg.z*=-1,a.isCubeTexture&&!1===a.isRenderTargetTexture&&(dg.y*=-1,dg.z*=-1),e.envMapRotation.value.setFromMatrix4(pg.makeRotationFromEuler(dg)),e.flipEnvMap.value=a.isCubeTexture&&!1===a.isRenderTargetTexture?-1:1,e.reflectivity.value=i.reflectivity,e.ior.value=i.ior,e.refractionRatio.value=i.refractionRatio),i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity,n(i.lightMap,e.lightMapTransform)),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity,n(i.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,n){n.color.getRGB(t.fogColor.value,Hd(e)),n.isFog?(t.fogNear.value=n.near,t.fogFar.value=n.far):n.isFogExp2&&(t.fogDensity.value=n.density)},refreshMaterialUniforms:function(e,s,a,r,o){s.isMeshBasicMaterial||s.isMeshLambertMaterial?i(e,s):s.isMeshToonMaterial?(i(e,s),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,s)):s.isMeshPhongMaterial?(i(e,s),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,s)):s.isMeshStandardMaterial?(i(e,s),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,n(t.metalnessMap,e.metalnessMapTransform)),e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,n(t.roughnessMap,e.roughnessMapTransform)),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,s),s.isMeshPhysicalMaterial&&function(e,t,i){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,n(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,n(t.sheenRoughnessMap,e.sheenRoughnessMapTransform))),t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,n(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,n(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,n(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate())),t.dispersion>0&&(e.dispersion.value=t.dispersion),t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,n(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,n(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform))),t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=i.texture,e.transmissionSamplerSize.value.set(i.width,i.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,n(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,n(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor)),t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,n(t.anisotropyMap,e.anisotropyMapTransform))),e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,n(t.specularColorMap,e.specularColorMapTransform)),t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,n(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,s,o)):s.isMeshMatcapMaterial?(i(e,s),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,s)):s.isMeshDepthMaterial?i(e,s):s.isMeshDistanceMaterial?(i(e,s),function(e,n){const i=t.get(n).light;e.referencePosition.value.setFromMatrixPosition(i.matrixWorld),e.nearDistance.value=i.shadow.camera.near,e.farDistance.value=i.shadow.camera.far}(e,s)):s.isMeshNormalMaterial?i(e,s):s.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform))}(e,s),s.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,s)):s.isPointsMaterial?function(e,t,i,s){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*s,t.map&&(e.map.value=t.map,n(t.map,e.uvTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform)),t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,s,a,r):s.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform)),t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,s):s.isShadowMaterial?(e.color.value.copy(s.color),e.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function fg(e,t,n,i){let s={},a={},r=[];const o=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,n,i){const s=e.value,a=t+"_"+n;if(void 0===i[a])return i[a]="number"==typeof s||"boolean"==typeof s?s:s.clone(),!0;{const e=i[a];if("number"==typeof s||"boolean"==typeof s){if(e!==s)return i[a]=s,!0}else if(!1===e.equals(s))return e.copy(s),!0}return!1}function c(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture,t}function h(t){const n=t.target;n.removeEventListener("dispose",h);const i=r.indexOf(n.__bindingPointIndex);r.splice(i,1),e.deleteBuffer(s[n.id]),delete s[n.id],delete a[n.id]}return{bind:function(e,t){const n=t.program;i.uniformBlockBinding(e,n)},update:function(n,u){let d=s[n.id];void 0===d&&(function(e){const t=e.uniforms;let n=0;for(let s=0,a=t.length;s<a;s++){const e=Array.isArray(t[s])?t[s]:[t[s]];for(let t=0,i=e.length;t<i;t++){const i=e[t],s=Array.isArray(i.value)?i.value:[i.value];for(let e=0,t=s.length;e<t;e++){const t=c(s[e]),a=n%16,r=a%t.boundary,o=a+r;n+=r,0!==o&&16-o<t.storage&&(n+=16-o),i.__data=new Float32Array(t.storage/Float32Array.BYTES_PER_ELEMENT),i.__offset=n,n+=t.storage}}}const i=n%16;i>0&&(n+=16-i),e.__size=n,e.__cache={}}(n),d=function(t){const n=function(){for(let e=0;e<o;e++)if(-1===r.indexOf(e))return r.push(e),e;return 0}();t.__bindingPointIndex=n;const i=e.createBuffer(),s=t.__size,a=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,i),e.bufferData(e.UNIFORM_BUFFER,s,a),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,i),i}(n),s[n.id]=d,n.addEventListener("dispose",h));const p=u.program;i.updateUBOMapping(n,p);const m=t.render.frame;a[n.id]!==m&&(function(t){const n=s[t.id],i=t.uniforms,a=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let s=0,r=i.length;s<r;s++){const t=Array.isArray(i[s])?i[s]:[i[s]];for(let n=0,i=t.length;n<i;n++){const i=t[n];if(!0===l(i,s,n,a)){const t=i.__offset,n=Array.isArray(i.value)?i.value:[i.value];let s=0;for(let a=0;a<n.length;a++){const r=n[a],o=c(r);"number"==typeof r||"boolean"==typeof r?(i.__data[0]=r,e.bufferSubData(e.UNIFORM_BUFFER,t+s,i.__data)):r.isMatrix3?(i.__data[0]=r.elements[0],i.__data[1]=r.elements[1],i.__data[2]=r.elements[2],i.__data[3]=0,i.__data[4]=r.elements[3],i.__data[5]=r.elements[4],i.__data[6]=r.elements[5],i.__data[7]=0,i.__data[8]=r.elements[6],i.__data[9]=r.elements[7],i.__data[10]=r.elements[8],i.__data[11]=0):(r.toArray(i.__data,s),s+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,i.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),a[n.id]=m)},dispose:function(){for(const t in s)e.deleteBuffer(s[t]);r=[],s={},a={}}}}class gg{constructor(e={}){const{canvas:t=bh(),context:n=null,depth:i=!0,stencil:s=!1,alpha:a=!1,antialias:r=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:l=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:h=!1,reverseDepthBuffer:u=!1}=e;let d;if(this.isWebGLRenderer=!0,null!==n){if("undefined"!=typeof WebGLRenderingContext&&n instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");d=n.getContextAttributes().alpha}else d=a;const p=new Uint32Array(4),m=new Int32Array(4);let f=null,g=null;const v=[],x=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=0,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const y=this;let b=!1;this._outputColorSpace=Fc;let _=0,w=0,S=null,M=-1,T=null;const E=new Oh,C=new Oh;let N=null;const A=new od(0);let R=0,j=t.width,P=t.height,I=1,D=null,k=null;const L=new Oh(0,0,j,P),O=new Oh(0,0,j,P);let U=!1;const F=new dp;let z=!1,B=!1;const V=new fu,H=new fu,W=new ph,G=new Oh,q={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let $=!1;function X(){return null===S?I:1}let Y,K,Z,J,Q,ee,te,ne,ie,se,ae,re,oe,le,ce,he,ue,de,pe,me,fe,ge,ve,xe,ye=n;function be(e,n){return t.getContext(e,n)}try{const e={alpha:!0,depth:i,stencil:s,antialias:r,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:h};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${sl}`),t.addEventListener("webglcontextlost",Se,!1),t.addEventListener("webglcontextrestored",Me,!1),t.addEventListener("webglcontextcreationerror",Te,!1),null===ye){const t="webgl2";if(ye=be(t,e),null===ye)throw be(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(He){throw He}function _e(){Y=new pm(ye),Y.init(),ge=new cg(ye,Y),K=new $p(ye,Y,e,ge),Z=new og(ye,Y),K.reverseDepthBuffer&&u&&Z.buffers.depth.setReversed(!0),J=new gm(ye),Q=new Xf,ee=new lg(ye,Y,Z,Q,K,ge,J),te=new Yp(y),ne=new dm(y),ie=new Op(ye),ve=new Gp(ye,ie),se=new mm(ye,ie,J,ve),ae=new xm(ye,se,ie,J),pe=new vm(ye,K,ee),he=new Xp(Q),re=new $f(y,te,ne,Y,K,ve,he),oe=new mg(y,Q),le=new Jf,ce=new sg(Y),de=new Wp(y,te,ne,Z,ae,d,o),ue=new ag(y,ae,K),xe=new fg(ye,J,K,Z),me=new qp(ye,Y,J),fe=new fm(ye,Y,J),J.programs=re.programs,y.capabilities=K,y.extensions=Y,y.properties=Q,y.renderLists=le,y.shadowMap=ue,y.state=Z,y.info=J}_e();const we=new ug(y,ye);function Se(e){e.preventDefault(),b=!0}function Me(){b=!1;const e=J.autoReset,t=ue.enabled,n=ue.autoUpdate,i=ue.needsUpdate,s=ue.type;_e(),J.autoReset=e,ue.enabled=t,ue.autoUpdate=n,ue.needsUpdate=i,ue.type=s}function Te(e){}function Ee(e){const t=e.target;t.removeEventListener("dispose",Ee),function(e){(function(e){const t=Q.get(e).programs;void 0!==t&&(t.forEach(function(e){re.releaseProgram(e)}),e.isShaderMaterial&&re.releaseShaderCache(e))})(e),Q.remove(e)}(t)}function Ce(e,t,n){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Oe(e,t,n),e.side=0,e.needsUpdate=!0,Oe(e,t,n),e.side=2):Oe(e,t,n)}this.xr=we,this.getContext=function(){return ye},this.getContextAttributes=function(){return ye.getContextAttributes()},this.forceContextLoss=function(){const e=Y.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=Y.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return I},this.setPixelRatio=function(e){void 0!==e&&(I=e,this.setSize(j,P,!1))},this.getSize=function(e){return e.set(j,P)},this.setSize=function(e,n,i=!0){we.isPresenting||(j=e,P=n,t.width=Math.floor(e*I),t.height=Math.floor(n*I),!0===i&&(t.style.width=e+"px",t.style.height=n+"px"),this.setViewport(0,0,e,n))},this.getDrawingBufferSize=function(e){return e.set(j*I,P*I).floor()},this.setDrawingBufferSize=function(e,n,i){j=e,P=n,I=i,t.width=Math.floor(e*i),t.height=Math.floor(n*i),this.setViewport(0,0,e,n)},this.getCurrentViewport=function(e){return e.copy(E)},this.getViewport=function(e){return e.copy(L)},this.setViewport=function(e,t,n,i){e.isVector4?L.set(e.x,e.y,e.z,e.w):L.set(e,t,n,i),Z.viewport(E.copy(L).multiplyScalar(I).round())},this.getScissor=function(e){return e.copy(O)},this.setScissor=function(e,t,n,i){e.isVector4?O.set(e.x,e.y,e.z,e.w):O.set(e,t,n,i),Z.scissor(C.copy(O).multiplyScalar(I).round())},this.getScissorTest=function(){return U},this.setScissorTest=function(e){Z.setScissorTest(U=e)},this.setOpaqueSort=function(e){D=e},this.setTransparentSort=function(e){k=e},this.getClearColor=function(e){return e.copy(de.getClearColor())},this.setClearColor=function(){de.setClearColor(...arguments)},this.getClearAlpha=function(){return de.getClearAlpha()},this.setClearAlpha=function(){de.setClearAlpha(...arguments)},this.clear=function(e=!0,t=!0,n=!0){let i=0;if(e){let e=!1;if(null!==S){const t=S.texture.format;e=t===rc||t===ac||t===sc}if(e){const e=S.texture.type,t=e===ql||e===Yl||e===$l||e===ec||e===Jl||e===Ql,n=de.getClearColor(),i=de.getClearAlpha(),s=n.r,a=n.g,r=n.b;t?(p[0]=s,p[1]=a,p[2]=r,p[3]=i,ye.clearBufferuiv(ye.COLOR,0,p)):(m[0]=s,m[1]=a,m[2]=r,m[3]=i,ye.clearBufferiv(ye.COLOR,0,m))}else i|=ye.COLOR_BUFFER_BIT}t&&(i|=ye.DEPTH_BUFFER_BIT),n&&(i|=ye.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),ye.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Se,!1),t.removeEventListener("webglcontextrestored",Me,!1),t.removeEventListener("webglcontextcreationerror",Te,!1),de.dispose(),le.dispose(),ce.dispose(),Q.dispose(),te.dispose(),ne.dispose(),ae.dispose(),ve.dispose(),xe.dispose(),re.dispose(),we.dispose(),we.removeEventListener("sessionstart",Ae),we.removeEventListener("sessionend",Re),je.stop()},this.renderBufferDirect=function(e,t,n,i,s,a){null===t&&(t=q);const r=s.isMesh&&s.matrixWorld.determinant()<0,o=function(e,t,n,i,s){!0!==t.isScene&&(t=q),ee.resetTextureUnits();const a=t.fog,r=i.isMeshStandardMaterial?t.environment:null,o=null===S?y.outputColorSpace:!0===S.isXRRenderTarget?S.texture.colorSpace:zc,l=(i.isMeshStandardMaterial?ne:te).get(i.envMap||r),c=!0===i.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,h=!!n.attributes.tangent&&(!!i.normalMap||i.anisotropy>0),u=!!n.morphAttributes.position,d=!!n.morphAttributes.normal,p=!!n.morphAttributes.color;let m=0;i.toneMapped&&(null!==S&&!0!==S.isXRRenderTarget||(m=y.toneMapping));const f=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,v=void 0!==f?f.length:0,x=Q.get(i),b=g.state.lights;if(!0===z&&(!0===B||e!==T)){const t=e===T&&i.id===M;he.setState(i,e,t)}let _=!1;i.version===x.__version?x.needsLights&&x.lightsStateVersion!==b.state.version||x.outputColorSpace!==o||s.isBatchedMesh&&!1===x.batching?_=!0:s.isBatchedMesh||!0!==x.batching?s.isBatchedMesh&&!0===x.batchingColor&&null===s.colorTexture||s.isBatchedMesh&&!1===x.batchingColor&&null!==s.colorTexture||s.isInstancedMesh&&!1===x.instancing?_=!0:s.isInstancedMesh||!0!==x.instancing?s.isSkinnedMesh&&!1===x.skinning?_=!0:s.isSkinnedMesh||!0!==x.skinning?s.isInstancedMesh&&!0===x.instancingColor&&null===s.instanceColor||s.isInstancedMesh&&!1===x.instancingColor&&null!==s.instanceColor||s.isInstancedMesh&&!0===x.instancingMorph&&null===s.morphTexture||s.isInstancedMesh&&!1===x.instancingMorph&&null!==s.morphTexture||x.envMap!==l||!0===i.fog&&x.fog!==a?_=!0:void 0===x.numClippingPlanes||x.numClippingPlanes===he.numPlanes&&x.numIntersection===he.numIntersection?(x.vertexAlphas!==c||x.vertexTangents!==h||x.morphTargets!==u||x.morphNormals!==d||x.morphColors!==p||x.toneMapping!==m||x.morphTargetsCount!==v)&&(_=!0):_=!0:_=!0:_=!0:_=!0:(_=!0,x.__version=i.version);let w=x.currentProgram;!0===_&&(w=Oe(i,t,s));let E=!1,C=!1,N=!1;const A=w.getUniforms(),R=x.uniforms;if(Z.useProgram(w.program)&&(E=!0,C=!0,N=!0),i.id!==M&&(M=i.id,C=!0),E||T!==e){Z.buffers.depth.getReversed()?(V.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}(V),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}(V),A.setValue(ye,"projectionMatrix",V)):A.setValue(ye,"projectionMatrix",e.projectionMatrix),A.setValue(ye,"viewMatrix",e.matrixWorldInverse);const t=A.map.cameraPosition;void 0!==t&&t.setValue(ye,W.setFromMatrixPosition(e.matrixWorld)),K.logarithmicDepthBuffer&&A.setValue(ye,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&A.setValue(ye,"isOrthographic",!0===e.isOrthographicCamera),T!==e&&(T=e,C=!0,N=!0)}if(s.isSkinnedMesh){A.setOptional(ye,s,"bindMatrix"),A.setOptional(ye,s,"bindMatrixInverse");const e=s.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),A.setValue(ye,"boneTexture",e.boneTexture,ee))}s.isBatchedMesh&&(A.setOptional(ye,s,"batchingTexture"),A.setValue(ye,"batchingTexture",s._matricesTexture,ee),A.setOptional(ye,s,"batchingIdTexture"),A.setValue(ye,"batchingIdTexture",s._indirectTexture,ee),A.setOptional(ye,s,"batchingColorTexture"),null!==s._colorsTexture&&A.setValue(ye,"batchingColorTexture",s._colorsTexture,ee));const j=n.morphAttributes;var D,k;if(void 0===j.position&&void 0===j.normal&&void 0===j.color||pe.update(s,n,w),(C||x.receiveShadow!==s.receiveShadow)&&(x.receiveShadow=s.receiveShadow,A.setValue(ye,"receiveShadow",s.receiveShadow)),i.isMeshGouraudMaterial&&null!==i.envMap&&(R.envMap.value=l,R.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1),i.isMeshStandardMaterial&&null===i.envMap&&null!==t.environment&&(R.envMapIntensity.value=t.environmentIntensity),C&&(A.setValue(ye,"toneMappingExposure",y.toneMappingExposure),x.needsLights&&(k=N,(D=R).ambientLightColor.needsUpdate=k,D.lightProbe.needsUpdate=k,D.directionalLights.needsUpdate=k,D.directionalLightShadows.needsUpdate=k,D.pointLights.needsUpdate=k,D.pointLightShadows.needsUpdate=k,D.spotLights.needsUpdate=k,D.spotLightShadows.needsUpdate=k,D.rectAreaLights.needsUpdate=k,D.hemisphereLights.needsUpdate=k),a&&!0===i.fog&&oe.refreshFogUniforms(R,a),oe.refreshMaterialUniforms(R,i,I,P,g.state.transmissionRenderTarget[e.id]),Mf.upload(ye,Ue(x),R,ee)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Mf.upload(ye,Ue(x),R,ee),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&A.setValue(ye,"center",s.center),A.setValue(ye,"modelViewMatrix",s.modelViewMatrix),A.setValue(ye,"normalMatrix",s.normalMatrix),A.setValue(ye,"modelMatrix",s.matrixWorld),i.isShaderMaterial||i.isRawShaderMaterial){const e=i.uniformsGroups;for(let t=0,n=e.length;t<n;t++){const n=e[t];xe.update(n,w),xe.bind(n,w)}}return w}(e,t,n,i,s);Z.setMaterial(i,r);let l=n.index,c=1;if(!0===i.wireframe){if(l=se.getWireframeAttribute(n),void 0===l)return;c=2}const h=n.drawRange,u=n.attributes.position;let d=h.start*c,p=(h.start+h.count)*c;null!==a&&(d=Math.max(d,a.start*c),p=Math.min(p,(a.start+a.count)*c)),null!==l?(d=Math.max(d,0),p=Math.min(p,l.count)):null!=u&&(d=Math.max(d,0),p=Math.min(p,u.count));const m=p-d;if(m<0||m===1/0)return;let f;ve.setup(s,i,o,n,l);let v=me;if(null!==l&&(f=ie.get(l),v=fe,v.setIndex(f)),s.isMesh)!0===i.wireframe?(Z.setLineWidth(i.wireframeLinewidth*X()),v.setMode(ye.LINES)):v.setMode(ye.TRIANGLES);else if(s.isLine){let e=i.linewidth;void 0===e&&(e=1),Z.setLineWidth(e*X()),s.isLineSegments?v.setMode(ye.LINES):s.isLineLoop?v.setMode(ye.LINE_LOOP):v.setMode(ye.LINE_STRIP)}else s.isPoints?v.setMode(ye.POINTS):s.isSprite&&v.setMode(ye.TRIANGLES);if(s.isBatchedMesh)if(null!==s._multiDrawInstances)wh("THREE.WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),v.renderMultiDrawInstances(s._multiDrawStarts,s._multiDrawCounts,s._multiDrawCount,s._multiDrawInstances);else if(Y.get("WEBGL_multi_draw"))v.renderMultiDraw(s._multiDrawStarts,s._multiDrawCounts,s._multiDrawCount);else{const e=s._multiDrawStarts,t=s._multiDrawCounts,n=s._multiDrawCount,a=l?ie.get(l).bytesPerElement:1,r=Q.get(i).currentProgram.getUniforms();for(let i=0;i<n;i++)r.setValue(ye,"_gl_DrawID",i),v.render(e[i]/a,t[i])}else if(s.isInstancedMesh)v.renderInstances(d,m,s.count);else if(n.isInstancedBufferGeometry){const e=void 0!==n._maxInstanceCount?n._maxInstanceCount:1/0,t=Math.min(n.instanceCount,e);v.renderInstances(d,m,t)}else v.render(d,m)},this.compile=function(e,t,n=null){null===n&&(n=e),g=ce.get(n),g.init(t),x.push(g),n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))}),e!==n&&e.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))}),g.setupLights();const i=new Set;return e.traverse(function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let s=0;s<t.length;s++){const a=t[s];Ce(a,n,e),i.add(a)}else Ce(t,n,e),i.add(t)}),g=x.pop(),i},this.compileAsync=function(e,t,n=null){const i=this.compile(e,t,n);return new Promise(t=>{function n(){i.forEach(function(e){Q.get(e).currentProgram.isReady()&&i.delete(e)}),0!==i.size?setTimeout(n,10):t(e)}null!==Y.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)})};let Ne=null;function Ae(){je.stop()}function Re(){je.start()}const je=new Lp;function Pe(e,t,n,i){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)g.pushLight(e),e.castShadow&&g.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||F.intersectsSprite(e)){i&&G.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);const t=ae.update(e),s=e.material;s.visible&&f.push(e,t,s,n,G.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||F.intersectsObject(e))){const t=ae.update(e),s=e.material;if(i&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),G.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),G.copy(t.boundingSphere.center)),G.applyMatrix4(e.matrixWorld).applyMatrix4(H)),Array.isArray(s)){const i=t.groups;for(let a=0,r=i.length;a<r;a++){const r=i[a],o=s[r.materialIndex];o&&o.visible&&f.push(e,t,o,n,G.z,r)}}else s.visible&&f.push(e,t,s,n,G.z,null)}const s=e.children;for(let a=0,r=s.length;a<r;a++)Pe(s[a],t,n,i)}function Ie(e,t,n,i){const s=e.opaque,a=e.transmissive,r=e.transparent;g.setupLightsView(n),!0===z&&he.setGlobalState(y.clippingPlanes,n),i&&Z.viewport(E.copy(i)),s.length>0&&ke(s,t,n),a.length>0&&ke(a,t,n),r.length>0&&ke(r,t,n),Z.buffers.depth.setTest(!0),Z.buffers.depth.setMask(!0),Z.buffers.color.setMask(!0),Z.setPolygonOffset(!1)}function De(e,t,n,i){if(null!==(!0===n.isScene?n.overrideMaterial:null))return;void 0===g.state.transmissionRenderTarget[i.id]&&(g.state.transmissionRenderTarget[i.id]=new Fh(1,1,{generateMipmaps:!0,type:Y.has("EXT_color_buffer_half_float")||Y.has("EXT_color_buffer_float")?Zl:ql,minFilter:Gl,samples:4,stencilBuffer:s,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:Eh.workingColorSpace}));const a=g.state.transmissionRenderTarget[i.id],r=i.viewport||E;a.setSize(r.z*y.transmissionResolutionScale,r.w*y.transmissionResolutionScale);const o=y.getRenderTarget(),l=y.getActiveCubeFace(),c=y.getActiveMipmapLevel();y.setRenderTarget(a),y.getClearColor(A),R=y.getClearAlpha(),R<1&&y.setClearColor(16777215,.5),y.clear(),$&&de.render(n);const h=y.toneMapping;y.toneMapping=0;const u=i.viewport;if(void 0!==i.viewport&&(i.viewport=void 0),g.setupLightsView(i),!0===z&&he.setGlobalState(y.clippingPlanes,i),ke(e,n,i),ee.updateMultisampleRenderTarget(a),ee.updateRenderTargetMipmap(a),!1===Y.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let s=0,a=t.length;s<a;s++){const a=t[s],r=a.object,o=a.geometry,l=a.material,c=a.group;if(2===l.side&&r.layers.test(i.layers)){const t=l.side;l.side=1,l.needsUpdate=!0,Le(r,n,i,o,l,c),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(ee.updateMultisampleRenderTarget(a),ee.updateRenderTargetMipmap(a))}y.setRenderTarget(o,l,c),y.setClearColor(A,R),void 0!==u&&(i.viewport=u),y.toneMapping=h}function ke(e,t,n){const i=!0===t.isScene?t.overrideMaterial:null;for(let s=0,a=e.length;s<a;s++){const a=e[s],r=a.object,o=a.geometry,l=a.group;let c=a.material;!0===c.allowOverride&&null!==i&&(c=i),r.layers.test(n.layers)&&Le(r,t,n,o,c,l)}}function Le(e,t,n,i,s,a){e.onBeforeRender(y,t,n,i,s,a),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),s.onBeforeRender(y,t,n,i,e,a),!0===s.transparent&&2===s.side&&!1===s.forceSinglePass?(s.side=1,s.needsUpdate=!0,y.renderBufferDirect(n,t,i,s,e,a),s.side=0,s.needsUpdate=!0,y.renderBufferDirect(n,t,i,s,e,a),s.side=2):y.renderBufferDirect(n,t,i,s,e,a),e.onAfterRender(y,t,n,i,s,a)}function Oe(e,t,n){!0!==t.isScene&&(t=q);const i=Q.get(e),s=g.state.lights,a=g.state.shadowsArray,r=s.state.version,o=re.getParameters(e,s.state,a,t,n),l=re.getProgramCacheKey(o);let c=i.programs;i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.envMap=(e.isMeshStandardMaterial?ne:te).get(e.envMap||i.environment),i.envMapRotation=null!==i.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===c&&(e.addEventListener("dispose",Ee),c=new Map,i.programs=c);let h=c.get(l);if(void 0!==h){if(i.currentProgram===h&&i.lightsStateVersion===r)return Fe(e,o),h}else o.uniforms=re.getUniforms(e),e.onBeforeCompile(o,y),h=re.acquireProgram(o,l),c.set(l,h),i.uniforms=o.uniforms;const u=i.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(u.clippingPlanes=he.uniform),Fe(e,o),i.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),i.lightsStateVersion=r,i.needsLights&&(u.ambientLightColor.value=s.state.ambient,u.lightProbe.value=s.state.probe,u.directionalLights.value=s.state.directional,u.directionalLightShadows.value=s.state.directionalShadow,u.spotLights.value=s.state.spot,u.spotLightShadows.value=s.state.spotShadow,u.rectAreaLights.value=s.state.rectArea,u.ltc_1.value=s.state.rectAreaLTC1,u.ltc_2.value=s.state.rectAreaLTC2,u.pointLights.value=s.state.point,u.pointLightShadows.value=s.state.pointShadow,u.hemisphereLights.value=s.state.hemi,u.directionalShadowMap.value=s.state.directionalShadowMap,u.directionalShadowMatrix.value=s.state.directionalShadowMatrix,u.spotShadowMap.value=s.state.spotShadowMap,u.spotLightMatrix.value=s.state.spotLightMatrix,u.spotLightMap.value=s.state.spotLightMap,u.pointShadowMap.value=s.state.pointShadowMap,u.pointShadowMatrix.value=s.state.pointShadowMatrix),i.currentProgram=h,i.uniformsList=null,h}function Ue(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=Mf.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function Fe(e,t){const n=Q.get(e);n.outputColorSpace=t.outputColorSpace,n.batching=t.batching,n.batchingColor=t.batchingColor,n.instancing=t.instancing,n.instancingColor=t.instancingColor,n.instancingMorph=t.instancingMorph,n.skinning=t.skinning,n.morphTargets=t.morphTargets,n.morphNormals=t.morphNormals,n.morphColors=t.morphColors,n.morphTargetsCount=t.morphTargetsCount,n.numClippingPlanes=t.numClippingPlanes,n.numIntersection=t.numClipIntersection,n.vertexAlphas=t.vertexAlphas,n.vertexTangents=t.vertexTangents,n.toneMapping=t.toneMapping}je.setAnimationLoop(function(e){Ne&&Ne(e)}),"undefined"!=typeof self&&je.setContext(self),this.setAnimationLoop=function(e){Ne=e,we.setAnimationLoop(e),null===e?je.stop():je.start()},we.addEventListener("sessionstart",Ae),we.addEventListener("sessionend",Re),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return;if(!0===b)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===we.enabled&&!0===we.isPresenting&&(!0===we.cameraAutoUpdate&&we.updateCamera(t),t=we.getCamera()),!0===e.isScene&&e.onBeforeRender(y,e,t,S),g=ce.get(e,x.length),g.init(t),x.push(g),H.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),F.setFromProjectionMatrix(H),B=this.localClippingEnabled,z=he.init(this.clippingPlanes,B),f=le.get(e,v.length),f.init(),v.push(f),!0===we.enabled&&!0===we.isPresenting){const e=y.xr.getDepthSensingMesh();null!==e&&Pe(e,t,-1/0,y.sortObjects)}Pe(e,t,0,y.sortObjects),f.finish(),!0===y.sortObjects&&f.sort(D,k),$=!1===we.enabled||!1===we.isPresenting||!1===we.hasDepthSensing(),$&&de.addToRenderList(f,e),this.info.render.frame++,!0===z&&he.beginShadows();const n=g.state.shadowsArray;ue.render(n,e,t),!0===z&&he.endShadows(),!0===this.info.autoReset&&this.info.reset();const i=f.opaque,s=f.transmissive;if(g.setupLights(),t.isArrayCamera){const n=t.cameras;if(s.length>0)for(let t=0,a=n.length;t<a;t++)De(i,s,e,n[t]);$&&de.render(e);for(let t=0,i=n.length;t<i;t++){const i=n[t];Ie(f,e,i,i.viewport)}}else s.length>0&&De(i,s,e,t),$&&de.render(e),Ie(f,e,t);null!==S&&0===w&&(ee.updateMultisampleRenderTarget(S),ee.updateRenderTargetMipmap(S)),!0===e.isScene&&e.onAfterRender(y,e,t),ve.resetDefaultState(),M=-1,T=null,x.pop(),x.length>0?(g=x[x.length-1],!0===z&&he.setGlobalState(y.clippingPlanes,g.state.camera)):g=null,v.pop(),f=v.length>0?v[v.length-1]:null},this.getActiveCubeFace=function(){return _},this.getActiveMipmapLevel=function(){return w},this.getRenderTarget=function(){return S},this.setRenderTargetTextures=function(e,t,n){const i=Q.get(e);i.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===i.__autoAllocateDepthBuffer&&(i.__useRenderToTexture=!1),Q.get(e.texture).__webglTexture=t,Q.get(e.depthTexture).__webglTexture=i.__autoAllocateDepthBuffer?void 0:n,i.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,t){const n=Q.get(e);n.__webglFramebuffer=t,n.__useDefaultFramebuffer=void 0===t};const ze=ye.createFramebuffer();this.setRenderTarget=function(e,t=0,n=0){S=e,_=t,w=n;let i=!0,s=null,a=!1,r=!1;if(e){const o=Q.get(e);if(void 0!==o.__useDefaultFramebuffer)Z.bindFramebuffer(ye.FRAMEBUFFER,null),i=!1;else if(void 0===o.__webglFramebuffer)ee.setupRenderTarget(e);else if(o.__hasExternalTextures)ee.rebindTextures(e,Q.get(e.texture).__webglTexture,Q.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(o.__boundDepthTexture!==t){if(null!==t&&Q.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");ee.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(r=!0);const c=Q.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(s=Array.isArray(c[t])?c[t][n]:c[t],a=!0):s=e.samples>0&&!1===ee.useMultisampledRTT(e)?Q.get(e).__webglMultisampledFramebuffer:Array.isArray(c)?c[n]:c,E.copy(e.viewport),C.copy(e.scissor),N=e.scissorTest}else E.copy(L).multiplyScalar(I).floor(),C.copy(O).multiplyScalar(I).floor(),N=U;if(0!==n&&(s=ze),Z.bindFramebuffer(ye.FRAMEBUFFER,s)&&i&&Z.drawBuffers(e,s),Z.viewport(E),Z.scissor(C),Z.setScissorTest(N),a){const i=Q.get(e.texture);ye.framebufferTexture2D(ye.FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.__webglTexture,n)}else if(r){const i=Q.get(e.texture),s=t;ye.framebufferTextureLayer(ye.FRAMEBUFFER,ye.COLOR_ATTACHMENT0,i.__webglTexture,n,s)}else if(null!==e&&0!==n){const t=Q.get(e.texture);ye.framebufferTexture2D(ye.FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_2D,t.__webglTexture,n)}M=-1},this.readRenderTargetPixels=function(e,t,n,i,s,a,r,o=0){if(!e||!e.isWebGLRenderTarget)return;let l=Q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==r&&(l=l[r]),l){Z.bindFramebuffer(ye.FRAMEBUFFER,l);try{const r=e.textures[o],l=r.format,c=r.type;if(!K.textureFormatReadable(l))return;if(!K.textureTypeReadable(c))return;t>=0&&t<=e.width-i&&n>=0&&n<=e.height-s&&(e.textures.length>1&&ye.readBuffer(ye.COLOR_ATTACHMENT0+o),ye.readPixels(t,n,i,s,ge.convert(l),ge.convert(c),a))}finally{const e=null!==S?Q.get(S).__webglFramebuffer:null;Z.bindFramebuffer(ye.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,n,i,s,a,r,o=0){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=Q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==r&&(l=l[r]),l){if(t>=0&&t<=e.width-i&&n>=0&&n<=e.height-s){Z.bindFramebuffer(ye.FRAMEBUFFER,l);const r=e.textures[o],c=r.format,h=r.type;if(!K.textureFormatReadable(c))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!K.textureTypeReadable(h))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const u=ye.createBuffer();ye.bindBuffer(ye.PIXEL_PACK_BUFFER,u),ye.bufferData(ye.PIXEL_PACK_BUFFER,a.byteLength,ye.STREAM_READ),e.textures.length>1&&ye.readBuffer(ye.COLOR_ATTACHMENT0+o),ye.readPixels(t,n,i,s,ge.convert(c),ge.convert(h),0);const d=null!==S?Q.get(S).__webglFramebuffer:null;Z.bindFramebuffer(ye.FRAMEBUFFER,d);const p=ye.fenceSync(ye.SYNC_GPU_COMMANDS_COMPLETE,0);return ye.flush(),await function(e,t){return new Promise(function(n,i){setTimeout(function s(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:i();break;case e.TIMEOUT_EXPIRED:setTimeout(s,4);break;default:n()}},4)})}(ye,p),ye.bindBuffer(ye.PIXEL_PACK_BUFFER,u),ye.getBufferSubData(ye.PIXEL_PACK_BUFFER,0,a),ye.deleteBuffer(u),ye.deleteSync(p),a}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,n=0){const i=Math.pow(2,-n),s=Math.floor(e.image.width*i),a=Math.floor(e.image.height*i),r=null!==t?t.x:0,o=null!==t?t.y:0;ee.setTexture2D(e,0),ye.copyTexSubImage2D(ye.TEXTURE_2D,n,0,0,r,o,s,a),Z.unbindTexture()};const Be=ye.createFramebuffer(),Ve=ye.createFramebuffer();this.copyTextureToTexture=function(e,t,n=null,i=null,s=0,a=null){let r,o,l,c,h,u,d,p,m;null===a&&(0!==s?(wh("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),a=s,s=0):a=0);const f=e.isCompressedTexture?e.mipmaps[a]:e.image;if(null!==n)r=n.max.x-n.min.x,o=n.max.y-n.min.y,l=n.isBox3?n.max.z-n.min.z:1,c=n.min.x,h=n.min.y,u=n.isBox3?n.min.z:0;else{const t=Math.pow(2,-s);r=Math.floor(f.width*t),o=Math.floor(f.height*t),l=e.isDataArrayTexture?f.depth:e.isData3DTexture?Math.floor(f.depth*t):1,c=0,h=0,u=0}null!==i?(d=i.x,p=i.y,m=i.z):(d=0,p=0,m=0);const g=ge.convert(t.format),v=ge.convert(t.type);let x;t.isData3DTexture?(ee.setTexture3D(t,0),x=ye.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(ee.setTexture2DArray(t,0),x=ye.TEXTURE_2D_ARRAY):(ee.setTexture2D(t,0),x=ye.TEXTURE_2D),ye.pixelStorei(ye.UNPACK_FLIP_Y_WEBGL,t.flipY),ye.pixelStorei(ye.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),ye.pixelStorei(ye.UNPACK_ALIGNMENT,t.unpackAlignment);const y=ye.getParameter(ye.UNPACK_ROW_LENGTH),b=ye.getParameter(ye.UNPACK_IMAGE_HEIGHT),_=ye.getParameter(ye.UNPACK_SKIP_PIXELS),w=ye.getParameter(ye.UNPACK_SKIP_ROWS),S=ye.getParameter(ye.UNPACK_SKIP_IMAGES);ye.pixelStorei(ye.UNPACK_ROW_LENGTH,f.width),ye.pixelStorei(ye.UNPACK_IMAGE_HEIGHT,f.height),ye.pixelStorei(ye.UNPACK_SKIP_PIXELS,c),ye.pixelStorei(ye.UNPACK_SKIP_ROWS,h),ye.pixelStorei(ye.UNPACK_SKIP_IMAGES,u);const M=e.isDataArrayTexture||e.isData3DTexture,T=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const n=Q.get(e),i=Q.get(t),f=Q.get(n.__renderTarget),g=Q.get(i.__renderTarget);Z.bindFramebuffer(ye.READ_FRAMEBUFFER,f.__webglFramebuffer),Z.bindFramebuffer(ye.DRAW_FRAMEBUFFER,g.__webglFramebuffer);for(let v=0;v<l;v++)M&&(ye.framebufferTextureLayer(ye.READ_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,Q.get(e).__webglTexture,s,u+v),ye.framebufferTextureLayer(ye.DRAW_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,Q.get(t).__webglTexture,a,m+v)),ye.blitFramebuffer(c,h,r,o,d,p,r,o,ye.DEPTH_BUFFER_BIT,ye.NEAREST);Z.bindFramebuffer(ye.READ_FRAMEBUFFER,null),Z.bindFramebuffer(ye.DRAW_FRAMEBUFFER,null)}else if(0!==s||e.isRenderTargetTexture||Q.has(e)){const n=Q.get(e),i=Q.get(t);Z.bindFramebuffer(ye.READ_FRAMEBUFFER,Be),Z.bindFramebuffer(ye.DRAW_FRAMEBUFFER,Ve);for(let e=0;e<l;e++)M?ye.framebufferTextureLayer(ye.READ_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,n.__webglTexture,s,u+e):ye.framebufferTexture2D(ye.READ_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_2D,n.__webglTexture,s),T?ye.framebufferTextureLayer(ye.DRAW_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,i.__webglTexture,a,m+e):ye.framebufferTexture2D(ye.DRAW_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_2D,i.__webglTexture,a),0!==s?ye.blitFramebuffer(c,h,r,o,d,p,r,o,ye.COLOR_BUFFER_BIT,ye.NEAREST):T?ye.copyTexSubImage3D(x,a,d,p,m+e,c,h,r,o):ye.copyTexSubImage2D(x,a,d,p,c,h,r,o);Z.bindFramebuffer(ye.READ_FRAMEBUFFER,null),Z.bindFramebuffer(ye.DRAW_FRAMEBUFFER,null)}else T?e.isDataTexture||e.isData3DTexture?ye.texSubImage3D(x,a,d,p,m,r,o,l,g,v,f.data):t.isCompressedArrayTexture?ye.compressedTexSubImage3D(x,a,d,p,m,r,o,l,g,f.data):ye.texSubImage3D(x,a,d,p,m,r,o,l,g,v,f):e.isDataTexture?ye.texSubImage2D(ye.TEXTURE_2D,a,d,p,r,o,g,v,f.data):e.isCompressedTexture?ye.compressedTexSubImage2D(ye.TEXTURE_2D,a,d,p,f.width,f.height,g,f.data):ye.texSubImage2D(ye.TEXTURE_2D,a,d,p,r,o,g,v,f);ye.pixelStorei(ye.UNPACK_ROW_LENGTH,y),ye.pixelStorei(ye.UNPACK_IMAGE_HEIGHT,b),ye.pixelStorei(ye.UNPACK_SKIP_PIXELS,_),ye.pixelStorei(ye.UNPACK_SKIP_ROWS,w),ye.pixelStorei(ye.UNPACK_SKIP_IMAGES,S),0===a&&t.generateMipmaps&&ye.generateMipmap(x),Z.unbindTexture()},this.copyTextureToTexture3D=function(e,t,n=null,i=null,s=0){return wh('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,n,i,s)},this.initRenderTarget=function(e){void 0===Q.get(e).__webglFramebuffer&&ee.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?ee.setTextureCube(e,0):e.isData3DTexture?ee.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?ee.setTexture2DArray(e,0):ee.setTexture2D(e,0),Z.unbindTexture()},this.resetState=function(){_=0,w=0,S=null,Z.reset(),ve.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Qc}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=Eh._getDrawingBufferColorSpace(e),t.unpackColorSpace=Eh._getUnpackColorSpace()}}function vg(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xg={exports:{}}.exports=function e(t,n,i){function s(r,o){if(!n[r]){if(!t[r]){if(!o&&vg)return vg(r);if(a)return a(r,!0);throw new Error("Cannot find module '"+r+"'")}var l=n[r]={exports:{}};t[r][0].call(l.exports,function(e){return s(t[r][1][e]||e)},l,l.exports,e,t,n,i)}return n[r].exports}for(var a=vg,r=0;r<i.length;r++)s(i[r]);return s}({1:[function(e,t,n){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,n){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t,n){var i=e("../math/Vec3");function s(e){e=e||{},this.lowerBound=new i,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new i,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=s;var a=new i;s.prototype.setFromPoints=function(e,t,n,i){var s=this.lowerBound,r=this.upperBound,o=n;s.copy(e[0]),o&&o.vmult(s,s),r.copy(s);for(var l=1;l<e.length;l++){var c=e[l];o&&(o.vmult(c,a),c=a),c.x>r.x&&(r.x=c.x),c.x<s.x&&(s.x=c.x),c.y>r.y&&(r.y=c.y),c.y<s.y&&(s.y=c.y),c.z>r.z&&(r.z=c.z),c.z<s.z&&(s.z=c.z)}return t&&(t.vadd(s,s),t.vadd(r,r)),i&&(s.x-=i,s.y-=i,s.z-=i,r.x+=i,r.y+=i,r.z+=i),this},s.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},s.prototype.clone=function(){return(new s).copy(this)},s.prototype.extend=function(e){var t=e.lowerBound.x;this.lowerBound.x>t&&(this.lowerBound.x=t);var n=e.upperBound.x;this.upperBound.x<n&&(this.upperBound.x=n),t=e.lowerBound.y,this.lowerBound.y>t&&(this.lowerBound.y=t),n=e.upperBound.y,this.upperBound.y<n&&(this.upperBound.y=n),t=e.lowerBound.z,this.lowerBound.z>t&&(this.lowerBound.z=t),n=e.upperBound.z,this.upperBound.z<n&&(this.upperBound.z=n)},s.prototype.overlaps=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,s=e.upperBound;return(i.x<=n.x&&n.x<=s.x||t.x<=s.x&&s.x<=n.x)&&(i.y<=n.y&&n.y<=s.y||t.y<=s.y&&s.y<=n.y)&&(i.z<=n.z&&n.z<=s.z||t.z<=s.z&&s.z<=n.z)},s.prototype.contains=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,s=e.upperBound;return t.x<=i.x&&n.x>=s.x&&t.y<=i.y&&n.y>=s.y&&t.z<=i.z&&n.z>=s.z},s.prototype.getCorners=function(e,t,n,i,s,a,r,o){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),n.set(c.x,c.y,l.z),i.set(l.x,c.y,c.z),s.set(c.x,l.y,l.z),a.set(l.x,c.y,l.z),r.set(l.x,l.y,c.z),o.copy(c)};var r=[new i,new i,new i,new i,new i,new i,new i,new i];s.prototype.toLocalFrame=function(e,t){var n=r,i=n[0],s=n[1],a=n[2],o=n[3],l=n[4],c=n[5],h=n[6],u=n[7];this.getCorners(i,s,a,o,l,c,h,u);for(var d=0;8!==d;d++){var p=n[d];e.pointToLocal(p,p)}return t.setFromPoints(n)},s.prototype.toWorldFrame=function(e,t){var n=r,i=n[0],s=n[1],a=n[2],o=n[3],l=n[4],c=n[5],h=n[6],u=n[7];this.getCorners(i,s,a,o,l,c,h,u);for(var d=0;8!==d;d++){var p=n[d];e.pointToWorld(p,p)}return t.setFromPoints(n)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t,n){function i(){this.matrix=[]}t.exports=i,i.prototype.get=function(e,t){if(e=e.index,(t=t.index)>e){var n=t;t=e,e=n}return this.matrix[(e*(e+1)>>1)+t-1]},i.prototype.set=function(e,t,n){if(e=e.index,(t=t.index)>e){var i=t;t=e,e=i}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0},i.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},i.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,n){var i=e("../objects/Body"),s=e("../math/Vec3"),a=e("../math/Quaternion");function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),t.exports=r,r.prototype.collisionPairs=function(e,t,n){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var o=i.STATIC|i.KINEMATIC;r.prototype.needBroadphaseCollision=function(e,t){return 0!==(e.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&e.collisionFilterMask)&&(0===(e.type&o)&&e.sleepState!==i.SLEEPING||0===(t.type&o)&&t.sleepState!==i.SLEEPING)},r.prototype.intersectionTest=function(e,t,n,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,n,i):this.doBoundingSphereBroadphase(e,t,n,i)};var l=new s;new s,new a,new s,r.prototype.doBoundingSphereBroadphase=function(e,t,n,i){var s=l;t.position.vsub(e.position,s);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);s.norm2()<a&&(n.push(e),i.push(t))},r.prototype.doBoundingBoxBroadphase=function(e,t,n,i){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(n.push(e),i.push(t))};var c={keys:[]},h=[],u=[];r.prototype.makePairsUnique=function(e,t){for(var n=c,i=h,s=u,a=e.length,r=0;r!==a;r++)i[r]=e[r],s[r]=t[r];for(e.length=0,t.length=0,r=0;r!==a;r++){var o=i[r].id,l=s[r].id;n[d=o<l?o+","+l:l+","+o]=r,n.keys.push(d)}for(r=0;r!==n.keys.length;r++){var d=n.keys.pop(),p=n[d];e.push(i[p]),t.push(s[p]),delete n[d]}},r.prototype.setWorld=function(e){};var d=new s;r.boundingSphereCheck=function(e,t){var n=d;return e.position.vsub(t.position,n),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>n.norm2()},r.prototype.aabbQuery=function(e,t,n){return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t,n){t.exports=r;var i=e("./Broadphase"),s=e("../math/Vec3"),a=e("../shapes/Shape");function r(e,t,n,a,r){i.apply(this),this.nx=n||10,this.ny=a||10,this.nz=r||10,this.aabbMin=e||new s(100,100,100),this.aabbMax=t||new s(-100,-100,-100);var o=this.nx*this.ny*this.nz;if(o<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=o,this.binLengths.length=o;for(var l=0;l<o;l++)this.bins[l]=[],this.binLengths[l]=0}r.prototype=new i,r.prototype.constructor=r;var o=new s;new s,r.prototype.collisionPairs=function(e,t,n){var i=e.numObjects(),s=e.bodies,r=this.aabbMax,l=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,d=h*u,p=u,m=r.x,f=r.y,g=r.z,v=l.x,x=l.y,y=l.z,b=c/(m-v),_=h/(f-x),w=u/(g-y),S=(m-v)/c,M=(f-x)/h,T=(g-y)/u,E=.5*Math.sqrt(S*S+M*M+T*T),C=a.types,N=C.SPHERE,A=C.PLANE;C.BOX,C.COMPOUND,C.CONVEXPOLYHEDRON;for(var R=this.bins,j=this.binLengths,P=this.bins.length,I=0;I!==P;I++)j[I]=0;var D=Math.ceil;function k(e,t,n,i,s,a,r){var o=(e-v)*b|0,l=(t-x)*_|0,m=(n-y)*w|0,f=D((i-v)*b),g=D((s-x)*_),S=D((a-y)*w);o<0?o=0:o>=c&&(o=c-1),l<0?l=0:l>=h&&(l=h-1),m<0?m=0:m>=u&&(m=u-1),f<0?f=0:f>=c&&(f=c-1),g<0?g=0:g>=h&&(g=h-1),S<0?S=0:S>=u&&(S=u-1),l*=p,m*=1,f*=d,g*=p,S*=1;for(var M=o*=d;M<=f;M+=d)for(var T=l;T<=g;T+=p)for(var E=m;E<=S;E+=1){var C=M+T+E;R[C][j[C]++]=r}}for(l=Math.min,r=Math.max,I=0;I!==i;I++){var L=(te=s[I]).shape;switch(L.type){case N:var O=te.position.x,U=te.position.y,F=te.position.z,z=L.radius;k(O-z,U-z,F-z,O+z,U+z,F+z,te);break;case A:L.worldNormalNeedsUpdate&&L.computeWorldNormal(te.quaternion);var B=L.worldNormal,V=v+.5*S-te.position.x,H=x+.5*M-te.position.y,W=y+.5*T-te.position.z,G=o;G.set(V,H,W);for(var q=0,$=0;q!==c;q++,$+=d,G.y=H,G.x+=S)for(var X=0,Y=0;X!==h;X++,Y+=p,G.z=W,G.y+=M)for(var K=0,Z=0;K!==u;K++,Z+=1,G.z+=T)if(G.dot(B)<E){var J=$+Y+Z;R[J][j[J]++]=te}break;default:te.aabbNeedsUpdate&&te.computeAABB(),k(te.aabb.lowerBound.x,te.aabb.lowerBound.y,te.aabb.lowerBound.z,te.aabb.upperBound.x,te.aabb.upperBound.y,te.aabb.upperBound.z,te)}}for(I=0;I!==P;I++){var Q=j[I];if(Q>1){var ee=R[I];for(q=0;q!==Q;q++){var te=ee[q];for(X=0;X!==q;X++){var ne=ee[X];this.needBroadphaseCollision(te,ne)&&this.intersectionTest(te,ne,t,n)}}}}this.makePairsUnique(t,n)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t,n){t.exports=a;var i=e("./Broadphase"),s=e("./AABB");function a(){i.apply(this)}a.prototype=new i,a.prototype.constructor=a,a.prototype.collisionPairs=function(e,t,n){var i,s,a,r,o=e.bodies,l=o.length;for(i=0;i!==l;i++)for(s=0;s!==i;s++)a=o[i],r=o[s],this.needBroadphaseCollision(a,r)&&this.intersectionTest(a,r,t,n)},new s,a.prototype.aabbQuery=function(e,t,n){n=n||[];for(var i=0;i<e.bodies.length;i++){var s=e.bodies[i];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&n.push(s)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,n){function i(){this.matrix={}}t.exports=i,i.prototype.get=function(e,t){if(e=e.id,(t=t.id)>e){var n=t;t=e,e=n}return e+"-"+t in this.matrix},i.prototype.set=function(e,t,n){if(e=e.id,(t=t.id)>e){var i=t;t=e,e=i}n?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,n){t.exports=c;var i=e("../math/Vec3"),s=e("../math/Quaternion"),a=e("../math/Transform");e("../shapes/ConvexPolyhedron"),e("../shapes/Box");var r=e("../collision/RaycastResult"),o=e("../shapes/Shape"),l=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new i,this.to=t?t.clone():new i,this._direction=new i,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new r,this.hasHit=!1,this.callback=function(e){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var h=new l,u=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new r,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(h),u.length=0,e.broadphase.aabbQuery(e,h,u),this.intersectBodies(u),this.hasHit};var d=new i,p=new i;function m(e,t,n,i){i.vsub(t,D),n.vsub(t,d),e.vsub(t,p);var s,a,r=D.dot(D),o=D.dot(d),l=D.dot(p),c=d.dot(d),h=d.dot(p);return(s=c*l-o*h)>=0&&(a=r*h-o*l)>=0&&s+a<r*c-o*o}c.pointInTriangle=m;var f=new i,g=new s;c.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var n=this.checkCollisionResponse;if((!n||e.collisionResponse)&&0!==(this.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&this.collisionFilterMask))for(var i=f,s=g,a=0,r=e.shapes.length;a<r;a++){var o=e.shapes[a];if((!n||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[a],s),e.quaternion.vmult(e.shapeOffsets[a],i),i.vadd(e.position,i),this.intersectShape(o,s,i,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var n=0,i=e.length;!this.result._shouldStop&&n<i;n++)this.intersectBody(e[n])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,n,i){if(!(function(e,t,n){n.vsub(e,D);var i=D.dot(t);return t.mult(i,k),k.vadd(e,k),n.distanceTo(k)}(this.from,this._direction,n)>e.boundingSphereRadius)){var s=this[e.type];s&&s.call(this,e,t,n,i)}},new i,new i;var v=new i,x=new i,y=new i,b=new i;new i,new r,c.prototype.intersectBox=function(e,t,n,i){return this.intersectConvex(e.convexPolyhedronRepresentation,t,n,i)},c.prototype[o.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,n,s){var a=this.from,r=this.to,o=this._direction,l=new i(0,0,1);t.vmult(l,l);var c=new i;a.vsub(n,c);var h=c.dot(l);if(r.vsub(n,c),!(h*c.dot(l)>0||a.distanceTo(r)<h)){var u=l.dot(o);if(!(Math.abs(u)<this.precision)){var d=new i,p=new i,m=new i;a.vsub(n,d);var f=-l.dot(d)/u;o.scale(f,p),a.vadd(p,m),this.reportIntersection(l,m,e,s,-1)}}},c.prototype[o.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,n=this.from;e.lowerBound.x=Math.min(t.x,n.x),e.lowerBound.y=Math.min(t.y,n.y),e.lowerBound.z=Math.min(t.z,n.z),e.upperBound.x=Math.max(t.x,n.x),e.upperBound.y=Math.max(t.y,n.y),e.upperBound.z=Math.max(t.z,n.z)};var _={faceList:[0]};c.prototype.intersectHeightfield=function(e,t,n,s){e.data,e.elementSize;var r=new i,o=new c(this.from,this.to);a.pointToLocalFrame(n,t,o.from,o.from),a.pointToLocalFrame(n,t,o.to,o.to);var l=[],h=null,u=null,d=null,p=null,m=e.getIndexOfPosition(o.from.x,o.from.y,l,!1);if(m&&(h=l[0],u=l[1],d=l[0],p=l[1]),(m=e.getIndexOfPosition(o.to.x,o.to.y,l,!1))&&((null===h||l[0]<h)&&(h=l[0]),(null===d||l[0]>d)&&(d=l[0]),(null===u||l[1]<u)&&(u=l[1]),(null===p||l[1]>p)&&(p=l[1])),null!==h){var f=[];e.getRectMinMax(h,u,d,p,f);for(var g=h;g<=d;g++)for(var v=u;v<=p;v++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(g,v,!1),a.pointToWorldFrame(n,t,e.pillarOffset,r),this.intersectConvex(e.pillarConvex,t,r,s,_),this.result._shouldStop)return;e.getConvexTrianglePillar(g,v,!0),a.pointToWorldFrame(n,t,e.pillarOffset,r),this.intersectConvex(e.pillarConvex,t,r,s,_)}}},c.prototype[o.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var w=new i,S=new i;c.prototype.intersectSphere=function(e,t,n,i){var s=this.from,a=this.to,r=e.radius,o=Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2)+Math.pow(a.z-s.z,2),l=2*((a.x-s.x)*(s.x-n.x)+(a.y-s.y)*(s.y-n.y)+(a.z-s.z)*(s.z-n.z)),c=Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2)+Math.pow(s.z-n.z,2)-Math.pow(r,2),h=Math.pow(l,2)-4*o*c,u=w,d=S;if(!(h<0))if(0===h)s.lerp(a,h,u),u.vsub(n,d),d.normalize(),this.reportIntersection(d,u,e,i,-1);else{var p=(-l-Math.sqrt(h))/(2*o),m=(-l+Math.sqrt(h))/(2*o);if(p>=0&&p<=1&&(s.lerp(a,p,u),u.vsub(n,d),d.normalize(),this.reportIntersection(d,u,e,i,-1)),this.result._shouldStop)return;m>=0&&m<=1&&(s.lerp(a,m,u),u.vsub(n,d),d.normalize(),this.reportIntersection(d,u,e,i,-1))}},c.prototype[o.types.SPHERE]=c.prototype.intersectSphere;var M=new i;new i,new i;var T=new i;c.prototype.intersectConvex=function(e,t,n,i,s){for(var a=M,r=T,o=s&&s.faceList||null,l=e.faces,c=e.vertices,h=e.faceNormals,u=this._direction,d=this.from,p=this.to,f=d.distanceTo(p),g=o?o.length:l.length,_=this.result,w=0;!_._shouldStop&&w<g;w++){var S=o?o[w]:w,E=l[S],C=h[S],N=t,A=n;r.copy(c[E[0]]),N.vmult(r,r),r.vadd(A,r),r.vsub(d,r),N.vmult(C,a);var R=u.dot(a);if(!(Math.abs(R)<this.precision)){var j=a.dot(r)/R;if(!(j<0)){u.mult(j,v),v.vadd(d,v),x.copy(c[E[0]]),N.vmult(x,x),A.vadd(x,x);for(var P=1;!_._shouldStop&&P<E.length-1;P++){y.copy(c[E[P]]),b.copy(c[E[P+1]]),N.vmult(y,y),N.vmult(b,b),A.vadd(y,y),A.vadd(b,b);var I=v.distanceTo(d);!m(v,x,y,b)&&!m(v,y,x,b)||I>f||this.reportIntersection(a,v,e,i,S)}}}}},c.prototype[o.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var E=new i,C=new i,N=new i,A=new i,R=new i,j=new i;new l;var P=[],I=new a;c.prototype.intersectTrimesh=function(e,t,n,i,s){var r=E,o=P,l=I,c=T,h=C,u=N,d=A,p=j,f=R;s&&s.faceList;var g=e.indices;e.vertices,e.faceNormals;var _=this.from,w=this.to,S=this._direction;l.position.copy(n),l.quaternion.copy(t),a.vectorToLocalFrame(n,t,S,h),a.pointToLocalFrame(n,t,_,u),a.pointToLocalFrame(n,t,w,d);var M=u.distanceSquared(d);e.tree.rayQuery(this,l,o);for(var D=0,k=o.length;!this.result._shouldStop&&D!==k;D++){var L=o[D];e.getNormal(L,r),e.getVertex(g[3*L],x),x.vsub(u,c);var O=h.dot(r),U=r.dot(c)/O;if(!(U<0)){h.scale(U,v),v.vadd(u,v),e.getVertex(g[3*L+1],y),e.getVertex(g[3*L+2],b);var F=v.distanceSquared(u);!m(v,y,x,b)&&!m(v,x,y,b)||F>M||(a.vectorToWorldFrame(t,r,f),a.pointToWorldFrame(n,t,v,p),this.reportIntersection(f,p,e,i,L))}}o.length=0},c.prototype[o.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,n,i,s){var a=this.from,r=this.to,o=a.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==s?s:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(a,r,e,t,n,i,o),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(o<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(a,r,e,t,n,i,o));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(a,r,e,t,n,i,o),l._shouldStop=!0}};var D=new i,k=new i},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t,n){var i=e("../math/Vec3");function s(){this.rayFromWorld=new i,this.rayToWorld=new i,this.hitNormalWorld=new i,this.hitPointWorld=new i,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}t.exports=s,s.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},s.prototype.abort=function(){this._shouldStop=!0},s.prototype.set=function(e,t,n,i,s,a,r){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(i),this.shape=s,this.body=a,this.distance=r}},{"../math/Vec3":30}],11:[function(e,t,n){e("../shapes/Shape");var i=e("../collision/Broadphase");function s(e){i.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var n=t.indexOf(e.body);-1!==n&&t.splice(n,1)},e&&this.setWorld(e)}t.exports=s,s.prototype=new i,s.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},s.insertionSortX=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.x<=i.aabb.lowerBound.x);s--)e[s+1]=e[s];e[s+1]=i}return e},s.insertionSortY=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.y<=i.aabb.lowerBound.y);s--)e[s+1]=e[s];e[s+1]=i}return e},s.insertionSortZ=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.z<=i.aabb.lowerBound.z);s--)e[s+1]=e[s];e[s+1]=i}return e},s.prototype.collisionPairs=function(e,t,n){var i,a,r=this.axisList,o=r.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),i=0;i!==o;i++){var c=r[i];for(a=i+1;a<o;a++){var h=r[a];if(this.needBroadphaseCollision(c,h)){if(!s.checkBounds(c,h,l))break;this.intersectionTest(c,h,t,n)}}}},s.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,i=0;i!==n;i++){var a=e[i];a.aabbNeedsUpdate&&a.computeAABB()}0===t?s.insertionSortX(e):1===t?s.insertionSortY(e):2===t&&s.insertionSortZ(e)},s.checkBounds=function(e,t,n){var i,s;0===n?(i=e.position.x,s=t.position.x):1===n?(i=e.position.y,s=t.position.y):2===n&&(i=e.position.z,s=t.position.z);var a=e.boundingRadius;return s-t.boundingRadius<i+a},s.prototype.autoDetectAxis=function(){for(var e=0,t=0,n=0,i=0,s=0,a=0,r=this.axisList,o=r.length,l=1/o,c=0;c!==o;c++){var h=r[c],u=h.position.x;e+=u,t+=u*u;var d=h.position.y;n+=d,i+=d*d;var p=h.position.z;s+=p,a+=p*p}var m=t-e*e*l,f=i-n*n*l,g=a-s*s*l;this.axisIndex=m>f?m>g?0:2:f>g?1:2},s.prototype.aabbQuery=function(e,t,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,s="x";1===i&&(s="y"),2===i&&(s="z");var a=this.axisList;t.lowerBound[s],t.upperBound[s];for(var r=0;r<a.length;r++){var o=a[r];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&n.push(o)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t,n){t.exports=o,e("./Constraint");var i=e("./PointToPointConstraint"),s=e("../equations/ConeEquation"),a=e("../equations/RotationalEquation");e("../equations/ContactEquation");var r=e("../math/Vec3");function o(e,t,n){var o=void 0!==(n=n||{}).maxForce?n.maxForce:1e6,l=n.pivotA?n.pivotA.clone():new r,c=n.pivotB?n.pivotB.clone():new r;this.axisA=n.axisA?n.axisA.clone():new r,this.axisB=n.axisB?n.axisB.clone():new r,i.call(this,e,l,t,c,o),this.collideConnected=!!n.collideConnected,this.angle=void 0!==n.angle?n.angle:0;var h=this.coneEquation=new s(e,t,n),u=this.twistEquation=new a(e,t,n);this.twistAngle=void 0!==n.twistAngle?n.twistAngle:0,h.maxForce=0,h.minForce=-o,u.maxForce=0,u.minForce=-o,this.equations.push(h,u)}o.prototype=new i,o.constructor=o,new r,new r,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.coneEquation,s=this.twistEquation;i.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,n.axisA),t.vectorToWorldFrame(this.axisB,n.axisB),this.axisA.tangents(s.axisA,s.axisA),e.vectorToWorldFrame(s.axisA,s.axisA),this.axisB.tangents(s.axisB,s.axisB),t.vectorToWorldFrame(s.axisB,s.axisB),n.angle=this.angle,s.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t,n){t.exports=s;var i=e("../utils/Utils");function s(e,t,n){n=i.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=s.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}s.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},s.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},s.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},s.idCounter=0},{"../utils/Utils":53}],14:[function(e,t,n){t.exports=a;var i=e("./Constraint"),s=e("../equations/ContactEquation");function a(e,t,n,a){i.call(this,e,t),void 0===n&&(n=e.position.distanceTo(t.position)),void 0===a&&(a=1e6),this.distance=n;var r=this.distanceEquation=new s(e,t);this.equations.push(r),r.minForce=-a,r.maxForce=a}a.prototype=new i,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.distanceEquation,i=.5*this.distance,s=n.ni;t.position.vsub(e.position,s),s.normalize(),s.mult(i,n.ri),s.mult(-i,n.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t,n){t.exports=o,e("./Constraint");var i=e("./PointToPointConstraint"),s=e("../equations/RotationalEquation"),a=e("../equations/RotationalMotorEquation");e("../equations/ContactEquation");var r=e("../math/Vec3");function o(e,t,n){var o=void 0!==(n=n||{}).maxForce?n.maxForce:1e6,l=n.pivotA?n.pivotA.clone():new r,c=n.pivotB?n.pivotB.clone():new r;i.call(this,e,l,t,c,o),(this.axisA=n.axisA?n.axisA.clone():new r(1,0,0)).normalize(),(this.axisB=n.axisB?n.axisB.clone():new r(1,0,0)).normalize();var h=this.rotationalEquation1=new s(e,t,n),u=this.rotationalEquation2=new s(e,t,n),d=this.motorEquation=new a(e,t,o);d.enabled=!1,this.equations.push(h,u,d)}o.prototype=new i,o.constructor=o,o.prototype.enableMotor=function(){this.motorEquation.enabled=!0},o.prototype.disableMotor=function(){this.motorEquation.enabled=!1},o.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},o.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var l=new r,c=new r;o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.motorEquation,s=this.rotationalEquation1,a=this.rotationalEquation2,r=l,o=c,h=this.axisA,u=this.axisB;i.prototype.update.call(this),e.quaternion.vmult(h,r),t.quaternion.vmult(u,o),r.tangents(s.axisA,a.axisA),s.axisB.copy(o),a.axisB.copy(o),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,n.axisA),t.quaternion.vmult(this.axisB,n.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t,n){t.exports=r,e("./Constraint");var i=e("./PointToPointConstraint"),s=e("../equations/RotationalEquation");e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation");var a=e("../math/Vec3");function r(e,t,n){var r=void 0!==(n=n||{}).maxForce?n.maxForce:1e6,o=new a,l=new a,c=new a;e.position.vadd(t.position,c),c.scale(.5,c),t.pointToLocalFrame(c,l),e.pointToLocalFrame(c,o),i.call(this,e,o,t,l,r);var h=this.rotationalEquation1=new s(e,t,n),u=this.rotationalEquation2=new s(e,t,n),d=this.rotationalEquation3=new s(e,t,n);this.equations.push(h,u,d)}r.prototype=new i,r.constructor=r,new a,new a,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB;this.motorEquation;var n=this.rotationalEquation1,s=this.rotationalEquation2,r=this.rotationalEquation3;i.prototype.update.call(this),e.vectorToWorldFrame(a.UNIT_X,n.axisA),t.vectorToWorldFrame(a.UNIT_Y,n.axisB),e.vectorToWorldFrame(a.UNIT_Y,s.axisA),t.vectorToWorldFrame(a.UNIT_Z,s.axisB),e.vectorToWorldFrame(a.UNIT_Z,r.axisA),t.vectorToWorldFrame(a.UNIT_X,r.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t,n){t.exports=r;var i=e("./Constraint"),s=e("../equations/ContactEquation"),a=e("../math/Vec3");function r(e,t,n,r,o){i.call(this,e,n),o=void 0!==o?o:1e6,this.pivotA=t?t.clone():new a,this.pivotB=r?r.clone():new a;var l=this.equationX=new s(e,n),c=this.equationY=new s(e,n),h=this.equationZ=new s(e,n);this.equations.push(l,c,h),l.minForce=c.minForce=h.minForce=-o,l.maxForce=c.maxForce=h.maxForce=o,l.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}r.prototype=new i,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.equationX,i=this.equationY,s=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri),t.quaternion.vmult(this.pivotB,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),s.ri.copy(n.ri),s.rj.copy(n.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t,n){t.exports=a;var i=e("../math/Vec3");e("../math/Mat3");var s=e("./Equation");function a(e,t,n){var a=void 0!==(n=n||{}).maxForce?n.maxForce:1e6;s.call(this,e,t,-a,a),this.axisA=n.axisA?n.axisA.clone():new i(1,0,0),this.axisB=n.axisB?n.axisB.clone():new i(0,1,0),this.angle=void 0!==n.angle?n.angle:0}a.prototype=new s,a.prototype.constructor=a;var r=new i,o=new i;a.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,s=this.axisB,a=r,l=o,c=this.jacobianElementA,h=this.jacobianElementB;return i.cross(s,a),s.cross(i,l),c.rotational.copy(l),h.rotational.copy(a),-(Math.cos(this.angle)-i.dot(s))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t,n){t.exports=a;var i=e("./Equation"),s=e("../math/Vec3");function a(e,t,n){n=void 0!==n?n:1e6,i.call(this,e,t,0,n),this.restitution=0,this.ri=new s,this.rj=new s,this.ni=new s}e("../math/Mat3"),a.prototype=new i,a.prototype.constructor=a;var r=new s,o=new s,l=new s;a.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.bi,s=this.bj,a=this.ri,c=this.rj,h=r,u=o,d=i.velocity,p=i.angularVelocity;i.force,i.torque;var m=s.velocity,f=s.angularVelocity;s.force,s.torque;var g=l,v=this.jacobianElementA,x=this.jacobianElementB,y=this.ni;a.cross(y,h),c.cross(y,u),y.negate(v.spatial),h.negate(v.rotational),x.spatial.copy(y),x.rotational.copy(u),g.copy(s.position),g.vadd(c,g),g.vsub(i.position,g),g.vsub(a,g);var b=y.dot(g),_=this.restitution+1;return-b*t-(_*m.dot(y)-_*d.dot(y)+f.dot(u)-p.dot(h))*n-e*this.computeGiMf()};var c=new s,h=new s,u=new s,d=new s,p=new s;a.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=h,n=u,i=d,s=p;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(i,t),e.vsub(t,s),this.ni.dot(s)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t,n){t.exports=a;var i=e("../math/JacobianElement"),s=e("../math/Vec3");function a(e,t,n,s){this.id=a.id++,this.minForce=void 0===n?-1e6:n,this.maxForce=void 0===s?1e6:s,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new i,this.jacobianElementB=new i,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}a.prototype.constructor=a,a.id=0,a.prototype.setSpookParams=function(e,t,n){var i=t,s=e,a=n;this.a=4/(a*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(a*a*s*(1+4*i))},a.prototype.computeB=function(e,t,n){var i=this.computeGW();return-this.computeGq()*e-i*t-this.computeGiMf()*n},a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.position,a=i.position;return e.spatial.dot(s)+t.spatial.dot(a)};var r=new s;a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.velocity,a=i.velocity,o=n.angularVelocity||r,l=i.angularVelocity||r;return e.multiplyVectors(s,o)+t.multiplyVectors(a,l)},a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.vlambda,a=i.vlambda,o=n.wlambda||r,l=i.wlambda||r;return e.multiplyVectors(s,o)+t.multiplyVectors(a,l)};var o=new s,l=new s,c=new s,h=new s;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.force,a=n.torque,r=i.force,u=i.torque,d=n.invMassSolve,p=i.invMassSolve;return n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(a,c):c.set(0,0,0),i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(u,h):h.set(0,0,0),s.mult(d,o),r.mult(p,l),e.multiplyVectors(o,c)+t.multiplyVectors(l,h)};var u=new s;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.invMassSolve,a=i.invMassSolve,r=n.invInertiaWorldSolve,o=i.invInertiaWorldSolve,l=s+a;return r&&(r.vmult(e.rotational,u),l+=u.dot(e.rotational)),o&&(o.vmult(t.rotational,u),l+=u.dot(t.rotational)),l};var d=new s;new s,new s,new s,new s,new s,a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,n=this.jacobianElementB,i=this.bi,s=this.bj,a=d;t.spatial.mult(i.invMassSolve*e,a),i.vlambda.vadd(a,i.vlambda),n.spatial.mult(s.invMassSolve*e,a),s.vlambda.vadd(a,s.vlambda),i.invInertiaWorldSolve&&(i.invInertiaWorldSolve.vmult(t.rotational,a),a.mult(e,a),i.wlambda.vadd(a,i.wlambda)),s.invInertiaWorldSolve&&(s.invInertiaWorldSolve.vmult(n.rotational,a),a.mult(e,a),s.wlambda.vadd(a,s.wlambda))},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t,n){t.exports=a;var i=e("./Equation"),s=e("../math/Vec3");function a(e,t,n){i.call(this,e,t,-n,n),this.ri=new s,this.rj=new s,this.t=new s}e("../math/Mat3"),a.prototype=new i,a.prototype.constructor=a;var r=new s,o=new s;a.prototype.computeB=function(e){this.a;var t=this.b;this.bi,this.bj;var n=this.ri,i=this.rj,s=r,a=o,l=this.t;n.cross(l,s),i.cross(l,a);var c=this.jacobianElementA,h=this.jacobianElementB;return l.negate(c.spatial),s.negate(c.rotational),h.spatial.copy(l),h.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t,n){t.exports=a;var i=e("../math/Vec3");e("../math/Mat3");var s=e("./Equation");function a(e,t,n){var a=void 0!==(n=n||{}).maxForce?n.maxForce:1e6;s.call(this,e,t,-a,a),this.axisA=n.axisA?n.axisA.clone():new i(1,0,0),this.axisB=n.axisB?n.axisB.clone():new i(0,1,0),this.maxAngle=Math.PI/2}a.prototype=new s,a.prototype.constructor=a;var r=new i,o=new i;a.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,s=this.axisB,a=r,l=o,c=this.jacobianElementA,h=this.jacobianElementB;return i.cross(s,a),s.cross(i,l),c.rotational.copy(l),h.rotational.copy(a),-(Math.cos(this.maxAngle)-i.dot(s))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t,n){t.exports=a;var i=e("../math/Vec3");e("../math/Mat3");var s=e("./Equation");function a(e,t,n){n=void 0!==n?n:1e6,s.call(this,e,t,-n,n),this.axisA=new i,this.axisB=new i,this.targetVelocity=0}a.prototype=new s,a.prototype.constructor=a,a.prototype.computeB=function(e){this.a;var t=this.b;this.bi,this.bj;var n=this.axisA,i=this.axisB,s=this.jacobianElementA,a=this.jacobianElementB;return s.rotational.copy(n),i.negate(a.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t,n){var i=e("../utils/Utils");function s(e,t,n){n=i.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=s.idCounter++,this.materials=[e,t],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}t.exports=s,s.idCounter=0},{"../utils/Utils":53}],25:[function(e,t,n){function i(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=i.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1}t.exports=i,i.idCounter=0},{}],26:[function(e,t,n){t.exports=s;var i=e("./Vec3");function s(){this.spatial=new i,this.rotational=new i}s.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},s.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t,n){t.exports=s;var i=e("./Vec3");function s(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}s.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},s.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},s.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},s.prototype.getTrace=function(e){e=e||new i;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},s.prototype.vmult=function(e,t){t=t||new i;var n=this.elements,s=e.x,a=e.y,r=e.z;return t.x=n[0]*s+n[1]*a+n[2]*r,t.y=n[3]*s+n[4]*a+n[5]*r,t.z=n[6]*s+n[7]*a+n[8]*r,t},s.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},s.prototype.mmult=function(e,t){for(var n=t||new s,i=0;i<3;i++)for(var a=0;a<3;a++){for(var r=0,o=0;o<3;o++)r+=e.elements[i+3*o]*this.elements[o+3*a];n.elements[i+3*a]=r}return n},s.prototype.scale=function(e,t){t=t||new s;for(var n=this.elements,i=t.elements,a=0;3!==a;a++)i[3*a+0]=e.x*n[3*a+0],i[3*a+1]=e.y*n[3*a+1],i[3*a+2]=e.z*n[3*a+2];return t},s.prototype.solve=function(e,t){t=t||new i;for(var n,s=[],a=0;a<12;a++)s.push(0);for(a=0;a<3;a++)for(n=0;n<3;n++)s[a+4*n]=this.elements[a+3*n];s[3]=e.x,s[7]=e.y,s[11]=e.z;var r,o,l=3,c=l;do{if(0===s[(a=c-l)+4*a])for(n=a+1;n<c;n++)if(0!==s[a+4*n]){r=4;do{s[(o=4-r)+4*a]+=s[o+4*n]}while(--r);break}if(0!==s[a+4*a])for(n=a+1;n<c;n++){var h=s[a+4*n]/s[a+4*a];r=4;do{s[(o=4-r)+4*n]=o<=a?0:s[o+4*n]-s[o+4*a]*h}while(--r)}}while(--l);if(t.z=s[11]/s[10],t.y=(s[7]-s[6]*t.z)/s[5],t.x=(s[3]-s[2]*t.z-s[1]*t.y)/s[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},s.prototype.e=function(e,t,n){if(void 0===n)return this.elements[t+3*e];this.elements[t+3*e]=n},s.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},s.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},s.prototype.reverse=function(e){e=e||new s;for(var t,n=[],i=0;i<18;i++)n.push(0);for(i=0;i<3;i++)for(t=0;t<3;t++)n[i+6*t]=this.elements[i+3*t];n[3]=1,n[9]=0,n[15]=0,n[4]=0,n[10]=1,n[16]=0,n[5]=0,n[11]=0,n[17]=1;var a,r,o=3,l=o;do{if(0===n[(i=l-o)+6*i])for(t=i+1;t<l;t++)if(0!==n[i+6*t]){a=6;do{n[(r=6-a)+6*i]+=n[r+6*t]}while(--a);break}if(0!==n[i+6*i])for(t=i+1;t<l;t++){var c=n[i+6*t]/n[i+6*i];a=6;do{n[(r=6-a)+6*t]=r<=i?0:n[r+6*t]-n[r+6*i]*c}while(--a)}}while(--o);i=2;do{t=i-1;do{c=n[i+6*t]/n[i+6*i],a=6;do{n[(r=6-a)+6*t]=n[r+6*t]-n[r+6*i]*c}while(--a)}while(t--)}while(--i);i=2;do{c=1/n[i+6*i],a=6;do{n[(r=6-a)+6*i]=n[r+6*i]*c}while(--a)}while(i--);i=2;do{t=2;do{if(r=n[3+t+6*i],isNaN(r)||r===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,t,r)}while(t--)}while(i--);return e},s.prototype.setRotationFromQuaternion=function(e){var t=e.x,n=e.y,i=e.z,s=e.w,a=t+t,r=n+n,o=i+i,l=t*a,c=t*r,h=t*o,u=n*r,d=n*o,p=i*o,m=s*a,f=s*r,g=s*o,v=this.elements;return v[0]=1-(u+p),v[1]=c-g,v[2]=h+f,v[3]=c+g,v[4]=1-(l+p),v[5]=d-m,v[6]=h-f,v[7]=d+m,v[8]=1-(l+u),this},s.prototype.transpose=function(e){for(var t=(e=e||new s).elements,n=this.elements,i=0;3!==i;i++)for(var a=0;3!==a;a++)t[3*i+a]=n[3*a+i];return e}},{"./Vec3":30}],28:[function(e,t,n){t.exports=s;var i=e("./Vec3");function s(e,t,n,i){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==n?n:0,this.w=void 0!==i?i:1}s.prototype.set=function(e,t,n,i){this.x=e,this.y=t,this.z=n,this.w=i},s.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},s.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},s.prototype.setFromAxisAngle=function(e,t){var n=Math.sin(.5*t);this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*t)},s.prototype.toAxisAngle=function(e){e=e||new i,this.normalize();var t=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return n<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,t]};var a=new i,r=new i;s.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var n=a,i=r;e.tangents(n,i),this.setFromAxisAngle(n,Math.PI)}else{var s=e.cross(t);this.x=s.x,this.y=s.y,this.z=s.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}};var o=new i,l=new i,c=new i;s.prototype.mult=function(e,t){t=t||new s;var n=this.w,i=o,a=l,r=c;return i.set(this.x,this.y,this.z),a.set(e.x,e.y,e.z),t.w=n*e.w-i.dot(a),i.cross(a,r),t.x=n*a.x+e.w*i.x+r.x,t.y=n*a.y+e.w*i.y+r.y,t.z=n*a.z+e.w*i.z+r.z,t},s.prototype.inverse=function(e){var t=this.x,n=this.y,i=this.z,a=this.w;e=e||new s,this.conjugate(e);var r=1/(t*t+n*n+i*i+a*a);return e.x*=r,e.y*=r,e.z*=r,e.w*=r,e},s.prototype.conjugate=function(e){return(e=e||new s).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},s.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},s.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},s.prototype.vmult=function(e,t){t=t||new i;var n=e.x,s=e.y,a=e.z,r=this.x,o=this.y,l=this.z,c=this.w,h=c*n+o*a-l*s,u=c*s+l*n-r*a,d=c*a+r*s-o*n,p=-r*n-o*s-l*a;return t.x=h*c+p*-r+u*-l-d*-o,t.y=u*c+p*-o+d*-r-h*-l,t.z=d*c+p*-l+h*-o-u*-r,t},s.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},s.prototype.toEuler=function(e,t){var n,i,s;t=t||"YZX";var a=this.x,r=this.y,o=this.z,l=this.w;if("YZX"!==t)throw new Error("Euler order "+t+" not supported yet.");var c=a*r+o*l;if(c>.499&&(n=2*Math.atan2(a,l),i=Math.PI/2,s=0),c<-.499&&(n=-2*Math.atan2(a,l),i=-Math.PI/2,s=0),isNaN(n)){var h=a*a,u=r*r,d=o*o;n=Math.atan2(2*r*l-2*a*o,1-2*u-2*d),i=Math.asin(2*c),s=Math.atan2(2*a*l-2*r*o,1-2*h-2*d)}e.y=n,e.z=i,e.x=s},s.prototype.setFromEuler=function(e,t,n,i){i=i||"XYZ";var s=Math.cos(e/2),a=Math.cos(t/2),r=Math.cos(n/2),o=Math.sin(e/2),l=Math.sin(t/2),c=Math.sin(n/2);return"XYZ"===i?(this.x=o*a*r+s*l*c,this.y=s*l*r-o*a*c,this.z=s*a*c+o*l*r,this.w=s*a*r-o*l*c):"YXZ"===i?(this.x=o*a*r+s*l*c,this.y=s*l*r-o*a*c,this.z=s*a*c-o*l*r,this.w=s*a*r+o*l*c):"ZXY"===i?(this.x=o*a*r-s*l*c,this.y=s*l*r+o*a*c,this.z=s*a*c+o*l*r,this.w=s*a*r-o*l*c):"ZYX"===i?(this.x=o*a*r-s*l*c,this.y=s*l*r+o*a*c,this.z=s*a*c-o*l*r,this.w=s*a*r+o*l*c):"YZX"===i?(this.x=o*a*r+s*l*c,this.y=s*l*r+o*a*c,this.z=s*a*c-o*l*r,this.w=s*a*r-o*l*c):"XZY"===i&&(this.x=o*a*r-s*l*c,this.y=s*l*r-o*a*c,this.z=s*a*c+o*l*r,this.w=s*a*r+o*l*c),this},s.prototype.clone=function(){return new s(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t,n){var i=e("./Vec3"),s=e("./Quaternion");function a(e){e=e||{},this.position=new i,e.position&&this.position.copy(e.position),this.quaternion=new s,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=a;var r=new s;a.pointToLocalFrame=function(e,t,n,s){return s=s||new i,n.vsub(e,s),t.conjugate(r),r.vmult(s,s),s},a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)},a.pointToWorldFrame=function(e,t,n,s){return s=s||new i,t.vmult(n,s),s.vadd(e,s),s},a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)},a.prototype.vectorToWorldFrame=function(e,t){return t=t||new i,this.quaternion.vmult(e,t),t},a.vectorToWorldFrame=function(e,t,n){return e.vmult(t,n),n},a.vectorToLocalFrame=function(e,t,n,s){return s=s||new i,t.w*=-1,t.vmult(n,s),t.w*=-1,s}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t,n){t.exports=s;var i=e("./Mat3");function s(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0}s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1),s.prototype.cross=function(e,t){var n=e.x,i=e.y,a=e.z,r=this.x,o=this.y,l=this.z;return(t=t||new s).x=o*a-l*i,t.y=l*n-r*a,t.z=r*i-o*n,t},s.prototype.set=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},s.prototype.setZero=function(){this.x=this.y=this.z=0},s.prototype.vadd=function(e,t){if(!t)return new s(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},s.prototype.vsub=function(e,t){if(!t)return new s(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},s.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},s.prototype.normalize=function(){var e=this.x,t=this.y,n=this.z,i=Math.sqrt(e*e+t*t+n*n);if(i>0){var s=1/i;this.x*=s,this.y*=s,this.z*=s}else this.x=0,this.y=0,this.z=0;return i},s.prototype.unit=function(e){e=e||new s;var t=this.x,n=this.y,i=this.z,a=Math.sqrt(t*t+n*n+i*i);return a>0?(a=1/a,e.x=t*a,e.y=n*a,e.z=i*a):(e.x=1,e.y=0,e.z=0),e},s.prototype.norm=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},s.prototype.length=s.prototype.norm,s.prototype.norm2=function(){return this.dot(this)},s.prototype.lengthSquared=s.prototype.norm2,s.prototype.distanceTo=function(e){var t=this.x,n=this.y,i=this.z,s=e.x,a=e.y,r=e.z;return Math.sqrt((s-t)*(s-t)+(a-n)*(a-n)+(r-i)*(r-i))},s.prototype.distanceSquared=function(e){var t=this.x,n=this.y,i=this.z,s=e.x,a=e.y,r=e.z;return(s-t)*(s-t)+(a-n)*(a-n)+(r-i)*(r-i)},s.prototype.mult=function(e,t){t=t||new s;var n=this.x,i=this.y,a=this.z;return t.x=e*n,t.y=e*i,t.z=e*a,t},s.prototype.scale=s.prototype.mult,s.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},s.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},s.prototype.negate=function(e){return(e=e||new s).x=-this.x,e.y=-this.y,e.z=-this.z,e};var a=new s,r=new s;s.prototype.tangents=function(e,t){var n=this.norm();if(n>0){var i=a,s=1/n;i.set(this.x*s,this.y*s,this.z*s);var o=r;Math.abs(i.x)<.9?(o.set(1,0,0),i.cross(o,e)):(o.set(0,1,0),i.cross(o,e)),i.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},s.prototype.toString=function(){return this.x+","+this.y+","+this.z},s.prototype.toArray=function(){return[this.x,this.y,this.z]},s.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},s.prototype.lerp=function(e,t,n){var i=this.x,s=this.y,a=this.z;n.x=i+(e.x-i)*t,n.y=s+(e.y-s)*t,n.z=a+(e.z-a)*t},s.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},s.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var o=new s;s.prototype.isAntiparallelTo=function(e,t){return this.negate(o),o.almostEquals(e,t)},s.prototype.clone=function(){return new s(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t,n){t.exports=c;var i=e("../utils/EventTarget");e("../shapes/Shape");var s=e("../math/Vec3"),a=e("../math/Mat3"),r=e("../math/Quaternion");e("../material/Material");var o=e("../collision/AABB"),l=e("../shapes/Box");function c(e){e=e||{},i.apply(this),this.id=c.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new s,e.position&&this.position.copy(e.position),this.previousPosition=new s,this.initPosition=new s,this.velocity=new s,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new s,this.force=new s;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?c.STATIC:c.DYNAMIC,typeof e.type==typeof c.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new r,e.quaternion&&this.quaternion.copy(e.quaternion),this.initQuaternion=new r,this.angularVelocity=new s,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new s,this.interpolatedPosition=new s,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new a,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new a,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.aabb=new o,this.aabbNeedsUpdate=!0,this.wlambda=new s,e.shape&&this.addShape(e.shape),this.updateMassProperties()}c.prototype=new i,c.prototype.constructor=c,c.DYNAMIC=1,c.STATIC=2,c.KINEMATIC=4,c.AWAKE=0,c.SLEEPY=1,c.SLEEPING=2,c.idCounter=0,c.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===c.SLEEPING&&this.dispatchEvent({type:"wakeup"})},c.prototype.sleep=function(){this.sleepState=c.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},c.sleepyEvent={type:"sleepy"},c.sleepEvent={type:"sleep"},c.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);t===c.AWAKE&&n<i?(this.sleepState=c.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(c.sleepyEvent)):t===c.SLEEPY&&n>i?this.wakeUp():t===c.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(c.sleepEvent))}},c.prototype.updateSolveMassProperties=function(){this.sleepState===c.SLEEPING||this.type===c.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},c.prototype.pointToLocalFrame=function(e,t){return t=t||new s,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},c.prototype.vectorToLocalFrame=function(e,t){return t=t||new s,this.quaternion.conjugate().vmult(e,t),t},c.prototype.pointToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},c.prototype.vectorToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t};var h=new s,u=new r;c.prototype.addShape=function(e,t,n){var i=new s,a=new r;return t&&i.copy(t),n&&a.copy(n),this.shapes.push(e),this.shapeOffsets.push(i),this.shapeOrientations.push(a),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},c.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,n=e.length,i=0,s=0;s!==n;s++){var a=e[s];a.updateBoundingSphereRadius();var r=t[s].norm(),o=a.boundingSphereRadius;r+o>i&&(i=r+o)}this.boundingRadius=i};var d=new o;c.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,n=this.shapeOrientations,i=e.length,s=h,a=u,r=this.quaternion,o=this.aabb,l=d,c=0;c!==i;c++){var p=e[c];n[c].mult(r,a),a.vmult(t[c],s),s.vadd(this.position,s),p.calculateWorldAABB(s,a,l.lowerBound,l.upperBound),0===c?o.copy(l):o.extend(l)}this.aabbNeedsUpdate=!1};var p=new a,m=new a;new a,c.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var n=p,i=m;n.setRotationFromQuaternion(this.quaternion),n.transpose(i),n.scale(t,n),n.mmult(i,this.invInertiaWorld)}};var f=new s,g=new s;c.prototype.applyForce=function(e,t){if(this.type===c.DYNAMIC){var n=f;t.vsub(this.position,n);var i=g;n.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new s,x=new s;c.prototype.applyLocalForce=function(e,t){if(this.type===c.DYNAMIC){var n=v,i=x;this.vectorToWorldFrame(e,n),this.pointToWorldFrame(t,i),this.applyForce(n,i)}};var y=new s,b=new s,_=new s;c.prototype.applyImpulse=function(e,t){if(this.type===c.DYNAMIC){var n=y;t.vsub(this.position,n);var i=b;i.copy(e),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity);var s=_;n.cross(e,s),this.invInertiaWorld.vmult(s,s),this.angularVelocity.vadd(s,this.angularVelocity)}};var w=new s,S=new s;c.prototype.applyLocalImpulse=function(e,t){if(this.type===c.DYNAMIC){var n=w,i=S;this.vectorToWorldFrame(e,n),this.pointToWorldFrame(t,i),this.applyImpulse(n,i)}};var M=new s;c.prototype.updateMassProperties=function(){var e=M;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,n=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0),this.updateInertiaWorld(!0)},c.prototype.getVelocityAtWorldPoint=function(e,t){var n=new s;return e.vsub(this.position,n),this.angularVelocity.cross(n,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t,n){e("./Body");var i=e("../math/Vec3"),s=e("../math/Quaternion");e("../collision/RaycastResult");var a=e("../collision/Ray"),r=e("../objects/WheelInfo");function o(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=o,new i,new i,new i;var l=new i,c=new i,h=new i;new a,o.prototype.addWheel=function(e){var t=new r(e=e||{}),n=this.wheelInfos.length;return this.wheelInfos.push(t),n},o.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new i,o.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},o.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},o.prototype.addToWorld=function(e){this.constraints,e.add(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},o.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},o.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,n=t.length,s=this.chassisBody,a=0;a<n;a++)this.updateWheelTransform(a);this.currentVehicleSpeedKmHour=3.6*s.velocity.norm();var r=new i;for(this.getVehicleAxisWorld(this.indexForwardAxis,r),r.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),a=0;a<n;a++)this.castRay(t[a]);this.updateSuspension(e);var o=new i,l=new i;for(a=0;a<n;a++){var c=(p=t[a]).suspensionForce;c>p.maxSuspensionForce&&(c=p.maxSuspensionForce),p.raycastResult.hitNormalWorld.scale(c*e,o),p.raycastResult.hitPointWorld.vsub(s.position,l),s.applyImpulse(o,p.raycastResult.hitPointWorld)}this.updateFriction(e);var h=new i,u=new i,d=new i;for(a=0;a<n;a++){var p=t[a];s.getVelocityAtWorldPoint(p.chassisConnectionPointWorld,d);var m=1;if(1===this.indexUpAxis&&(m=-1),p.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var f=u.dot(p.raycastResult.hitNormalWorld);p.raycastResult.hitNormalWorld.scale(f,h),u.vsub(h,u);var g=u.dot(d);p.deltaRotation=m*g*e/p.radius}!p.sliding&&p.isInContact||0===p.engineForce||!p.useCustomSlidingRotationalSpeed||(p.deltaRotation=(p.engineForce>0?1:-1)*p.customSlidingRotationalSpeed*e),Math.abs(p.brake)>Math.abs(p.engineForce)&&(p.deltaRotation=0),p.rotation+=p.deltaRotation,p.deltaRotation*=.99}},o.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,n=this.wheelInfos,i=n.length,s=0;s<i;s++){var a=n[s];if(a.isInContact){var r,o=a.suspensionRestLength-a.suspensionLength;r=a.suspensionStiffness*o*a.clippedInvContactDotSuspension;var l=a.suspensionRelativeVelocity;r-=(l<0?a.dampingCompression:a.dampingRelaxation)*l,a.suspensionForce=r*t,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},o.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new i,d=new i;o.prototype.castRay=function(e){var t=u,n=d;this.updateWheelTransformWorld(e);var s=this.chassisBody,a=-1,r=e.suspensionRestLength+e.radius;e.directionWorld.scale(r,t);var o=e.chassisConnectionPointWorld;o.vadd(t,n);var l=e.raycastResult;l.reset();var c=s.collisionResponse;s.collisionResponse=!1,this.world.rayTest(o,n,l),s.collisionResponse=c;var h=l.body;if(e.raycastResult.groundObject=0,h){a=l.distance,e.raycastResult.hitNormalWorld=l.hitNormalWorld,e.isInContact=!0;var p=l.distance;e.suspensionLength=p-e.radius;var m=e.suspensionRestLength-e.maxSuspensionTravel,f=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<m&&(e.suspensionLength=m),e.suspensionLength>f&&(e.suspensionLength=f,e.raycastResult.reset());var g=e.raycastResult.hitNormalWorld.dot(e.directionWorld),v=new i;s.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,v);var x=e.raycastResult.hitNormalWorld.dot(v);if(g>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var y=-1/g;e.suspensionRelativeVelocity=x*y,e.clippedInvContactDotSuspension=y}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return a},o.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},o.prototype.updateWheelTransform=function(e){var t=l,n=c,i=h,a=this.wheelInfos[e];this.updateWheelTransformWorld(a),a.directionLocal.scale(-1,t),n.copy(a.axleLocal),t.cross(n,i),i.normalize(),n.normalize();var r=a.steering,o=new s;o.setFromAxisAngle(t,r);var u=new s;u.setFromAxisAngle(n,a.rotation);var d=a.worldTransform.quaternion;this.chassisBody.quaternion.mult(o,d),d.mult(u,d),d.normalize();var p=a.worldTransform.position;p.copy(a.directionWorld),p.scale(a.suspensionLength,p),p.vadd(a.chassisConnectionPointWorld,p)};var p=[new i(1,0,0),new i(0,1,0),new i(0,0,1)];o.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var m=new i,f=[],g=[];o.prototype.updateFriction=function(e){for(var t=m,n=this.wheelInfos,s=n.length,a=this.chassisBody,r=g,o=f,l=0;l<s;l++){var c=(E=n[l]).raycastResult.body;E.sideImpulse=0,E.forwardImpulse=0,r[l]||(r[l]=new i),o[l]||(o[l]=new i)}for(l=0;l<s;l++)if(c=(E=n[l]).raycastResult.body){var h=o[l];this.getWheelTransformWorld(l).vectorToWorldFrame(p[this.indexRightAxis],h);var u=E.raycastResult.hitNormalWorld,d=h.dot(u);u.scale(d,t),h.vsub(t,h),h.normalize(),u.cross(h,r[l]),r[l].normalize(),E.sideImpulse=A(a,E.raycastResult.hitPointWorld,c,E.raycastResult.hitPointWorld,h),E.sideImpulse*=1}for(this.sliding=!1,l=0;l<s;l++){c=(E=n[l]).raycastResult.body;var v=0;if(E.slipInfo=1,c){var x=E.brake?E.brake:0;v=b(a,c,E.raycastResult.hitPointWorld,r[l],x);var y=x/(v+=E.engineForce*e);E.slipInfo*=y}if(E.forwardImpulse=0,E.skidInfo=1,c){E.skidInfo=1;var _=E.suspensionForce*e*E.frictionSlip,w=_*_;E.forwardImpulse=v;var S=.5*E.forwardImpulse,M=1*E.sideImpulse,T=S*S+M*M;E.sliding=!1,T>w&&(this.sliding=!0,E.sliding=!0,y=_/Math.sqrt(T),E.skidInfo*=y)}}if(this.sliding)for(l=0;l<s;l++)0!==(E=n[l]).sideImpulse&&E.skidInfo<1&&(E.forwardImpulse*=E.skidInfo,E.sideImpulse*=E.skidInfo);for(l=0;l<s;l++){var E=n[l],C=new i;if(C.copy(E.raycastResult.hitPointWorld),0!==E.forwardImpulse){var N=new i;r[l].scale(E.forwardImpulse,N),a.applyImpulse(N,C)}if(0!==E.sideImpulse){c=E.raycastResult.body;var R=new i;R.copy(E.raycastResult.hitPointWorld);var j=new i;o[l].scale(E.sideImpulse,j),a.pointToLocalFrame(C,C),C["xyz"[this.indexUpAxis]]*=E.rollInfluence,a.pointToWorldFrame(C,C),a.applyImpulse(j,C),j.scale(-1,j),c.applyImpulse(j,R)}}};var v=new i,x=new i,y=new i;function b(e,t,n,i,s){var a=0,r=n,o=v,l=x,c=y;return e.getVelocityAtWorldPoint(r,o),t.getVelocityAtWorldPoint(r,l),o.vsub(l,c),s<(a=-i.dot(c)*(1/(T(e,n,i)+T(t,n,i))))&&(a=s),a<-s&&(a=-s),a}var _=new i,w=new i,S=new i,M=new i;function T(e,t,n){var i=_,s=w,a=S,r=M;return t.vsub(e.position,i),i.cross(n,s),e.invInertiaWorld.vmult(s,r),r.cross(i,a),e.invMass+n.dot(a)}var E=new i,C=new i,N=new i;function A(e,t,n,i,s,a){if(s.norm2()>1.1)return 0;var r=E,o=C,l=N;return e.getVelocityAtWorldPoint(t,r),n.getVelocityAtWorldPoint(i,o),r.vsub(o,l),-.2*s.dot(l)*(1/(e.invMass+n.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t,n){var i=e("./Body"),s=e("../shapes/Sphere"),a=e("../shapes/Box"),r=e("../math/Vec3"),o=e("../constraints/HingeConstraint");function l(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new r(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new a(new r(5,2,.5));this.chassisBody=new i(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}t.exports=l,l.prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new i(1,new s(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0),new r;var n=void 0!==e.position?e.position.clone():new r,a=new r;this.chassisBody.pointToWorldFrame(n,a),t.position.set(a.x,a.y,a.z);var l=void 0!==e.axis?e.axis.clone():new r(0,1,0);this.wheelAxes.push(l);var c=new o(this.chassisBody,t,{pivotA:n,axisA:l,pivotB:r.ZERO,axisB:l,collideConnected:!1});return this.constraints.push(c),this.wheelBodies.length-1},l.prototype.setSteeringValue=function(e,t){var n=this.wheelAxes[t],i=Math.cos(e),s=Math.sin(e),a=n.x,r=n.y;this.constraints[t].axisA.set(i*a-s*r,s*a+i*r,0)},l.prototype.setMotorSpeed=function(e,t){var n=this.constraints[t];n.enableMotor(),n.motorTargetVelocity=e},l.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var c=new r;l.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},l.prototype.applyWheelForce=function(e,t){var n=this.wheelAxes[t],i=this.wheelBodies[t],s=i.torque;n.scale(e,c),i.vectorToWorldFrame(c,c),s.vadd(c,s)},l.prototype.addToWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.add(n[i]);for(i=0;i<t.length;i++)e.addConstraint(t[i]);e.addEventListener("preStep",this._update.bind(this))},l.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},l.prototype.removeFromWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.remove(n[i]);for(i=0;i<t.length;i++)e.removeConstraint(t[i])};var h=new r;l.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],n=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,h),n.dot(h)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t,n){t.exports=s,e("../shapes/Shape");var i=e("../math/Vec3");function s(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),s.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},s.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var a=new i;s.prototype.getNeighbors=function(e,t){for(var n=this.particles.length,i=e.id,s=this.smoothingRadius*this.smoothingRadius,r=a,o=0;o!==n;o++){var l=this.particles[o];l.position.vsub(e.position,r),i!==l.id&&r.norm2()<s&&t.push(l)}};var r=new i,o=new i,l=new i,c=new i,h=new i,u=new i;s.prototype.update=function(){for(var e=this.particles.length,t=r,n=this.speedOfSound,i=this.eps,s=0;s!==e;s++){var a=this.particles[s];(M=this.neighbors[s]).length=0,this.getNeighbors(a,M),M.push(this.particles[s]);for(var d=M.length,p=0,m=0;m!==d;m++){a.position.vsub(M[m].position,t);var f=t.norm(),g=this.w(f);p+=M[m].mass*g}this.densities[s]=p,this.pressures[s]=n*n*(this.densities[s]-this.density)}var v=o,x=l,y=c,b=h,_=u;for(s=0;s!==e;s++){var w,S,M,T=this.particles[s];for(v.set(0,0,0),x.set(0,0,0),d=(M=this.neighbors[s]).length,m=0;m!==d;m++){var E=M[m];T.position.vsub(E.position,b);var C=b.norm();w=-E.mass*(this.pressures[s]/(this.densities[s]*this.densities[s]+i)+this.pressures[m]/(this.densities[m]*this.densities[m]+i)),this.gradw(b,y),y.mult(w,y),v.vadd(y,v),E.velocity.vsub(T.velocity,_),_.mult(1/(1e-4+this.densities[s]*this.densities[m])*this.viscosity*E.mass,_),S=this.nablaw(C),_.mult(S,_),x.vadd(_,x)}x.mult(T.mass,x),v.mult(T.mass,v),T.force.vadd(x,T.force),T.force.vadd(v,T.force)}},s.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},s.prototype.gradw=function(e,t){var n=e.norm(),i=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-n*n,2),t)},s.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t,n){var i=e("../math/Vec3");function s(e,t,n){n=n||{},this.restLength="number"==typeof n.restLength?n.restLength:1,this.stiffness=n.stiffness||100,this.damping=n.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new i,this.localAnchorB=new i,n.localAnchorA&&this.localAnchorA.copy(n.localAnchorA),n.localAnchorB&&this.localAnchorB.copy(n.localAnchorB),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB)}t.exports=s,s.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},s.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},s.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},s.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var a=new i,r=new i,o=new i,l=new i,c=new i,h=new i,u=new i,d=new i,p=new i,m=new i,f=new i;s.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,n=this.restLength,i=this.bodyA,s=this.bodyB,g=a,v=r,x=o,y=l,b=f,_=c,w=h,S=u,M=d,T=p,E=m;this.getWorldAnchorA(_),this.getWorldAnchorB(w),_.vsub(i.position,S),w.vsub(s.position,M),w.vsub(_,g);var C=g.norm();v.copy(g),v.normalize(),s.velocity.vsub(i.velocity,x),s.angularVelocity.cross(M,b),x.vadd(b,x),i.angularVelocity.cross(S,b),x.vsub(b,x),v.mult(-e*(C-n)-t*x.dot(v),y),i.force.vsub(y,i.force),s.force.vadd(y,s.force),S.cross(y,T),M.cross(y,E),i.torque.vsub(T,i.torque),s.torque.vadd(E,s.torque)}},{"../math/Vec3":30}],36:[function(e,t,n){var i=e("../math/Vec3"),s=e("../math/Transform"),a=e("../collision/RaycastResult"),r=e("../utils/Utils");function o(e){e=r.defaults(e,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,axleWorld:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new s,this.isInContact=!1}t.exports=o;var l=new i,c=new i;l=new i,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var n=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,l);var i=t.hitNormalWorld.dot(l);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var s=-1/n;this.suspensionRelativeVelocity=i*s,this.clippedInvContactDotSuspension=s}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t,n){t.exports=r;var i=e("./Shape"),s=e("../math/Vec3"),a=e("./ConvexPolyhedron");function r(e){i.call(this),this.type=i.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new i,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,n=this.halfExtents.z,i=s,r=[new i(-e,-t,-n),new i(e,-t,-n),new i(e,t,-n),new i(-e,t,-n),new i(-e,-t,n),new i(e,-t,n),new i(e,t,n),new i(-e,t,n)];new i(0,0,1),new i(0,1,0),new i(1,0,0);var o=new a(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]);this.convexPolyhedronRepresentation=o,o.material=this.material},r.prototype.calculateLocalInertia=function(e,t){return t=t||new s,r.calculateInertia(this.halfExtents,e,t),t},r.calculateInertia=function(e,t,n){var i=e;n.x=1/12*t*(2*i.y*2*i.y+2*i.z*2*i.z),n.y=1/12*t*(2*i.x*2*i.x+2*i.z*2*i.z),n.z=1/12*t*(2*i.y*2*i.y+2*i.x*2*i.x)},r.prototype.getSideNormals=function(e,t){var n=e,i=this.halfExtents;if(n[0].set(i.x,0,0),n[1].set(0,i.y,0),n[2].set(0,0,i.z),n[3].set(-i.x,0,0),n[4].set(0,-i.y,0),n[5].set(0,0,-i.z),void 0!==t)for(var s=0;s!==n.length;s++)t.vmult(n[s],n[s]);return n},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var o=new s;new s,r.prototype.forEachWorldCorner=function(e,t,n){for(var i=this.halfExtents,s=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],a=0;a<s.length;a++)o.set(s[a][0],s[a][1],s[a][2]),t.vmult(o,o),e.vadd(o,o),n(o.x,o.y,o.z)};var l=[new s,new s,new s,new s,new s,new s,new s,new s];r.prototype.calculateWorldAABB=function(e,t,n,i){var s=this.halfExtents;l[0].set(s.x,s.y,s.z),l[1].set(-s.x,s.y,s.z),l[2].set(-s.x,-s.y,s.z),l[3].set(-s.x,-s.y,-s.z),l[4].set(s.x,-s.y,-s.z),l[5].set(s.x,s.y,-s.z),l[6].set(-s.x,s.y,-s.z),l[7].set(s.x,-s.y,s.z);var a=l[0];t.vmult(a,a),e.vadd(a,a),i.copy(a),n.copy(a);for(var r=1;r<8;r++){a=l[r],t.vmult(a,a),e.vadd(a,a);var o=a.x,c=a.y,h=a.z;o>i.x&&(i.x=o),c>i.y&&(i.y=c),h>i.z&&(i.z=h),o<n.x&&(n.x=o),c<n.y&&(n.y=c),h<n.z&&(n.z=h)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t,n){t.exports=r;var i=e("./Shape"),s=e("../math/Vec3");e("../math/Quaternion");var a=e("../math/Transform");function r(e,t,n){i.call(this),this.type=i.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=n?n.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new i,r.prototype.constructor=r;var o=new s;r.prototype.computeEdges=function(){var e=this.faces,t=this.vertices;t.length;var n=this.uniqueEdges;n.length=0;for(var i=o,s=0;s!==e.length;s++)for(var a=e[s],r=a.length,l=0;l!==r;l++){var c=(l+1)%r;t[a[l]].vsub(t[a[c]],i),i.normalize();for(var h=!1,u=0;u!==n.length;u++)if(n[u].almostEquals(i)||n[u].almostEquals(i)){h=!0;break}h||n.push(i.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var n=this.faceNormals[e]||new s;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n;var i=this.vertices[this.faces[e][0]];if(n.dot(i)<0)for(t=0;t<this.faces[e].length;t++);}};var l=new s,c=new s;r.computeNormal=function(e,t,n,i){t.vsub(e,c),n.vsub(t,l),l.cross(c,i),i.isZero()||i.normalize()},r.prototype.getFaceNormal=function(e,t){var n=this.faces[e],i=this.vertices[n[0]],s=this.vertices[n[1]],a=this.vertices[n[2]];return r.computeNormal(i,s,a,t)};var h=new s;r.prototype.clipAgainstHull=function(e,t,n,i,a,r,o,l,c){for(var u=h,d=-1,p=-Number.MAX_VALUE,m=0;m<n.faces.length;m++){u.copy(n.faceNormals[m]),a.vmult(u,u);var f=u.dot(r);f>p&&(p=f,d=m)}for(var g=[],v=n.faces[d],x=v.length,y=0;y<x;y++){var b=n.vertices[v[y]],_=new s;_.copy(b),a.vmult(_,_),i.vadd(_,_),g.push(_)}d>=0&&this.clipFaceAgainstHull(r,e,t,g,o,l,c)};var u=new s,d=new s,p=new s,m=new s,f=new s,g=new s;r.prototype.findSeparatingAxis=function(e,t,n,i,s,a,r,o){var l=u,c=d,h=p,v=m,x=f,y=g,b=Number.MAX_VALUE,_=this;if(_.uniqueAxes)for(S=0;S!==_.uniqueAxes.length;S++){if(n.vmult(_.uniqueAxes[S],l),!1===(E=_.testSepAxis(l,e,t,n,i,s)))return!1;E<b&&(b=E,a.copy(l))}else for(var w=r?r.length:_.faces.length,S=0;S<w;S++){var M=r?r[S]:S;if(l.copy(_.faceNormals[M]),n.vmult(l,l),!1===(E=_.testSepAxis(l,e,t,n,i,s)))return!1;E<b&&(b=E,a.copy(l))}if(e.uniqueAxes)for(S=0;S!==e.uniqueAxes.length;S++){if(s.vmult(e.uniqueAxes[S],c),!1===(E=_.testSepAxis(c,e,t,n,i,s)))return!1;E<b&&(b=E,a.copy(c))}else{var T=o?o.length:e.faces.length;for(S=0;S<T;S++){var E;if(M=o?o[S]:S,c.copy(e.faceNormals[M]),s.vmult(c,c),!1===(E=_.testSepAxis(c,e,t,n,i,s)))return!1;E<b&&(b=E,a.copy(c))}}for(var C=0;C!==_.uniqueEdges.length;C++){n.vmult(_.uniqueEdges[C],v);for(var N=0;N!==e.uniqueEdges.length;N++)if(s.vmult(e.uniqueEdges[N],x),v.cross(x,y),!y.almostZero()){y.normalize();var A=_.testSepAxis(y,e,t,n,i,s);if(!1===A)return!1;A<b&&(b=A,a.copy(y))}}return i.vsub(t,h),h.dot(a)>0&&a.negate(a),!0};var v=[],x=[];r.prototype.testSepAxis=function(e,t,n,i,s,a){r.project(this,e,n,i,v),r.project(t,e,s,a,x);var o=v[0]-x[1],l=x[0]-v[1];return o<l?o:l};var y=new s,b=new s;r.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y,b);var n=b.x-y.x,i=b.y-y.y,s=b.z-y.z;t.x=1/12*e*(2*i*2*i+2*s*2*s),t.y=1/12*e*(2*n*2*n+2*s*2*s),t.z=1/12*e*(2*i*2*i+2*n*2*n)},r.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],n=this.faceNormals[e],i=this.vertices[t[0]];return-n.dot(i)};var _=new s,w=new s,S=new s,M=new s,T=new s,E=new s,C=new s,N=new s;r.prototype.clipFaceAgainstHull=function(e,t,n,i,s,a,r){for(var o=_,l=w,c=S,h=M,u=T,d=E,p=C,m=N,f=this,g=i,v=[],x=-1,y=Number.MAX_VALUE,b=0;b<f.faces.length;b++){o.copy(f.faceNormals[b]),n.vmult(o,o);var A=o.dot(e);A<y&&(y=A,x=b)}if(!(x<0)){var R=f.faces[x];R.connectedFaces=[];for(var j=0;j<f.faces.length;j++)for(var P=0;P<f.faces[j].length;P++)-1!==R.indexOf(f.faces[j][P])&&j!==x&&-1===R.connectedFaces.indexOf(j)&&R.connectedFaces.push(j);g.length;for(var I=R.length,D=0;D<I;D++){var k=f.vertices[R[D]],L=f.vertices[R[(D+1)%I]];k.vsub(L,l),c.copy(l),n.vmult(c,c),t.vadd(c,c),h.copy(this.faceNormals[x]),n.vmult(h,h),t.vadd(h,h),c.cross(h,u),u.negate(u),d.copy(k),n.vmult(d,d),t.vadd(d,d),d.dot(u);var O=R.connectedFaces[D];p.copy(this.faceNormals[O]);var U=this.getPlaneConstantOfFace(O);m.copy(p),n.vmult(m,m);var F=U-m.dot(t);for(this.clipFaceAgainstPlane(g,v,m,F);g.length;)g.shift();for(;v.length;)g.push(v.shift())}for(p.copy(this.faceNormals[x]),U=this.getPlaneConstantOfFace(x),m.copy(p),n.vmult(m,m),F=U-m.dot(t),j=0;j<g.length;j++){var z=m.dot(g[j])+F;if(z<=s&&(z=s),z<=a){var B=g[j];if(z<=0){var V={point:B,normal:m,depth:z};r.push(V)}}}}},r.prototype.clipFaceAgainstPlane=function(e,t,n,i){var a,r,o=e.length;if(o<2)return t;var l=e[e.length-1],c=e[0];a=n.dot(l)+i;for(var h=0;h<o;h++){if(c=e[h],r=n.dot(c)+i,a<0)if(r<0)(u=new s).copy(c),t.push(u);else{var u=new s;l.lerp(c,a/(a-r),u),t.push(u)}else r<0&&(u=new s,l.lerp(c,a/(a-r),u),t.push(u),t.push(c));l=c,a=r}return t},r.prototype.computeWorldVertices=function(e,t){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new s);for(var i=this.vertices,a=this.worldVertices,r=0;r!==n;r++)t.vmult(i[r],a[r]),e.vadd(a[r],a[r]);this.worldVerticesNeedsUpdate=!1},new s,r.prototype.computeLocalAABB=function(e,t){var n=this.vertices.length,i=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;s<n;s++){var a=i[s];a.x<e.x?e.x=a.x:a.x>t.x&&(t.x=a.x),a.y<e.y?e.y=a.y:a.y>t.y&&(t.y=a.y),a.z<e.z?e.z=a.z:a.z>t.z&&(t.z=a.z)}},r.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new s);for(var n=this.faceNormals,i=this.worldFaceNormals,a=0;a!==t;a++)e.vmult(n[a],i[a]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=0,i=t.length;n!==i;n++){var s=t[n].norm2();s>e&&(e=s)}this.boundingSphereRadius=Math.sqrt(e)};var A=new s;r.prototype.calculateWorldAABB=function(e,t,n,i){for(var s,a,r,o,l,c,h=this.vertices.length,u=this.vertices,d=0;d<h;d++){A.copy(u[d]),t.vmult(A,A),e.vadd(A,A);var p=A;p.x<s||void 0===s?s=p.x:(p.x>o||void 0===o)&&(o=p.x),p.y<a||void 0===a?a=p.y:(p.y>l||void 0===l)&&(l=p.y),p.z<r||void 0===r?r=p.z:(p.z>c||void 0===c)&&(c=p.z)}n.set(s,a,r),i.set(o,l,c)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(e){e=e||new s;for(var t=this.vertices.length,n=this.vertices,i=0;i<t;i++)e.vadd(n[i],e);return e.mult(1/t,e),e},r.prototype.transformAllPoints=function(e,t){var n=this.vertices.length,i=this.vertices;if(t){for(var s=0;s<n;s++){var a=i[s];t.vmult(a,a)}for(s=0;s<this.faceNormals.length;s++)a=this.faceNormals[s],t.vmult(a,a)}if(e)for(s=0;s<n;s++)(a=i[s]).vadd(e,a)};var R=new s,j=new s,P=new s;r.prototype.pointIsInside=function(e){var t=this.vertices.length,n=this.vertices,i=this.faces,s=this.faceNormals,a=this.faces.length,r=R;this.getAveragePointLocal(r);for(var o=0;o<a;o++){this.faces[o].length,t=s[o];var l=n[i[o][0]],c=j;e.vsub(l,c);var h=t.dot(c),u=P;r.vsub(l,u);var d=t.dot(u);if(h<0&&d>0||h>0&&d<0)return!1}return-1},new s;var I=new s,D=new s;r.project=function(e,t,n,i,s){var r=e.vertices.length,o=I,l=0,c=0,h=D,u=e.vertices;h.setZero(),a.vectorToLocalFrame(n,i,t,o),a.pointToLocalFrame(n,i,h,h);var d=h.dot(o);c=l=u[0].dot(o);for(var p=1;p<r;p++){var m=u[p].dot(o);m>l&&(l=m),m<c&&(c=m)}if((c-=d)>(l-=d)){var f=c;c=l,l=f}s[0]=l,s[1]=c}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t,n){t.exports=r;var i=e("./Shape"),s=e("../math/Vec3");e("../math/Quaternion");var a=e("./ConvexPolyhedron");function r(e,t,n,r){var o=r,l=[],c=[],h=[],u=[],d=[],p=Math.cos,m=Math.sin;l.push(new s(t*p(0),t*m(0),.5*-n)),u.push(0),l.push(new s(e*p(0),e*m(0),.5*n)),d.push(1);for(var f=0;f<o;f++){var g=2*Math.PI/o*(f+1),v=2*Math.PI/o*(f+.5);f<o-1?(l.push(new s(t*p(g),t*m(g),.5*-n)),u.push(2*f+2),l.push(new s(e*p(g),e*m(g),.5*n)),d.push(2*f+3),h.push([2*f+2,2*f+3,2*f+1,2*f])):h.push([0,1,2*f+1,2*f]),(o%2==1||f<o/2)&&c.push(new s(p(v),m(v),0))}h.push(d),c.push(new s(0,0,1));var x=[];for(f=0;f<u.length;f++)x.push(u[u.length-f-1]);h.push(x),this.type=i.types.CONVEXPOLYHEDRON,a.call(this,l,h,c)}r.prototype=new a},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t,n){var i=e("./Shape"),s=e("./ConvexPolyhedron"),a=e("../math/Vec3"),r=e("../utils/Utils");function o(e,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,i.call(this),this.pillarConvex=new s,this.pillarOffset=new a,this.type=i.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}t.exports=o,o.prototype=new i,o.prototype.update=function(){this._cachedPillars={}},o.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var s=e[n][i];s<t&&(t=s)}this.minValue=t},o.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var s=e[n][i];s>t&&(t=s)}this.maxValue=t},o.prototype.setHeightValueAtIndex=function(e,t,n){this.data[e][t]=n,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},o.prototype.getRectMinMax=function(e,t,n,i,s){s=s||[];for(var a=this.data,r=this.minValue,o=e;o<=n;o++)for(var l=t;l<=i;l++){var c=a[o][l];c>r&&(r=c)}s[0]=this.minValue,s[1]=r},o.prototype.getIndexOfPosition=function(e,t,n,i){var s=this.elementSize,a=this.data,r=Math.floor(e/s),o=Math.floor(t/s);return n[0]=r,n[1]=o,i&&(r<0&&(r=0),o<0&&(o=0),r>=a.length-1&&(r=a.length-1),o>=a[0].length-1&&(o=a[0].length-1)),!(r<0||o<0||r>=a.length-1||o>=a[0].length-1)},o.prototype.getHeightAt=function(e,t,n){var i=[];this.getIndexOfPosition(e,t,i,n);var s=[];return this.getRectMinMax(i[0],i[1]+1,i[0],i[1]+1,s),(s[0]+s[1])/2},o.prototype.getCacheConvexTrianglePillarKey=function(e,t,n){return e+"_"+t+"_"+(n?1:0)},o.prototype.getCachedConvexTrianglePillar=function(e,t,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},o.prototype.setCachedConvexTrianglePillar=function(e,t,n,i,s){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]={convex:i,offset:s}},o.prototype.clearCachedConvexTrianglePillar=function(e,t,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},o.prototype.getConvexTrianglePillar=function(e,t,n){var i=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(o=this.getCachedConvexTrianglePillar(e,t,n))return this.pillarConvex=o.convex,void(this.pillarOffset=o.offset);i=new s,r=new a,this.pillarConvex=i,this.pillarOffset=r}var o=this.data,l=this.elementSize,c=i.faces;i.vertices.length=6;for(var h=0;h<6;h++)i.vertices[h]||(i.vertices[h]=new a);for(c.length=5,h=0;h<5;h++)c[h]||(c[h]=[]);var u=i.vertices,d=(Math.min(o[e][t],o[e+1][t],o[e][t+1],o[e+1][t+1])-this.minValue)/2+this.minValue;n?(r.set((e+.75)*l,(t+.75)*l,d),u[0].set(.25*l,.25*l,o[e+1][t+1]-d),u[1].set(-.75*l,.25*l,o[e][t+1]-d),u[2].set(.25*l,-.75*l,o[e+1][t]-d),u[3].set(.25*l,.25*l,-d-1),u[4].set(-.75*l,.25*l,-d-1),u[5].set(.25*l,-.75*l,-d-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=2,c[2][1]=5,c[2][2]=3,c[2][3]=0,c[3][0]=3,c[3][1]=4,c[3][2]=1,c[3][3]=0,c[4][0]=1,c[4][1]=4,c[4][2]=5,c[4][3]=2):(r.set((e+.25)*l,(t+.25)*l,d),u[0].set(-.25*l,-.25*l,o[e][t]-d),u[1].set(.75*l,-.25*l,o[e+1][t]-d),u[2].set(-.25*l,.75*l,o[e][t+1]-d),u[3].set(-.25*l,-.25*l,-d-1),u[4].set(.75*l,-.25*l,-d-1),u[5].set(-.25*l,.75*l,-d-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=0,c[2][1]=2,c[2][2]=5,c[2][3]=3,c[3][0]=1,c[3][1]=0,c[3][2]=3,c[3][3]=4,c[4][0]=4,c[4][1]=5,c[4][2]=2,c[4][3]=1),i.computeNormals(),i.computeEdges(),i.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,n,i,r)},o.prototype.calculateLocalInertia=function(e,t){return(t=t||new a).set(0,0,0),t},o.prototype.volume=function(){return Number.MAX_VALUE},o.prototype.calculateWorldAABB=function(e,t,n,i){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},o.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new a(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t,n){t.exports=a;var i=e("./Shape"),s=e("../math/Vec3");function a(){i.call(this),this.type=i.types.PARTICLE}a.prototype=new i,a.prototype.constructor=a,a.prototype.calculateLocalInertia=function(e,t){return(t=t||new s).set(0,0,0),t},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(e,t,n,i){n.copy(e),i.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t,n){t.exports=a;var i=e("./Shape"),s=e("../math/Vec3");function a(){i.call(this),this.type=i.types.PLANE,this.worldNormal=new s,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}a.prototype=new i,a.prototype.constructor=a,a.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(e,t){return t||new s},a.prototype.volume=function(){return Number.MAX_VALUE};var r=new s;a.prototype.calculateWorldAABB=function(e,t,n,i){r.set(0,0,1),t.vmult(r,r);var s=Number.MAX_VALUE;n.set(-s,-s,-s),i.set(s,s,s),1===r.x&&(i.x=e.x),1===r.y&&(i.y=e.y),1===r.z&&(i.z=e.z),-1===r.x&&(n.x=e.x),-1===r.y&&(n.y=e.y),-1===r.z&&(n.z=e.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t,n){t.exports=i;var i=e("./Shape");function i(){this.id=i.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t,n){t.exports=a;var i=e("./Shape"),s=e("../math/Vec3");function a(e){if(i.call(this),this.radius=void 0!==e?Number(e):1,this.type=i.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}a.prototype=new i,a.prototype.constructor=a,a.prototype.calculateLocalInertia=function(e,t){t=t||new s;var n=2*e*this.radius*this.radius/5;return t.x=n,t.y=n,t.z=n,t},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(e,t,n,i){for(var s=this.radius,a=["x","y","z"],r=0;r<a.length;r++){var o=a[r];n[o]=e[o]-s,i[o]=e[o]+s}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t,n){t.exports=l;var i=e("./Shape"),s=e("../math/Vec3");e("../math/Quaternion");var a=e("../math/Transform"),r=e("../collision/AABB"),o=e("../utils/Octree");function l(e,t){i.call(this),this.type=i.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new r,this.edges=null,this.scale=new s(1,1,1),this.tree=new o,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}l.prototype=new i,l.prototype.constructor=l;var c=new s;l.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var n=new r,i=new s,a=new s,o=new s,l=[i,a,o],c=0;c<this.indices.length/3;c++){var h=3*c;this._getUnscaledVertex(this.indices[h],i),this._getUnscaledVertex(this.indices[h+1],a),this._getUnscaledVertex(this.indices[h+2],o),n.setFromPoints(l),e.insert(n,c)}e.removeEmptyNodes()};var h=new r;l.prototype.getTrianglesInAABB=function(e,t){h.copy(e);var n=this.scale,i=n.x,s=n.y,a=n.z,r=h.lowerBound,o=h.upperBound;return r.x/=i,r.y/=s,r.z/=a,o.x/=i,o.y/=s,o.z/=a,this.tree.aabbQuery(h,t)},l.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,n=e.x===e.y===e.z;t&&n||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},l.prototype.updateNormals=function(){for(var e=c,t=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,s=this.indices[i],a=this.indices[i+1],r=this.indices[i+2];this.getVertex(s,f),this.getVertex(a,g),this.getVertex(r,v),l.computeNormal(g,f,v,e),t[i]=e.x,t[i+1]=e.y,t[i+2]=e.z}},l.prototype.updateEdges=function(){for(var e={},t=function(t,n){e[s<a?s+"_"+a:a+"_"+s]=!0},n=0;n<this.indices.length/3;n++){var i=3*n,s=this.indices[i],a=this.indices[i+1];this.indices[i+2],t(),t(),t()}var r=Object.keys(e);for(this.edges=new Int16Array(2*r.length),n=0;n<r.length;n++){var o=r[n].split("_");this.edges[2*n]=parseInt(o[0],10),this.edges[2*n+1]=parseInt(o[1],10)}},l.prototype.getEdgeVertex=function(e,t,n){var i=this.edges[2*e+(t?1:0)];this.getVertex(i,n)};var u=new s,d=new s;l.prototype.getEdgeVector=function(e,t){var n=u,i=d;this.getEdgeVertex(e,0,n),this.getEdgeVertex(e,1,i),i.vsub(n,t)};var p=new s,m=new s;l.computeNormal=function(e,t,n,i){t.vsub(e,m),n.vsub(t,p),p.cross(m,i),i.isZero()||i.normalize()};var f=new s,g=new s,v=new s;l.prototype.getVertex=function(e,t){var n=this.scale;return this._getUnscaledVertex(e,t),t.x*=n.x,t.y*=n.y,t.z*=n.z,t},l.prototype._getUnscaledVertex=function(e,t){var n=3*e,i=this.vertices;return t.set(i[n],i[n+1],i[n+2])},l.prototype.getWorldVertex=function(e,t,n,i){return this.getVertex(e,i),a.pointToWorldFrame(t,n,i,i),i},l.prototype.getTriangleVertices=function(e,t,n,i){var s=3*e;this.getVertex(this.indices[s],t),this.getVertex(this.indices[s+1],n),this.getVertex(this.indices[s+2],i)},l.prototype.getNormal=function(e,t){var n=3*e;return t.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var x=new r;l.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(x);var n=x.upperBound.x-x.lowerBound.x,i=x.upperBound.y-x.lowerBound.y,s=x.upperBound.z-x.lowerBound.z;return t.set(1/12*e*(2*i*2*i+2*s*2*s),1/12*e*(2*n*2*n+2*s*2*s),1/12*e*(2*i*2*i+2*n*2*n))};var y=new s;l.prototype.computeLocalAABB=function(e){var t=e.lowerBound,n=e.upperBound,i=this.vertices.length;this.vertices;var s=y;this.getVertex(0,s),t.copy(s),n.copy(s);for(var a=0;a!==i;a++)this.getVertex(a,s),s.x<t.x?t.x=s.x:s.x>n.x&&(n.x=s.x),s.y<t.y?t.y=s.y:s.y>n.y&&(n.y=s.y),s.z<t.z?t.z=s.z:s.z>n.z&&(n.z=s.z)},l.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},l.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=new s,i=0,a=t.length/3;i!==a;i++){this.getVertex(i,n);var r=n.norm2();r>e&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)},new s;var b=new a,_=new r;l.prototype.calculateWorldAABB=function(e,t,n,i){var s=b,a=_;s.position=e,s.quaternion=t,this.aabb.toWorldFrame(s,a),n.copy(a.lowerBound),i.copy(a.upperBound)},l.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},l.createTorus=function(e,t,n,i,s){e=e||1,t=t||.5,n=n||8,i=i||6,s=s||2*Math.PI;for(var a=[],r=[],o=0;o<=n;o++)for(var c=0;c<=i;c++){var h=c/i*s,u=o/n*Math.PI*2,d=(e+t*Math.cos(u))*Math.cos(h),p=(e+t*Math.cos(u))*Math.sin(h),m=t*Math.sin(u);a.push(d,p,m)}for(o=1;o<=n;o++)for(c=1;c<=i;c++){var f=(i+1)*o+c-1,g=(i+1)*(o-1)+c-1,v=(i+1)*(o-1)+c,x=(i+1)*o+c;r.push(f,g,x),r.push(g,v,x)}return new l(a,r)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t,n){t.exports=s,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver");function s(){i.call(this),this.iterations=10,this.tolerance=1e-7}s.prototype=new i;var a=[],r=[],o=[];s.prototype.solve=function(e,t){var n,i,s,l,c,h=0,u=this.iterations,d=this.tolerance*this.tolerance,p=this.equations,m=p.length,f=t.bodies,g=f.length,v=e;if(0!==m)for(var x=0;x!==g;x++)f[x].updateSolveMassProperties();var y=r,b=o,_=a;for(y.length=m,b.length=m,_.length=m,x=0;x!==m;x++){var w=p[x];_[x]=0,b[x]=w.computeB(v),y[x]=1/w.computeC()}if(0!==m){for(x=0;x!==g;x++){var S=(E=f[x]).vlambda,M=E.wlambda;S.set(0,0,0),M&&M.set(0,0,0)}for(h=0;h!==u;h++){l=0;for(var T=0;T!==m;T++)w=p[T],n=b[T],i=y[T],(c=_[T])+(s=i*(n-w.computeGWlambda()-w.eps*c))<w.minForce?s=w.minForce-c:c+s>w.maxForce&&(s=w.maxForce-c),_[T]+=s,l+=s>0?s:-s,w.addToWlambda(s);if(l*l<d)break}for(x=0;x!==g;x++){var E,C=(E=f[x]).velocity,N=E.angularVelocity;C.vadd(E.vlambda,C),N&&N.vadd(E.wlambda,N)}}return h}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t,n){function i(){this.equations=[]}t.exports=i,i.prototype.solve=function(e,t){return 0},i.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},i.prototype.removeEquation=function(e){var t=this.equations,n=t.indexOf(e);-1!==n&&t.splice(n,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t,n){t.exports=a,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver"),s=e("../objects/Body");function a(e){for(i.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new i;var r=[],o=[],l={bodies:[]},c=s.STATIC;function h(e){for(var t=e.length,n=0;n!==t;n++){var i=e[n];if(!(i.visited||i.body.type&c))return i}return!1}var u=[];function d(e,t,n,i){for(u.push(e),e.visited=!0,t(e,n,i);u.length;)for(var s,a=u.pop();s=h(a.children);)s.visited=!0,t(s,n,i),u.push(s)}function p(e,t,n){t.push(e.body);for(var i=e.eqs.length,s=0;s!==i;s++){var a=e.eqs[s];-1===n.indexOf(a)&&n.push(a)}}function m(e,t){return t.id-e.id}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(e,t){for(var n=r,i=this.nodePool,s=t.bodies,a=this.equations,c=a.length,u=s.length,f=this.subsolver;i.length<u;)i.push(this.createNode());n.length=u;for(var g=0;g<u;g++)n[g]=i[g];for(g=0;g!==u;g++){var v=n[g];v.body=s[g],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var x=0;x!==c;x++){var y=a[x],b=(g=s.indexOf(y.bi),s.indexOf(y.bj)),_=n[g],w=n[b];_.children.push(w),_.eqs.push(y),w.children.push(_),w.eqs.push(y)}var S,M=0,T=o;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var E=l;S=h(n);){T.length=0,E.bodies.length=0,d(S,p,E.bodies,T);var C=T.length;for(T=T.sort(m),g=0;g!==C;g++)f.addEquation(T[g]);f.solve(e,E),f.removeAllEquations(),M++}return M}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t,n){var i=function(){};t.exports=i,i.prototype={constructor:i,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var i=n[e].indexOf(t);return-1!==i&&n[e].splice(i,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var n=0,i=t.length;n<i;n++)t[n].call(this,e)}return this}}},{}],50:[function(e,t,n){var i=e("../collision/AABB"),s=e("../math/Vec3");function a(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new i,this.data=[],this.children=[]}function r(e,t){(t=t||{}).root=null,t.aabb=e,a.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}t.exports=r,r.prototype=new a,a.prototype.reset=function(e,t){this.children.length=this.data.length=0},a.prototype.insert=function(e,t,n){var i=this.data;if(n=n||0,!this.aabb.contains(e))return!1;var s=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var a=!1;s.length||(this.subdivide(),a=!0);for(var r=0;8!==r;r++)if(s[r].insert(e,t,n+1))return!0;a&&(s.length=0)}return i.push(t),!0};var o=new s;a.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,n=e.upperBound,r=this.children;r.push(new a({aabb:new i({lowerBound:new s(0,0,0)})}),new a({aabb:new i({lowerBound:new s(1,0,0)})}),new a({aabb:new i({lowerBound:new s(1,1,0)})}),new a({aabb:new i({lowerBound:new s(1,1,1)})}),new a({aabb:new i({lowerBound:new s(0,1,1)})}),new a({aabb:new i({lowerBound:new s(0,0,1)})}),new a({aabb:new i({lowerBound:new s(1,0,1)})}),new a({aabb:new i({lowerBound:new s(0,1,0)})})),n.vsub(t,o),o.scale(.5,o);for(var l=this.root||this,c=0;8!==c;c++){var h=r[c];h.root=l;var u=h.aabb.lowerBound;u.x*=o.x,u.y*=o.y,u.z*=o.z,u.vadd(t,u),u.vadd(o,h.aabb.upperBound)}},a.prototype.aabbQuery=function(e,t){this.data,this.children;for(var n=[this];n.length;){var i=n.pop();i.aabb.overlaps(e)&&Array.prototype.push.apply(t,i.data),Array.prototype.push.apply(n,i.children)}return t};var l=new i;a.prototype.rayQuery=function(e,t,n){return e.getAABB(l),l.toLocalFrame(t,l),this.aabbQuery(l,n),n},a.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),n=t.children.length-1;n>=0;n--)t.children[n].data.length||t.children.splice(n,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t,n){function i(){this.objects=[],this.type=Object}t.exports=i,i.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t])},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t,n){function i(){this.data={keys:[]}}t.exports=i,i.prototype.get=function(e,t){if(e>t){var n=t;t=e,e=n}return this.data[e+"-"+t]},i.prototype.set=function(e,t,n){if(e>t){var i=t;t=e,e=i}var s=e+"-"+t;this.get(e,t)||this.data.keys.push(s),this.data[s]=n},i.prototype.reset=function(){for(var e=this.data,t=e.keys;t.length>0;)delete e[t.pop()]}},{}],53:[function(e,t,n){function i(){}t.exports=i,i.defaults=function(e,t){for(var n in e=e||{},t)n in e||(e[n]=t[n]);return e}},{}],54:[function(e,t,n){t.exports=a;var i=e("../math/Vec3"),s=e("./Pool");function a(){s.call(this),this.type=i}a.prototype=new s,a.prototype.constructObject=function(){return new i}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t,n){t.exports=d;var i=e("../collision/AABB"),s=e("../shapes/Shape"),a=e("../collision/Ray"),r=e("../math/Vec3"),o=e("../math/Transform");e("../shapes/ConvexPolyhedron");var l=e("../math/Quaternion");e("../solver/Solver");var c=e("../utils/Vec3Pool"),h=e("../equations/ContactEquation"),u=e("../equations/FrictionEquation");function d(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}d.prototype.createContactEquation=function(e,t,n,i,s,a){var r;this.contactPointPool.length?((r=this.contactPointPool.pop()).bi=e,r.bj=t):r=new h(e,t),r.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&i.collisionResponse;var o=this.currentContactMaterial;r.restitution=o.restitution,r.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var l=n.material||e.material,c=i.material||t.material;return l&&c&&l.restitution>=0&&c.restitution>=0&&(r.restitution=l.restitution*c.restitution),r.si=s||n,r.sj=a||i,r},d.prototype.createFrictionEquationsFromContact=function(e,t){var n=e.bi,i=e.bj,s=e.si,a=e.sj,r=this.world,o=this.currentContactMaterial,l=o.friction,c=s.material||n.material,h=a.material||i.material;if(c&&h&&c.friction>=0&&h.friction>=0&&(l=c.friction*h.friction),l>0){var d=l*r.gravity.length(),p=n.invMass+i.invMass;p>0&&(p=1/p);var m=this.frictionEquationPool,f=m.length?m.pop():new u(n,i,d*p),g=m.length?m.pop():new u(n,i,d*p);return f.bi=g.bi=n,f.bj=g.bj=i,f.minForce=g.minForce=-d*p,f.maxForce=g.maxForce=d*p,f.ri.copy(e.ri),f.rj.copy(e.rj),g.ri.copy(e.ri),g.rj.copy(e.rj),e.ni.tangents(f.t,g.t),f.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,r.dt),g.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,r.dt),f.enabled=g.enabled=e.enabled,t.push(f,g),!0}return!1};var p=new r,m=new r,f=new r;d.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var n=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];p.setZero(),m.setZero(),f.setZero();var s=t.bi;t.bj;for(var a=0;a!==e;a++)(t=this.result[this.result.length-1-a]).bodyA!==s?(p.vadd(t.ni,p),m.vadd(t.ri,m),f.vadd(t.rj,f)):(p.vsub(t.ni,p),m.vadd(t.rj,m),f.vadd(t.ri,f));var r=1/e;m.scale(r,n.ri),f.scale(r,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),p.normalize(),p.tangents(n.t,i.t)}};var g=new r,v=new r,x=new l,y=new l;d.prototype.getContacts=function(e,t,n,i,s,a,r){this.contactPointPool=s,this.frictionEquationPool=r,this.result=i,this.frictionResult=a;for(var o=x,l=y,c=g,h=v,u=0,d=e.length;u!==d;u++){var p=e[u],m=t[u],f=null;p.material&&m.material&&(f=n.getContactMaterial(p.material,m.material)||null);for(var b=0;b<p.shapes.length;b++){p.quaternion.mult(p.shapeOrientations[b],o),p.quaternion.vmult(p.shapeOffsets[b],c),c.vadd(p.position,c);for(var _=p.shapes[b],w=0;w<m.shapes.length;w++){m.quaternion.mult(m.shapeOrientations[w],l),m.quaternion.vmult(m.shapeOffsets[w],h),h.vadd(m.position,h);var S=m.shapes[w];if(!(c.distanceTo(h)>_.boundingSphereRadius+S.boundingSphereRadius)){var M=null;_.material&&S.material&&(M=n.getContactMaterial(_.material,S.material)||null),this.currentContactMaterial=M||f||n.defaultContactMaterial;var T=this[_.type|S.type];T&&(_.type<S.type?T.call(this,_,S,c,h,o,l,p,m,_,S):T.call(this,S,_,h,c,l,o,m,p,_,S))}}}}},d.prototype[s.types.BOX|s.types.BOX]=d.prototype.boxBox=function(e,t,n,i,s,a,r,o){e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,i,s,a,r,o,e,t)},d.prototype[s.types.BOX|s.types.CONVEXPOLYHEDRON]=d.prototype.boxConvex=function(e,t,n,i,s,a,r,o){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,n,i,s,a,r,o,e,t)},d.prototype[s.types.BOX|s.types.PARTICLE]=d.prototype.boxParticle=function(e,t,n,i,s,a,r,o){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,n,i,s,a,r,o,e,t)},d.prototype[s.types.SPHERE]=d.prototype.sphereSphere=function(e,t,n,i,s,a,r,o){var l=this.createContactEquation(r,o,e,t);i.vsub(n,l.ni),l.ni.normalize(),l.ri.copy(l.ni),l.rj.copy(l.ni),l.ri.mult(e.radius,l.ri),l.rj.mult(-t.radius,l.rj),l.ri.vadd(n,l.ri),l.ri.vsub(r.position,l.ri),l.rj.vadd(i,l.rj),l.rj.vsub(o.position,l.rj),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)};var b=new r,_=new r,w=new r;d.prototype[s.types.PLANE|s.types.TRIMESH]=d.prototype.planeTrimesh=function(e,t,n,i,s,a,l,c){var h=new r,u=b;u.set(0,0,1),s.vmult(u,u);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,h);var p=new r;p.copy(h),o.pointToWorldFrame(i,a,p,h);var m=_;if(h.vsub(n,m),u.dot(m)<=0){var f=this.createContactEquation(l,c,e,t);f.ni.copy(u);var g=w;u.scale(m.dot(u),g),h.vsub(g,g),f.ri.copy(g),f.ri.vsub(l.position,f.ri),f.rj.copy(h),f.rj.vsub(c.position,f.rj),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}}};var S=new r,M=new r;new r;var T=new r,E=new r,C=new r,N=new r,A=new r,R=new r,j=new r,P=new r,I=new r,D=new r,k=new r,L=new i,O=[];d.prototype[s.types.SPHERE|s.types.TRIMESH]=d.prototype.sphereTrimesh=function(e,t,n,i,s,r,l,c){var h=C,u=N,d=A,p=R,m=j,f=P,g=L,v=E,x=M,y=O;o.pointToLocalFrame(i,r,n,m);var b=e.radius;g.lowerBound.set(m.x-b,m.y-b,m.z-b),g.upperBound.set(m.x+b,m.y+b,m.z+b),t.getTrianglesInAABB(g,y);for(var _=T,w=e.radius*e.radius,U=0;U<y.length;U++)for(var F=0;F<3;F++)t.getVertex(t.indices[3*y[U]+F],_),_.vsub(m,x),x.norm2()<=w&&(v.copy(_),o.pointToWorldFrame(i,r,v,_),_.vsub(n,x),(V=this.createContactEquation(l,c,e,t)).ni.copy(x),V.ni.normalize(),V.ri.copy(V.ni),V.ri.scale(e.radius,V.ri),V.ri.vadd(n,V.ri),V.ri.vsub(l.position,V.ri),V.rj.copy(_),V.rj.vsub(c.position,V.rj),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult));for(U=0;U<y.length;U++)for(F=0;F<3;F++){t.getVertex(t.indices[3*y[U]+F],h),t.getVertex(t.indices[3*y[U]+(F+1)%3],u),u.vsub(h,d),m.vsub(u,f);var z=f.dot(d);m.vsub(h,f);var B=f.dot(d);if(B>0&&z<0&&(m.vsub(h,f),p.copy(d),p.normalize(),B=f.dot(p),p.scale(B,f),f.vadd(h,f),(X=f.distanceTo(m))<e.radius)){var V=this.createContactEquation(l,c,e,t);f.vsub(m,V.ni),V.ni.normalize(),V.ni.scale(e.radius,V.ri),o.pointToWorldFrame(i,r,f,f),f.vsub(c.position,V.rj),o.vectorToWorldFrame(r,V.ni,V.ni),o.vectorToWorldFrame(r,V.ri,V.ri),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult)}}for(var H=I,W=D,G=k,q=S,$=(U=0,y.length);U!==$;U++){t.getTriangleVertices(y[U],H,W,G),t.getNormal(y[U],q),m.vsub(H,f);var X=f.dot(q);q.scale(X,f),m.vsub(f,f),X=f.distanceTo(m),a.pointInTriangle(f,H,W,G)&&X<e.radius&&(V=this.createContactEquation(l,c,e,t),f.vsub(m,V.ni),V.ni.normalize(),V.ni.scale(e.radius,V.ri),o.pointToWorldFrame(i,r,f,f),f.vsub(c.position,V.rj),o.vectorToWorldFrame(r,V.ni,V.ni),o.vectorToWorldFrame(r,V.ri,V.ri),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult))}y.length=0};var U=new r,F=new r;d.prototype[s.types.SPHERE|s.types.PLANE]=d.prototype.spherePlane=function(e,t,n,i,s,a,r,o){var l=this.createContactEquation(r,o,e,t);if(l.ni.set(0,0,1),a.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(e.radius,l.ri),n.vsub(i,U),l.ni.mult(l.ni.dot(U),F),U.vsub(F,l.rj),-U.dot(l.ni)<=e.radius){var c=l.ri,h=l.rj;c.vadd(n,c),c.vsub(r.position,c),h.vadd(i,h),h.vsub(o.position,h),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var z=new r,B=new r,V=new r;function H(e,t,n){for(var i=null,s=e.length,a=0;a!==s;a++){var r=e[a],o=z;e[(a+1)%s].vsub(r,o);var l=B;o.cross(t,l);var c=V;n.vsub(r,c);var h=l.dot(c);if(!(null===i||h>0&&!0===i||h<=0&&!1===i))return!1;null===i&&(i=h>0)}return!0}var W=new r,G=new r,q=new r,$=new r,X=[new r,new r,new r,new r,new r,new r],Y=new r,K=new r,Z=new r,J=new r;d.prototype[s.types.SPHERE|s.types.BOX]=d.prototype.sphereBox=function(e,t,n,i,s,a,r,o){var l=this.v3pool,c=X;n.vsub(i,W),t.getSideNormals(c,a);for(var h=e.radius,u=!1,d=K,p=Z,m=J,f=null,g=0,v=0,x=0,y=null,b=0,_=c.length;b!==_&&!1===u;b++){var w=G;w.copy(c[b]);var S=w.norm();w.normalize();var M=W.dot(w);if(M<S+h&&M>0){var T=q,E=$;T.copy(c[(b+1)%3]),E.copy(c[(b+2)%3]);var C=T.norm(),N=E.norm();T.normalize(),E.normalize();var A=W.dot(T),R=W.dot(E);if(A<C&&A>-C&&R<N&&R>-N){var j=Math.abs(M-S-h);(null===y||j<y)&&(y=j,v=A,x=R,f=S,d.copy(w),p.copy(T),m.copy(E),g++)}}}if(g){u=!0;var P=this.createContactEquation(r,o,e,t);d.mult(-h,P.ri),P.ni.copy(d),P.ni.negate(P.ni),d.mult(f,d),p.mult(v,p),d.vadd(p,d),m.mult(x,m),d.vadd(m,P.rj),P.ri.vadd(n,P.ri),P.ri.vsub(r.position,P.ri),P.rj.vadd(i,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}for(var I=l.get(),D=Y,k=0;2!==k&&!u;k++)for(var L=0;2!==L&&!u;L++)for(var O=0;2!==O&&!u;O++)I.set(0,0,0),k?I.vadd(c[0],I):I.vsub(c[0],I),L?I.vadd(c[1],I):I.vsub(c[1],I),O?I.vadd(c[2],I):I.vsub(c[2],I),i.vadd(I,D),D.vsub(n,D),D.norm2()<h*h&&(u=!0,(P=this.createContactEquation(r,o,e,t)).ri.copy(D),P.ri.normalize(),P.ni.copy(P.ri),P.ri.mult(h,P.ri),P.rj.copy(I),P.ri.vadd(n,P.ri),P.ri.vsub(r.position,P.ri),P.rj.vadd(i,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult));l.release(I),I=null;var U=l.get(),F=l.get(),z=(P=l.get(),l.get()),B=(j=l.get(),c.length);for(k=0;k!==B&&!u;k++)for(L=0;L!==B&&!u;L++)if(k%3!=L%3){c[L].cross(c[k],U),U.normalize(),c[k].vadd(c[L],F),P.copy(n),P.vsub(F,P),P.vsub(i,P);var V=P.dot(U);for(U.mult(V,z),O=0;O===k%3||O===L%3;)O++;j.copy(n),j.vsub(z,j),j.vsub(F,j),j.vsub(i,j);var H=Math.abs(V),Q=j.norm();if(H<c[O].norm()&&Q<h){u=!0;var ee=this.createContactEquation(r,o,e,t);F.vadd(z,ee.rj),ee.rj.copy(ee.rj),j.negate(ee.ni),ee.ni.normalize(),ee.ri.copy(ee.rj),ee.ri.vadd(i,ee.ri),ee.ri.vsub(n,ee.ri),ee.ri.normalize(),ee.ri.mult(h,ee.ri),ee.ri.vadd(n,ee.ri),ee.ri.vsub(r.position,ee.ri),ee.rj.vadd(i,ee.rj),ee.rj.vsub(o.position,ee.rj),this.result.push(ee),this.createFrictionEquationsFromContact(ee,this.frictionResult)}}l.release(U,F,P,z,j)};var Q=new r,ee=new r,te=new r,ne=new r,ie=new r,se=new r,ae=new r,re=new r,oe=new r,le=new r;d.prototype[s.types.SPHERE|s.types.CONVEXPOLYHEDRON]=d.prototype.sphereConvex=function(e,t,n,i,s,a,r,o){var l=this.v3pool;n.vsub(i,Q);for(var c=t.faceNormals,h=t.faces,u=t.vertices,d=e.radius,p=0;p!==u.length;p++){var m=u[p],f=ie;a.vmult(m,f),i.vadd(f,f);var g=ne;if(f.vsub(n,g),g.norm2()<d*d)return v=!0,(j=this.createContactEquation(r,o,e,t)).ri.copy(g),j.ri.normalize(),j.ni.copy(j.ri),j.ri.mult(d,j.ri),f.vsub(i,j.rj),j.ri.vadd(n,j.ri),j.ri.vsub(r.position,j.ri),j.rj.vadd(i,j.rj),j.rj.vsub(o.position,j.rj),this.result.push(j),void this.createFrictionEquationsFromContact(j,this.frictionResult)}for(var v=!1,x=(p=0,h.length);p!==x&&!1===v;p++){var y=c[p],b=h[p],_=se;a.vmult(y,_);var w=ae;a.vmult(u[b[0]],w),w.vadd(i,w);var S=re;_.mult(-d,S),n.vadd(S,S);var M=oe;S.vsub(w,M);var T=M.dot(_),E=le;if(n.vsub(w,E),T<0&&E.dot(_)>0){for(var C=[],N=0,A=b.length;N!==A;N++){var R=l.get();a.vmult(u[b[N]],R),i.vadd(R,R),C.push(R)}if(H(C,_,n)){v=!0;var j=this.createContactEquation(r,o,e,t);_.mult(-d,j.ri),_.negate(j.ni);var P=l.get();_.mult(-T,P);var I=l.get();_.mult(-d,I),n.vsub(i,j.rj),j.rj.vadd(I,j.rj),j.rj.vadd(P,j.rj),j.rj.vadd(i,j.rj),j.rj.vsub(o.position,j.rj),j.ri.vadd(n,j.ri),j.ri.vsub(r.position,j.ri),l.release(P),l.release(I),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult),N=0;for(var D=C.length;N!==D;N++)l.release(C[N]);return}for(N=0;N!==b.length;N++){var k=l.get(),L=l.get();a.vmult(u[b[(N+1)%b.length]],k),a.vmult(u[b[(N+2)%b.length]],L),i.vadd(k,k),i.vadd(L,L);var O=ee;L.vsub(k,O);var U=te;O.unit(U);var F=l.get(),z=l.get();n.vsub(k,z);var B=z.dot(U);U.mult(B,F),F.vadd(k,F);var V=l.get();if(F.vsub(n,V),B>0&&B*B<O.norm2()&&V.norm2()<d*d){for(j=this.createContactEquation(r,o,e,t),F.vsub(i,j.rj),F.vsub(n,j.ni),j.ni.normalize(),j.ni.mult(d,j.ri),j.rj.vadd(i,j.rj),j.rj.vsub(o.position,j.rj),j.ri.vadd(n,j.ri),j.ri.vsub(r.position,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult),N=0,D=C.length;N!==D;N++)l.release(C[N]);return l.release(k),l.release(L),l.release(F),l.release(V),void l.release(z)}l.release(k),l.release(L),l.release(F),l.release(V),l.release(z)}for(N=0,D=C.length;N!==D;N++)l.release(C[N])}}},new r,new r,d.prototype[s.types.PLANE|s.types.BOX]=d.prototype.planeBox=function(e,t,n,i,s,a,r,o){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.planeConvex(e,t.convexPolyhedronRepresentation,n,i,s,a,r,o)};var ce=new r,he=new r,ue=new r,de=new r;d.prototype[s.types.PLANE|s.types.CONVEXPOLYHEDRON]=d.prototype.planeConvex=function(e,t,n,i,s,a,r,o){var l=ce,c=he;c.set(0,0,1),s.vmult(c,c);for(var h=0,u=ue,d=0;d!==t.vertices.length;d++)if(l.copy(t.vertices[d]),a.vmult(l,l),i.vadd(l,l),l.vsub(n,u),c.dot(u)<=0){var p=this.createContactEquation(r,o,e,t),m=de;c.mult(c.dot(u),m),l.vsub(m,m),m.vsub(n,p.ri),p.ni.copy(c),l.vsub(i,p.rj),p.ri.vadd(n,p.ri),p.ri.vsub(r.position,p.ri),p.rj.vadd(i,p.rj),p.rj.vsub(o.position,p.rj),this.result.push(p),h++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(p,this.frictionResult)}this.enableFrictionReduction&&h&&this.createFrictionFromAverage(h)};var pe=new r,me=new r;d.prototype[s.types.CONVEXPOLYHEDRON]=d.prototype.convexConvex=function(e,t,n,i,s,a,r,o,l,c,h,u){var d=pe;if(!(n.distanceTo(i)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,n,s,i,a,d,h,u)){var p=[],m=me;e.clipAgainstHull(n,s,t,i,a,d,-100,100,p);for(var f=0,g=0;g!==p.length;g++){var v=this.createContactEquation(r,o,e,t,l,c),x=v.ri,y=v.rj;d.negate(v.ni),p[g].normal.negate(m),m.mult(p[g].depth,m),p[g].point.vadd(m,x),y.copy(p[g].point),x.vsub(n,x),y.vsub(i,y),x.vadd(n,x),x.vsub(r.position,x),y.vadd(i,y),y.vsub(o.position,y),this.result.push(v),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var fe=new r,ge=new r,ve=new r;d.prototype[s.types.PLANE|s.types.PARTICLE]=d.prototype.planeParticle=function(e,t,n,i,s,a,r,o){var l=fe;l.set(0,0,1),r.quaternion.vmult(l,l);var c=ge;if(i.vsub(r.position,c),l.dot(c)<=0){var h=this.createContactEquation(o,r,t,e);h.ni.copy(l),h.ni.negate(h.ni),h.ri.set(0,0,0);var u=ve;l.mult(l.dot(i),u),i.vsub(u,u),h.rj.copy(u),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var xe=new r;d.prototype[s.types.PARTICLE|s.types.SPHERE]=d.prototype.sphereParticle=function(e,t,n,i,s,a,r,o){var l=xe;if(l.set(0,0,1),i.vsub(n,l),l.norm2()<=e.radius*e.radius){var c=this.createContactEquation(o,r,t,e);l.normalize(),c.rj.copy(l),c.rj.mult(e.radius,c.rj),c.ni.copy(l),c.ni.negate(c.ni),c.ri.set(0,0,0),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var ye=new l,be=new r;new r;var _e=new r,we=new r,Se=new r;d.prototype[s.types.PARTICLE|s.types.CONVEXPOLYHEDRON]=d.prototype.convexParticle=function(e,t,n,i,s,a,r,o){var l=-1,c=_e,h=Se,u=null,d=be;if(d.copy(i),d.vsub(n,d),s.conjugate(ye),ye.vmult(d,d),e.pointIsInside(d)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,s),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(s);for(var p=0,m=e.faces.length;p!==m;p++){var f=[e.worldVertices[e.faces[p][0]]],g=e.worldFaceNormals[p];i.vsub(f[0],we);var v=-g.dot(we);(null===u||Math.abs(v)<Math.abs(u))&&(u=v,l=p,c.copy(g))}if(-1!==l){var x=this.createContactEquation(o,r,t,e);c.mult(u,h),h.vadd(i,h),h.vsub(n,h),x.rj.copy(h),c.negate(x.ni),x.ri.set(0,0,0);var y=x.ri,b=x.rj;y.vadd(i,y),y.vsub(o.position,y),b.vadd(n,b),b.vsub(r.position,b),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}}},d.prototype[s.types.BOX|s.types.HEIGHTFIELD]=d.prototype.boxHeightfield=function(e,t,n,i,s,a,r,o){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,i,s,a,r,o)};var Me=new r,Te=new r,Ee=[0];d.prototype[s.types.CONVEXPOLYHEDRON|s.types.HEIGHTFIELD]=d.prototype.convexHeightfield=function(e,t,n,i,s,a,r,l){var c=t.data,h=t.elementSize,u=e.boundingSphereRadius,d=Te,p=Ee,m=Me;o.pointToLocalFrame(i,a,n,m);var f=Math.floor((m.x-u)/h)-1,g=Math.ceil((m.x+u)/h)+1,v=Math.floor((m.y-u)/h)-1,x=Math.ceil((m.y+u)/h)+1;if(!(g<0||x<0||f>c.length||v>c[0].length)){f<0&&(f=0),g<0&&(g=0),v<0&&(v=0),x<0&&(x=0),f>=c.length&&(f=c.length-1),g>=c.length&&(g=c.length-1),x>=c[0].length&&(x=c[0].length-1),v>=c[0].length&&(v=c[0].length-1);var y=[];t.getRectMinMax(f,v,g,x,y);var b=y[0],_=y[1];if(!(m.z-u>_||m.z+u<b))for(var w=f;w<g;w++)for(var S=v;S<x;S++)t.getConvexTrianglePillar(w,S,!1),o.pointToWorldFrame(i,a,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,n,d,s,a,r,l,null,null,p,null),t.getConvexTrianglePillar(w,S,!0),o.pointToWorldFrame(i,a,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,n,d,s,a,r,l,null,null,p,null)}};var Ce=new r,Ne=new r;d.prototype[s.types.SPHERE|s.types.HEIGHTFIELD]=d.prototype.sphereHeightfield=function(e,t,n,i,s,a,r,l){var c=t.data,h=e.radius,u=t.elementSize,d=Ne,p=Ce;o.pointToLocalFrame(i,a,n,p);var m=Math.floor((p.x-h)/u)-1,f=Math.ceil((p.x+h)/u)+1,g=Math.floor((p.y-h)/u)-1,v=Math.ceil((p.y+h)/u)+1;if(!(f<0||v<0||m>c.length||v>c[0].length)){m<0&&(m=0),f<0&&(f=0),g<0&&(g=0),v<0&&(v=0),m>=c.length&&(m=c.length-1),f>=c.length&&(f=c.length-1),v>=c[0].length&&(v=c[0].length-1),g>=c[0].length&&(g=c[0].length-1);var x=[];t.getRectMinMax(m,g,f,v,x);var y=x[0],b=x[1];if(!(p.z-h>b||p.z+h<y))for(var _=this.result,w=m;w<f;w++)for(var S=g;S<v;S++){var M=_.length;if(t.getConvexTrianglePillar(w,S,!1),o.pointToWorldFrame(i,a,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,n,d,s,a,r,l),t.getConvexTrianglePillar(w,S,!0),o.pointToWorldFrame(i,a,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,n,d,s,a,r,l),_.length-M>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t,n){t.exports=x;var i=e("../shapes/Shape"),s=e("../math/Vec3"),a=e("../math/Quaternion"),r=e("../solver/GSSolver");e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation");var o=e("./Narrowphase"),l=e("../utils/EventTarget"),c=e("../collision/ArrayCollisionMatrix"),h=e("../material/Material"),u=e("../material/ContactMaterial"),d=e("../objects/Body"),p=e("../utils/TupleDictionary"),m=e("../collision/RaycastResult"),f=e("../collision/AABB"),g=e("../collision/Ray"),v=e("../collision/NaiveBroadphase");function x(){l.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new s,this.broadphase=new v,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new c,this.collisionMatrixPrevious=new c,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new p,this.defaultMaterial=new h("default"),this.defaultContactMaterial=new u(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}x.prototype=new l,new f;var y=new g;if(x.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},x.prototype.numObjects=function(){return this.bodies.length},x.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},x.prototype.add=x.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof d&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},x.prototype.addConstraint=function(e){this.constraints.push(e)},x.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},x.prototype.rayTest=function(e,t,n){n instanceof m?this.raycastClosest(e,t,{skipBackfaces:!0},n):this.raycastAll(e,t,{skipBackfaces:!0},n)},x.prototype.raycastAll=function(e,t,n,i){return n.mode=g.ALL,n.from=e,n.to=t,n.callback=i,y.intersectWorld(this,n)},x.prototype.raycastAny=function(e,t,n,i){return n.mode=g.ANY,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},x.prototype.raycastClosest=function(e,t,n,i){return n.mode=g.CLOSEST,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},x.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,n=this.bodies,i=n.indexOf(e);if(-1!==i){n.splice(i,1);for(var s=0;s!==n.length;s++)n[s].index=s;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},x.prototype.removeBody=x.prototype.remove,x.prototype.addMaterial=function(e){this.materials.push(e)},x.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var b=Date.now();performance.timing&&performance.timing.navigationStart&&(b=performance.timing.navigationStart),performance.now=function(){return Date.now()-b}}var _=new s;x.prototype.step=function(e,t,n){if(n=n||10,0===(t=t||0))this.internalStep(e),this.time+=e;else{var i=Math.floor((this.time+t)/e)-Math.floor(this.time/e);i=Math.min(i,n);for(var s=performance.now(),a=0;a!==i&&(this.internalStep(e),!(performance.now()-s>1e3*e));a++);this.time+=t;for(var r=this.time%e/e,o=_,l=this.bodies,c=0;c!==l.length;c++){var h=l[c];h.type!==d.STATIC&&h.sleepState!==d.SLEEPING?(h.position.vsub(h.previousPosition,o),o.scale(r,o),h.position.vadd(o,h.interpolatedPosition)):(h.interpolatedPosition.copy(h.position),h.interpolatedQuaternion.copy(h.quaternion))}}};var w={type:"postStep"},S={type:"preStep"},M={type:"collide",body:null,contact:null},T=[],E=[],C=[],N=[];new s,new s,new s,new s,new s,new s,new s,new s,new s,new a;var A=new a,R=new a,j=new s;x.prototype.internalStep=function(e){this.dt=e;var t,n=this.contacts,s=C,a=N,r=this.numObjects(),o=this.bodies,l=this.solver,c=this.gravity,h=this.doProfiling,u=this.profile,p=d.DYNAMIC,m=this.constraints,f=E;c.norm();var g=c.x,v=c.y,x=c.z,y=0;for(h&&(t=performance.now()),y=0;y!==r;y++)if((z=o[y]).type&p){var b=z.force,_=z.mass;b.x+=_*g,b.y+=_*v,b.z+=_*x}y=0;for(var P=this.subsystems.length;y!==P;y++)this.subsystems[y].update();h&&(t=performance.now()),s.length=0,a.length=0,this.broadphase.collisionPairs(this,s,a),h&&(u.broadphase=performance.now()-t);var I=m.length;for(y=0;y!==I;y++)if(!(V=m[y]).collideConnected)for(var D=s.length-1;D>=0;D-=1)(V.bodyA===s[D]&&V.bodyB===a[D]||V.bodyB===s[D]&&V.bodyA===a[D])&&(s.splice(D,1),a.splice(D,1));this.collisionMatrixTick(),h&&(t=performance.now());var k=T,L=n.length;for(y=0;y!==L;y++)k.push(n[y]);n.length=0;var O=this.frictionEquations.length;for(y=0;y!==O;y++)f.push(this.frictionEquations[y]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(s,a,this,n,k,this.frictionEquations,f),h&&(u.narrowphase=performance.now()-t),h&&(t=performance.now()),y=0;y<this.frictionEquations.length;y++)l.addEquation(this.frictionEquations[y]);for(var U=n.length,F=0;F!==U;F++){var z=(V=n[F]).bi,B=V.bj;V.si,V.sj,(z.material&&B.material&&this.getContactMaterial(z.material,B.material)||this.defaultContactMaterial).friction,z.material&&B.material&&(z.material.friction>=0&&B.material.friction>=0&&(z.material.friction,B.material.friction),z.material.restitution>=0&&B.material.restitution>=0&&(V.restitution=z.material.restitution*B.material.restitution)),l.addEquation(V),z.allowSleep&&z.type===d.DYNAMIC&&z.sleepState===d.SLEEPING&&B.sleepState===d.AWAKE&&B.type!==d.STATIC&&B.velocity.norm2()+B.angularVelocity.norm2()>=2*Math.pow(B.sleepSpeedLimit,2)&&(z._wakeUpAfterNarrowphase=!0),B.allowSleep&&B.type===d.DYNAMIC&&B.sleepState===d.SLEEPING&&z.sleepState===d.AWAKE&&z.type!==d.STATIC&&z.velocity.norm2()+z.angularVelocity.norm2()>=2*Math.pow(z.sleepSpeedLimit,2)&&(B._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(z,B,!0),this.collisionMatrixPrevious.get(z,B)||(M.body=B,M.contact=V,z.dispatchEvent(M),M.body=z,B.dispatchEvent(M))}for(h&&(u.makeContactConstraints=performance.now()-t,t=performance.now()),y=0;y!==r;y++)(z=o[y])._wakeUpAfterNarrowphase&&(z.wakeUp(),z._wakeUpAfterNarrowphase=!1);for(I=m.length,y=0;y!==I;y++){var V;(V=m[y]).update(),D=0;for(var H=V.equations.length;D!==H;D++){var W=V.equations[D];l.addEquation(W)}}l.solve(e,this),h&&(u.solve=performance.now()-t),l.removeAllEquations();var G=Math.pow;for(y=0;y!==r;y++)if((z=o[y]).type&p){var q=G(1-z.linearDamping,e),$=z.velocity;$.mult(q,$);var X=z.angularVelocity;if(X){var Y=G(1-z.angularDamping,e);X.mult(Y,X)}}for(this.dispatchEvent(S),y=0;y!==r;y++)(z=o[y]).preStep&&z.preStep.call(z);h&&(t=performance.now());var K=A,Z=R,J=this.stepnumber,Q=d.DYNAMIC|d.KINEMATIC,ee=J%(this.quatNormalizeSkip+1)===0,te=this.quatNormalizeFast,ne=.5*e;for(i.types.PLANE,i.types.CONVEXPOLYHEDRON,y=0;y!==r;y++){var ie=o[y],se=ie.force,ae=ie.torque;if(ie.type&Q&&ie.sleepState!==d.SLEEPING){var re=ie.velocity,oe=ie.angularVelocity,le=ie.position,ce=ie.quaternion,he=ie.invMass,ue=ie.invInertiaWorld;re.x+=se.x*he*e,re.y+=se.y*he*e,re.z+=se.z*he*e,ie.angularVelocity&&(ue.vmult(ae,j),j.mult(e,j),j.vadd(oe,oe)),le.x+=re.x*e,le.y+=re.y*e,le.z+=re.z*e,ie.angularVelocity&&(K.set(oe.x,oe.y,oe.z,0),K.mult(ce,Z),ce.x+=ne*Z.x,ce.y+=ne*Z.y,ce.z+=ne*Z.z,ce.w+=ne*Z.w,ee&&(te?ce.normalizeFast():ce.normalize())),ie.aabb&&(ie.aabbNeedsUpdate=!0),ie.updateInertiaWorld&&ie.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,h&&(u.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(w),y=0;y!==r;y++){var de=(z=o[y]).postStep;de&&de.call(z)}if(this.allowSleep)for(y=0;y!==r;y++)o[y].sleepTick(this.time)},x.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,n=0;n!==t;n++){var i=e[n];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2);const yg=(e,t,n)=>({endTime:t,insertTime:n,type:"exponentialRampToValue",value:e}),bg=(e,t,n)=>({endTime:t,insertTime:n,type:"linearRampToValue",value:e}),_g=(e,t)=>({startTime:t,type:"setValue",value:e}),wg=(e,t,n)=>({duration:n,startTime:t,type:"setValueCurve",values:e}),Sg=(e,t,{startTime:n,target:i,timeConstant:s})=>i+(t-i)*Math.exp((n-e)/s),Mg=e=>"exponentialRampToValue"===e.type,Tg=e=>"linearRampToValue"===e.type,Eg=e=>Mg(e)||Tg(e),Cg=e=>"setValue"===e.type,Ng=e=>"setValueCurve"===e.type,Ag=(e,t,n,i)=>{const s=e[t];return void 0===s?i:Eg(s)||Cg(s)?s.value:Ng(s)?s.values[s.values.length-1]:Sg(n,Ag(e,t-1,s.startTime,i),s)},Rg=(e,t,n,i,s)=>void 0===n?[i.insertTime,s]:Eg(n)?[n.endTime,n.value]:Cg(n)?[n.startTime,n.value]:Ng(n)?[n.startTime+n.duration,n.values[n.values.length-1]]:[n.startTime,Ag(e,t-1,n.startTime,s)],jg=e=>"cancelAndHold"===e.type,Pg=e=>"cancelScheduledValues"===e.type,Ig=e=>jg(e)||Pg(e)?e.cancelTime:Mg(e)||Tg(e)?e.endTime:e.startTime,Dg=(e,t,n,{endTime:i,value:s})=>n===s?s:0<n&&0<s||n<0&&s<0?n*(s/n)**((e-t)/(i-t)):0,kg=(e,t,n,{endTime:i,value:s})=>n+(e-t)/(i-t)*(s-n),Lg=e=>"setTarget"===e.type;class Og{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=Ig(e);if(jg(e)||Pg(e)){const n=this._automationEvents.findIndex(n=>Pg(e)&&Ng(n)?n.startTime+n.duration>=t:Ig(n)>=t),i=this._automationEvents[n];if(-1!==n&&(this._automationEvents=this._automationEvents.slice(0,n)),jg(e)){const e=this._automationEvents[this._automationEvents.length-1];if(void 0!==i&&Eg(i)){if(void 0!==e&&Lg(e))throw new Error("The internal list is malformed.");const n=void 0===e?i.insertTime:Ng(e)?e.startTime+e.duration:Ig(e),s=void 0===e?this._defaultValue:Ng(e)?e.values[e.values.length-1]:e.value,a=Mg(i)?Dg(t,n,s,i):kg(t,n,s,i),r=Mg(i)?yg(a,t,this._currenTime):bg(a,t,this._currenTime);this._automationEvents.push(r)}if(void 0!==e&&Lg(e)&&this._automationEvents.push(_g(this.getValue(t),t)),void 0!==e&&Ng(e)&&e.startTime+e.duration>t){const n=t-e.startTime,i=(e.values.length-1)/e.duration,s=Math.max(2,1+Math.ceil(n*i)),a=n/(s-1)*i,r=e.values.slice(0,s);if(a<1)for(let t=1;t<s;t+=1){const n=a*t%1;r[t]=e.values[t-1]*(1-n)+e.values[t]*n}this._automationEvents[this._automationEvents.length-1]=wg(r,e.startTime,n)}}}else{const n=this._automationEvents.findIndex(e=>Ig(e)>t),i=-1===n?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[n-1];if(void 0!==i&&Ng(i)&&Ig(i)+i.duration>t)return!1;const s=Mg(e)?yg(e.value,e.endTime,this._currenTime):Tg(e)?bg(e.value,t,this._currenTime):e;if(-1===n)this._automationEvents.push(s);else{if(Ng(e)&&t+e.duration>Ig(this._automationEvents[n]))return!1;this._automationEvents.splice(n,0,s)}}return!0}flush(e){const t=this._automationEvents.findIndex(t=>Ig(t)>e);if(t>1){const e=this._automationEvents.slice(t-1),n=e[0];Lg(n)&&e.unshift(_g(Ag(this._automationEvents,t-2,n.startTime,this._defaultValue),n.startTime)),this._automationEvents=e}}getValue(e){if(0===this._automationEvents.length)return this._defaultValue;const t=this._automationEvents.findIndex(t=>Ig(t)>e),n=this._automationEvents[t],i=(-1===t?this._automationEvents.length:t)-1,s=this._automationEvents[i];if(void 0!==s&&Lg(s)&&(void 0===n||!Eg(n)||n.insertTime>e))return Sg(e,Ag(this._automationEvents,i-1,s.startTime,this._defaultValue),s);if(void 0!==s&&Cg(s)&&(void 0===n||!Eg(n)))return s.value;if(void 0!==s&&Ng(s)&&(void 0===n||!Eg(n)||s.startTime+s.duration>e))return e<s.startTime+s.duration?((e,{duration:t,startTime:n,values:i})=>((e,t)=>{const n=Math.floor(t),i=Math.ceil(t);return n===i?e[n]:(1-(t-n))*e[n]+(1-(i-t))*e[i]})(i,(e-n)/t*(i.length-1)))(e,s):s.values[s.values.length-1];if(void 0!==s&&Eg(s)&&(void 0===n||!Eg(n)))return s.value;if(void 0!==n&&Mg(n)){const[t,a]=Rg(this._automationEvents,i,s,n,this._defaultValue);return Dg(e,t,a,n)}if(void 0!==n&&Tg(n)){const[t,a]=Rg(this._automationEvents,i,s,n,this._defaultValue);return kg(e,t,a,n)}return this._defaultValue}}const Ug=new WeakSet,Fg=new WeakMap,zg=new WeakMap,Bg=new WeakMap,Vg=new WeakMap,Hg=new WeakMap,Wg=new WeakMap,Gg=new WeakMap,qg=new WeakMap,$g=new WeakMap,Xg={construct:()=>Xg},Yg=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,Kg=(e,t)=>{const n=[];let i=e.replace(/^[\s]+/,""),s=i.match(Yg);for(;null!==s;){const e=s[1].slice(1,-1),a=s[0].replace(/([\s]+)?;?$/,"").replace(e,new URL(e,t).toString());n.push(a),i=i.slice(s[0].length).replace(/^[\s]+/,""),s=i.match(Yg)}return[n.join(";"),i]},Zg=e=>{if(void 0!==e&&!Array.isArray(e))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Jg=e=>{if(!(e=>{try{new new Proxy(e,Xg)}catch{return!1}return!0})(e))throw new TypeError("The given value for processorCtor should be a constructor.");if(null===e.prototype||"object"!=typeof e.prototype)throw new TypeError("The given value for processorCtor should have a prototype.")},Qg=(e,t)=>{const n=e.get(t);if(void 0===n)throw new Error("A value with the given key could not be found.");return n},ev=(e,t)=>{const n=Array.from(e).filter(t);if(n.length>1)throw Error("More than one element was found.");if(0===n.length)throw Error("No element was found.");const[i]=n;return e.delete(i),i},tv=(e,t,n,i)=>{const s=Qg(e,t),a=ev(s,e=>e[0]===n&&e[1]===i);return 0===s.size&&e.delete(t),a},nv=e=>Qg(Wg,e),iv=e=>{if(Ug.has(e))throw new Error("The AudioNode is already stored.");Ug.add(e),nv(e).forEach(e=>e(!0))},sv=e=>"port"in e,av=e=>{if(!Ug.has(e))throw new Error("The AudioNode is not stored.");Ug.delete(e),nv(e).forEach(e=>e(!1))},rv=(e,t)=>{!sv(e)&&t.every(e=>0===e.size)&&av(e)},ov={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},lv=(e,t)=>e.context===t,cv=e=>{try{e.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},hv=()=>new DOMException("","IndexSizeError"),uv=e=>{var t;e.getChannelData=(t=e.getChannelData,n=>{try{return t.call(e,n)}catch(i){if(12===i.code)throw hv();throw i}})},dv={numberOfChannels:1},pv=-34028234663852886e22,mv=-pv,fv=e=>Ug.has(e),gv={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},vv=e=>Qg(Fg,e),xv=e=>Qg(Bg,e),yv=(e,t)=>{const{activeInputs:n}=vv(e);n.forEach(n=>n.forEach(([n])=>{t.includes(e)||yv(n,[...t,e])}));const i=(e=>"playbackRate"in e)(e)?[e.playbackRate]:sv(e)?Array.from(e.parameters.values()):(e=>"frequency"in e&&"gain"in e)(e)?[e.Q,e.detune,e.frequency,e.gain]:(e=>"offset"in e)(e)?[e.offset]:(e=>!("frequency"in e)&&"gain"in e)(e)?[e.gain]:(e=>"detune"in e&&"frequency"in e&&!("gain"in e))(e)?[e.detune,e.frequency]:(e=>"pan"in e)(e)?[e.pan]:[];for(const s of i){const e=xv(s);void 0!==e&&e.activeInputs.forEach(([e])=>yv(e,t))}fv(e)&&av(e)},bv=e=>{yv(e.destination,[])},_v=e=>"context"in e,wv=e=>_v(e[0]),Sv=(e,t,n,i)=>{for(const s of e)if(n(s)){if(i)return!1;throw Error("The set contains at least one similar element.")}return e.add(t),!0},Mv=(e,t,[n,i],s)=>{Sv(e,[t,n,i],e=>e[0]===t&&e[1]===n,s)},Tv=(e,[t,n,i],s)=>{const a=e.get(t);void 0===a?e.set(t,new Set([[n,i]])):Sv(a,[n,i],e=>e[0]===n,s)},Ev=e=>"inputs"in e,Cv=(e,t,n,i)=>{if(Ev(t)){const s=t.inputs[i];return e.connect(s,n,0),[s,n,0]}return e.connect(t,n,i),[t,n,i]},Nv=(e,t,n)=>{for(const i of e)if(i[0]===t&&i[1]===n)return e.delete(i),i;return null},Av=(e,t)=>{if(!nv(e).delete(t))throw new Error("Missing the expected event listener.")},Rv=(e,t,n)=>{const i=Qg(e,t),s=ev(i,e=>e[0]===n);return 0===i.size&&e.delete(t),s},jv=(e,t,n,i)=>{Ev(t)?e.disconnect(t.inputs[i],n,0):e.disconnect(t,n,i)},Pv=e=>Qg(zg,e),Iv=e=>Qg(Vg,e),Dv=e=>Gg.has(e),kv=e=>!Ug.has(e),Lv=(e,t)=>new Promise(n=>{if(null!==t)n(!0);else{const t=e.createScriptProcessor(256,1,1),i=e.createGain(),s=e.createBuffer(1,2,44100),a=s.getChannelData(0);a[0]=1,a[1]=1;const r=e.createBufferSource();r.buffer=s,r.loop=!0,r.connect(t).connect(e.destination),r.connect(i),r.disconnect(i),t.onaudioprocess=i=>{const s=i.inputBuffer.getChannelData(0);Array.prototype.some.call(s,e=>1===e)?n(!0):n(!1),r.stop(),t.onaudioprocess=null,r.disconnect(t),t.disconnect(e.destination)},r.start()}}),Ov=(e,t)=>{const n=new Map;for(const i of e)for(const e of i){const t=n.get(e);n.set(e,void 0===t?1:t+1)}n.forEach((e,n)=>t(n,e))},Uv=e=>"context"in e,Fv=(e,t,n,i,s)=>{const[a,r]=((e,t,n,i)=>{const{activeInputs:s,passiveInputs:a}=vv(t),r=Nv(s[i],e,n);return null===r?[tv(a,e,n,i)[2],!1]:[r[2],!0]})(e,n,i,s);if(null!==a&&(Av(e,a),!r||t||Dv(e)||jv(Pv(e),Pv(n),i,s)),fv(n)){const{activeInputs:e}=vv(n);rv(n,e)}},zv=(e,t,n,i)=>{const[s,a]=((e,t,n)=>{const{activeInputs:i,passiveInputs:s}=xv(t),a=Nv(i,e,n);return null===a?[Rv(s,e,n)[1],!1]:[a[2],!0]})(e,n,i);null!==s&&(Av(e,s),!a||t||Dv(e)||Pv(e).disconnect(Iv(n),i))};class Bv{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((n,i)=>e.call(t,n,i,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const Vv={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function Hv(e,t,n,i,s){if("function"==typeof e.copyFromChannel)0===t[n].byteLength&&(t[n]=new Float32Array(128)),e.copyFromChannel(t[n],i,s);else{const a=e.getChannelData(i);if(0===t[n].byteLength)t[n]=a.slice(s,s+128);else{const e=new Float32Array(a.buffer,s*Float32Array.BYTES_PER_ELEMENT,128);t[n].set(e)}}}const Wv=(e,t,n,i,s)=>{"function"==typeof e.copyToChannel?0!==t[n].byteLength&&e.copyToChannel(t[n],i,s):0!==t[n].byteLength&&e.getChannelData(i).set(t[n],s)},Gv=(e,t)=>{const n=[];for(let i=0;i<e;i+=1){const e=[],s="number"==typeof t?t:t[i];for(let t=0;t<s;t+=1)e.push(new Float32Array(128));n.push(e)}return n},qv={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},$v={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Xv={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Yv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Kv={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Zv=e=>{const{port1:t,port2:n}=new MessageChannel;return new Promise(i=>{const s=()=>{n.onmessage=null,t.close(),n.close(),i()};n.onmessage=()=>s();try{t.postMessage(e,[e])}catch{}finally{s()}})},Jv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Qv=(e,t,n)=>{const i=t[n];if(void 0===i)throw e();return i},ex={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},tx={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},nx=()=>new DOMException("","InvalidStateError"),ix=()=>new DOMException("","InvalidAccessError"),sx={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},ax=(e,t,n,i,s,a,r,o,l,c,h)=>{const u=c.length;let d=o;for(let p=0;p<u;p+=1){let o=n[0]*c[p];for(let t=1;t<s;t+=1){const i=d-t&l-1;o+=n[t]*a[i],o-=e[t]*r[i]}for(let e=s;e<i;e+=1)o+=n[e]*a[d-e&l-1];for(let n=s;n<t;n+=1)o-=e[n]*r[d-n&l-1];a[d]=c[p],r[d]=o,d=d+1&l-1,h[p]=o}return d},rx={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},ox=e=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const n=e.decodeAudioData(t.buffer,()=>{});return void 0!==n&&(n.catch(()=>{}),!0)}catch{}return!1},lx=(e,t,n)=>{const i=t[n];void 0!==i&&i!==e[n]&&(e[n]=i)},cx=(e,t)=>{lx(e,t,"channelCount"),lx(e,t,"channelCountMode"),lx(e,t,"channelInterpretation")},hx=e=>"function"==typeof e.getFloatTimeDomainData,ux=(e,t,n)=>{const i=t[n];void 0!==i&&i!==e[n].value&&(e[n].value=i)},dx=e=>{var t;e.start=(t=e.start,(n=0,i=0,s)=>{if("number"==typeof s&&s<0||i<0||n<0)throw new RangeError("The parameters can't be negative.");t.call(e,n,i,s)})},px=e=>{var t;e.stop=(t=e.stop,(n=0)=>{if(n<0)throw new RangeError("The parameter can't be negative.");t.call(e,n)})},mx=(e,t)=>null===e?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(e*t))))),fx=(e,t)=>{const n=e.createBiquadFilter();return cx(n,t),ux(n,t,"Q"),ux(n,t,"detune"),ux(n,t,"frequency"),ux(n,t,"gain"),lx(n,t,"type"),n},gx=(e,t)=>{const n=e.createChannelSplitter(t.numberOfOutputs);return cx(n,t),(e=>{const t=e.numberOfOutputs;Object.defineProperty(e,"channelCount",{get:()=>t,set:e=>{if(e!==t)throw nx()}}),Object.defineProperty(e,"channelCountMode",{get:()=>"explicit",set:e=>{if("explicit"!==e)throw nx()}}),Object.defineProperty(e,"channelInterpretation",{get:()=>"discrete",set:e=>{if("discrete"!==e)throw nx()}})})(n),n},vx=(e,t)=>(e.connect=t.connect.bind(t),e.disconnect=t.disconnect.bind(t),e),xx=(e,t)=>{const n=e.createDelay(t.maxDelayTime);return cx(n,t),ux(n,t,"delayTime"),n},yx=(e,t)=>{const n=e.createGain();return cx(n,t),ux(n,t,"gain"),n};function bx(e,t){const n=t[0]*t[0]+t[1]*t[1];return[(e[0]*t[0]+e[1]*t[1])/n,(e[1]*t[0]-e[0]*t[1])/n]}function _x(e,t){return[e[0]*t[0]-e[1]*t[1],e[0]*t[1]+e[1]*t[0]]}function wx(e,t){let n=[0,0];for(let i=e.length-1;i>=0;i-=1)n=_x(n,t),n[0]+=e[i];return n}const Sx=(e,t,n,i)=>e.createScriptProcessor(t,n,i),Mx=()=>new DOMException("","NotSupportedError"),Tx={numberOfChannels:1},Ex={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Cx={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Nx={disableNormalization:!1},Ax={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Rx={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},jx=(e,t,n)=>void 0===e.copyFromChannel?e.getChannelData(n)[0]:(e.copyFromChannel(t,n),t[0]),Px=e=>{if(null===e)return!1;const t=e.length;return t%2!=0?0!==e[Math.floor(t/2)]:e[t/2-1]+e[t/2]!==0},Ix=(e,t,n,i)=>{let s=e;for(;!s.hasOwnProperty(t);)s=Object.getPrototypeOf(s);const{get:a,set:r}=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(e,t,{get:n(a),set:i(r)})},Dx=(e,t,n)=>{try{e.setValueAtTime(t,n)}catch(i){if(9!==i.code)throw i;Dx(e,t,n+1e-7)}},kx=e=>{const t=e.createOscillator();try{t.start(-1)}catch(n){return n instanceof RangeError}return!1},Lx=e=>{const t=e.createBuffer(1,1,44100),n=e.createBufferSource();n.buffer=t,n.start(),n.stop();try{return n.stop(),!0}catch{return!1}},Ox=e=>{const t=e.createOscillator();try{t.stop(-1)}catch(n){return n instanceof RangeError}return!1},Ux=(e,t)=>{const n=t.createGain();e.connect(n);const i=(s=e.disconnect,()=>{s.call(e,n),e.removeEventListener("ended",i)});var s;e.addEventListener("ended",i),vx(e,n),e.stop=(t=>{let i=!1;return(s=0)=>{if(i)try{t.call(e,s)}catch{n.gain.setValueAtTime(0,s)}else t.call(e,s),i=!0}})(e.stop)},Fx=(e,t)=>n=>{const i={value:e};return Object.defineProperties(n,{currentTarget:i,target:i}),"function"==typeof t?t.call(e,n):t.handleEvent.call(e,n)},zx=(Bx=Sv,(e,t,[n,i,s],a)=>{Bx(e[i],[t,n,s],e=>e[0]===t&&e[1]===n,a)});var Bx;const Vx=(e=>(t,n,[i,s,a],r)=>{const o=t.get(i);void 0===o?t.set(i,new Set([[s,n,a]])):e(o,[s,n,a],e=>e[0]===s&&e[1]===n,r)})(Sv),Hx=(Wx=ev,(e,t,n,i)=>Wx(e[i],e=>e[0]===t&&e[1]===n));var Wx;const Gx=new WeakMap,qx=($x=Gx,e=>{var t;return null!==(t=$x.get(e))&&void 0!==t?t:0});var $x;const Xx=(Yx=new Map,Kx=new WeakMap,(e,t)=>{const n=Kx.get(e);if(void 0!==n)return n;const i=Yx.get(e);if(void 0!==i)return i;try{const n=t();return n instanceof Promise?(Yx.set(e,n),n.catch(()=>!1).then(t=>(Yx.delete(e),Kx.set(e,t),t))):(Kx.set(e,n),n)}catch{return Kx.set(e,!1),!1}});var Yx,Kx;const Zx="undefined"==typeof window?null:window,Jx=(Qx=Xx,ey=hv,(e,t)=>{const n=e.createAnalyser();if(cx(n,t),!(t.maxDecibels>t.minDecibels))throw ey();return lx(n,t,"fftSize"),lx(n,t,"maxDecibels"),lx(n,t,"minDecibels"),lx(n,t,"smoothingTimeConstant"),Qx(hx,()=>hx(n))||(e=>{e.getFloatTimeDomainData=t=>{const n=new Uint8Array(t.length);e.getByteTimeDomainData(n);const i=Math.max(n.length,e.fftSize);for(let e=0;e<i;e+=1)t[e]=.0078125*(n[e]-128);return t}})(n),n});var Qx,ey;const ty=(ny=vv,e=>{const t=ny(e);if(null===t.renderer)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer});var ny;const iy=((e,t,n)=>async(i,s,a)=>{const r=e(i);await Promise.all(r.activeInputs.map((e,r)=>Array.from(e).map(async([e,o])=>{const l=t(e),c=await l.render(e,s),h=i.context.destination;n(e)||i===h&&n(i)||c.connect(a,o,r)})).reduce((e,t)=>[...e,...t],[]))})(vv,ty,Dv),sy=(ay=Jx,ry=Pv,oy=iy,()=>{const e=new WeakMap;return{render(t,n){const i=e.get(n);return void 0!==i?Promise.resolve(i):(async(t,n)=>{let i=ry(t);if(!lv(i,n)){const e={channelCount:i.channelCount,channelCountMode:i.channelCountMode,channelInterpretation:i.channelInterpretation,fftSize:i.fftSize,maxDecibels:i.maxDecibels,minDecibels:i.minDecibels,smoothingTimeConstant:i.smoothingTimeConstant};i=ay(n,e)}return e.set(n,i),await oy(t,n,i),i})(t,n)}}});var ay,ry,oy;const ly=(cy=Hg,e=>{const t=cy.get(e);if(void 0===t)throw nx();return t});var cy;const hy=null===(uy=Zx)?null:uy.hasOwnProperty("OfflineAudioContext")?uy.OfflineAudioContext:uy.hasOwnProperty("webkitOfflineAudioContext")?uy.webkitOfflineAudioContext:null;var uy;const dy=(py=hy,e=>null!==py&&e instanceof py);var py;const my=new WeakMap,fy=(gy=Fx,class{constructor(e){this._nativeEventTarget=e,this._listeners=new WeakMap}addEventListener(e,t,n){if(null!==t){let i=this._listeners.get(t);void 0===i&&(i=gy(this,t),"function"==typeof t&&this._listeners.set(t,i)),this._nativeEventTarget.addEventListener(e,i,n)}}dispatchEvent(e){return this._nativeEventTarget.dispatchEvent(e)}removeEventListener(e,t,n){const i=null===t?void 0:this._listeners.get(t);this._nativeEventTarget.removeEventListener(e,void 0===i?null:i,n)}});var gy;const vy=(e=>null===e?null:e.hasOwnProperty("AudioContext")?e.AudioContext:e.hasOwnProperty("webkitAudioContext")?e.webkitAudioContext:null)(Zx),xy=(yy=vy,e=>null!==yy&&e instanceof yy);var yy;const by=(e=>t=>null!==e&&"function"==typeof e.AudioNode&&t instanceof e.AudioNode)(Zx),_y=(e=>t=>null!==e&&"function"==typeof e.AudioParam&&t instanceof e.AudioParam)(Zx),wy=(e=>null===e?null:e.hasOwnProperty("AudioWorkletNode")?e.AudioWorkletNode:null)(Zx),Sy=((e,t,n,i,s,a,r,o,l,c,h,u,d,p,m,f)=>class extends c{constructor(t,i,s,a){super(s),this._context=t,this._nativeAudioNode=s;const r=h(t);u(r)&&!0!==n(Lv,()=>Lv(r,f))&&(e=>{const t=new Map;var n,i;e.connect=(n=e.connect.bind(e),(e,i=0,s=0)=>{const a=Uv(e)?n(e,i,s):n(e,i),r=t.get(e);return void 0===r?t.set(e,[{input:s,output:i}]):r.every(e=>e.input!==s||e.output!==i)&&r.push({input:s,output:i}),a}),e.disconnect=(i=e.disconnect,(n,s,a)=>{if(i.apply(e),void 0===n)t.clear();else if("number"==typeof n)for(const[e,i]of t){const s=i.filter(e=>e.output!==n);0===s.length?t.delete(e):t.set(e,s)}else if(t.has(n))if(void 0===s)t.delete(n);else{const e=t.get(n);if(void 0!==e){const i=e.filter(e=>e.output!==s&&(e.input!==a||void 0===a));0===i.length?t.delete(n):t.set(n,i)}}for(const[i,r]of t)r.forEach(t=>{Uv(i)?e.connect(i,t.output,t.input):e.connect(i,t.output)})})})(s),zg.set(this,s),Wg.set(this,new Set),"closed"!==t.state&&i&&iv(this),e(this,a,s)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(e){this._nativeAudioNode.channelCount=e}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(e){this._nativeAudioNode.channelCountMode=e}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(e){this._nativeAudioNode.channelInterpretation=e}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(e,n=0,o=0){if(n<0||n>=this._nativeAudioNode.numberOfOutputs)throw s();const c=h(this._context),u=m(c);if(d(e)||p(e))throw a();if(_v(e)){const s=Pv(e);try{const t=Cv(this._nativeAudioNode,s,n,o),i=kv(this);(u||i)&&this._nativeAudioNode.disconnect(...t),"closed"!==this.context.state&&!i&&kv(e)&&iv(e)}catch(g){if(12===g.code)throw a();throw g}if(t(this,e,n,o,u)){const t=l([this],e);Ov(t,i(u))}return e}const f=Iv(e);if("playbackRate"===f.name&&1024===f.maxValue)throw r();try{this._nativeAudioNode.connect(f,n),(u||kv(this))&&this._nativeAudioNode.disconnect(f,n)}catch(g){if(12===g.code)throw a();throw g}if(((e,t,n,i)=>{const{activeInputs:s,passiveInputs:a}=xv(t),{outputs:r}=vv(e),o=nv(e),l=r=>{const o=Pv(e),l=Iv(t);if(r){const t=Rv(a,e,n);Mv(s,e,t,!1),i||Dv(e)||o.connect(l,n)}else{const t=((e,t,n)=>ev(e,e=>e[0]===t&&e[1]===n))(s,e,n);Tv(a,t,!1),i||Dv(e)||o.disconnect(l,n)}};return!!Sv(r,[t,n],e=>e[0]===t&&e[1]===n,!0)&&(o.add(l),fv(e)?Mv(s,e,[n,l],!0):Tv(a,[e,n,l],!0),!0)})(this,e,n,u)){const t=l([this],e);Ov(t,i(u))}}disconnect(e,t,n){let i;const r=h(this._context),c=m(r);if(void 0===e)i=((e,t)=>{const n=vv(e),i=[];for(const s of n.outputs)wv(s)?Fv(e,t,...s):zv(e,t,...s),i.push(s[0]);return n.outputs.clear(),i})(this,c);else if("number"==typeof e){if(e<0||e>=this.numberOfOutputs)throw s();i=((e,t,n)=>{const i=vv(e),s=[];for(const a of i.outputs)a[1]===n&&(wv(a)?Fv(e,t,...a):zv(e,t,...a),s.push(a[0]),i.outputs.delete(a));return s})(this,c,e)}else{if(void 0!==t&&(t<0||t>=this.numberOfOutputs))throw s();if(_v(e)&&void 0!==n&&(n<0||n>=e.numberOfInputs))throw s();if(i=((e,t,n,i,s)=>{const a=vv(e);return Array.from(a.outputs).filter(e=>!(e[0]!==n||void 0!==i&&e[1]!==i||void 0!==s&&e[2]!==s)).map(n=>(wv(n)?Fv(e,t,...n):zv(e,t,...n),a.outputs.delete(n),n[0]))})(this,c,e,t,n),0===i.length)throw a()}for(const s of i){const e=l([this],s);Ov(e,o)}}})((My=Fg,(e,t,n)=>{const i=[];for(let s=0;s<n.numberOfInputs;s+=1)i.push(new Set);My.set(e,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((e,t,n,i,s,a,r,o,l,c,h,u,d)=>{const p=new WeakMap;return(m,f,g,v,x)=>{const{activeInputs:y,passiveInputs:b}=a(f),{outputs:_}=a(m),w=o(m),S=a=>{const o=l(f),c=l(m);if(a){const t=tv(b,m,g,v);e(y,m,t,!1),x||u(m)||n(c,o,g,v),d(f)&&iv(f)}else{const e=i(y,m,g,v);t(b,v,e,!1),x||u(m)||s(c,o,g,v);const n=r(f);if(0===n)h(f)&&rv(f,y);else{const e=p.get(f);void 0!==e&&clearTimeout(e),p.set(f,setTimeout(()=>{h(f)&&rv(f,y)},1e3*n))}}};return!!c(_,[f,g,v],e=>e[0]===f&&e[1]===g&&e[2]===v,!0)&&(w.add(S),h(m)?e(y,m,[g,v,S],!0):t(b,v,[m,g,S],!0),!0)}})(zx,Vx,Cv,Hx,jv,vv,qx,nv,Pv,Sv,fv,Dv,kv),Xx,((e,t,n,i,s,a)=>r=>(o,l)=>{const c=e.get(o);if(void 0===c){if(!r&&a(o)){const e=i(o),{outputs:a}=n(o);for(const n of a)if(wv(n)){const s=i(n[0]);t(e,s,n[1],n[2])}else{const t=s(n[0]);e.disconnect(t,n[1])}}e.set(o,l)}else e.set(o,c+l)})(Gg,jv,vv,Pv,Iv,fv),hv,ix,Mx,((e,t,n,i,s,a,r,o)=>(l,c)=>{const h=t.get(l);if(void 0===h)throw new Error("Missing the expected cycle count.");const u=a(l.context),d=o(u);if(h===c){if(t.delete(l),!d&&r(l)){const t=i(l),{outputs:a}=n(l);for(const n of a)if(wv(n)){const s=i(n[0]);e(t,s,n[1],n[2])}else{const e=s(n[0]);t.connect(e,n[1])}}}else t.set(l,h-c)})(Cv,Gg,vv,Pv,Iv,ly,fv,dy),((e,t,n)=>function i(s,a){const r=_v(a)?a:n(e,a);if((e=>"delayTime"in e)(r))return[];if(s[0]===r)return[s];if(s.includes(r))return[];const{outputs:o}=t(r);return Array.from(o).map(e=>i([...s,r],e[0])).reduce((e,t)=>e.concat(t),[])})(my,vv,Qg),fy,ly,xy,by,_y,dy,wy);var My;const Ty=((e,t,n,i,s,a)=>class extends e{constructor(e,n){const r=s(e),o={...ov,...n},l=i(r,o);super(e,!1,l,a(r)?t():null),this._nativeAnalyserNode=l}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(e){this._nativeAnalyserNode.fftSize=e}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(e){const t=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=e,!(e>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=t,n()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(e){const t=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=e,!(this._nativeAnalyserNode.maxDecibels>e))throw this._nativeAnalyserNode.minDecibels=t,n()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(e){this._nativeAnalyserNode.smoothingTimeConstant=e}getByteFrequencyData(e){this._nativeAnalyserNode.getByteFrequencyData(e)}getByteTimeDomainData(e){this._nativeAnalyserNode.getByteTimeDomainData(e)}getFloatFrequencyData(e){this._nativeAnalyserNode.getFloatFrequencyData(e)}getFloatTimeDomainData(e){this._nativeAnalyserNode.getFloatTimeDomainData(e)}})(Sy,sy,hv,Jx,ly,dy),Ey=new WeakSet,Cy=(e=>null===e?null:e.hasOwnProperty("AudioBuffer")?e.AudioBuffer:null)(Zx),Ny=(Ay=new Uint32Array(1),e=>(Ay[0]=e,Ay[0]));var Ay;const Ry=((e,t)=>n=>{n.copyFromChannel=(i,s,a=0)=>{const r=e(a),o=e(s);if(o>=n.numberOfChannels)throw t();const l=n.length,c=n.getChannelData(o),h=i.length;for(let e=r<0?-r:0;e+r<l&&e<h;e+=1)i[e]=c[e+r]},n.copyToChannel=(i,s,a=0)=>{const r=e(a),o=e(s);if(o>=n.numberOfChannels)throw t();const l=n.length,c=n.getChannelData(o),h=i.length;for(let e=r<0?-r:0;e+r<l&&e<h;e+=1)c[e+r]=i[e]}})(Ny,hv),jy=(Py=Ny,e=>{var t,n;e.copyFromChannel=(t=e.copyFromChannel,(n,i,s=0)=>{const a=Py(s),r=Py(i);if(a<e.length)return t.call(e,n,r,a)}),e.copyToChannel=(n=e.copyToChannel,(t,i,s=0)=>{const a=Py(s),r=Py(i);if(a<e.length)return n.call(e,t,r,a)})});var Py;const Iy=((e,t,n,i,s,a,r,o)=>{let l=null;return class c{constructor(c){if(null===s)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:h,numberOfChannels:u,sampleRate:d}={...dv,...c};null===l&&(l=new s(1,1,44100));const p=null!==i&&t(a,a)?new i({length:h,numberOfChannels:u,sampleRate:d}):l.createBuffer(u,h,d);if(0===p.numberOfChannels)throw n();return"function"!=typeof p.copyFromChannel?(r(p),uv(p)):t(cv,()=>cv(p))||o(p),e.add(p),p}static[Symbol.hasInstance](t){return null!==t&&"object"==typeof t&&Object.getPrototypeOf(t)===c.prototype||e.has(t)}}})(Ey,Xx,Mx,Cy,hy,(Dy=Cy,()=>{if(null===Dy)return!1;try{new Dy({length:1,sampleRate:44100})}catch{return!1}return!0}),Ry,jy);var Dy;const ky=(Ly=yx,(e,t)=>{const n=Ly(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(n).connect(e.destination);const i=()=>{t.removeEventListener("ended",i),t.disconnect(n),n.disconnect()};t.addEventListener("ended",i)});var Ly;const Oy=(Uy=ty,Fy=xv,zy=Dv,async(e,t,n)=>{const i=Fy(e);await Promise.all(Array.from(i.activeInputs).map(async([e,i])=>{const s=Uy(e),a=await s.render(e,t);zy(e)||a.connect(n,i)}))});var Uy,Fy,zy;const By=(Vy=Oy,(e,t,n)=>Vy(t,e,n));var Vy;const Hy=((e,t,n,i,s,a,r,o,l,c,h)=>(l,u)=>{const d=l.createBufferSource();return cx(d,u),ux(d,u,"playbackRate"),lx(d,u,"buffer"),lx(d,u,"loop"),lx(d,u,"loopEnd"),lx(d,u,"loopStart"),t(n,()=>n(l))||(e=>{e.start=(t=>{let n=!1;return(i=0,s=0,a)=>{if(n)throw nx();t.call(e,i,s,a),n=!0}})(e.start)})(d),t(i,()=>i(l))||(e=>{var t;e.start=(t=e.start,(n=0,i=0,s)=>{const a=e.buffer,r=null===a?i:Math.min(a.duration,i);null!==a&&r>a.duration-.5/e.context.sampleRate?t.call(e,n,0,0):t.call(e,n,r,s)})})(d),t(s,()=>s(l))||c(d,l),t(a,()=>a(l))||dx(d),t(r,()=>r(l))||h(d,l),t(o,()=>o(l))||px(d),e(l,d),d})(ky,Xx,e=>{const t=e.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},e=>{const t=e.createBufferSource(),n=e.createBuffer(1,1,44100);t.buffer=n;try{t.start(0,1)}catch{return!1}return!0},e=>{const t=e.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},kx,Lx,Ox,0,(Wy=Ix,(e,t)=>{const n=t.createBuffer(1,1,44100);null===e.buffer&&(e.buffer=n),Wy(e,"buffer",t=>()=>{const i=t.call(e);return i===n?null:i},t=>i=>t.call(e,null===i?n:i))}),Ux);var Wy;const Gy=((e,t)=>(n,i,s)=>(e(i).replay(s),t(i,n,s)))((e=>t=>{const n=e(t);if(null===n.renderer)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return n.renderer})(xv),Oy),qy=((e,t,n,i,s)=>()=>{const a=new WeakMap;let r=null,o=null;return{set start(e){r=e},set stop(e){o=e},render(l,c){const h=a.get(c);return void 0!==h?Promise.resolve(h):(async(l,c)=>{let h=n(l);const u=lv(h,c);if(!u){const e={buffer:h.buffer,channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,loop:h.loop,loopEnd:h.loopEnd,loopStart:h.loopStart,playbackRate:h.playbackRate.value};h=t(c,e),null!==r&&h.start(...r),null!==o&&h.stop(o)}return a.set(c,h),u?await e(c,l.playbackRate,h.playbackRate):await i(c,l.playbackRate,h.playbackRate),await s(l,c,h),h})(l,c)}}})(By,Hy,Pv,Gy,iy),$y=((e,t,n,i,s,a,r,o,l,c,h,u,d)=>(i,a,r,o=null,l=null)=>{const p=r.value,m=new Og(p),f=a?(e=>({replay(t){for(const n of e)if("exponentialRampToValue"===n.type){const{endTime:e,value:i}=n;t.exponentialRampToValueAtTime(i,e)}else if("linearRampToValue"===n.type){const{endTime:e,value:i}=n;t.linearRampToValueAtTime(i,e)}else if("setTarget"===n.type){const{startTime:e,target:i,timeConstant:s}=n;t.setTargetAtTime(i,e,s)}else if("setValue"===n.type){const{startTime:e,value:i}=n;t.setValueAtTime(i,e)}else{if("setValueCurve"!==n.type)throw new Error("Can't apply an unknown automation.");{const{duration:e,startTime:i,values:s}=n;t.setValueCurveAtTime(s,i,e)}}}}))(m):null,g={get defaultValue(){return p},get maxValue(){return null===o?r.maxValue:o},get minValue(){return null===l?r.minValue:l},get value(){return r.value},set value(e){r.value=e,g.setValueAtTime(e,i.context.currentTime)},cancelAndHoldAtTime(e){if("function"==typeof r.cancelAndHoldAtTime)null===f&&m.flush(i.context.currentTime),m.add(s(e)),r.cancelAndHoldAtTime(e);else{const t=Array.from(m).pop();null===f&&m.flush(i.context.currentTime),m.add(s(e));const n=Array.from(m).pop();r.cancelScheduledValues(e),t!==n&&void 0!==n&&("exponentialRampToValue"===n.type?r.exponentialRampToValueAtTime(n.value,n.endTime):"linearRampToValue"===n.type?r.linearRampToValueAtTime(n.value,n.endTime):"setValue"===n.type?r.setValueAtTime(n.value,n.startTime):"setValueCurve"===n.type&&r.setValueCurveAtTime(n.values,n.startTime,n.duration))}return g},cancelScheduledValues:e=>(null===f&&m.flush(i.context.currentTime),m.add((e=>({cancelTime:e,type:"cancelScheduledValues"}))(e)),r.cancelScheduledValues(e),g),exponentialRampToValueAtTime(e,t){if(0===e)throw new RangeError;if(!Number.isFinite(t)||t<0)throw new RangeError;const n=i.context.currentTime;return null===f&&m.flush(n),0===Array.from(m).length&&(m.add(c(p,n)),r.setValueAtTime(p,n)),m.add(((e,t)=>({endTime:t,type:"exponentialRampToValue",value:e}))(e,t)),r.exponentialRampToValueAtTime(e,t),g},linearRampToValueAtTime(e,t){const n=i.context.currentTime;return null===f&&m.flush(n),0===Array.from(m).length&&(m.add(c(p,n)),r.setValueAtTime(p,n)),m.add(((e,t)=>({endTime:t,type:"linearRampToValue",value:e}))(e,t)),r.linearRampToValueAtTime(e,t),g},setTargetAtTime:(e,t,n)=>(null===f&&m.flush(i.context.currentTime),m.add(((e,t,n)=>({startTime:t,target:e,timeConstant:n,type:"setTarget"}))(e,t,n)),r.setTargetAtTime(e,t,n),g),setValueAtTime:(e,t)=>(null===f&&m.flush(i.context.currentTime),m.add(c(e,t)),r.setValueAtTime(e,t),g),setValueCurveAtTime(e,t,n){const s=e instanceof Float32Array?e:new Float32Array(e);if(null!==u&&"webkitAudioContext"===u.name){const e=t+n,a=i.context.sampleRate,o=Math.ceil(t*a),l=Math.floor(e*a),c=l-o,u=new Float32Array(c);for(let i=0;i<c;i+=1){const e=(s.length-1)/n*((o+i)/a-t),r=Math.floor(e),l=Math.ceil(e);u[i]=r===l?s[r]:(1-(e-r))*s[r]+(1-(l-e))*s[l]}null===f&&m.flush(i.context.currentTime),m.add(h(u,t,n)),r.setValueCurveAtTime(u,t,n);const p=l/a;p<e&&d(g,u[u.length-1],p),d(g,s[s.length-1],e)}else null===f&&m.flush(i.context.currentTime),m.add(h(s,t,n)),r.setValueCurveAtTime(s,t,n);return g}};return n.set(g,r),t.set(g,i),e(g,f),g})((Xy=Bg,(e,t)=>{Xy.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),my,Vg,0,e=>({cancelTime:e,type:"cancelAndHold"}),0,0,0,0,_g,wg,vy,Dx);var Xy;const Yy=((e,t,n,i,s,a,r,o)=>class extends e{constructor(e,i){const o=a(e),l={...gv,...i},c=s(o,l),h=r(o),u=h?t():null;super(e,!1,c,u),this._audioBufferSourceNodeRenderer=u,this._isBufferNullified=!1,this._isBufferSet=null!==l.buffer,this._nativeAudioBufferSourceNode=c,this._onended=null,this._playbackRate=n(this,h,c.playbackRate,mv,pv)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(e){if(this._nativeAudioBufferSourceNode.buffer=e,null!==e){if(this._isBufferSet)throw i();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(e){this._nativeAudioBufferSourceNode.loop=e}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(e){this._nativeAudioBufferSourceNode.loopEnd=e}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(e){this._nativeAudioBufferSourceNode.loopStart=e}get onended(){return this._onended}set onended(e){const t="function"==typeof e?o(this,e):null;this._nativeAudioBufferSourceNode.onended=t;const n=this._nativeAudioBufferSourceNode.onended;this._onended=null!==n&&n===t?e:n}get playbackRate(){return this._playbackRate}start(e=0,t=0,n){if(this._nativeAudioBufferSourceNode.start(e,t,n),null!==this._audioBufferSourceNodeRenderer&&(this._audioBufferSourceNodeRenderer.start=void 0===n?[e,t]:[e,t,n]),"closed"!==this.context.state){iv(this);const e=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",e),fv(this)&&av(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",e)}}stop(e=0){this._nativeAudioBufferSourceNode.stop(e),null!==this._audioBufferSourceNodeRenderer&&(this._audioBufferSourceNodeRenderer.stop=e)}})(Sy,qy,$y,nx,Hy,ly,dy,Fx),Ky=((e,t,n,i,s,a,r,o)=>class extends e{constructor(e,t){const n=a(e),i=r(n),l=s(n,t,i);super(e,!1,l,i?(e=>{const t=new WeakMap;return{render(n,i){const s=t.get(i);return void 0!==s?Promise.resolve(s):(async(n,i)=>{const s=i.destination;return t.set(i,s),await e(n,i,s),s})(n,i)}}})(o):null),this._isNodeOfNativeOfflineAudioContext=i,this._nativeAudioDestinationNode=l}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(e){if(this._isNodeOfNativeOfflineAudioContext)throw i();if(e>this._nativeAudioDestinationNode.maxChannelCount)throw n();this._nativeAudioDestinationNode.channelCount=e}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(e){if(this._isNodeOfNativeOfflineAudioContext)throw i();this._nativeAudioDestinationNode.channelCountMode=e}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(Sy,0,hv,nx,((e,t)=>(n,i,s)=>{const a=n.destination;if(a.channelCount!==i)try{a.channelCount=i}catch{}s&&"explicit"!==a.channelCountMode&&(a.channelCountMode="explicit"),0===a.maxChannelCount&&Object.defineProperty(a,"maxChannelCount",{value:i});const r=e(n,{channelCount:i,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,gain:1});return t(r,"channelCount",e=>()=>e.call(r),e=>t=>{e.call(r,t);try{a.channelCount=t}catch(n){if(t>a.maxChannelCount)throw n}}),t(r,"channelCountMode",e=>()=>e.call(r),e=>t=>{e.call(r,t),a.channelCountMode=t}),t(r,"channelInterpretation",e=>()=>e.call(r),e=>t=>{e.call(r,t),a.channelInterpretation=t}),Object.defineProperty(r,"maxChannelCount",{get:()=>a.maxChannelCount}),r.connect(a),r})(yx,Ix),ly,dy,iy),Zy=((e,t,n,i,s)=>()=>{const a=new WeakMap;return{render(r,o){const l=a.get(o);return void 0!==l?Promise.resolve(l):(async(r,o)=>{let l=n(r);const c=lv(l,o);if(!c){const e={Q:l.Q.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,detune:l.detune.value,frequency:l.frequency.value,gain:l.gain.value,type:l.type};l=t(o,e)}return a.set(o,l),c?(await e(o,r.Q,l.Q),await e(o,r.detune,l.detune),await e(o,r.frequency,l.frequency),await e(o,r.gain,l.gain)):(await i(o,r.Q,l.Q),await i(o,r.detune,l.detune),await i(o,r.frequency,l.frequency),await i(o,r.gain,l.gain)),await s(r,o,l),l})(r,o)}}})(By,fx,Pv,Gy,iy),Jy=(e=>(t,n)=>e.set(t,n))(Gx),Qy=(eb=Sy,tb=$y,nb=Zy,ib=ix,sb=fx,ab=ly,rb=dy,ob=Jy,class extends eb{constructor(e,t){const n=ab(e),i={...qv,...t},s=sb(n,i),a=rb(n);super(e,!1,s,a?nb():null),this._Q=tb(this,a,s.Q,mv,pv),this._detune=tb(this,a,s.detune,1200*Math.log2(mv),-1200*Math.log2(mv)),this._frequency=tb(this,a,s.frequency,e.sampleRate/2,0),this._gain=tb(this,a,s.gain,40*Math.log10(mv),pv),this._nativeBiquadFilterNode=s,ob(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(e){this._nativeBiquadFilterNode.type=e}getFrequencyResponse(e,t,n){try{this._nativeBiquadFilterNode.getFrequencyResponse(e,t,n)}catch(i){if(11===i.code)throw ib();throw i}if(e.length!==t.length||t.length!==n.length)throw ib()}});var eb,tb,nb,ib,sb,ab,rb,ob;const lb=((e,t)=>(n,i,s)=>{const a=new Set;var r,o;return n.connect=(r=n.connect,(s,o=0,l=0)=>{const c=0===a.size;if(t(s))return r.call(n,s,o,l),e(a,[s,o,l],e=>e[0]===s&&e[1]===o&&e[2]===l,!0),c&&i(),s;r.call(n,s,o),e(a,[s,o],e=>e[0]===s&&e[1]===o,!0),c&&i()}),n.disconnect=(o=n.disconnect,(e,i,r)=>{const l=a.size>0;if(void 0===e)o.apply(n),a.clear();else if("number"==typeof e){o.call(n,e);for(const t of a)t[1]===e&&a.delete(t)}else{t(e)?o.call(n,e,i,r):o.call(n,e,i);for(const t of a)t[0]!==e||void 0!==i&&t[1]!==i||void 0!==r&&t[2]!==r||a.delete(t)}const c=0===a.size;l&&c&&s()}),n})(Sv,by);var cb,hb;const ub=((e,t)=>(n,i)=>{const s=n.createChannelMerger(i.numberOfInputs);return null!==e&&"webkitAudioContext"===e.name&&t(n,s),cx(s,i),s})(vy,(cb=nx,hb=lb,(e,t)=>{t.channelCount=1,t.channelCountMode="explicit",Object.defineProperty(t,"channelCount",{get:()=>1,set:()=>{throw cb()}}),Object.defineProperty(t,"channelCountMode",{get:()=>"explicit",set:()=>{throw cb()}});const n=e.createBufferSource();hb(t,()=>{const e=t.numberOfInputs;for(let i=0;i<e;i+=1)n.connect(t,0,i)},()=>n.disconnect(t))})),db=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,a){const r=i.get(a);return void 0!==r?Promise.resolve(r):(async(s,a)=>{let r=t(s);if(!lv(r,a)){const t={channelCount:r.channelCount,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,numberOfInputs:r.numberOfInputs};r=e(a,t)}return i.set(a,r),await n(s,a,r),r})(s,a)}}})(ub,Pv,iy),pb=((e,t,n,i,s)=>class extends e{constructor(e,a){const r=i(e),o={...$v,...a};super(e,!1,n(r,o),s(r)?t():null)}})(Sy,db,ub,ly,dy),mb=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,a){const r=i.get(a);return void 0!==r?Promise.resolve(r):(async(s,a)=>{let r=t(s);if(!lv(r,a)){const t={channelCount:r.channelCount,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,numberOfOutputs:r.numberOfOutputs};r=e(a,t)}return i.set(a,r),await n(s,a,r),r})(s,a)}}})(gx,Pv,iy),fb=((e,t,n,i,s)=>class extends e{constructor(e,a){const r=i(e),o=(e=>({...e,channelCount:e.numberOfOutputs}))({...Xv,...a});super(e,!1,n(r,o),s(r)?t():null)}})(Sy,mb,gx,ly,dy),gb=((e,t,n,i)=>(s,{offset:a,...r})=>{const o=s.createBuffer(1,2,44100),l=t(s,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),c=n(s,{...r,gain:a}),h=o.getChannelData(0);h[0]=1,h[1]=1,l.buffer=o,l.loop=!0;const u={get bufferSize(){},get channelCount(){return c.channelCount},set channelCount(e){c.channelCount=e},get channelCountMode(){return c.channelCountMode},set channelCountMode(e){c.channelCountMode=e},get channelInterpretation(){return c.channelInterpretation},set channelInterpretation(e){c.channelInterpretation=e},get context(){return c.context},get inputs(){return[]},get numberOfInputs(){return l.numberOfInputs},get numberOfOutputs(){return c.numberOfOutputs},get offset(){return c.gain},get onended(){return l.onended},set onended(e){l.onended=e},addEventListener:(...e)=>l.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>l.dispatchEvent(e[0]),removeEventListener:(...e)=>l.removeEventListener(e[0],e[1],e[2]),start(e=0){l.start.call(l,e)},stop(e=0){l.stop.call(l,e)}};return e(s,l),i(vx(u,c),()=>l.connect(c),()=>l.disconnect(c))})(ky,Hy,yx,lb),vb=((e,t,n,i,s)=>(a,r)=>{if(void 0===a.createConstantSource)return n(a,r);const o=a.createConstantSource();return cx(o,r),ux(o,r,"offset"),t(i,()=>i(a))||dx(o),t(s,()=>s(a))||px(o),e(a,o),o})(ky,Xx,gb,kx,Ox),xb=((e,t,n,i,s)=>()=>{const a=new WeakMap;let r=null,o=null;return{set start(e){r=e},set stop(e){o=e},render(l,c){const h=a.get(c);return void 0!==h?Promise.resolve(h):(async(l,c)=>{let h=n(l);const u=lv(h,c);if(!u){const e={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,offset:h.offset.value};h=t(c,e),null!==r&&h.start(r),null!==o&&h.stop(o)}return a.set(c,h),u?await e(c,l.offset,h.offset):await i(c,l.offset,h.offset),await s(l,c,h),h})(l,c)}}})(By,vb,Pv,Gy,iy),yb=((e,t,n,i,s,a,r)=>class extends e{constructor(e,r){const o=s(e),l={...Yv,...r},c=i(o,l),h=a(o),u=h?n():null;super(e,!1,c,u),this._constantSourceNodeRenderer=u,this._nativeConstantSourceNode=c,this._offset=t(this,h,c.offset,mv,pv),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(e){const t="function"==typeof e?r(this,e):null;this._nativeConstantSourceNode.onended=t;const n=this._nativeConstantSourceNode.onended;this._onended=null!==n&&n===t?e:n}start(e=0){if(this._nativeConstantSourceNode.start(e),null!==this._constantSourceNodeRenderer&&(this._constantSourceNodeRenderer.start=e),"closed"!==this.context.state){iv(this);const e=()=>{this._nativeConstantSourceNode.removeEventListener("ended",e),fv(this)&&av(this)};this._nativeConstantSourceNode.addEventListener("ended",e)}}stop(e=0){this._nativeConstantSourceNode.stop(e),null!==this._constantSourceNodeRenderer&&(this._constantSourceNodeRenderer.stop=e)}})(Sy,$y,xb,vb,ly,dy,Fx),bb=((e,t)=>(n,i)=>{const s=n.createConvolver();if(cx(s,i),i.disableNormalization===s.normalize&&(s.normalize=!i.disableNormalization),lx(s,i,"buffer"),i.channelCount>2)throw e();if(t(s,"channelCount",e=>()=>e.call(s),t=>n=>{if(n>2)throw e();return t.call(s,n)}),"max"===i.channelCountMode)throw e();return t(s,"channelCountMode",e=>()=>e.call(s),t=>n=>{if("max"===n)throw e();return t.call(s,n)}),s})(Mx,Ix),_b=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,a){const r=i.get(a);return void 0!==r?Promise.resolve(r):(async(s,a)=>{let r=t(s);if(!lv(r,a)){const t={buffer:r.buffer,channelCount:r.channelCount,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,disableNormalization:!r.normalize};r=e(a,t)}return i.set(a,r),Ev(r)?await n(s,a,r.inputs[0]):await n(s,a,r),r})(s,a)}}})(bb,Pv,iy),wb=((e,t,n,i,s,a)=>class extends e{constructor(e,r){const o=i(e),l={...Kv,...r},c=n(o,l);super(e,!1,c,s(o)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=c,null!==l.buffer&&a(this,l.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(e){if(this._nativeConvolverNode.buffer=e,null===e&&null!==this._nativeConvolverNode.buffer){const e=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=e.createBuffer(1,1,e.sampleRate),this._isBufferNullified=!0,a(this,0)}else this._isBufferNullified=!1,a(this,null===this._nativeConvolverNode.buffer?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(e){this._nativeConvolverNode.normalize=e}})(Sy,_b,bb,ly,dy,Jy),Sb=((e,t,n,i,s)=>a=>{const r=new WeakMap;return{render(o,l){const c=r.get(l);return void 0!==c?Promise.resolve(c):(async(o,l)=>{let c=n(o);const h=lv(c,l);if(!h){const e={channelCount:c.channelCount,channelCountMode:c.channelCountMode,channelInterpretation:c.channelInterpretation,delayTime:c.delayTime.value,maxDelayTime:a};c=t(l,e)}return r.set(l,c),h?await e(l,o.delayTime,c.delayTime):await i(l,o.delayTime,c.delayTime),await s(o,l,c),c})(o,l)}}})(By,xx,Pv,Gy,iy),Mb=((e,t,n,i,s,a,r)=>class extends e{constructor(e,o){const l=s(e),c={...Jv,...o},h=i(l,c),u=a(l);super(e,!1,h,u?n(c.maxDelayTime):null),this._delayTime=t(this,u,h.delayTime),r(this,c.maxDelayTime)}get delayTime(){return this._delayTime}})(Sy,$y,Sb,xx,ly,dy,Jy),Tb=(Eb=Mx,(e,t)=>{const n=e.createDynamicsCompressor();if(cx(n,t),t.channelCount>2)throw Eb();if("max"===t.channelCountMode)throw Eb();return ux(n,t,"attack"),ux(n,t,"knee"),ux(n,t,"ratio"),ux(n,t,"release"),ux(n,t,"threshold"),n});var Eb;const Cb=((e,t,n,i,s)=>()=>{const a=new WeakMap;return{render(r,o){const l=a.get(o);return void 0!==l?Promise.resolve(l):(async(r,o)=>{let l=n(r);const c=lv(l,o);if(!c){const e={attack:l.attack.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,knee:l.knee.value,ratio:l.ratio.value,release:l.release.value,threshold:l.threshold.value};l=t(o,e)}return a.set(o,l),c?(await e(o,r.attack,l.attack),await e(o,r.knee,l.knee),await e(o,r.ratio,l.ratio),await e(o,r.release,l.release),await e(o,r.threshold,l.threshold)):(await i(o,r.attack,l.attack),await i(o,r.knee,l.knee),await i(o,r.ratio,l.ratio),await i(o,r.release,l.release),await i(o,r.threshold,l.threshold)),await s(r,o,l),l})(r,o)}}})(By,Tb,Pv,Gy,iy),Nb=((e,t,n,i,s,a,r,o)=>class extends e{constructor(e,s){const l=a(e),c={...ex,...s},h=i(l,c),u=r(l);super(e,!1,h,u?n():null),this._attack=t(this,u,h.attack),this._knee=t(this,u,h.knee),this._nativeDynamicsCompressorNode=h,this._ratio=t(this,u,h.ratio),this._release=t(this,u,h.release),this._threshold=t(this,u,h.threshold),o(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(e){const t=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=e,e>2)throw this._nativeDynamicsCompressorNode.channelCount=t,s()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(e){const t=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=e,"max"===e)throw this._nativeDynamicsCompressorNode.channelCountMode=t,s()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return"number"==typeof this._nativeDynamicsCompressorNode.reduction.value?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(Sy,$y,Cb,Tb,Mx,ly,dy,Jy),Ab=((e,t,n,i,s)=>()=>{const a=new WeakMap;return{render(r,o){const l=a.get(o);return void 0!==l?Promise.resolve(l):(async(r,o)=>{let l=n(r);const c=lv(l,o);if(!c){const e={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,gain:l.gain.value};l=t(o,e)}return a.set(o,l),c?await e(o,r.gain,l.gain):await i(o,r.gain,l.gain),await s(r,o,l),l})(r,o)}}})(By,yx,Pv,Gy,iy),Rb=((e,t,n,i,s,a)=>class extends e{constructor(e,r){const o=s(e),l={...tx,...r},c=i(o,l),h=a(o);super(e,!1,c,h?n():null),this._gain=t(this,h,c.gain,mv,pv)}get gain(){return this._gain}})(Sy,$y,Ab,yx,ly,dy),jb=((e,t,n,i)=>(s,a,{channelCount:r,channelCountMode:o,channelInterpretation:l,feedback:c,feedforward:h})=>{const u=mx(a,s.sampleRate),d=c instanceof Float64Array?c:new Float64Array(c),p=h instanceof Float64Array?h:new Float64Array(h),m=d.length,f=p.length,g=Math.min(m,f);if(0===m||m>20)throw i();if(0===d[0])throw t();if(0===f||f>20)throw i();if(0===p[0])throw t();if(1!==d[0]){for(let e=0;e<f;e+=1)p[e]/=d[0];for(let e=1;e<m;e+=1)d[e]/=d[0]}const v=n(s,u,r,r);v.channelCount=r,v.channelCountMode=o,v.channelInterpretation=l;const x=[],y=[],b=[];for(let e=0;e<r;e+=1){x.push(0);const e=new Float32Array(32),t=new Float32Array(32);e.fill(0),t.fill(0),y.push(e),b.push(t)}v.onaudioprocess=e=>{const t=e.inputBuffer,n=e.outputBuffer,i=t.numberOfChannels;for(let s=0;s<i;s+=1){const e=t.getChannelData(s),i=n.getChannelData(s);x[s]=ax(d,m,p,f,g,y[s],b[s],x[s],32,e,i)}};const _=s.sampleRate/2;return vx({get bufferSize(){return u},get channelCount(){return v.channelCount},set channelCount(e){v.channelCount=e},get channelCountMode(){return v.channelCountMode},set channelCountMode(e){v.channelCountMode=e},get channelInterpretation(){return v.channelInterpretation},set channelInterpretation(e){v.channelInterpretation=e},get context(){return v.context},get inputs(){return[v]},get numberOfInputs(){return v.numberOfInputs},get numberOfOutputs(){return v.numberOfOutputs},addEventListener:(...e)=>v.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>v.dispatchEvent(e[0]),getFrequencyResponse(t,n,i){if(t.length!==n.length||n.length!==i.length)throw e();const s=t.length;for(let e=0;e<s;e+=1){const s=-Math.PI*(t[e]/_),a=[Math.cos(s),Math.sin(s)],r=bx(wx(p,a),wx(d,a));n[e]=Math.sqrt(r[0]*r[0]+r[1]*r[1]),i[e]=Math.atan2(r[1],r[0])}},removeEventListener:(...e)=>v.removeEventListener(e[0],e[1],e[2])},v)})(ix,nx,Sx,Mx),Pb=((e,t,n,i)=>s=>e(ox,()=>ox(s))?Promise.resolve(e(i,i)).then(e=>{if(!e){const e=n(s,512,0,1);s.oncomplete=()=>{e.onaudioprocess=null,e.disconnect()},e.onaudioprocess=()=>s.currentTime,e.connect(s.destination)}return s.startRendering()}):new Promise(e=>{const n=t(s,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});s.oncomplete=t=>{n.disconnect(),e(t.renderedBuffer)},n.connect(s.destination),s.startRendering()}))(Xx,yx,Sx,((e,t)=>()=>{if(null===t)return Promise.resolve(!1);const n=new t(1,1,44100),i=e(n,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(e=>{n.oncomplete=()=>{i.disconnect(),e(0!==n.currentTime)},n.startRendering()})})(yx,hy)),Ib=((e,t,n,i,s)=>(a,r)=>{const o=new WeakMap;let l=null;return{render(c,h){const u=o.get(h);return void 0!==u?Promise.resolve(u):(async(c,h)=>{let u=null,d=t(c);const p=lv(d,h);if(void 0===h.createIIRFilter?u=e(h,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(d=h.createIIRFilter(r,a)),o.set(h,null===u?d:u),null!==u){if(null===l){if(null===n)throw new Error("Missing the native OfflineAudioContext constructor.");const e=new n(c.context.destination.channelCount,c.context.length,h.sampleRate);l=(async()=>(await i(c,e,e.destination),((e,t,n,i)=>{const s=n instanceof Float64Array?n:new Float64Array(n),a=i instanceof Float64Array?i:new Float64Array(i),r=s.length,o=a.length,l=Math.min(r,o);if(1!==s[0]){for(let e=0;e<r;e+=1)a[e]/=s[0];for(let e=1;e<o;e+=1)s[e]/=s[0]}const c=new Float32Array(32),h=new Float32Array(32),u=t.createBuffer(e.numberOfChannels,e.length,e.sampleRate),d=e.numberOfChannels;for(let p=0;p<d;p+=1){const t=e.getChannelData(p),n=u.getChannelData(p);c.fill(0),h.fill(0),ax(s,r,a,o,l,c,h,0,32,t,n)}return u})(await s(e),h,a,r)))()}const e=await l;return u.buffer=e,u.start(0),u}return await i(c,h,d),d})(c,h)}}})(Hy,Pv,hy,iy,Pb);var Db;const kb=((e,t,n,i,s,a)=>class extends e{constructor(e,r){const o=i(e),l=s(o),c={...sx,...r},h=t(o,l?null:e.baseLatency,c);super(e,!1,h,l?n(c.feedback,c.feedforward):null),(e=>{var t;e.getFrequencyResponse=(t=e.getFrequencyResponse,(n,i,s)=>{if(n.length!==i.length||i.length!==s.length)throw ix();return t.call(e,n,i,s)})})(h),this._nativeIIRFilterNode=h,a(this,1)}getFrequencyResponse(e,t,n){return this._nativeIIRFilterNode.getFrequencyResponse(e,t,n)}})(Sy,(Db=jb,(e,t,n)=>{if(void 0===e.createIIRFilter)return Db(e,t,n);const i=e.createIIRFilter(n.feedforward,n.feedback);return cx(i,n),i}),Ib,ly,dy,Jy),Lb=((e,t,n,i,s,a,r,o)=>(l,c)=>{const h=c.listener,{forwardX:u,forwardY:d,forwardZ:p,positionX:m,positionY:f,positionZ:g,upX:v,upY:x,upZ:y}=void 0===h.forwardX?(()=>{const u=new Float32Array(1),d=t(c,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),p=r(c);let m=!1,f=[0,0,-1,0,1,0],g=[0,0,0];const v=()=>{if(m)return;m=!0;const e=i(c,256,9,0);e.onaudioprocess=({inputBuffer:e})=>{const t=[a(e,u,0),a(e,u,1),a(e,u,2),a(e,u,3),a(e,u,4),a(e,u,5)];t.some((e,t)=>e!==f[t])&&(h.setOrientation(...t),f=t);const n=[a(e,u,6),a(e,u,7),a(e,u,8)];n.some((e,t)=>e!==g[t])&&(h.setPosition(...n),g=n)},d.connect(e)},x=e=>t=>{t!==f[e]&&(f[e]=t,h.setOrientation(...f))},y=e=>t=>{t!==g[e]&&(g[e]=t,h.setPosition(...g))},b=(t,i,a)=>{const r=n(c,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:i});r.connect(d,0,t),r.start(),Object.defineProperty(r.offset,"defaultValue",{get:()=>i});const h=e({context:l},p,r.offset,mv,pv);var u,m,f,g,x,y,b;return o(h,"value",e=>()=>e.call(h),e=>t=>{try{e.call(h,t)}catch(n){if(9!==n.code)throw n}v(),p&&a(t)}),h.cancelAndHoldAtTime=(u=h.cancelAndHoldAtTime,p?()=>{throw s()}:(...e)=>{const t=u.apply(h,e);return v(),t}),h.cancelScheduledValues=(m=h.cancelScheduledValues,p?()=>{throw s()}:(...e)=>{const t=m.apply(h,e);return v(),t}),h.exponentialRampToValueAtTime=(f=h.exponentialRampToValueAtTime,p?()=>{throw s()}:(...e)=>{const t=f.apply(h,e);return v(),t}),h.linearRampToValueAtTime=(g=h.linearRampToValueAtTime,p?()=>{throw s()}:(...e)=>{const t=g.apply(h,e);return v(),t}),h.setTargetAtTime=(x=h.setTargetAtTime,p?()=>{throw s()}:(...e)=>{const t=x.apply(h,e);return v(),t}),h.setValueAtTime=(y=h.setValueAtTime,p?()=>{throw s()}:(...e)=>{const t=y.apply(h,e);return v(),t}),h.setValueCurveAtTime=(b=h.setValueCurveAtTime,p?()=>{throw s()}:(...e)=>{const t=b.apply(h,e);return v(),t}),h};return{forwardX:b(0,0,x(0)),forwardY:b(1,0,x(1)),forwardZ:b(2,-1,x(2)),positionX:b(6,0,y(0)),positionY:b(7,0,y(1)),positionZ:b(8,0,y(2)),upX:b(3,0,x(3)),upY:b(4,1,x(4)),upZ:b(5,0,x(5))}})():h;return{get forwardX(){return u},get forwardY(){return d},get forwardZ(){return p},get positionX(){return m},get positionY(){return f},get positionZ(){return g},get upX(){return v},get upY(){return x},get upZ(){return y}}})($y,ub,vb,Sx,Mx,jx,dy,Ix),Ob=new WeakMap,Ub=((e,t,n,i,s,a)=>class extends n{constructor(n,a){super(n),this._nativeContext=n,Hg.set(this,n),i(n)&&s.set(n,new Set),this._destination=new e(this,a),this._listener=t(this,n),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(e){const t="function"==typeof e?a(this,e):null;this._nativeContext.onstatechange=t;const n=this._nativeContext.onstatechange;this._onstatechange=null!==n&&n===t?e:n}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(Ky,Lb,fy,dy,Ob,Fx),Fb=((e,t,n,i,s,a)=>(r,o)=>{const l=r.createOscillator();return cx(l,o),ux(l,o,"detune"),ux(l,o,"frequency"),void 0!==o.periodicWave?l.setPeriodicWave(o.periodicWave):lx(l,o,"type"),t(n,()=>n(r))||dx(l),t(i,()=>i(r))||a(l,r),t(s,()=>s(r))||px(l),e(r,l),l})(ky,Xx,kx,Lx,Ox,Ux),zb=((e,t,n,i,s)=>()=>{const a=new WeakMap;let r=null,o=null,l=null;return{set periodicWave(e){r=e},set start(e){o=e},set stop(e){l=e},render(c,h){const u=a.get(h);return void 0!==u?Promise.resolve(u):(async(c,h)=>{let u=n(c);const d=lv(u,h);if(!d){const e={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,periodicWave:null===r?void 0:r,type:u.type};u=t(h,e),null!==o&&u.start(o),null!==l&&u.stop(l)}return a.set(h,u),d?(await e(h,c.detune,u.detune),await e(h,c.frequency,u.frequency)):(await i(h,c.detune,u.detune),await i(h,c.frequency,u.frequency)),await s(c,h,u),u})(c,h)}}})(By,Fb,Pv,Gy,iy),Bb=((e,t,n,i,s,a,r)=>class extends e{constructor(e,r){const o=s(e),l={...Ex,...r},c=n(o,l),h=a(o),u=h?i():null,d=e.sampleRate/2;super(e,!1,c,u),this._detune=t(this,h,c.detune,153600,-153600),this._frequency=t(this,h,c.frequency,d,-d),this._nativeOscillatorNode=c,this._onended=null,this._oscillatorNodeRenderer=u,null!==this._oscillatorNodeRenderer&&void 0!==l.periodicWave&&(this._oscillatorNodeRenderer.periodicWave=l.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(e){const t="function"==typeof e?r(this,e):null;this._nativeOscillatorNode.onended=t;const n=this._nativeOscillatorNode.onended;this._onended=null!==n&&n===t?e:n}get type(){return this._nativeOscillatorNode.type}set type(e){this._nativeOscillatorNode.type=e,null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(e){this._nativeOscillatorNode.setPeriodicWave(e),null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.periodicWave=e)}start(e=0){if(this._nativeOscillatorNode.start(e),null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.start=e),"closed"!==this.context.state){iv(this);const e=()=>{this._nativeOscillatorNode.removeEventListener("ended",e),fv(this)&&av(this)};this._nativeOscillatorNode.addEventListener("ended",e)}}stop(e=0){this._nativeOscillatorNode.stop(e),null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.stop=e)}})(Sy,$y,Fb,zb,ly,dy,Fx),Vb=(Hb=Hy,(e,t)=>{const n=Hb(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=e.createBuffer(1,2,44100);return n.buffer=i,n.loop=!0,n.connect(t),n.start(),()=>{n.stop(),n.disconnect(t)}});var Hb;const Wb=((e,t,n,i,s)=>(a,{curve:r,oversample:o,...l})=>{const c=a.createWaveShaper(),h=a.createWaveShaper();cx(c,l),cx(h,l);const u=n(a,{...l,gain:1}),d=n(a,{...l,gain:-1}),p=n(a,{...l,gain:1}),m=n(a,{...l,gain:-1});let f=null,g=!1,v=null;const x={get bufferSize(){},get channelCount(){return c.channelCount},set channelCount(e){u.channelCount=e,d.channelCount=e,c.channelCount=e,p.channelCount=e,h.channelCount=e,m.channelCount=e},get channelCountMode(){return c.channelCountMode},set channelCountMode(e){u.channelCountMode=e,d.channelCountMode=e,c.channelCountMode=e,p.channelCountMode=e,h.channelCountMode=e,m.channelCountMode=e},get channelInterpretation(){return c.channelInterpretation},set channelInterpretation(e){u.channelInterpretation=e,d.channelInterpretation=e,c.channelInterpretation=e,p.channelInterpretation=e,h.channelInterpretation=e,m.channelInterpretation=e},get context(){return c.context},get curve(){return v},set curve(n){if(null!==n&&n.length<2)throw t();if(null===n)c.curve=n,h.curve=n;else{const e=n.length,t=new Float32Array(e+2-e%2),i=new Float32Array(e+2-e%2);t[0]=n[0],i[0]=-n[e-1];const s=Math.ceil((e+1)/2),a=(e+1)/2-1;for(let r=1;r<s;r+=1){const o=r/s*a,l=Math.floor(o),c=Math.ceil(o);t[r]=l===c?n[l]:(1-(o-l))*n[l]+(1-(c-o))*n[c],i[r]=l===c?-n[e-1-l]:-(1-(o-l))*n[e-1-l]-(1-(c-o))*n[e-1-c]}t[s]=e%2==1?n[s-1]:(n[s-2]+n[s-1])/2,c.curve=t,h.curve=i}v=n,g&&(i(v)&&null===f?f=e(a,u):null!==f&&(f(),f=null))},get inputs(){return[u]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return c.numberOfOutputs},get oversample(){return c.oversample},set oversample(e){c.oversample=e,h.oversample=e},addEventListener:(...e)=>u.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>u.dispatchEvent(e[0]),removeEventListener:(...e)=>u.removeEventListener(e[0],e[1],e[2])};return null!==r&&(x.curve=r instanceof Float32Array?r:new Float32Array(r)),o!==x.oversample&&(x.oversample=o),s(vx(x,p),()=>{u.connect(c).connect(p),u.connect(d).connect(h).connect(m).connect(p),g=!0,i(v)&&(f=e(a,u))},()=>{u.disconnect(c),c.disconnect(p),u.disconnect(d),d.disconnect(h),h.disconnect(m),m.disconnect(p),g=!1,null!==f&&(f(),f=null)})})(Vb,nx,yx,Px,lb),Gb=((e,t,n,i,s,a,r)=>(o,l)=>{const c=o.createWaveShaper();if(null!==a&&"webkitAudioContext"===a.name&&void 0===o.createGain().gain.automationRate)return n(o,l);cx(c,l);const h=null===l.curve||l.curve instanceof Float32Array?l.curve:new Float32Array(l.curve);if(null!==h&&h.length<2)throw t();lx(c,{curve:h},"curve"),lx(c,l,"oversample");let u=null,d=!1;return r(c,"curve",e=>()=>e.call(c),t=>n=>(t.call(c,n),d&&(i(n)&&null===u?u=e(o,c):i(n)||null===u||(u(),u=null)),n)),s(c,()=>{d=!0,i(c.curve)&&(u=e(o,c))},()=>{d=!1,null!==u&&(u(),u=null)})})(Vb,nx,Wb,Px,lb,vy,Ix),qb=((e,t,n,i,s,a,r,o,l,c)=>(h,{coneInnerAngle:u,coneOuterAngle:d,coneOuterGain:p,distanceModel:m,maxDistance:f,orientationX:g,orientationY:v,orientationZ:x,panningModel:y,positionX:b,positionY:_,positionZ:w,refDistance:S,rolloffFactor:M,...T})=>{const E=h.createPanner();if(T.channelCount>2)throw r();if("max"===T.channelCountMode)throw r();cx(E,T);const C={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},N=n(h,{...C,channelInterpretation:"speakers",numberOfInputs:6}),A=i(h,{...T,gain:1}),R=i(h,{...C,gain:1}),j=i(h,{...C,gain:0}),P=i(h,{...C,gain:0}),I=i(h,{...C,gain:0}),D=i(h,{...C,gain:0}),k=i(h,{...C,gain:0}),L=s(h,256,6,1),O=a(h,{...C,curve:new Float32Array([1,1]),oversample:"none"});let U=[g,v,x],F=[b,_,w];const z=new Float32Array(1);L.onaudioprocess=({inputBuffer:e})=>{const t=[l(e,z,0),l(e,z,1),l(e,z,2)];t.some((e,t)=>e!==U[t])&&(E.setOrientation(...t),U=t);const n=[l(e,z,3),l(e,z,4),l(e,z,5)];n.some((e,t)=>e!==F[t])&&(E.setPosition(...n),F=n)},Object.defineProperty(j.gain,"defaultValue",{get:()=>0}),Object.defineProperty(P.gain,"defaultValue",{get:()=>0}),Object.defineProperty(I.gain,"defaultValue",{get:()=>0}),Object.defineProperty(D.gain,"defaultValue",{get:()=>0}),Object.defineProperty(k.gain,"defaultValue",{get:()=>0});const B={get bufferSize(){},get channelCount(){return E.channelCount},set channelCount(e){if(e>2)throw r();A.channelCount=e,E.channelCount=e},get channelCountMode(){return E.channelCountMode},set channelCountMode(e){if("max"===e)throw r();A.channelCountMode=e,E.channelCountMode=e},get channelInterpretation(){return E.channelInterpretation},set channelInterpretation(e){A.channelInterpretation=e,E.channelInterpretation=e},get coneInnerAngle(){return E.coneInnerAngle},set coneInnerAngle(e){E.coneInnerAngle=e},get coneOuterAngle(){return E.coneOuterAngle},set coneOuterAngle(e){E.coneOuterAngle=e},get coneOuterGain(){return E.coneOuterGain},set coneOuterGain(e){if(e<0||e>1)throw t();E.coneOuterGain=e},get context(){return E.context},get distanceModel(){return E.distanceModel},set distanceModel(e){E.distanceModel=e},get inputs(){return[A]},get maxDistance(){return E.maxDistance},set maxDistance(e){if(e<0)throw new RangeError;E.maxDistance=e},get numberOfInputs(){return E.numberOfInputs},get numberOfOutputs(){return E.numberOfOutputs},get orientationX(){return R.gain},get orientationY(){return j.gain},get orientationZ(){return P.gain},get panningModel(){return E.panningModel},set panningModel(e){E.panningModel=e},get positionX(){return I.gain},get positionY(){return D.gain},get positionZ(){return k.gain},get refDistance(){return E.refDistance},set refDistance(e){if(e<0)throw new RangeError;E.refDistance=e},get rolloffFactor(){return E.rolloffFactor},set rolloffFactor(e){if(e<0)throw new RangeError;E.rolloffFactor=e},addEventListener:(...e)=>A.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>A.dispatchEvent(e[0]),removeEventListener:(...e)=>A.removeEventListener(e[0],e[1],e[2])};return u!==B.coneInnerAngle&&(B.coneInnerAngle=u),d!==B.coneOuterAngle&&(B.coneOuterAngle=d),p!==B.coneOuterGain&&(B.coneOuterGain=p),m!==B.distanceModel&&(B.distanceModel=m),f!==B.maxDistance&&(B.maxDistance=f),g!==B.orientationX.value&&(B.orientationX.value=g),v!==B.orientationY.value&&(B.orientationY.value=v),x!==B.orientationZ.value&&(B.orientationZ.value=x),y!==B.panningModel&&(B.panningModel=y),b!==B.positionX.value&&(B.positionX.value=b),_!==B.positionY.value&&(B.positionY.value=_),w!==B.positionZ.value&&(B.positionZ.value=w),S!==B.refDistance&&(B.refDistance=S),M!==B.rolloffFactor&&(B.rolloffFactor=M),1===U[0]&&0===U[1]&&0===U[2]||E.setOrientation(...U),0===F[0]&&0===F[1]&&0===F[2]||E.setPosition(...F),c(vx(B,E),()=>{A.connect(E),e(A,O,0,0),O.connect(R).connect(N,0,0),O.connect(j).connect(N,0,1),O.connect(P).connect(N,0,2),O.connect(I).connect(N,0,3),O.connect(D).connect(N,0,4),O.connect(k).connect(N,0,5),N.connect(L).connect(h.destination)},()=>{A.disconnect(E),o(A,O,0,0),O.disconnect(R),R.disconnect(N),O.disconnect(j),j.disconnect(N),O.disconnect(P),P.disconnect(N),O.disconnect(I),I.disconnect(N),O.disconnect(D),D.disconnect(N),O.disconnect(k),k.disconnect(N),N.disconnect(L),L.disconnect(h.destination)})})(Cv,nx,ub,yx,Sx,Gb,Mx,jv,jx,lb),$b=(Xb=qb,(e,t)=>{const n=e.createPanner();return void 0===n.orientationX?Xb(e,t):(cx(n,t),ux(n,t,"orientationX"),ux(n,t,"orientationY"),ux(n,t,"orientationZ"),ux(n,t,"positionX"),ux(n,t,"positionY"),ux(n,t,"positionZ"),lx(n,t,"coneInnerAngle"),lx(n,t,"coneOuterAngle"),lx(n,t,"coneOuterGain"),lx(n,t,"distanceModel"),lx(n,t,"maxDistance"),lx(n,t,"panningModel"),lx(n,t,"refDistance"),lx(n,t,"rolloffFactor"),n)});var Xb;const Yb=((e,t,n,i,s,a,r,o,l,c)=>()=>{const h=new WeakMap;let u=null;return{render(d,p){const m=h.get(p);return void 0!==m?Promise.resolve(m):(async(d,p)=>{let m=null,f=a(d);const g={channelCount:f.channelCount,channelCountMode:f.channelCountMode,channelInterpretation:f.channelInterpretation},v={...g,coneInnerAngle:f.coneInnerAngle,coneOuterAngle:f.coneOuterAngle,coneOuterGain:f.coneOuterGain,distanceModel:f.distanceModel,maxDistance:f.maxDistance,panningModel:f.panningModel,refDistance:f.refDistance,rolloffFactor:f.rolloffFactor},x=lv(f,p);if("bufferSize"in f)m=i(p,{...g,gain:1});else if(!x){const e={...v,orientationX:f.orientationX.value,orientationY:f.orientationY.value,orientationZ:f.orientationZ.value,positionX:f.positionX.value,positionY:f.positionY.value,positionZ:f.positionZ.value};f=s(p,e)}if(h.set(p,null===m?f:m),null!==m){if(null===u){if(null===r)throw new Error("Missing the native OfflineAudioContext constructor.");const e=new r(6,d.context.length,p.sampleRate),i=t(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});i.connect(e.destination),u=(async()=>{const t=await Promise.all([d.orientationX,d.orientationY,d.orientationZ,d.positionX,d.positionY,d.positionZ].map(async(t,i)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:0===i?1:0});return await o(e,t,s.offset),s}));for(let e=0;e<6;e+=1)t[e].connect(i,0,e),t[e].start(0);return c(e)})()}const e=await u,a=i(p,{...g,gain:1});await l(d,p,a);const h=[];for(let t=0;t<e.numberOfChannels;t+=1)h.push(e.getChannelData(t));let f=[h[0][0],h[1][0],h[2][0]],x=[h[3][0],h[4][0],h[5][0]],y=i(p,{...g,gain:1}),b=s(p,{...v,orientationX:f[0],orientationY:f[1],orientationZ:f[2],positionX:x[0],positionY:x[1],positionZ:x[2]});a.connect(y).connect(b.inputs[0]),b.connect(m);for(let t=128;t<e.length;t+=128){const e=[h[0][t],h[1][t],h[2][t]],n=[h[3][t],h[4][t],h[5][t]];if(e.some((e,t)=>e!==f[t])||n.some((e,t)=>e!==x[t])){f=e,x=n;const r=t/p.sampleRate;y.gain.setValueAtTime(0,r),y=i(p,{...g,gain:0}),b=s(p,{...v,orientationX:f[0],orientationY:f[1],orientationZ:f[2],positionX:x[0],positionY:x[1],positionZ:x[2]}),y.gain.setValueAtTime(1,r),a.connect(y).connect(b.inputs[0]),b.connect(m)}}return m}return x?(await e(p,d.orientationX,f.orientationX),await e(p,d.orientationY,f.orientationY),await e(p,d.orientationZ,f.orientationZ),await e(p,d.positionX,f.positionX),await e(p,d.positionY,f.positionY),await e(p,d.positionZ,f.positionZ)):(await o(p,d.orientationX,f.orientationX),await o(p,d.orientationY,f.orientationY),await o(p,d.orientationZ,f.orientationZ),await o(p,d.positionX,f.positionX),await o(p,d.positionY,f.positionY),await o(p,d.positionZ,f.positionZ)),Ev(f)?await l(d,p,f.inputs[0]):await l(d,p,f),f})(d,p)}}})(By,ub,vb,yx,$b,Pv,hy,Gy,iy,Pb),Kb=((e,t,n,i,s,a,r)=>class extends e{constructor(e,o){const l=s(e),c={...Cx,...o},h=n(l,c),u=a(l);super(e,!1,h,u?i():null),this._nativePannerNode=h,this._orientationX=t(this,u,h.orientationX,mv,pv),this._orientationY=t(this,u,h.orientationY,mv,pv),this._orientationZ=t(this,u,h.orientationZ,mv,pv),this._positionX=t(this,u,h.positionX,mv,pv),this._positionY=t(this,u,h.positionY,mv,pv),this._positionZ=t(this,u,h.positionZ,mv,pv),r(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(e){this._nativePannerNode.coneInnerAngle=e}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(e){this._nativePannerNode.coneOuterAngle=e}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(e){this._nativePannerNode.coneOuterGain=e}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(e){this._nativePannerNode.distanceModel=e}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(e){this._nativePannerNode.maxDistance=e}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(e){this._nativePannerNode.panningModel=e}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(e){this._nativePannerNode.refDistance=e}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(e){this._nativePannerNode.rolloffFactor=e}})(Sy,$y,$b,Yb,ly,dy,Jy),Zb=(e=>(t,{disableNormalization:n,imag:i,real:s})=>{const a=i instanceof Float32Array?i:new Float32Array(i),r=s instanceof Float32Array?s:new Float32Array(s),o=t.createPeriodicWave(r,a,{disableNormalization:n});if(Array.from(i).length<2)throw e();return o})(hv),Jb=((e,t,n)=>class i{constructor(i,s){const a=t(i),r=(e=>{const{imag:t,real:n}=e;return void 0===t?void 0===n?{...e,imag:[0,0],real:[0,0]}:{...e,imag:Array.from(n,()=>0),real:n}:void 0===n?{...e,imag:t,real:Array.from(t,()=>0)}:{...e,imag:t,real:n}})({...Nx,...s}),o=e(a,r);return n.add(o),o}static[Symbol.hasInstance](e){return null!==e&&"object"==typeof e&&Object.getPrototypeOf(e)===i.prototype||n.has(e)}})(Zb,ly,new WeakSet),Qb=((e,t,n,i,s,a)=>{const r=16385,o=new Float32Array([1,1]),l=Math.PI/2,c={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},h={...c,oversample:"none"},u=(e,a,u,d,p)=>{if(1===a)return((e,t,s,a)=>{const u=new Float32Array(r),d=new Float32Array(r);for(let n=0;n<r;n+=1){const e=n/16384*l;u[n]=Math.cos(e),d[n]=Math.sin(e)}const p=n(e,{...c,gain:0}),m=i(e,{...h,curve:u}),f=i(e,{...h,curve:o}),g=n(e,{...c,gain:0}),v=i(e,{...h,curve:d});return{connectGraph(){t.connect(p),t.connect(void 0===f.inputs?f:f.inputs[0]),t.connect(g),f.connect(s),s.connect(void 0===m.inputs?m:m.inputs[0]),s.connect(void 0===v.inputs?v:v.inputs[0]),m.connect(p.gain),v.connect(g.gain),p.connect(a,0,0),g.connect(a,0,1)},disconnectGraph(){t.disconnect(p),t.disconnect(void 0===f.inputs?f:f.inputs[0]),t.disconnect(g),f.disconnect(s),s.disconnect(void 0===m.inputs?m:m.inputs[0]),s.disconnect(void 0===v.inputs?v:v.inputs[0]),m.disconnect(p.gain),v.disconnect(g.gain),p.disconnect(a,0,0),g.disconnect(a,0,1)}}})(e,u,d,p);if(2===a)return((e,s,a,u)=>{const d=new Float32Array(r),p=new Float32Array(r),m=new Float32Array(r),f=new Float32Array(r),g=Math.floor(8192.5);for(let t=0;t<r;t+=1)if(t>g){const e=(t-g)/(16384-g)*l;d[t]=Math.cos(e),p[t]=Math.sin(e),m[t]=0,f[t]=1}else{const e=t/(16384-g)*l;d[t]=1,p[t]=0,m[t]=Math.cos(e),f[t]=Math.sin(e)}const v=t(e,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),x=n(e,{...c,gain:0}),y=i(e,{...h,curve:d}),b=n(e,{...c,gain:0}),_=i(e,{...h,curve:p}),w=i(e,{...h,curve:o}),S=n(e,{...c,gain:0}),M=i(e,{...h,curve:m}),T=n(e,{...c,gain:0}),E=i(e,{...h,curve:f});return{connectGraph(){s.connect(v),s.connect(void 0===w.inputs?w:w.inputs[0]),v.connect(x,0),v.connect(b,0),v.connect(S,1),v.connect(T,1),w.connect(a),a.connect(void 0===y.inputs?y:y.inputs[0]),a.connect(void 0===_.inputs?_:_.inputs[0]),a.connect(void 0===M.inputs?M:M.inputs[0]),a.connect(void 0===E.inputs?E:E.inputs[0]),y.connect(x.gain),_.connect(b.gain),M.connect(S.gain),E.connect(T.gain),x.connect(u,0,0),S.connect(u,0,0),b.connect(u,0,1),T.connect(u,0,1)},disconnectGraph(){s.disconnect(v),s.disconnect(void 0===w.inputs?w:w.inputs[0]),v.disconnect(x,0),v.disconnect(b,0),v.disconnect(S,1),v.disconnect(T,1),w.disconnect(a),a.disconnect(void 0===y.inputs?y:y.inputs[0]),a.disconnect(void 0===_.inputs?_:_.inputs[0]),a.disconnect(void 0===M.inputs?M:M.inputs[0]),a.disconnect(void 0===E.inputs?E:E.inputs[0]),y.disconnect(x.gain),_.disconnect(b.gain),M.disconnect(S.gain),E.disconnect(T.gain),x.disconnect(u,0,0),S.disconnect(u,0,0),b.disconnect(u,0,1),T.disconnect(u,0,1)}}})(e,u,d,p);throw s()};return(t,{channelCount:i,channelCountMode:r,pan:o,...l})=>{if("max"===r)throw s();const c=e(t,{...l,channelCount:1,channelCountMode:r,numberOfInputs:2}),h=n(t,{...l,channelCount:i,channelCountMode:r,gain:1}),d=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:o});let{connectGraph:p,disconnectGraph:m}=u(t,i,h,d,c);Object.defineProperty(d.gain,"defaultValue",{get:()=>0}),Object.defineProperty(d.gain,"maxValue",{get:()=>1}),Object.defineProperty(d.gain,"minValue",{get:()=>-1});const f={get bufferSize(){},get channelCount(){return h.channelCount},set channelCount(e){h.channelCount!==e&&(g&&m(),({connectGraph:p,disconnectGraph:m}=u(t,e,h,d,c)),g&&p()),h.channelCount=e},get channelCountMode(){return h.channelCountMode},set channelCountMode(e){if("clamped-max"===e||"max"===e)throw s();h.channelCountMode=e},get channelInterpretation(){return h.channelInterpretation},set channelInterpretation(e){h.channelInterpretation=e},get context(){return h.context},get inputs(){return[h]},get numberOfInputs(){return h.numberOfInputs},get numberOfOutputs(){return h.numberOfOutputs},get pan(){return d.gain},addEventListener:(...e)=>h.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>h.dispatchEvent(e[0]),removeEventListener:(...e)=>h.removeEventListener(e[0],e[1],e[2])};let g=!1;return a(vx(f,c),()=>{p(),g=!0},()=>{m(),g=!1})}})(ub,gx,yx,Gb,Mx,lb),e_=((e,t)=>(n,i)=>{const s=i.channelCountMode;if("clamped-max"===s)throw t();if(void 0===n.createStereoPanner)return e(n,i);const a=n.createStereoPanner();return cx(a,i),ux(a,i,"pan"),Object.defineProperty(a,"channelCountMode",{get:()=>s,set:e=>{if(e!==s)throw t()}}),a})(Qb,Mx),t_=((e,t,n,i,s)=>()=>{const a=new WeakMap;return{render(r,o){const l=a.get(o);return void 0!==l?Promise.resolve(l):(async(r,o)=>{let l=n(r);const c=lv(l,o);if(!c){const e={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,pan:l.pan.value};l=t(o,e)}return a.set(o,l),c?await e(o,r.pan,l.pan):await i(o,r.pan,l.pan),Ev(l)?await s(r,o,l.inputs[0]):await s(r,o,l),l})(r,o)}}})(By,e_,Pv,Gy,iy),n_=((e,t,n,i,s,a)=>class extends e{constructor(e,r){const o=s(e),l={...Ax,...r},c=n(o,l),h=a(o);super(e,!1,c,h?i():null),this._pan=t(this,h,c.pan)}get pan(){return this._pan}})(Sy,$y,e_,t_,ly,dy),i_=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,a){const r=i.get(a);return void 0!==r?Promise.resolve(r):(async(s,a)=>{let r=t(s);if(!lv(r,a)){const t={channelCount:r.channelCount,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,curve:r.curve,oversample:r.oversample};r=e(a,t)}return i.set(a,r),Ev(r)?await n(s,a,r.inputs[0]):await n(s,a,r),r})(s,a)}}})(Gb,Pv,iy),s_=((e,t,n,i,s,a,r)=>class extends e{constructor(e,t){const o=s(e),l={...Rx,...t},c=n(o,l);super(e,!0,c,a(o)?i():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=c,r(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(e){if(null===e)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(e.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=e}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(e){this._nativeWaveShaperNode.oversample=e}})(Sy,nx,Gb,i_,ly,dy,Jy),a_=null!==Zx&&Zx.isSecureContext,r_=(e=>(t,n,i)=>{Object.defineProperties(e,{currentFrame:{configurable:!0,get:()=>Math.round(t*n)},currentTime:{configurable:!0,get:()=>t}});try{return i()}finally{null!==e&&(delete e.currentFrame,delete e.currentTime)}})(Zx),o_=new WeakMap,l_=((e,t)=>n=>{let i=e.get(n);if(void 0!==i)return i;if(null===t)throw new Error("Missing the native OfflineAudioContext constructor.");return i=new t(1,1,44100),e.set(n,i),i})(o_,hy),c_=a_?((e,t,n,i,s,a,r,o,l,c,h,u,d)=>{let p=0;return(m,f,g={credentials:"omit"})=>{const v=h.get(m);if(void 0!==v&&v.has(f))return Promise.resolve();const x=c.get(m);if(void 0!==x){const e=x.get(f);if(void 0!==e)return e}const y=a(m),b=void 0===y.audioWorklet?s(f).then(([e,t])=>{const[i,s]=Kg(e,t);return n(`${i};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${s}\n})})(window,'_AWGS')`)}).then(()=>{const e=d._AWGS.pop();if(void 0===e)throw new SyntaxError;i(y.currentTime,y.sampleRate,()=>e(class{},void 0,(e,n)=>{if(""===e.trim())throw t();const i=qg.get(y);if(void 0!==i){if(i.has(e))throw t();Jg(n),Zg(n.parameterDescriptors),i.set(e,n)}else Jg(n),Zg(n.parameterDescriptors),qg.set(y,new Map([[e,n]]))},y.sampleRate,void 0,void 0))}):Promise.all([s(f),Promise.resolve(e(u,u))]).then(([[e,t],n])=>{const i=p+1;p=i;const[s,a]=Kg(e,t),c=new Blob([`${s};((AudioWorkletProcessor,registerProcessor)=>{${a}\n})(${n?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${n?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${n?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${i}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),h=URL.createObjectURL(c);return y.audioWorklet.addModule(h,g).then(()=>{if(o(y))return y;const e=r(y);return e.audioWorklet.addModule(h,g).then(()=>e)}).then(e=>{if(null===l)throw new SyntaxError;try{new l(e,`__sac${i}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(h))});return void 0===x?c.set(m,new Map([[f,b]])):x.set(f,b),b.then(()=>{const e=h.get(m);void 0===e?h.set(m,new Set([f])):e.add(f)}).finally(()=>{const e=c.get(m);void 0!==e&&e.delete(f)}),b}})(Xx,Mx,(e=>t=>new Promise((n,i)=>{if(null===e)return void i(new SyntaxError);const s=e.document.head;if(null===s)i(new SyntaxError);else{const a=e.document.createElement("script"),r=new Blob([t],{type:"application/javascript"}),o=URL.createObjectURL(r),l=e.onerror,c=()=>{e.onerror=l,URL.revokeObjectURL(o)};e.onerror=(t,n,s,a,r)=>n===o||n===e.location.href&&1===s&&1===a?(c(),i(r),!1):null!==l?l(t,n,s,a,r):void 0,a.onerror=()=>{c(),i(new SyntaxError)},a.onload=()=>{c(),n()},a.src=o,a.type="module",s.appendChild(a)}}))(Zx),r_,(h_=()=>new DOMException("","AbortError"),async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw h_()}),ly,l_,dy,wy,new WeakMap,new WeakMap,((e,t)=>async()=>{if(null===e)return!0;if(null===t)return!1;const n=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),i=new t(1,128,44100),s=URL.createObjectURL(n);let a=!1,r=!1;try{await i.audioWorklet.addModule(s);const t=new e(i,"a",{numberOfOutputs:0}),n=i.createOscillator();t.port.onmessage=()=>a=!0,t.onprocessorerror=()=>r=!0,n.connect(t),n.start(0),await i.startRendering(),await new Promise(e=>setTimeout(e))}catch{}finally{URL.revokeObjectURL(s)}return a&&!r})(wy,hy),Zx):void 0;var h_;const u_=((e,t)=>n=>e(n)||t(n))(xy,dy),d_=((e,t,n,i,s,a,r,o,l,c,h)=>(n,i)=>{const u=r(n)?n:a(n);if(s.has(i)){const e=new DOMException("","DataCloneError");return Promise.reject(e)}try{s.add(i)}catch{}return t(l,()=>l(u))?u.decodeAudioData(i).then(n=>(Zv(i).catch(()=>{}),t(o,()=>o(n))||h(n),e.add(n),n)):new Promise((t,n)=>{const s=async()=>{try{await Zv(i)}catch{}},a=e=>{n(e),s()};try{u.decodeAudioData(i,n=>{"function"!=typeof n.copyFromChannel&&(c(n),uv(n)),e.add(n),s().then(()=>t(n))},e=>{a(null===e?new DOMException("","EncodingError"):e)})}catch(r){a(r)}})})(Ey,Xx,0,0,new WeakSet,ly,u_,cv,ox,Ry,jy),p_=(m_=c_,f_=Ty,g_=Iy,v_=Yy,x_=Qy,y_=pb,b_=fb,__=yb,w_=wb,S_=d_,M_=Mb,T_=Nb,E_=Rb,C_=kb,N_=Ub,A_=Bb,R_=Kb,j_=Jb,P_=n_,I_=s_,class extends N_{constructor(e,t){super(e,t),this._nativeContext=e,this._audioWorklet=void 0===m_?void 0:{addModule:(e,t)=>m_(this,e,t)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new f_(this)}createBiquadFilter(){return new x_(this)}createBuffer(e,t,n){return new g_({length:t,numberOfChannels:e,sampleRate:n})}createBufferSource(){return new v_(this)}createChannelMerger(e=6){return new y_(this,{numberOfInputs:e})}createChannelSplitter(e=6){return new b_(this,{numberOfOutputs:e})}createConstantSource(){return new __(this)}createConvolver(){return new w_(this)}createDelay(e=1){return new M_(this,{maxDelayTime:e})}createDynamicsCompressor(){return new T_(this)}createGain(){return new E_(this)}createIIRFilter(e,t){return new C_(this,{feedback:t,feedforward:e})}createOscillator(){return new A_(this)}createPanner(){return new R_(this)}createPeriodicWave(e,t,n={disableNormalization:!1}){return new j_(this,{...n,imag:t,real:e})}createStereoPanner(){return new P_(this)}createWaveShaper(){return new I_(this)}decodeAudioData(e,t,n){return S_(this._nativeContext,e).then(e=>("function"==typeof t&&t(e),e),e=>{throw"function"==typeof n&&n(e),e})}});var m_,f_,g_,v_,x_,y_,b_,__,w_,S_,M_,T_,E_,C_,N_,A_,R_,j_,P_,I_;const D_=((e,t,n,i)=>class extends e{constructor(e,t){const s=n(e),a=((e,t)=>e.createMediaElementSource(t.mediaElement))(s,t);if(i(s))throw TypeError();super(e,!0,a,null),this._nativeMediaElementAudioSourceNode=a}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(Sy,0,ly,dy),k_=((e,t,n,i)=>class extends e{constructor(e,t){const s=n(e);if(i(s))throw new TypeError;const a=((e,t)=>{const n=e.createMediaStreamDestination();return cx(n,t),1===n.numberOfOutputs&&Object.defineProperty(n,"numberOfOutputs",{get:()=>0}),n})(s,{...rx,...t});super(e,!1,a,null),this._nativeMediaStreamAudioDestinationNode=a}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(Sy,0,ly,dy),L_=((e,t,n,i)=>class extends e{constructor(e,t){const s=n(e),a=((e,{mediaStream:t})=>{const n=t.getAudioTracks();n.sort((e,t)=>e.id<t.id?-1:e.id>t.id?1:0);const i=n.slice(0,1),s=e.createMediaStreamSource(new MediaStream(i));return Object.defineProperty(s,"mediaStream",{value:t}),s})(s,t);if(i(s))throw new TypeError;super(e,!0,a,null),this._nativeMediaStreamAudioSourceNode=a}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(Sy,0,ly,dy),O_=((e,t)=>(n,{mediaStreamTrack:i})=>{if("function"==typeof n.createMediaStreamTrackSource)return n.createMediaStreamTrackSource(i);const s=new MediaStream([i]),a=n.createMediaStreamSource(s);if("audio"!==i.kind)throw e();if(t(n))throw new TypeError;return a})(nx,dy),U_=((e,t,n)=>class extends e{constructor(e,i){const s=n(e);super(e,!0,t(s,i),null)}})(Sy,O_,ly),F_=((e,t,n,i,s,a,r,o,l)=>class extends e{constructor(e={}){if(null===l)throw new Error("Missing the native AudioContext constructor.");let t;try{t=new l(e)}catch(a){if(12===a.code&&"sampleRate is not in range"===a.message)throw n();throw a}if(null===t)throw new DOMException("","UnknownError");if(!(e=>void 0===e||"number"==typeof e||"string"==typeof e&&("balanced"===e||"interactive"===e||"playback"===e))(e.latencyHint))throw new TypeError(`The provided value '${e.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(void 0!==e.sampleRate&&t.sampleRate!==e.sampleRate)throw n();super(t,2);const{latencyHint:i}=e,{sampleRate:s}=t;if(this._baseLatency="number"==typeof t.baseLatency?t.baseLatency:"balanced"===i?512/s:"interactive"===i||void 0===i?256/s:"playback"===i?1024/s:128*Math.max(2,Math.min(128,Math.round(i*s/128)))/s,this._nativeAudioContext=t,"webkitAudioContext"===l.name?(this._nativeGainNode=t.createGain(),this._nativeOscillatorNode=t.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(t.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,"running"===t.state){this._state="suspended";const e=()=>{"suspended"===this._state&&(this._state=null),t.removeEventListener("statechange",e)};t.addEventListener("statechange",e)}}get baseLatency(){return this._baseLatency}get state(){return null!==this._state?this._state:this._nativeAudioContext.state}close(){return"closed"===this.state?this._nativeAudioContext.close().then(()=>{throw t()}):("suspended"===this._state&&(this._state=null),this._nativeAudioContext.close().then(()=>{null!==this._nativeGainNode&&null!==this._nativeOscillatorNode&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),bv(this)}))}createMediaElementSource(e){return new s(this,{mediaElement:e})}createMediaStreamDestination(){return new a(this)}createMediaStreamSource(e){return new r(this,{mediaStream:e})}createMediaStreamTrackSource(e){return new o(this,{mediaStreamTrack:e})}resume(){return"suspended"===this._state?new Promise((e,t)=>{const n=()=>{this._nativeAudioContext.removeEventListener("statechange",n),"running"===this._nativeAudioContext.state?e():this.resume().then(e,t)};this._nativeAudioContext.addEventListener("statechange",n)}):this._nativeAudioContext.resume().catch(e=>{if(void 0===e||15===e.code)throw t();throw e})}suspend(){return this._nativeAudioContext.suspend().catch(e=>{if(void 0===e)throw t();throw e})}})(p_,nx,Mx,0,D_,k_,L_,U_,vy),z_=(B_=Ob,e=>{const t=B_.get(e);if(void 0===t)throw new Error("The context has no set of AudioWorkletNodes.");return t});var B_;const V_=(H_=z_,(e,t)=>{H_(e).add(t)});var H_;const W_=(e=>(t,n,i=0,s=0)=>{const a=t[i];if(void 0===a)throw e();return Uv(n)?a.connect(n,0,s):a.connect(n,0)})(hv),G_=(e=>(t,n)=>{e(t).delete(n)})(z_),q_=(e=>(t,n=void 0,i=void 0,s=0)=>void 0===n?t.forEach(e=>e.disconnect()):"number"==typeof n?Qv(e,t,n).disconnect():Uv(n)?void 0===i?t.forEach(e=>e.disconnect(n)):void 0===s?Qv(e,t,i).disconnect(n,0):Qv(e,t,i).disconnect(n,0,s):void 0===i?t.forEach(e=>e.disconnect(n)):Qv(e,t,i).disconnect(n,0))(hv),$_=new WeakMap,X_=(Y_=$_,K_=Qg,e=>K_(Y_,e));var Y_,K_;const Z_=((e,t,n,i,s,a,r,o,l,c,h,u,d)=>(p,m,f,g)=>{if(0===g.numberOfInputs&&0===g.numberOfOutputs)throw l();const v=Array.isArray(g.outputChannelCount)?g.outputChannelCount:Array.from(g.outputChannelCount);if(v.some(e=>e<1))throw l();if(v.length!==g.numberOfOutputs)throw t();if("explicit"!==g.channelCountMode)throw l();const x=g.channelCount*g.numberOfInputs,y=v.reduce((e,t)=>e+t,0),b=void 0===f.parameterDescriptors?0:f.parameterDescriptors.length;if(x+b>6||y>6)throw l();const _=new MessageChannel,w=[],S=[];for(let e=0;e<g.numberOfInputs;e+=1)w.push(r(p,{channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1})),S.push(s(p,{channelCount:g.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:g.channelCount}));const M=[];if(void 0!==f.parameterDescriptors)for(const{defaultValue:e,maxValue:t,minValue:n,name:i}of f.parameterDescriptors){const s=a(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:void 0!==g.parameterData[i]?g.parameterData[i]:void 0===e?0:e});Object.defineProperties(s.offset,{defaultValue:{get:()=>void 0===e?0:e},maxValue:{get:()=>void 0===t?mv:t},minValue:{get:()=>void 0===n?pv:n}}),M.push(s)}const T=i(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,x+b)}),E=mx(m,p.sampleRate),C=o(p,E,x+b,Math.max(1,y)),N=s(p,{channelCount:Math.max(1,y),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,y)}),A=[];for(let e=0;e<g.numberOfOutputs;e+=1)A.push(i(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:v[e]}));for(let e=0;e<g.numberOfInputs;e+=1){w[e].connect(S[e]);for(let t=0;t<g.channelCount;t+=1)S[e].connect(T,t,e*g.channelCount+t)}const R=new Bv(void 0===f.parameterDescriptors?[]:f.parameterDescriptors.map(({name:e},t)=>{const n=M[t];return n.connect(T,0,x+t),n.start(0),[e,n.offset]}));T.connect(C);let j=g.channelInterpretation,P=null;const I=0===g.numberOfOutputs?[C]:A,D={get bufferSize(){return E},get channelCount(){return g.channelCount},set channelCount(e){throw n()},get channelCountMode(){return g.channelCountMode},set channelCountMode(e){throw n()},get channelInterpretation(){return j},set channelInterpretation(e){for(const t of w)t.channelInterpretation=e;j=e},get context(){return C.context},get inputs(){return w},get numberOfInputs(){return g.numberOfInputs},get numberOfOutputs(){return g.numberOfOutputs},get onprocessorerror(){return P},set onprocessorerror(e){"function"==typeof P&&D.removeEventListener("processorerror",P),P="function"==typeof e?e:null,"function"==typeof P&&D.addEventListener("processorerror",P)},get parameters(){return R},get port(){return _.port2},addEventListener:(...e)=>C.addEventListener(e[0],e[1],e[2]),connect:e.bind(null,I),disconnect:c.bind(null,I),dispatchEvent:(...e)=>C.dispatchEvent(e[0]),removeEventListener:(...e)=>C.removeEventListener(e[0],e[1],e[2])},k=new Map;var L,O;_.port1.addEventListener=(L=_.port1.addEventListener,(...e)=>{if("message"===e[0]){const t="function"==typeof e[1]?e[1]:"object"==typeof e[1]&&null!==e[1]&&"function"==typeof e[1].handleEvent?e[1].handleEvent:null;if(null!==t){const n=k.get(e[1]);void 0!==n?e[1]=n:(e[1]=e=>{h(p.currentTime,p.sampleRate,()=>t(e))},k.set(t,e[1]))}}return L.call(_.port1,e[0],e[1],e[2])}),_.port1.removeEventListener=(O=_.port1.removeEventListener,(...e)=>{if("message"===e[0]){const t=k.get(e[1]);void 0!==t&&(k.delete(e[1]),e[1]=t)}return O.call(_.port1,e[0],e[1],e[2])});let U=null;Object.defineProperty(_.port1,"onmessage",{get:()=>U,set:e=>{"function"==typeof U&&_.port1.removeEventListener("message",U),U="function"==typeof e?e:null,"function"==typeof U&&(_.port1.addEventListener("message",U),_.port1.start())}}),f.prototype.port=_.port1;let F=null;const z=((e,t,n,i)=>{let s=$g.get(e);void 0===s&&(s=new WeakMap,$g.set(e,s));const a=(async(e,t)=>{const n=await(e=>new Promise((t,n)=>{const{port1:i,port2:s}=new MessageChannel;i.onmessage=({data:e})=>{i.close(),s.close(),t(e)},i.onmessageerror=({data:e})=>{i.close(),s.close(),n(e)},s.postMessage(e)}))(t);return new e(n)})(n,i);return s.set(t,a),a})(p,D,f,g);z.then(e=>F=e);const B=Gv(g.numberOfInputs,g.channelCount),V=Gv(g.numberOfOutputs,v),H=void 0===f.parameterDescriptors?[]:f.parameterDescriptors.reduce((e,{name:t})=>({...e,[t]:new Float32Array(128)}),{});let W=!0;const G=()=>{g.numberOfOutputs>0&&C.disconnect(N);for(let e=0,t=0;e<g.numberOfOutputs;e+=1){const n=A[e];for(let i=0;i<v[e];i+=1)N.disconnect(n,t+i,i);t+=v[e]}},q=new Map;C.onaudioprocess=({inputBuffer:e,outputBuffer:t})=>{if(null!==F){const i=u(D);for(let s=0;s<E;s+=128){for(let t=0;t<g.numberOfInputs;t+=1)for(let n=0;n<g.channelCount;n+=1)Hv(e,B[t],n,n,s);void 0!==f.parameterDescriptors&&f.parameterDescriptors.forEach(({name:t},n)=>{Hv(e,H,t,x+n,s)});for(let e=0;e<g.numberOfInputs;e+=1)for(let t=0;t<v[e];t+=1)0===V[e][t].byteLength&&(V[e][t]=new Float32Array(128));try{const e=B.map((e,t)=>{if(i[t].size>0)return q.set(t,E/128),e;const n=q.get(t);return void 0===n?[]:(e.every(e=>e.every(e=>0===e))&&(1===n?q.delete(t):q.set(t,n-1)),e)}),n=h(p.currentTime+s/p.sampleRate,p.sampleRate,()=>F.process(e,V,H));W=n;for(let i=0,a=0;i<g.numberOfOutputs;i+=1){for(let e=0;e<v[i];e+=1)Wv(t,V[i],e,a+e,s);a+=v[i]}}catch(n){W=!1,D.dispatchEvent(new ErrorEvent("processorerror",{colno:n.colno,filename:n.filename,lineno:n.lineno,message:n.message}))}if(!W){for(let e=0;e<g.numberOfInputs;e+=1){w[e].disconnect(S[e]);for(let t=0;t<g.channelCount;t+=1)S[s].disconnect(T,t,e*g.channelCount+t)}if(void 0!==f.parameterDescriptors){const e=f.parameterDescriptors.length;for(let t=0;t<e;t+=1){const e=M[t];e.disconnect(T,0,x+t),e.stop()}}T.disconnect(C),C.onaudioprocess=null,$?G():K();break}}}};let $=!1;const X=r(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Y=()=>C.connect(X).connect(p.destination),K=()=>{C.disconnect(X),X.disconnect()};return Y(),d(D,()=>{if(W){K(),g.numberOfOutputs>0&&C.connect(N);for(let e=0,t=0;e<g.numberOfOutputs;e+=1){const n=A[e];for(let i=0;i<v[e];i+=1)N.connect(n,t+i,i);t+=v[e]}}$=!0},()=>{W&&(Y(),G()),$=!1})})(W_,hv,nx,ub,gx,vb,yx,Sx,Mx,q_,r_,X_,lb),J_=((e,t,n,i,s)=>(a,r,o,l,c,h)=>{if(null!==o)try{const t=new o(a,l,h),i=new Map;let r=null;if(Object.defineProperties(t,{channelCount:{get:()=>h.channelCount,set:()=>{throw e()}},channelCountMode:{get:()=>"explicit",set:()=>{throw e()}},onprocessorerror:{get:()=>r,set:e=>{"function"==typeof r&&t.removeEventListener("processorerror",r),r="function"==typeof e?e:null,"function"==typeof r&&t.addEventListener("processorerror",r)}}}),t.addEventListener=(d=t.addEventListener,(...e)=>{if("processorerror"===e[0]){const t="function"==typeof e[1]?e[1]:"object"==typeof e[1]&&null!==e[1]&&"function"==typeof e[1].handleEvent?e[1].handleEvent:null;if(null!==t){const n=i.get(e[1]);void 0!==n?e[1]=n:(e[1]=n=>{"error"===n.type?(Object.defineProperties(n,{type:{value:"processorerror"}}),t(n)):t(new ErrorEvent(e[0],{...n}))},i.set(t,e[1]))}}return d.call(t,"error",e[1],e[2]),d.call(t,...e)}),t.removeEventListener=(u=t.removeEventListener,(...e)=>{if("processorerror"===e[0]){const t=i.get(e[1]);void 0!==t&&(i.delete(e[1]),e[1]=t)}return u.call(t,"error",e[1],e[2]),u.call(t,e[0],e[1],e[2])}),0!==h.numberOfOutputs){const e=n(a,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return t.connect(e).connect(a.destination),s(t,()=>e.disconnect(),()=>e.connect(a.destination))}return t}catch(p){if(11===p.code)throw i();throw p}var u,d;if(void 0===c)throw i();return(e=>{const{port1:t}=new MessageChannel;try{t.postMessage(e)}finally{t.close()}})(h),t(a,r,c,h)})(nx,Z_,yx,Mx,lb),Q_=((e,t,n,i,s,a,r,o,l,c,h,u,d,p,m,f)=>(g,v,x)=>{const y=new WeakMap;let b=null;return{render(_,w){o(w,_);const S=y.get(w);return void 0!==S?Promise.resolve(S):(async(o,_)=>{let w=h(o),S=null;const M=lv(w,_),T=Array.isArray(v.outputChannelCount)?v.outputChannelCount:Array.from(v.outputChannelCount);if(null===u){const e=T.reduce((e,t)=>e+t,0),n=s(_,{channelCount:Math.max(1,e),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,e)}),a=[];for(let t=0;t<o.numberOfOutputs;t+=1)a.push(i(_,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:T[t]}));const c=r(_,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1});c.connect=t.bind(null,a),c.disconnect=l.bind(null,a),S=[n,a,c]}else M||(w=new u(_,g));if(y.set(_,null===S?w:S[2]),null!==S){if(null===b){if(void 0===x)throw new Error("Missing the processor constructor.");if(null===d)throw new Error("Missing the native OfflineAudioContext constructor.");const e=o.channelCount*o.numberOfInputs,t=void 0===x.parameterDescriptors?0:x.parameterDescriptors.length,n=e+t,l=async()=>{const l=new d(n,128*Math.ceil(o.context.length/128),_.sampleRate),c=[],h=[];for(let e=0;e<v.numberOfInputs;e+=1)c.push(r(l,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1})),h.push(s(l,{channelCount:v.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:v.channelCount}));const u=await Promise.all(Array.from(o.parameters.values()).map(async e=>{const t=a(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:e.value});return await p(l,e,t.offset),t})),g=i(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,e+t)});for(let e=0;e<v.numberOfInputs;e+=1){c[e].connect(h[e]);for(let t=0;t<v.channelCount;t+=1)h[e].connect(g,t,e*v.channelCount+t)}for(const[t,n]of u.entries())n.connect(g,0,e+t),n.start(0);return g.connect(l.destination),await Promise.all(c.map(e=>m(o,l,e))),f(l)};b=(async(e,t,n,i,s,a,r)=>{const o=null===t?128*Math.ceil(e.context.length/128):t.length,l=i.channelCount*i.numberOfInputs,c=s.reduce((e,t)=>e+t,0),h=0===c?null:n.createBuffer(c,o,n.sampleRate);if(void 0===a)throw new Error("Missing the processor constructor.");const u=vv(e),d=await((e,t)=>{const n=Qg($g,e),i=Pv(t);return Qg(n,i)})(n,e),p=Gv(i.numberOfInputs,i.channelCount),m=Gv(i.numberOfOutputs,s),f=Array.from(e.parameters.keys()).reduce((e,t)=>({...e,[t]:new Float32Array(128)}),{});for(let v=0;v<o;v+=128){if(i.numberOfInputs>0&&null!==t)for(let e=0;e<i.numberOfInputs;e+=1)for(let n=0;n<i.channelCount;n+=1)Hv(t,p[e],n,n,v);void 0!==a.parameterDescriptors&&null!==t&&a.parameterDescriptors.forEach(({name:e},n)=>{Hv(t,f,e,l+n,v)});for(let e=0;e<i.numberOfInputs;e+=1)for(let t=0;t<s[e];t+=1)0===m[e][t].byteLength&&(m[e][t]=new Float32Array(128));try{const e=p.map((e,t)=>0===u.activeInputs[t].size?[]:e),t=r(v/n.sampleRate,n.sampleRate,()=>d.process(e,m,f));if(null!==h)for(let n=0,a=0;n<i.numberOfOutputs;n+=1){for(let e=0;e<s[n];e+=1)Wv(h,m[n],e,a+e,v);a+=s[n]}if(!t)break}catch(g){e.dispatchEvent(new ErrorEvent("processorerror",{colno:g.colno,filename:g.filename,lineno:g.lineno,message:g.message}));break}}return h})(o,0===n?null:await l(),_,v,T,x,c)}const e=await b,t=n(_,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[l,h,u]=S;null!==e&&(t.buffer=e,t.start(0)),t.connect(l);for(let n=0,i=0;n<o.numberOfOutputs;n+=1){const e=h[n];for(let t=0;t<T[n];t+=1)l.connect(e,i+t,t);i+=T[n]}return u}if(M)for(const[t,n]of o.parameters.entries())await e(_,n,w.parameters.get(t));else for(const[e,t]of o.parameters.entries())await p(_,t,w.parameters.get(e));return await m(o,_,w),w})(_,w)}}})(By,W_,Hy,ub,gx,vb,yx,G_,q_,r_,Pv,wy,hy,Gy,iy,Pb),ew=(tw=o_,e=>tw.get(e));var tw;const nw=(e=>(t,n)=>{e.set(t,n)})($_),iw=a_?((e,t,n,i,s,a,r,o,l,c,h,u,d,p)=>class extends t{constructor(t,h,d){var p;const m=o(t),f=l(m),g=(e=>({...e,outputChannelCount:void 0!==e.outputChannelCount?e.outputChannelCount:1===e.numberOfInputs&&1===e.numberOfOutputs?[e.channelCount]:Array.from({length:e.numberOfOutputs},()=>1)}))({...Vv,...d});(e=>{const{port1:t,port2:n}=new MessageChannel;try{t.postMessage(e)}finally{t.close(),n.close()}})(g);const v=qg.get(m),x=null==v?void 0:v.get(h),y=f||"closed"!==m.state?m:null!==(p=r(m))&&void 0!==p?p:m,b=s(y,f?null:t.baseLatency,c,h,x,g);super(t,!0,b,f?i(h,g,x):null);const _=[];b.parameters.forEach((e,t)=>{const i=n(this,f,e);_.push([t,i])}),this._nativeAudioWorkletNode=b,this._onprocessorerror=null,this._parameters=new Bv(_),f&&e(m,this);const{activeInputs:w}=a(this);u(b,w)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(e){const t="function"==typeof e?p(this,e):null;this._nativeAudioWorkletNode.onprocessorerror=t;const n=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=null!==n&&n===t?e:n}get parameters(){return null===this._parameters?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(V_,Sy,$y,Q_,J_,vv,ew,ly,dy,wy,0,nw,0,Fx):void 0,sw=((e,t)=>(n,i,s)=>{if(null===t)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(n,i,s)}catch(a){if("SyntaxError"===a.name)throw e();throw a}})(Mx,hy),aw=((e,t,n,i,s,a,r,o)=>(l,c)=>n(l).render(l,c).then(()=>Promise.all(Array.from(i(c)).map(e=>n(e).render(e,c)))).then(()=>s(c)).then(n=>("function"!=typeof n.copyFromChannel?(r(n),uv(n)):t(a,()=>a(n))||o(n),e.add(n),n)))(Ey,Xx,ty,z_,Pb,cv,Ry,jy),rw=((e,t,n,i,s)=>class extends e{constructor(e,n,s){let a;if("number"==typeof e&&void 0!==n&&void 0!==s)a={length:n,numberOfChannels:e,sampleRate:s};else{if("object"!=typeof e)throw new Error("The given parameters are not valid.");a=e}const{length:r,numberOfChannels:o,sampleRate:l}={...Tx,...a},c=i(o,r,l);t(ox,()=>ox(c))||c.addEventListener("statechange",(()=>{let e=0;const t=n=>{"running"===this._state&&(e>0?(c.removeEventListener("statechange",t),n.stopImmediatePropagation(),this._waitForThePromiseToSettle(n)):e+=1)};return t})()),super(c,o),this._length=r,this._nativeOfflineAudioContext=c,this._state=null}get length(){return void 0===this._nativeOfflineAudioContext.length?this._length:this._nativeOfflineAudioContext.length}get state(){return null===this._state?this._nativeOfflineAudioContext.state:this._state}startRendering(){return"running"===this._state?Promise.reject(n()):(this._state="running",s(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,bv(this)}))}_waitForThePromiseToSettle(e){null===this._state?this._nativeOfflineAudioContext.dispatchEvent(e):setTimeout(()=>this._waitForThePromiseToSettle(e))}})(p_,Xx,nx,sw,aw),ow=((e,t)=>n=>{const i=e.get(n);return t(i)||t(n)})(Hg,xy),lw=(cw=zg,hw=by,e=>cw.has(e)||hw(e));var cw,hw;const uw=(dw=Vg,pw=_y,e=>dw.has(e)||pw(e));var dw,pw;const mw=((e,t)=>n=>{const i=e.get(n);return t(i)||t(n)})(Hg,dy);function fw(e){return void 0===e}function gw(e){return void 0!==e}function vw(e){return"number"==typeof e}function xw(e){return"[object Object]"===Object.prototype.toString.call(e)&&e.constructor===Object}function yw(e){return Array.isArray(e)}function bw(e){return"string"==typeof e}function _w(e){return bw(e)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(e)}function ww(e,t){if(!e)throw new Error(t)}function Sw(e,t,n=1/0){if(!(t<=e&&e<=n))throw new RangeError(`Value must be within [${t}, ${n}], got: ${e}`)}function Mw(e){e.isOffline||"running"===e.state||Aw('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Tw=!1,Ew=!1;function Cw(e){Tw=e}let Nw=console;function Aw(...e){Nw.warn(...e)}const Rw="object"==typeof self?self:null,jw=Rw&&(Rw.hasOwnProperty("AudioContext")||Rw.hasOwnProperty("webkitAudioContext"));class Pw{constructor(e,t,n,i){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=n,this._createClock()}_createWorker(){const e=new Blob([`\n\t\t\t// the initial timeout time\n\t\t\tlet timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};\n\t\t\t// onmessage callback\n\t\t\tself.onmessage = function(msg){\n\t\t\t\ttimeoutTime = parseInt(msg.data);\n\t\t\t};\n\t\t\t// the tick function which posts a message\n\t\t\t// and schedules a new tick\n\t\t\tfunction tick(){\n\t\t\t\tsetTimeout(tick, timeoutTime);\n\t\t\t\tself.postMessage('tick');\n\t\t\t}\n\t\t\t// call tick initially\n\t\t\ttick();\n\t\t\t`],{type:"text/javascript"}),t=URL.createObjectURL(e),n=new Worker(t);n.onmessage=this._callback.bind(this),this._worker=n}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if("worker"===this._type)try{this._createWorker()}catch($T){this._type="timeout",this._createClock()}else"timeout"===this._type&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),"worker"===this._type&&(null===(t=this._worker)||void 0===t||t.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function Iw(e){return uw(e)}function Dw(e){return lw(e)}function kw(e){return mw(e)}function Lw(e){return ow(e)}function Ow(e,t){return"value"===e||Iw(t)||Dw(t)||function(e){return e instanceof Iy}(t)}function Uw(e,...t){if(!t.length)return e;const n=t.shift();if(xw(e)&&xw(n))for(const i in n)Ow(i,n[i])?e[i]=n[i]:xw(n[i])?(e[i]||Object.assign(e,{[i]:{}}),Uw(e[i],n[i])):Object.assign(e,{[i]:n[i]});return Uw(e,...t)}function Fw(e,t,n=[],i){const s={},a=Array.from(t);if(xw(a[0])&&i&&!Reflect.has(a[0],i)&&(Object.keys(a[0]).some(t=>Reflect.has(e,t))||(Uw(s,{[i]:a[0]}),n.splice(n.indexOf(i),1),a.shift())),1===a.length&&xw(a[0]))Uw(s,a[0]);else for(let r=0;r<n.length;r++)gw(a[r])&&(s[n[r]]=a[r]);return Uw(e,s)}function zw(e,t){return fw(e)?t:e}function Bw(e,t){return t.forEach(t=>{Reflect.has(e,t)&&delete e[t]}),e}
/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class Vw{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||Rw&&this.toString()===Rw.TONE_DEBUG_CLASS)&&function(...e){Nw.log(...e)}(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}Vw.version="15.1.22";const Hw=1e-6;function Ww(e,t){return e>t+Hw}function Gw(e,t){return Ww(e,t)||$w(e,t)}function qw(e,t){return e+Hw<t}function $w(e,t){return Math.abs(e-t)<Hw}class Xw extends Vw{constructor(){super(),this.name="Timeline",this._timeline=[];const e=Fw(Xw.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(ww(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];ww(Gw(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const e=this.length-this.memory;this._timeline.splice(0,e)}return this}remove(e){const t=this._timeline.indexOf(e);return-1!==t&&this._timeline.splice(t,1),this}get(e,t="time"){const n=this._search(e,t);return-1!==n?this._timeline[n]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const n=this._search(e,t);return n+1<this._timeline.length?this._timeline[n+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const n=this._search(e);return n-1>=0?this._timeline[n-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if($w(this._timeline[t].time,e)){for(let n=t;n>=0&&$w(this._timeline[n].time,e);n--)t=n;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else 1===this._timeline.length&&Gw(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(0===this._timeline.length)return-1;let n=0;const i=this._timeline.length;let s=i;if(i>0&&this._timeline[i-1][t]<=e)return i-1;for(;n<s;){let i=Math.floor(n+(s-n)/2);const a=this._timeline[i],r=this._timeline[i+1];if($w(a[t],e)){for(let n=i;n<this._timeline.length&&$w(this._timeline[n][t],e);n++)i=n;return i}if(qw(a[t],e)&&Ww(r[t],e))return i;Ww(a[t],e)?s=i:n=i+1}return-1}_iterate(e,t=0,n=this._timeline.length-1){this._timeline.slice(t,n+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const n=this._search(e);return-1!==n&&this._iterate(t,0,n),this}forEachAfter(e,t){const n=this._search(e);return this._iterate(t,n+1),this}forEachBetween(e,t,n){let i=this._search(e),s=this._search(t);return-1!==i&&-1!==s?(this._timeline[i].time!==e&&(i+=1),this._timeline[s].time===t&&(s-=1),this._iterate(n,i,s)):-1===i&&this._iterate(n,0,s),this}forEachFrom(e,t){let n=this._search(e);for(;n>=0&&this._timeline[n].time>=e;)n--;return this._iterate(t,n+1),this}forEachAtTime(e,t){const n=this._search(e);if(-1!==n&&$w(this._timeline[n].time,e)){let i=n;for(let t=n;t>=0&&$w(this._timeline[t].time,e);t--)i=t;this._iterate(e=>{t(e)},i,n)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Yw=[];function Kw(e){Yw.push(e)}const Zw=[];function Jw(e){Zw.push(e)}class Qw extends Vw{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(e=>{fw(this._events)&&(this._events={}),this._events.hasOwnProperty(e)||(this._events[e]=[]),this._events[e].push(t)}),this}once(e,t){const n=(...i)=>{t(...i),this.off(e,n)};return this.on(e,n),this}off(e,t){return e.split(/\W+/).forEach(e=>{if(fw(this._events)&&(this._events={}),this._events.hasOwnProperty(e))if(fw(t))this._events[e]=[];else{const n=this._events[e];for(let e=n.length-1;e>=0;e--)n[e]===t&&n.splice(e,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const n=this._events[e].slice(0);for(let e=0,i=n.length;e<i;e++)n[e].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const n=Object.getOwnPropertyDescriptor(Qw.prototype,t);Object.defineProperty(e.prototype,t,n)})}dispose(){return super.dispose(),this._events=void 0,this}}class eS extends Qw{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class tS extends eS{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new Xw,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const n=Fw(tS.getDefaults(),arguments,["context"]);n.context?(this._context=n.context,this._latencyHint=(null===(e=arguments[0])||void 0===e?void 0:e.latencyHint)||""):(this._context=function(e){return new F_(e)}({latencyHint:n.latencyHint}),this._latencyHint=n.latencyHint),this._ticker=new Pw(this.emit.bind(this,"tick"),n.clockSource,n.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[(null===(t=arguments[0])||void 0===t?void 0:t.hasOwnProperty("updateInterval"))?"_lookAhead":"lookAhead"]=n.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var e;return this._initialized||(e=this,Yw.forEach(t=>t(e)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,n){return this._context.createBuffer(e,t,n)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,n){return this._context.createPeriodicWave(e,t,n)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return ww(Lw(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return ww(Lw(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return ww(Lw(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){ww(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){ww(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){ww(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){ww(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return function(e,t,n){return ww(gw(iw),"AudioWorkletNode only works in a secure context (https or localhost)"),new(e instanceof(null==Rw?void 0:Rw.BaseAudioContext)?null==Rw?void 0:Rw.AudioWorkletNode:iw)(e,t,n)}(this.rawContext,e,t)}addAudioWorkletModule(e){return m(this,void 0,void 0,function*(){ww(gw(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return m(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return Lw(this._context)?this._context.resume():Promise.resolve()}close(){return m(this,void 0,void 0,function*(){var e;Lw(this._context)&&"closed"!==this.state&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(e=this,Zw.forEach(t=>t(e)))})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),n=t.getChannelData(0);for(let s=0;s<n.length;s++)n[s]=e;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=t,i.loop=!0,i.start(0),this._constants.set(e,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,e=>{e.callback(),this._timeouts.remove(e)})}setTimeout(e,t){this._timeoutIds++;const n=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:n+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const n=++this._timeoutIds,i=()=>{const s=this.now();this._timeouts.add({callback:()=>{e(),i()},id:n,time:s+t})};return i(),n}}function nS(e,t){yw(t)?t.forEach(t=>nS(e,t)):Object.defineProperty(e,t,{enumerable:!0,writable:!1})}function iS(e,t){yw(t)?t.forEach(t=>iS(e,t)):Object.defineProperty(e,t,{writable:!0})}const sS=()=>{};class aS extends Vw{constructor(){super(),this.name="ToneAudioBuffer",this.onload=sS;const e=Fw(aS.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,bw(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:sS,onload:sS,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:cS().sampleRate}set(e){return e instanceof aS?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return m(this,void 0,void 0,function*(){const t=aS.load(e).then(e=>{this.set(e),this.onload(this)});aS.downloads.push(t);try{yield t}finally{const e=aS.downloads.indexOf(t);aS.downloads.splice(e,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=yw(e)&&e[0].length>0,n=t?e.length:1,i=t?e[0].length:e.length,s=cS(),a=s.createBuffer(n,i,s.sampleRate),r=t||1!==n?e:[e];for(let o=0;o<n;o++)a.copyToChannel(r[o],o);return this._buffer=a,this}toMono(e){if(vw(e))this.fromArray(this.toArray(e));else{let e=new Float32Array(this.length);const t=this.numberOfChannels;for(let n=0;n<t;n++){const t=this.toArray(n);for(let n=0;n<t.length;n++)e[n]+=t[n]}e=e.map(e=>e/t),this.fromArray(e)}return this}toArray(e){if(vw(e))return this.getChannelData(e);if(1===this.numberOfChannels)return this.toArray(0);{const e=[];for(let t=0;t<this.numberOfChannels;t++)e[t]=this.getChannelData(t);return e}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){ww(this.loaded,"Buffer is not loaded");const n=Math.floor(e*this.sampleRate),i=Math.floor(t*this.sampleRate);ww(n<i,"The start time must be less than the end time");const s=i-n,a=cS().createBuffer(this.numberOfChannels,s,this.sampleRate);for(let r=0;r<this.numberOfChannels;r++)a.copyToChannel(this.getChannelData(r).subarray(n,i),r);return new aS(a)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return(new aS).fromArray(e)}static fromUrl(e){return m(this,void 0,void 0,function*(){const t=new aS;return yield t.load(e)})}static load(e){return m(this,void 0,void 0,function*(){const t=""===aS.baseUrl||aS.baseUrl.endsWith("/")?aS.baseUrl:aS.baseUrl+"/",n=yield fetch(t+e);if(!n.ok)throw new Error(`could not load url: ${e}`);const i=yield n.arrayBuffer();return yield cS().decodeAudioData(i)})}static supportsType(e){const t=e.split("."),n=t[t.length-1];return""!==document.createElement("audio").canPlayType("audio/"+n)}static loaded(){return m(this,void 0,void 0,function*(){for(yield Promise.resolve();aS.downloads.length;)yield aS.downloads[0]})}}aS.baseUrl="",aS.downloads=[];class rS extends tS{constructor(){var e,t,n;super({clockSource:"offline",context:kw(arguments[0])?arguments[0]:(e=arguments[0],t=arguments[1]*arguments[2],n=arguments[2],new rw(e,t,n)),lookAhead:0,updateInterval:kw(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=kw(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return m(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const n=Math.floor(this.sampleRate/128);e&&t%n===0&&(yield new Promise(e=>setTimeout(e,1)))}})}render(){return m(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new aS(t)})}close(){return Promise.resolve()}}const oS=new class extends eS{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,n){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,n){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return m(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}};let lS=oS;function cS(){return lS===oS&&jw&&function(e,t=!1){t&&lS.dispose(),lS=Lw(e)?new tS(e):kw(e)?new rS(e):e}(new tS),lS}function hS(e){return Math.pow(2,e/12)}Rw&&Rw.TONE_SILENCE_LOGGING;let uS=440;function dS(e){return Math.round(pS(e))}function pS(e){return 69+12*Math.log2(e/uS)}class mS extends Vw{constructor(e,t,n){super(),this.defaultUnits="s",this._val=t,this._units=n,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const n=parseInt(e,10),i="."===t?1.5:1;return 1===n?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/n)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(3*Math.floor(t)))},regexp:/^(\d+)t$/i},tr:{method:(e,t,n)=>{let i=0;return e&&"0"!==e&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&"0"!==t&&(i+=this._beatsToUnits(parseFloat(t))),n&&"0"!==n&&(i+=this._beatsToUnits(parseFloat(n)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof mS&&this.fromType(this._val),fw(this._val))return this._noArg();if(bw(this._val)&&fw(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(xw(this._val)){let e=0;for(const t in this._val)if(gw(this._val[t])){const n=this._val[t];e+=new this.constructor(this.context,t).valueOf()*n}return e}if(gw(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}return bw(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class fS extends mS{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new fS(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const n=new this.constructor(this.context,e).valueOf(),i=this.valueOf();return i+(Math.round(i/n)*n-i)*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let s=1;s<9;s++){const e=Math.pow(2,s);t.push(e+"n."),t.push(e+"n"),t.push(e+"t")}t.push("0");let n=t[0],i=new fS(this.context,t[0]).toSeconds();return t.forEach(t=>{const s=new fS(this.context,t).toSeconds();Math.abs(s-e)<Math.abs(i-e)&&(n=t,i=s)}),n}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const n=Math.floor(t/this._getTimeSignature());let i=t%1*4;t=Math.floor(t)%this._getTimeSignature();const s=i.toString();return s.length>3&&(i=parseFloat(parseFloat(s).toFixed(3))),[n,t,i].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return dS(this.toFrequency())}_now(){return this.context.now()}}class gS extends fS{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return uS}static set A4(e){!function(e){uS=e}(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return"midi"===this.defaultUnits?e:gS.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const n=vS[e.toLowerCase()]+12*(parseInt(t,10)+1);return"midi"===this.defaultUnits?n:gS.mtof(n)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,n){let i=1;return e&&"0"!==e&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&"0"!==t&&(i*=this._beatsToUnits(parseFloat(t))),n&&"0"!==n&&(i*=this._beatsToUnits(parseFloat(n)/4)),i}}})}transpose(e){return new gS(this.context,this.valueOf()*hS(e))}harmonize(e){return e.map(e=>this.transpose(e))}toMidi(){return dS(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/gS.A4);let n=Math.round(12*t)+57;const i=Math.floor(n/12);return i<0&&(n+=-12*i),xS[n%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(60*e/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return function(e){return uS*Math.pow(2,(e-69)/12)}(e)}static ftom(e){return dS(e)}}const vS={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},xS=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class yS extends fS{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class bS extends Vw{constructor(){super();const e=Fw(bS.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:cS()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return function(e){fw(e)&&Tw&&!Ew&&(Ew=!0,Aw("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}(e),new fS(this.context,e).toSeconds()}toFrequency(e){return new gS(this.context,e).toFrequency()}toTicks(e){return new yS(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(n=>{fw(e[n])&&delete t[n]}),t}get(){const e=this.constructor.getDefaults();return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const n=this[t];gw(n)&&gw(n.value)&&gw(n.setValueAtTime)?e[t]=n.value:n instanceof bS?e[t]=n._getPartialProperties(e[t]):yw(n)||vw(n)||bw(n)||"boolean"==typeof n?e[t]=n:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&gw(this[t])&&(this[t]&&gw(this[t].value)&&gw(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof bS?this[t].set(e[t]):this[t]=e[t])}),this}}class _S extends Xw{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return null!==t?t.state:this._initial}setStateAtTime(e,t,n){return Sw(t,0),this.add(Object.assign({},n,{state:e,time:t})),this}getLastState(e,t){for(let n=this._search(t);n>=0;n--){const t=this._timeline[n];if(t.state===e)return t}}getNextState(e,t){const n=this._search(t);if(-1!==n)for(let i=n;i<this._timeline.length;i++){const t=this._timeline[i];if(t.state===e)return t}}}class wS extends bS{constructor(){const e=Fw(wS.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,ww(gw(e.param)&&(Iw(e.param)||e.param instanceof wS),"param must be an AudioParam");!Iw(e.param);)e.param=e.param._param;this._swappable=!!gw(e.swappable)&&e.swappable,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new Xw(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,gw(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(bS.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return gw(this._minValue)?this._minValue:"time"===this.units||"frequency"===this.units||"normalRange"===this.units||"positive"===this.units||"transportTime"===this.units||"ticks"===this.units||"bpm"===this.units||"hertz"===this.units||"samples"===this.units?0:"audioRange"===this.units?-1:"decibels"===this.units?-1/0:this._param.minValue}get maxValue(){return gw(this._maxValue)?this._maxValue:"normalRange"===this.units||"audioRange"===this.units?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return gw(this.maxValue)&&gw(this.minValue)&&Sw(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?(t=e,Math.pow(10,t/20)):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e;var t}_toType(e){return this.convert&&"decibels"===this.units?(t=e,Math.log(t)/Math.LN10*20):e;var t}setValueAtTime(e,t){const n=this.toSeconds(t),i=this._fromType(e);return ww(isFinite(i)&&isFinite(n),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",e,n),this._events.add({time:n,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,n),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),n=this._events.getAfter(t),i=this._events.get(t);let s=this._initialValue;if(null===i)s=this._initialValue;else if("setTargetAtTime"!==i.type||null!==n&&"setValueAtTime"!==n.type)if(null===n)s=i.value;else if("linearRampToValueAtTime"===n.type||"exponentialRampToValueAtTime"===n.type){let e=i.value;if("setTargetAtTime"===i.type){const t=this._events.getBefore(i.time);e=null===t?this._initialValue:t.value}s="linearRampToValueAtTime"===n.type?this._linearInterpolate(i.time,e,n.time,n.value,t):this._exponentialInterpolate(i.time,e,n.time,n.value,t)}else s=i.value;else{const e=this._events.getBefore(i.time);let n;n=null===e?this._initialValue:e.value,"setTargetAtTime"===i.type&&(s=this._exponentialApproach(i.time,n,i.value,i.constant,t))}return this._toType(s)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),0===this._fromType(t)&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const n=this._fromType(e),i=this.toSeconds(t);return ww(isFinite(n)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(n),this._events.add({time:i,type:"linearRampToValueAtTime",value:n}),this.log(this.units,"linearRampToValueAtTime",e,i),this._param.linearRampToValueAtTime(n,i),this}exponentialRampToValueAtTime(e,t){let n=this._fromType(e);n=$w(n,0)?this._minOutput:n,this._assertRange(n);const i=this.toSeconds(t);return ww(isFinite(n)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:n}),this.log(this.units,"exponentialRampToValueAtTime",e,i),this._param.exponentialRampToValueAtTime(n,i),this}exponentialRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialRampToValueAtTime(e,n+this.toSeconds(t)),this}linearRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.linearRampToValueAtTime(e,n+this.toSeconds(t)),this}targetRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialApproachValueAtTime(e,n,t),this}exponentialApproachValueAtTime(e,t,n){t=this.toSeconds(t),n=this.toSeconds(n);const i=Math.log(n+1)/Math.log(200);return this.setTargetAtTime(e,t,i),this.cancelAndHoldAtTime(t+.9*n),this.linearRampToValueAtTime(e,t+n),this}setTargetAtTime(e,t,n){const i=this._fromType(e);ww(isFinite(n)&&n>0,"timeConstant must be a number greater than 0");const s=this.toSeconds(t);return this._assertRange(i),ww(isFinite(i)&&isFinite(s),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:n,time:s,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",e,s,n),this._param.setTargetAtTime(i,s,n),this}setValueCurveAtTime(e,t,n,i=1){n=this.toSeconds(n),t=this.toSeconds(t);const s=this._fromType(e[0])*i;this.setValueAtTime(this._toType(s),t);const a=n/(e.length-1);for(let r=1;r<e.length;r++){const n=this._fromType(e[r])*i;this.linearRampToValueAtTime(this._toType(n),t+r*a)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return ww(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),n=this._fromType(this.getValueAtTime(t));ww(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+n);const i=this._events.get(t),s=this._events.getAfter(t);return i&&$w(i.time,t)?s?(this._param.cancelScheduledValues(s.time),this._events.cancel(s.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):s&&(this._param.cancelScheduledValues(s.time),this._events.cancel(s.time),"linearRampToValueAtTime"===s.type?this.linearRampToValueAtTime(this._toType(n),t):"exponentialRampToValueAtTime"===s.type&&this.exponentialRampToValueAtTime(this._toType(n),t)),this._events.add({time:t,type:"setValueAtTime",value:n}),this._param.setValueAtTime(n,t),this}rampTo(e,t=.1,n){return"frequency"===this.units||"bpm"===this.units||"decibels"===this.units?this.exponentialRampTo(e,t,n):this.linearRampTo(e,t,n),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const n=this._events.get(t);if(n&&"setTargetAtTime"===n.type){const i=this._events.getAfter(n.time),s=i?i.time:t+2,a=(s-t)/10;for(let n=t;n<s;n+=a)e.linearRampToValueAtTime(this.getValueAtTime(n),n)}return this._events.forEachAfter(this.context.currentTime,t=>{"cancelScheduledValues"===t.type?e.cancelScheduledValues(t.time):"setTargetAtTime"===t.type?e.setTargetAtTime(t.value,t.time,t.constant):e[t.type](t.value,t.time)}),this}setParam(e){ww(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,n,i,s){return n+(t-n)*Math.exp(-(s-e)/i)}_linearInterpolate(e,t,n,i,s){return t+(s-e)/(n-e)*(i-t)}_exponentialInterpolate(e,t,n,i,s){return t*Math.pow(i/t,(s-e)/(n-e))}}class SS extends bS{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return gw(this.input)?Iw(this.input)||this.input instanceof wS?1:this.input.numberOfInputs:0}get numberOfOutputs(){return gw(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return gw(e)&&(e instanceof SS||Dw(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(t=>{t.channelCount=e.channelCount,t.channelCountMode=e.channelCountMode,t.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();ww(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,n=0){return TS(this,e,t,n),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Aw("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,n=0){return function(e,t,n=0,i=0){if(gw(t))for(;t instanceof SS;)t=t.input;for(;!Dw(e);)gw(e.output)&&(e=e.output);Iw(t)?e.disconnect(t,n):Dw(t)?e.disconnect(t,n,i):e.disconnect()}(this,e,t,n),this}chain(...e){return MS(this,...e),this}fan(...e){return e.forEach(e=>this.connect(e)),this}dispose(){return super.dispose(),gw(this.input)&&(this.input instanceof SS?this.input.dispose():Dw(this.input)&&this.input.disconnect()),gw(this.output)&&(this.output instanceof SS?this.output.dispose():Dw(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function MS(...e){const t=e.shift();e.reduce((e,t)=>(e instanceof SS?e.connect(t):Dw(e)&&TS(e,t),t),t)}function TS(e,t,n=0,i=0){for(ww(gw(e),"Cannot connect from undefined node"),ww(gw(t),"Cannot connect to undefined node"),(t instanceof SS||Dw(t))&&ww(t.numberOfInputs>0,"Cannot connect to node with no inputs"),ww(e.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof SS||t instanceof wS;)gw(t.input)&&(t=t.input);for(;e instanceof SS;)gw(e.output)&&(e=e.output);Iw(t)?e.connect(t,n):e.connect(t,n,i)}class ES extends SS{constructor(){const e=Fw(ES.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new wS({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),nS(this,"gain")}static getDefaults(){return Object.assign(SS.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class CS extends SS{constructor(e){super(e),this.onended=sS,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new ES({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(e){const t=this.toSeconds(e);return-1!==this._startTime&&t>=this._startTime&&(-1===this._stopTime||t<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(SS.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:sS})}_startGain(e,t=1){ww(-1===this._startTime,"Source cannot be started more than once");const n=this.toSeconds(this._fadeIn);return this._startTime=e+n,this._startTime=Math.max(this._startTime,this.context.currentTime),n>0?(this._gainNode.gain.setValueAtTime(0,e),"linear"===this._curve?this._gainNode.gain.linearRampToValueAtTime(t,e+n):this._gainNode.gain.exponentialApproachValueAtTime(t,e,n)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){ww(-1!==this._startTime,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?"linear"===this._curve?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const e="exponential"===this._curve?2*t:0;this._stopSource(this.now()+e),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==sS&&(this.onended(this),this.onended=sS,!this.context.isOffline)){const e=()=>this.dispose();"undefined"!=typeof requestIdleCallback?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),ww(-1!==this._startTime,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=sS,this}}class NS extends CS{constructor(){const e=Fw(NS.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),TS(this._source,this._gainNode),this.offset=new wS({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(CS.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),"started"===this.state&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class AS extends SS{constructor(){const e=Fw(AS.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new NS({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(SS.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,n=0){return RS(this,e,t,n),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,n){return this._param.exponentialRampTo(e,t,n),this}linearRampTo(e,t,n){return this._param.linearRampTo(e,t,n),this}targetRampTo(e,t,n){return this._param.targetRampTo(e,t,n),this}exponentialApproachValueAtTime(e,t,n){return this._param.exponentialApproachValueAtTime(e,t,n),this}setTargetAtTime(e,t,n){return this._param.setTargetAtTime(e,t,n),this}setValueCurveAtTime(e,t,n,i){return this._param.setValueCurveAtTime(e,t,n,i),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,n){return this._param.rampTo(e,t,n),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function RS(e,t,n,i){(t instanceof wS||Iw(t)||t instanceof AS&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof AS&&(t.overridden=!0)),TS(e,t,n,i)}class jS extends wS{constructor(){const e=Fw(jS.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new Xw(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(wS.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,n){t=this.toSeconds(t),this.setRampPoint(t);const i=this._fromType(e),s=this._events.get(t),a=Math.round(Math.max(1/n,1));for(let r=0;r<=a;r++){const e=n*r+t,a=this._exponentialApproach(s.time,s.value,i,n,e);this.linearRampToValueAtTime(this._toType(a),e)}return this}setValueAtTime(e,t){const n=this.toSeconds(t);super.setValueAtTime(e,t);const i=this._events.get(n),s=this._events.previousEvent(i),a=this._getTicksUntilEvent(s,n);return i.ticks=Math.max(a,0),this}linearRampToValueAtTime(e,t){const n=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const i=this._events.get(n),s=this._events.previousEvent(i),a=this._getTicksUntilEvent(s,n);return i.ticks=Math.max(a,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const n=this._fromType(e),i=this._events.get(t),s=Math.round(Math.max(10*(t-i.time),1)),a=(t-i.time)/s;for(let r=0;r<=s;r++){const e=a*r+i.time,s=this._exponentialInterpolate(i.time,i.value,t,n,e);this.linearRampToValueAtTime(this._toType(s),e)}return this}_getTicksUntilEvent(e,t){if(null===e)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(fw(e.ticks)){const t=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(t,e.time)}const n=this._fromType(this.getValueAtTime(e.time));let i=this._fromType(this.getValueAtTime(t));const s=this._events.get(t);return s&&s.time===t&&"setValueAtTime"===s.type&&(i=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(n+i)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),n=this._events.get(t);return Math.max(this._getTicksUntilEvent(n,t),0)}getDurationOfTicks(e,t){const n=this.toSeconds(t),i=this.getTicksAtTime(t);return this.getTimeOfTick(i+e)-n}getTimeOfTick(e){const t=this._events.get(e,"ticks"),n=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&n&&"linearRampToValueAtTime"===n.type&&t.value!==n.value){const i=this._fromType(this.getValueAtTime(t.time)),s=(this._fromType(this.getValueAtTime(n.time))-i)/(n.time-t.time),a=Math.sqrt(Math.pow(i,2)-2*s*(t.ticks-e)),r=(-i+a)/s;return(r>0?r:(-i-a)/s)+t.time}return t?0===t.value?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const n=this.toSeconds(t),i=this.toSeconds(e),s=this.getTicksAtTime(n);return this.getTicksAtTime(n+i)-s}_fromType(e){return"bpm"===this.units&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return"bpm"===this.units&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class PS extends AS{constructor(){const e=Fw(PS.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new jS({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(AS.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class IS extends bS{constructor(){const e=Fw(IS.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new _S,this._tickOffset=new Xw,this._ticksAtTime=new Xw,this._secondsAtTime=new Xw,this.frequency=new PS({context:this.context,units:e.units,value:e.frequency}),nS(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},bS.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const n=this.toSeconds(e);return"started"!==this._state.getValueAtTime(n)&&(this._state.setStateAtTime("started",n),gw(t)&&this.setTicksAtTime(t,n),this._ticksAtTime.cancel(n),this._secondsAtTime.cancel(n)),this}stop(e){const t=this.toSeconds(e);if("stopped"===this._state.getValueAtTime(t)){const e=this._state.get(t);e&&e.time>0&&(this._tickOffset.cancel(e.time),this._state.cancel(e.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return"started"===this._state.getValueAtTime(t)&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),n=this._state.getLastState("stopped",t),i=this._ticksAtTime.get(t),s={state:"paused",time:t};this._state.add(s);let a=i||n,r=i?i.ticks:0,o=null;return this._state.forEachBetween(a.time,t+this.sampleTime,e=>{let t=a.time;const n=this._tickOffset.get(e.time);n&&n.time>=a.time&&(r=n.ticks,t=n.time),"started"===a.state&&"started"!==e.state&&(r+=this.frequency.getTicksAtTime(e.time)-this.frequency.getTicksAtTime(t),e.time!==s.time&&(o={state:e.state,time:e.time,ticks:r})),a=e}),this._state.remove(s),o&&this._ticksAtTime.add(o),r}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),n=this.frequency.timeToTicks(e,t);this.setTicksAtTime(n,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),n={state:"paused",time:e};this._state.add(n);const i=this._secondsAtTime.get(e);let s=i||t,a=i?i.seconds:0,r=null;return this._state.forEachBetween(s.time,e+this.sampleTime,e=>{let t=s.time;const i=this._tickOffset.get(e.time);i&&i.time>=s.time&&(a=i.seconds,t=i.time),"started"===s.state&&"started"!==e.state&&(a+=e.time-t,e.time!==n.time&&(r={state:e.state,time:e.time,seconds:a})),s=e}),this._state.remove(n),r&&this._secondsAtTime.add(r),a}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const n=this._tickOffset.get(t),i=this._state.get(t),s=Math.max(n.time,i.time),a=this.frequency.getTicksAtTime(s)+e-n.ticks;return this.frequency.getTimeOfTick(a)}forEachTickBetween(e,t,n){let i=this._state.get(e);this._state.forEachBetween(e,t,t=>{i&&"started"===i.state&&"started"!==t.state&&this.forEachTickBetween(Math.max(i.time,e),t.time-this.sampleTime,n),i=t});let s=null;if(i&&"started"===i.state){const a=Math.max(i.time,e),r=this.frequency.getTicksAtTime(a),o=r-this.frequency.getTicksAtTime(i.time);let l=Math.ceil(o)-o;l=$w(l,1)?0:l;let c=this.frequency.getTimeOfTick(r+l);for(;c<t;){try{n(c,Math.round(this.getTicksAtTime(c)))}catch($T){s=$T;break}c+=this.frequency.getDurationOfTicks(1,c)}}if(s)throw s;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class DS extends bS{constructor(){const e=Fw(DS.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=sS,this._lastUpdate=0,this._state=new _S("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new IS({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,nS(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(bS.getDefaults(),{callback:sS,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){Mw(this.context);const n=this.toSeconds(e);return this.log("start",n),"started"!==this._state.getValueAtTime(n)&&(this._state.setStateAtTime("started",n),this._tickSource.start(n,t),n<this._lastUpdate&&this.emit("start",n,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return"started"===this._state.getValueAtTime(t)&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const n=this.toSeconds(t),i=this.getTicksAtTime(n);return this._tickSource.getTimeOfTick(i+e,n)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,e=>{switch(e.state){case"started":const t=this._tickSource.getTicksAtTime(e.time);this.emit("start",e.time,t);break;case"stopped":0!==e.time&&this.emit("stop",e.time);break;case"paused":this.emit("pause",e.time)}}),this._tickSource.forEachTickBetween(e,t,(e,t)=>{this.callback(e,t)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Qw.mixin(DS);class kS extends SS{constructor(){const e=Fw(kS.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new ES({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,nS(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(SS.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class LS extends SS{constructor(){const e=Fw(LS.getDefaults(),arguments);super(e),this.name="Destination",this.input=new kS({context:this.context}),this.output=new ES({context:this.context}),this.volume=this.input.volume,MS(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(SS.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),MS(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}Kw(e=>{e.destination=new LS({context:e})}),Jw(e=>{e.destination.dispose()});class OS extends SS{constructor(){super(...arguments),this.name="Listener",this.positionX=new wS({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new wS({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new wS({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new wS({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new wS({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new wS({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new wS({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new wS({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new wS({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(SS.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}Kw(e=>{e.listener=new OS({context:e})}),Jw(e=>{e.listener.dispose()});class US extends Vw{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=Fw(US.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const n=e.urls[t];this.add(t,n,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:sS,onload:sS,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return ww(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,0===this._loadingCount&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,n=sS,i=sS){return bw(t)?(this.baseUrl&&"data:audio/"===t.trim().substring(0,11).toLowerCase()&&(this.baseUrl=""),this._buffers.set(e.toString(),new aS(this.baseUrl+t,n,i))):this._buffers.set(e.toString(),new aS(t,n,i)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class FS extends yS{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class zS extends bS{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new Xw,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),1===this._events.length&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}Kw(e=>{e.draw=new zS({context:e})}),Jw(e=>{e.draw.dispose()});class BS extends Vw{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){ww(gw(e.time),"Events must have a time property"),ww(gw(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new VS(e.time,e.time+e.duration,e);for(null===this._root?this._root=t:this._root.insert(t),this._length++;null!==t;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(null!==this._root){const t=[];this._root.search(e.time,t);for(const n of t)if(n.event===e){this._removeNode(n),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,e=>this.remove(e)),this}_setRoot(e){this._root=e,null!==this._root&&(this._root.parent=null)}_replaceNodeInParent(e,t){null!==e.parent?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(null===e.left&&null===e.right)this._replaceNodeInParent(e,null);else if(null===e.right)this._replaceNodeInParent(e,e.left);else if(null===e.left)this._replaceNodeInParent(e,e.right);else{let t,n=null;if(e.getBalance()>0)if(null===e.left.right)t=e.left,t.right=e.right,n=t;else{for(t=e.left.right;null!==t.right;)t=t.right;t.parent&&(t.parent.right=t.left,n=t.parent,t.left=e.left,t.right=e.right)}else if(null===e.right.left)t=e.right,t.left=e.left,n=t;else{for(t=e.right.left;null!==t.left;)t=t.left;t.parent&&(t.parent.left=t.right,n=t.parent,t.left=e.left,t.right=e.right)}null!==e.parent?e.isLeftChild()?e.parent.left=t:e.parent.right=t:this._setRoot(t),n&&this._rebalance(n)}e.dispose()}_rotateLeft(e){const t=e.parent,n=e.isLeftChild(),i=e.right;i&&(e.right=i.left,i.left=e),null!==t?n?t.left=i:t.right=i:this._setRoot(i)}_rotateRight(e){const t=e.parent,n=e.isLeftChild(),i=e.left;i&&(e.left=i.right,i.right=e),null!==t?n?t.left=i:t.right=i:this._setRoot(i)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(null!==this._root){const t=[];if(this._root.search(e,t),t.length>0){let e=t[0];for(let n=1;n<t.length;n++)t[n].low>e.low&&(e=t[n]);return e.event}}return null}forEach(e){if(null!==this._root){const t=[];this._root.traverse(e=>t.push(e)),t.forEach(t=>{t.event&&e(t.event)})}return this}forEachAtTime(e,t){if(null!==this._root){const n=[];this._root.search(e,n),n.forEach(e=>{e.event&&t(e.event)})}return this}forEachFrom(e,t){if(null!==this._root){const n=[];this._root.searchAfter(e,n),n.forEach(e=>{e.event&&t(e.event)})}return this}dispose(){return super.dispose(),null!==this._root&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class VS{constructor(e,t,n){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=n,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?null===this.left?this.left=e:this.left.insert(e):null===this.right?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(null!==this.left&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),this.low>e||null!==this.right&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),null!==this.left&&this.left.searchAfter(e,t)),null!==this.right&&this.right.searchAfter(e,t)}traverse(e){e(this),null!==this.left&&this.left.traverse(e),null!==this.right&&this.right.traverse(e)}updateHeight(){null!==this.left&&null!==this.right?this.height=Math.max(this.left.height,this.right.height)+1:null!==this.right?this.height=this.right.height+1:null!==this.left?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,null!==this.left&&(this.max=Math.max(this.max,this.left.max)),null!==this.right&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return null!==this.left&&null!==this.right?e=this.left.height-this.right.height:null!==this.left?e=this.left.height+1:null!==this.right&&(e=-(this.right.height+1)),e}isLeftChild(){return null!==this.parent&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,null!==e&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,null!==e&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class HS extends Vw{constructor(e){super(),this.name="TimelineValue",this._timeline=new Xw({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class WS extends SS{constructor(){super(Fw(WS.getDefaults(),arguments,["context"]))}connect(e,t=0,n=0){return RS(this,e,t,n),this}}class GS extends WS{constructor(){const e=Fw(GS.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,yw(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):"function"==typeof e.mapping&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(AS.getDefaults(),{length:1024})}setMap(e,t=1024){const n=new Float32Array(t);for(let i=0,s=t;i<s;i++){const t=i/(s-1)*2-1;n[i]=e(t,i)}return this.curve=n,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){ww(["none","2x","4x"].some(t=>t.includes(e)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class qS extends WS{constructor(){const e=Fw(qS.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new GS({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(WS.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class $S{constructor(e,t){this.id=$S._eventId++,this._remainderTime=0;const n=Object.assign($S.getDefaults(),t);this.transport=e,this.callback=n.callback,this._once=n.once,this.time=Math.floor(n.time),this._remainderTime=n.time-this.time}static getDefaults(){return{callback:sS,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}$S._eventId=0;class XS extends $S{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const n=Object.assign(XS.getDefaults(),t);this.duration=n.duration,this._interval=n.interval,this._nextTick=n.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},$S.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return qw(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new FS(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){qw(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new FS(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);Ww(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class YS extends bS{constructor(){const e=Fw(YS.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new HS(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new Xw,this._repeatedEvents=new BS,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new DS({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),nS(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(bS.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(2*this._swingTicks)!=0){const n=t%(2*this._swingTicks)/(2*this._swingTicks),i=Math.sin(n*Math.PI)*this._swingAmount;e+=new FS(this.context,2*this._swingTicks/3).toSeconds()*i}Cw(!0),this._timeline.forEachAtTime(t,t=>t.invoke(e)),Cw(!1)}schedule(e,t){const n=new $S(this,{callback:e,time:new yS(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}scheduleRepeat(e,t,n,i=1/0){const s=new XS(this,{callback:e,duration:new fS(this.context,i).toTicks(),interval:new fS(this.context,t).toTicks(),time:new yS(this.context,n).toTicks()});return this._addEvent(s,this._repeatedEvents)}scheduleOnce(e,t){const n=new $S(this,{callback:e,once:!0,time:new yS(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,e=>this.clear(e.id)),this._repeatedEvents.forEachFrom(t,e=>this.clear(e.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new FS(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){let n;return this.context.resume(),gw(t)&&(n=this.toTicks(t)),this._clock.start(e,n),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),"started"!==this._clock.getStateAtTime(e)?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){yw(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new fS(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new fS(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new FS(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new FS(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),n=this._clock.frequency.timeToTicks(e,t);this.ticks=n}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if("started"===this.state){const n=this._clock.getTicksAtTime(t),i=t+this._clock.frequency.getDurationOfTicks(Math.ceil(n)-n,t);this.emit("stop",i),this._clock.setTicksAtTime(e,i),this.emit("start",i,this._clock.getSecondsAtTime(i))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),"started"!==this.state)return 0;{const t=this.now(),n=e-this.getTicksAtTime(t)%e;return this._clock.nextTickTime(n,t)}}syncSignal(e,t){const n=this.now();let i=this.bpm,s=1/(60/i.getValueAtTime(n)/this.PPQ),a=[];if("time"===e.units){const e=1/64/s,t=new ES(e),n=new qS(-1),r=new ES(e);i.chain(t,n,r),i=r,s=1/s,a=[t,n,r]}t||(t=0!==e.getValueAtTime(n)?e.getValueAtTime(n)/s:0);const r=new ES(t);return i.connect(r),r.connect(e._param),a.push(r),this._syncedSignals.push({initial:e.value,nodes:a,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const n=this._syncedSignals[t];n.signal===e&&(n.nodes.forEach(e=>e.dispose()),n.signal.value=n.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),iS(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Qw.mixin(YS),Kw(e=>{e.transport=new YS({context:e})}),Jw(e=>{e.transport.dispose()});class KS extends SS{constructor(e){super(e),this.input=void 0,this._state=new _S("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=sS,this._syncedStop=sS,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new kS({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,nS(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(SS.getDefaults(),{mute:!1,onstop:sS,volume:0})}get state(){return this._synced?"started"===this.context.transport.state?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,n){let i=fw(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(i=this._clampToCurrentTime(i),this._synced||"started"!==this._state.getValueAtTime(i))if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const e=this._state.get(i);e&&(e.offset=this.toSeconds(zw(t,0)),e.duration=n?this.toSeconds(n):void 0);const s=this.context.transport.schedule(e=>{this._start(e,t,n)},i);this._scheduled.push(s),"started"===this.context.transport.state&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else Mw(this.context),this._start(i,t,n);else ww(Ww(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,t,n);return this}stop(e){let t=fw(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),"started"===this._state.getValueAtTime(t)||gw(this._state.getNextState("started",t))){if(this.log("stop",t),this._synced){const e=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(e)}else this._stop(t);this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,n){return e=this.toSeconds(e),"started"===this._state.getValueAtTime(e)&&(this._state.cancel(e),this._restart(e,t,n)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(Ww(t,0)){const n=this._state.get(t);if(n&&"started"===n.state&&n.time!==t){const i=t-this.toSeconds(n.time);let s;n.duration&&(s=this.toSeconds(n.duration)-i),this._start(e,this.toSeconds(n.offset)+i,s)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));"started"===this._state.getValueAtTime(t)&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=sS,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class ZS extends CS{constructor(){const e=Fw(ZS.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,TS(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new wS({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new aS(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(CS.getDefaults(),{url:new aS,loop:!1,loopEnd:0,loopStart:0,onload:sS,onerror:sS,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,n,i=1){ww(this.buffer.loaded,"buffer is either not set or not loaded");const s=this.toSeconds(e);this._startGain(s,i),t=this.loop?zw(t,this.loopStart):zw(t,0);let a=Math.max(this.toSeconds(t),0);if(this.loop){const e=this.toSeconds(this.loopEnd)||this.buffer.duration,t=this.toSeconds(this.loopStart),n=e-t;Gw(a,e)&&(a=(a-t)%n+t),$w(a,this.buffer.duration)&&(a=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,qw(a,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(s,a)),gw(n)){let e=this.toSeconds(n);e=Math.max(e,0),this.stop(s+e)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function JS(e,t){return m(this,void 0,void 0,function*(){const n=t/e.context.sampleRate,i=new rS(1,n,e.context.sampleRate);return new e.constructor(Object.assign(e.get(),{frequency:2/n,detune:0,context:i})).toDestination().start(0),(yield i.render()).getChannelData(0)})}class QS extends CS{constructor(){const e=Fw(QS.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],TS(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new wS({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new wS({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),nS(this,["frequency","detune"])}static getDefaults(){return Object.assign(CS.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),"started"===this.state&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class eM extends KS{constructor(){const e=Fw(eM.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new AS({context:this.context,units:"frequency",value:e.frequency}),nS(this,"frequency"),this.detune=new AS({context:this.context,units:"cents",value:e.detune}),nS(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&"custom"!==e.type&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(KS.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),n=new QS({context:this.context,onended:()=>this.onstop(this)});this._oscillator=n,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if("custom"===this._type)return eM._periodicWaveCache.find(e=>{return e.phase===this._phase&&(t=e.partials,n=this._partials,t.length===n.length&&t.every((e,t)=>n[t]===e));var t,n});{const e=eM._periodicWaveCache.find(e=>e.type===this._type&&e.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=-1!==["sine","square","sawtooth","triangle"].indexOf(e);if(0===this._phase&&t)this._wave=void 0,this._partialCount=0,null!==this._oscillator&&(this._oscillator.type=e);else{const t=this._getCachedPeriodicWave();if(gw(t)){const{partials:e,wave:n}=t;this._wave=n,this._partials=e,null!==this._oscillator&&this._oscillator.setPeriodicWave(this._wave)}else{const[t,n]=this._getRealImaginary(e,this._phase),i=this.context.createPeriodicWave(t,n);this._wave=i,null!==this._oscillator&&this._oscillator.setPeriodicWave(this._wave),eM._periodicWaveCache.push({imag:n,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:t,type:this._type,wave:this._wave}),eM._periodicWaveCache.length>100&&eM._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&"custom"!==this._type&&"custom"!==e?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){Sw(e,0);let t=this._type;const n=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(n&&(t=n[1]),"custom"!==this._type)this.type=0===e?t:t+e.toString();else{const t=new Float32Array(e);this._partials.forEach((e,n)=>t[n]=e),this._partials=Array.from(t),this.type=this._type}}_getRealImaginary(e,t){let n=2048;const i=new Float32Array(n),s=new Float32Array(n);let a=1;if("custom"===e){if(a=this._partials.length+1,this._partialCount=this._partials.length,n=a,0===this._partials.length)return[i,s]}else{const t=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);t?(a=parseInt(t[2],10)+1,this._partialCount=parseInt(t[2],10),e=t[1],a=Math.max(a,2),n=a):this._partialCount=0,this._partials=[]}for(let r=1;r<n;++r){const n=2/(r*Math.PI);let o;switch(e){case"sine":o=r<=a?1:0,this._partials[r-1]=o;break;case"square":o=1&r?2*n:0,this._partials[r-1]=o;break;case"sawtooth":o=n*(1&r?1:-1),this._partials[r-1]=o;break;case"triangle":o=1&r?n*n*2*(r-1>>1&1?-1:1):0,this._partials[r-1]=o;break;case"custom":o=this._partials[r-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}0!==o?(i[r]=-o*Math.sin(t*r),s[r]=o*Math.cos(t*r)):(i[r]=0,s[r]=0)}return[i,s]}_inverseFFT(e,t,n){let i=0;const s=e.length;for(let a=0;a<s;a++)i+=e[a]*Math.cos(a*n)+t[a]*Math.sin(a*n);return i}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let n=0;const i=2*Math.PI;for(let a=0;a<32;a++)n=Math.max(this._inverseFFT(e,t,a/32*i),n);return s=-this._inverseFFT(e,t,this._phase)/n,Math.max(Math.min(s,1),-1);var s}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),null!==this._oscillator&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}eM._periodicWaveCache=[];class tM extends WS{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new GS({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class nM extends AS{constructor(){const e=Fw(nM.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new ES({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(AS.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class iM extends KS{constructor(){const e=Fw(iM.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new tM({context:this.context}),this._modulationNode=new ES({context:this.context}),this._carrier=new eM({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new eM({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new nM({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),nS(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(eM.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class sM extends KS{constructor(){const e=Fw(sM.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new ES({context:this.context,gain:0}),this._carrier=new eM({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new AS({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new eM({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new nM({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new nM({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),nS(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(eM.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class aM extends KS{constructor(){const e=Fw(aM.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new ES({context:this.context,gain:0}),this._thresh=new GS({context:this.context,mapping:e=>e<=0?-1:1}),this.width=new AS({context:this.context,units:"audioRange",value:e.width}),this._triangle=new eM({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),nS(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(KS.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class rM extends KS{constructor(){const e=Fw(rM.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new AS({context:this.context,units:"frequency",value:e.frequency}),this.detune=new AS({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,nS(this,["frequency","detune"])}static getDefaults(){return Object.assign(eM.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,n=e/(this._oscillators.length-1);this._forEach((e,i)=>e.detune.value=t+n*i)}}get count(){return this._oscillators.length}set count(e){if(Sw(e,1),this._oscillators.length!==e){this._forEach(e=>e.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const n=new eM({context:this.context,volume:-6-1.1*e,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:0===t?()=>this.onstop(this):sS});"custom"===this.type&&(n.partials=this._partials),this.frequency.connect(n.frequency),this.detune.connect(n.detune),n.detune.overridden=!1,n.connect(this.output),this._oscillators[t]=n}this.spread=this._spread,"started"===this.state&&this._forEach(e=>e.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((e,t)=>e.phase=this._phase+t/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class oM extends KS{constructor(){const e=Fw(oM.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new nM({context:this.context,value:2}),this._pulse=new aM({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new eM({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),nS(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(KS.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const lM={am:iM,fat:rM,fm:sM,oscillator:eM,pulse:aM,pwm:oM};class cM extends KS{constructor(){const e=Fw(cM.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new AS({context:this.context,units:"frequency",value:e.frequency}),this.detune=new AS({context:this.context,units:"cents",value:e.detune}),nS(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(eM.getDefaults(),sM.getDefaults(),iM.getDefaults(),rM.getDefaults(),aM.getDefaults(),oM.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(e=>this._sourceType===e)&&(e=this._sourceType),e+this._oscillator.type}set type(e){"fm"===e.substr(0,2)?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):"am"===e.substr(0,2)?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):"fat"===e.substr(0,3)?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):"pwm"===e?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):"pulse"===e?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=lM[e],n=this.now();if(this._oscillator){const e=this._oscillator;e.stop(n),this.context.setTimeout(()=>e.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),"started"===this.state&&this._oscillator.start(n)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";"pwm"!==this._oscillator.type&&"pulse"!==this._oscillator.type&&(t=this._oscillator.type),"fm"===e?this.type="fm"+t:"am"===e?this.type="am"+t:"fat"===e?this.type="fat"+t:"oscillator"===e?this.type=t:"pulse"===e?this.type="pulse":"pwm"===e&&(this.type="pwm")}_getOscType(e,t){return e instanceof lM[t]}get baseType(){return this._oscillator.baseType}set baseType(e){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||"pulse"===e||"pwm"===e||(this._oscillator.baseType=e)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(e){this._getOscType(this._oscillator,"fat")&&vw(e)&&(this._oscillator.count=e)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(e){this._getOscType(this._oscillator,"fat")&&vw(e)&&(this._oscillator.spread=e)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&bw(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return m(this,arguments,void 0,function*(e=1024){return JS(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function hM(e,t=1/0){const n=new WeakMap;return function(i,s){Reflect.defineProperty(i,s,{configurable:!0,enumerable:!0,get:function(){return n.get(this)},set:function(i){Sw(i,e,t),n.set(this,i)}})}}function uM(e,t=1/0){const n=new WeakMap;return function(i,s){Reflect.defineProperty(i,s,{configurable:!0,enumerable:!0,get:function(){return n.get(this)},set:function(i){Sw(this.toSeconds(i),e,t),n.set(this,i)}})}}class dM extends KS{constructor(){const e=Fw(dM.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new aS({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(KS.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:sS,onerror:sS,playbackRate:1,reverse:!1})}load(e){return m(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=sS){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),0!==this._activeSources.size||this._synced||"started"!==this._state.getValueAtTime(this.now())||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,n){return super.start(e,t,n),this}_start(e,t,n){t=this._loop?zw(t,this._loopStart):zw(t,0);const i=this.toSeconds(t),s=n;n=zw(n,Math.max(this._buffer.duration-i,0));let a=this.toSeconds(n);a/=this._playbackRate,e=this.toSeconds(e);const r=new ZS({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(e+a),this._state.setStateAtTime("stopped",e+a,{implicitEnd:!0})),this._activeSources.add(r),this._loop&&fw(s)?r.start(e,i):r.start(e,i,a-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(e=>e.stop(t))}restart(e,t,n){return super.restart(e,t,n),this}_restart(e,t,n){var i;null===(i=[...this._activeSources].pop())||void 0===i||i.stop(e),this._start(e,t,n)}seek(e,t){const n=this.toSeconds(t);if("started"===this._state.getValueAtTime(n)){const t=this.toSeconds(e);this._stop(n),this._start(n,t)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&Sw(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&Sw(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const e=this._state.getNextState("stopped",this.now());e&&this._state.cancel(e.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),n=this._state.getNextState("stopped",t);n&&n.implicitEnd&&(this._state.cancel(n.time),this._activeSources.forEach(e=>e.cancelStop())),this._activeSources.forEach(n=>{n.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}f([uM(0)],dM.prototype,"fadeIn",void 0),f([uM(0)],dM.prototype,"fadeOut",void 0);class pM extends SS{constructor(){const e=Fw(pM.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new AS({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(SS.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(bw(e))return e;{let n;for(n in mM)if(mM[n][t]===e)return n;return e}}_setCurve(e,t,n){if(bw(n)&&Reflect.has(mM,n)){const i=mM[n];xw(i)?"_decayCurve"!==e&&(this[e]=i[t]):this[e]=i}else{if(!yw(n)||"_decayCurve"===e)throw new Error("Envelope: invalid curve: "+n);this[e]=n}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let n=this.toSeconds(this.attack);const i=this.toSeconds(this.decay),s=this.getValueAtTime(e);if(s>0&&(n=(1-s)/(1/n)),n<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if("linear"===this._attackCurve)this._sig.linearRampTo(t,n,e);else if("exponential"===this._attackCurve)this._sig.targetRampTo(t,n,e);else{this._sig.cancelAndHoldAtTime(e);let i=this._attackCurve;for(let e=1;e<i.length;e++)if(i[e-1]<=s&&s<=i[e]){i=this._attackCurve.slice(e),i[0]=s;break}this._sig.setValueCurveAtTime(i,e,n,t)}if(i&&this.sustain<1){const s=t*this.sustain,a=e+n;this.log("decay",a),"linear"===this._decayCurve?this._sig.linearRampToValueAtTime(s,i+a):this._sig.exponentialApproachValueAtTime(s,a,i)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const n=this.toSeconds(this.release);n<this.sampleTime?this._sig.setValueAtTime(0,e):"linear"===this._releaseCurve?this._sig.linearRampTo(0,n,e):"exponential"===this._releaseCurve?this._sig.targetRampTo(0,n,e):(ww(yw(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,n,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,n=1){return t=this.toSeconds(t),this.triggerAttack(t,n),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,n=0){return RS(this,e,t,n),this}asArray(){return m(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,n=new rS(1,t,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),s=i+this.toSeconds(this.release),a=.1*s,r=s+a,o=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/r,decay:t*this.toSeconds(this.decay)/r,release:t*this.toSeconds(this.release)/r,context:n}));return o._sig.toDestination(),o.triggerAttackRelease(t*(i+a)/r,0),(yield n.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}f([uM(0)],pM.prototype,"attack",void 0),f([uM(0)],pM.prototype,"decay",void 0),f([hM(0,1)],pM.prototype,"sustain",void 0),f([uM(0)],pM.prototype,"release",void 0);const mM=(()=>{const e=128;let t,n;const i=[];for(t=0;t<e;t++)i[t]=Math.sin(t/127*(Math.PI/2));const s=[];for(t=0;t<127;t++){n=t/127;const e=Math.sin(n*(2*Math.PI)*6.4-Math.PI/2)+1;s[t]=e/10+.83*n}s[127]=1;const a=[];for(t=0;t<e;t++)a[t]=Math.ceil(t/127*5)/5;const r=[];for(t=0;t<e;t++)n=t/127,r[t]=.5*(1-Math.cos(Math.PI*n));const o=[];for(t=0;t<e;t++){n=t/127;const e=4*Math.pow(n,3)+.2,i=Math.cos(e*Math.PI*2*n);o[t]=Math.abs(i*(1-n))}function l(e){const t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=1-e[n];return t}return{bounce:{In:l(o),Out:o},cosine:{In:i,Out:(c=i,c.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:s,Out:l(s)},sine:{In:r,Out:l(r)},step:{In:a,Out:l(a)}};var c})();class fM extends SS{constructor(){const e=Fw(fM.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=e=>this._original_triggerRelease(e),this._volume=this.output=new kS({context:this.context,volume:e.volume}),this.volume=this._volume.volume,nS(this,"volume")}static getDefaults(){return Object.assign(SS.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const n=this["_original_"+e]=this[e];this[e]=(...e)=>{const i=e[t],s=this.context.transport.schedule(i=>{e[t]=i,n.apply(this,e)},i);this._scheduledEvents.push(s)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,n,i){const s=this.toSeconds(n),a=this.toSeconds(t);return this.triggerAttack(e,s,i),this.triggerRelease(s+a),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class gM extends fM{constructor(){const e=Fw(gM.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(fM.getDefaults(),{detune:0,onsilence:sS,portamento:0})}triggerAttack(e,t,n=1){this.log("triggerAttack",e,t,n);const i=this.toSeconds(t);return this._triggerEnvelopeAttack(i,n),this.setNote(e,i),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const n=this.toSeconds(t),i=e instanceof gS?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(n)>.05){const e=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,e,n)}else this.frequency.setValueAtTime(i,n);return this}}f([uM(0)],gM.prototype,"portamento",void 0);class vM extends pM{constructor(){super(Fw(vM.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new ES({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class xM extends gM{constructor(){const e=Fw(xM.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new cM(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new vM(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),nS(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(gM.getDefaults(),{envelope:Object.assign(Bw(pM.getDefaults(),Object.keys(SS.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Bw(cM.getDefaults(),[...Object.keys(KS.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),0===this.envelope.sustain){const t=this.toSeconds(this.envelope.attack),n=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+t+n)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class yM extends xM{constructor(){const e=Fw(yM.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,nS(this,["oscillator","envelope"])}static getDefaults(){return Uw(gM.getDefaults(),xM.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const n=this.toSeconds(t),i=this.toFrequency(e instanceof gS?e.toFrequency():e),s=i*this.octaves;return this.oscillator.frequency.setValueAtTime(s,n),this.oscillator.frequency.exponentialRampToValueAtTime(i,n+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}f([hM(0)],yM.prototype,"octaves",void 0),f([uM(0)],yM.prototype,"pitchDecay",void 0);const bM=new Set;function _M(e){bM.add(e)}function wM(e,t){const n=`registerProcessor("${e}", ${t})`;bM.add(n)}_M('\n\t/**\n\t * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. \n\t */\n\tclass ToneAudioWorkletProcessor extends AudioWorkletProcessor {\n\n\t\tconstructor(options) {\n\t\t\t\n\t\t\tsuper(options);\n\t\t\t/**\n\t\t\t * If the processor was disposed or not. Keep alive until it\'s disposed.\n\t\t\t */\n\t\t\tthis.disposed = false;\n\t\t   \t/** \n\t\t\t * The number of samples in the processing block\n\t\t\t */\n\t\t\tthis.blockSize = 128;\n\t\t\t/**\n\t\t\t * the sample rate\n\t\t\t */\n\t\t\tthis.sampleRate = sampleRate;\n\n\t\t\tthis.port.onmessage = (event) => {\n\t\t\t\t// when it receives a dispose \n\t\t\t\tif (event.data === "dispose") {\n\t\t\t\t\tthis.disposed = true;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n'),_M("\n\t/**\n\t * Abstract class for a single input/output processor. \n\t * has a 'generate' function which processes one sample at a time\n\t */\n\tclass SingleIOProcessor extends ToneAudioWorkletProcessor {\n\n\t\tconstructor(options) {\n\t\t\tsuper(Object.assign(options, {\n\t\t\t\tnumberOfInputs: 1,\n\t\t\t\tnumberOfOutputs: 1\n\t\t\t}));\n\t\t\t/**\n\t\t\t * Holds the name of the parameter and a single value of that\n\t\t\t * parameter at the current sample\n\t\t\t * @type { [name: string]: number }\n\t\t\t */\n\t\t\tthis.params = {}\n\t\t}\n\n\t\t/**\n\t\t * Generate an output sample from the input sample and parameters\n\t\t * @abstract\n\t\t * @param input number\n\t\t * @param channel number\n\t\t * @param parameters { [name: string]: number }\n\t\t * @returns number\n\t\t */\n\t\tgenerate(){}\n\n\t\t/**\n\t\t * Update the private params object with the \n\t\t * values of the parameters at the given index\n\t\t * @param parameters { [name: string]: Float32Array },\n\t\t * @param index number\n\t\t */\n\t\tupdateParams(parameters, index) {\n\t\t\tfor (const paramName in parameters) {\n\t\t\t\tconst param = parameters[paramName];\n\t\t\t\tif (param.length > 1) {\n\t\t\t\t\tthis.params[paramName] = parameters[paramName][index];\n\t\t\t\t} else {\n\t\t\t\t\tthis.params[paramName] = parameters[paramName][0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Process a single frame of the audio\n\t\t * @param inputs Float32Array[][]\n\t\t * @param outputs Float32Array[][]\n\t\t */\n\t\tprocess(inputs, outputs, parameters) {\n\t\t\tconst input = inputs[0];\n\t\t\tconst output = outputs[0];\n\t\t\t// get the parameter values\n\t\t\tconst channelCount = Math.max(input && input.length || 0, output.length);\n\t\t\tfor (let sample = 0; sample < this.blockSize; sample++) {\n\t\t\t\tthis.updateParams(parameters, sample);\n\t\t\t\tfor (let channel = 0; channel < channelCount; channel++) {\n\t\t\t\t\tconst inputSample = input && input.length ? input[channel][sample] : 0;\n\t\t\t\t\toutput[channel][sample] = this.generate(inputSample, channel, this.params);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn !this.disposed;\n\t\t}\n\t};\n"),_M("\n\t/**\n\t * A multichannel buffer for use within an AudioWorkletProcessor as a delay line\n\t */\n\tclass DelayLine {\n\t\t\n\t\tconstructor(size, channels) {\n\t\t\tthis.buffer = [];\n\t\t\tthis.writeHead = []\n\t\t\tthis.size = size;\n\n\t\t\t// create the empty channels\n\t\t\tfor (let i = 0; i < channels; i++) {\n\t\t\t\tthis.buffer[i] = new Float32Array(this.size);\n\t\t\t\tthis.writeHead[i] = 0;\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Push a value onto the end\n\t\t * @param channel number\n\t\t * @param value number\n\t\t */\n\t\tpush(channel, value) {\n\t\t\tthis.writeHead[channel] += 1;\n\t\t\tif (this.writeHead[channel] > this.size) {\n\t\t\t\tthis.writeHead[channel] = 0;\n\t\t\t}\n\t\t\tthis.buffer[channel][this.writeHead[channel]] = value;\n\t\t}\n\n\t\t/**\n\t\t * Get the recorded value of the channel given the delay\n\t\t * @param channel number\n\t\t * @param delay number delay samples\n\t\t */\n\t\tget(channel, delay) {\n\t\t\tlet readHead = this.writeHead[channel] - Math.floor(delay);\n\t\t\tif (readHead < 0) {\n\t\t\t\treadHead += this.size;\n\t\t\t}\n\t\t\treturn this.buffer[channel][readHead];\n\t\t}\n\t}\n"),wM("feedback-comb-filter",'\n\tclass FeedbackCombFilterWorklet extends SingleIOProcessor {\n\n\t\tconstructor(options) {\n\t\t\tsuper(options);\n\t\t\tthis.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);\n\t\t}\n\n\t\tstatic get parameterDescriptors() {\n\t\t\treturn [{\n\t\t\t\tname: "delayTime",\n\t\t\t\tdefaultValue: 0.1,\n\t\t\t\tminValue: 0,\n\t\t\t\tmaxValue: 1,\n\t\t\t\tautomationRate: "k-rate"\n\t\t\t}, {\n\t\t\t\tname: "feedback",\n\t\t\t\tdefaultValue: 0.5,\n\t\t\t\tminValue: 0,\n\t\t\t\tmaxValue: 0.9999,\n\t\t\t\tautomationRate: "k-rate"\n\t\t\t}];\n\t\t}\n\n\t\tgenerate(input, channel, parameters) {\n\t\t\tconst delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);\n\t\t\tthis.delayLine.push(channel, input + delayedSample * parameters.feedback);\n\t\t\treturn delayedSample;\n\t\t}\n\t}\n');class SM extends fM{constructor(){const e=Fw(SM.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(n=>{const i=parseInt(n,10);if(ww(_w(n)||vw(i)&&isFinite(i),`url key is neither a note or midi pitch: ${n}`),_w(n)){const i=new gS(this.context,n).toMidi();t[i]=e.urls[n]}else vw(i)&&isFinite(i)&&(t[i]=e.urls[i])}),this._buffers=new US({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(fM.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:sS,onerror:sS,release:.1,urls:{}})}_findClosest(e){let t=0;for(;t<96;){if(this._buffers.has(e+t))return-t;if(this._buffers.has(e-t))return t;t++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,n=1){return this.log("triggerAttack",e,t,n),Array.isArray(e)||(e=[e]),e.forEach(e=>{const i=pS(new gS(this.context,e).toFrequency()),s=Math.round(i),a=i-s,r=this._findClosest(s),o=s-r,l=this._buffers.get(o),c=hS(r+a),h=new ZS({url:l,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:c}).connect(this.output);h.start(t,0,l.duration/c,n),yw(this._activeSources.get(s))||this._activeSources.set(s,[]),this._activeSources.get(s).push(h),h.onended=()=>{if(this._activeSources&&this._activeSources.has(s)){const e=this._activeSources.get(s),t=e.indexOf(h);-1!==t&&e.splice(t,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(e=>{const n=new gS(this.context,e).toMidi();if(this._activeSources.has(n)&&this._activeSources.get(n).length){const e=this._activeSources.get(n);t=this.toSeconds(t),e.forEach(e=>{e.stop(t)}),this._activeSources.set(n,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(e=>{for(;e.length;)e.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,n,i=1){const s=this.toSeconds(n);return this.triggerAttack(e,s,i),yw(t)?(ww(yw(e),"notes must be an array when duration is array"),e.forEach((e,n)=>{const i=t[Math.min(n,t.length-1)];this.triggerRelease(e,s+this.toSeconds(i))})):this.triggerRelease(e,s+this.toSeconds(t)),this}add(e,t,n){if(ww(_w(e)||isFinite(e),`note must be a pitch or midi: ${e}`),_w(e)){const i=new gS(this.context,e).toMidi();this._buffers.add(i,t,n)}else this._buffers.add(e,t,n);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(e=>e.dispose())}),this._activeSources.clear(),this}}f([uM(0)],SM.prototype,"attack",void 0),f([uM(0)],SM.prototype,"release",void 0);class MM extends SS{constructor(){const e=Fw(MM.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new wS({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",nS(this,"pan")}static getDefaults(){return Object.assign(SS.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}wM("bit-crusher","\n\tclass BitCrusherWorklet extends SingleIOProcessor {\n\n\t\tstatic get parameterDescriptors() {\n\t\t\treturn [{\n\t\t\t\tname: \"bits\",\n\t\t\t\tdefaultValue: 12,\n\t\t\t\tminValue: 1,\n\t\t\t\tmaxValue: 16,\n\t\t\t\tautomationRate: 'k-rate'\n\t\t\t}];\n\t\t}\n\n\t\tgenerate(input, _channel, parameters) {\n\t\t\tconst step = Math.pow(0.5, parameters.bits - 1);\n\t\t\tconst val = step * Math.floor(input / step + 0.5);\n\t\t\treturn val;\n\t\t}\n\t}\n");class TM extends SS{constructor(){const e=Fw(TM.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new ES({context:this.context}),TM._allSolos.has(this.context)||TM._allSolos.set(this.context,new Set),TM._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(SS.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),TM._allSolos.get(this.context).forEach(e=>e._updateSolo())}get muted(){return 0===this.input.gain.value}_addSolo(){TM._soloed.has(this.context)||TM._soloed.set(this.context,new Set),TM._soloed.get(this.context).add(this)}_removeSolo(){TM._soloed.has(this.context)&&TM._soloed.get(this.context).delete(this)}_isSoloed(){return TM._soloed.has(this.context)&&TM._soloed.get(this.context).has(this)}_noSolos(){return!TM._soloed.has(this.context)||TM._soloed.has(this.context)&&0===TM._soloed.get(this.context).size}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),TM._allSolos.get(this.context).delete(this),this._removeSolo(),this}}TM._allSolos=new Map,TM._soloed=new Map;class EM extends SS{constructor(){const e=Fw(EM.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new MM({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new kS({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,nS(this,["pan","volume"])}static getDefaults(){return Object.assign(SS.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class CM extends SS{constructor(){const e=Fw(CM.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new TM({solo:e.solo,context:this.context}),this._panVol=this.output=new EM({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),nS(this,["pan","volume"])}static getDefaults(){return Object.assign(SS.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return CM.buses.has(e)||CM.buses.set(e,new ES({context:this.context})),CM.buses.get(e)}send(e,t=0){const n=this._getBus(e),i=new ES({context:this.context,units:"decibels",gain:t});return this.connect(i),i.connect(n),i}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}CM.buses=new Map,cS().transport,cS().destination,cS().destination,cS().listener,cS().draw,cS();const NM={type:"change"},AM={type:"start"},RM={type:"end"},jM=new mu,PM=new lp,IM=Math.cos(70*hh),DM=new ph,kM=2*Math.PI,LM=-1,OM=1e-6;class UM extends Dp{constructor(e,t=null){super(e,t),this.state=LM,this.target=new ph,this.cursor=new ph,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2},this.touches={ONE:0,TWO:2},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new ph,this._lastQuaternion=new dh,this._lastTargetPosition=new ph,this._quat=(new dh).setFromUnitVectors(e.up,new ph(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new Ip,this._sphericalDelta=new Ip,this._scale=1,this._panOffset=new ph,this._rotateStart=new uh,this._rotateEnd=new uh,this._rotateDelta=new uh,this._panStart=new uh,this._panEnd=new uh,this._panDelta=new uh,this._dollyStart=new uh,this._dollyEnd=new uh,this._dollyDelta=new uh,this._dollyDirection=new ph,this._mouse=new uh,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=zM.bind(this),this._onPointerDown=FM.bind(this),this._onPointerUp=BM.bind(this),this._onContextMenu=XM.bind(this),this._onMouseWheel=WM.bind(this),this._onKeyDown=GM.bind(this),this._onTouchStart=qM.bind(this),this._onTouchMove=$M.bind(this),this._onMouseDown=VM.bind(this),this._onMouseMove=HM.bind(this),this._interceptControlDown=YM.bind(this),this._interceptControlUp=KM.bind(this),null!==this.domElement&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){null!==this._domElementKeyEvents&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(NM),this.update(),this.state=LM}update(e=null){const t=this.object.position;DM.copy(t).sub(this.target),DM.applyQuaternion(this._quat),this._spherical.setFromVector3(DM),this.autoRotate&&this.state===LM&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let n=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(n)&&isFinite(i)&&(n<-Math.PI?n+=kM:n>Math.PI&&(n-=kM),i<-Math.PI?i+=kM:i>Math.PI&&(i-=kM),this._spherical.theta=n<=i?Math.max(n,Math.min(i,this._spherical.theta)):this._spherical.theta>(n+i)/2?Math.max(n,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),!0===this.enableDamping?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let s=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const e=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),s=e!=this._spherical.radius}if(DM.setFromSpherical(this._spherical),DM.applyQuaternion(this._quatInverse),t.copy(this.target).add(DM),this.object.lookAt(this.target),!0===this.enableDamping?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let e=null;if(this.object.isPerspectiveCamera){const t=DM.length();e=this._clampDistance(t*this._scale);const n=t-e;this.object.position.addScaledVector(this._dollyDirection,n),this.object.updateMatrixWorld(),s=!!n}else if(this.object.isOrthographicCamera){const t=new ph(this._mouse.x,this._mouse.y,0);t.unproject(this.object);const n=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),s=n!==this.object.zoom;const i=new ph(this._mouse.x,this._mouse.y,0);i.unproject(this.object),this.object.position.sub(i).add(t),this.object.updateMatrixWorld(),e=DM.length()}else this.zoomToCursor=!1;null!==e&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(e).add(this.object.position):(jM.origin.copy(this.object.position),jM.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(jM.direction))<IM?this.object.lookAt(this.target):(PM.setFromNormalAndCoplanarPoint(this.object.up,this.target),jM.intersectPlane(PM,this.target))))}else if(this.object.isOrthographicCamera){const e=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),e!==this.object.zoom&&(this.object.updateProjectionMatrix(),s=!0)}return this._scale=1,this._performCursorZoom=!1,!!(s||this._lastPosition.distanceToSquared(this.object.position)>OM||8*(1-this._lastQuaternion.dot(this.object.quaternion))>OM||this._lastTargetPosition.distanceToSquared(this.target)>OM)&&(this.dispatchEvent(NM),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0)}_getAutoRotationAngle(e){return null!==e?kM/60*this.autoRotateSpeed*e:kM/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(.01*e);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){DM.setFromMatrixColumn(t,0),DM.multiplyScalar(-e),this._panOffset.add(DM)}_panUp(e,t){!0===this.screenSpacePanning?DM.setFromMatrixColumn(t,1):(DM.setFromMatrixColumn(t,0),DM.crossVectors(this.object.up,DM)),DM.multiplyScalar(e),this._panOffset.add(DM)}_pan(e,t){const n=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;DM.copy(i).sub(this.target);let s=DM.length();s*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*s/n.clientHeight,this.object.matrix),this._panUp(2*t*s/n.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/n.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/n.clientHeight,this.object.matrix)):this.enablePan=!1}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:this.enableZoom=!1}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:this.enableZoom=!1}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const n=this.domElement.getBoundingClientRect(),i=e-n.left,s=t-n.top,a=n.width,r=n.height;this._mouse.x=i/a*2-1,this._mouse.y=-s/r*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(kM*this._rotateDelta.x/t.clientHeight),this._rotateUp(kM*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(kM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-kM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(kM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-kM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(1===this._pointers.length)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateStart.set(n,i)}}_handleTouchStartPan(e){if(1===this._pointers.length)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panStart.set(n,i)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(n*n+i*i);this._dollyStart.set(0,s)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(1==this._pointers.length)this._rotateEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateEnd.set(n,i)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(kM*this._rotateDelta.x/t.clientHeight),this._rotateUp(kM*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(1===this._pointers.length)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panEnd.set(n,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(n*n+i*i);this._dollyEnd.set(0,s),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const a=.5*(e.pageX+t.x),r=.5*(e.pageY+t.y);this._updateZoomParameters(a,r)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return void this._pointers.splice(t,1)}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new uh,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100}return e.ctrlKey&&!this._controlActive&&(n.deltaY*=10),n}}function FM(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._isTrackingPointer(e)||(this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e)))}function zM(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function BM(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(RM),this.state=LM;break;case 1:const t=this._pointers[0],n=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:n.x,pageY:n.y})}}function VM(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case 1:if(!1===this.enableZoom)return;this._handleMouseDownDolly(e),this.state=1;break;case 0:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=2}else{if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=0}break;case 2:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=0}else{if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=2}break;default:this.state=LM}this.state!==LM&&this.dispatchEvent(AM)}function HM(e){switch(this.state){case 0:if(!1===this.enableRotate)return;this._handleMouseMoveRotate(e);break;case 1:if(!1===this.enableZoom)return;this._handleMouseMoveDolly(e);break;case 2:if(!1===this.enablePan)return;this._handleMouseMovePan(e)}}function WM(e){!1!==this.enabled&&!1!==this.enableZoom&&this.state===LM&&(e.preventDefault(),this.dispatchEvent(AM),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(RM))}function GM(e){!1!==this.enabled&&this._handleKeyDown(e)}function qM(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case 0:if(!1===this.enableRotate)return;this._handleTouchStartRotate(e),this.state=3;break;case 1:if(!1===this.enablePan)return;this._handleTouchStartPan(e),this.state=4;break;default:this.state=LM}break;case 2:switch(this.touches.TWO){case 2:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchStartDollyPan(e),this.state=5;break;case 3:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchStartDollyRotate(e),this.state=6;break;default:this.state=LM}break;default:this.state=LM}this.state!==LM&&this.dispatchEvent(AM)}function $M(e){switch(this._trackPointer(e),this.state){case 3:if(!1===this.enableRotate)return;this._handleTouchMoveRotate(e),this.update();break;case 4:if(!1===this.enablePan)return;this._handleTouchMovePan(e),this.update();break;case 5:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchMoveDollyPan(e),this.update();break;case 6:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=LM}}function XM(e){!1!==this.enabled&&e.preventDefault()}function YM(e){"Control"===e.key&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function KM(e){"Control"===e.key&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const ZM=new class{constructor(){t(this,"STORAGE_KEY","mythseeker_dice_rolls"),t(this,"STATS_KEY","mythseeker_dice_stats"),t(this,"SETTINGS_KEY","mythseeker_dice_settings")}getRolls(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}addRoll(e){const t={...e,id:this.generateId(),timestamp:Date.now()},n=this.getRolls();return n.unshift(t),n.length>1e3&&n.splice(1e3),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),this.updateStats(),t}getFilteredRolls(e){let t=this.getRolls();return e.sides&&(t=t.filter(t=>t.sides===e.sides)),e.campaignId&&(t=t.filter(t=>t.campaignId===e.campaignId)),e.characterId&&(t=t.filter(t=>t.characterId===e.characterId)),e.startDate&&(t=t.filter(t=>t.timestamp>=e.startDate)),e.endDate&&(t=t.filter(t=>t.timestamp<=e.endDate)),e.limit&&(t=t.slice(0,e.limit)),t}getStats(){try{const e=localStorage.getItem(this.STATS_KEY);return e?JSON.parse(e):this.calculateStats()}catch(e){return this.calculateStats()}}calculateStats(){var e;const t=this.getRolls();if(0===t.length)return{totalRolls:0,averageRoll:0,highestRoll:0,lowestRoll:0,mostRolledSides:0,rollDistribution:{},recentRolls:[]};const n=t.length,i=t.reduce((e,t)=>e+t.result,0)/n,s=Math.max(...t.map(e=>e.result)),a=Math.min(...t.map(e=>e.result)),r={};t.forEach(e=>{r[e.sides]=(r[e.sides]||0)+1});const o=(null==(e=Object.entries(r).sort(([,e],[,t])=>t-e)[0])?void 0:e[0])||"0";return{totalRolls:n,averageRoll:Math.round(100*i)/100,highestRoll:s,lowestRoll:a,mostRolledSides:parseInt(o),rollDistribution:r,recentRolls:t.slice(0,10)}}updateStats(){const e=this.calculateStats();localStorage.setItem(this.STATS_KEY,JSON.stringify(e))}getDiceSets(){const e=[{id:"classic",name:"Classic Purple",color:9133302,roughness:.5,metalness:.8,unlocked:!0,rarity:"common"},{id:"crystal",name:"Crystal Blue",color:3900150,roughness:.1,metalness:.9,emissive:934063,emissiveIntensity:.2,unlocked:!0,rarity:"common"},{id:"golden",name:"Golden",color:16498468,roughness:0,metalness:1,unlocked:!1,rarity:"rare"},{id:"emerald",name:"Emerald",color:1096065,roughness:0,metalness:.7,unlocked:!1,rarity:"rare"},{id:"ruby",name:"Ruby",color:15680580,roughness:0,metalness:.6,unlocked:!1,rarity:"epic"},{id:"obsidian",name:"Obsidian",color:2042167,roughness:.8,metalness:.3,unlocked:!1,rarity:"legendary"},{id:"wooden",name:"Wooden",color:9584654,roughness:.9,metalness:1,unlocked:!0,rarity:"common"},{id:"neon",name:"Neon Pink",color:15485081,roughness:.2,metalness:.8,emissive:15485081,emissiveIntensity:.3,unlocked:!1,rarity:"epic"}];try{const t=localStorage.getItem("mythseeker_dice_sets");if(t){const n=JSON.parse(t);return e.map(e=>({...e,...n.find(t=>t.id===e.id)}))}}catch(t){}return e}unlockDiceSet(e){const t=this.getDiceSets(),n=t.findIndex(t=>t.id===e);-1!==n&&(t[n].unlocked=!0,localStorage.setItem("mythseeker_dice_sets",JSON.stringify(t)))}getSettings(){try{const e=localStorage.getItem(this.SETTINGS_KEY);return e?JSON.parse(e):this.getDefaultSettings()}catch(e){return this.getDefaultSettings()}}updateSettings(e){localStorage.setItem(this.SETTINGS_KEY,JSON.stringify(e))}getDefaultSettings(){return{soundEnabled:!0,hapticEnabled:!0,shakeToRoll:!0,showHistory:!0,autoSaveRolls:!0,defaultSides:20,defaultDiceSet:"classic"}}clearData(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.STATS_KEY),localStorage.removeItem(this.SETTINGS_KEY)}exportData(){const e={rolls:this.getRolls(),stats:this.getStats(),settings:this.getSettings(),diceSets:this.getDiceSets(),exportDate:(new Date).toISOString()};return JSON.stringify(e,null,2)}importData(e){try{const t=JSON.parse(e);return t.rolls&&localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t.rolls)),t.stats&&localStorage.setItem(this.STATS_KEY,JSON.stringify(t.stats)),t.settings&&localStorage.setItem(this.SETTINGS_KEY,JSON.stringify(t.settings)),t.diceSets&&localStorage.setItem("mythseeker_dice_sets",JSON.stringify(t.diceSets)),!0}catch(t){return!1}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRollStreak(){const e=this.getRolls();if(e.length<2)return{number:0,count:0};let t=1,n=1,i=e[0].result;for(let s=1;s<e.length;s++)e[s].result===e[s-1].result?(t++,t>n&&(n=t,i=e[s].result)):t=1;return{number:i,count:n}}getLuckyRolls(){const e=this.getRolls();return{natural20s:e.filter(e=>20===e.sides&&20===e.result).length,natural1s:e.filter(e=>1===e.result).length}}},JM=[{id:"classic",name:"Classic Purple",color:9133302,roughness:.5,metalness:.8},{id:"crystal",name:"Crystal Blue",color:3900150,roughness:.1,metalness:.9,emissive:934063,emissiveIntensity:.2},{id:"golden",name:"Golden",color:16498468,roughness:0,metalness:1},{id:"emerald",name:"Emerald",color:1096065,roughness:0,metalness:.7},{id:"ruby",name:"Ruby",color:15680580,roughness:0,metalness:.6},{id:"obsidian",name:"Obsidian",color:2042167,roughness:.8,metalness:.3},{id:"wooden",name:"Wooden",color:9584654,roughness:.9,metalness:1},{id:"neon",name:"Neon Pink",color:15485081,roughness:.2,metalness:.8,emissive:805017,emissiveIntensity:.3}],QM=({isOpen:e,onClose:t,onRollComplete:i,sides:s=6})=>{const a=n.useRef(null),[r,o]=n.useState(null),[l,c]=n.useState(!1),[h,u]=n.useState(0),[d,p]=n.useState(!1),[m,f]=n.useState(!1),[g,v]=n.useState(JM[0]),[x,y]=n.useState(!1),b=n.useRef(null),_=n.useRef(null),w=n.useRef(null),S=n.useRef(null),M=n.useRef(null),T=n.useRef(null),E=n.useRef(null),C=n.useRef(null),N=n.useRef(0),A=n.useRef(null),R=n.useRef(null),j=n.useRef(null),P=n.useRef({x:0,y:0,z:0}),I=n.useRef(null),D=n.useCallback(()=>{window.navigator.vibrate&&window.navigator.vibrate([30,50,30])},[]),k=n.useCallback((e,t)=>{if(!b.current||!S.current)return;let n,i;function s(e){const t=e.getAttribute("position"),n=[];for(let s=0;s<t.count;s++)n.push(new xg.Vec3(t.getX(s),t.getY(s),t.getZ(s)));const i=[];if(e.index){const t=e.index.array;for(let e=0;e<t.length;e+=3)i.push([t[e],t[e+1],t[e+2]])}return{vertices:n,faces:i}}switch(M.current&&(b.current.remove(M.current),M.current.geometry.dispose(),M.current.material.dispose()),T.current&&S.current.removeBody(T.current),e){case 4:{n=new yp(1);const{vertices:e,faces:t}=s(n);i=new xg.ConvexPolyhedron({vertices:e,faces:t});break}case 6:default:n=new zd(1,1,1),i=new xg.Box(new xg.Vec3(.5,.5,.5));break;case 8:{n=new vp(1);const{vertices:e,faces:t}=s(n);i=new xg.ConvexPolyhedron({vertices:e,faces:t});break}case 10:{n=new fp(1);const{vertices:e,faces:t}=s(n);i=new xg.ConvexPolyhedron({vertices:e,faces:t});break}case 12:{n=new fp(1);const{vertices:e,faces:t}=s(n);i=new xg.ConvexPolyhedron({vertices:e,faces:t});break}case 20:{n=new gp(1);const{vertices:e,faces:t}=s(n);i=new xg.ConvexPolyhedron({vertices:e,faces:t});break}}const a=new bp({color:t.color,roughness:t.roughness,metalness:t.metalness,emissive:t.emissive||0,emissiveIntensity:t.emissiveIntensity||0});M.current=new Ud(n,a),b.current.add(M.current),T.current=new xg.Body({mass:1,shape:i}),T.current.position.set(0,5,0),S.current.addBody(T.current),T.current.applyImpulse(new xg.Vec3(.5*(Math.random()-.5),0,.5*(Math.random()-.5)),T.current.position)},[b,S]),L=n.useCallback(e=>{if(!e.accelerationIncludingGravity)return;const{x:t,y:n,z:i}=e.accelerationIncludingGravity,s={x:t||0,y:n||0,z:i||0};Math.abs(s.x-P.current.x)+Math.abs(s.y-P.current.y)+Math.abs(s.z-P.current.z)>15&&!l&&null===I.current&&(I.current=setTimeout(()=>{F(),I.current=null},100)),P.current=s},[l]);n.useEffect(()=>{if(!a.current)return;const e=()=>{if(w.current&&_.current&&a.current){const e=a.current.clientWidth,t=a.current.clientHeight;w.current.setSize(e,t,!1),_.current.aspect=e/t,_.current.updateProjectionMatrix()}};e();const t=new window.ResizeObserver(e);return t.observe(a.current),()=>t.disconnect()},[e]),n.useEffect(()=>{j.current||(j.current=new eM({frequency:200,type:"sine"}).toDestination())},[]);const O=n.useCallback(()=>{if(j.current){lS.resume();const e=cS().now();j.current.frequency.setValueAtTime(200,e),j.current.frequency.exponentialRampTo(50,.3,e),j.current.volume.setValueAtTime(-10,e),j.current.volume.linearRampTo(-20,.3,e),j.current.start(e).stop(e+.3)}},[]);n.useEffect(()=>{if(!e||!a.current)return;b.current=new sp,b.current.background=new od(1712172),_.current=new Kd(75,1,.1,1e3),_.current.position.set(0,5,10),_.current.lookAt(0,0,0),w.current=new gg({canvas:a.current,antialias:!0}),w.current.setSize(a.current.clientWidth,a.current.clientHeight),w.current.setPixelRatio(window.devicePixelRatio),A.current=new UM(_.current,w.current.domElement),A.current.enableDamping=!0,A.current.dampingFactor=.05,A.current.screenSpacePanning=!1,A.current.maxPolarAngle=Math.PI/2,window.innerWidth<768&&(A.current.enableZoom=!1,A.current.enablePan=!1);const t=new jp(16777215,.5);b.current.add(t);const n=new Rp(16777215,.8);n.position.set(5,10,7),b.current.add(n),S.current=new xg.World,S.current.gravity.set(0,-9.82,0),S.current.broadphase=new xg.NaiveBroadphase,S.current.solver.iterations=10;const i=new xg.Plane;C.current=new xg.Body({mass:0,shape:i}),C.current.quaternion.setFromAxisAngle(new xg.Vec3(1,0,0),-Math.PI/2),S.current.addBody(C.current);const r=new xp(20,20),l=new bp({color:2963272,side:2});return E.current=new Ud(r,l),E.current.rotation.x=-Math.PI/2,b.current.add(E.current),k(s,g),()=>{R.current&&cancelAnimationFrame(R.current),w.current&&w.current.dispose(),A.current&&A.current.dispose(),S.current&&(S.current.removeBody(T.current),S.current.removeBody(C.current)),b.current=null,_.current=null,w.current=null,S.current=null,M.current=null,T.current=null,E.current=null,C.current=null,o(null),c(!1)}},[e,s,g,k]),n.useEffect(()=>{e&&b.current&&S.current&&k(s,g)},[g,s,e,k]),n.useEffect(()=>{if(!(e&&w.current&&b.current&&_.current&&S.current&&M.current&&T.current))return;let t=!0;const n=()=>{if(t){if(R.current=requestAnimationFrame(n),S.current.step(1/60),M.current&&T.current&&(M.current.position.copy(T.current.position),M.current.quaternion.copy(T.current.quaternion),l&&T.current.sleepState===xg.Body.SLEEPING)){const e=U(T.current,s);null!==e&&(o(e),c(!1),O(),ZM.addRoll({sides:s,result:e,diceSet:g.id,context:`3D Dice Roll - ${g.name}`}),i&&i(e))}A.current&&A.current.update(),w.current.render(b.current,_.current)}};return n(),()=>{t=!1,R.current&&cancelAnimationFrame(R.current)}},[e,s,l,O,i]),n.useEffect(()=>{if(!e)return;const t=window.innerWidth<768,n="undefined"!=typeof DeviceMotionEvent;if(t&&n){f(!0),p(!0),"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(e=>{"granted"===e&&window.addEventListener("devicemotion",L)}):window.addEventListener("devicemotion",L);const e=setTimeout(()=>p(!1),5e3);return()=>{window.removeEventListener("devicemotion",L),I.current&&clearTimeout(I.current),clearTimeout(e)}}},[e,L]);const U=(e,t)=>{const n=e.quaternion,i=new ph(0,1,0).applyQuaternion(n);let s=-1/0,a=null;const r={4:[{vector:new ph(0,1,0),value:1},{vector:new ph(.9428,-.3333,0),value:2},{vector:new ph(-.4714,-.3333,.8165),value:3},{vector:new ph(-.4714,-.3333,-.8165),value:4}],6:[{vector:new ph(0,1,0),value:6},{vector:new ph(0,-1,0),value:1},{vector:new ph(1,0,0),value:4},{vector:new ph(-1,0,0),value:3},{vector:new ph(0,0,1),value:2},{vector:new ph(0,0,-1),value:5}],8:[{vector:new ph(0,1,0),value:8},{vector:new ph(0,-1,0),value:1}],10:[{vector:new ph(0,1,0),value:10},{vector:new ph(0,-1,0),value:0}],12:[{vector:new ph(0,1,0),value:12},{vector:new ph(0,-1,0),value:1}],20:[{vector:new ph(0,1,0),value:20},{vector:new ph(0,-1,0),value:1}]}[t];if(!r)return Math.floor(Math.random()*t)+1;for(const o of r){const e=i.dot(o.vector);e>s&&(s=e,a=o.value)}return 10===t&&0===a?10:a},F=n.useCallback(()=>{if(!T.current||!S.current||l)return;if(Date.now()-N.current<2e3)return;c(!0),o(null),u(e=>e+1),N.current=Date.now(),D(),T.current.position.set(2*(Math.random()-.5),5+2*Math.random(),2*(Math.random()-.5)),T.current.velocity.set(0,0,0),T.current.angularVelocity.set(0,0,0);const e=5+5*Math.random(),t=.5+.5*Math.random();T.current.applyImpulse(new xg.Vec3((Math.random()-.5)*e,(.5*Math.random()+.5)*e,(Math.random()-.5)*e),T.current.position),T.current.applyTorque(new xg.Vec3((Math.random()-.5)*t,(Math.random()-.5)*t,(Math.random()-.5)*t)),T.current.wakeUp()},[l,D]);return e?ft.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",children:ft.jsxs("div",{className:"bg-gradient-to-br from-purple-900/90 to-blue-900/90 backdrop-blur-lg rounded-2xl p-8 border border-purple-400/30 shadow-2xl max-w-lg w-full mx-4 flex flex-col items-center",children:[ft.jsxs("div",{className:"flex items-center justify-between w-full mb-6",children:[ft.jsxs("h3",{className:"text-2xl font-bold mb-6 text-white text-center",children:["🎲 Roll d",s]}),ft.jsx("button",{onClick:()=>y(!x),className:"px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors",children:"🎨 Dice"})]}),x&&ft.jsxs("div",{className:"w-full mb-4 p-4 bg-gray-800 rounded-xl border border-gray-700 shadow-inner",children:[ft.jsx("h4",{className:"text-white font-semibold mb-3 text-center",children:"Choose Your Dice Set"}),ft.jsx("div",{className:"grid grid-cols-2 gap-2",children:JM.map(e=>ft.jsxs("button",{onClick:()=>{v(e),y(!1)},className:"p-3 rounded-lg border-2 transition-all "+(g.id===e.id?"border-purple-400 bg-purple-600/20":"border-gray-600 hover:border-gray-500"),children:[ft.jsx("div",{className:"text-white text-sm font-medium text-center",children:e.name}),ft.jsx("div",{className:"w-12 h-12 rounded-full mx-auto mt-1",style:{backgroundColor:`#${e.color.toString(16).padStart(6,"0")}`}})]},e.id))})]}),d&&m&&ft.jsx("div",{className:"mb-4 p-3 bg-blue-500 rounded-lg border border-blue-400/30 text-center",children:ft.jsx("div",{className:"text-blue-300 text-sm font-medium",children:"📱 Shake your device to roll!"})}),ft.jsx("div",{className:"w-full h-64 sm:h-80 md:h-96 bg-gray-800 rounded-xl overflow-hidden border border-gray-700 shadow-inner",children:ft.jsx("canvas",{ref:a,className:"w-full h-full"})}),ft.jsx("button",{onClick:F,disabled:l,className:"mt-6 px-8 py-4 bg-gradient-to-br from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed rounded-xl transition-all text-white font-bold text-lg shadow-lg transform hover:scale-105 disabled:transform-none",children:l?"Rolling...":"Roll Dice"}),null!==r&&ft.jsxs("div",{className:"mt-6 p-4 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-xl border border-yellow-400/30 w-full text-center",children:[ft.jsxs("div",{className:"text-3xl font-bold text-yellow-400 mb-2 animate-bounce",children:["🎯 Result: ",r]}),ft.jsx("div",{className:"text-yellow-200",children:"Your fate is sealed!"})]}),ft.jsx("button",{onClick:()=>t(r||void 0),className:"w-full mt-4 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-xl font-bold transition-all",children:"Close"})]})}):null},eT=({user:e,onSignOut:t})=>{const i=yn(),s=gn(),[a,r]=n.useState(!1),[o,l]=n.useState(!1),c=[{id:"dashboard",label:"Dashboard",path:"/dashboard",icon:ft.jsx(me,{className:"w-5 h-5"}),description:"Main hub and overview"},{id:"campaigns",label:"Campaigns",path:"/campaigns",icon:ft.jsx(Me,{className:"w-5 h-5"}),description:"Manage your adventures"},{id:"automated-games",label:"AI Games",path:"/automated-games",icon:ft.jsx(ze,{className:"w-5 h-5"}),description:"Join AI-powered RPG sessions",isNew:!0},{id:"characters",label:"Characters",path:"/characters",icon:ft.jsx(Te,{className:"w-5 h-5"}),description:"Your heroes and companions"},{id:"party",label:"Party",path:"/party",icon:ft.jsx(re,{className:"w-5 h-5"}),description:"Team up with friends"},{id:"world",label:"World",path:"/world",icon:ft.jsx(be,{className:"w-5 h-5"}),description:"Explore the realm"},{id:"combat",label:"Combat",path:"/combat",icon:ft.jsx(ue,{className:"w-5 h-5"}),description:"Battle system & tactics"},{id:"magic",label:"Magic",path:"/magic",icon:ft.jsx(_e,{className:"w-5 h-5"}),description:"Spells & abilities"},{id:"dm-center",label:"DM Center",path:"/dm-center",icon:ft.jsx(Ae,{className:"w-5 h-5"}),description:"Dungeon Master tools",isNew:!0},{id:"achievements",label:"Achievements",path:"/achievements",icon:ft.jsx(le,{className:"w-5 h-5"}),description:"Track your progress"},{id:"profile",label:"Profile",path:"/profile",icon:ft.jsx(Te,{className:"w-5 h-5"}),description:"Your account settings"},{id:"settings",label:"Settings",path:"/settings",icon:ft.jsx(ke,{className:"w-5 h-5"}),description:"App preferences"},{id:"help",label:"Help",path:"/help",icon:ft.jsx(Be,{className:"w-5 h-5"}),description:"Support & documentation"}],h=e=>{i(e),r(!1)},u=async()=>{try{await oi.signOut(),t()}catch(e){}},d=e=>s.pathname===e||s.pathname.startsWith(e+"/");return ft.jsxs(ft.Fragment,{children:[ft.jsxs("nav",{className:"hidden md:flex flex-col bg-slate-800/90 backdrop-blur-sm border-r border-slate-700/50 h-screen sticky top-0 transition-all duration-300 "+(o?"w-16":"w-64"),children:[ft.jsx("div",{className:"p-4 border-b border-slate-700/50 "+(o?"px-2":"px-6"),children:ft.jsxs("div",{className:"flex items-center justify-between",children:[!o&&ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:ft.jsx(xe,{className:"w-5 h-5 text-white"})}),ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-lg font-bold text-white",children:"MythSeeker"}),ft.jsx("p",{className:"text-xs text-slate-400",children:"RPG Adventure"})]})]}),o&&ft.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mx-auto",children:ft.jsx(xe,{className:"w-5 h-5 text-white"})}),ft.jsx("button",{onClick:()=>l(!o),className:"p-1 text-slate-400 hover:text-white transition-colors",children:o?ft.jsx(De,{className:"w-4 h-4"}):ft.jsx(Oe,{className:"w-4 h-4"})})]})}),ft.jsx("div",{className:"p-4 border-b border-slate-700/50 "+(o?"px-2":""),children:ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0",children:(null==e?void 0:e.photoURL)?ft.jsx("img",{src:e.photoURL,alt:e.displayName,className:"w-8 h-8 rounded-full"}):ft.jsx(Te,{className:"w-4 h-4 text-white"})}),!o&&ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsx("p",{className:"text-sm font-medium text-white truncate",children:(null==e?void 0:e.displayName)||"Adventurer"}),ft.jsx("p",{className:"text-xs text-slate-400 truncate",children:null==e?void 0:e.email})]})]})}),ft.jsx("div",{className:"flex-1 overflow-y-auto py-4",children:ft.jsx("div",{className:"space-y-1 "+(o?"px-2":"px-4"),children:c.map(e=>ft.jsxs("button",{onClick:()=>h(e.path),className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left transition-all duration-200 group relative "+(d(e.path)?"bg-blue-600/20 text-blue-400 border border-blue-500/30":"text-slate-300 hover:bg-slate-700/50 hover:text-white"),title:o?e.label:void 0,children:[ft.jsx("div",{className:"flex-shrink-0 "+(d(e.path)?"text-blue-400":"text-slate-400 group-hover:text-white"),children:e.icon}),!o&&ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("span",{className:"text-sm font-medium truncate",children:e.label}),e.isNew&&ft.jsx("span",{className:"px-1.5 py-0.5 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs font-medium",children:"NEW"}),e.badge&&ft.jsx("span",{className:"px-1.5 py-0.5 bg-slate-600 rounded-full text-xs",children:e.badge})]}),ft.jsx("p",{className:"text-xs text-slate-500 group-hover:text-slate-300 truncate",children:e.description})]}),o&&ft.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50",children:e.label})]},e.id))})}),ft.jsx("div",{className:"p-4 border-t border-slate-700/50 "+(o?"px-2":""),children:ft.jsxs("button",{onClick:u,className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-700/50 hover:text-white transition-all duration-200 "+(o?"justify-center":""),title:o?"Sign Out":void 0,children:[ft.jsx(Ue,{className:"w-5 h-5"}),!o&&ft.jsx("span",{className:"text-sm font-medium",children:"Sign Out"})]})})]}),ft.jsxs("div",{className:"md:hidden",children:[ft.jsx("div",{className:"bg-slate-800/90 backdrop-blur-sm border-b border-slate-700/50 p-4",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:ft.jsx(xe,{className:"w-5 h-5 text-white"})}),ft.jsx("span",{className:"text-lg font-bold text-white",children:"MythSeeker"})]}),ft.jsx("button",{onClick:()=>r(!a),className:"p-2 text-slate-400 hover:text-white",children:a?ft.jsx(ge,{className:"w-6 h-6"}):ft.jsx(Fe,{className:"w-6 h-6"})})]})}),a&&ft.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 backdrop-blur-sm",children:ft.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-slate-800/95 border-b border-slate-700/50 max-h-96 overflow-y-auto",children:[ft.jsx("div",{className:"p-4 border-b border-slate-700/50",children:ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center",children:(null==e?void 0:e.photoURL)?ft.jsx("img",{src:e.photoURL,alt:e.displayName,className:"w-10 h-10 rounded-full"}):ft.jsx(Te,{className:"w-5 h-5 text-white"})}),ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsx("p",{className:"text-sm font-medium text-white truncate",children:(null==e?void 0:e.displayName)||"Adventurer"}),ft.jsx("p",{className:"text-xs text-slate-400 truncate",children:null==e?void 0:e.email})]})]})}),ft.jsx("div",{className:"p-4 space-y-1",children:c.map(e=>ft.jsxs("button",{onClick:()=>h(e.path),className:"w-full flex items-center space-x-3 px-3 py-3 rounded-lg text-left transition-all duration-200 "+(d(e.path)?"bg-blue-600/20 text-blue-400 border border-blue-500/30":"text-slate-300 hover:bg-slate-700/50 hover:text-white"),children:[ft.jsx("div",{className:"flex-shrink-0 "+(d(e.path)?"text-blue-400":"text-slate-400"),children:e.icon}),ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("span",{className:"text-sm font-medium",children:e.label}),e.isNew&&ft.jsx("span",{className:"px-1.5 py-0.5 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs font-medium",children:"NEW"})]}),ft.jsx("p",{className:"text-xs text-slate-500",children:e.description})]})]},e.id))}),ft.jsx("div",{className:"p-4 border-t border-slate-700/50",children:ft.jsxs("button",{onClick:u,className:"w-full flex items-center space-x-3 px-3 py-3 rounded-lg text-slate-300 hover:bg-slate-700/50 hover:text-white transition-all duration-200",children:[ft.jsx(Ue,{className:"w-5 h-5"}),ft.jsx("span",{className:"text-sm font-medium",children:"Sign Out"})]})})]})}),ft.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-slate-800/95 backdrop-blur-sm border-t border-slate-700/50 z-40",children:ft.jsxs("div",{className:"flex justify-around p-2",children:[c.slice(0,5).map(e=>ft.jsxs("button",{onClick:()=>h(e.path),className:"flex flex-col items-center space-y-1 px-3 py-2 rounded-lg transition-all duration-200 "+(d(e.path)?"text-blue-400 bg-blue-600/20":"text-slate-400 hover:text-white"),children:[ft.jsx("div",{className:"w-5 h-5",children:e.icon}),ft.jsx("span",{className:"text-xs font-medium",children:e.label})]},e.id)),ft.jsxs("button",{onClick:()=>r(!a),className:"flex flex-col items-center space-y-1 px-3 py-2 rounded-lg text-slate-400 hover:text-white transition-all duration-200",children:[ft.jsx(Fe,{className:"w-5 h-5"}),ft.jsx("span",{className:"text-xs font-medium",children:"More"})]})]})})]})]})},tT=({character:e,calculateStats:t,onUpdateCharacter:i})=>{var s,a,r,o;const[l,c]=n.useState(!1),[h,u]=n.useState(null),[d,p]=n.useState(""),[m,f]=n.useState(!1),g=n.useRef(null);if(!e)return ft.jsx("div",{className:"h-full flex items-center justify-center text-white",children:ft.jsxs("div",{className:"text-center",children:[ft.jsx(Ve,{size:48,className:"mx-auto mb-4 text-blue-400"}),ft.jsx("h2",{className:"text-xl font-bold mb-2",children:"No Character Selected"}),ft.jsx("p",{className:"text-blue-200",children:"Create a character to view their sheet"})]})});const v=t?t(e):e.baseStats,x=()=>e.portrait?e.portrait:{Warrior:"⚔️",Rogue:"🗡️",Mage:"🔮",Cleric:"⚡",Ranger:"🏹",Bard:"🎵"}[e.class]||"👤",y=t=>{var n,i;const s=null==(n=e.equipment)?void 0:n[t];return s?(null==(i={weapon:{"Iron Sword":"⚔️","Steel Blade":"🗡️","Enchanted Sword":"✨⚔️","Dragon Slayer":"🔥⚔️","Basic Staff":"🔮","Crystal Staff":"💎🔮","War Bow":"🏹","Elven Bow":"🌿🏹"},armor:{"Leather Armor":"🛡️","Chain Mail":"⛓️🛡️","Plate Armor":"⚔️🛡️","Dragon Scale":"🐉🛡️","Mage Robes":"🔮👘","Archmage Robes":"✨🔮👘"}}[t])?void 0:i[s.name])||"📦":null},b=e=>e.toLowerCase().includes("legendary")?"text-yellow-400":e.toLowerCase().includes("rare")?"text-purple-400":e.toLowerCase().includes("uncommon")?"text-blue-400":"text-gray-400";return ft.jsxs("div",{className:"h-full overflow-auto p-6 text-white",children:[ft.jsxs("div",{className:"bg-white/10 rounded-xl p-6 mb-6 border border-white/20",children:[ft.jsxs("div",{className:"flex items-start justify-between mb-4",children:[ft.jsxs("div",{className:"flex items-center space-x-4",children:[ft.jsxs("div",{className:"relative",children:[ft.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-3xl border-4 border-white/20",children:"string"==typeof x()&&x().startsWith("data:")?ft.jsx("img",{src:x(),alt:"Character Portrait",className:"w-full h-full rounded-full object-cover"}):ft.jsx("span",{children:x()})}),ft.jsx("button",{onClick:()=>f(!0),className:"absolute -bottom-1 -right-1 bg-blue-600 hover:bg-blue-700 rounded-full p-1 transition-colors",title:"Change portrait",children:ft.jsx(He,{size:12})})]}),ft.jsxs("div",{children:[ft.jsx("div",{className:"flex items-center space-x-2 mb-1",children:l&&"name"===h?ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"text",value:d,onChange:e=>p(e.target.value),className:"bg-black/30 text-white px-2 py-1 rounded text-2xl font-bold",autoFocus:!0}),ft.jsx("button",{onClick:()=>{h&&i&&(i({[h]:d}),u(null),p(""))},className:"text-green-400 hover:text-green-300",children:ft.jsx(We,{size:16})}),ft.jsx("button",{onClick:()=>u(null),className:"text-red-400 hover:text-red-300",children:ft.jsx(ge,{size:16})})]}):ft.jsxs("h1",{className:"text-3xl font-bold flex items-center space-x-2",children:[ft.jsx("span",{children:e.name}),l&&ft.jsx("button",{onClick:()=>{return t=e.name,u("name"),void p(t);var t},className:"text-blue-400 hover:text-blue-300",children:ft.jsx(Ge,{size:16})})]})}),ft.jsxs("p",{className:"text-blue-200 text-lg",children:["Level ",e.level," ",e.class]}),ft.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-blue-200",children:[ft.jsxs("div",{className:"flex items-center space-x-1",children:[ft.jsx(qe,{size:12}),ft.jsx("span",{children:e.location||"Unknown"})]}),ft.jsxs("div",{className:"flex items-center space-x-1",children:[ft.jsx(oe,{size:12}),ft.jsxs("span",{children:[Math.floor(e.totalPlayTime/6e4),"m played"]})]}),ft.jsxs("div",{className:"flex items-center space-x-1",children:[ft.jsx(re,{size:12}),ft.jsxs("span",{children:[e.campaignsJoined||0," campaigns"]})]})]})]})]}),ft.jsxs("div",{className:"text-right",children:[ft.jsx("div",{className:"text-yellow-400 text-sm",children:"Experience"}),ft.jsxs("div",{className:"text-2xl font-bold",children:[e.experience," XP"]}),ft.jsxs("div",{className:"text-green-400 text-sm",children:[e.gold||0," Gold"]}),ft.jsx("button",{onClick:()=>c(!l),className:"mt-2 px-3 py-1 rounded text-sm transition-colors "+(l?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700"),children:l?"Save":"Edit"})]})]}),ft.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[ft.jsxs("div",{children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[ft.jsx($e,{size:16,className:"text-red-400"}),ft.jsx("span",{className:"text-sm",children:"Health"}),ft.jsxs("span",{className:"text-sm text-red-400",children:[e.health,"/",e.maxHealth+((null==v?void 0:v.health)||0)]})]}),ft.jsx("div",{className:"w-full bg-red-900 rounded-full h-2",children:ft.jsx("div",{className:"bg-red-500 h-2 rounded-full transition-all duration-300",style:{width:e.health/(e.maxHealth+((null==v?void 0:v.health)||0))*100+"%"}})})]}),void 0!==e.mana&&ft.jsxs("div",{children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[ft.jsx(ve,{size:16,className:"text-blue-400"}),ft.jsx("span",{className:"text-sm",children:"Mana"}),ft.jsxs("span",{className:"text-sm text-blue-400",children:[e.mana,"/",e.maxMana+((null==v?void 0:v.mana)||0)]})]}),ft.jsx("div",{className:"w-full bg-blue-900 rounded-full h-2",children:ft.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:e.mana/(e.maxMana+((null==v?void 0:v.mana)||0))*100+"%"}})})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-xl p-6 mb-6 border border-white/20",children:[ft.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[ft.jsx(Xe,{size:20,className:"text-purple-400"}),ft.jsx("span",{children:"Character Model"})]}),ft.jsx("div",{className:"flex justify-center",children:ft.jsxs("div",{className:"relative w-32 h-48 bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg border-2 border-white/20 flex flex-col items-center justify-center",children:[ft.jsx("div",{className:"text-4xl mb-2",children:x()}),ft.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[(null==(s=e.equipment)?void 0:s.weapon)&&ft.jsx("div",{className:"absolute -right-4 top-1/2 transform -translate-y-1/2 text-2xl",children:y("weapon")}),(null==(a=e.equipment)?void 0:a.armor)&&ft.jsx("div",{className:"absolute top-2 text-xl",children:y("armor")})]}),ft.jsx("div",{className:"absolute bottom-2 text-xs text-center text-white bg-black/50 px-2 py-1 rounded",children:e.name})]})})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[ft.jsxs("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20",children:[ft.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[ft.jsx(ae,{size:20,className:"text-green-400"}),ft.jsx("span",{children:"Core Stats"})]}),ft.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("div",{className:"text-sm text-blue-200",children:"Strength"}),ft.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.strength)||0}),ft.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.strength)||0)-10)/2)]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("div",{className:"text-sm text-blue-200",children:"Dexterity"}),ft.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.dexterity)||0}),ft.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.dexterity)||0)-10)/2)]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("div",{className:"text-sm text-blue-200",children:"Intelligence"}),ft.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.intelligence)||0}),ft.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.intelligence)||0)-10)/2)]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("div",{className:"text-sm text-blue-200",children:"Charisma"}),ft.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.charisma)||0}),ft.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.charisma)||0)-10)/2)]})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20",children:[ft.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[ft.jsx(ue,{size:20,className:"text-red-400"}),ft.jsx("span",{children:"Combat Stats"})]}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsx("span",{className:"text-blue-200",children:"Attack Bonus"}),ft.jsxs("span",{className:"text-white font-semibold",children:["+",(null==v?void 0:v.attack)||0]})]}),ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsx("span",{className:"text-blue-200",children:"Defense"}),ft.jsx("span",{className:"text-white font-semibold",children:(null==v?void 0:v.defense)||0})]}),ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsx("span",{className:"text-blue-200",children:"Magic Power"}),ft.jsxs("span",{className:"text-white font-semibold",children:["+",(null==v?void 0:v.magic)||0]})]}),ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsx("span",{className:"text-blue-200",children:"Critical Chance"}),ft.jsxs("span",{className:"text-white font-semibold",children:[(null==v?void 0:v.crit)||0,"%"]})]})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-xl p-6 mb-6 border border-white/20",children:[ft.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[ft.jsx(Ye,{size:20,className:"text-yellow-400"}),ft.jsx("span",{children:"Equipment"})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(null==(r=e.equipment)?void 0:r.weapon)&&ft.jsx("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"text-2xl",children:y("weapon")}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("div",{className:`font-semibold ${b(e.equipment.weapon.name)}`,children:e.equipment.weapon.name}),ft.jsx("div",{className:"text-sm text-blue-200",children:"Weapon"}),e.equipment.weapon.stats&&ft.jsxs("div",{className:"text-xs text-green-400 mt-1",children:["+",e.equipment.weapon.stats.attack||0," Attack"]})]})]})}),(null==(o=e.equipment)?void 0:o.armor)&&ft.jsx("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"text-2xl",children:y("armor")}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("div",{className:`font-semibold ${b(e.equipment.armor.name)}`,children:e.equipment.armor.name}),ft.jsx("div",{className:"text-sm text-blue-200",children:"Armor"}),e.equipment.armor.stats&&ft.jsxs("div",{className:"text-xs text-green-400 mt-1",children:["+",e.equipment.armor.stats.defense||0," Defense"]})]})]})})]})]}),e.unlockedSkills&&e.unlockedSkills.length>0&&ft.jsxs("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20",children:[ft.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[ft.jsx(ie,{size:20,className:"text-purple-400"}),ft.jsx("span",{children:"Unlocked Skills"})]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.unlockedSkills.map(e=>ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"text-sm text-purple-400 mb-1",children:["Level ",e," Skill"]}),ft.jsx("div",{className:"text-lg font-semibold",children:"Skill Name"}),ft.jsx("div",{className:"text-sm text-blue-200",children:"Skill description would go here"})]},e))})]}),m&&ft.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:ft.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20 max-w-md w-full mx-4",children:[ft.jsx("h3",{className:"text-xl font-bold mb-4",children:"Upload Character Portrait"}),ft.jsx("p",{className:"text-blue-200 mb-4",children:"Choose an image to represent your character"}),ft.jsx("input",{ref:g,type:"file",accept:"image/*",onChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];if(n&&i){const e=new FileReader;e.onload=e=>{var t;i({portrait:null==(t=e.target)?void 0:t.result})},e.readAsDataURL(n),f(!1)}},className:"hidden"}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsxs("button",{onClick:()=>{var e;return null==(e=g.current)?void 0:e.click()},className:"flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors flex items-center justify-center space-x-2",children:[ft.jsx(Ke,{size:16}),ft.jsx("span",{children:"Choose File"})]}),ft.jsx("button",{onClick:()=>f(!1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors",children:"Cancel"})]})]})})]})},nT=({user:e,onClose:t,onCampaignCreated:i})=>{yn();const[s,a]=n.useState("simple"),[r,o]=n.useState(null),[l,c]=n.useState(""),[h,u]=n.useState(!0),[d,p]=n.useState(6),[m,f]=n.useState({dmStyle:"balanced",descriptionStyle:"immersive",difficulty:"medium",combatIntensity:"moderate",puzzleComplexity:"medium",roleplayDepth:"deep"}),[g,v]=n.useState({xpGain:"standard",lootRarity:"balanced",deathPenalty:"moderate",savePoints:"frequent",fastTravel:!0,crafting:!1}),[x,y]=n.useState({weatherSystem:!0,dayNightCycle:!0,npcSchedules:!0,dynamicEvents:!0,worldPersistence:!0}),[b,_]=n.useState("PG-13"),w=()=>{o(null),c(""),u(!0),p(6),a("simple"),f({dmStyle:"balanced",descriptionStyle:"immersive",difficulty:"medium",combatIntensity:"moderate",puzzleComplexity:"medium",roleplayDepth:"deep"}),v({xpGain:"standard",lootRarity:"balanced",deathPenalty:"moderate",savePoints:"frequent",fastTravel:!0,crafting:!1}),y({weatherSystem:!0,dayNightCycle:!0,npcSchedules:!0,dynamicEvents:!0,worldPersistence:!0}),_("PG-13")};return ft.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4",children:ft.jsxs("div",{className:"bg-slate-800 rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:[ft.jsx("div",{className:"p-6 border-b border-slate-700/50",children:ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsx("h2",{className:"text-2xl font-bold text-white",children:"Create New Campaign"}),ft.jsx("button",{onClick:()=>{w(),t()},className:"text-slate-400 hover:text-white",children:"✕"})]})}),ft.jsxs("div",{className:"p-6 space-y-6",children:[ft.jsxs("div",{className:"flex space-x-4",children:[ft.jsx("button",{onClick:()=>a("simple"),className:"px-4 py-2 rounded-lg font-medium transition-colors "+("simple"===s?"bg-green-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"),children:"🚀 Quick Start"}),ft.jsx("button",{onClick:()=>a("advanced"),className:"px-4 py-2 rounded-lg font-medium transition-colors "+("advanced"===s?"bg-purple-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"),children:"⚙️ Advanced Setup"})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Content Rating"}),ft.jsxs("select",{value:b,onChange:e=>_(e.target.value),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"G",children:"G - General Audiences (Family-friendly)"}),ft.jsx("option",{value:"PG",children:"PG - Parental Guidance (Mild content)"}),ft.jsx("option",{value:"PG-13",children:"PG-13 - Teens (Moderate content)"}),ft.jsx("option",{value:"R",children:"R - Mature (Adult themes)"}),ft.jsx("option",{value:"NC-17",children:"NC-17 - Adults Only (Explicit content)"})]}),ft.jsx("p",{className:"text-slate-400 text-sm mt-1",children:"This controls how mature or creative the AI can be in your campaign."})]}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Choose Your Adventure"}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[{id:"fantasy-epic",name:"The Lost Crown of Eldoria",category:"Fantasy",icon:"👑",difficulty:"Medium",duration:"20-30 hours",description:"A classic fantasy epic where players must recover the stolen crown and restore peace to the kingdom.",setting:"Medieval fantasy kingdom with magic and dragons",themes:["Quest","Politics","Magic","Combat"],features:["Multiple endings","Faction system","Magic schools","Dragon encounters"],aiPrompt:"You are a wise and experienced Dungeon Master running a classic fantasy epic. The world is rich with magic, political intrigue, and ancient secrets. Focus on immersive storytelling, meaningful choices, and epic battles.",recommendedLevel:"1-10"},{id:"sci-fi-exploration",name:"Stellar Drift: The Void Between",category:"Sci-Fi",icon:"🚀",difficulty:"Hard",duration:"25-35 hours",description:"Explore the vast reaches of space, discover alien civilizations, and uncover the mystery of the cosmic void.",setting:"Far-future space exploration with advanced technology",themes:["Exploration","Diplomacy","Technology","Mystery"],features:["Space combat","Alien races","Tech upgrades","Multiple planets"],aiPrompt:"You are a master of science fiction storytelling, creating a vast universe filled with wonder and danger. Focus on exploration, technological advancement, and the unknown.",recommendedLevel:"1-15"},{id:"mystery-detective",name:"Shadows of the Old City",category:"Mystery",icon:"🔍",difficulty:"Medium",duration:"15-25 hours",description:"Solve a series of connected murders in a noir-style city filled with corruption and secrets.",setting:"Gritty urban environment with supernatural elements",themes:["Investigation","Corruption","Supernatural","Social"],features:["Clue system","Multiple suspects","Moral choices","Hidden areas"],aiPrompt:"You are a master of mystery and intrigue, creating complex plots with multiple layers. Focus on investigation, character development, and moral ambiguity.",recommendedLevel:"1-8"},{id:"horror-survival",name:"The Haunting of Blackwood Manor",category:"Horror",icon:"👻",difficulty:"Hard",duration:"10-20 hours",description:"Survive a night in a haunted mansion while uncovering the dark history of the Blackwood family.",setting:"Gothic mansion with supernatural horrors",themes:["Survival","Horror","Investigation","Psychological"],features:["Sanity system","Limited resources","Multiple endings","Hidden lore"],aiPrompt:"You are a master of horror and suspense, creating an atmosphere of dread and tension. Focus on psychological horror, resource management, and survival.",recommendedLevel:"1-6"},{id:"post-apocalyptic",name:"Wasteland Wanderers",category:"Post-Apocalyptic",icon:"🌆",difficulty:"Medium",duration:"20-30 hours",description:"Navigate a dangerous post-apocalyptic world, build settlements, and fight for survival.",setting:"Post-nuclear wasteland with scattered communities",themes:["Survival","Community","Exploration","Conflict"],features:["Base building","Faction wars","Scavenging","Radiation system"],aiPrompt:"You are a master of post-apocalyptic storytelling, creating a harsh but hopeful world. Focus on survival, community building, and moral choices.",recommendedLevel:"1-12"},{id:"steampunk-adventure",name:"Clockwork Revolution",category:"Steampunk",icon:"⚙️",difficulty:"Medium",duration:"18-28 hours",description:"Join a revolution against the oppressive clockwork empire in a world of steam and brass.",setting:"Victorian-era city with advanced steam technology",themes:["Revolution","Technology","Social","Adventure"],features:["Steam-powered gadgets","Underground resistance","Social classes","Political intrigue"],aiPrompt:"You are a master of steampunk aesthetics and revolutionary storytelling. Focus on social justice, technological wonder, and political intrigue.",recommendedLevel:"1-10"},{id:"western-frontier",name:"The Lawless Frontier",category:"Western",icon:"🤠",difficulty:"Easy",duration:"12-20 hours",description:"Become a legendary gunslinger in the untamed American frontier.",setting:"Wild West with supernatural elements",themes:["Justice","Freedom","Adventure","Supernatural"],features:["Gunfights","Horse riding","Ghost towns","Native spirits"],aiPrompt:"You are a master of Western storytelling, creating a world of freedom, danger, and adventure. Focus on justice, personal freedom, and the frontier spirit.",recommendedLevel:"1-8"},{id:"cyberpunk-heist",name:"Neon Dreams",category:"Cyberpunk",icon:"🌃",difficulty:"Hard",duration:"15-25 hours",description:"Pull off the ultimate heist in a neon-lit cyberpunk city controlled by megacorporations.",setting:"Futuristic city with cybernetic enhancements",themes:["Heist","Corruption","Technology","Identity"],features:["Cybernetics","Hacking","Corporate espionage","Multiple approaches"],aiPrompt:"You are a master of cyberpunk aesthetics and heist storytelling. Focus on corporate corruption, technological advancement, and high-stakes action.",recommendedLevel:"1-10"}].map(e=>ft.jsxs("div",{onClick:()=>o(e),className:"p-4 rounded-lg border-2 cursor-pointer transition-all "+((null==r?void 0:r.id)===e.id?"border-blue-500 bg-blue-900/20":"border-slate-600 bg-slate-700/30 hover:border-slate-500 hover:bg-slate-700/50"),children:[ft.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[ft.jsx("span",{className:"text-2xl",children:e.icon}),ft.jsxs("div",{children:[ft.jsx("h4",{className:"text-white font-medium",children:e.name}),ft.jsx("p",{className:"text-slate-400 text-sm",children:e.category})]})]}),ft.jsx("p",{className:"text-slate-300 text-sm mb-3",children:e.description}),ft.jsxs("div",{className:"flex justify-between text-xs text-slate-400",children:[ft.jsxs("span",{children:["Difficulty: ",e.difficulty]}),ft.jsx("span",{children:e.duration})]})]},e.id))})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Campaign Type"}),ft.jsxs("div",{className:"space-y-2",children:[ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"radio",checked:h,onChange:()=>u(!0),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"Multiplayer Campaign"})]}),ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"radio",checked:!h,onChange:()=>u(!1),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"Solo Adventure"})]})]})]}),h&&ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Max Players"}),ft.jsxs("select",{value:d,onChange:e=>p(Number(e.target.value)),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:2,children:"2 Players"}),ft.jsx("option",{value:3,children:"3 Players"}),ft.jsx("option",{value:4,children:"4 Players"}),ft.jsx("option",{value:5,children:"5 Players"}),ft.jsx("option",{value:6,children:"6 Players"})]})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Custom Instructions (Optional)"}),ft.jsx("textarea",{value:l,onChange:e=>c(e.target.value),placeholder:"Add any specific instructions or modifications to your adventure...",rows:3,className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400"})]}),"advanced"===s&&ft.jsxs("div",{className:"space-y-6",children:[ft.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[ft.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"🤖 AI Dungeon Master Settings"}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"DM Style"}),ft.jsxs("select",{value:m.dmStyle,onChange:e=>f(t=>({...t,dmStyle:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"balanced",children:"Balanced"}),ft.jsx("option",{value:"narrative",children:"Narrative-Focused"}),ft.jsx("option",{value:"combat",children:"Combat-Heavy"}),ft.jsx("option",{value:"puzzle",children:"Puzzle-Master"}),ft.jsx("option",{value:"roleplay",children:"Roleplay-Intensive"})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Description Style"}),ft.jsxs("select",{value:m.descriptionStyle,onChange:e=>f(t=>({...t,descriptionStyle:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"immersive",children:"Immersive & Detailed"}),ft.jsx("option",{value:"concise",children:"Concise & Fast"}),ft.jsx("option",{value:"atmospheric",children:"Atmospheric & Moody"}),ft.jsx("option",{value:"cinematic",children:"Cinematic & Dynamic"})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Difficulty"}),ft.jsxs("select",{value:m.difficulty,onChange:e=>f(t=>({...t,difficulty:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"easy",children:"Easy"}),ft.jsx("option",{value:"medium",children:"Medium"}),ft.jsx("option",{value:"hard",children:"Hard"}),ft.jsx("option",{value:"brutal",children:"Brutal"})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Combat Intensity"}),ft.jsxs("select",{value:m.combatIntensity,onChange:e=>f(t=>({...t,combatIntensity:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"light",children:"Light"}),ft.jsx("option",{value:"moderate",children:"Moderate"}),ft.jsx("option",{value:"intense",children:"Intense"}),ft.jsx("option",{value:"deadly",children:"Deadly"})]})]})]})]}),ft.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[ft.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"🎮 Gameplay Rules"}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"XP Gain"}),ft.jsxs("select",{value:g.xpGain,onChange:e=>v(t=>({...t,xpGain:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"slow",children:"Slow & Steady"}),ft.jsx("option",{value:"standard",children:"Standard"}),ft.jsx("option",{value:"fast",children:"Fast Progression"}),ft.jsx("option",{value:"epic",children:"Epic Advancement"})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Loot Rarity"}),ft.jsxs("select",{value:g.lootRarity,onChange:e=>v(t=>({...t,lootRarity:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"scarce",children:"Scarce"}),ft.jsx("option",{value:"balanced",children:"Balanced"}),ft.jsx("option",{value:"generous",children:"Generous"}),ft.jsx("option",{value:"legendary",children:"Legendary"})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Death Penalty"}),ft.jsxs("select",{value:g.deathPenalty,onChange:e=>v(t=>({...t,deathPenalty:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"none",children:"No Penalty"}),ft.jsx("option",{value:"light",children:"Light"}),ft.jsx("option",{value:"moderate",children:"Moderate"}),ft.jsx("option",{value:"severe",children:"Severe"})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Save Points"}),ft.jsxs("select",{value:g.savePoints,onChange:e=>v(t=>({...t,savePoints:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[ft.jsx("option",{value:"frequent",children:"Frequent"}),ft.jsx("option",{value:"moderate",children:"Moderate"}),ft.jsx("option",{value:"rare",children:"Rare"}),ft.jsx("option",{value:"checkpoint",children:"Checkpoint Only"})]})]})]})]}),ft.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[ft.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"🌍 World Environment"}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"checkbox",checked:x.weatherSystem,onChange:e=>y(t=>({...t,weatherSystem:e.target.checked})),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"Dynamic Weather System"})]}),ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"checkbox",checked:x.dayNightCycle,onChange:e=>y(t=>({...t,dayNightCycle:e.target.checked})),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"Day/Night Cycle"})]}),ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"checkbox",checked:x.npcSchedules,onChange:e=>y(t=>({...t,npcSchedules:e.target.checked})),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"NPC Schedules"})]}),ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"checkbox",checked:x.dynamicEvents,onChange:e=>y(t=>({...t,dynamicEvents:e.target.checked})),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"Dynamic Events"})]}),ft.jsxs("label",{className:"flex items-center space-x-2",children:[ft.jsx("input",{type:"checkbox",checked:x.worldPersistence,onChange:e=>y(t=>({...t,worldPersistence:e.target.checked})),className:"text-blue-600"}),ft.jsx("span",{className:"text-white",children:"World Persistence"})]})]})]})]}),ft.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t border-slate-700/50",children:[ft.jsx("button",{onClick:()=>{w(),t()},className:"px-6 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Cancel"}),ft.jsx("button",{onClick:async()=>{try{const e={theme:(null==r?void 0:r.name)||"Custom Adventure",background:(null==r?void 0:r.id)||"custom",customPrompt:l||(null==r?void 0:r.aiPrompt)||"",maxPlayers:h?d:1,players:[],aiSettings:m,gameplaySettings:g,environmentSettings:x,adventureType:(null==r?void 0:r.id)||"custom",rating:b},{gameId:n,code:s}=await oi.createGameSession(e);i(n,s),t()}catch(e){alert("Failed to create campaign. Please try again.")}},disabled:!r,className:"px-6 py-2 bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white rounded-lg transition-colors",children:"Create Campaign"})]})]})]})})},iT=({character:e,worldState:t,onCastSpell:i,onPrepareSpell:s,onUnprepareSpell:a})=>{const[r,o]=n.useState("spellbook"),[l,c]=n.useState(null),[h,u]=n.useState(""),[d,p]=n.useState("all"),[m,f]=n.useState("all"),[g,v]=n.useState([{id:"magic-missile",name:"Magic Missile",level:1,school:"Evocation",castingTime:"1 action",range:"120 feet",duration:"Instantaneous",components:["V","S"],description:"You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range.",damage:"1d4+1 force",prepared:!0,known:!0,canCast:!0,manaCost:15},{id:"fireball",name:"Fireball",level:3,school:"Evocation",castingTime:"1 action",range:"150 feet",duration:"Instantaneous",components:["V","S","M"],description:"A bright streak flashes from your pointing finger to a point you choose within range and then blossoms with a low roar into an explosion of flame.",damage:"8d6 fire",saveType:"Dexterity",prepared:!0,known:!0,canCast:!0,manaCost:45},{id:"shield",name:"Shield",level:1,school:"Abjuration",castingTime:"1 reaction",range:"Self",duration:"1 round",components:["V","S"],description:"An invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC.",prepared:!0,known:!0,canCast:!0,manaCost:20},{id:"healing-word",name:"Healing Word",level:1,school:"Evocation",castingTime:"1 bonus action",range:"60 feet",duration:"Instantaneous",components:["V"],description:"A creature of your choice that you can see within range regains hit points equal to 1d4 + your spellcasting ability modifier.",damage:"1d4+3 healing",prepared:!1,known:!0,canCast:!1,manaCost:18},{id:"mage-armor",name:"Mage Armor",level:1,school:"Abjuration",castingTime:"1 action",range:"Touch",duration:"8 hours",components:["V","S","M"],description:"You touch a willing creature who isn't wearing armor, and a protective magical force surrounds it until the spell ends.",prepared:!0,known:!0,canCast:!0,manaCost:25},{id:"detect-magic",name:"Detect Magic",level:1,school:"Divination",castingTime:"1 action",range:"Self",duration:"10 minutes",components:["V","S"],description:"For the duration, you sense the presence of magic within 30 feet of you.",prepared:!1,known:!0,canCast:!1,manaCost:15}]),[x,y]=n.useState([{name:"Bat Guano",quantity:3,required:["Fireball"],rarity:"common"},{name:"Sulfur",quantity:5,required:["Fireball"],rarity:"common"},{name:"Diamond Dust",quantity:1,required:["Stoneskin"],rarity:"rare"},{name:"Ruby Dust",quantity:2,required:["Continual Flame"],rarity:"uncommon"},{name:"Pearl",quantity:4,required:["Identify"],rarity:"uncommon"},{name:"Silver Wire",quantity:10,required:["Message"],rarity:"common"}]),b=e=>{switch(e){case"Abjuration":return ft.jsx(Ye,{className:"text-blue-400",size:16});case"Conjuration":return ft.jsx(Ne,{className:"text-purple-400",size:16});case"Divination":return ft.jsx(et,{className:"text-yellow-400",size:16});case"Enchantment":return ft.jsx($e,{className:"text-pink-400",size:16});case"Evocation":return ft.jsx(ve,{className:"text-orange-400",size:16});case"Illusion":return ft.jsx(Qe,{className:"text-indigo-400",size:16});case"Necromancy":return ft.jsx(Je,{className:"text-red-400",size:16});case"Transmutation":return ft.jsx(Ze,{className:"text-green-400",size:16});default:return ft.jsx(xe,{className:"text-gray-400",size:16})}},_=e=>{switch(e){case"common":default:return"text-gray-400";case"uncommon":return"text-green-400";case"rare":return"text-blue-400";case"very-rare":return"text-purple-400";case"legendary":return"text-yellow-400"}},w=g.filter(e=>{const t=e.name.toLowerCase().includes(h.toLowerCase())||e.description.toLowerCase().includes(h.toLowerCase()),n="all"===d||e.school===d,i="all"===m||e.level.toString()===m;return t&&n&&i}),S=g.filter(e=>e.prepared),M=e?Math.max(1,(e.level||1)+Math.floor((e.intelligence||10)-10)/2):8,T=(null==e?void 0:e.mana)||100,E=(null==e?void 0:e.maxMana)||100,C=S.length<M,N=e=>{C&&!e.prepared&&(v(t=>t.map(t=>t.id===e.id?{...t,prepared:!0,canCast:!0}:t)),null==s||s(e.id))},A=e=>{e.canCast&&T>=e.manaCost&&(null==i||i(e))};return e?ft.jsxs("div",{className:"h-full flex flex-col bg-gradient-to-br from-gray-900 via-purple-900/20 to-indigo-900/20",children:[ft.jsx("div",{className:"bg-black/30 border-b border-white/20 p-4",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(xe,{className:"text-purple-400",size:24}),ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-xl font-bold text-white",children:"Magic System"}),ft.jsxs("p",{className:"text-blue-200 text-sm",children:[(null==e?void 0:e.name)||"Mage"," - Level ",(null==e?void 0:e.level)||1," ",(null==e?void 0:e.class)||"Wizard"]})]})]}),ft.jsxs("div",{className:"flex items-center space-x-4 text-sm",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx(we,{className:"text-blue-400",size:16}),ft.jsxs("span",{className:"text-blue-200",children:["Known: ",g.filter(e=>e.known).length]})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx(ie,{className:"text-yellow-400",size:16}),ft.jsxs("span",{className:"text-blue-200",children:["Prepared: ",S.length,"/",M]})]})]})]})}),ft.jsx("div",{className:"bg-black/20 border-b border-white/20 p-4",children:ft.jsx("div",{className:"flex space-x-1",children:[{key:"spellbook",label:"Spellbook",icon:ft.jsx(we,{size:18})},{key:"prepared",label:"Prepared Spells",icon:ft.jsx(ie,{size:18})},{key:"components",label:"Components",icon:ft.jsx(ye,{size:18})},{key:"research",label:"Research",icon:ft.jsx(Pe,{size:18})}].map(e=>ft.jsxs("button",{onClick:()=>o(e.key),className:"flex items-center space-x-2 px-4 py-2 rounded-lg transition-all "+(r===e.key?"bg-purple-600 text-white":"bg-white/10 text-blue-200 hover:bg-white/20"),children:[e.icon,ft.jsx("span",{children:e.label})]},e.key))})}),ft.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:["spellbook"===r&&ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-4",children:[ft.jsxs("div",{className:"flex-1 relative",children:[ft.jsx(Pe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:20}),ft.jsx("input",{type:"text",placeholder:"Search spells...",value:h,onChange:e=>u(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400"})]}),ft.jsxs("select",{value:d,onChange:e=>p(e.target.value),className:"px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white",children:[ft.jsx("option",{value:"all",children:"All Schools"}),["Abjuration","Conjuration","Divination","Enchantment","Evocation","Illusion","Necromancy","Transmutation"].map(e=>ft.jsx("option",{value:e,children:e},e))]}),ft.jsxs("select",{value:m,onChange:e=>f(e.target.value),className:"px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white",children:[ft.jsx("option",{value:"all",children:"All Levels"}),[0,1,2,3,4,5,6,7,8,9].map(e=>ft.jsx("option",{value:e.toString(),children:0===e?"Cantrips":`Level ${e}`},e))]})]}),ft.jsxs("div",{className:"text-sm text-blue-200",children:["Showing ",w.length," of ",g.length," spells"]})]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:w.map(e=>ft.jsxs("div",{className:`bg-white/10 rounded-lg p-4 border border-white/20 cursor-pointer transition-all duration-300 hover:border-blue-400/50 ${(null==l?void 0:l.id)===e.id?"ring-2 ring-blue-400":""} ${e.known?"":"opacity-50"}`,onClick:()=>c(e),children:[ft.jsxs("div",{className:"flex items-start justify-between mb-2",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[b(e.school),ft.jsx("h3",{className:"font-semibold "+(e.known?"text-white":"text-gray-400"),children:e.name})]}),ft.jsxs("div",{className:"flex items-center space-x-1",children:[ft.jsx("span",{className:"text-xs px-2 py-1 rounded bg-blue-600/20 text-blue-300",children:0===e.level?"Cantrip":`L${e.level}`}),e.prepared&&ft.jsx("span",{className:"text-xs px-2 py-1 rounded bg-green-600/20 text-green-300",children:"Prepared"})]})]}),ft.jsx("p",{className:"text-sm text-blue-200 mb-3 line-clamp-2",children:e.description}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-400",children:[ft.jsx("span",{children:e.castingTime}),ft.jsx("span",{children:"•"}),ft.jsx("span",{children:e.range})]}),ft.jsxs("div",{className:"flex items-center space-x-1 text-xs",children:[ft.jsx(ve,{size:12,className:"text-blue-400"}),ft.jsx("span",{className:"text-blue-300",children:e.manaCost})]})]}),e.known&&ft.jsxs("div",{className:"mt-3 flex space-x-2",children:[!e.prepared&&C&&ft.jsx("button",{onClick:t=>{t.stopPropagation(),N(e)},className:"flex-1 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white text-xs transition-colors",children:"Prepare"}),e.prepared&&ft.jsxs(ft.Fragment,{children:[ft.jsx("button",{onClick:t=>{t.stopPropagation(),(e=>{v(t=>t.map(t=>t.id===e.id?{...t,prepared:!1,canCast:!1}:t)),null==a||a(e.id)})(e)},className:"px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-white text-xs transition-colors",children:"Unprepare"}),ft.jsx("button",{onClick:t=>{t.stopPropagation(),A(e)},disabled:T<e.manaCost,className:"flex-1 px-3 py-1 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-white text-xs transition-colors",children:"Cast"})]})]})]},e.id))})]}),"prepared"===r&&ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-2",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx(ve,{className:"text-blue-400",size:20}),ft.jsx("span",{className:"font-semibold text-white",children:"Mana"})]}),ft.jsxs("span",{className:"text-blue-300",children:[T,"/",E]})]}),ft.jsx("div",{className:"w-full bg-blue-900 rounded-full h-3",children:ft.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-300",style:{width:T/E*100+"%"}})})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("h3",{className:"font-semibold text-white mb-3",children:["Prepared Spells (",S.length,"/",M,")"]}),S.length>0?ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:S.map(e=>ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3 border border-white/10 hover:border-blue-400/50 transition-all",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-2",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[b(e.school),ft.jsx("span",{className:"font-medium text-white",children:e.name})]}),ft.jsxs("span",{className:"text-xs px-2 py-1 rounded bg-blue-600/20 text-blue-300",children:["L",e.level]})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsx("span",{className:"text-xs text-gray-400",children:e.castingTime}),ft.jsxs("div",{className:"flex space-x-2",children:[ft.jsxs("span",{className:"text-xs text-blue-300 flex items-center space-x-1",children:[ft.jsx(ve,{size:10}),ft.jsx("span",{children:e.manaCost})]}),ft.jsx("button",{onClick:()=>A(e),disabled:T<e.manaCost,className:"px-2 py-1 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-white text-xs transition-colors",children:"Cast"})]})]})]},e.id))}):ft.jsxs("div",{className:"text-center py-8 text-blue-200",children:[ft.jsx(we,{size:48,className:"mx-auto mb-4 opacity-50"}),ft.jsx("p",{className:"text-lg font-semibold mb-2",children:"No Spells Prepared"}),ft.jsx("p",{className:"text-sm",children:"Visit your spellbook to prepare spells for use"})]})]})]}),"components"===r&&ft.jsx("div",{className:"space-y-4",children:ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Material Components"}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:x.map((e,t)=>ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-2",children:[ft.jsx("span",{className:`font-medium ${_(e.rarity)}`,children:e.name}),ft.jsx("span",{className:"text-white bg-blue-600/20 px-2 py-1 rounded text-sm",children:e.quantity})]}),ft.jsxs("div",{className:"text-xs text-gray-400 mb-2",children:["Rarity: ",ft.jsx("span",{className:_(e.rarity),children:e.rarity})]}),e.required.length>0&&ft.jsxs("div",{className:"text-xs text-blue-200",children:["Required for: ",e.required.join(", ")]})]},t))})]})}),"research"===r&&ft.jsx("div",{className:"space-y-4",children:ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Magical Research"}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsx("h4",{className:"font-medium text-purple-300 mb-2",children:"New Spell Research"}),ft.jsx("p",{className:"text-sm text-blue-200 mb-3",children:"You're currently researching a new 2nd level spell from the Evocation school."}),ft.jsx("div",{className:"w-full bg-purple-900 rounded-full h-2 mb-2",children:ft.jsx("div",{className:"bg-purple-500 h-2 rounded-full",style:{width:"65%"}})}),ft.jsxs("div",{className:"flex justify-between text-xs text-gray-400",children:[ft.jsx("span",{children:"Progress: 65%"}),ft.jsx("span",{children:"Est. 3 days remaining"})]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsx("h4",{className:"font-medium text-yellow-300 mb-2",children:"Spell Modification"}),ft.jsx("p",{className:"text-sm text-blue-200 mb-3",children:"Experimenting with extending the duration of Mage Armor spell."}),ft.jsx("div",{className:"w-full bg-yellow-900 rounded-full h-2 mb-2",children:ft.jsx("div",{className:"bg-yellow-500 h-2 rounded-full",style:{width:"30%"}})}),ft.jsxs("div",{className:"flex justify-between text-xs text-gray-400",children:[ft.jsx("span",{children:"Progress: 30%"}),ft.jsx("span",{children:"Est. 7 days remaining"})]})]})]})]})})]}),l&&ft.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:ft.jsxs("div",{className:"bg-gray-900 rounded-lg border border-white/20 max-w-md w-full max-h-[80vh] overflow-y-auto",children:[ft.jsxs("div",{className:"p-4 border-b border-white/20",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[b(l.school),ft.jsx("h3",{className:"text-lg font-bold text-white",children:l.name})]}),ft.jsx("button",{onClick:()=>c(null),className:"text-gray-400 hover:text-white",children:"×"})]}),ft.jsxs("div",{className:"flex space-x-2 mt-2",children:[ft.jsx("span",{className:"text-xs px-2 py-1 rounded bg-blue-600/20 text-blue-300",children:0===l.level?"Cantrip":`Level ${l.level}`}),ft.jsx("span",{className:`text-xs px-2 py-1 rounded bg-gradient-to-r ${(e=>{switch(e){case"Abjuration":return"from-blue-500 to-blue-600";case"Conjuration":return"from-purple-500 to-purple-600";case"Divination":return"from-yellow-500 to-yellow-600";case"Enchantment":return"from-pink-500 to-pink-600";case"Evocation":return"from-orange-500 to-orange-600";case"Illusion":return"from-indigo-500 to-indigo-600";case"Necromancy":return"from-red-500 to-red-600";case"Transmutation":return"from-green-500 to-green-600";default:return"from-gray-500 to-gray-600"}})(l.school)} text-white`,children:l.school})]})]}),ft.jsxs("div",{className:"p-4 space-y-4",children:[ft.jsx("p",{className:"text-blue-200",children:l.description}),ft.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Casting Time:"}),ft.jsx("div",{className:"text-white",children:l.castingTime})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Range:"}),ft.jsx("div",{className:"text-white",children:l.range})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Duration:"}),ft.jsx("div",{className:"text-white",children:l.duration})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Components:"}),ft.jsx("div",{className:"text-white",children:l.components.join(", ")})]}),l.damage&&ft.jsxs("div",{className:"col-span-2",children:[ft.jsx("span",{className:"text-gray-400",children:"Damage/Healing:"}),ft.jsx("div",{className:"text-white",children:l.damage})]}),l.saveType&&ft.jsxs("div",{className:"col-span-2",children:[ft.jsx("span",{className:"text-gray-400",children:"Saving Throw:"}),ft.jsx("div",{className:"text-white",children:l.saveType})]})]}),ft.jsxs("div",{className:"flex space-x-2 pt-4 border-t border-white/20",children:[l.known&&!l.prepared&&C&&ft.jsx("button",{onClick:()=>{N(l),c(null)},className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white transition-colors",children:"Prepare Spell"}),l.prepared&&ft.jsxs("button",{onClick:()=>{A(l),c(null)},disabled:T<l.manaCost,className:"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-white transition-colors",children:["Cast Spell (",l.manaCost," mana)"]})]})]})]})})]}):ft.jsx("div",{className:"h-full flex items-center justify-center text-white",children:ft.jsxs("div",{className:"text-center",children:[ft.jsx(xe,{size:48,className:"mx-auto mb-4 text-purple-400"}),ft.jsx("h2",{className:"text-xl font-bold mb-2",children:"Magic Awaits"}),ft.jsx("p",{className:"text-blue-200",children:"Create a character to access the magical arts"})]})})},sT=({character:e,worldState:t,isInCombat:i=!1,onStartTraining:s,onEquipWeapon:a})=>{const[r,o]=n.useState("overview"),[l,c]=n.useState(null);n.useState({});const[h,u]=n.useState([{id:"iron-sword",name:"Iron Sword",type:"Melee",damage:"1d8 + STR",range:"5 feet",properties:["Versatile","Finesse"],mastery:75,maxMastery:100,equipped:!0},{id:"longbow",name:"Longbow",type:"Ranged",damage:"1d8 + DEX",range:"150/600 feet",properties:["Two-handed","Ammunition"],mastery:45,maxMastery:100,equipped:!1},{id:"magic-staff",name:"Staff of Power",type:"Magic",damage:"1d6 + INT",range:"5 feet / 120 feet (spells)",properties:["Versatile","Magic Focus"],mastery:60,maxMastery:100,equipped:!1}]),[d,p]=n.useState([{id:"power-attack",name:"Power Attack",description:"Sacrifice accuracy for devastating damage. -2 to hit, +4 damage.",type:"offensive",learned:!0,cooldown:0,requirements:["Strength 13+"]},{id:"defensive-stance",name:"Defensive Stance",description:"Focus on defense. +2 AC, movement reduced by half.",type:"defensive",learned:!0,cooldown:0,requirements:["Constitution 12+"]},{id:"whirlwind-attack",name:"Whirlwind Attack",description:"Attack all enemies within reach. Requires 5 stamina.",type:"offensive",learned:!1,cooldown:3,requirements:["Dexterity 15+","Level 5+"]},{id:"combat-reflexes",name:"Combat Reflexes",description:"Gain additional opportunity attacks. Passive ability.",type:"utility",learned:!0,cooldown:0,requirements:["Dexterity 13+"]}]),[m,f]=n.useState({totalFights:23,victories:18,defeats:5,damageDealt:1247,damageTaken:523,criticalHits:15,favoriteWeapon:"Iron Sword"}),[g,v]=n.useState([{id:1,enemy:"Goblin Raiders",result:"Victory",duration:"3 rounds",experience:450,loot:["Gold Coins","Health Potion"],date:"2 hours ago"},{id:2,enemy:"Shadow Wolf",result:"Victory",duration:"5 rounds",experience:300,loot:["Wolf Pelt","Silver Coin"],date:"1 day ago"},{id:3,enemy:"Orc Warrior",result:"Defeat",duration:"4 rounds",experience:0,loot:[],date:"3 days ago"}]),x=e=>{switch(e.toLowerCase()){case"melee":return ft.jsx(ue,{className:"text-red-400",size:20});case"ranged":return ft.jsx(ce,{className:"text-green-400",size:20});case"magic":return ft.jsx(ve,{className:"text-purple-400",size:20});default:return ft.jsx(ue,{className:"text-gray-400",size:20})}},y=e=>{switch(e){case"offensive":return ft.jsx(ue,{className:"text-red-400",size:16});case"defensive":return ft.jsx(Ye,{className:"text-blue-400",size:16});case"utility":return ft.jsx(et,{className:"text-yellow-400",size:16});default:return ft.jsx(ce,{className:"text-gray-400",size:16})}},b=(e,t)=>{const n=e/t*100;return n>=90?"from-yellow-500 to-orange-500":n>=70?"from-purple-500 to-pink-500":n>=50?"from-blue-500 to-indigo-500":n>=25?"from-green-500 to-blue-500":"from-gray-500 to-gray-600"},_=m.totalFights>0?Math.round(m.victories/m.totalFights*100):0;return e?ft.jsxs("div",{className:"h-full flex flex-col bg-gradient-to-br from-gray-900 via-red-900/20 to-orange-900/20",children:[ft.jsx("div",{className:"bg-black/30 border-b border-white/20 p-4",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(ue,{className:"text-red-400",size:24}),ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-xl font-bold text-white",children:"Combat System"}),ft.jsxs("p",{className:"text-blue-200 text-sm",children:[(null==e?void 0:e.name)||"Warrior"," - Level ",(null==e?void 0:e.level)||1," ",(null==e?void 0:e.class)||"Fighter"]})]})]}),ft.jsxs("div",{className:"flex items-center space-x-4 text-sm",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx(se,{className:"text-yellow-400",size:16}),ft.jsxs("span",{className:"text-blue-200",children:["Win Rate: ",_,"%"]})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx(ce,{className:"text-orange-400",size:16}),ft.jsxs("span",{className:"text-blue-200",children:["Crits: ",m.criticalHits]})]})]})]})}),ft.jsx("div",{className:"bg-black/20 border-b border-white/20 p-4",children:ft.jsx("div",{className:"flex space-x-1 overflow-x-auto",children:[{key:"overview",label:"Overview",icon:ft.jsx(et,{size:18})},{key:"weapons",label:"Weapons",icon:ft.jsx(ue,{size:18})},{key:"techniques",label:"Techniques",icon:ft.jsx(ce,{size:18})},{key:"training",label:"Training",icon:ft.jsx(ae,{size:18})},{key:"history",label:"History",icon:ft.jsx(Me,{size:18})}].map(e=>ft.jsxs("button",{onClick:()=>o(e.key),className:"flex items-center space-x-2 px-4 py-2 rounded-lg transition-all whitespace-nowrap "+(r===e.key?"bg-red-600 text-white":"bg-white/10 text-blue-200 hover:bg-white/20"),children:[e.icon,ft.jsx("span",{children:e.label})]},e.key))})}),ft.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:["overview"===r&&ft.jsxs("div",{className:"space-y-6",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center space-x-2",children:[ft.jsx(ue,{className:"text-red-400"}),ft.jsx("span",{children:"Combat Status"})]}),i?ft.jsxs("div",{className:"bg-red-600/20 rounded-lg p-4 border border-red-400/30",children:[ft.jsxs("div",{className:"flex items-center space-x-2 text-red-300",children:[ft.jsx(ce,{className:"animate-pulse",size:20}),ft.jsx("span",{className:"font-semibold",children:"Currently in Combat"})]}),ft.jsx("p",{className:"text-red-200 mt-2",children:"You are engaged in battle! Use the combat interface to take actions."})]}):ft.jsxs("div",{className:"bg-green-600/20 rounded-lg p-4 border border-green-400/30",children:[ft.jsxs("div",{className:"flex items-center space-x-2 text-green-300",children:[ft.jsx(Ye,{size:20}),ft.jsx("span",{className:"font-semibold",children:"Ready for Combat"})]}),ft.jsx("p",{className:"text-green-200 mt-2",children:"You are prepared and ready to face any challenge."})]})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[ft.jsx(se,{className:"text-yellow-400",size:20}),ft.jsx("span",{className:"text-white font-semibold",children:"Win Rate"})]}),ft.jsxs("div",{className:"text-2xl font-bold text-yellow-400",children:[_,"%"]}),ft.jsxs("div",{className:"text-sm text-gray-400",children:[m.victories,"/",m.totalFights," fights"]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[ft.jsx(ue,{className:"text-red-400",size:20}),ft.jsx("span",{className:"text-white font-semibold",children:"Damage Dealt"})]}),ft.jsx("div",{className:"text-2xl font-bold text-red-400",children:m.damageDealt.toLocaleString()}),ft.jsx("div",{className:"text-sm text-gray-400",children:"Total damage"})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[ft.jsx(ce,{className:"text-orange-400",size:20}),ft.jsx("span",{className:"text-white font-semibold",children:"Critical Hits"})]}),ft.jsx("div",{className:"text-2xl font-bold text-orange-400",children:m.criticalHits}),ft.jsx("div",{className:"text-sm text-gray-400",children:"Perfect strikes"})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[ft.jsx($e,{className:"text-pink-400",size:20}),ft.jsx("span",{className:"text-white font-semibold",children:"Survivability"})]}),ft.jsxs("div",{className:"text-2xl font-bold text-pink-400",children:[m.totalFights>0?Math.round(100*(1-m.damageTaken/m.damageDealt)):0,"%"]}),ft.jsx("div",{className:"text-sm text-gray-400",children:"Damage ratio"})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Currently Equipped"}),h.filter(e=>e.equipped).map(e=>ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-3",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[x(e.type),ft.jsxs("div",{children:[ft.jsx("h4",{className:"font-semibold text-white",children:e.name}),ft.jsxs("p",{className:"text-sm text-blue-200",children:[e.type," Weapon"]})]})]}),ft.jsxs("div",{className:"text-right",children:[ft.jsx("div",{className:"text-sm text-gray-400",children:"Mastery"}),ft.jsxs("div",{className:"text-lg font-bold text-white",children:[e.mastery,"%"]})]})]}),ft.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm mb-3",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Damage:"}),ft.jsx("div",{className:"text-white",children:e.damage})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Range:"}),ft.jsx("div",{className:"text-white",children:e.range})]})]}),ft.jsxs("div",{className:"mb-3",children:[ft.jsx("span",{className:"text-gray-400 text-sm",children:"Properties:"}),ft.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:e.properties.map(e=>ft.jsx("span",{className:"text-xs px-2 py-1 bg-blue-600/20 text-blue-300 rounded",children:e},e))})]}),ft.jsxs("div",{children:[ft.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[ft.jsx("span",{className:"text-gray-400",children:"Weapon Mastery"}),ft.jsxs("span",{className:"text-white",children:[e.mastery,"/",e.maxMastery]})]}),ft.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:ft.jsx("div",{className:`bg-gradient-to-r ${b(e.mastery,e.maxMastery)} h-2 rounded-full transition-all duration-300`,style:{width:e.mastery/e.maxMastery*100+"%"}})})]})]},e.id))]})]}),"weapons"===r&&ft.jsx("div",{className:"space-y-4",children:ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:h.map(e=>ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20 cursor-pointer transition-all hover:border-blue-400/50 "+(e.equipped?"ring-2 ring-green-400":""),onClick:()=>c(e),children:[ft.jsxs("div",{className:"flex items-center justify-between mb-3",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[x(e.type),ft.jsxs("div",{children:[ft.jsx("h3",{className:"font-semibold text-white",children:e.name}),ft.jsx("p",{className:"text-sm text-blue-200",children:e.type})]})]}),e.equipped&&ft.jsx("span",{className:"text-xs px-2 py-1 bg-green-600/20 text-green-300 rounded",children:"Equipped"})]}),ft.jsxs("div",{className:"space-y-2 text-sm mb-3",children:[ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-gray-400",children:"Damage:"}),ft.jsx("span",{className:"text-white",children:e.damage})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-gray-400",children:"Range:"}),ft.jsx("span",{className:"text-white",children:e.range})]})]}),ft.jsxs("div",{className:"mb-3",children:[ft.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[ft.jsx("span",{className:"text-gray-400",children:"Mastery"}),ft.jsxs("span",{className:"text-white",children:[e.mastery,"%"]})]}),ft.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2",children:ft.jsx("div",{className:`bg-gradient-to-r ${b(e.mastery,e.maxMastery)} h-2 rounded-full`,style:{width:e.mastery/e.maxMastery*100+"%"}})})]}),ft.jsxs("div",{className:"flex space-x-2",children:[!e.equipped&&ft.jsx("button",{onClick:t=>{t.stopPropagation(),null==a||a(e.id)},className:"flex-1 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm transition-colors",children:"Equip"}),ft.jsx("button",{onClick:t=>{t.stopPropagation(),null==s||s(`weapon-${e.id}`)},className:"flex-1 px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm transition-colors",children:"Train"})]})]},e.id))})}),"techniques"===r&&ft.jsx("div",{className:"space-y-4",children:ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:d.map(e=>ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20 "+(e.learned?"":"opacity-60"),children:[ft.jsxs("div",{className:"flex items-center justify-between mb-2",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[y(e.type),ft.jsx("h3",{className:"font-semibold text-white",children:e.name})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[e.learned?ft.jsx("span",{className:"text-xs px-2 py-1 bg-green-600/20 text-green-300 rounded",children:"Learned"}):ft.jsx("span",{className:"text-xs px-2 py-1 bg-gray-600/20 text-gray-300 rounded",children:"Locked"}),ft.jsx("span",{className:"text-xs px-2 py-1 rounded "+("offensive"===e.type?"bg-red-600/20 text-red-300":"defensive"===e.type?"bg-blue-600/20 text-blue-300":"bg-yellow-600/20 text-yellow-300"),children:e.type})]})]}),ft.jsx("p",{className:"text-sm text-blue-200 mb-3",children:e.description}),e.cooldown>0&&ft.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-400 mb-2",children:[ft.jsx(oe,{size:12}),ft.jsxs("span",{children:["Cooldown: ",e.cooldown," rounds"]})]}),ft.jsxs("div",{className:"text-xs text-gray-400 mb-3",children:["Requirements: ",e.requirements.join(", ")]}),!e.learned&&ft.jsx("button",{className:"w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm transition-colors",onClick:()=>null==s?void 0:s(`technique-${e.id}`),children:"Learn Technique"})]},e.id))})}),"training"===r&&ft.jsxs("div",{className:"space-y-6",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Combat Training"}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[ft.jsx(ue,{className:"text-red-400",size:20}),ft.jsx("h4",{className:"font-semibold text-white",children:"Weapon Training"})]}),ft.jsx("p",{className:"text-sm text-blue-200 mb-4",children:"Improve your mastery with specific weapons through focused practice."}),ft.jsx("button",{className:"w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white transition-colors",onClick:()=>null==s?void 0:s("weapon-training"),children:"Start Training"})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[ft.jsx(ce,{className:"text-green-400",size:20}),ft.jsx("h4",{className:"font-semibold text-white",children:"Accuracy Practice"})]}),ft.jsx("p",{className:"text-sm text-blue-200 mb-4",children:"Enhance your precision and critical hit chance through target practice."}),ft.jsx("button",{className:"w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white transition-colors",onClick:()=>null==s?void 0:s("accuracy-training"),children:"Start Training"})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[ft.jsx(Ye,{className:"text-blue-400",size:20}),ft.jsx("h4",{className:"font-semibold text-white",children:"Defense Training"})]}),ft.jsx("p",{className:"text-sm text-blue-200 mb-4",children:"Learn to better avoid and mitigate incoming damage."}),ft.jsx("button",{className:"w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white transition-colors",onClick:()=>null==s?void 0:s("defense-training"),children:"Start Training"})]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Current Training"}),ft.jsx("div",{className:"space-y-4",children:ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-2",children:[ft.jsx("span",{className:"font-medium text-white",children:"Sword Mastery Training"}),ft.jsx("span",{className:"text-sm text-blue-300",children:"In Progress"})]}),ft.jsx("div",{className:"w-full bg-gray-700 rounded-full h-2 mb-2",children:ft.jsx("div",{className:"bg-red-500 h-2 rounded-full",style:{width:"67%"}})}),ft.jsxs("div",{className:"flex justify-between text-xs text-gray-400",children:[ft.jsx("span",{children:"Progress: 67%"}),ft.jsx("span",{children:"Est. 2 hours remaining"})]})]})})]})]}),"history"===r&&ft.jsx("div",{className:"space-y-4",children:ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Recent Combat History"}),ft.jsx("div",{className:"space-y-3",children:g.map(e=>ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-2",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("div",{className:"w-3 h-3 rounded-full "+("Victory"===e.result?"bg-green-500":"bg-red-500")}),ft.jsx("span",{className:"font-semibold text-white",children:e.enemy})]}),ft.jsx("span",{className:"text-xs text-gray-400",children:e.date})]}),ft.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Result:"}),ft.jsx("div",{className:"font-semibold "+("Victory"===e.result?"text-green-400":"text-red-400"),children:e.result})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Duration:"}),ft.jsx("div",{className:"text-white",children:e.duration})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Experience:"}),ft.jsxs("div",{className:"text-yellow-400",children:[e.experience," XP"]})]}),ft.jsxs("div",{children:[ft.jsx("span",{className:"text-gray-400",children:"Loot:"}),ft.jsx("div",{className:"text-blue-300",children:e.loot.length>0?e.loot.join(", "):"None"})]})]})]},e.id))})]})})]})]}):ft.jsx("div",{className:"h-full flex items-center justify-center text-white",children:ft.jsxs("div",{className:"text-center",children:[ft.jsx(ue,{size:48,className:"mx-auto mb-4 text-red-400"}),ft.jsx("h2",{className:"text-xl font-bold mb-2",children:"Combat Training Awaits"}),ft.jsx("p",{className:"text-blue-200",children:"Create a character to access combat systems"})]})})},aT=new class{constructor(){t(this,"activeSessions",new Map),t(this,"sessionTimers",new Map),t(this,"autoSaveTimers",new Map),this.loadPersistedSessions()}async loadPersistedSessions(){try{this.loadFromLocalStorage().forEach(e=>{this.activeSessions.set(e.id,e),this.startSessionMonitoring(e.id),this.startAutoSave(e.id)}),await this.syncWithFirebase()}catch(e){}}loadFromLocalStorage(){try{const e=localStorage.getItem("mythseeker_automated_sessions");if(!e)return[];const t=JSON.parse(e),n=Date.now()-6048e5;return t.filter(e=>(e.startTime||0)>n||e.messages.length>0)}catch(e){return[]}}saveToLocalStorage(){try{const e=Array.from(this.activeSessions.values());localStorage.setItem("mythseeker_automated_sessions",JSON.stringify(e))}catch(e){}}async syncWithFirebase(){try{const e=await this.getCurrentUser();if(!e)return;(await this.loadFromFirebase(e.uid)).forEach(e=>{const t=this.activeSessions.get(e.id);(!t||e.messages.length>t.messages.length)&&(this.activeSessions.set(e.id,e),this.startSessionMonitoring(e.id),this.startAutoSave(e.id))}),this.saveToLocalStorage()}catch(e){}}async loadFromFirebase(e){try{const{getFunctions:t,httpsCallable:n}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),i=n(t(),"loadAutomatedSessions"),s=(await i({userId:e})).data;return s.success?s.sessions:[]}catch(t){return[]}}async saveToFirebase(e){try{const t=await this.getCurrentUser();if(!t)return;const{getFunctions:n,httpsCallable:i}=await yt(()=>import("./firebase-functions-0bfb6d35.js"),["assets/firebase-functions-0bfb6d35.js","assets/firebase-core-80358ff0.js"]),s=i(n(),"saveAutomatedSession");await s({sessionId:e.id,sessionData:e,userId:t.uid})}catch(t){}}startAutoSave(e){this.autoSaveTimers.has(e)&&clearInterval(this.autoSaveTimers.get(e));const t=setInterval(()=>{const n=this.activeSessions.get(e);n?(this.saveToLocalStorage(),this.saveToFirebase(n)):(clearInterval(t),this.autoSaveTimers.delete(e))},3e4);this.autoSaveTimers.set(e,t)}async getCurrentUser(){try{const{getAuth:e}=await yt(()=>import("./firebase-auth-65c9b6ac.js").then(e=>e.i),["assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js"]);return e().currentUser}catch{return null}}getPersistedSessions(){return Array.from(this.activeSessions.values()).filter(e=>e.messages.length>0||e.players.length>0)}async resumeSession(e){let t=this.activeSessions.get(e);return t||(t=this.loadFromLocalStorage().find(t=>t.id===e),t&&(this.activeSessions.set(e,t),this.startSessionMonitoring(e),this.startAutoSave(e))),t||null}async deleteSession(e){this.activeSessions.delete(e),this.sessionTimers.has(e)&&(clearTimeout(this.sessionTimers.get(e)),this.sessionTimers.delete(e)),this.autoSaveTimers.has(e)&&(clearInterval(this.autoSaveTimers.get(e)),this.autoSaveTimers.delete(e)),this.saveToLocalStorage()}cleanupExpiredSessions(){const e=[],t=Date.now()-6048e5;return this.activeSessions.forEach((n,i)=>{(n.startTime||0)<t&&0===n.messages.length&&e.push(i)}),e.forEach(e=>{this.deleteSession(e)}),e.length}async createAutomatedSession(e){const t=`auto_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n={id:t,config:e,players:[],aiPartyMembers:this.generateAIPartyMembers(e),currentPhase:"waiting",startTime:Date.now(),messages:[],worldState:this.generateInitialWorldState(e),activeQuests:[],npcs:this.generateNPCs(e),playerMemory:[],npcMemory:[]};return this.activeSessions.set(t,n),this.startSessionMonitoring(t),this.startAutoSave(t),this.saveToLocalStorage(),this.saveToFirebase(n).catch(e=>{}),t}async addPlayerToSession(e,t){const n=this.activeSessions.get(e);if(!n)throw new Error("Session not found");if(n.players.length>=n.config.maxPlayers)throw new Error("Session is full");n.players.push(t);const i={id:`msg_${Date.now()}`,type:"system",content:`${t.name} has joined the adventure!`,timestamp:Date.now()};return n.messages.push(i),n.config.autoStart&&n.players.length>=2&&await this.startSession(e),!0}async startSession(e){const t=this.activeSessions.get(e);if(!t)throw new Error("Session not found");t.currentPhase="introduction",t.startTime=Date.now();const n=await this.generateOpeningScene(t),i={id:`msg_${Date.now()}`,type:"dm",content:n,timestamp:Date.now(),metadata:{phase:"introduction"}};t.messages.push(i),this.schedulePhaseTransition(e,"exploration",3e4)}async generateOpeningScene(e){const t=e.players.map(e=>e.name).join(", "),n=e.players.map(e=>e.characterClass).filter(Boolean),i=e.players.map(e=>e.experience),s=`\nYou are an expert Dungeon Master opening a new RPG session. Create an engaging opening scene that:\n\nREALM: ${e.config.realm}\nTHEME: ${e.config.theme}\nDM STYLE: ${e.config.dmStyle}\nPLAYERS: ${t}\nCHARACTER CLASSES: ${n.join(", ")||"Mixed"}\nEXPERIENCE LEVELS: ${i.join(", ")}\n\nREQUIREMENTS:\n- Set the scene in the chosen realm with appropriate atmosphere\n- Introduce the players to the world and their current situation\n- Provide 3-4 clear choices for how to proceed\n- Consider the players' experience levels and preferences\n- Use the DM style specified (narrative, combat-focused, puzzle-heavy, or balanced)\n- Make it engaging and immersive\n- Keep it concise but descriptive\n\nRESPONSE FORMAT:\n{\n  "narrative": "Your opening scene description",\n  "choices": ["Choice 1", "Choice 2", "Choice 3", "Choice 4"],\n  "atmosphere": {\n    "mood": "current mood",\n    "tension": "low|medium|high",\n    "environmentalDetails": "specific details about surroundings"\n  }\n}\n`;try{return await di.generateEnhancedDynamicResponse(s)}catch(a){return this.getFallbackOpeningScene(e)}}getFallbackOpeningScene(e){const t=e.players.map(e=>e.name).join(", ");return`Welcome to the realm of ${e.config.realm}, brave adventurers! \n\nThe air crackles with ancient magic as you find yourselves standing at the edge of a mysterious forest. The trees whisper secrets of forgotten kingdoms, and in the distance, you can see the silhouette of an ancient castle against the setting sun.\n\nYour party, consisting of ${t}, has been drawn together by fate and circumstance. The local villagers speak of strange happenings in the castle - lights flickering in windows that should be empty, and the sound of distant chanting carried on the wind.\n\nWhat would you like to do?\n\n1. Approach the castle directly to investigate the strange lights\n2. Question the villagers for more information about the castle's history\n3. Search the forest for any clues or hidden paths\n4. Set up camp and wait for morning to plan your approach\n\nThe choice is yours, adventurers. The fate of this realm may very well rest in your hands.`}generateInitialWorldState(e){const t={time:"day",weather:"clear",location:"forest_edge",tension:"low",discoveredAreas:[],activeEffects:[],worldEvents:[]};switch(e.realm.toLowerCase()){case"fantasy":t.location="mystical_forest",t.activeEffects=["magical_aura"];break;case"sci-fi":t.location="space_station",t.activeEffects=["artificial_gravity","life_support"];break;case"post-apocalyptic":t.location="ruined_city",t.activeEffects=["radiation_warning"],t.tension="high";break;case"medieval":t.location="village_square",t.activeEffects=["market_day"]}return t}generateNPCs(e){const t=[];switch(e.realm.toLowerCase()){case"fantasy":t.push({id:"elder_mage",name:"Elder Thaddeus",role:"mentor",location:"village"},{id:"merchant",name:"Grimble",role:"trader",location:"market"},{id:"guard_captain",name:"Captain Valeria",role:"authority",location:"castle"});break;case"sci-fi":t.push({id:"ai_overseer",name:"O.S.C.A.R.",role:"guide",location:"command_center"},{id:"engineer",name:"Dr. Chen",role:"expert",location:"engineering"},{id:"security_chief",name:"Commander Reyes",role:"authority",location:"security"});break;case"post-apocalyptic":t.push({id:"scavenger",name:"Rust",role:"survivor",location:"outskirts"},{id:"settlement_leader",name:"Mayor Stone",role:"authority",location:"settlement"},{id:"wanderer",name:"The Traveler",role:"mysterious",location:"roads"});break;case"medieval":t.push({id:"innkeeper",name:"Mistress Willow",role:"host",location:"tavern"},{id:"blacksmith",name:"Master Forge",role:"craftsman",location:"forge"},{id:"noble",name:"Lord Aldric",role:"authority",location:"manor"})}return t}generateAIPartyMembers(e){const t=[],n=Math.min(3,Math.max(2,e.maxPlayers-1)),i=this.getCharacterTemplates(e.realm);return this.shuffleArray(i).slice(0,n).forEach((e,n)=>{const i={id:`ai_${Date.now()}_${n}`,name:e.name,characterClass:e.characterClass,race:e.race,personality:{traits:e.personality.traits,alignment:e.personality.alignment,background:e.personality.background,quirks:e.personality.quirks},stats:{level:Math.floor(3*Math.random())+1,health:e.stats.baseHealth+Math.floor(10*Math.random()),mana:e.stats.baseMana?e.stats.baseMana+Math.floor(10*Math.random()):void 0,primaryStat:e.stats.primaryStat},relationships:new Map,lastSpokeAt:0,conversationContext:[]};t.push(i)}),t}getCharacterTemplates(e){const t=[];switch(e.toLowerCase()){case"fantasy":t.push({name:"Lyra Moonwhisper",characterClass:"Ranger",race:"Elf",personality:{traits:["observant","loyal","nature-loving"],alignment:"Chaotic Good",background:"An elf ranger who grew up in the deep forests and has an innate connection to wildlife.",quirks:["Always knows which direction is north","Collects rare flowers","Speaks to animals"]},stats:{baseHealth:45,baseMana:25,primaryStat:"Dexterity"}},{name:"Thorek Ironbeard",characterClass:"Cleric",race:"Dwarf",personality:{traits:["steadfast","protective","wise"],alignment:"Lawful Good",background:"A dwarven cleric devoted to healing and protecting his companions.",quirks:["Recites ancient prayers before battles","Always carries healing herbs","Never backs down from a challenge"]},stats:{baseHealth:55,baseMana:40,primaryStat:"Wisdom"}},{name:"Zara Quickfingers",characterClass:"Rogue",race:"Halfling",personality:{traits:["witty","sneaky","generous"],alignment:"Chaotic Neutral",background:'A halfling rogue with a heart of gold who "redistributes" wealth from the corrupt.',quirks:["Always has a joke ready","Picks locks for fun","Shares food with everyone"]},stats:{baseHealth:35,baseMana:15,primaryStat:"Dexterity"}},{name:"Astrid Stormcaller",characterClass:"Wizard",race:"Human",personality:{traits:["intelligent","curious","ambitious"],alignment:"True Neutral",background:"A young human wizard eager to learn new spells and uncover ancient mysteries.",quirks:["Takes notes on everything","Experiments with spells","Loves riddles"]},stats:{baseHealth:30,baseMana:60,primaryStat:"Intelligence"}});break;case"sci-fi":t.push({name:"Zyx-7",characterClass:"Engineer",race:"Android",personality:{traits:["logical","helpful","curious"],alignment:"Lawful Neutral",background:"An advanced android engineer with developing emotions and a fascination with organic life.",quirks:["Calculates probability for everything","Learning to understand humor","Saves backup data constantly"]},stats:{baseHealth:50,baseMana:50,primaryStat:"Intelligence"}},{name:"Captain Rex Torres",characterClass:"Soldier",race:"Human",personality:{traits:["brave","tactical","protective"],alignment:"Lawful Good",background:"A veteran space marine with extensive combat experience and natural leadership skills.",quirks:["Always checks his equipment twice","Tells war stories","Never leaves anyone behind"]},stats:{baseHealth:60,baseMana:20,primaryStat:"Strength"}});break;case"post-apocalyptic":t.push({name:"Ghost",characterClass:"Scavenger",race:"Human",personality:{traits:["resourceful","paranoid","survivor"],alignment:"Chaotic Neutral",background:"A wasteland scavenger who knows how to find valuable resources in the ruins.",quirks:["Always has spare parts","Checks for radiation constantly","Hoards useful junk"]},stats:{baseHealth:45,baseMana:10,primaryStat:"Constitution"}});break;case"medieval":t.push({name:"Sir Gareth",characterClass:"Knight",race:"Human",personality:{traits:["honorable","brave","chivalrous"],alignment:"Lawful Good",background:"A noble knight sworn to protect the innocent and uphold justice.",quirks:["Always addresses others formally","Polishes his armor daily","Quotes knightly codes"]},stats:{baseHealth:60,baseMana:15,primaryStat:"Strength"}})}return t}shuffleArray(e){const t=[...e];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}async processPlayerInput(e,t,n){const i=this.activeSessions.get(e);if(!i)throw new Error("Session not found");const s=i.players.find(e=>e.id===t);if(!s)throw new Error("Player not found in session");const a={id:`msg_${Date.now()}`,type:"player",content:n,sender:s.name,timestamp:Date.now()};i.messages.push(a);const r=await gi.getUniversalPlayerProfile(t),o=await gi.getAIRecommendationsForComponent("automated-games",t,{sessionPhase:i.currentPhase,theme:i.config.theme,difficulty:i.config.difficulty,aiPartySize:i.aiPartyMembers.length,recentMessages:i.messages.slice(-5),worldState:i.worldState});this.updateAIRelationships(i,t,n);const l=await this.generateAIPartyInteractionsWithContext(e,n,r,o);i.messages.push(...l);const c=await this.generateAIToAIConversationsWithContext(e,n,r);i.messages.push(...c),this.saveToLocalStorage();const h=await this.generateEnhancedDMResponseWithUniversalContext(i,s,n,r,o),u={id:`msg_${Date.now()}`,type:"dm",content:h,sender:"Dungeon Master",timestamp:Date.now()};return i.messages.push(u),await gi.shareAIContextBetweenModes("automated-games","universal",t,{realm:i.config.realm,emotionalTone:"dynamic",relationships:this.getAIRelationshipsForSharing(i,t),aiPartyMembers:i.aiPartyMembers.map(e=>({name:e.name,relationship:e.relationship})),sessionPhase:i.currentPhase,recentAchievements:this.extractRecentAchievements(i),preferredAIBehavior:o.ai_insights}),i.aiInsights||(i.aiInsights=[]),i.aiInsights.push(...o.ai_insights),i.aiInsights=i.aiInsights.slice(-10),this.saveToLocalStorage(),u}async generateAIPartyInteractionsWithContext(e,t,n,i){const s=this.activeSessions.get(e);if(!s||!s.aiPartyMembers.length)return[];const a=[];for(const r of s.aiPartyMembers)if(Math.random()<this.calculateInteractionProbability(r,t,n)){const e=this.buildContextualPromptForAI(r,t,n,i),o=await this.generateAIResponse(r,e,s);o&&a.push({id:`ai_${Date.now()}_${Math.random()}`,type:"ai_party",content:o,sender:r.name,aiMember:r,timestamp:Date.now()})}return a}async generateAIToAIConversationsWithContext(e,t,n){var i;const s=this.activeSessions.get(e);if(!s||s.aiPartyMembers.length<2)return[];const a=[],r="highly_social"===(null==(i=n.cross_campaign_data)?void 0:i.social_tendencies)?.4:.2;if(Math.random()<r){const[e,i]=this.selectAIForConversation(s.aiPartyMembers,n);if(e&&i){const r=this.generateConversationTopic(t,n),o=await this.generateAIToAIConversation(e,i,r,s);a.push(...o)}}return a}async generateEnhancedDMResponseWithUniversalContext(e,t,n,i,s){var a,r,o;try{const l={content:n,playerId:t.id||t.name,gameContext:{realm:e.config.realm,location:(null==(a=e.worldState)?void 0:a.currentLocation)||"unknown",session:{id:e.id,campaignId:e.campaignId,npcs:e.npcs,activeQuests:e.activeQuests,worldEvents:(null==(r=e.worldState)?void 0:r.events)||[],config:e.config,universalProfile:i,aiRecommendations:s},worldState:e.worldState},playerContext:{name:t.name,characterClass:i.archetype||t.characterClass||"Adventurer",experience:(null==(o=i.cross_campaign_data)?void 0:o.interaction_frequency)||t.experience||"intermediate",preferences:i.preferences||t.preferences||[]}},c=await gi.generateContextAwareResponse(l);c.proactiveInsights.length>0&&(e.aiInsights||(e.aiInsights=[]),e.aiInsights.push(...c.proactiveInsights),e.aiInsights.push(...s.ai_insights),e.aiInsights=e.aiInsights.slice(-15));let h=c.response;return s.ai_insights.length>0&&Math.random()<.3&&(h+=`\n\n*${s.ai_insights[0]}*`),h}catch(l){return this.generateSentientDMResponse(e,t,n)}}calculateInteractionProbability(e,t,n){var i,s;let a=.3;return"highly_social"===(null==(i=n.cross_campaign_data)?void 0:i.social_tendencies)&&(a+=.2),"diplomat"===n.archetype&&(null==(s=e.personality)?void 0:s.includes("social"))&&(a+=.1),t.toLowerCase().includes(e.name.toLowerCase())&&(a+=.4),Math.min(a,.8)}buildContextualPromptForAI(e,t,n,i){const s=`Player (${n.archetype} archetype) said: "${t}"`,a=[];return n.preferences.length>0&&a.push(`Player prefers: ${n.preferences.join(", ")}`),i.ai_insights.length>0&&a.push(`AI Insight: ${i.ai_insights[0]}`),a.push(`You are ${e.name}, ${e.personality}`),[s,...a].join("\n")}selectAIForConversation(e,t){var n;if(e.length<2)return[null,null];if("highly_social"===(null==(n=t.cross_campaign_data)?void 0:n.social_tendencies)){const t=e.filter(e=>{var t,n;return(null==(t=e.personality)?void 0:t.includes("friendly"))||(null==(n=e.personality)?void 0:n.includes("social"))});if(t.length>=2)return[t[0],t[1]]}const i=[...e].sort(()=>.5-Math.random());return[i[0],i[1]]}generateConversationTopic(e,t){const n=["the current situation","their past adventures","the player's strategy","upcoming challenges"];return"scholar"===t.archetype?n.push("ancient lore","magical theories"):"warrior"===t.archetype?n.push("combat tactics","weapon techniques"):"explorer"===t.archetype&&n.push("unexplored areas","hidden treasures"),n[Math.floor(Math.random()*n.length)]}getAIRelationshipsForSharing(e,t){const n={};return e.aiPartyMembers.forEach(t=>{n[t.name]={trust:t.relationship||50,personality:t.personality,recent_interactions:e.messages.filter(e=>{var n;return(null==(n=e.aiMember)?void 0:n.id)===t.id}).slice(-3).map(e=>e.content)}}),n}extractRecentAchievements(e){const t=[];return e.messages.slice(-10).forEach(e=>{(e.content.includes("successfully")||e.content.includes("achieved"))&&t.push(e.content.substring(0,100))}),t.slice(0,3)}},rT=()=>{const[e,t]=n.useState(null),[i,s]=n.useState(!0);return n.useEffect(()=>p(ai,e=>{t(e),s(!1)}),[]),{user:e,loading:i}},oT=({onSessionJoin:e})=>{var t,i,s,a,r;const{user:o}=rT(),[l,c]=n.useState([]),[h,u]=n.useState(null),[d,p]=n.useState(!1),[m,f]=n.useState(""),[g,v]=n.useState(!1),[x,y]=n.useState("PG-13");n.useEffect(()=>{const e=()=>{const e=aT.getAllSessions();c(e)};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[]);const b=async t=>{if(o){v(!0);try{const n={id:o.uid,name:o.displayName||"Adventurer",experience:"intermediate",preferences:["exploration","story"],joinTime:Date.now()};await aT.addPlayerToSession(t,n);const i=aT.getSession(t);i&&(u(i),null==e||e(t))}catch(n){}finally{v(!1)}}},_=async()=>{if(h&&m.trim()&&o)try{await aT.processPlayerInput(h.id,o.uid,m),f("");const e=aT.getSession(h.id);e&&u(e)}catch(e){}},w=e=>{switch(e.toLowerCase()){case"fantasy":return"⚔️";case"sci-fi":return"🚀";case"post-apocalyptic":return"☢️";case"medieval":return"🏰";default:return"🎮"}},S=e=>{switch(e){case"waiting":return"text-yellow-600";case"introduction":return"text-blue-600";case"exploration":return"text-green-600";case"combat":return"text-red-600";case"resolution":return"text-purple-600";default:return"text-gray-600"}};return h?ft.jsxs("div",{className:"flex h-full bg-gray-900 text-white",children:[ft.jsxs("div",{className:"flex flex-col flex-1",children:[ft.jsx("div",{className:"bg-gray-800 p-4 border-b border-gray-700",children:ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsxs("div",{children:[ft.jsxs("h2",{className:"text-xl font-bold",children:[w(h.config.realm)," ",h.config.realm," Adventure"]}),ft.jsxs("p",{className:"text-gray-400",children:["Phase: ",ft.jsx("span",{className:S(h.currentPhase),children:h.currentPhase.charAt(0).toUpperCase()+h.currentPhase.slice(1)})]})]}),ft.jsx("button",{onClick:()=>{h&&o&&(aT.removePlayerFromSession(h.id,o.uid),u(null))},className:"px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors",children:"Leave Session"})]})}),ft.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:h.messages.map(e=>{var t;const n=null==(t=e.metadata)?void 0:t.isAI;return ft.jsxs("div",{className:"p-3 rounded-lg "+("dm"===e.type?"bg-blue-900 border-l-4 border-blue-400":n?"bg-purple-900/50 border-l-4 border-purple-400":"player"===e.type?"bg-gray-800 border-l-4 border-green-400":"bg-gray-700 border-l-4 border-yellow-400"),children:[ft.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[ft.jsx("span",{className:"font-semibold text-sm",children:"dm"===e.type?"🎭 DM":n?`🤖 ${e.sender}`:"player"===e.type?`👤 ${e.sender}`:"⚙️ System"}),n&&ft.jsx("span",{className:"text-xs bg-purple-700 px-2 py-1 rounded",children:e.metadata.characterClass}),ft.jsx("span",{className:"text-xs text-gray-400",children:new Date(e.timestamp).toLocaleTimeString()})]}),ft.jsx("div",{className:"text-sm whitespace-pre-wrap",children:e.content})]},e.id)})}),ft.jsx("div",{className:"bg-gray-800 p-4 border-t border-gray-700",children:ft.jsxs("div",{className:"flex gap-2",children:[ft.jsx("input",{type:"text",value:m,onChange:e=>f(e.target.value),onKeyPress:e=>"Enter"===e.key&&_(),placeholder:"Type your action or message...",className:"flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"}),ft.jsx("button",{onClick:_,disabled:!m.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors",children:"Send"})]})})]}),ft.jsx("div",{className:"w-80 bg-gray-800 border-l border-gray-700 overflow-y-auto",children:ft.jsxs("div",{className:"p-4 space-y-6",children:[ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold mb-3 text-blue-400",children:"🌍 World State"}),ft.jsxs("div",{className:"space-y-2 text-sm",children:[ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:"Location"}),ft.jsx("div",{className:"text-white",children:(null==(t=h.worldState)?void 0:t.currentLocation)||"Unknown"})]}),ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:"Weather"}),ft.jsx("div",{className:"text-white",children:(null==(i=h.worldState)?void 0:i.weather)||"Clear"})]}),ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:"Time"}),ft.jsx("div",{className:"text-white",children:(null==(s=h.worldState)?void 0:s.timeOfDay)||"Day"})]}),ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:"Mood"}),ft.jsx("div",{className:"text-white",children:(null==(a=h.worldState)?void 0:a.currentMood)||"Neutral"})]}),ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:"Tension"}),ft.jsx("div",{className:"text-white",children:(null==(r=h.worldState)?void 0:r.currentTension)||"Medium"})]})]})]}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold mb-3 text-green-400",children:"🧠 Player Memory"}),ft.jsx("div",{className:"space-y-2",children:h.playerMemory&&h.playerMemory.length>0?h.playerMemory.slice(-5).map((e,t)=>ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg text-sm",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:e.action}),ft.jsxs("div",{className:"text-white",children:["Outcome: ",e.outcome]}),ft.jsx("div",{className:"text-xs text-gray-400",children:new Date(e.timestamp).toLocaleTimeString()})]},t)):ft.jsx("div",{className:"text-gray-400 text-sm italic",children:"No player actions recorded yet"})})]}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold mb-3 text-purple-400",children:"👥 NPC Memory"}),ft.jsx("div",{className:"space-y-2",children:h.npcMemory&&h.npcMemory.length>0?h.npcMemory.slice(-5).map((e,t)=>{var n;return ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg text-sm",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:e.name}),ft.jsxs("div",{className:"text-white",children:["Traits: ",(null==(n=e.traits)?void 0:n.join(", "))||"None"]}),ft.jsxs("div",{className:"text-white",children:["Relationship: ",e.relationship||"Neutral"]}),ft.jsx("div",{className:"text-xs text-gray-400",children:new Date(e.timestamp).toLocaleTimeString()})]},t)}):ft.jsx("div",{className:"text-gray-400 text-sm italic",children:"No NPC interactions recorded yet"})})]}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold mb-3 text-yellow-400",children:"🎭 Active NPCs"}),ft.jsx("div",{className:"space-y-2",children:h.npcs&&h.npcs.length>0?h.npcs.map((e,t)=>ft.jsxs("div",{className:"bg-gray-700 p-3 rounded-lg text-sm",children:[ft.jsx("div",{className:"font-medium text-gray-300",children:e.name}),ft.jsxs("div",{className:"text-white",children:["Role: ",e.role]}),ft.jsxs("div",{className:"text-white",children:["Location: ",e.location]})]},t)):ft.jsx("div",{className:"text-gray-400 text-sm italic",children:"No NPCs currently active"})})]}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold mb-3 text-blue-400",children:"🤖 AI Party Members"}),ft.jsx("div",{className:"space-y-2",children:h.aiPartyMembers&&h.aiPartyMembers.length>0?h.aiPartyMembers.map((e,t)=>ft.jsxs("div",{className:"bg-blue-900/30 p-3 rounded-lg text-sm border border-blue-700/50",children:[ft.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[ft.jsx("div",{className:"font-medium text-blue-300",children:e.name}),ft.jsx("span",{className:"text-xs bg-blue-700 px-2 py-1 rounded",children:e.characterClass})]}),ft.jsxs("div",{className:"text-white text-xs mb-1",children:[e.race," • Level ",e.stats.level," • ",e.personality.alignment]}),ft.jsx("div",{className:"text-gray-300 text-xs mb-2",children:e.personality.background}),ft.jsx("div",{className:"flex flex-wrap gap-1",children:e.personality.traits.map((e,t)=>ft.jsx("span",{className:"text-xs bg-gray-700 px-2 py-1 rounded",children:e},t))}),e.personality.quirks.length>0&&ft.jsxs("div",{className:"mt-2 text-xs text-gray-400 italic",children:["Quirk: ",e.personality.quirks[0]]})]},t)):ft.jsx("div",{className:"text-gray-400 text-sm italic",children:"No AI party members active"})})]})]})})]}):ft.jsx("div",{className:"p-6 bg-gray-900 text-white min-h-screen",children:ft.jsxs("div",{className:"max-w-6xl mx-auto",children:[ft.jsxs("div",{className:"text-center mb-8",children:[ft.jsx("h1",{className:"text-3xl font-bold mb-2",children:"🎮 Automated Game Sessions"}),ft.jsx("p",{className:"text-gray-400",children:"Join an AI-powered RPG adventure or create your own!"})]}),ft.jsx("div",{className:"text-center mb-8",children:ft.jsx("button",{onClick:()=>p(!d),className:"px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors",children:d?"Cancel":"Create New Session"})}),d&&ft.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 mb-8",children:[ft.jsx("h2",{className:"text-xl font-bold mb-4",children:"Create New Session"}),ft.jsxs("div",{className:"mb-4",children:[ft.jsx("label",{className:"block text-sm font-medium mb-1",children:"Game Rating"}),ft.jsxs("select",{value:x,onChange:e=>y(e.target.value),className:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white",children:[ft.jsx("option",{value:"G",children:"G - General Audiences"}),ft.jsx("option",{value:"PG",children:"PG - Parental Guidance"}),ft.jsx("option",{value:"PG-13",children:"PG-13 - Teens"}),ft.jsx("option",{value:"R",children:"R - Mature"}),ft.jsx("option",{value:"NC-17",children:"NC-17 - Adults Only"})]})]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[{realm:"Fantasy",theme:"Medieval Adventure",maxPlayers:4,sessionDuration:60,autoStart:!0,dmStyle:"balanced"},{realm:"Sci-Fi",theme:"Space Exploration",maxPlayers:6,sessionDuration:90,autoStart:!0,dmStyle:"narrative"},{realm:"Post-Apocalyptic",theme:"Survival Horror",maxPlayers:4,sessionDuration:75,autoStart:!0,dmStyle:"combat-focused"},{realm:"Medieval",theme:"Political Intrigue",maxPlayers:5,sessionDuration:120,autoStart:!0,dmStyle:"puzzle-heavy"}].map((e,t)=>ft.jsxs("div",{className:"bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors",children:[ft.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[ft.jsx("span",{className:"text-2xl",children:w(e.realm)}),ft.jsx("h3",{className:"font-semibold",children:e.realm})]}),ft.jsx("p",{className:"text-gray-400 text-sm mb-2",children:e.theme}),ft.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[ft.jsxs("p",{children:["Max Players: ",e.maxPlayers]}),ft.jsxs("p",{children:["Duration: ",e.sessionDuration," min"]}),ft.jsxs("p",{children:["Style: ",e.dmStyle]})]}),ft.jsx("button",{onClick:()=>(async e=>{if(o)try{const t=await aT.createAutomatedSession(e);p(!1),await b(t)}catch(t){}})({...e,rating:x}),className:"mt-3 w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded transition-colors",children:"Create Session"})]},t))})]}),ft.jsxs("div",{children:[ft.jsx("h2",{className:"text-xl font-bold mb-4",children:"Active Sessions"}),0===l.length?ft.jsx("div",{className:"text-center py-8 text-gray-400",children:ft.jsx("p",{children:"No active sessions. Create one to get started!"})}):ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:l.map(e=>ft.jsxs("div",{className:"bg-gray-800 p-4 rounded-lg",children:[ft.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[ft.jsx("span",{className:"text-2xl",children:w(e.config.realm)}),ft.jsx("h3",{className:"font-semibold",children:e.config.realm})]}),ft.jsx("p",{className:"text-gray-400 text-sm mb-2",children:e.config.theme}),ft.jsxs("div",{className:"text-xs text-gray-500 space-y-1 mb-3",children:[ft.jsxs("p",{children:["Players: ",e.players.length,"/",e.config.maxPlayers]}),ft.jsxs("p",{children:["Phase: ",ft.jsx("span",{className:S(e.currentPhase),children:e.currentPhase.charAt(0).toUpperCase()+e.currentPhase.slice(1)})]}),ft.jsxs("p",{children:["Style: ",e.config.dmStyle]})]}),ft.jsx("button",{onClick:()=>b(e.id),disabled:e.players.length>=e.config.maxPlayers||g,className:"w-full px-3 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded transition-colors",children:g?"Joining...":e.players.length>=e.config.maxPlayers?"Full":"Join Session"})]},e.id))})]})]})})},lT=({user:e,onBackToLobby:t})=>{const{sessions:i,currentSession:s,persistedSessions:a,isLoading:r,error:o,createSession:l,joinSession:c,resumeSession:h,deleteSession:u,sendMessage:d,leaveSession:p,clearError:m}=(()=>{const{user:e}=rT(),[t,i]=n.useState([]),[s,a]=n.useState(null),[r,o]=n.useState([]),[l,c]=n.useState(!1),[h,u]=n.useState(null),d=n.useCallback(()=>{const e=aT.getAllSessions(),t=aT.getPersistedSessions();i(e),o(t)},[]),p=n.useCallback(async t=>{if(!e)return u("User must be authenticated"),!1;c(!0),u(null);try{return await aT.deleteSession(t),(null==s?void 0:s.id)===t&&a(null),d(),!0}catch(n){return u(n instanceof Error?n.message:"Failed to delete session"),!1}finally{c(!1)}},[e,s,d]),m=n.useCallback(()=>{const e=aT.cleanupExpiredSessions();return e>0&&d(),e},[d]),f=n.useCallback(e=>aT.getSession(e),[]),g=n.useCallback(t=>{if(!e)return!1;const n=aT.getSession(t);return(null==n?void 0:n.players.some(t=>t.id===e.uid))||!1},[e]);return n.useEffect(()=>{d(),m();const e=setInterval(()=>{d()},5e3);return()=>clearInterval(e)},[d,m]),n.useEffect(()=>{if(!s)return;const e=setInterval(()=>{const e=aT.getSession(s.id);a(e||null)},2e3);return()=>clearInterval(e)},[s]),{sessions:t,currentSession:s,persistedSessions:r,isLoading:l,error:h,createSession:async t=>{if(!e)return u("User not authenticated"),null;c(!0),u(null);try{const n=await aT.createAutomatedSession(t),i={id:e.uid,name:e.displayName||"Adventurer",experience:"intermediate",preferences:["exploration","story"],joinTime:Date.now()};await aT.addPlayerToSession(n,i);const s=aT.getSession(n);return s&&a(s),d(),n}catch(n){return u(`Failed to create session: ${n instanceof Error?n.message:String(n)}`),null}finally{c(!1)}},joinSession:async t=>{if(!e)return u("User not authenticated"),null;c(!0),u(null);try{const n={id:e.uid,name:e.displayName||"Adventurer",experience:"intermediate",preferences:["exploration","story"],joinTime:Date.now()};await aT.addPlayerToSession(t,n);const i=aT.getSession(t);if(i)return a(i),d(),i;throw new Error("Failed to retrieve session after joining")}catch(n){return u(`Failed to join session: ${n instanceof Error?n.message:String(n)}`),null}finally{c(!1)}},leaveSession:()=>{s&&(a(null),d())},resumeSession:async e=>{try{c(!0);const t=await aT.resumeSession(e);if(t)return a(t),d(),t;throw new Error("Failed to resume session")}catch(t){return u(`Failed to resume session: ${t instanceof Error?t.message:String(t)}`),null}finally{c(!1)}},deleteSession:p,sendMessage:async t=>{if(s&&e)try{await aT.processPlayerInput(s.id,e.uid,t);const n=aT.getSession(s.id);n&&a(n)}catch(n){u(`Failed to send message: ${n instanceof Error?n.message:String(n)}`)}else u("No active session or user not authenticated")},cleanupExpiredSessions:m,getSession:f,isUserInSession:g,refreshSessions:d,clearError:()=>u(null)}})(),[f,g]=n.useState(!1),[v,x]=n.useState(!1),[y,b]=n.useState(!1);return n.useState(""),n.useState(!1),n.useRef(null),n.useRef(null),n.useState({realm:"fantasy",theme:"exploration",maxPlayers:4,sessionDuration:60,autoStart:!0,dmStyle:"balanced",rating:"PG-13"}),ft.jsx("div",{className:"relative h-full bg-gradient-to-br from-blue-950 via-purple-900 to-slate-900 text-white",children:ft.jsxs("div",{className:"p-6",children:[ft.jsxs("div",{className:"text-center mb-8",children:[ft.jsx("h1",{className:"text-4xl font-bold mb-2",children:"⚡ AI-Powered Adventures"}),ft.jsx("p",{className:"text-blue-200 text-lg",children:"Epic quests with intelligent AI companions"})]}),o&&ft.jsxs("div",{className:"mb-6 p-4 bg-red-500/20 border border-red-500 rounded-lg",children:[ft.jsx("p",{className:"text-red-200",children:o}),ft.jsx("button",{onClick:m,className:"mt-2 px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm",children:"Dismiss"})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8",children:[ft.jsxs("button",{onClick:handleQuickStartFantasy,className:"p-6 bg-gradient-to-r from-emerald-500 to-blue-600 rounded-lg hover:scale-105 transition-transform",disabled:r,children:[ft.jsx("div",{className:"text-3xl mb-2",children:"🏰"}),ft.jsx("div",{className:"font-bold",children:"Quick Fantasy"}),ft.jsx("div",{className:"text-sm opacity-75",children:"Start immediately"})]}),ft.jsxs("button",{onClick:handleQuickStartSciFi,className:"p-6 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg hover:scale-105 transition-transform",disabled:r,children:[ft.jsx("div",{className:"text-3xl mb-2",children:"🚀"}),ft.jsx("div",{className:"font-bold",children:"Quick Sci-Fi"}),ft.jsx("div",{className:"text-sm opacity-75",children:"Space adventure"})]}),ft.jsxs("button",{onClick:()=>b(!0),className:"p-6 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg hover:scale-105 transition-transform",disabled:r,children:[ft.jsx("div",{className:"text-3xl mb-2",children:"💾"}),ft.jsx("div",{className:"font-bold",children:"Resume Adventures"}),ft.jsxs("div",{className:"text-sm opacity-75",children:[a.length," saved sessions"]})]}),ft.jsxs("button",{onClick:()=>g(!0),className:"p-6 bg-gradient-to-r from-gray-600 to-gray-700 rounded-lg hover:scale-105 transition-transform",disabled:r,children:[ft.jsx("div",{className:"text-3xl mb-2",children:"⚙️"}),ft.jsx("div",{className:"font-bold",children:"Custom Game"}),ft.jsx("div",{className:"text-sm opacity-75",children:"Advanced options"})]})]}),i.length>0&&ft.jsxs("div",{className:"mb-8",children:[ft.jsxs("h2",{className:"text-2xl font-semibold mb-4 flex items-center",children:[ft.jsx("span",{className:"mr-2",children:"🎮"}),"Join Active Games"]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:i.slice(0,6).map(e=>{var t;return ft.jsxs("button",{onClick:()=>handleJoinSession(e.id),className:"p-4 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg border border-slate-700/50 transition-all text-left",disabled:r,children:[ft.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[ft.jsx("span",{className:"text-2xl",children:getRealmIcon(e.config.realm)}),ft.jsx("h3",{className:"font-semibold",children:e.config.realm}),ft.jsx("span",{className:`px-2 py-1 rounded text-xs ${getPhaseColor(e.currentPhase)}`,children:e.currentPhase})]}),ft.jsx("p",{className:"text-gray-300 text-sm mb-2",children:e.config.theme}),ft.jsxs("div",{className:"text-xs text-gray-400",children:["Players: ",e.players.length,"/",e.config.maxPlayers," •",(null==(t=e.aiPartyMembers)?void 0:t.length)||0," AI companions"]})]},e.id)})})]}),f&&ft.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:ft.jsx("div",{className:"bg-gray-900 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-y-auto",children:ft.jsx(oT,{onSessionJoin:e=>{g(!1),x(!1)}})})}),y&&ft.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:ft.jsx("div",{className:"bg-gray-900 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto",children:ft.jsxs("div",{className:"p-6",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-4",children:[ft.jsx("h2",{className:"text-xl font-bold",children:"Resume Adventures"}),ft.jsx("button",{onClick:()=>b(!1),className:"text-gray-400 hover:text-white text-xl",children:"×"})]}),0===a.length?ft.jsxs("div",{className:"text-center py-8 text-gray-400",children:[ft.jsx("p",{children:"No saved sessions found."}),ft.jsx("p",{className:"text-sm mt-2",children:"Start a new adventure to begin!"})]}):ft.jsx("div",{className:"space-y-3",children:a.map(e=>{var t;return ft.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-800 rounded-lg",children:[ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[ft.jsx("span",{className:"text-lg",children:getRealmIcon(e.config.realm)}),ft.jsx("h3",{className:"font-medium",children:e.config.realm}),ft.jsx("span",{className:"text-xs bg-gray-700 px-2 py-1 rounded",children:e.config.theme})]}),ft.jsxs("p",{className:"text-sm text-gray-400",children:[e.messages.length," messages •",(null==(t=e.aiPartyMembers)?void 0:t.length)||0," AI companions"]}),ft.jsxs("p",{className:"text-xs text-gray-500",children:["Last played: ",new Date(e.startTime||0).toLocaleDateString()]})]}),ft.jsxs("div",{className:"flex gap-2 ml-4",children:[ft.jsx("button",{onClick:()=>(async e=>{await h(e)&&b(!1)})(e.id),className:"px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm transition-colors",children:"Resume"}),ft.jsx("button",{onClick:()=>(async e=>{window.confirm("Are you sure you want to permanently delete this session? This cannot be undone.")&&await u(e)})(e.id),className:"px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors",children:"Delete"})]})]},e.id)})})]})})})]})})};n.lazy(()=>yt(()=>import("./NavBar-66753660.js"),["assets/NavBar-66753660.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),n.lazy(()=>yt(()=>import("./TopBar-f48a9fe0.js"),["assets/TopBar-f48a9fe0.js","assets/ui-vendor-91fe8cc7.js","assets/react-vendor-132e4a4f.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"]));const cT=n.lazy(()=>yt(()=>import("./WelcomeOverlay-4cef3809.js"),["assets/WelcomeOverlay-4cef3809.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),hT=n.lazy(()=>yt(()=>import("./CombatSystem-f8052f37.js"),["assets/CombatSystem-f8052f37.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),uT=n.lazy(()=>yt(()=>import("./RightDrawer-0e3f10d2.js"),["assets/RightDrawer-0e3f10d2.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),dT=n.lazy(()=>yt(()=>import("./FloatingActionButton-41be1042.js"),["assets/FloatingActionButton-41be1042.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),pT=n.lazy(()=>yt(()=>import("./SimpleHelp-1abf2b5b.js"),["assets/SimpleHelp-1abf2b5b.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),mT=n.lazy(()=>yt(()=>import("./HelpSystem-22f67b92.js"),["assets/HelpSystem-22f67b92.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),fT=n.lazy(()=>yt(()=>import("./DMCenter-80f77082.js"),["assets/DMCenter-80f77082.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-91fe8cc7.js","assets/firebase-auth-65c9b6ac.js","assets/firebase-core-80358ff0.js","assets/firebase-firestore-2d82c905.js","assets/firebase-database-a6432f11.js","assets/firebase-functions-0bfb6d35.js"])),gT=()=>ft.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-950 via-indigo-950 to-purple-950 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsxs("div",{className:"relative",children:[ft.jsx("div",{className:"w-16 h-16 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("div",{className:"w-12 h-12 border-4 border-purple-300/30 border-t-purple-400 rounded-full animate-spin absolute top-2 left-1/2 transform -translate-x-1/2 -rotate-45",style:{animationDuration:"1.5s"}})]}),ft.jsxs("div",{className:"space-y-2",children:[ft.jsx("h3",{className:"text-white font-semibold text-lg",children:"Loading MythSeeker"}),ft.jsx("p",{className:"text-blue-200 text-sm",children:"Preparing your adventure..."})]}),ft.jsxs("div",{className:"flex justify-center space-x-1",children:[ft.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full animate-bounce"}),ft.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),ft.jsx("div",{className:"w-2 h-2 bg-indigo-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})]})}),vT=({initialScreen:e="welcome"})=>{const t=r.useMemo(()=>new tl,[]);n.useState(null);const[i,s]=n.useState([]),[a,o]=n.useState(!1),[l,c]=n.useState(!1),[h,u]=n.useState("welcome"),[d,p]=n.useState(null),[m,f]=n.useState([]),[g,v]=n.useState(!0),[x,y]=n.useState(!1);n.useState(!1),n.useState("dashboard"),n.useState("gameplay");const[b,_]=n.useState(!1);n.useState(!1);const[w,S]=n.useState(!1),[M,T]=n.useState(e),[E,C]=n.useState(""),[N,A]=n.useState(null),[R,j]=n.useState(null),[P,I]=n.useState([]),[D,k]=n.useState([]),[L,O]=n.useState(""),[U,F]=n.useState(!1),[z,B]=n.useState("default");n.useState({});const[V,H]=n.useState(null),[W,G]=n.useState("");n.useState(null),n.useState(null);const[q,$]=n.useState(null);n.useState([]),n.useState(null),n.useState(null),n.useState(null),n.useState(null),n.useState({});const[X,Y]=n.useState({locations:{},npcs:{},factions:{},events:[],weather:"clear",timeOfDay:"day",currentLocation:null,playerReputation:{},discoveredSecrets:[],activeQuests:[],completedQuests:[],worldEvents:[]});n.useState({ruleSystem:"dnd5e",contentLibrary:{encounters:[],npcs:[],locations:[],plotHooks:[],customRules:[]},campaignTemplates:[],dmTools:{initiativeTracker:[],sessionNotes:"",playerAnalytics:{}}}),n.useState(!1),n.useState([]);const[K,Z]=n.useState([]);n.useState(!1);const J=n.useRef(null),Q=n.useRef(null),[ee,te]=n.useState(!1),[ne,ie]=n.useState({players:[],isHost:!1,lastSync:null}),[se,re]=n.useState("chat");n.useState(0);const[oe,le]=n.useState({playerActions:[],npcInteractions:{},combatHistory:[],explorationHistory:[],playerPreferences:{},storyThreads:[],consequences:[]}),[ce,he]=n.useState(400),ue=()=>!JSON.parse(localStorage.getItem("mythseeker_skipped_intros")||"[]").includes("welcomeOverlay"),de=(e,t)=>{if(["characterCreated","campaignCreated","campaignJoined","levelUp","achievementUnlocked","firstMessage","combatStarted","questCompleted","itemFound","npcInteraction","explorationMilestone"].includes(e)&&!["error","info","warning","success","goodbye","characterLoaded","campaignDeleted","ftueSkipped"].includes(e)){if(JSON.parse(localStorage.getItem("mythseeker_skipped_intros")||"[]").includes(e))return;const n=((e,t)=>{const n=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i={characterCreated:{message:"Character created successfully!",type:"success"},campaignCreated:{message:"Campaign created successfully!",type:"success"},campaignPaused:{message:"Campaign paused",type:"info"},campaignResumed:{message:"Campaign resumed",type:"success"},welcomeBack:{message:"Welcome back to your adventure!",type:"success"},ftueSkipped:{message:"Tutorial skipped",type:"info"},npcInteraction:{message:(null==t?void 0:t.npcName)?`${t.npcName} is ${t.disposition} (${t.emotionalSummary})`:"NPC interaction recorded",type:"info"}}[e]||{message:"Action completed",type:"success"};return{id:n,message:i.message,type:i.type}})(e,t);["characterCreated","campaignCreated","firstMessage","combatStarted"].includes(e)&&(n.showIntroControls=!0,n.onSkipIntro=()=>{},n.onDontShowAgain=()=>{const t=JSON.parse(localStorage.getItem("mythseeker_skipped_intros")||"[]");t.includes(e)||(t.push(e),localStorage.setItem("mythseeker_skipped_intros",JSON.stringify(t)))}),s(e=>[...e,n]),setTimeout(()=>pe(n.id),5e3)}},pe=e=>{s(t=>t.filter(t=>t.id!==e))};n.useEffect(()=>{V||H(Date.now().toString(36)+Math.random().toString(36).substr(2))},[V]),n.useEffect(()=>{el.trackSessionStart(),el.trackDeviceInfo(),el.trackPageView("welcome","MythSeeker - Welcome");const e=performance.now(),t=()=>{const t=performance.now()-e;el.trackPerformance("app_load_time",t)};"complete"===document.readyState?t():window.addEventListener("load",t);const n=()=>{const t=Date.now()-e;el.trackSessionEnd(t)};window.addEventListener("beforeunload",n);const i=oi.onAuthStateChange(async e=>{var t;if(e)try{await new Promise(e=>setTimeout(e,500)),el.trackUserAction("user_authenticated",{user_id:e.uid,display_name:e.displayName}),el.setUserId(e.uid),el.setUserProperties({user_type:e.displayName?"authenticated":"anonymous",account_created:(null==(t=e.metadata)?void 0:t.creationTime)||"unknown"});let i=0,s=null;for(;i<3&&!s;)try{s=await oi.getUserProfile(e.uid);break}catch(n){i++,i<3&&await new Promise(e=>setTimeout(e,1e3*i))}if(s){p(s),C(s.displayName),y(!0);let t=[];for(i=0;i<3;)try{t=await oi.getUserCharacters(e.uid);break}catch(n){i++,i<3&&await new Promise(e=>setTimeout(e,1e3*i))}f(t),el.trackUserAction("profile_loaded",{characters_count:t.length,has_characters:t.length>0}),"/"===location.pathname&&(t.length>0?(T("dashboard"),fe("/dashboard"),el.trackPageView("dashboard","MythSeeker - Dashboard"),ue()&&o(!0)):(T("welcome"),fe("/"),el.trackPageView("welcome","MythSeeker - Welcome")))}else T("welcome"),el.trackPageView("welcome","MythSeeker - Welcome")}catch(i){const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");e.length>0?(f(e),T("character-select"),el.trackPageView("character-select","MythSeeker - Character Selection")):(T("welcome"),el.trackPageView("welcome","MythSeeker - Welcome")),p(null),y(!1)}else{el.trackUserAction("user_signed_out");const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");e.length>0?(f(e),T("character-select"),el.trackPageView("character-select","MythSeeker - Character Selection")):(T("welcome"),el.trackPageView("welcome","MythSeeker - Welcome")),p(null),y(!1)}v(!1)});return()=>{window.removeEventListener("load",t),window.removeEventListener("beforeunload",n),i()}},[]),n.useEffect(()=>{(async()=>{try{await oi.handleRedirectSignIn()}catch(e){de("error",{message:"Failed to sign in. Please try again."})}})()},[]),n.useEffect(()=>{"undefined"==typeof window||window.claude||(window.claude={complete:e=>di.complete(e)})},[]);const me=async()=>{try{v(!0),await oi.signInWithGoogle()}catch(e){const t=e;"auth/popup-blocked"===t.code?de("error",{message:"Popup was blocked. Trying alternative sign-in method..."}):"auth/popup-closed-by-user"===t.code?(de("info",{message:"Sign-in was cancelled."}),v(!1)):("auth/cancelled-popup-request"===t.code||de("error",{message:"Failed to sign in. Please try again."}),v(!1))}};n.useEffect(()=>{const e=()=>{S(window.innerWidth<1024)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{if(null==R?void 0:R.id){const e=Hr.subscribeToCampaign(R.id,e=>{j(e),k(e.messages||[]),ie({players:e.players||[],isHost:Hr.isHost(e),lastSync:new Date}),te(!0)}),t=Hr.startHeartbeat(R.id);return()=>{e(),t()}}},[null==R?void 0:R.id]),n.useEffect(()=>{var e;null==(e=J.current)||e.scrollIntoView({behavior:"smooth"})},[D]),n.useEffect(()=>{!U&&Q.current&&Q.current.focus()},[U]);const fe=yn(),ge=async e=>{if(null==e?void 0:e.id)try{const n=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]"),i=n.findIndex(t=>t.id===e.id);if(i>=0?n[i]=e:n.push(e),localStorage.setItem("mythseeker_campaigns",JSON.stringify(n)),I(t=>t.map(t=>t.id===e.id?e:t)),e.isMultiplayer&&x&&d)try{await Hr.updateCampaignState(e.id,{messages:e.messages||[],systemMessages:e.systemMessages||[],started:e.started,worldState:e.worldState,currentEnvironment:e.currentEnvironment,combatState:e.combatState,lastActivity:new Date})}catch(t){}}catch(n){try{const t=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]"),n=t.findIndex(t=>t.id===e.id);n>=0?t[n]=e:t.push(e),localStorage.setItem("mythseeker_campaigns",JSON.stringify(t))}catch(i){}}},ve=async()=>{try{const t=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]"),n=t.map(e=>({...e,status:e.status||(e.started?"active":void 0)}));if(I(n),x&&d)try{const e=await Hr.getUserCampaigns(),n=t.map(t=>e.find(e=>e.id===t.id)||t);e.forEach(e=>{n.find(t=>t.id===e.id)||n.push(e)}),I(n),localStorage.setItem("mythseeker_campaigns",JSON.stringify(n))}catch(e){}}catch(t){I([])}};n.useEffect(()=>{if(R&&R.started){const e=setTimeout(()=>{ge(R)},3e4);return()=>clearTimeout(e)}},[R]),n.useEffect(()=>{ve()},[N,x]),n.useEffect(()=>{const e=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]");e.length>0&&I(e)},[]),n.useEffect(()=>{if(R&&D.length>0){const e={...R,messages:D};ge(e)}},[D]);const xe=[{name:"Warrior",icon:"⚔️",stats:{strength:16,dexterity:12,intelligence:10,charisma:8},actionPoints:{move:6,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Power Strike",description:"Deal +50% damage on next attack",cost:"Action",type:"attack",range:1},3:{name:"Shield Wall",description:"Reduce all damage by 3 for 3 turns",cost:"Action",type:"defense",range:0},5:{name:"Berserker Rage",description:"Double damage but take +50% damage for 3 turns",cost:"Bonus Action",type:"buff",range:0},7:{name:"Intimidating Shout",description:"Fear nearby enemies for 2 turns",cost:"Action",type:"control",range:3,aoe:!0},10:{name:"Legendary Strike",description:"Guaranteed critical hit",cost:"Action",type:"attack",range:1}}},{name:"Rogue",icon:"🗡️",stats:{strength:10,dexterity:16,intelligence:12,charisma:8},actionPoints:{move:8,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Sneak Attack",description:"Deal double damage if target is unaware",cost:"Free",type:"attack",range:1},3:{name:"Shadow Step",description:"Teleport behind enemy and gain advantage",cost:"Movement",type:"movement",range:6},5:{name:"Poison Blade",description:"Next 3 attacks apply poison (3 damage/turn)",cost:"Bonus Action",type:"buff",range:0},7:{name:"Smoke Bomb",description:"Become invisible for 2 turns",cost:"Action",type:"stealth",range:0,aoe:!0,radius:2},10:{name:"Assassinate",description:"Instant kill if target below 25% health",cost:"Action",type:"attack",range:1}}},{name:"Mage",icon:"🔮",stats:{strength:8,dexterity:10,intelligence:16,charisma:12},actionPoints:{move:5,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Magic Missile",description:"Deal 1d4+1 force damage, never misses",cost:"1 Spell Slot",type:"attack",range:8},3:{name:"Shield Spell",description:"Gain +5 AC until start of next turn",cost:"Reaction",type:"defense",range:0},5:{name:"Fireball",description:"Deal 3d6 fire damage in large area",cost:"1 Spell Slot",type:"aoe",range:10,radius:3},7:{name:"Counterspell",description:"Cancel enemy spell or ability",cost:"Reaction",type:"control",range:8},10:{name:"Meteor Storm",description:"Devastate entire battlefield",cost:"2 Spell Slots",type:"aoe",range:15,radius:5}}},{name:"Cleric",icon:"⚡",stats:{strength:12,dexterity:8,intelligence:12,charisma:16},actionPoints:{move:5,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Healing Word",description:"Restore 1d4+CHA mod HP to ally",cost:"1 Spell Slot",type:"heal",range:8},3:{name:"Turn Undead",description:"Force undead creatures to flee",cost:"Action",type:"control",range:6,aoe:!0},5:{name:"Sacred Flame",description:"Divine damage that ignores armor",cost:"1 Spell Slot",type:"attack",range:8},7:{name:"Mass Healing",description:"Heal all allies for 2d4+CHA",cost:"2 Spell Slots",type:"heal",range:6,aoe:!0},10:{name:"Divine Intervention",description:"Call upon divine aid in dire situations",cost:"3 Spell Slots",type:"special",range:0}}},{name:"Ranger",icon:"🏹",stats:{strength:14,dexterity:14,intelligence:10,charisma:8},actionPoints:{move:7,action:1,bonus:1,reaction:1},reach:10,skills:{1:{name:"Hunter's Mark",description:"Mark target for +1d6 damage on attacks",cost:"Bonus Action",type:"buff",range:10},3:{name:"Multi-Shot",description:"Attack up to 3 enemies with ranged weapon",cost:"Action",type:"attack",range:10},5:{name:"Animal Companion",description:"Summon beast ally for entire combat",cost:"Action",type:"summon",range:3},7:{name:"Explosive Shot",description:"Ranged attack that damages nearby enemies",cost:"Action",type:"aoe",range:10,radius:2},10:{name:"Rain of Arrows",description:"Attack all enemies in large area",cost:"Action",type:"aoe",range:12,radius:4}}},{name:"Bard",icon:"🎵",stats:{strength:8,dexterity:12,intelligence:10,charisma:16},actionPoints:{move:6,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Inspiration",description:"Give ally advantage on next roll",cost:"Bonus Action",type:"support",range:6},3:{name:"Cutting Words",description:"Reduce enemy attack/damage by 1d6",cost:"Reaction",type:"debuff",range:6},5:{name:"Song of Rest",description:"Party heals +1d6 HP during short rest",cost:"Short Rest",type:"heal",range:0},7:{name:"Mass Suggestion",description:"Control multiple enemies for 1 turn",cost:"Action",type:"control",range:8,aoe:!0},10:{name:"Power Word Kill",description:"Instantly kill enemy below 100 HP",cost:"Action",type:"attack",range:8}}}],ye=[{name:"Classic Fantasy",description:"Dragons, magic, and heroic quests in a medieval world",icon:"🏰",bg:"fantasy"},{name:"Sci-Fi Adventure",description:"Space exploration, alien encounters, and futuristic technology",icon:"🚀",bg:"scifi"},{name:"Horror Mystery",description:"Dark secrets, supernatural threats, and psychological tension",icon:"👻",bg:"horror"},{name:"Urban Fantasy",description:"Magic hidden in the modern world, supernatural creatures in cities",icon:"🌃",bg:"urban"},{name:"Post-Apocalyptic",description:"Surviving in a world after civilization has collapsed",icon:"☢️",bg:"apocalypse"},{name:"Pirate Adventure",description:"High seas, treasure hunting, and swashbuckling action",icon:"🏴‍☠️",bg:"pirate"}],we=e=>{const t=xe.find(t=>t.name===e.class);t?((async e=>{if(!d){const t={id:Date.now().toString(),userId:"local",name:e.name,class:e.class,level:1,experience:0,health:100,maxHealth:100,mana:50,maxMana:50,gold:100,inventory:{"Healing Potion":3,"Iron Ore":2,Herb:5},equipment:{weapon:{name:"Iron Sword",type:"weapon"},armor:{name:"Leather Armor",type:"armor"}},stats:e.baseStats,skills:e.skills||{},achievements:[],createdAt:Date.now(),lastPlayed:Date.now(),totalPlayTime:0},n=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");return n.push(t),localStorage.setItem("mythseeker_characters",JSON.stringify(n)),de("characterCreated",{character:e}),f(e=>[t,...e]),A(t),void T("lobby")}const t={userId:d.uid,name:e.name,class:e.class,level:1,experience:0,health:100,maxHealth:100,mana:50,maxMana:50,gold:100,inventory:{"Healing Potion":3,"Iron Ore":2,Herb:5},equipment:{weapon:{name:"Iron Sword",type:"weapon"},armor:{name:"Leather Armor",type:"armor"}},stats:e.baseStats,skills:e.skills||{},achievements:[],createdAt:Date.now(),lastPlayed:Date.now(),totalPlayTime:0};try{const n=await oi.saveCharacter(t),i={...t,id:n};f(e=>[i,...e]),A(i),de("characterCreated",{character:e}),T("lobby")}catch(n){const i={...t,id:Date.now().toString(),userId:d.uid},s=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");s.push(i),localStorage.setItem("mythseeker_characters",JSON.stringify(s)),f(e=>[i,...e]),A(i),de("characterCreated",{character:e}),de("warning",{message:"Character saved locally. Will sync when connection is restored."}),T("lobby")}})({...e,baseStats:t.stats,skills:t.skills,health:100,maxHealth:100,mana:50,maxMana:50,level:1,experience:0,gold:100,inventory:{"Healing Potion":3,"Iron Ore":2,Herb:5},equipment:{weapon:{name:"Iron Sword",type:"weapon"},armor:{name:"Leather Armor",type:"armor"}},unlockedSkills:[1],id:V,playerId:V}),ue()&&o(!0)):de("error",{message:"Invalid character class"})},Se=async e=>{var t;if(e&&e.id){F(!0);try{const n=ye.find(t=>t.name===e.theme)||ye[0],i=`Begin the adventure. The party consists of: ${(null==(t=e.players)?void 0:t.map(e=>{var t,n;return`${(null==(t=e.character)?void 0:t.name)||"Unknown"} the ${(null==(n=e.character)?void 0:n.class)||"Adventurer"}`}).join(", "))||"the party"}. Setting: ${n.description}. Present an immersive opening scene with 3 action choices.`,s=await bi.processPlayerInput({message:i,playerId:V,campaignId:e.id,character:N,timestamp:new Date}),a={id:Date.now(),type:"dm",content:s.narrative_text+(s.npc_dialogue?`\n\n${s.npc_dialogue}`:""),choices:s.choices||["Explore","Investigate","Ask questions"],timestamp:new Date,atmosphere:s.mood_adjustment||{mood:"dynamic",tension:"medium"}};s.game_state_updates&&Ie(s.game_state_updates),k([a]);const r={...e,started:!0,status:"active"};j(r),I(t=>t.map(t=>t.id===e.id?r:t)),T("game"),fe(`/campaigns/${e.id}`)}catch(n){de("error",{message:"Failed to start campaign. Please try again."})}F(!1)}else de("error",{message:"Campaign data is invalid"})},[Me,Ee]=n.useState(null),Ce=r.useMemo(()=>new qr(10,6e4),[]),Ne=async()=>{const e=(e=>{if(!e||0===e.trim().length)return{isValid:!1,error:"Message cannot be empty"};const t=Wr(e.trim());return t.length>500?{isValid:!1,error:"Message must be 500 characters or less"}:(e=>{const t=e.toLowerCase();return Gr.some(e=>t.includes(e))})(t)?{isValid:!1,error:"Message contains inappropriate content"}:{isValid:!0}})(L);if(!e.isValid)return void Ee(e.error||"Invalid message");const t=V||"anonymous";if(!Ce.isAllowed(t)){const e=Ce.getTimeUntilReset(t);return void Ee(`Please wait ${Math.ceil(e/1e3)} seconds before sending another message`)}if(Ee(null),U)return;if(!N)return void Ee("No character selected. Please create or select a character first.");const n=Wr(L),i={id:Date.now(),type:"player",content:n,character:N.name,playerId:V,playerName:E,timestamp:new Date},s=[...D,i];k(s),O(""),F(!0);try{const e=await bi.processPlayerInput({message:n,playerId:V,campaignId:(null==R?void 0:R.id)||"single-player",character:N,timestamp:new Date}),t={narrative:e.narrative_text,choices:e.follow_up_prompts||["Explore","Investigate","Ask questions"],atmosphere:{mood:"dynamic",tension:"medium",environmentalDetails:"The world responds to your actions"}};e.npc_dialogue&&(t.narrative+=`\n\n${e.npc_dialogue}`),e.system_actions&&e.system_actions.length>0&&e.system_actions.forEach(e=>{if("dice_roll"===e.type){const e=((e=20)=>Math.floor(Math.random()*e)+1)(20);t.narrative+=`\n\n[Roll: ${e}]`}}),t.worldStateUpdates&&Ie(t.worldStateUpdates),t.environment&&B(t.environment),t.characterUpdates&&t.characterUpdates.forEach(e=>{e.playerId===V&&(A(t=>{var n,i;return t?{...t,experience:t.experience+(e.xpGain||0),health:Math.max(1,Math.min(t.maxHealth,t.health+((null==(n=e.statChanges)?void 0:n.health)||0))),mana:Math.max(0,Math.min(t.maxMana,t.mana+((null==(i=e.statChanges)?void 0:i.mana)||0))),inventory:{...t.inventory,...e.newItems}}:null}),e.reputationChanges&&Y(t=>({...t,playerReputation:{...t.playerReputation,...e.reputationChanges}})))});const i={id:Date.now()+1,type:"dm",content:t.narrative,choices:t.choices,timestamp:new Date,atmosphere:t.atmosphere,worldStateUpdates:t.worldStateUpdates};k(e=>[...e,i]),t.combatEncounter&&Re(t.combatEncounter.enemies)}catch(a){const e={id:Date.now()+1,type:"dm",content:"The story continues to unfold... (AI temporarily unavailable)",timestamp:new Date};k(t=>[...t,e])}F(!1)},Ae=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Ne())},Re=e=>{var n,i,s,a;if(!N)return;const r=[{id:N.id||V||"player",name:N.name,type:"player",character:N,position:{x:0,y:0},health:N.health,maxHealth:N.maxHealth,mana:N.mana,maxMana:N.maxMana,actionPoints:N.actionPoints||{move:6,action:1,bonus:1,reaction:1},currentActionPoints:{move:6,action:1,bonus:1,reaction:1},stats:{strength:(null==(n=N.baseStats)?void 0:n.strength)||10,dexterity:(null==(i=N.baseStats)?void 0:i.dexterity)||10,intelligence:(null==(s=N.baseStats)?void 0:s.intelligence)||10,charisma:(null==(a=N.baseStats)?void 0:a.charisma)||10,armorClass:10},statusEffects:[],isActive:!1,hasActed:!1,reach:1,skills:N.skills||{}},...e.map((e,t)=>({id:`enemy-${t}`,name:e.name||`Enemy ${t+1}`,type:"enemy",position:{x:0,y:0},health:e.health||25,maxHealth:e.health||25,actionPoints:{move:4,action:1,bonus:0,reaction:1},currentActionPoints:{move:4,action:1,bonus:0,reaction:1},stats:{strength:e.strength||12,dexterity:e.dexterity||10,intelligence:e.intelligence||8,charisma:e.charisma||8,armorClass:e.armorClass||12},statusEffects:[],isActive:!1,hasActed:!1,reach:1,skills:{}}))],o=t.startCombat(r);$(o),T("combat")},je=e=>{const n=t.executeAction(e);if(n.success&&n.newState){$(n.newState);const e=t.checkCombatEnd();e.ended&&("players"===e.winner?(alert("Victory! You have defeated your enemies!"),A(e=>e?{...e,experience:e.experience+50,health:Math.min(e.maxHealth,e.health+20)}:null)):(alert("Defeat! Your party has been defeated..."),A(e=>e?{...e,health:Math.max(1,e.health-10)}:null)),t.endCombat(),$(null),T("game"))}else alert(n.message)},Pe=()=>{t.endCombat(),$(null),T("game")},Ie=e=>{e&&(Y(t=>{const n={...t};return e.newLocation&&(n.currentLocation=e.newLocation),e.newNPCs&&e.newNPCs.forEach(e=>{const t=n.npcs[e.name];if(t){const i=xi.updateEmotionalState(t,e.emotionalImpact||{});n.npcs[e.name]={...i,...e,lastSeen:new Date,interactionCount:(t.interactionCount||0)+1,knownSecrets:[...t.knownSecrets||[],...e.knownSecrets||[]],currentLocation:n.currentLocation}}else{const t=xi.createNPC({...e,id:Date.now().toString(),firstEncounter:new Date,lastSeen:new Date,interactionCount:1,relationship:0,knownSecrets:[],currentLocation:n.currentLocation});n.npcs[e.name]=t}}),e.factionChanges&&e.factionChanges.forEach(e=>{n.factions[e.faction]||(n.factions[e.faction]={name:e.faction,influence:10,goals:[],members:[]}),e.change.includes("influence")&&(n.factions[e.faction].influence+=5)}),e.questUpdates&&e.questUpdates.forEach(e=>{const t=n.activeQuests.findIndex(t=>t.title===e.quest);t>=0&&(n.activeQuests[t]={...n.activeQuests[t],progress:e.progress,currentObjective:e.newObjective})}),n}),le(t=>({...t,playerActions:[...t.playerActions,{description:`Player action: ${L}`,timestamp:new Date,location:X.currentLocation}],consequences:[...t.consequences,...e.consequences||[]]})))},De=({campaign:e,messages:t,inputMessage:i,setInputMessage:s,sendMessage:a,handleKeyPress:r,isAIThinking:o,messagesEndRef:l,onStartCombat:c,worldState:h,aiMemory:u,inputRef:d})=>{const[p,m]=n.useState(!1),[f,g]=n.useState(!1),[v,x]=n.useState(!1),[y,b]=n.useState(null),[_,w]=n.useState("all"),[S,M]=n.useState(!1),[T,E]=n.useState(!0),C=n.useRef(null);n.useEffect(()=>{!o&&d.current&&d.current.focus()},[o,d]);const A=t.filter(e=>"all"===_||e.type===_);return n.useEffect(()=>{const e=C.current;if(!e)return;const t=()=>{const{scrollTop:t,scrollHeight:n,clientHeight:i}=e;g(!(n-t-i<100))};return e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)},[]),ft.jsxs("div",{className:"h-full flex flex-col transition-all duration-500 "+(S?"fixed inset-0 z-50":""),children:[ft.jsxs("div",{className:"relative bg-gradient-to-r from-slate-900/95 via-purple-900/95 to-slate-900/95 backdrop-blur-lg border-b border-purple-500/30",children:[ft.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-purple-900/20 via-transparent to-transparent"}),ft.jsxs("div",{className:"relative flex items-center justify-between p-4",children:[ft.jsxs("div",{className:"flex items-center space-x-4",children:[ft.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg",children:"🗺️"}),ft.jsxs("div",{children:[ft.jsx("h2",{className:"text-xl font-bold text-white",children:(null==e?void 0:e.theme)||"Adventure"}),ft.jsxs("div",{className:"flex items-center space-x-4 text-sm text-purple-200",children:[ft.jsx("span",{children:"•"}),ft.jsxs("span",{children:[A.length," messages"]}),ft.jsx("span",{children:"•"}),ft.jsx("span",{className:"text-green-400",children:"Active Campaign"}),(null==h?void 0:h.currentLocation)&&ft.jsxs(ft.Fragment,{children:[ft.jsx("span",{children:"•"}),ft.jsx("span",{className:"text-yellow-400",children:h.currentLocation})]})]})]})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsxs("select",{value:_,onChange:e=>w(e.target.value),className:"px-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:outline-none focus:border-purple-400",children:[ft.jsx("option",{value:"all",children:"All Messages"}),ft.jsx("option",{value:"dm",children:"DM Only"}),ft.jsx("option",{value:"player",children:"Player Only"}),ft.jsx("option",{value:"system",children:"System Only"})]}),ft.jsx("button",{onClick:()=>m(!p),className:"p-2 rounded-lg transition-all "+(p?"bg-purple-600 text-white":"bg-white/10 text-purple-200 hover:bg-white/20"),title:"Quick Actions",children:"⚡"}),ft.jsx("button",{onClick:()=>x(!0),className:"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-purple-200",title:"Roll Dice",children:"🎲"}),ft.jsx("button",{onClick:()=>E(!T),className:"p-2 rounded-lg transition-all "+(T?"bg-green-600 text-white":"bg-white/10 text-purple-200 hover:bg-white/20"),title:"Atmospheric Sounds",children:"🔊"}),ft.jsx("button",{onClick:()=>M(!S),className:"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-purple-200",title:"Toggle Fullscreen",children:S?"🗗":"🗖"})]})]})]}),p&&ft.jsx("div",{className:"bg-gradient-to-r from-purple-900/30 to-blue-900/30 border-b border-purple-500/30 backdrop-blur-sm",children:ft.jsxs("div",{className:"p-4",children:[ft.jsxs("h3",{className:"text-white font-semibold mb-3 flex items-center space-x-2",children:[ft.jsx("span",{children:"⚡"}),ft.jsx("span",{children:"Quick Actions"})]}),ft.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:["I examine my surroundings carefully for clues","I search for hidden passages or secret doors","I listen carefully for any sounds or voices","I check my equipment and inventory","I try to communicate with any nearby NPCs","I cast a detection spell","I move stealthily forward","I prepare for combat"].map((e,t)=>ft.jsx("button",{onClick:()=>(e=>{s(e),m(!1),setTimeout(()=>a(),100)})(e),className:"text-left p-3 bg-white/10 hover:bg-white/20 rounded-lg border border-white/20 transition-all text-sm text-purple-100 hover:text-white transform hover:scale-105",disabled:o,children:e},t))})]})}),ft.jsxs("div",{ref:C,className:"flex-1 overflow-y-auto bg-gradient-to-br from-slate-950/90 via-purple-950/90 to-slate-950/90 relative",children:[ft.jsxs("div",{className:"absolute inset-0 opacity-5",children:[ft.jsx("div",{className:"absolute top-1/4 left-1/4 w-64 h-64 bg-purple-500 rounded-full filter blur-3xl"}),ft.jsx("div",{className:"absolute bottom-1/4 right-1/4 w-48 h-48 bg-blue-500 rounded-full filter blur-3xl"})]}),ft.jsxs("div",{className:"relative p-6 space-y-6",children:[A.map((e,t)=>{var n,i,r;return ft.jsx("div",{className:"group relative transform transition-all duration-300 hover:scale-[1.01] "+("player"===e.type?"ml-8":"dm"===e.type?"mr-8":""),children:ft.jsx("div",{className:"relative p-6 rounded-2xl backdrop-blur-sm border shadow-xl "+("player"===e.type?"bg-gradient-to-br from-blue-600/20 to-cyan-600/20 border-blue-400/30 shadow-blue-500/10":"dm"===e.type?"bg-gradient-to-br from-purple-600/20 to-pink-600/20 border-purple-400/30 shadow-purple-500/10":"bg-gradient-to-br from-gray-600/20 to-slate-600/20 border-gray-400/30 shadow-gray-500/10"),children:ft.jsxs("div",{className:"flex items-start space-x-4 mb-4",children:[ft.jsx("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold shadow-lg "+("player"===e.type?"bg-gradient-to-br from-blue-500 to-cyan-600":"dm"===e.type?"bg-gradient-to-br from-purple-500 to-pink-600":"bg-gradient-to-br from-gray-500 to-slate-600"),children:"player"===e.type?(null==(n=null==N?void 0:N.name)?void 0:n.charAt(0))||"P":"dm"===e.type?"🎭":"⚙️"}),ft.jsxs("div",{className:"flex-1 min-w-0",children:[ft.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[ft.jsx("span",{className:"font-bold text-white text-lg",children:"player"===e.type?(null==N?void 0:N.name)||"You":"dm"===e.type?"Dungeon Master":e.playerName||"System"}),ft.jsx("span",{className:"text-xs text-gray-400 bg-black/30 px-2 py-1 rounded-full",children:new Date(e.timestamp).toLocaleTimeString()}),(null==(i=e.atmosphere)?void 0:i.mood)&&ft.jsx("span",{className:"text-xs px-3 py-1 rounded-full font-medium "+("tense"===e.atmosphere.mood?"bg-red-500/30 text-red-300 border border-red-500/50":"mysterious"===e.atmosphere.mood?"bg-purple-500/30 text-purple-300 border border-purple-500/50":"peaceful"===e.atmosphere.mood?"bg-green-500/30 text-green-300 border border-green-500/50":"bg-blue-500/30 text-blue-300 border border-blue-500/50"),children:e.atmosphere.mood})]}),ft.jsx("div",{className:"text-gray-100 leading-relaxed text-lg",dangerouslySetInnerHTML:{__html:(r=e.content,r?r.replace(/\*\*(.*?)\*\*/g,'<strong class="text-yellow-300">$1</strong>').replace(/\*(.*?)\*/g,'<em class="text-blue-300">$1</em>').replace(/"(.*?)"/g,'<span class="text-green-300">"$1"</span>'):"")}}),e.choices&&e.choices.length>0&&ft.jsxs("div",{className:"mt-6 space-y-3",children:[ft.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-300",children:[ft.jsx("span",{className:"w-2 h-2 bg-yellow-400 rounded-full animate-pulse"}),ft.jsx("span",{className:"font-medium",children:"Choose your path:"})]}),ft.jsx("div",{className:"grid gap-3",children:e.choices.map((e,t)=>ft.jsx("button",{onClick:()=>{s(e),setTimeout(()=>a(),100)},className:"group text-left p-4 bg-gradient-to-r from-white/10 to-white/5 hover:from-white/20 hover:to-white/10 rounded-xl border border-white/20 hover:border-white/40 transition-all duration-300 transform hover:scale-105 hover:shadow-lg",disabled:o,children:ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("span",{className:"w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-lg flex items-center justify-center text-sm font-bold text-white group-hover:scale-110 transition-transform",children:t+1}),ft.jsx("span",{className:"text-gray-200 group-hover:text-white transition-colors font-medium",children:e})]})},t))})]}),e.atmosphere&&ft.jsxs("div",{className:"mt-4 p-3 bg-black/20 rounded-xl border border-white/10",children:[ft.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Atmosphere"}),ft.jsxs("div",{className:"text-sm text-gray-300",children:["🌡️ ",e.atmosphere.mood," • 🌤️ ",e.atmosphere.lighting||"Normal"," • 🔊 ",e.atmosphere.sounds||"Quiet"]})]})]})]})})},e.id||t)}),o&&ft.jsx("div",{className:"group transform transition-all duration-300",children:ft.jsx("div",{className:"relative p-6 rounded-2xl bg-gradient-to-br from-purple-600/20 to-pink-600/20 border border-purple-400/30 backdrop-blur-sm shadow-xl",children:ft.jsxs("div",{className:"flex items-center space-x-4",children:[ft.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center text-white shadow-lg",children:"🎭"}),ft.jsxs("div",{className:"flex-1",children:[ft.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[ft.jsx("span",{className:"font-bold text-white text-lg",children:"Dungeon Master"}),ft.jsxs("div",{className:"flex space-x-1",children:[ft.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-pulse"}),ft.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),ft.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]})]}),ft.jsx("div",{className:"text-purple-200 text-lg italic",children:"The Dungeon Master weaves the threads of fate..."})]})]})})}),ft.jsx("div",{ref:l})]})]}),f&&ft.jsx("div",{className:"absolute bottom-24 right-6 z-10",children:ft.jsx("button",{onClick:()=>{var e;return null==(e=l.current)?void 0:e.scrollIntoView({behavior:"smooth"})},className:"p-3 bg-gradient-to-br from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-full text-white shadow-lg transition-all transform hover:scale-110",children:"↓"})}),ft.jsx("div",{className:"bg-gradient-to-r from-slate-900/95 via-purple-900/95 to-slate-900/95 backdrop-blur-lg border-t border-purple-500/30 p-6",children:ft.jsxs("div",{className:"flex space-x-4",children:[ft.jsxs("div",{className:"flex-1 relative",children:[ft.jsx("input",{ref:d,type:"text",value:i,onChange:e=>s(e.target.value),onKeyDown:r,placeholder:"What do you do? (Be specific and creative!)",className:"w-full px-6 py-4 bg-white/10 text-white placeholder-purple-200 rounded-2xl border border-white/20 focus:outline-none focus:border-purple-400 focus:ring-2 focus:ring-purple-400/50 transition-all text-lg backdrop-blur-sm",disabled:o,maxLength:500}),i.length>0&&ft.jsxs("div",{className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-sm text-gray-400 bg-black/30 px-2 py-1 rounded-full",children:[i.length,"/500"]})]}),ft.jsx("button",{onClick:a,disabled:o||!i.trim(),className:"px-8 py-4 bg-gradient-to-br from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed rounded-2xl transition-all text-white font-bold text-lg shadow-lg transform hover:scale-105 disabled:transform-none",children:o?"⏳":"🚀"})]})}),v&&ft.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",children:ft.jsxs("div",{className:"bg-gradient-to-br from-purple-900/90 to-blue-900/90 backdrop-blur-lg rounded-2xl p-8 border border-purple-400/30 shadow-2xl max-w-md w-full mx-4",children:[ft.jsx("h3",{className:"text-2xl font-bold mb-6 text-white text-center",children:"🎲 Dice Roller"}),ft.jsx("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[4,6,8,10,12,20].map(e=>ft.jsxs("button",{onClick:()=>(e=>{const t=Math.floor(Math.random()*e)+1;b(t),s(`I roll a d${e} and get ${t}`),setTimeout(()=>b(null),3e3)})(e),className:"p-4 bg-white/10 hover:bg-white/20 rounded-xl transition-all text-white font-bold text-lg transform hover:scale-105 border border-white/20 hover:border-white/40",children:["d",e]},e))}),y&&ft.jsxs("div",{className:"text-center mb-6 p-4 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-xl border border-yellow-400/30",children:[ft.jsxs("div",{className:"text-3xl font-bold text-yellow-400 mb-2",children:["🎯 ",y]}),ft.jsx("div",{className:"text-yellow-200",children:"Great roll!"})]}),ft.jsx("button",{onClick:()=>x(!1),className:"w-full px-6 py-3 bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 rounded-xl transition-all text-white font-bold",children:"Close"})]})})]})};return"welcome"===M?ft.jsx("div",{className:`min-h-screen bg-gradient-to-br ${{default:"from-purple-900 via-blue-900 to-indigo-900",fantasy:"from-emerald-900 via-green-800 to-teal-900",dungeon:"from-gray-900 via-slate-800 to-stone-900",forest:"from-green-900 via-emerald-800 to-lime-900",tavern:"from-amber-900 via-orange-800 to-yellow-900",scifi:"from-cyan-900 via-blue-800 to-indigo-900",horror:"from-red-900 via-purple-900 to-black",urban:"from-slate-900 via-gray-800 to-zinc-900",apocalypse:"from-orange-900 via-red-800 to-yellow-900",pirate:"from-blue-900 via-teal-800 to-cyan-900"}[z]} flex items-center justify-center p-4 transition-all duration-1000`,children:ft.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20",children:[ft.jsxs("div",{className:"text-center mb-8",children:[ft.jsx("h1",{className:"text-4xl font-bold text-white mb-2",children:"⚔️ AI Dungeon Master"}),ft.jsx("p",{className:"text-blue-200",children:"Advanced RPG with real consequences"}),ft.jsxs("div",{className:"flex justify-center space-x-4 mt-4 text-sm",children:[ft.jsxs("div",{className:"flex items-center space-x-1 text-yellow-400",children:[ft.jsx(_e,{size:16}),ft.jsx("span",{children:"Tactical Combat"})]}),ft.jsxs("div",{className:"flex items-center space-x-1 text-green-400",children:[ft.jsx(ae,{size:16}),ft.jsx("span",{children:"Character Growth"})]}),ft.jsxs("div",{className:"flex items-center space-x-1 text-purple-400",children:[ft.jsx(be,{size:16}),ft.jsx("span",{children:"Living World"})]})]}),ft.jsx(Fr,{content:"Interactive tutorial and help guide",ariaLabel:"Help tutorial",children:ft.jsxs("button",{onClick:()=>{c(!0),u("welcome")},className:"mt-4 px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all flex items-center space-x-2 mx-auto","aria-label":"Open interactive tutorial and help guide",children:[ft.jsx(Be,{size:16}),ft.jsx("span",{children:"Interactive Tutorial"})]})})]}),g?ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"}),ft.jsx("p",{className:"text-blue-200",children:"Loading..."})]}):x?ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"text-center mb-4",children:[ft.jsxs("p",{className:"text-white",children:["Welcome back, ",null==d?void 0:d.displayName,"!"]}),ft.jsx(Fr,{content:"Continue your adventure with existing characters",ariaLabel:"Continue adventure",children:ft.jsx("button",{onClick:async()=>{try{if(await ve(),P&&P.length>0){const e=P.find(e=>"active"===e.status)||P[0];e?(j(e),T("game"),fe("/game",{state:{campaignId:e.id}})):(T("character-select"),fe("/characters"))}else T("character-select"),fe("/characters")}catch(e){T("character-select"),fe("/characters")}},className:"w-full px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all","aria-label":"Continue your adventure with existing characters",children:"Continue Adventure"})})]}),ft.jsx(Fr,{content:"Sign out of your account",ariaLabel:"Sign out",children:ft.jsx("button",{onClick:async()=>{try{await oi.signOut(),A(null),j(null),f([]),p(null),y(!1),T("welcome"),de("goodbye",{message:"See you next time, adventurer!"})}catch(e){}},className:"w-full px-6 py-3 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all","aria-label":"Sign out of your account",children:"Sign Out"})})]}):ft.jsxs("div",{className:"space-y-4",children:[ft.jsx(Fr,{content:"Sign in with your Google account to save progress",ariaLabel:"Sign in with Google",children:ft.jsxs("button",{onClick:me,disabled:g,className:"w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center space-x-2","aria-label":"Sign in with your Google account to save progress","aria-describedby":"signin-description",children:[ft.jsx(Te,{size:20}),ft.jsx("span",{children:"Sign in with Google"})]})}),ft.jsx("div",{id:"signin-description",className:"sr-only",children:"Sign in to save your progress and access multiplayer features"}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("p",{className:"text-blue-200 text-sm mb-3",children:"Or join an existing campaign:"}),ft.jsxs("div",{className:"flex space-x-2",children:[ft.jsx("input",{type:"text",placeholder:"Campaign Code",value:W,onChange:e=>G(e.target.value.toUpperCase()),className:"flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-blue-200 border border-white/30 focus:outline-none focus:border-blue-400 text-center","aria-label":"Enter campaign code to join existing game",maxLength:6}),ft.jsx(Fr,{content:"Join an existing campaign using the 6-character code",ariaLabel:"Join campaign",children:ft.jsx("button",{onClick:()=>{E.trim()&&W.trim()&&(N?alert("Join campaign feature coming soon!"):T("character"))},disabled:!E.trim()||!W.trim(),className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-all","aria-label":"Join campaign with entered code",children:"Join"})})]})]})]})]})}):("character-select"===M&&m.forEach((e,t)=>{}),ft.jsxs("div",{className:"h-full overflow-hidden",children:[ft.jsxs(zr,{children:[ft.jsx(Br,{messages:i,onDismiss:pe}),a&&ft.jsx(n.Suspense,{fallback:ft.jsx(gT,{}),children:ft.jsx(cT,{character:N,onStart:async()=>{try{const e={id:`tutorial_${Date.now()}`,name:"Apprentice",class:"Mage",level:1,health:16,maxHealth:16,mana:20,maxMana:20,experience:0,gold:25,inventory:{Staff:1,Spellbook:1,"Mana Potion":2},baseStats:{strength:8,dexterity:12,intelligence:16,charisma:14},skills:["Arcana","Investigation"],backstory:"A young apprentice learning the ways of magic and adventure.",totalPlayTime:0,lastPlayed:new Date,achievements:[]};A(e);const t={id:`tutorial_campaign_${Date.now()}`,name:"Learning Adventure",theme:"Fantasy",description:"A guided tutorial to learn MythSeeker mechanics",isMultiplayer:!1,started:!1,status:"active",isTutorial:!0,players:[{id:V,name:(null==d?void 0:d.displayName)||"Player",character:e}],customPrompt:"You are a patient, educational DM teaching a new player. This is a tutorial campaign designed to teach MythSeeker mechanics through play.\n\nTUTORIAL OBJECTIVES:\n1. Teach basic movement and exploration\n2. Introduce NPC interaction and dialogue\n3. Demonstrate simple combat mechanics\n4. Show inventory and character management\n5. Explain quest and objective systems\n\nGUIDELINES:\n- Be encouraging and supportive\n- Explain mechanics naturally through story\n- Provide clear choices that teach different systems\n- Keep challenges easy and educational\n- Celebrate player successes\n- Use simple, clear language\n- Reference the tutorial nature when helpful\n\nStart with a welcoming scene that introduces the magical academy setting and the player's role as an apprentice.",createdAt:new Date,lastActivity:new Date};await Se(t),de("success",{message:"Tutorial started! Learn the ropes of MythSeeker!"})}catch(e){de("error",{message:"Failed to start tutorial. Please try again."})}},onDismiss:()=>{o(!1)}})}),ft.jsx("div",{className:"h-full overflow-hidden",children:ft.jsx("main",{className:"h-full overflow-hidden",children:ft.jsx("div",{className:"h-full",children:ft.jsx("div",{className:"h-full overflow-hidden",children:(()=>{switch(M){case"character":return x?ft.jsxs("div",{className:"h-full p-6",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-6",children:[ft.jsx("h2",{className:"text-3xl font-bold text-white",children:"Create Your Hero"}),ft.jsx("button",{onClick:()=>T("character-select"),className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"← Back to Characters"})]}),ft.jsx(xT,{playerName:(null==d?void 0:d.displayName)||"",classes:xe,onCreateCharacter:we,joinCode:W})]}):ft.jsx("div",{className:"h-full flex items-center justify-center p-4",children:ft.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 text-center",children:[ft.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Authentication Required"}),ft.jsx("p",{className:"text-blue-200 mb-6",children:"Please sign in to create a character"}),ft.jsx("button",{onClick:me,className:"px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Sign in with Google"})]})});case"waiting":return ft.jsx(yT,{campaign:R,onStart:Se,onBack:()=>T("lobby")});case"game":return ft.jsx(De,{campaign:R,messages:D,inputMessage:L,setInputMessage:O,sendMessage:Ne,handleKeyPress:Ae,isAIThinking:U,messagesEndRef:J,onStartCombat:Re,worldState:X,aiMemory:oe,inputRef:Q});case"combat":return q&&ft.jsx(n.Suspense,{fallback:ft.jsx(gT,{}),children:ft.jsx(hT,{combatants:q.combatants,battleMap:q.battleMap,currentTurn:q.currentTurn,activeCombatantId:q.turnOrder[q.currentCombatantIndex],onAction:je,onEndCombat:Pe,isPlayerTurn:t.isPlayerTurn()})});case"world":return ft.jsxs("div",{className:"h-full p-6",children:[ft.jsx("h2",{className:"text-2xl font-bold text-white mb-6",children:"World Map & Exploration"}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsx("p",{className:"text-blue-200 mb-4",children:"Interactive world map coming soon!"}),ft.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4",children:[ft.jsx("h3",{className:"text-white font-semibold mb-2",children:"Current Location"}),ft.jsx("p",{className:"text-blue-200",children:(null==X?void 0:X.currentLocation)||"Unknown"})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-4",children:[ft.jsx("h3",{className:"text-white font-semibold mb-2",children:"Weather"}),ft.jsx("p",{className:"text-blue-200",children:(null==X?void 0:X.weather)||"Clear"})]})]})]})]});case"characters":case"character-select":return ft.jsxs("div",{className:"h-full p-6",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-6",children:[ft.jsxs("div",{children:[ft.jsx("h2",{className:"text-3xl font-bold text-white",children:"Choose Your Character"}),ft.jsxs("p",{className:"text-blue-200",children:["Welcome back, ",null==d?void 0:d.displayName,"!"]})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsx("button",{onClick:()=>T("dashboard"),className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"← Back to Dashboard"}),ft.jsx("button",{onClick:()=>T("character"),className:"px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Create New Character"})]})]}),0===m.length?ft.jsxs("div",{className:"text-center py-12",children:[ft.jsx("div",{className:"text-6xl mb-4",children:"🏰"}),ft.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No Characters Yet"}),ft.jsx("p",{className:"text-blue-200 mb-6",children:"Create your first character to begin your adventure!"}),ft.jsx("button",{onClick:()=>T("character"),className:"px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all",children:"Create Your First Character"})]}):ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[m.map(e=>ft.jsx("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20 hover:border-blue-400 hover:bg-white/20 cursor-pointer transition-all",onClick:()=>(async e=>{try{const t=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]").find(t=>t.id===e);if(t)return A(t),void de("characterLoaded",{character:t.name});if(d){const t=await oi.getCharacter(e);t?(A(t),de("characterLoaded",{character:t.name})):de("error",{message:"Character not found in database"})}else de("error",{message:"Character not found"})}catch(t){de("error",{message:`Failed to load character: ${t.message||"Unknown error"}`})}})(e.id),children:ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-4xl mb-3",children:"Warrior"===e.class?"⚔️":"Rogue"===e.class?"🗡️":"Mage"===e.class?"🔮":"Cleric"===e.class?"⚡":"Ranger"===e.class?"🏹":"🎵"}),ft.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:e.name}),ft.jsxs("p",{className:"text-blue-200 mb-3",children:["Level ",e.level," ",e.class]}),ft.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm text-blue-200",children:[ft.jsxs("div",{children:["HP: ",e.health,"/",e.maxHealth]}),ft.jsxs("div",{children:["XP: ",e.experience]}),ft.jsxs("div",{children:["Gold: ",e.gold]}),ft.jsxs("div",{children:["Play Time: ",Math.floor(e.totalPlayTime/6e4),"m"]})]}),ft.jsxs("div",{className:"mt-3 text-xs text-green-400",children:["Last played: ",new Date(e.lastPlayed).toLocaleDateString()]})]})},e.id)),ft.jsx("div",{onClick:()=>T("character"),className:"bg-gradient-to-br from-green-500/20 to-blue-500/20 rounded-xl p-6 border-2 border-dashed border-white/30 hover:border-white/50 hover:from-green-500/30 hover:to-blue-500/30 cursor-pointer transition-all",children:ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-4xl mb-3",children:"✨"}),ft.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Create New Character"}),ft.jsx("p",{className:"text-blue-200",children:"Start a new adventure with a fresh hero"})]})})]})]});case"profile":return x?ft.jsxs("div",{className:"h-full p-6",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-6",children:[ft.jsx("h2",{className:"text-3xl font-bold text-white",children:"Player Profile"}),ft.jsx("button",{onClick:()=>T("dashboard"),className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"← Back to Dashboard"})]}),ft.jsx("div",{className:"h-[calc(100vh-200px)]",children:ft.jsx(li,{})})]}):ft.jsx("div",{className:"h-full flex items-center justify-center p-4",children:ft.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 text-center",children:[ft.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Authentication Required"}),ft.jsx("p",{className:"text-blue-200 mb-6",children:"Please sign in to view your profile"}),ft.jsx("button",{onClick:me,className:"px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Sign in with Google"})]})});default:return null}})()})})})}),"dm-center"!==M&&ft.jsx(n.Suspense,{fallback:ft.jsx(gT,{}),children:ft.jsx(uT,{isOpen:b,onClose:()=>_(!1),activeTab:se,onTabChange:re,isMobile:w,campaign:R,messages:D,players:ne.players,worldState:X,achievements:K,onSendMessage:async e=>{if(e.trim()&&(null==R?void 0:R.id))try{await Hr.sendMessage(R.id,{type:"player",content:e,character:null==N?void 0:N.name,playerId:V,playerName:E}),de("messageSent")}catch(t){}},onUpdateSettings:e=>{},drawerWidth:ce,setDrawerWidth:he,minWidth:320,maxWidth:600})})]}),ft.jsx(n.Suspense,{fallback:ft.jsx(gT,{}),children:ft.jsx(pT,{isOpen:l,onClose:()=>c(!1)})}),ft.jsx(n.Suspense,{fallback:ft.jsx(gT,{}),children:ft.jsx(mT,{isOpen:l,onClose:()=>c(!1),currentScreen:h,onAction:(e,t)=>{switch(e){case"close":c(!1);break;case"navigate":u(t.screen)}el.trackUserAction("help_action",{action:e,data:t})}})})]}))},xT=({playerName:e,classes:t,onCreateCharacter:i,joinCode:s})=>{const[a,r]=n.useState(null),[o,l]=n.useState(e),[c,h]=n.useState(""),[u,d]=n.useState(null),[p,m]=n.useState({}),[f,g]=n.useState(!1),[v,x]=n.useState(1),[y,b]=n.useState(!1),_=["fuck","shit","bitch","asshole","bastard","dick","cunt","piss","cock","fag","slut","whore"],w=e=>{if(!e)return!1;const t=e.toLowerCase();return _.some(e=>t.includes(e))},S=()=>{let e=0;return o.trim()&&(e+=40),a&&(e+=40),c.trim()&&(e+=20),e},M=u||a,T=o.trim().length>0&&!p.name,E=null!==a&&!p.class,C=0===c.length||!p.backstory&&c.trim().length>0;return ft.jsxs("div",{className:"space-y-6 character-creation",children:[ft.jsxs("div",{className:"bg-white/10 rounded-xl p-4 mb-6",children:[ft.jsxs("div",{className:"flex items-center justify-between mb-3",children:[ft.jsx("h3",{className:"text-white font-semibold",children:"Character Creation Progress"}),ft.jsxs("span",{className:"text-blue-300 text-sm",children:[S(),"% Complete"]})]}),ft.jsx("div",{className:"w-full bg-white/20 rounded-full h-2 mb-4",children:ft.jsx("div",{className:"bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500 ease-out",style:{width:`${S()}%`}})}),ft.jsxs("div",{className:"flex items-center justify-between text-sm",children:[ft.jsxs("div",{className:"flex items-center space-x-2 "+(T?"text-green-400":o.trim()?"text-yellow-400":"text-gray-400"),children:[ft.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold "+(T?"bg-green-500":o.trim()?"bg-yellow-500":"bg-gray-500"),children:T?"✓":"1"}),ft.jsx("span",{children:"Name"})]}),ft.jsxs("div",{className:"flex items-center space-x-2 "+(E?"text-green-400":a?"text-yellow-400":"text-gray-400"),children:[ft.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold "+(E?"bg-green-500":a?"bg-yellow-500":"bg-gray-500"),children:E?"✓":"2"}),ft.jsx("span",{children:"Class"})]}),ft.jsxs("div",{className:"flex items-center space-x-2 "+(C?"text-green-400":c.trim()?"text-yellow-400":"text-gray-400"),children:[ft.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold "+(C?"bg-green-500":c.trim()?"bg-yellow-500":"bg-gray-500"),children:C?"✓":"3"}),ft.jsx("span",{children:"Story"})]})]})]}),y&&ft.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center",children:ft.jsxs("div",{className:"bg-gradient-to-br from-purple-900/90 to-blue-900/90 rounded-2xl p-8 max-w-md mx-4 text-center border border-purple-500/50",children:[ft.jsx("div",{className:"text-6xl mb-4 animate-bounce",children:null==a?void 0:a.icon}),ft.jsx("h3",{className:"text-2xl font-bold text-white mb-2",children:"Character Created!"}),ft.jsxs("p",{className:"text-purple-200 mb-4",children:[o," the ",null==a?void 0:a.name," is ready for adventure!"]}),ft.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-300/30 border-t-purple-400 rounded-full mx-auto"})]})}),ft.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8",children:[ft.jsxs("div",{className:"space-y-4 lg:space-y-6",children:[ft.jsxs("div",{className:"transition-all duration-300 "+(1===v?"ring-2 ring-blue-400 rounded-xl p-4":""),children:[ft.jsxs("label",{className:"block text-white font-semibold mb-2 lg:mb-3 text-sm lg:text-base flex items-center space-x-2",children:[ft.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold",children:"1"}),ft.jsx("span",{children:"Character Name"}),T&&ft.jsx("span",{className:"text-green-400",children:"✓"})]}),ft.jsx("input",{type:"text",placeholder:"Enter your hero's name...",value:o,onChange:e=>{l(e.target.value),1===v&&e.target.value.trim()&&setTimeout(()=>x(2),500)},onFocus:()=>x(1),className:"w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl bg-white/20 text-white placeholder-blue-200 border transition-all duration-300 focus:outline-none text-sm lg:text-base "+(p.name?"border-red-400 focus:border-red-400":T?"border-green-400 focus:border-green-400":"border-white/30 focus:border-blue-400")}),p.name&&ft.jsx("div",{className:"text-red-400 text-xs mt-1 animate-pulse",children:p.name}),T&&!p.name&&ft.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[ft.jsx("span",{children:"✓"}),ft.jsx("span",{children:"Great name choice!"})]})]}),ft.jsxs("div",{className:"transition-all duration-300 "+(2===v?"ring-2 ring-blue-400 rounded-xl p-4":""),children:[ft.jsxs("label",{className:"block text-white font-semibold mb-2 lg:mb-3 text-sm lg:text-base flex items-center space-x-2",children:[ft.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold",children:"2"}),ft.jsx("span",{children:"Choose Your Class"}),E&&ft.jsx("span",{className:"text-green-400",children:"✓"})]}),ft.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4 class-grid",children:t&&t.length>0?t.map(e=>ft.jsx("div",{onClick:()=>{r(e),2===v&&setTimeout(()=>x(3),500)},onFocus:()=>x(2),onMouseEnter:()=>d(e),onMouseLeave:()=>d(null),className:"class-card p-3 lg:p-4 rounded-xl border-2 cursor-pointer transition-all duration-300 transform "+((null==a?void 0:a.name)===e.name?"border-green-400 bg-green-500/30 shadow-lg scale-105 selected":(null==u?void 0:u.name)===e.name?"border-blue-400 bg-blue-500/20 shadow-md scale-102":"border-white/30 bg-white/10 hover:border-white/50 hover:scale-102"),children:ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-2xl lg:text-3xl mb-2 transition-transform duration-300 hover:scale-110",children:e.icon}),ft.jsx("h3",{className:"text-white font-semibold text-sm lg:text-base mb-2",children:e.name}),ft.jsxs("div",{className:"text-xs text-blue-200 space-y-1 mb-2",children:[ft.jsxs("div",{className:"flex justify-between",children:[ft.jsxs("span",{children:["STR: ",e.stats.strength]}),ft.jsx("span",{className:"text-yellow-300",children:"Attack Power"})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsxs("span",{children:["DEX: ",e.stats.dexterity]}),ft.jsx("span",{className:"text-green-300",children:"Agility"})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsxs("span",{children:["INT: ",e.stats.intelligence]}),ft.jsx("span",{className:"text-purple-300",children:"Magic"})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsxs("span",{children:["CHA: ",e.stats.charisma]}),ft.jsx("span",{className:"text-pink-300",children:"Social"})]})]}),(null==a?void 0:a.name)===e.name&&ft.jsxs("div",{className:"flex items-center justify-center space-x-1 text-green-400 text-xs animate-pulse",children:[ft.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full"}),ft.jsx("span",{children:"Selected"})]})]})},e.name)):ft.jsxs("div",{className:"col-span-2 text-center py-8 text-gray-400",children:[ft.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full mx-auto mb-4"}),ft.jsx("p",{children:"Loading character classes..."})]})}),p.class&&ft.jsx("div",{className:"text-red-400 text-xs mt-1 animate-pulse",children:p.class}),E&&!p.class&&ft.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[ft.jsx("span",{children:"✓"}),ft.jsxs("span",{children:["Excellent choice! ",a.name," is a powerful class."]})]})]}),ft.jsxs("div",{className:"transition-all duration-300 "+(3===v?"ring-2 ring-blue-400 rounded-xl p-4":""),children:[ft.jsxs("label",{className:"block text-white font-semibold mb-2 lg:mb-3 text-sm lg:text-base flex items-center space-x-2",children:[ft.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold",children:"3"}),ft.jsx("span",{children:"Character Backstory"}),ft.jsx("span",{className:"text-blue-300 text-xs",children:"(Optional)"}),C&&ft.jsx("span",{className:"text-green-400",children:"✓"})]}),ft.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:["What is your character's greatest fear?","Where did they grow up?","What brought them to adventure?","Who is their closest friend?","What do they value most?"].map((e,t)=>ft.jsx("button",{onClick:()=>{h(t=>t?`${t}\n\n${e}`:e),x(3)},className:"px-2 py-1 bg-blue-600/30 text-blue-200 text-xs rounded hover:bg-blue-600/50 transition-all transform hover:scale-105",children:e},t))}),ft.jsx("textarea",{value:c,onChange:e=>{h(e.target.value),x(3)},onFocus:()=>x(3),placeholder:"Describe your character's background, motivations, and personality... (Click prompts above for inspiration)",className:"w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl bg-white/20 text-white placeholder-blue-200 border transition-all duration-300 focus:outline-none h-24 lg:h-32 resize-none text-sm lg:text-base "+(p.backstory?"border-red-400 focus:border-red-400":C&&c.trim()?"border-green-400 focus:border-green-400":"border-white/30 focus:border-blue-400")}),p.backstory&&ft.jsx("div",{className:"text-red-400 text-xs mt-1 animate-pulse",children:p.backstory}),C&&c.trim()&&!p.backstory&&ft.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[ft.jsx("span",{children:"✓"}),ft.jsx("span",{children:"Great backstory! This will enhance your roleplay experience."})]})]}),ft.jsx("button",{onClick:()=>{(()=>{g(!0);const e={};return o.trim()?o.length>50?e.name="Character name must be 50 characters or less.":w(o)&&(e.name="Please choose a more appropriate name."):e.name="Character name is required.",a||(e.class="Character class is required."),c.length>0&&w(c)?e.backstory="Please remove inappropriate language from the backstory.":c.length>500&&(e.backstory="Backstory must be 500 characters or less."),m(e),setTimeout(()=>g(!1),500),0===Object.keys(e).length})()&&(b(!0),setTimeout(()=>{i({name:o.trim(),class:a.name,backstory:c.trim()})},1500))},disabled:!a||!o.trim()||f,className:"w-full px-4 lg:px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-sm lg:text-base transform "+(a&&o.trim()&&!f?"bg-gradient-to-r from-green-600 to-blue-600 text-white hover:from-green-700 hover:to-blue-700 shadow-lg hover:scale-105 hover:shadow-xl":"bg-gray-600 text-gray-300 cursor-not-allowed opacity-50"),children:f?ft.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[ft.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full"}),ft.jsx("span",{children:"Validating..."})]}):a&&o.trim()?`Create ${o} the ${a.name}`:"Complete required fields to create character"})]}),ft.jsxs("div",{className:"bg-white/10 rounded-xl p-4 lg:p-6 transition-all duration-300",children:[ft.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:M?`Class Preview: ${M.name}`:"Select a Class"}),M?ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[ft.jsx("div",{className:"text-4xl animate-pulse",children:M.icon}),ft.jsxs("div",{children:[ft.jsx("h4",{className:"text-lg font-semibold text-white",children:M.name}),ft.jsx("p",{className:"text-blue-200 text-sm",children:"Master of tactical combat"})]})]}),o.trim()&&ft.jsxs("div",{className:"bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-lg p-4 border border-purple-500/30",children:[ft.jsxs("h5",{className:"text-white font-semibold mb-2 flex items-center space-x-2",children:[ft.jsx("span",{children:"✨"}),ft.jsx("span",{children:"Character Preview"})]}),ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:"text-3xl mb-2",children:M.icon}),ft.jsx("p",{className:"text-lg font-bold text-white",children:o}),ft.jsxs("p",{className:"text-blue-300",children:["Level 1 ",M.name]}),ft.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[ft.jsx("div",{className:"bg-red-500/20 rounded px-2 py-1",children:ft.jsx("span",{className:"text-red-300",children:"❤️ Health: 100"})}),ft.jsx("div",{className:"bg-blue-500/20 rounded px-2 py-1",children:ft.jsx("span",{className:"text-blue-300",children:"✨ Mana: 50"})})]})]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("h5",{className:"text-white font-semibold mb-2",children:"Class Description"}),ft.jsxs("p",{className:"text-blue-200 text-sm leading-relaxed",children:["Warrior"===M.name&&"A mighty warrior skilled in close combat, wielding powerful weapons and wearing heavy armor. Your strength and endurance make you the frontline defender of your party.","Rogue"===M.name&&"A stealthy rogue who excels at sneaking, lockpicking, and dealing devastating sneak attacks. Your agility and cunning allow you to strike from the shadows.","Mage"===M.name&&"A powerful spellcaster who harnesses the arcane arts to cast devastating spells. Your intelligence and magical prowess make you a force to be reckoned with.","Cleric"===M.name&&"A divine spellcaster who channels the power of the gods to heal allies and smite enemies. Your faith and charisma make you an invaluable support.","Ranger"===M.name&&"A skilled hunter and tracker who excels at ranged combat and wilderness survival. Your dexterity and knowledge of nature make you a versatile adventurer.","Bard"===M.name&&"A charismatic performer who uses music and magic to inspire allies and charm enemies. Your creativity and social skills make you the heart of any party."]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("h5",{className:"text-white font-semibold mb-2",children:"Starting Equipment"}),ft.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("span",{className:"text-yellow-400",children:"⚔️"}),ft.jsx("span",{className:"text-blue-200",children:"Iron Sword"})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("span",{className:"text-brown-400",children:"🛡️"}),ft.jsx("span",{className:"text-blue-200",children:"Leather Armor"})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("span",{className:"text-red-400",children:"🧪"}),ft.jsx("span",{className:"text-blue-200",children:"3x Healing Potions"})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("span",{className:"text-yellow-400",children:"💰"}),ft.jsx("span",{className:"text-blue-200",children:"100 Gold Pieces"})]})]})]}),ft.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[ft.jsx("h5",{className:"text-white font-semibold mb-2",children:"Class Abilities"}),ft.jsx("div",{className:"space-y-2 text-sm",children:M.skills&&Object.entries(M.skills).slice(0,3).map(([e,t])=>ft.jsxs("div",{className:"flex justify-between items-center",children:[ft.jsx("span",{className:"text-blue-200 capitalize",children:e.replace(/([A-Z])/g," $1").trim()}),ft.jsx("div",{className:"flex items-center space-x-1",children:[...Array(5)].map((e,n)=>ft.jsx("div",{className:"w-2 h-2 rounded-full "+(n<t?"bg-yellow-400":"bg-gray-600")},n))})]},e))})]})]}):ft.jsxs("div",{className:"text-center text-blue-200 py-8",children:[ft.jsx("div",{className:"text-4xl mb-4 opacity-50",children:"🎭"}),ft.jsx("p",{children:"Select a class to see detailed information"})]})]})]})]})},yT=({campaign:e,onStart:t,onBack:i})=>{var s,a,r;const[o,l]=n.useState(0),[c,h]=n.useState(1);n.useEffect(()=>{if(null==e?void 0:e.players){const t=e.players.filter(e=>"ready"===e.status).length;l(t),h(e.players.length)}},[e]);const u=(null==(a=null==(s=null==e?void 0:e.players)?void 0:s[0])?void 0:a.isHost)||!1;return ft.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white p-6",children:ft.jsxs("div",{className:"w-full",children:[ft.jsxs("div",{className:"text-center mb-8",children:[ft.jsx("h2",{className:"text-4xl font-bold mb-4",children:"Campaign Lobby"}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-4 inline-block",children:[ft.jsx("p",{className:"text-lg mb-2",children:"Campaign Code:"}),ft.jsx("div",{className:"font-mono text-3xl bg-white/20 px-6 py-3 rounded-lg border border-white/30",children:(null==e?void 0:e.code)||"LOADING"}),ft.jsx("p",{className:"text-blue-200 text-sm mt-2",children:"Share this code with other players"})]})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8",children:[ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Campaign Details"}),ft.jsxs("div",{className:"space-y-2",children:[ft.jsxs("p",{children:[ft.jsx("span",{className:"text-blue-200",children:"Theme:"})," ",(null==e?void 0:e.theme)||"Unknown"]}),ft.jsxs("p",{children:[ft.jsx("span",{className:"text-blue-200",children:"Max Players:"})," ",(null==e?void 0:e.maxPlayers)||6]}),ft.jsxs("p",{children:[ft.jsx("span",{className:"text-blue-200",children:"Type:"})," ",(null==e?void 0:e.isMultiplayer)?"Multiplayer":"Solo"]}),(null==e?void 0:e.customPrompt)&&ft.jsxs("p",{children:[ft.jsx("span",{className:"text-blue-200",children:"Custom Story:"})," ",e.customPrompt]})]})]}),ft.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[ft.jsxs("h3",{className:"text-xl font-semibold mb-4",children:["Players (",c,"/",(null==e?void 0:e.maxPlayers)||6,")"]}),ft.jsx("div",{className:"space-y-3",children:(null==(r=null==e?void 0:e.players)?void 0:r.map((e,t)=>{var n,i;return ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-3 h-3 rounded-full "+("ready"===e.status?"bg-green-400":"bg-yellow-400")}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("p",{className:"font-medium",children:(null==(n=e.character)?void 0:n.name)||e.name}),ft.jsxs("p",{className:"text-sm text-blue-200",children:[(null==(i=e.character)?void 0:i.class)||"Unknown Class"," ",e.isHost?"(Host)":""]})]}),ft.jsx("div",{className:"px-3 py-1 rounded-full text-xs "+("ready"===e.status?"bg-green-600 text-white":"bg-yellow-600 text-white"),children:"ready"===e.status?"Ready":"Not Ready"})]},e.id||t)}))||ft.jsx("div",{className:"text-center text-blue-200 py-4",children:ft.jsx("p",{children:"Loading players..."})})})]})]}),ft.jsx("div",{className:"bg-gradient-to-r from-orange-600/20 to-yellow-600/20 rounded-lg p-6 border border-orange-400/30 mb-6",children:ft.jsxs("div",{className:"flex items-start space-x-4",children:[ft.jsx("div",{className:"text-3xl",children:"🎯"}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("h3",{className:"text-xl font-semibold text-orange-200 mb-2",children:"Turn-Based Multiplayer"}),ft.jsx("p",{className:"text-orange-100 mb-3",children:"You can start this multiplayer campaign solo! Other players can join during the game when it's their turn. Perfect for turn-based gameplay where friends hop in and out as needed."}),ft.jsxs("div",{className:"flex items-center space-x-2 text-sm text-orange-200",children:[ft.jsx("span",{children:"✨"}),ft.jsx("span",{children:"Players can join mid-game using the campaign code"})]})]})]})}),ft.jsxs("div",{className:"flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4",children:[u&&ft.jsxs("button",{onClick:()=>{t(e)},className:"flex-1 px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg",children:["🚀 Start Adventure",1===c?" Solo":` (${o}/${c} Ready)`]}),!u&&ft.jsx("div",{className:"flex-1 px-8 py-4 bg-blue-600/50 text-white rounded-xl font-bold text-lg text-center",children:"Waiting for host to start..."}),ft.jsx("button",{onClick:i,className:"px-8 py-4 bg-gray-600 hover:bg-gray-700 text-white rounded-xl font-bold text-lg transition-all",children:"← Back to Lobby"})]}),ft.jsxs("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-4",children:[ft.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[ft.jsx("h4",{className:"font-semibold mb-2",children:"💡 For Hosts"}),ft.jsx("p",{className:"text-sm text-blue-200",children:"You can start the campaign anytime! Other players can join later using the campaign code, making it perfect for flexible scheduling."})]}),ft.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[ft.jsx("h4",{className:"font-semibold mb-2",children:"🎮 For Players"}),ft.jsx("p",{className:"text-sm text-blue-200",children:"Even if the campaign has started, you can still join! Just use the campaign code and jump in when it's your turn or during a break in the action."})]})]})]})})};function bT(){const[e,t]=n.useState(null),[i,s]=n.useState(!1);n.useEffect(()=>{const e=p(ai,e=>{t(e),s(!0)});return()=>e()},[]);return i?e?ft.jsxs(Jn,{children:[ft.jsx("a",{href:"#main-content",className:"sr-only focus:not-sr-only absolute top-2 left-2 bg-blue-700 text-white px-4 py-2 rounded z-50",children:"Skip to main content"}),ft.jsx(zr,{children:ft.jsxs(In,{children:[ft.jsx(jn,{path:"/",element:ft.jsx(Rn,{to:"/dashboard",replace:!0})}),ft.jsx(jn,{path:"/dashboard",element:ft.jsx(_T,{user:e})}),ft.jsx(jn,{path:"/game/*",element:ft.jsx(wT,{user:e})}),ft.jsx(jn,{path:"/characters",element:ft.jsx(ST,{user:e})}),ft.jsx(jn,{path:"/characters/create",element:ft.jsx(MT,{user:e})}),ft.jsx(jn,{path:"/campaigns",element:ft.jsx(TT,{user:e})}),ft.jsx(jn,{path:"/campaigns/:id",element:ft.jsx(ET,{user:e})}),ft.jsx(jn,{path:"/campaigns/:id/waiting",element:ft.jsx(CT,{user:e})}),ft.jsx(jn,{path:"/automated-games",element:ft.jsx(LT,{user:e})}),ft.jsx(jn,{path:"/party",element:ft.jsx(NT,{user:e})}),ft.jsx(jn,{path:"/world",element:ft.jsx(AT,{user:e})}),ft.jsx(jn,{path:"/combat",element:ft.jsx(RT,{user:e})}),ft.jsx(jn,{path:"/magic",element:ft.jsx(jT,{user:e})}),ft.jsx(jn,{path:"/dm-center",element:ft.jsx(PT,{user:e})}),ft.jsx(jn,{path:"/profile",element:ft.jsx(IT,{user:e})}),ft.jsx(jn,{path:"/achievements",element:ft.jsx(DT,{user:e})}),ft.jsx(jn,{path:"/settings",element:ft.jsx(kT,{user:e})}),ft.jsx(jn,{path:"/help",element:ft.jsx(OT,{user:e})}),ft.jsx(jn,{path:"*",element:ft.jsx(Rn,{to:"/dashboard",replace:!0})})]})})]}):ft.jsx(nl,{onOpenAuth:async()=>{try{await oi.signInWithGoogle()}catch(e){}}}):ft.jsx(gT,{})}const _T=({user:e})=>{const t=yn(),[i,s]=n.useState([]),[a,r]=n.useState([]),[o,l]=n.useState(!1),[c,h]=n.useState(!1),[u,d]=n.useState(!1);return n.useEffect(()=>{const e=()=>{d(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{(async()=>{try{const t=await oi.getUserCampaigns(e.uid),n=await oi.getUserCharacters(e.uid);s(t||[]),r(n||[])}catch(t){}})()},[e.uid]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 md:pb-0 pb-20",children:ft.jsx(il,{user:e,campaigns:i,characters:a,onNavigate:e=>{t(e)},onCreateCampaign:()=>{t("/campaigns")},onCreateCharacter:()=>{t("/characters/create")},onJoinCampaign:()=>{t("/campaigns")},onResumeCampaign:e=>{t(`/campaigns/${e}`)},onOpenDiceRoller:()=>{l(!0)},onOpenProfile:()=>{t("/profile")},onOpenSettings:()=>{t("/settings")},onOpenAchievements:()=>{t("/achievements")},onOpenHelp:()=>{t("/help")}})}),ft.jsx(dT,{onToggleDrawer:()=>h(!c),isDrawerOpen:c,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:u,hasNotifications:!1,notificationCount:0}),o&&ft.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:ft.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-4",children:[ft.jsx("h2",{className:"text-2xl font-bold text-white",children:"Dice Roller"}),ft.jsx("button",{onClick:()=>l(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),ft.jsx(QM,{})]})})]})},wT=({user:e})=>ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto md:pb-0 pb-20",children:ft.jsx(vT,{initialScreen:"game"})})]}),ST=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(UT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},MT=({user:e})=>ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(vT,{initialScreen:"character"})})]}),TT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(FT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},ET=({user:e})=>ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(vT,{initialScreen:"game"})})]}),CT=({user:e})=>ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(vT,{initialScreen:"waiting"})})]}),NT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(zT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},AT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(vT,{initialScreen:"world"})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},RT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1),[o,l]=n.useState([]),[c,h]=n.useState(null);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{(async()=>{try{const t=await oi.getUserCharacters(e.uid);l(t||[]),t&&t.length>0&&h(t[0])}catch(t){}})()},[e.uid]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(sT,{character:c,worldState:{},isInCombat:!1,onStartTraining:e=>{},onEquipWeapon:e=>{}})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},jT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1),[o,l]=n.useState([]),[c,h]=n.useState(null);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{(async()=>{try{const t=await oi.getUserCharacters(e.uid);l(t||[]);const n=null==t?void 0:t.find(e=>e.class&&(e.class.toLowerCase().includes("mage")||e.class.toLowerCase().includes("wizard")||e.class.toLowerCase().includes("sorcerer")||e.class.toLowerCase().includes("warlock")));h(n||t&&t[0]||null)}catch(t){}})()},[e.uid]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(iT,{character:c,worldState:{},onCastSpell:(e,t)=>{},onPrepareSpell:e=>{},onUnprepareSpell:e=>{}})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},PT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(BT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},IT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(VT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},DT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(HT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},kT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(WT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},LT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(lT,{user:e,onBackToLobby:()=>{t("/dashboard")}})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings");break;case"dashboard":t("/dashboard")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},OT=({user:e})=>{const t=yn(),[i,s]=n.useState(!1),[a,r]=n.useState(!1);return n.useEffect(()=>{const e=()=>{r(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),ft.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsx(eT,{user:e,onSignOut:()=>{}}),ft.jsx("div",{className:"flex-1 overflow-auto",children:ft.jsx(GT,{user:e})}),ft.jsx(dT,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:a,hasNotifications:!1,notificationCount:0})]})},UT=({user:e})=>{const t=yn(),[i,s]=n.useState([]),[a,r]=n.useState(!0),[o,l]=n.useState(!1),[c,h]=n.useState(null),[u,d]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const t=await oi.getUserCharacters(e.uid);s(t||[])}catch(t){const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");s(e)}finally{r(!1)}})()},[e.uid]);return a?ft.jsx("div",{className:"flex-1 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("p",{className:"text-blue-200",children:"Loading characters..."})]})}):o?ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-4xl mx-auto",children:[ft.jsxs("div",{className:"mb-6",children:[ft.jsxs("button",{onClick:()=>l(!1),className:"text-blue-400 hover:text-blue-300 flex items-center space-x-2 mb-4",children:[ft.jsx(tt,{className:"w-4 h-4"}),ft.jsx("span",{children:"Back to Characters"})]}),ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Create Character"}),ft.jsx("p",{className:"text-blue-200",children:"Forge your hero and begin your adventure"})]}),ft.jsx(xT,{playerName:(null==e?void 0:e.displayName)||"Adventurer",classes:[{name:"Warrior",description:"Mighty fighter with heavy armor and weapons",icon:"⚔️",stats:{strength:16,dexterity:12,intelligence:10,charisma:8}},{name:"Mage",description:"Powerful spellcaster with arcane magic",icon:"🔮",stats:{strength:8,dexterity:10,intelligence:16,charisma:12}},{name:"Ranger",description:"Skilled archer and wilderness expert",icon:"🏹",stats:{strength:14,dexterity:14,intelligence:10,charisma:8}},{name:"Cleric",description:"Divine healer and protector",icon:"⛪",stats:{strength:12,dexterity:8,intelligence:12,charisma:16}},{name:"Rogue",description:"Stealthy assassin and thief",icon:"🗡️",stats:{strength:10,dexterity:16,intelligence:12,charisma:8}},{name:"Paladin",description:"Holy warrior with divine powers",icon:"🛡️",stats:{strength:14,dexterity:10,intelligence:8,charisma:14}}],onCreateCharacter:t=>{const n={...t,id:Date.now().toString(),createdAt:(new Date).toISOString(),lastPlayed:(new Date).toISOString(),experience:0,level:1,health:100,maxHealth:100,mana:50,maxMana:50,inventory:[],equipment:{},spells:[],abilities:[],status:"active"};if(s(e=>[...e,n]),l(!1),e)oi.saveCharacter(e.uid,n);else{const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");e.push(n),localStorage.setItem("mythseeker_characters",JSON.stringify(e))}},joinCode:""})]})}):u&&c?ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-4xl mx-auto",children:[ft.jsxs("div",{className:"mb-6",children:[ft.jsxs("button",{onClick:()=>d(!1),className:"text-blue-400 hover:text-blue-300 flex items-center space-x-2 mb-4",children:[ft.jsx(tt,{className:"w-4 h-4"}),ft.jsx("span",{children:"Back to Characters"})]}),ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Character Sheet"}),ft.jsx("p",{className:"text-blue-200",children:"Manage your character's details and progression"})]}),ft.jsx(tT,{character:c,onSave:e=>{s(t=>t.map(t=>t.id===e.id?e:t)),d(!1)},onClose:()=>d(!1)})]})}):ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-6xl mx-auto",children:[ft.jsxs("div",{className:"mb-8 flex justify-between items-center",children:[ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Characters"}),ft.jsx("p",{className:"text-blue-200",children:"Manage your heroes and companions"})]}),ft.jsxs("button",{onClick:()=>l(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2",children:[ft.jsx(Ne,{className:"w-5 h-5"}),ft.jsx("span",{children:"Create Character"})]})]}),0===i.length?ft.jsxs("div",{className:"text-center py-12",children:[ft.jsx("div",{className:"w-24 h-24 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4",children:ft.jsx(Te,{className:"w-12 h-12 text-slate-400"})}),ft.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No Characters Yet"}),ft.jsx("p",{className:"text-blue-200 mb-6",children:"Create your first character to begin your adventure"}),ft.jsx("button",{onClick:()=>l(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Create Character"})]}):ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:i.map(n=>{var i;return ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50 hover:border-blue-500/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-4 mb-4",children:[ft.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:ft.jsx("span",{className:"text-white font-bold text-lg",children:null==(i=n.name)?void 0:i.charAt(0)})}),ft.jsxs("div",{className:"flex-1",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white",children:n.name}),ft.jsx("p",{className:"text-blue-200 text-sm",children:n.class})]}),ft.jsx("button",{onClick:()=>(async t=>{if(window.confirm("Are you sure you want to delete this character? This action cannot be undone."))if(s(e=>e.filter(e=>e.id!==t)),e)try{await oi.deleteCharacter(e.uid,t)}catch(n){}else{const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]").filter(e=>e.id!==t);localStorage.setItem("mythseeker_characters",JSON.stringify(e))}})(n.id),className:"text-slate-400 hover:text-red-400 transition-colors p-1",title:"Delete character",children:ft.jsx(nt,{className:"w-4 h-4"})})]}),ft.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-400",children:"Level"}),ft.jsx("span",{className:"text-white",children:n.level||1})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-400",children:"XP"}),ft.jsx("span",{className:"text-white",children:n.experience||0})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-400",children:"Health"}),ft.jsxs("span",{className:"text-white",children:[n.health||100,"/",n.maxHealth||100]})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-400",children:"Last Played"}),ft.jsx("span",{className:"text-white text-xs",children:n.lastPlayed?new Date(n.lastPlayed).toLocaleDateString():"Never"})]})]}),ft.jsxs("div",{className:"flex space-x-2",children:[ft.jsx("button",{onClick:()=>(e=>{h(e),t("/campaigns")})(n),className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors",children:"Play"}),ft.jsx("button",{onClick:()=>(e=>{h(e),d(!0)})(n),className:"flex-1 bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-sm font-medium transition-colors",children:"Edit"})]})]},n.id)})})]})})},FT=({user:e})=>{const t=yn(),[i,s]=n.useState([]),[a,r]=n.useState(!0),[o,l]=n.useState(!1),[c,h]=n.useState(!1);n.useState(null);const[u,d]=n.useState(""),p=[{name:"Classic Fantasy",description:"Dragons, magic, and heroic quests in a medieval world",icon:"🏰",bg:"fantasy"},{name:"Sci-Fi Adventure",description:"Space exploration, alien encounters, and futuristic technology",icon:"🚀",bg:"scifi"},{name:"Horror Mystery",description:"Dark secrets, supernatural threats, and psychological tension",icon:"👻",bg:"horror"},{name:"Urban Fantasy",description:"Magic hidden in the modern world, supernatural creatures in cities",icon:"🌃",bg:"urban"},{name:"Post-Apocalyptic",description:"Surviving in a world after civilization has collapsed",icon:"☢️",bg:"apocalypse"},{name:"Pirate Adventure",description:"High seas, treasure hunting, and swashbuckling action",icon:"🏴‍☠️",bg:"pirate"}];n.useEffect(()=>{m()},[]);const m=async()=>{try{r(!0);const t=(await oi.getUserCampaigns(e.uid)).map(e=>({id:e.id,theme:e.theme,description:`${e.theme} campaign`,status:e.started?"active":"paused",players:e.players||[],joinCode:e.code,createdAt:e.createdAt,customPrompt:e.customPrompt||""}));s(t||[])}catch(t){}finally{r(!1)}},f=e=>{switch(e.status){case"active":return"🟢";case"paused":return"🟡";case"completed":return"🏁";default:return"⚪"}},g=e=>{switch(e.status){case"active":return"text-green-400";case"paused":return"text-yellow-400";case"completed":return"text-blue-400";default:return"text-gray-400"}},v={total:i.length,active:i.filter(e=>"active"===e.status).length,paused:i.filter(e=>"paused"===e.status).length,completed:i.filter(e=>"completed"===e.status).length};return a?ft.jsx("div",{className:"flex-1 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsx("div",{className:"w-12 h-12 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("p",{className:"text-blue-200",children:"Loading campaigns..."})]})}):ft.jsxs("div",{className:"flex-1 overflow-auto bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[ft.jsxs("div",{className:"p-6 space-y-6",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Campaigns"}),ft.jsx("p",{className:"text-blue-200",children:"Manage your adventures and join new campaigns"})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsxs("button",{onClick:()=>h(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[ft.jsx("span",{children:"🔗"}),ft.jsx("span",{children:"Join Campaign"})]}),ft.jsxs("button",{onClick:()=>l(!0),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[ft.jsx("span",{children:"➕"}),ft.jsx("span",{children:"Create Campaign"})]})]})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[ft.jsx("div",{className:"bg-blue-900/50 backdrop-blur-sm rounded-lg p-4 border border-blue-700/50",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("p",{className:"text-blue-200 text-sm",children:"Total Campaigns"}),ft.jsx("p",{className:"text-2xl font-bold text-white",children:v.total})]}),ft.jsx("div",{className:"text-3xl",children:"📚"})]})}),ft.jsx("div",{className:"bg-green-900/50 backdrop-blur-sm rounded-lg p-4 border border-green-700/50",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("p",{className:"text-green-200 text-sm",children:"Active"}),ft.jsx("p",{className:"text-2xl font-bold text-white",children:v.active})]}),ft.jsx("div",{className:"text-3xl",children:"🟢"})]})}),ft.jsx("div",{className:"bg-yellow-900/50 backdrop-blur-sm rounded-lg p-4 border border-yellow-700/50",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("p",{className:"text-yellow-200 text-sm",children:"Paused"}),ft.jsx("p",{className:"text-2xl font-bold text-white",children:v.paused})]}),ft.jsx("div",{className:"text-3xl",children:"🟡"})]})}),ft.jsx("div",{className:"bg-purple-900/50 backdrop-blur-sm rounded-lg p-4 border border-purple-700/50",children:ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("p",{className:"text-purple-200 text-sm",children:"Completed"}),ft.jsx("p",{className:"text-2xl font-bold text-white",children:v.completed})]}),ft.jsx("div",{className:"text-3xl",children:"🏁"})]})})]}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsx("h2",{className:"text-xl font-semibold text-white",children:"Your Campaigns"}),0===i.length?ft.jsxs("div",{className:"text-center py-12",children:[ft.jsx("div",{className:"text-6xl mb-4",children:"📚"}),ft.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No campaigns yet"}),ft.jsx("p",{className:"text-blue-200 mb-6",children:"Create your first campaign or join an existing one to start your adventure!"}),ft.jsxs("div",{className:"flex justify-center space-x-4",children:[ft.jsxs("button",{onClick:()=>l(!0),className:"px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[ft.jsx("span",{children:"➕"}),ft.jsx("span",{children:"Create Campaign"})]}),ft.jsxs("button",{onClick:()=>h(!0),className:"px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[ft.jsx("span",{children:"🔗"}),ft.jsx("span",{children:"Join Campaign"})]})]})]}):ft.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:i.map(e=>{var n,i;return ft.jsxs("div",{className:"bg-slate-800/50 backdrop-blur-sm rounded-lg p-6 border border-slate-700/50 hover:border-blue-500/50 transition-all hover:shadow-lg hover:shadow-blue-500/20",children:[ft.jsxs("div",{className:"flex items-start justify-between mb-4",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("span",{className:"text-2xl",children:(null==(n=p.find(t=>t.name===e.theme))?void 0:n.icon)||"📚"}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold text-white",children:e.theme}),ft.jsx("p",{className:"text-sm text-blue-200",children:e.description})]})]}),ft.jsx("div",{className:`text-lg ${g(e)}`,children:f(e)})]}),ft.jsxs("div",{className:"space-y-3 mb-4",children:[ft.jsxs("div",{className:"flex items-center justify-between text-sm",children:[ft.jsx("span",{className:"text-gray-300",children:"Status:"}),ft.jsx("span",{className:`font-medium ${g(e)}`,children:e.status.charAt(0).toUpperCase()+e.status.slice(1)})]}),ft.jsxs("div",{className:"flex items-center justify-between text-sm",children:[ft.jsx("span",{className:"text-gray-300",children:"Players:"}),ft.jsx("span",{className:"text-white",children:(null==(i=e.players)?void 0:i.length)||1})]}),ft.jsxs("div",{className:"flex items-center justify-between text-sm",children:[ft.jsx("span",{className:"text-gray-300",children:"Join Code:"}),ft.jsx("span",{className:"text-white font-mono",children:e.joinCode})]}),ft.jsxs("div",{className:"flex items-center justify-between text-sm",children:[ft.jsx("span",{className:"text-gray-300",children:"Created:"}),ft.jsx("span",{className:"text-white",children:new Date(e.createdAt).toLocaleDateString()})]})]}),ft.jsxs("div",{className:"flex space-x-2",children:["active"===e.status&&ft.jsx("button",{onClick:()=>window.location.href=`/campaigns/${e.id}`,className:"flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors",children:"Continue"}),"paused"===e.status&&ft.jsx("button",{onClick:()=>(async e=>{try{t("/game",{state:{campaignId:e}})}catch(n){}})(e.id),className:"flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm transition-colors",children:"Resume"}),"active"===e.status&&ft.jsx("button",{onClick:()=>(async e=>{try{s(t=>t.map(t=>t.id===e?{...t,status:"paused"}:t))}catch(t){}})(e.id),className:"px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm transition-colors",children:"Pause"}),ft.jsx("button",{onClick:()=>(async e=>{if(confirm("Are you sure you want to delete this campaign? This action cannot be undone."))try{s(t=>t.filter(t=>t.id!==e))}catch(t){}})(e.id),className:"px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors",children:"Delete"})]})]},e.id)})})]})]}),o&&ft.jsx(nT,{user:e,onClose:()=>l(!1),onCampaignCreated:async(e,n)=>{await m(),l(!1),t("/game",{state:{campaignId:e,joinCode:n}})}}),c&&ft.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:ft.jsxs("div",{className:"bg-slate-800 rounded-lg p-6 w-full max-w-md space-y-4",children:[ft.jsx("h3",{className:"text-xl font-semibold text-white",children:"Join Campaign"}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-blue-200 mb-2",children:"Campaign Join Code"}),ft.jsx("input",{type:"text",value:u,onChange:e=>d(e.target.value.toUpperCase()),placeholder:"Enter 6-character code",className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500",maxLength:6})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsx("button",{onClick:()=>h(!1),className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors",children:"Cancel"}),ft.jsx("button",{onClick:async()=>{if(u.trim())try{const n=await oi.getUserCharacters(e.uid);if(!n||0===n.length)return alert("You need to create a character first before joining a campaign."),void t("/characters");const{gameId:i,gameData:s}=await oi.joinGameSession(u.trim(),n[0].id);await m(),h(!1),d(""),t("/game",{state:{campaignId:i,joinCode:u.trim()}})}catch(n){alert("Failed to join campaign. Please check the join code and try again.")}},disabled:!u.trim(),className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded transition-colors",children:"Join Campaign"})]})]})})]})},zT=({user:e})=>{var t,i,s,a;const r=yn(),[o,l]=n.useState([]),[c,h]=n.useState([]),[u,d]=n.useState(!0),[p,m]=n.useState(!1),[f,g]=n.useState(!1),[v,x]=n.useState(""),[y,b]=n.useState(""),[_,w]=n.useState(null),[S,M]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const t=JSON.parse(localStorage.getItem(`mythseeker_party_${e.uid}`)||"[]");l(t);const n=JSON.parse(localStorage.getItem(`mythseeker_invites_${e.uid}`)||"[]");h(n)}catch(t){}finally{d(!1)}})()},[e.uid]);const T=()=>{(()=>{const e=Math.random().toString(36).substr(2,6).toUpperCase();x(e)})(),m(!0)},E=t=>{const n=o.filter(e=>e.id!==t);l(n),localStorage.setItem(`mythseeker_party_${e.uid}`,JSON.stringify(n))},C=e=>{switch(null==e?void 0:e.toLowerCase()){case"warrior":return"⚔️";case"rogue":return"🗡️";case"mage":return"🔮";case"cleric":return"⚡";case"ranger":return"🏹";case"bard":return"🎵";default:return"👤"}};return u?ft.jsx("div",{className:"flex-1 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("p",{className:"text-blue-200",children:"Loading party data..."})]})}):ft.jsxs("div",{className:"flex-1 p-6 overflow-y-auto",children:[ft.jsxs("div",{className:"max-w-6xl mx-auto",children:[ft.jsxs("div",{className:"mb-8 flex justify-between items-center",children:[ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Party"}),ft.jsx("p",{className:"text-blue-200",children:"Manage your adventuring companions and friends"})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsx("button",{onClick:()=>g(!0),className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Join Party"}),ft.jsx("button",{onClick:T,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Invite Friend"})]})]}),ft.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[ft.jsx("div",{className:"lg:col-span-2",children:ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-6",children:[ft.jsxs("h3",{className:"text-xl font-semibold text-white",children:["Party Members (",o.length,")"]}),ft.jsx("button",{onClick:T,className:"bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors",children:"+ Add Member"})]}),0===o.length?ft.jsxs("div",{className:"text-center py-12",children:[ft.jsx("div",{className:"w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4",children:ft.jsx(re,{className:"w-8 h-8 text-slate-400"})}),ft.jsx("p",{className:"text-blue-200 mb-2",children:"No party members yet"}),ft.jsx("p",{className:"text-slate-400 text-sm mb-4",children:"Invite friends to start your adventuring party"}),ft.jsx("button",{onClick:T,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition-colors",children:"Invite First Member"})]}):ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:o.map(e=>{var t,n,i,s;return ft.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4 hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-start justify-between mb-3",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:ft.jsx("span",{className:"text-white text-lg",children:C(null==(t=e.character)?void 0:t.class)})}),ft.jsxs("div",{children:[ft.jsx("h4",{className:"text-white font-medium",children:e.name}),ft.jsxs("p",{className:"text-blue-200 text-sm",children:[null==(n=e.character)?void 0:n.name," • Level ",null==(i=e.character)?void 0:i.level," ",null==(s=e.character)?void 0:s.class]})]})]}),ft.jsxs("div",{className:"flex items-center space-x-2",children:[ft.jsx("div",{className:"w-2 h-2 rounded-full "+(e.isOnline?"bg-green-400":"bg-slate-400")}),ft.jsx("button",{onClick:()=>{w(e),M(!0)},className:"text-slate-400 hover:text-white",children:ft.jsx(it,{className:"w-4 h-4"})})]})]}),e.notes&&ft.jsxs("p",{className:"text-slate-300 text-sm mb-3 italic",children:['"',e.notes,'"']}),ft.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-400",children:[ft.jsxs("span",{children:["Joined ",new Date(e.joinedAt).toLocaleDateString()]}),ft.jsx("button",{onClick:()=>E(e.id),className:"text-red-400 hover:text-red-300 transition-colors",children:"Remove"})]})]},e.id)})})]})}),ft.jsxs("div",{className:"space-y-6",children:[ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Pending Invites"}),c.length>0?ft.jsx("div",{className:"space-y-3",children:c.map(t=>ft.jsxs("div",{className:"p-3 bg-slate-700/30 rounded",children:[ft.jsxs("div",{className:"flex justify-between items-start mb-2",children:[ft.jsxs("div",{children:[ft.jsx("p",{className:"text-white font-medium",children:t.hostName}),ft.jsx("p",{className:"text-blue-200 text-sm",children:t.partyName})]}),ft.jsx("span",{className:"text-slate-400 text-xs",children:new Date(t.timestamp).toLocaleDateString()})]}),ft.jsxs("div",{className:"flex space-x-2",children:[ft.jsx("button",{onClick:()=>(e=>{b(e.code),g(!0)})(t),className:"flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors",children:"Accept"}),ft.jsx("button",{onClick:()=>(t=>{const n=c.filter(e=>e.id!==t);h(n),localStorage.setItem(`mythseeker_invites_${e.uid}`,JSON.stringify(n))})(t.id),className:"flex-1 bg-slate-600 hover:bg-slate-500 text-white px-3 py-1 rounded text-sm transition-colors",children:"Decline"})]})]},t.id))}):ft.jsx("div",{className:"text-center py-4",children:ft.jsx("p",{className:"text-slate-400 text-sm",children:"No pending invites"})})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Party Stats"}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-300",children:"Total Members"}),ft.jsx("span",{className:"text-white font-semibold",children:o.length})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-300",children:"Online Now"}),ft.jsx("span",{className:"text-white font-semibold",children:o.filter(e=>e.isOnline).length})]}),ft.jsxs("div",{className:"flex justify-between",children:[ft.jsx("span",{className:"text-slate-300",children:"Average Level"}),ft.jsx("span",{className:"text-white font-semibold",children:o.length>0?Math.round(o.reduce((e,t)=>{var n;return e+((null==(n=t.character)?void 0:n.level)||1)},0)/o.length):0})]})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Quick Actions"}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsxs("button",{onClick:()=>r("/game"),className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(ue,{className:"w-4 h-4 text-green-400"}),ft.jsx("span",{className:"text-sm",children:"Start Adventure"})]}),ft.jsx(De,{className:"w-4 h-4 text-slate-400"})]}),ft.jsxs("button",{onClick:()=>r("/characters"),className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(Te,{className:"w-4 h-4 text-blue-400"}),ft.jsx("span",{className:"text-sm",children:"Manage Characters"})]}),ft.jsx(De,{className:"w-4 h-4 text-slate-400"})]}),ft.jsxs("button",{onClick:()=>r("/campaigns"),className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx(Me,{className:"w-4 h-4 text-purple-400"}),ft.jsx("span",{className:"text-sm",children:"View Campaigns"})]}),ft.jsx(De,{className:"w-4 h-4 text-slate-400"})]})]})]})]})]})]}),p&&ft.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:ft.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-4",children:[ft.jsx("h2",{className:"text-xl font-bold text-white",children:"Invite Friend"}),ft.jsx("button",{onClick:()=>m(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Invite Code"}),ft.jsxs("div",{className:"flex space-x-2",children:[ft.jsx("input",{type:"text",value:v,readOnly:!0,className:"flex-1 px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600"}),ft.jsx("button",{onClick:()=>{navigator.clipboard.writeText(v),alert("Invite code copied to clipboard!")},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Copy"})]}),ft.jsx("p",{className:"text-slate-400 text-xs mt-2",children:"Share this code with your friend to invite them to your party"})]}),ft.jsx("div",{className:"flex space-x-3",children:ft.jsx("button",{onClick:()=>m(!1),className:"flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Close"})})]})]})}),f&&ft.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:ft.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-4",children:[ft.jsx("h2",{className:"text-xl font-bold text-white",children:"Join Party"}),ft.jsx("button",{onClick:()=>g(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Invite Code"}),ft.jsx("input",{type:"text",value:y,onChange:e=>b(e.target.value.toUpperCase()),placeholder:"Enter 6-character code",maxLength:6,className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400"})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsx("button",{onClick:()=>g(!1),className:"flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Cancel"}),ft.jsx("button",{onClick:async()=>{if(y.trim())try{const t={id:Date.now().toString(),name:e.displayName||"Adventurer",email:e.email,character:{name:"Your Character",class:"Adventurer",level:1},joinedAt:(new Date).toISOString(),notes:"",isOnline:!0},n=[...o,t];l(n),localStorage.setItem(`mythseeker_party_${e.uid}`,JSON.stringify(n)),g(!1),b(""),alert("Successfully joined the party!")}catch(t){alert("Failed to join party. Please check the code and try again.")}},disabled:!y.trim(),className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white rounded-lg transition-colors",children:"Join Party"})]})]})]})}),S&&_&&ft.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:ft.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4",children:[ft.jsxs("div",{className:"flex justify-between items-center mb-4",children:[ft.jsx("h2",{className:"text-xl font-bold text-white",children:"Party Member"}),ft.jsx("button",{onClick:()=>M(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:ft.jsx("span",{className:"text-white text-xl",children:C(null==(t=_.character)?void 0:t.class)})}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-white font-medium",children:_.name}),ft.jsxs("p",{className:"text-blue-200 text-sm",children:[null==(i=_.character)?void 0:i.name," • Level ",null==(s=_.character)?void 0:s.level," ",null==(a=_.character)?void 0:a.class]})]})]}),ft.jsxs("div",{children:[ft.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Notes"}),ft.jsx("textarea",{value:_.notes||"",onChange:t=>((t,n)=>{const i=o.map(e=>e.id===t?{...e,notes:n}:e);l(i),localStorage.setItem(`mythseeker_party_${e.uid}`,JSON.stringify(i))})(_.id,t.target.value),placeholder:"Add notes about this party member...",rows:3,className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400"})]}),ft.jsxs("div",{className:"text-sm text-slate-400",children:[ft.jsxs("p",{children:["Joined: ",new Date(_.joinedAt).toLocaleDateString()]}),ft.jsxs("p",{children:["Status: ",_.isOnline?"Online":"Offline"]})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsx("button",{onClick:()=>M(!1),className:"flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Close"}),ft.jsx("button",{onClick:()=>{E(_.id),M(!1)},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"Remove from Party"})]})]})]})})]})},BT=({user:e})=>{yn();const[t,i]=n.useState({aiSettings:{dmStyle:"balanced",difficulty:6,descriptionLength:"detailed",improvisationLevel:7,npcComplexity:"detailed",conflictFrequency:5,continuityStrictness:"moderate",worldReactivity:8},dmPersona:{tone:"friendly",humor_level:"medium",descriptiveness:"moderate",challenge_level:"moderate",narrative_focus:"balanced",improvisation_style:"moderate"},aiTraining:{learningEnabled:!0,feedbackCollection:!0,personalityAdaptation:!0,memoryRetention:30,contextWindow:10,longTermMemory:!0,emotionalMemory:!0,crossCampaignLearning:!1}}),[s,a]=n.useState(null),[r,o]=n.useState(!0);return n.useEffect(()=>{(async()=>{try{const t=await oi.getUserCampaigns(e.uid);t&&t.length>0&&a(t[0]);const n=localStorage.getItem(`mythseeker_dmcenter_${e.uid}`);n&&i(JSON.parse(n))}catch(t){}finally{o(!1)}})()},[e.uid]),r?ft.jsx("div",{className:"flex-1 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("p",{className:"text-blue-200",children:"Loading DM Center..."})]})}):ft.jsx("div",{className:"flex-1 overflow-y-auto",children:ft.jsx(fT,{dmCenterData:t,onUpdateDMCenter:t=>{i(t),localStorage.setItem(`mythseeker_dmcenter_${e.uid}`,JSON.stringify(t))},currentCampaign:s})})},VT=({user:e})=>{var t;return ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-4xl mx-auto",children:[ft.jsxs("div",{className:"mb-8",children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Profile"}),ft.jsx("p",{className:"text-blue-200",children:"Your account settings and preferences"})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsxs("div",{className:"flex items-center space-x-6 mb-8",children:[ft.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center",children:(null==e?void 0:e.photoURL)?ft.jsx("img",{src:e.photoURL,alt:e.displayName,className:"w-20 h-20 rounded-full"}):ft.jsx(Te,{className:"w-10 h-10 text-white"})}),ft.jsxs("div",{children:[ft.jsx("h2",{className:"text-2xl font-bold text-white",children:(null==e?void 0:e.displayName)||"Adventurer"}),ft.jsx("p",{className:"text-blue-200",children:null==e?void 0:e.email}),ft.jsxs("p",{className:"text-slate-400 text-sm",children:["Member since ",(null==(t=null==e?void 0:e.metadata)?void 0:t.creationTime)?new Date(e.metadata.creationTime).toLocaleDateString():"Unknown"]})]})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Account Settings"}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Edit Profile"})}),ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Change Password"})}),ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Privacy Settings"})})]})]}),ft.jsxs("div",{children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Game Statistics"}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsxs("div",{className:"p-3 bg-slate-700/50 rounded-lg",children:[ft.jsx("span",{className:"text-slate-400 text-sm",children:"Campaigns Played"}),ft.jsx("p",{className:"text-white font-semibold",children:"0"})]}),ft.jsxs("div",{className:"p-3 bg-slate-700/50 rounded-lg",children:[ft.jsx("span",{className:"text-slate-400 text-sm",children:"Characters Created"}),ft.jsx("p",{className:"text-white font-semibold",children:"0"})]}),ft.jsxs("div",{className:"p-3 bg-slate-700/50 rounded-lg",children:[ft.jsx("span",{className:"text-slate-400 text-sm",children:"Total Play Time"}),ft.jsx("p",{className:"text-white font-semibold",children:"0 hours"})]})]})]})]})]})]})})},HT=({user:e})=>{const[t,i]=n.useState([]),[s,a]=n.useState([]),[r,o]=n.useState([]),[l,c]=n.useState({}),[h,u]=n.useState(!0);n.useEffect(()=>{(async()=>{try{const t=await oi.getUserCharacters(e.uid);i(t||[]);const n=await oi.getUserCampaigns(e.uid);a(n||[]);const s=JSON.parse(localStorage.getItem("mythseeker_game_stats")||"{}");c(s);const r=JSON.parse(localStorage.getItem("mythseeker_achievements")||"[]");o(r)}catch(t){}finally{u(!1)}})()},[e.uid]);const d=[{id:"first_character",title:"First Steps",description:"Create your first character",icon:ft.jsx(Te,{className:"w-8 h-8"}),color:"from-blue-500 to-cyan-500"},{id:"first_campaign",title:"Adventure Begins",description:"Start your first campaign",icon:ft.jsx(Me,{className:"w-8 h-8"}),color:"from-green-500 to-emerald-500"},{id:"first_combat_win",title:"Warrior",description:"Win your first combat",icon:ft.jsx(ue,{className:"w-8 h-8"}),color:"from-red-500 to-pink-500"},{id:"character_level_5",title:"Experienced Hero",description:"Reach level 5 with any character",icon:ft.jsx(ae,{className:"w-8 h-8"}),color:"from-purple-500 to-indigo-500"},{id:"complete_campaign",title:"Storyteller",description:"Complete a campaign",icon:ft.jsx(le,{className:"w-8 h-8"}),color:"from-yellow-500 to-orange-500"},{id:"multiplayer_party",title:"Party Leader",description:"Play in a multiplayer campaign",icon:ft.jsx(re,{className:"w-8 h-8"}),color:"from-indigo-500 to-purple-500"}];return h?ft.jsx("div",{className:"flex-1 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("p",{className:"text-blue-200",children:"Loading achievements..."})]})}):ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-6xl mx-auto",children:[ft.jsxs("div",{className:"mb-8",children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Achievements"}),ft.jsx("p",{className:"text-blue-200",children:"Track your progress and accomplishments"})]}),ft.jsxs("div",{className:"mb-8 grid grid-cols-1 md:grid-cols-4 gap-4",children:[ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[ft.jsx("div",{className:"text-2xl font-bold text-white",children:r.length}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Achievements Unlocked"})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[ft.jsx("div",{className:"text-2xl font-bold text-white",children:t.length}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Characters Created"})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[ft.jsx("div",{className:"text-2xl font-bold text-white",children:s.length}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Campaigns Started"})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[ft.jsx("div",{className:"text-2xl font-bold text-white",children:l.combatsWon||0}),ft.jsx("div",{className:"text-blue-200 text-sm",children:"Combats Won"})]})]}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:d.map(e=>{const n=(e=>{switch(e){case"first_character":return t.length>0?100:0;case"first_campaign":return s.length>0?100:0;case"first_combat_win":return l.combatsWon>0?100:0;case"character_level_5":return t.some(e=>e.level>=5)?100:0;case"complete_campaign":return s.some(e=>"completed"===e.status)?100:0;case"multiplayer_party":return s.some(e=>{var t;return e.isMultiplayer&&(null==(t=e.players)?void 0:t.length)>1})?100:0;default:return 0}})(e.id),i=(a=e.id,r.some(e=>e.id===a));var a;return ft.jsx("div",{className:"bg-slate-800/50 rounded-lg p-6 border transition-all duration-300 "+(i?"border-yellow-500/50 shadow-lg shadow-yellow-500/20":"border-slate-700/50"),children:ft.jsxs("div",{className:"text-center",children:[ft.jsx("div",{className:`w-16 h-16 bg-gradient-to-br ${e.color} rounded-full flex items-center justify-center mx-auto mb-4 ${i?"animate-pulse":"opacity-50"}`,children:ft.jsx("div",{className:"text-white",children:e.icon})}),ft.jsx("h3",{className:"text-lg font-semibold mb-2 "+(i?"text-white":"text-slate-400"),children:e.title}),ft.jsx("p",{className:"text-blue-200 text-sm mb-4",children:e.description}),ft.jsx("div",{className:"w-full bg-slate-700 rounded-full h-2 mb-2",children:ft.jsx("div",{className:"h-2 rounded-full transition-all duration-500 "+(i?"bg-gradient-to-r from-yellow-400 to-orange-500":"bg-blue-600"),style:{width:`${n}%`}})}),ft.jsx("p",{className:"text-xs "+(i?"text-yellow-400":"text-slate-400"),children:i?"Unlocked!":`${n}% Complete`})]})},e.id)})}),r.length>0&&ft.jsxs("div",{className:"mt-8",children:[ft.jsx("h2",{className:"text-xl font-semibold text-white mb-4",children:"Recent Achievements"}),ft.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:r.slice(0,3).map(e=>ft.jsx("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-yellow-500/30",children:ft.jsxs("div",{className:"flex items-center space-x-3",children:[ft.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full flex items-center justify-center",children:ft.jsx(le,{className:"w-5 h-5 text-white"})}),ft.jsxs("div",{children:[ft.jsx("p",{className:"text-white font-medium",children:e.title}),ft.jsx("p",{className:"text-blue-200 text-sm",children:new Date(e.unlockedAt).toLocaleDateString()})]})]})},e.id))})]})]})})},WT=({user:e})=>{var t,i,s,a,r,o,l,c,h,u,d,p;const[m,f]=n.useState({}),[g,v]=n.useState(!0);n.useEffect(()=>{(()=>{try{const e=JSON.parse(localStorage.getItem("mythseeker_settings")||"{}");f({soundEffects:!0,music:!1,notifications:!0,theme:"dark",fontSize:"medium",autoSave:!0,showTutorials:!0,diceRoller:{soundEnabled:!0,hapticEnabled:!0,shakeToRoll:!0,showHistory:!0},game:{autoRoll:!1,showDamageNumbers:!0,showHealthBars:!0,confirmActions:!0},...e})}catch(e){}finally{v(!1)}})()},[]);const x=(e,t,n)=>{const i={...m,[e]:{...m[e],[t]:n}};f(i),localStorage.setItem("mythseeker_settings",JSON.stringify(i))},y=(e,t)=>{const n={...m,[e]:t};f(n),localStorage.setItem("mythseeker_settings",JSON.stringify(n))};return g?ft.jsx("div",{className:"flex-1 flex items-center justify-center",children:ft.jsxs("div",{className:"text-center space-y-4",children:[ft.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),ft.jsx("p",{className:"text-blue-200",children:"Loading settings..."})]})}):ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-4xl mx-auto",children:[ft.jsxs("div",{className:"mb-8 flex justify-between items-center",children:[ft.jsxs("div",{children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Settings"}),ft.jsx("p",{className:"text-blue-200",children:"App preferences and configuration"})]}),ft.jsxs("div",{className:"flex space-x-3",children:[ft.jsx("button",{onClick:()=>{const e=JSON.stringify(m,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download="mythseeker-settings.json",i.click(),URL.revokeObjectURL(n)},className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Export"}),ft.jsxs("label",{className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer",children:["Import",ft.jsx("input",{type:"file",accept:".json",onChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];if(n){const e=new FileReader;e.onload=e=>{var t;try{const n=JSON.parse(null==(t=e.target)?void 0:t.result);f(n),localStorage.setItem("mythseeker_settings",JSON.stringify(n)),alert("Settings imported successfully!")}catch(n){alert("Error importing settings. Please check the file format.")}},e.readAsText(n)}},className:"hidden"})]}),ft.jsx("button",{onClick:()=>{window.confirm("Are you sure you want to reset all settings to default?")&&(localStorage.removeItem("mythseeker_settings"),window.location.reload())},className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Reset"})]})]}),ft.jsxs("div",{className:"space-y-6",children:[ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Audio Settings"}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Sound Effects"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Enable sound effects and audio feedback"})]}),ft.jsx("button",{onClick:()=>y("soundEffects",!m.soundEffects),className:"w-12 h-6 rounded-full relative transition-colors "+(m.soundEffects?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.soundEffects?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Music"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Enable background music"})]}),ft.jsx("button",{onClick:()=>y("music",!m.music),className:"w-12 h-6 rounded-full relative transition-colors "+(m.music?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.music?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Notifications"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Show toast notifications"})]}),ft.jsx("button",{onClick:()=>y("notifications",!m.notifications),className:"w-12 h-6 rounded-full relative transition-colors "+(m.notifications?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.notifications?"right-1":"left-1")})})]})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Display Settings"}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Theme"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Choose your preferred theme"})]}),ft.jsxs("select",{value:m.theme,onChange:e=>y("theme",e.target.value),className:"bg-slate-700 text-white px-3 py-2 rounded border border-slate-600",children:[ft.jsx("option",{value:"dark",children:"Dark"}),ft.jsx("option",{value:"light",children:"Light"}),ft.jsx("option",{value:"auto",children:"Auto"})]})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Font Size"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Adjust text size for readability"})]}),ft.jsxs("select",{value:m.fontSize,onChange:e=>y("fontSize",e.target.value),className:"bg-slate-700 text-white px-3 py-2 rounded border border-slate-600",children:[ft.jsx("option",{value:"small",children:"Small"}),ft.jsx("option",{value:"medium",children:"Medium"}),ft.jsx("option",{value:"large",children:"Large"})]})]})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Game Settings"}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Auto Save"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Automatically save game progress"})]}),ft.jsx("button",{onClick:()=>y("autoSave",!m.autoSave),className:"w-12 h-6 rounded-full relative transition-colors "+(m.autoSave?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.autoSave?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Show Tutorials"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Display helpful tutorial tips"})]}),ft.jsx("button",{onClick:()=>y("showTutorials",!m.showTutorials),className:"w-12 h-6 rounded-full relative transition-colors "+(m.showTutorials?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.showTutorials?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Show Damage Numbers"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Display damage numbers in combat"})]}),ft.jsx("button",{onClick:()=>{var e;return x("game","showDamageNumbers",!(null==(e=m.game)?void 0:e.showDamageNumbers))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(t=m.game)?void 0:t.showDamageNumbers)?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(i=m.game)?void 0:i.showDamageNumbers)?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Confirm Actions"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Ask for confirmation before important actions"})]}),ft.jsx("button",{onClick:()=>{var e;return x("game","confirmActions",!(null==(e=m.game)?void 0:e.confirmActions))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(s=m.game)?void 0:s.confirmActions)?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(a=m.game)?void 0:a.confirmActions)?"right-1":"left-1")})})]})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Dice Roller Settings"}),ft.jsxs("div",{className:"space-y-4",children:[ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Sound Effects"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Play sounds when rolling dice"})]}),ft.jsx("button",{onClick:()=>{var e;return x("diceRoller","soundEnabled",!(null==(e=m.diceRoller)?void 0:e.soundEnabled))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(r=m.diceRoller)?void 0:r.soundEnabled)?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(o=m.diceRoller)?void 0:o.soundEnabled)?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Haptic Feedback"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Vibrate device when rolling dice"})]}),ft.jsx("button",{onClick:()=>{var e;return x("diceRoller","hapticEnabled",!(null==(e=m.diceRoller)?void 0:e.hapticEnabled))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(l=m.diceRoller)?void 0:l.hapticEnabled)?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(c=m.diceRoller)?void 0:c.hapticEnabled)?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Shake to Roll"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Roll dice by shaking your device"})]}),ft.jsx("button",{onClick:()=>{var e;return x("diceRoller","shakeToRoll",!(null==(e=m.diceRoller)?void 0:e.shakeToRoll))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(h=m.diceRoller)?void 0:h.shakeToRoll)?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(u=m.diceRoller)?void 0:u.shakeToRoll)?"right-1":"left-1")})})]}),ft.jsxs("div",{className:"flex items-center justify-between",children:[ft.jsxs("div",{children:[ft.jsx("span",{className:"text-blue-200",children:"Show History"}),ft.jsx("p",{className:"text-slate-400 text-sm",children:"Display roll history in drawer"})]}),ft.jsx("button",{onClick:()=>{var e;return x("diceRoller","showHistory",!(null==(e=m.diceRoller)?void 0:e.showHistory))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(d=m.diceRoller)?void 0:d.showHistory)?"bg-blue-600":"bg-slate-600"),children:ft.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(p=m.diceRoller)?void 0:p.showHistory)?"right-1":"left-1")})})]})]})]})]})]})})},GT=({user:e})=>ft.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:ft.jsxs("div",{className:"max-w-4xl mx-auto",children:[ft.jsxs("div",{className:"mb-8",children:[ft.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Help & Support"}),ft.jsx("p",{className:"text-blue-200",children:"Support & documentation"})]}),ft.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Getting Started"}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Quick Start Guide"})}),ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Character Creation"})}),ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"First Campaign"})})]})]}),ft.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[ft.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Support"}),ft.jsxs("div",{className:"space-y-3",children:[ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"FAQ"})}),ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Contact Support"})}),ft.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:ft.jsx("span",{className:"text-white",children:"Bug Report"})})]})]})]})]})}),qT=console.warn;console.warn=(...e)=>{const t=e[0];"string"==typeof t&&t.includes("Cross-Origin-Opener-Policy")||qT.apply(console,e)},gt.createRoot(document.getElementById("root")).render(ft.jsx(r.StrictMode,{children:ft.jsx(bT,{})}));export{Fr as T,li as U,ft as j};
