var e=Object.defineProperty,t=(t,n,i)=>(((t,n,i)=>{n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i})(t,"symbol"!=typeof n?n+"":n,i),i);import{r as n,a as i,R as s,b as r,c as a}from"./react-vendor-132e4a4f.js";import{g as o,G as l,s as c,a as h,b as u,c as d,o as p,_ as m,d as f}from"./firebase-auth-07649063.js";import{T as g,r as v,_ as x,C as y,c as _,E as b,F as w,U as S,b as M,e as T,k as E,m as C,f as A,V as N,W as R,X as P,Y as I}from"./firebase-core-a7cb50f5.js";import{g as j,s as D,d as k,a as L,u as O,b as U,c as F,q as B,w as z,e as V,f as H,h as W,o as G}from"./firebase-firestore-e3da4556.js";import{g as q,r as X,s as Y,o as $,a as Z,p as K,u as J,b as Q}from"./firebase-database-b022e4c6.js";import{S as ee,A as te,T as ne,U as ie,C as se,a as re,b as ae,c as oe,d as le,e as ce,R as he,H as ue,f as de,X as pe,Z as me,g as fe,F as ge,G as ve,h as xe,B as ye,i as _e,j as be,k as we,P as Se,l as Me,m as Te,n as Ee,o as Ce,p as Ae,q as Ne,r as Re,s as Pe,t as Ie,u as je,L as De,M as ke,v as Le,w as Oe,x as Ue,y as Fe,z as Be,D as ze,E as Ve,I as He,J as We,K as Ge,N as qe,O as Xe,Q as Ye}from"./ui-vendor-1b8d788c.js";import{getFunctions as $e,httpsCallable as Ze}from"./firebase-functions-7c25f05b.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var Ke={exports:{}},Je={},Qe=n,et=Symbol.for("react.element"),tt=Symbol.for("react.fragment"),nt=Object.prototype.hasOwnProperty,it=Qe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,st={key:!0,ref:!0,__self:!0,__source:!0};function rt(e,t,n){var i,s={},r=null,a=null;for(i in void 0!==n&&(r=""+n),void 0!==t.key&&(r=""+t.key),void 0!==t.ref&&(a=t.ref),t)nt.call(t,i)&&!st.hasOwnProperty(i)&&(s[i]=t[i]);if(e&&e.defaultProps)for(i in t=e.defaultProps)void 0===s[i]&&(s[i]=t[i]);return{$$typeof:et,type:e,key:r,ref:a,props:s,_owner:it.current}}Je.Fragment=tt,Je.jsx=rt,Je.jsxs=rt,Ke.exports=Je;var at=Ke.exports,ot={},lt=i;ot.createRoot=lt.createRoot,ot.hydrateRoot=lt.hydrateRoot;const ct={},ht=function(e,t,n){if(!t||0===t.length)return e();const i=document.getElementsByTagName("link");return Promise.all(t.map(e=>{if((e=function(e){return"/"+e}(e))in ct)return;ct[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(n)for(let n=i.length-1;n>=0;n--){const s=i[n];if(s.href===e&&(!t||"stylesheet"===s.rel))return}else if(document.querySelector(`link[href="${e}"]${s}`))return;const r=document.createElement("link");return r.rel=t?"stylesheet":"modulepreload",t||(r.as="script",r.crossOrigin=""),r.href=e,document.head.appendChild(r),t?new Promise((t,n)=>{r.addEventListener("load",t),r.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0})).then(()=>e()).catch(e=>{const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e})};var ut={};Object.defineProperty(ut,"__esModule",{value:!0}),ut.parse=function(e,t){const n=new vt,i=e.length;if(i<2)return n;const s=(null==t?void 0:t.decode)||_t;let r=0;do{const t=e.indexOf("=",r);if(-1===t)break;const a=e.indexOf(";",r),o=-1===a?i:a;if(t>o){r=e.lastIndexOf(";",t-1)+1;continue}const l=xt(e,r,t),c=yt(e,t,l),h=e.slice(l,c);if(void 0===n[h]){let i=xt(e,t+1,o),r=yt(e,o,i);const a=s(e.slice(i,r));n[h]=a}r=o+1}while(r<i);return n},ut.serialize=function(e,t,n){const i=(null==n?void 0:n.encode)||encodeURIComponent;if(!dt.test(e))throw new TypeError(`argument name is invalid: ${e}`);const s=i(t);if(!pt.test(s))throw new TypeError(`argument val is invalid: ${t}`);let r=e+"="+s;if(!n)return r;if(void 0!==n.maxAge){if(!Number.isInteger(n.maxAge))throw new TypeError(`option maxAge is invalid: ${n.maxAge}`);r+="; Max-Age="+n.maxAge}if(n.domain){if(!mt.test(n.domain))throw new TypeError(`option domain is invalid: ${n.domain}`);r+="; Domain="+n.domain}if(n.path){if(!ft.test(n.path))throw new TypeError(`option path is invalid: ${n.path}`);r+="; Path="+n.path}if(n.expires){if(!function(e){return"[object Date]"===gt.call(e)}(n.expires)||!Number.isFinite(n.expires.valueOf()))throw new TypeError(`option expires is invalid: ${n.expires}`);r+="; Expires="+n.expires.toUTCString()}if(n.httpOnly&&(r+="; HttpOnly"),n.secure&&(r+="; Secure"),n.partitioned&&(r+="; Partitioned"),n.priority)switch("string"==typeof n.priority?n.priority.toLowerCase():void 0){case"low":r+="; Priority=Low";break;case"medium":r+="; Priority=Medium";break;case"high":r+="; Priority=High";break;default:throw new TypeError(`option priority is invalid: ${n.priority}`)}if(n.sameSite)switch("string"==typeof n.sameSite?n.sameSite.toLowerCase():n.sameSite){case!0:case"strict":r+="; SameSite=Strict";break;case"lax":r+="; SameSite=Lax";break;case"none":r+="; SameSite=None";break;default:throw new TypeError(`option sameSite is invalid: ${n.sameSite}`)}return r};const dt=/^[\u0021-\u003A\u003C\u003E-\u007E]+$/,pt=/^[\u0021-\u003A\u003C-\u007E]*$/,mt=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i,ft=/^[\u0020-\u003A\u003D-\u007E]*$/,gt=Object.prototype.toString,vt=(()=>{const e=function(){};return e.prototype=Object.create(null),e})();function xt(e,t,n){do{const n=e.charCodeAt(t);if(32!==n&&9!==n)return t}while(++t<n);return n}function yt(e,t,n){for(;t>n;){const n=e.charCodeAt(--t);if(32!==n&&9!==n)return t+1}return n}function _t(e){if(-1===e.indexOf("%"))return e;try{return decodeURIComponent(e)}catch(t){return e}}var bt="popstate";function wt(e,t){if(!1===e||null==e)throw new Error(t)}function St(e,t){if(!e)try{throw new Error(t)}catch(n){}}function Mt(e,t){return{usr:e.state,key:e.key,idx:t}}function Tt(e,t,n=null,i){return{pathname:"string"==typeof e?e:e.pathname,search:"",hash:"",..."string"==typeof t?Ct(t):t,state:n,key:t&&t.key||i||Math.random().toString(36).substring(2,10)}}function Et({pathname:e="/",search:t="",hash:n=""}){return t&&"?"!==t&&(e+="?"===t.charAt(0)?t:"?"+t),n&&"#"!==n&&(e+="#"===n.charAt(0)?n:"#"+n),e}function Ct(e){let t={};if(e){let n=e.indexOf("#");n>=0&&(t.hash=e.substring(n),e=e.substring(0,n));let i=e.indexOf("?");i>=0&&(t.search=e.substring(i),e=e.substring(0,i)),e&&(t.pathname=e)}return t}function At(e,t,n="/"){return function(e,t,n){let i=Vt(("string"==typeof t?Ct(t):t).pathname||"/",n);if(null==i)return null;let s=Nt(e);!function(e){e.sort((e,t)=>e.score!==t.score?t.score-e.score:function(e,t){return e.length===t.length&&e.slice(0,-1).every((e,n)=>e===t[n])?e[e.length-1]-t[t.length-1]:0}(e.routesMeta.map(e=>e.childrenIndex),t.routesMeta.map(e=>e.childrenIndex)))}(s);let r=null;for(let a=0;null==r&&a<s.length;++a){let e=zt(i);r=Ft(s[a],e,false)}return r}(e,t,n)}function Nt(e,t=[],n=[],i=""){let s=(e,s,r)=>{let a={relativePath:void 0===r?e.path||"":r,caseSensitive:!0===e.caseSensitive,childrenIndex:s,route:e};a.relativePath.startsWith("/")&&(wt(a.relativePath.startsWith(i),`Absolute route path "${a.relativePath}" nested under path "${i}" is not valid. An absolute child route path must start with the combined path of all its parent routes.`),a.relativePath=a.relativePath.slice(i.length));let o=qt([i,a.relativePath]),l=n.concat(a);e.children&&e.children.length>0&&(wt(!0!==e.index,`Index routes must not have child routes. Please remove all child routes from route path "${o}".`),Nt(e.children,t,l,o)),(null!=e.path||e.index)&&t.push({path:o,score:Ut(o,e.index),routesMeta:l})};return e.forEach((e,t)=>{var n;if(""!==e.path&&(null==(n=e.path)?void 0:n.includes("?")))for(let i of Rt(e.path))s(e,t,i);else s(e,t)}),t}function Rt(e){let t=e.split("/");if(0===t.length)return[];let[n,...i]=t,s=n.endsWith("?"),r=n.replace(/\?$/,"");if(0===i.length)return s?[r,""]:[r];let a=Rt(i.join("/")),o=[];return o.push(...a.map(e=>""===e?r:[r,e].join("/"))),s&&o.push(...a),o.map(t=>e.startsWith("/")&&""===t?"/":t)}var Pt=/^:[\w-]+$/,It=3,jt=2,Dt=1,kt=10,Lt=-2,Ot=e=>"*"===e;function Ut(e,t){let n=e.split("/"),i=n.length;return n.some(Ot)&&(i+=Lt),t&&(i+=jt),n.filter(e=>!Ot(e)).reduce((e,t)=>e+(Pt.test(t)?It:""===t?Dt:kt),i)}function Ft(e,t,n=!1){let{routesMeta:i}=e,s={},r="/",a=[];for(let o=0;o<i.length;++o){let e=i[o],l=o===i.length-1,c="/"===r?t:t.slice(r.length)||"/",h=Bt({path:e.relativePath,caseSensitive:e.caseSensitive,end:l},c),u=e.route;if(!h&&l&&n&&!i[i.length-1].route.index&&(h=Bt({path:e.relativePath,caseSensitive:e.caseSensitive,end:!1},c)),!h)return null;Object.assign(s,h.params),a.push({params:s,pathname:qt([r,h.pathname]),pathnameBase:Xt(qt([r,h.pathnameBase])),route:u}),"/"!==h.pathnameBase&&(r=qt([r,h.pathnameBase]))}return a}function Bt(e,t){"string"==typeof e&&(e={path:e,caseSensitive:!1,end:!0});let[n,i]=function(e,t=!1,n=!0){St("*"===e||!e.endsWith("*")||e.endsWith("/*"),`Route path "${e}" will be treated as if it were "${e.replace(/\*$/,"/*")}" because the \`*\` character must always follow a \`/\` in the pattern. To get rid of this warning, please change the route path to "${e.replace(/\*$/,"/*")}".`);let i=[],s="^"+e.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(e,t,n)=>(i.push({paramName:t,isOptional:null!=n}),n?"/?([^\\/]+)?":"/([^\\/]+)"));return e.endsWith("*")?(i.push({paramName:"*"}),s+="*"===e||"/*"===e?"(.*)$":"(?:\\/(.+)|\\/*)$"):n?s+="\\/*$":""!==e&&"/"!==e&&(s+="(?:(?=\\/|$))"),[new RegExp(s,t?void 0:"i"),i]}(e.path,e.caseSensitive,e.end),s=t.match(n);if(!s)return null;let r=s[0],a=r.replace(/(.)\/+$/,"$1"),o=s.slice(1);return{params:i.reduce((e,{paramName:t,isOptional:n},i)=>{if("*"===t){let e=o[i]||"";a=r.slice(0,r.length-e.length).replace(/(.)\/+$/,"$1")}const s=o[i];return e[t]=n&&!s?void 0:(s||"").replace(/%2F/g,"/"),e},{}),pathname:r,pathnameBase:a,pattern:e}}function zt(e){try{return e.split("/").map(e=>decodeURIComponent(e).replace(/\//g,"%2F")).join("/")}catch(t){return St(!1,`The URL path "${e}" could not be decoded because it is a malformed URL segment. This is probably due to a bad percent encoding (${t}).`),e}}function Vt(e,t){if("/"===t)return e;if(!e.toLowerCase().startsWith(t.toLowerCase()))return null;let n=t.endsWith("/")?t.length-1:t.length,i=e.charAt(n);return i&&"/"!==i?null:e.slice(n)||"/"}function Ht(e,t,n,i){return`Cannot include a '${e}' character in a manually specified \`to.${t}\` field [${JSON.stringify(i)}].  Please separate it out to the \`to.${n}\` field. Alternatively you may provide the full path as a string in <Link to="..."> and the router will parse it for you.`}function Wt(e){let t=function(e){return e.filter((e,t)=>0===t||e.route.path&&e.route.path.length>0)}(e);return t.map((e,n)=>n===t.length-1?e.pathname:e.pathnameBase)}function Gt(e,t,n,i=!1){let s;"string"==typeof e?s=Ct(e):(s={...e},wt(!s.pathname||!s.pathname.includes("?"),Ht("?","pathname","search",s)),wt(!s.pathname||!s.pathname.includes("#"),Ht("#","pathname","hash",s)),wt(!s.search||!s.search.includes("#"),Ht("#","search","hash",s)));let r,a=""===e||""===s.pathname,o=a?"/":s.pathname;if(null==o)r=n;else{let e=t.length-1;if(!i&&o.startsWith("..")){let t=o.split("/");for(;".."===t[0];)t.shift(),e-=1;s.pathname=t.join("/")}r=e>=0?t[e]:"/"}let l=function(e,t="/"){let{pathname:n,search:i="",hash:s=""}="string"==typeof e?Ct(e):e,r=n?n.startsWith("/")?n:function(e,t){let n=t.replace(/\/+$/,"").split("/");return e.split("/").forEach(e=>{".."===e?n.length>1&&n.pop():"."!==e&&n.push(e)}),n.length>1?n.join("/"):"/"}(n,t):t;return{pathname:r,search:Yt(i),hash:$t(s)}}(s,r),c=o&&"/"!==o&&o.endsWith("/"),h=(a||"."===o)&&n.endsWith("/");return l.pathname.endsWith("/")||!c&&!h||(l.pathname+="/"),l}var qt=e=>e.join("/").replace(/\/\/+/g,"/"),Xt=e=>e.replace(/\/+$/,"").replace(/^\/*/,"/"),Yt=e=>e&&"?"!==e?e.startsWith("?")?e:"?"+e:"",$t=e=>e&&"#"!==e?e.startsWith("#")?e:"#"+e:"",Zt=["POST","PUT","PATCH","DELETE"];new Set(Zt);var Kt=["GET",...Zt];new Set(Kt);var Jt=n.createContext(null);Jt.displayName="DataRouter";var Qt=n.createContext(null);Qt.displayName="DataRouterState";var en=n.createContext({isTransitioning:!1});en.displayName="ViewTransition",n.createContext(new Map).displayName="Fetchers",n.createContext(null).displayName="Await";var tn=n.createContext(null);tn.displayName="Navigation";var nn=n.createContext(null);nn.displayName="Location";var sn=n.createContext({outlet:null,matches:[],isDataRoute:!1});sn.displayName="Route";var rn=n.createContext(null);function an(){return null!=n.useContext(nn)}function on(){return wt(an(),"useLocation() may be used only in the context of a <Router> component."),n.useContext(nn).location}rn.displayName="RouteError";var ln="You should call navigate() in a React.useEffect(), not when your component is first rendered.";function cn(e){n.useContext(tn).static||n.useLayoutEffect(e)}function hn(){let{isDataRoute:e}=n.useContext(sn);return e?function(){let{router:e}=function(){let e=n.useContext(Jt);return wt(e,vn("useNavigate")),e}(),t=xn("useNavigate"),i=n.useRef(!1);return cn(()=>{i.current=!0}),n.useCallback(async(n,s={})=>{St(i.current,ln),i.current&&("number"==typeof n?e.navigate(n):await e.navigate(n,{fromRouteId:t,...s}))},[e,t])}():function(){wt(an(),"useNavigate() may be used only in the context of a <Router> component.");let e=n.useContext(Jt),{basename:t,navigator:i}=n.useContext(tn),{matches:s}=n.useContext(sn),{pathname:r}=on(),a=JSON.stringify(Wt(s)),o=n.useRef(!1);return cn(()=>{o.current=!0}),n.useCallback((n,s={})=>{if(St(o.current,ln),!o.current)return;if("number"==typeof n)return void i.go(n);let l=Gt(n,JSON.parse(a),r,"path"===s.relative);null==e&&"/"!==t&&(l.pathname="/"===l.pathname?t:qt([t,l.pathname])),(s.replace?i.replace:i.push)(l,s.state,s)},[t,i,a,r,e])}()}function un(e,{relative:t}={}){let{matches:i}=n.useContext(sn),{pathname:s}=on(),r=JSON.stringify(Wt(i));return n.useMemo(()=>Gt(e,JSON.parse(r),s,"path"===t),[e,r,s,t])}function dn(e,t,i,s){var r;wt(an(),"useRoutes() may be used only in the context of a <Router> component.");let{navigator:a}=n.useContext(tn),{matches:o}=n.useContext(sn),l=o[o.length-1],c=l?l.params:{},h=l?l.pathname:"/",u=l?l.pathnameBase:"/",d=l&&l.route;{let e=d&&d.path||"";_n(h,!d||e.endsWith("*")||e.endsWith("*?"),`You rendered descendant <Routes> (or called \`useRoutes()\`) at "${h}" (under <Route path="${e}">) but the parent route path has no trailing "*". This means if you navigate deeper, the parent won't match anymore and therefore the child routes will never render.\n\nPlease change the parent <Route path="${e}"> to <Route path="${"/"===e?"*":`${e}/*`}">.`)}let p,m=on();if(t){let e="string"==typeof t?Ct(t):t;wt("/"===u||(null==(r=e.pathname)?void 0:r.startsWith(u)),`When overriding the location using \`<Routes location>\` or \`useRoutes(routes, location)\`, the location pathname must begin with the portion of the URL pathname that was matched by all parent routes. The current pathname base is "${u}" but pathname "${e.pathname}" was given in the \`location\` prop.`),p=e}else p=m;let f=p.pathname||"/",g=f;if("/"!==u){let e=u.replace(/^\//,"").split("/");g="/"+f.replace(/^\//,"").split("/").slice(e.length).join("/")}let v=At(e,{pathname:g});St(d||null!=v,`No routes matched location "${p.pathname}${p.search}${p.hash}" `),St(null==v||void 0!==v[v.length-1].route.element||void 0!==v[v.length-1].route.Component||void 0!==v[v.length-1].route.lazy,`Matched leaf route at location "${p.pathname}${p.search}${p.hash}" does not have an element or Component. This means it will render an <Outlet /> with a null value by default resulting in an "empty" page.`);let x=function(e,t=[],i=null){if(null==e){if(!i)return null;if(i.errors)e=i.matches;else{if(0!==t.length||i.initialized||!(i.matches.length>0))return null;e=i.matches}}let s=e,r=null==i?void 0:i.errors;if(null!=r){let e=s.findIndex(e=>e.route.id&&void 0!==(null==r?void 0:r[e.route.id]));wt(e>=0,`Could not find a matching route for errors on route IDs: ${Object.keys(r).join(",")}`),s=s.slice(0,Math.min(s.length,e+1))}let a=!1,o=-1;if(i)for(let n=0;n<s.length;n++){let e=s[n];if((e.route.HydrateFallback||e.route.hydrateFallbackElement)&&(o=n),e.route.id){let{loaderData:t,errors:n}=i,r=e.route.loader&&!t.hasOwnProperty(e.route.id)&&(!n||void 0===n[e.route.id]);if(e.route.lazy||r){a=!0,s=o>=0?s.slice(0,o+1):[s[0]];break}}}return s.reduceRight((e,l,c)=>{let h,u=!1,d=null,p=null;i&&(h=r&&l.route.id?r[l.route.id]:void 0,d=l.route.errorElement||mn,a&&(o<0&&0===c?(_n("route-fallback",!1,"No `HydrateFallback` element provided to render during initial hydration"),u=!0,p=null):o===c&&(u=!0,p=l.route.hydrateFallbackElement||null)));let m=t.concat(s.slice(0,c+1)),f=()=>{let t;return t=h?d:u?p:l.route.Component?n.createElement(l.route.Component,null):l.route.element?l.route.element:e,n.createElement(gn,{match:l,routeContext:{outlet:e,matches:m,isDataRoute:null!=i},children:t})};return i&&(l.route.ErrorBoundary||l.route.errorElement||0===c)?n.createElement(fn,{location:i.location,revalidation:i.revalidation,component:d,error:h,children:f(),routeContext:{outlet:null,matches:m,isDataRoute:!0}}):f()},null)}(v&&v.map(e=>Object.assign({},e,{params:Object.assign({},c,e.params),pathname:qt([u,a.encodeLocation?a.encodeLocation(e.pathname).pathname:e.pathname]),pathnameBase:"/"===e.pathnameBase?u:qt([u,a.encodeLocation?a.encodeLocation(e.pathnameBase).pathname:e.pathnameBase])})),o,i);return t&&x?n.createElement(nn.Provider,{value:{location:{pathname:"/",search:"",hash:"",state:null,key:"default",...p},navigationType:"POP"}},x):x}function pn(){let e=function(){var e;let t=n.useContext(rn),i=function(){let e=n.useContext(Qt);return wt(e,vn("useRouteError")),e}(),s=xn("useRouteError");return void 0!==t?t:null==(e=i.errors)?void 0:e[s]}(),t=function(e){return null!=e&&"number"==typeof e.status&&"string"==typeof e.statusText&&"boolean"==typeof e.internal&&"data"in e}(e)?`${e.status} ${e.statusText}`:e instanceof Error?e.message:JSON.stringify(e),i=e instanceof Error?e.stack:null,s="rgba(200,200,200, 0.5)",r={padding:"0.5rem",backgroundColor:s},a={padding:"2px 4px",backgroundColor:s},o=null;return o=n.createElement(n.Fragment,null,n.createElement("p",null,"💿 Hey developer 👋"),n.createElement("p",null,"You can provide a way better UX than this when your app throws errors by providing your own ",n.createElement("code",{style:a},"ErrorBoundary")," or"," ",n.createElement("code",{style:a},"errorElement")," prop on your route.")),n.createElement(n.Fragment,null,n.createElement("h2",null,"Unexpected Application Error!"),n.createElement("h3",{style:{fontStyle:"italic"}},t),i?n.createElement("pre",{style:r},i):null,o)}n.createContext(null);var mn=n.createElement(pn,null),fn=class extends n.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||"idle"!==t.revalidation&&"idle"===e.revalidation?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:void 0!==e.error?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){}render(){return void 0!==this.state.error?n.createElement(sn.Provider,{value:this.props.routeContext},n.createElement(rn.Provider,{value:this.state.error,children:this.props.component})):this.props.children}};function gn({routeContext:e,match:t,children:i}){let s=n.useContext(Jt);return s&&s.static&&s.staticContext&&(t.route.errorElement||t.route.ErrorBoundary)&&(s.staticContext._deepestRenderedBoundaryId=t.route.id),n.createElement(sn.Provider,{value:e},i)}function vn(e){return`${e} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}function xn(e){let t=function(e){let t=n.useContext(sn);return wt(t,vn(e)),t}(e),i=t.matches[t.matches.length-1];return wt(i.route.id,`${e} can only be used on routes that contain a unique "id"`),i.route.id}var yn={};function _n(e,t,n){t||yn[e]||(yn[e]=!0,St(!1,n))}function bn({to:e,replace:t,state:i,relative:s}){wt(an(),"<Navigate> may be used only in the context of a <Router> component.");let{static:r}=n.useContext(tn);St(!r,"<Navigate> must not be used on the initial render in a <StaticRouter>. This is a no-op, but you should modify your code so the <Navigate> is only ever rendered in response to some user interaction or state change.");let{matches:a}=n.useContext(sn),{pathname:o}=on(),l=hn(),c=Gt(e,Wt(a),o,"path"===s),h=JSON.stringify(c);return n.useEffect(()=>{l(JSON.parse(h),{replace:t,state:i,relative:s})},[l,h,s,t,i]),null}function wn(e){wt(!1,"A <Route> is only ever to be used as the child of <Routes> element, never rendered directly. Please wrap your <Route> in a <Routes>.")}function Sn({basename:e="/",children:t=null,location:i,navigationType:s="POP",navigator:r,static:a=!1}){wt(!an(),"You cannot render a <Router> inside another <Router>. You should never have more than one in your app.");let o=e.replace(/^\/*/,"/"),l=n.useMemo(()=>({basename:o,navigator:r,static:a,future:{}}),[o,r,a]);"string"==typeof i&&(i=Ct(i));let{pathname:c="/",search:h="",hash:u="",state:d=null,key:p="default"}=i,m=n.useMemo(()=>{let e=Vt(c,o);return null==e?null:{location:{pathname:e,search:h,hash:u,state:d,key:p},navigationType:s}},[o,c,h,u,d,p,s]);return St(null!=m,`<Router basename="${o}"> is not able to match the URL "${c}${h}${u}" because it does not start with the basename, so the <Router> won't render anything.`),null==m?null:n.createElement(tn.Provider,{value:l},n.createElement(nn.Provider,{children:t,value:m}))}function Mn({children:e,location:t}){return dn(Tn(e),t)}function Tn(e,t=[]){let i=[];return n.Children.forEach(e,(e,s)=>{if(!n.isValidElement(e))return;let r=[...t,s];if(e.type===n.Fragment)return void i.push.apply(i,Tn(e.props.children,r));wt(e.type===wn,`[${"string"==typeof e.type?e.type:e.type.name}] is not a <Route> component. All component children of <Routes> must be a <Route> or <React.Fragment>`),wt(!e.props.index||!e.props.children,"An index route cannot have child routes.");let a={id:e.props.id||r.join("-"),caseSensitive:e.props.caseSensitive,element:e.props.element,Component:e.props.Component,index:e.props.index,path:e.props.path,loader:e.props.loader,action:e.props.action,hydrateFallbackElement:e.props.hydrateFallbackElement,HydrateFallback:e.props.HydrateFallback,errorElement:e.props.errorElement,ErrorBoundary:e.props.ErrorBoundary,hasErrorBoundary:!0===e.props.hasErrorBoundary||null!=e.props.ErrorBoundary||null!=e.props.errorElement,shouldRevalidate:e.props.shouldRevalidate,handle:e.props.handle,lazy:e.props.lazy};e.props.children&&(a.children=Tn(e.props.children,r)),i.push(a)}),i}n.memo(function({routes:e,future:t,state:n}){return dn(e,void 0,n)});var En="get",Cn="application/x-www-form-urlencoded";function An(e){return null!=e&&"string"==typeof e.tagName}var Nn=null,Rn=new Set(["application/x-www-form-urlencoded","multipart/form-data","text/plain"]);function Pn(e){return null==e||Rn.has(e)?e:(St(!1,`"${e}" is not a valid \`encType\` for \`<Form>\`/\`<fetcher.Form>\` and will default to "${Cn}"`),null)}function In(e,t){if(!1===e||null==e)throw new Error(t)}function jn(e){return null!=e&&(null==e.href?"preload"===e.rel&&"string"==typeof e.imageSrcSet&&"string"==typeof e.imageSizes:"string"==typeof e.rel&&"string"==typeof e.href)}function Dn(e,t,n,i,s,r){let a=(e,t)=>!n[t]||e.route.id!==n[t].route.id,o=(e,t)=>{var i;return n[t].pathname!==e.pathname||(null==(i=n[t].route.path)?void 0:i.endsWith("*"))&&n[t].params["*"]!==e.params["*"]};return"assets"===r?t.filter((e,t)=>a(e,t)||o(e,t)):"data"===r?t.filter((t,r)=>{var l;let c=i.routes[t.route.id];if(!c||!c.hasLoader)return!1;if(a(t,r)||o(t,r))return!0;if(t.route.shouldRevalidate){let i=t.route.shouldRevalidate({currentUrl:new URL(s.pathname+s.search+s.hash,window.origin),currentParams:(null==(l=n[0])?void 0:l.params)||{},nextUrl:new URL(e,window.origin),nextParams:t.params,defaultShouldRevalidate:!0});if("boolean"==typeof i)return i}return!0}):[]}function kn(){let e=n.useContext(Jt);return In(e,"You must render this element inside a <DataRouterContext.Provider> element"),e}Object.getOwnPropertyNames(Object.prototype).sort().join("\0");var Ln=n.createContext(void 0);function On(){let e=n.useContext(Ln);return In(e,"You must render this element inside a <HydratedRouter> element"),e}function Un(e,t){return n=>{e&&e(n),n.defaultPrevented||t(n)}}function Fn({page:e,...t}){let{router:i}=kn(),s=n.useMemo(()=>At(i.routes,e,i.basename),[i.routes,e,i.basename]);return s?n.createElement(Bn,{page:e,matches:s,...t}):null}function Bn({page:e,matches:t,...i}){let s=on(),{manifest:r,routeModules:a}=On(),{basename:o}=kn(),{loaderData:l,matches:c}=function(){let e=n.useContext(Qt);return In(e,"You must render this element inside a <DataRouterStateContext.Provider> element"),e}(),h=n.useMemo(()=>Dn(e,t,c,r,s,"data"),[e,t,c,r,s]),u=n.useMemo(()=>Dn(e,t,c,r,s,"assets"),[e,t,c,r,s]),d=n.useMemo(()=>{if(e===s.pathname+s.search+s.hash)return[];let n=new Set,i=!1;if(t.forEach(e=>{var t;let s=r.routes[e.route.id];s&&s.hasLoader&&(!h.some(t=>t.route.id===e.route.id)&&e.route.id in l&&(null==(t=a[e.route.id])?void 0:t.shouldRevalidate)||s.hasClientLoader?i=!0:n.add(e.route.id))}),0===n.size)return[];let c=function(e,t){let n="string"==typeof e?new URL(e,"undefined"==typeof window?"server://singlefetch/":window.location.origin):e;return"/"===n.pathname?n.pathname="_root.data":t&&"/"===Vt(n.pathname,t)?n.pathname=`${t.replace(/\/$/,"")}/_root.data`:n.pathname=`${n.pathname.replace(/\/$/,"")}.data`,n}(e,o);return i&&n.size>0&&c.searchParams.set("_routes",t.filter(e=>n.has(e.route.id)).map(e=>e.route.id).join(",")),[c.pathname+c.search]},[o,l,s,r,h,t,e,a]),p=n.useMemo(()=>function(e,t,{includeHydrateFallback:n}={}){return i=e.map(e=>{let i=t.routes[e.route.id];if(!i)return[];let s=[i.module];return i.clientActionModule&&(s=s.concat(i.clientActionModule)),i.clientLoaderModule&&(s=s.concat(i.clientLoaderModule)),n&&i.hydrateFallbackModule&&(s=s.concat(i.hydrateFallbackModule)),i.imports&&(s=s.concat(i.imports)),s}).flat(1),[...new Set(i)];var i}(u,r),[u,r]),m=function(e){let{manifest:t,routeModules:i}=On(),[s,r]=n.useState([]);return n.useEffect(()=>{let n=!1;return async function(e,t,n){return function(e,t){let n=new Set;return new Set(t),e.reduce((e,t)=>{let i=JSON.stringify(function(e){let t={},n=Object.keys(e).sort();for(let i of n)t[i]=e[i];return t}(t));return n.has(i)||(n.add(i),e.push({key:i,link:t})),e},[])}((await Promise.all(e.map(async e=>{let i=t.routes[e.route.id];if(i){let e=await async function(e,t){if(e.id in t)return t[e.id];try{let n=await ht(()=>import(e.module),[]);return t[e.id]=n,n}catch(n){return window.__reactRouterContext&&window.__reactRouterContext.isSpaMode,window.location.reload(),new Promise(()=>{})}}(i,n);return e.links?e.links():[]}return[]}))).flat(1).filter(jn).filter(e=>"stylesheet"===e.rel||"preload"===e.rel).map(e=>"stylesheet"===e.rel?{...e,rel:"prefetch",as:"style"}:{...e,rel:"prefetch"}))}(e,t,i).then(e=>{n||r(e)}),()=>{n=!0}},[e,t,i]),s}(u);return n.createElement(n.Fragment,null,d.map(e=>n.createElement("link",{key:e,rel:"prefetch",as:"fetch",href:e,...i})),p.map(e=>n.createElement("link",{key:e,rel:"modulepreload",href:e,...i})),m.map(({key:e,link:t})=>n.createElement("link",{key:e,...t})))}function zn(...e){return t=>{e.forEach(e=>{"function"==typeof e?e(t):null!=e&&(e.current=t)})}}Ln.displayName="FrameworkContext";var Vn="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement;try{Vn&&(window.__reactRouterVersion="7.6.3")}catch(CT){}function Hn({basename:e,children:t,window:i}){let s=n.useRef();null==s.current&&(s.current=function(e={}){return function(e,t,n,i={}){let{window:s=document.defaultView,v5Compat:r=!1}=i,a=s.history,o="POP",l=null,c=h();function h(){return(a.state||{idx:null}).idx}function u(){o="POP";let e=h(),t=null==e?null:e-c;c=e,l&&l({action:o,location:p.location,delta:t})}function d(e){return function(e,t=!1){let n="http://localhost";"undefined"!=typeof window&&(n="null"!==window.location.origin?window.location.origin:window.location.href),wt(n,"No window.location.(origin|href) available to create URL");let i="string"==typeof e?e:Et(e);return i=i.replace(/ $/,"%20"),!t&&i.startsWith("//")&&(i=n+i),new URL(i,n)}(e)}null==c&&(c=0,a.replaceState({...a.state,idx:c},""));let p={get action(){return o},get location(){return e(s,a)},listen(e){if(l)throw new Error("A history only accepts one active listener");return s.addEventListener(bt,u),l=e,()=>{s.removeEventListener(bt,u),l=null}},createHref:e=>t(s,e),createURL:d,encodeLocation(e){let t=d(e);return{pathname:t.pathname,search:t.search,hash:t.hash}},push:function(e,t){o="PUSH";let i=Tt(p.location,e,t);n&&n(i,e),c=h()+1;let u=Mt(i,c),d=p.createHref(i);try{a.pushState(u,"",d)}catch(m){if(m instanceof DOMException&&"DataCloneError"===m.name)throw m;s.location.assign(d)}r&&l&&l({action:o,location:p.location,delta:1})},replace:function(e,t){o="REPLACE";let i=Tt(p.location,e,t);n&&n(i,e),c=h();let s=Mt(i,c),u=p.createHref(i);a.replaceState(s,"",u),r&&l&&l({action:o,location:p.location,delta:0})},go:e=>a.go(e)};return p}(function(e,t){let{pathname:n,search:i,hash:s}=e.location;return Tt("",{pathname:n,search:i,hash:s},t.state&&t.state.usr||null,t.state&&t.state.key||"default")},function(e,t){return"string"==typeof t?t:Et(t)},null,e)}({window:i,v5Compat:!0}));let r=s.current,[a,o]=n.useState({action:r.action,location:r.location}),l=n.useCallback(e=>{n.startTransition(()=>o(e))},[o]);return n.useLayoutEffect(()=>r.listen(l),[r,l]),n.createElement(Sn,{basename:e,children:t,location:a.location,navigationType:a.action,navigator:r})}var Wn=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Gn=n.forwardRef(function({onClick:e,discover:t="render",prefetch:i="none",relative:s,reloadDocument:r,replace:a,state:o,target:l,to:c,preventScrollReset:h,viewTransition:u,...d},p){let m,{basename:f}=n.useContext(tn),g="string"==typeof c&&Wn.test(c),v=!1;if("string"==typeof c&&g&&(m=c,Vn))try{let e=new URL(window.location.href),t=c.startsWith("//")?new URL(e.protocol+c):new URL(c),n=Vt(t.pathname,f);t.origin===e.origin&&null!=n?c=n+t.search+t.hash:v=!0}catch(CT){St(!1,`<Link to="${c}"> contains an invalid URL which will probably break when clicked - please update to a valid URL path.`)}let x=function(e,{relative:t}={}){wt(an(),"useHref() may be used only in the context of a <Router> component.");let{basename:i,navigator:s}=n.useContext(tn),{hash:r,pathname:a,search:o}=un(e,{relative:t}),l=a;return"/"!==i&&(l="/"===a?i:qt([i,a])),s.createHref({pathname:l,search:o,hash:r})}(c,{relative:s}),[y,_,b]=function(e,t){let i=n.useContext(Ln),[s,r]=n.useState(!1),[a,o]=n.useState(!1),{onFocus:l,onBlur:c,onMouseEnter:h,onMouseLeave:u,onTouchStart:d}=t,p=n.useRef(null);n.useEffect(()=>{if("render"===e&&o(!0),"viewport"===e){let e=new IntersectionObserver(e=>{e.forEach(e=>{o(e.isIntersecting)})},{threshold:.5});return p.current&&e.observe(p.current),()=>{e.disconnect()}}},[e]),n.useEffect(()=>{if(s){let e=setTimeout(()=>{o(!0)},100);return()=>{clearTimeout(e)}}},[s]);let m=()=>{r(!0)},f=()=>{r(!1),o(!1)};return i?"intent"!==e?[a,p,{}]:[a,p,{onFocus:Un(l,m),onBlur:Un(c,f),onMouseEnter:Un(h,m),onMouseLeave:Un(u,f),onTouchStart:Un(d,m)}]:[!1,p,{}]}(i,d),w=function(e,{target:t,replace:i,state:s,preventScrollReset:r,relative:a,viewTransition:o}={}){let l=hn(),c=on(),h=un(e,{relative:a});return n.useCallback(n=>{if(function(e,t){return!(0!==e.button||t&&"_self"!==t||function(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}(e))}(n,t)){n.preventDefault();let t=void 0!==i?i:Et(c)===Et(h);l(e,{replace:t,state:s,preventScrollReset:r,relative:a,viewTransition:o})}},[c,l,h,i,s,t,e,r,a,o])}(c,{replace:a,state:o,target:l,preventScrollReset:h,relative:s,viewTransition:u}),S=n.createElement("a",{...d,...b,href:m||x,onClick:v||r?e:function(t){e&&e(t),t.defaultPrevented||w(t)},ref:zn(p,_),target:l,"data-discover":g||"render"!==t?void 0:"true"});return y&&!g?n.createElement(n.Fragment,null,S,n.createElement(Fn,{page:x})):S});function qn(e){let t=n.useContext(Jt);return wt(t,function(e){return`${e} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}(e)),t}Gn.displayName="Link",n.forwardRef(function({"aria-current":e="page",caseSensitive:t=!1,className:i="",end:s=!1,style:r,to:a,viewTransition:o,children:l,...c},h){let u=un(a,{relative:c.relative}),d=on(),p=n.useContext(Qt),{navigator:m,basename:f}=n.useContext(tn),g=null!=p&&function(e,t={}){let i=n.useContext(en);wt(null!=i,"`useViewTransitionState` must be used within `react-router-dom`'s `RouterProvider`.  Did you accidentally import `RouterProvider` from `react-router`?");let{basename:s}=qn("useViewTransitionState"),r=un(e,{relative:t.relative});if(!i.isTransitioning)return!1;let a=Vt(i.currentLocation.pathname,s)||i.currentLocation.pathname,o=Vt(i.nextLocation.pathname,s)||i.nextLocation.pathname;return null!=Bt(r.pathname,o)||null!=Bt(r.pathname,a)}(u)&&!0===o,v=m.encodeLocation?m.encodeLocation(u).pathname:u.pathname,x=d.pathname,y=p&&p.navigation&&p.navigation.location?p.navigation.location.pathname:null;t||(x=x.toLowerCase(),y=y?y.toLowerCase():null,v=v.toLowerCase()),y&&f&&(y=Vt(y,f)||y);const _="/"!==v&&v.endsWith("/")?v.length-1:v.length;let b,w=x===v||!s&&x.startsWith(v)&&"/"===x.charAt(_),S=null!=y&&(y===v||!s&&y.startsWith(v)&&"/"===y.charAt(v.length)),M={isActive:w,isPending:S,isTransitioning:g},T=w?e:void 0;b="function"==typeof i?i(M):[i,w?"active":null,S?"pending":null,g?"transitioning":null].filter(Boolean).join(" ");let E="function"==typeof r?r(M):r;return n.createElement(Gn,{...c,"aria-current":T,className:b,ref:h,style:E,to:a,viewTransition:o},"function"==typeof l?l(M):l)}).displayName="NavLink",n.forwardRef(({discover:e="render",fetcherKey:t,navigate:i,reloadDocument:s,replace:r,state:a,method:o=En,action:l,onSubmit:c,relative:h,preventScrollReset:u,viewTransition:d,...p},m)=>{let f=function(){let{router:e}=qn("useSubmit"),{basename:t}=n.useContext(tn),i=xn("useRouteId");return n.useCallback(async(n,s={})=>{let{action:r,method:a,encType:o,formData:l,body:c}=function(e,t){let n,i,s,r,a;if(An(o=e)&&"form"===o.tagName.toLowerCase()){let a=e.getAttribute("action");i=a?Vt(a,t):null,n=e.getAttribute("method")||En,s=Pn(e.getAttribute("enctype"))||Cn,r=new FormData(e)}else if(function(e){return An(e)&&"button"===e.tagName.toLowerCase()}(e)||function(e){return An(e)&&"input"===e.tagName.toLowerCase()}(e)&&("submit"===e.type||"image"===e.type)){let a=e.form;if(null==a)throw new Error('Cannot submit a <button> or <input type="submit"> without a <form>');let o=e.getAttribute("formaction")||a.getAttribute("action");if(i=o?Vt(o,t):null,n=e.getAttribute("formmethod")||a.getAttribute("method")||En,s=Pn(e.getAttribute("formenctype"))||Pn(a.getAttribute("enctype"))||Cn,r=new FormData(a,e),!function(){if(null===Nn)try{new FormData(document.createElement("form"),0),Nn=!1}catch(CT){Nn=!0}return Nn}()){let{name:t,type:n,value:i}=e;if("image"===n){let e=t?`${t}.`:"";r.append(`${e}x`,"0"),r.append(`${e}y`,"0")}else t&&r.append(t,i)}}else{if(An(e))throw new Error('Cannot submit element that is not <form>, <button>, or <input type="submit|image">');n=En,i=null,s=Cn,a=e}var o;return r&&"text/plain"===s&&(a=r,r=void 0),{action:i,method:n.toLowerCase(),encType:s,formData:r,body:a}}(n,t);if(!1===s.navigate){let t=s.fetcherKey||Yn();await e.fetch(t,i,s.action||r,{preventScrollReset:s.preventScrollReset,formData:l,body:c,formMethod:s.method||a,formEncType:s.encType||o,flushSync:s.flushSync})}else await e.navigate(s.action||r,{preventScrollReset:s.preventScrollReset,formData:l,body:c,formMethod:s.method||a,formEncType:s.encType||o,replace:s.replace,state:s.state,fromRouteId:i,flushSync:s.flushSync,viewTransition:s.viewTransition})},[e,t,i])}(),g=function(e,{relative:t}={}){let{basename:i}=n.useContext(tn),s=n.useContext(sn);wt(s,"useFormAction must be used inside a RouteContext");let[r]=s.matches.slice(-1),a={...un(e||".",{relative:t})},o=on();if(null==e){a.search=o.search;let e=new URLSearchParams(a.search),t=e.getAll("index");if(t.some(e=>""===e)){e.delete("index"),t.filter(e=>e).forEach(t=>e.append("index",t));let n=e.toString();a.search=n?`?${n}`:""}}return e&&"."!==e||!r.route.index||(a.search=a.search?a.search.replace(/^\?/,"?index&"):"?index"),"/"!==i&&(a.pathname="/"===a.pathname?i:qt([i,a.pathname])),Et(a)}(l,{relative:h}),v="get"===o.toLowerCase()?"get":"post",x="string"==typeof l&&Wn.test(l);return n.createElement("form",{ref:m,method:v,action:g,onSubmit:s?c:e=>{if(c&&c(e),e.defaultPrevented)return;e.preventDefault();let n=e.nativeEvent.submitter,s=(null==n?void 0:n.getAttribute("formmethod"))||o;f(n||e.currentTarget,{fetcherKey:t,method:s,navigate:i,replace:r,state:a,relative:h,preventScrollReset:u,viewTransition:d})},...p,"data-discover":x||"render"!==e?void 0:"true"})}).displayName="Form";var Xn=0,Yn=()=>`__${String(++Xn)}__`;const $n=g({apiKey:"AIzaSyAVJvau3Hit06q1pNYCTOF-pVuutmk4oNQ",authDomain:"mythseekers-rpg.firebaseapp.com",databaseURL:"https://mythseekers-rpg-default-rtdb.firebaseio.com",projectId:"mythseekers-rpg",storageBucket:"mythseekers-rpg.firebasestorage.app",messagingSenderId:"659018227506",appId:"1:659018227506:web:82425e7adaf80c2e3c412b",measurementId:"G-E3T1V81ZX3"}),Zn=o($n),Kn=j($n);q($n);const Jn=new class{constructor(){t(this,"listeners",{})}async signInWithGoogle(){var e,t;try{const i=new l;i.setCustomParameters({prompt:"select_account"}),i.addScope("profile"),i.addScope("email");try{const e=await c(Zn,i);await this.getUserProfile(e.user.uid)||await this.createUserProfile(e.user)}catch(n){if("auth/popup-blocked"!==n.code&&"auth/popup-closed-by-user"!==n.code&&!(null==(e=n.message)?void 0:e.includes("Cross-Origin-Opener-Policy"))&&!(null==(t=n.message)?void 0:t.includes("window.closed")))throw n;await h(Zn,i)}}catch(i){throw i}}async handleRedirectSignIn(){try{const e=await u(Zn);if(e){const t=e.user;return await this.getUserProfile(t.uid)||await this.createUserProfile(t),t}return null}catch(e){return null}}async signOut(){await d(Zn)}onAuthStateChange(e){return p(Zn,e)}getCurrentUser(){return Zn.currentUser}async createUserProfile(e){try{const t={uid:e.uid,displayName:e.displayName||"Adventurer",email:e.email||"",photoURL:e.photoURL||"",createdAt:Date.now(),lastSeen:Date.now(),totalPlayTime:0,campaignsHosted:0,campaignsJoined:0};await D(k(Kn,"users",e.uid),t)}catch(t){throw t}}async getUserProfile(e){try{const t=k(Kn,"users",e),n=await L(t);return n.exists()?n.data():null}catch(t){return null}}async updateUserLastSeen(e){const t=k(Kn,"users",e);await O(t,{lastSeen:Date.now()})}async saveCharacter(e){if(!this.getCurrentUser())throw new Error("User not authenticated");if(!Kn)throw new Error("Firebase not initialized");const t={...e,lastPlayed:Date.now()};try{if(e.id){const n=k(Kn,"characters",e.id);return await O(n,t),e.id}return(await U(F(Kn,"characters"),t)).id}catch(n){throw n}}async getUserCharacters(e){const t=B(F(Kn,"characters"),z("userId","==",e));return(await V(t)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>t.lastPlayed-e.lastPlayed)}async getUserCampaigns(e){const t=B(F(Kn,"games"),z("hostId","==",e));return(await V(t)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>t.lastActivity-e.lastActivity)}async getCharacter(e){const t=k(Kn,"characters",e),n=await L(t);return n.exists()?{id:n.id,...n.data()}:null}async createGameSession(e){const t=this.generateGameCode(),n=this.getCurrentUser();if(!n)throw new Error("User must be authenticated");const i={code:t,theme:e.theme||"Classic Fantasy",background:e.background||"fantasy",hostId:n.uid,players:e.players||[],messages:e.messages||[],started:!1,customPrompt:e.customPrompt||"",maxPlayers:e.maxPlayers||6,createdAt:Date.now(),lastActivity:Date.now()},s=await U(F(Kn,"games"),i);return await this.updateUserStats(n.uid,{campaignsHosted:1}),{gameId:s.id,code:t}}async joinGameSession(e,t){const n=this.getCurrentUser();if(!n)throw new Error("User must be authenticated");const i=B(F(Kn,"games"),z("code","==",e),z("started","==",!1)),s=await V(i);if(s.empty)throw new Error("Game not found or already started");const r=s.docs[0],a=r.data();if(a.players.length>=a.maxPlayers)throw new Error("Game is full");if(a.players.find(e=>e.id===n.uid))throw new Error("Player already in game");const o=await this.getCharacter(t);if(!o)throw new Error("Character not found");const l={id:n.uid,name:o.name,characterId:t,isHost:!1,isOnline:!0,lastSeen:Date.now()};return await O(k(Kn,"games",r.id),{players:H(l),lastActivity:Date.now()}),await this.updateUserStats(n.uid,{campaignsJoined:1}),{gameId:r.id,gameData:{...a,players:[...a.players,l]}}}async leaveGameSession(e){const t=this.getCurrentUser();if(!t)throw new Error("User must be authenticated");const n=k(Kn,"games",e),i=await L(n);if(!i.exists())throw new Error("Game not found");const s=i.data().players.filter(e=>e.id!==t.uid);0===s.length?await W(n):await O(n,{players:s,lastActivity:Date.now()})}async startGameSession(e){const t=this.getCurrentUser();if(!t)throw new Error("User must be authenticated");const n=k(Kn,"games",e),i=await L(n);if(!i.exists())throw new Error("Game not found");if(i.data().hostId!==t.uid)throw new Error("Only host can start the game");await O(n,{started:!0,lastActivity:Date.now()})}onGameUpdate(e,t){const n=k(Kn,"games",e),i=G(n,e=>{if(e.exists()){const n={id:e.id,...e.data()};t(n)}});return this.listeners[e]=i,i}async sendMessage(e,t){if(!this.getCurrentUser())throw new Error("User must be authenticated");const n={...t,id:`msg-${Date.now()}`,timestamp:Date.now()},i=k(Kn,"games",e);await O(i,{messages:H(n),lastActivity:Date.now()})}async saveGameProgress(e,t,n){const i=this.getCurrentUser();if(!i)throw new Error("User must be authenticated");const s=k(Kn,"characters",t);await O(s,{...n,lastPlayed:Date.now()}),await this.updateUserStats(i.uid,{totalPlayTime:n.playTime||0})}async completeCampaign(e,t){try{if(!Zn.currentUser)throw new Error("User not authenticated");const{httpsCallable:n}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),{getFunctions:i}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),s=n(i($n),"completeCampaign");await s({gameId:e,campaignData:t})}catch(n){throw n}}async startCombat(e){try{if(!Zn.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),{getFunctions:n}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),i=t(n($n),"startCombat");return{success:!0,combatState:(await i(e)).data}}catch(t){return{success:!1,error:t.message}}}async getCombatState(e){try{if(!Zn.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),{getFunctions:n}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),i=t(n($n),"getCombatState");return{success:!0,combatState:(await i({combatId:e})).data}}catch(t){return{success:!1,error:t.message}}}async resolveCombatAction(e){try{if(!Zn.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),{getFunctions:n}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),i=t(n($n),"resolveCombatAction");return{success:!0,combatState:(await i(e)).data}}catch(t){return{success:!1,error:t.message}}}async endCombat(e){try{if(!Zn.currentUser)throw new Error("User not authenticated");const{httpsCallable:t}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),{getFunctions:n}=await ht(()=>import("./firebase-functions-7c25f05b.js"),["assets/firebase-functions-7c25f05b.js","assets/firebase-core-a7cb50f5.js"]),i=t(n($n),"endCombat");return await i(e),{success:!0}}catch(t){return{success:!1,error:t.message}}}async updateUserStats(e,t){const n=k(Kn,"users",e);await O(n,t)}async getUserAchievements(e){try{const t=F(Kn,"achievements"),n=B(t,z("userId","==",e)),i=await V(n),s=[];return i.forEach(e=>{s.push({id:e.id,...e.data()})}),s}catch(t){return[]}}async getPlayerStats(e){try{const t=await this.getUserProfile(e);if(!t)return{totalPlayTime:0,campaignsHosted:0,campaignsJoined:0,charactersCreated:0,totalXP:0,combatWins:0,questsCompleted:0,npcsInteracted:0,locationsDiscovered:0,achievementsUnlocked:0,lastActive:new Date,joinDate:new Date};const n=await this.getUserCharacters(e),i=await this.getUserAchievements(e);return{totalPlayTime:t.totalPlayTime||0,campaignsHosted:t.campaignsHosted||0,campaignsJoined:t.campaignsJoined||0,charactersCreated:n.length,totalXP:n.reduce((e,t)=>e+(t.experience||0),0),combatWins:0,questsCompleted:0,npcsInteracted:0,locationsDiscovered:0,achievementsUnlocked:i.length,lastActive:new Date(t.lastSeen),joinDate:new Date(t.createdAt)}}catch(t){return{totalPlayTime:0,campaignsHosted:0,campaignsJoined:0,charactersCreated:0,totalXP:0,combatWins:0,questsCompleted:0,npcsInteracted:0,locationsDiscovered:0,achievementsUnlocked:0,lastActive:new Date,joinDate:new Date}}}generateGameCode(){let e="";for(let t=0;t<6;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(36*Math.random()));return e}cleanup(){Object.values(this.listeners).forEach(e=>e()),this.listeners={}}},Qn=()=>{const[e,t]=n.useState(null),[i,s]=n.useState(null),[r,a]=n.useState(!0),[o,l]=n.useState("overview"),[c,h]=n.useState([]),[u,d]=n.useState(null);n.useEffect(()=>Jn.onAuthStateChange(async e=>{if(t(e),a(!1),e)try{const t=await Jn.getUserProfile(e.uid);s(t),await p(e.uid)}catch(n){s(null)}else s(null)}),[]);const p=async e=>{try{const t=await Jn.getUserAchievements(e);h(t);const n=await Jn.getPlayerStats(e);d(n)}catch(t){}},m=e=>{const t=Math.floor(e/60),n=e%60;return t>24?`${Math.floor(t/24)}d ${t%24}h ${n}m`:`${t}h ${n}m`};if(r)return at.jsx("div",{className:"text-blue-200",children:"Loading..."});if(!e)return at.jsx("div",{className:"flex flex-col items-center space-y-2",children:at.jsx("button",{onClick:async()=>{a(!0);try{await Jn.signInWithGoogle()}catch(CT){alert("Login failed: "+CT)}a(!1)},className:"px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Sign in with Google"})});const f=(g=(null==u?void 0:u.totalXP)||0,Math.floor(g/1e3)+1);var g;const v=(x=f)>=20?{name:"Legendary Master",color:"text-purple-400",icon:"👑"}:x>=15?{name:"Epic Hero",color:"text-red-400",icon:"⚔️"}:x>=10?{name:"Veteran Adventurer",color:"text-orange-400",icon:"🛡️"}:x>=5?{name:"Skilled Warrior",color:"text-yellow-400",icon:"⚡"}:{name:"Novice Explorer",color:"text-green-400",icon:"🌱"};var x;return at.jsxs("div",{className:"flex flex-col h-full",children:[at.jsx("div",{className:"bg-gradient-to-r from-blue-900/50 to-purple-900/50 rounded-lg p-4 mb-4 border border-white/20",children:at.jsxs("div",{className:"flex items-center space-x-4",children:[at.jsx("img",{src:e.photoURL,alt:"avatar",className:"w-16 h-16 rounded-full border-2 border-blue-400"}),at.jsxs("div",{className:"flex-1",children:[at.jsx("div",{className:"text-white font-bold text-lg",children:e.displayName}),at.jsx("div",{className:"text-blue-200 text-sm",children:e.email}),at.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[at.jsx("span",{className:"text-2xl",children:v.icon}),at.jsx("span",{className:`font-semibold ${v.color}`,children:v.name}),at.jsxs("span",{className:"text-gray-300",children:["• Level ",f]})]})]}),at.jsx("button",{onClick:async()=>{a(!0);try{await Jn.signOut()}catch(CT){alert("Logout failed: "+CT)}a(!1)},className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"Sign out"})]})}),at.jsx("div",{className:"flex space-x-1 mb-4",children:[{key:"overview",label:"Overview",icon:at.jsx(ee,{size:16})},{key:"achievements",label:"Achievements",icon:at.jsx(te,{size:16})},{key:"stats",label:"Statistics",icon:at.jsx(ne,{size:16})},{key:"characters",label:"Characters",icon:at.jsx(ie,{size:16})}].map(e=>at.jsxs("button",{onClick:()=>l(e.key),className:"flex items-center space-x-2 px-4 py-2 rounded-lg transition-all "+(o===e.key?"bg-blue-600 text-white":"bg-white/10 text-blue-200 hover:bg-white/20"),children:[e.icon,at.jsx("span",{className:"hidden sm:inline",children:e.label})]},e.key))}),at.jsxs("div",{className:"flex-1 overflow-y-auto",children:["overview"===o&&at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[at.jsx(se,{className:"w-6 h-6 text-blue-400 mx-auto mb-2"}),at.jsx("div",{className:"text-white font-bold",children:m((null==u?void 0:u.totalPlayTime)||0)}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Play Time"})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[at.jsx(re,{className:"w-6 h-6 text-yellow-400 mx-auto mb-2"}),at.jsx("div",{className:"text-white font-bold",children:(null==u?void 0:u.achievementsUnlocked)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Achievements"})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[at.jsx(ie,{className:"w-6 h-6 text-green-400 mx-auto mb-2"}),at.jsx("div",{className:"text-white font-bold",children:(null==u?void 0:u.campaignsJoined)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Campaigns"})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 text-center border border-white/20",children:[at.jsx(ae,{className:"w-6 h-6 text-red-400 mx-auto mb-2"}),at.jsx("div",{className:"text-white font-bold",children:(null==u?void 0:u.questsCompleted)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Quests"})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Recent Activity"}),at.jsxs("div",{className:"space-y-2 text-sm",children:[at.jsxs("div",{className:"flex items-center space-x-3 text-blue-200",children:[at.jsx(oe,{size:16}),at.jsxs("span",{children:["Joined MythSeeker ",(null==u?void 0:u.joinDate)?new Date(u.joinDate).toLocaleDateString():"recently"]})]}),at.jsxs("div",{className:"flex items-center space-x-3 text-blue-200",children:[at.jsx(se,{size:16}),at.jsxs("span",{children:["Last active ",(null==u?void 0:u.lastActive)?new Date(u.lastActive).toLocaleDateString():"recently"]})]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Level Progress"}),at.jsxs("div",{className:"space-y-2",children:[at.jsxs("div",{className:"flex justify-between text-sm",children:[at.jsxs("span",{className:"text-blue-200",children:["Level ",f]}),at.jsxs("span",{className:"text-blue-200",children:["Level ",f+1]})]}),at.jsx("div",{className:"w-full bg-white/20 rounded-full h-2",children:at.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all",style:{width:((null==u?void 0:u.totalXP)||0)%1e3/10+"%"}})}),at.jsxs("div",{className:"text-center text-sm text-blue-200",children:[(null==u?void 0:u.totalXP)||0," / ",1e3*(f+1)," XP"]})]})]})]}),"achievements"===o&&at.jsx("div",{className:"space-y-4",children:at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[c.map(e=>at.jsx("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:at.jsxs("div",{className:"flex items-start space-x-3",children:[at.jsx("div",{className:"text-3xl",children:e.icon}),at.jsxs("div",{className:"flex-1",children:[at.jsx("h4",{className:"text-white font-medium",children:e.name}),at.jsx("p",{className:"text-gray-300 text-sm mb-2",children:e.description}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("span",{className:"text-xs text-yellow-400",children:["+",e.points," points"]}),at.jsx("span",{className:"text-xs text-gray-400",children:e.unlockedAt?new Date(e.unlockedAt).toLocaleDateString():"Unlocked"})]})]})]})},e.id)),0===c.length&&at.jsxs("div",{className:"col-span-full text-center py-8",children:[at.jsx(te,{size:48,className:"text-gray-400 mx-auto mb-4"}),at.jsx("p",{className:"text-gray-400",children:"No achievements unlocked yet"}),at.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Complete quests and challenges to earn achievements!"})]})]})}),"stats"===o&&at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[at.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center space-x-2",children:[at.jsx(le,{size:20,className:"text-red-400"}),at.jsx("span",{children:"Combat Statistics"})]}),at.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.combatWins)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Combat Wins"})]}),at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.totalXP)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Total XP"})]}),at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.charactersCreated)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Characters"})]}),at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.campaignsHosted)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Campaigns Hosted"})]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[at.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center space-x-2",children:[at.jsx(ae,{size:20,className:"text-green-400"}),at.jsx("span",{children:"Exploration Statistics"})]}),at.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.questsCompleted)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Quests Completed"})]}),at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.locationsDiscovered)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Locations Found"})]}),at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-white font-bold text-xl",children:(null==u?void 0:u.npcsInteracted)||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"NPCs Met"})]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[at.jsxs("h3",{className:"text-lg font-semibold text-white mb-3 flex items-center space-x-2",children:[at.jsx(se,{size:20,className:"text-blue-400"}),at.jsx("span",{children:"Time Statistics"})]}),at.jsxs("div",{className:"space-y-2 text-sm",children:[at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-blue-200",children:"Total Play Time:"}),at.jsx("span",{className:"text-white",children:m((null==u?void 0:u.totalPlayTime)||0)})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-blue-200",children:"Average Session:"}),at.jsx("span",{className:"text-white",children:(null==u?void 0:u.campaignsJoined)?m(Math.floor((u.totalPlayTime||0)/u.campaignsJoined)):"0m"})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-blue-200",children:"Member Since:"}),at.jsx("span",{className:"text-white",children:(null==u?void 0:u.joinDate)?new Date(u.joinDate).toLocaleDateString():"Recently"})]})]})]})]}),"characters"===o&&at.jsx("div",{className:"space-y-4",children:at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 border border-white/20",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-3",children:"Character Gallery"}),at.jsx("p",{className:"text-blue-200 text-sm mb-4",children:"Your created characters and their achievements will appear here."}),at.jsxs("div",{className:"text-center py-8",children:[at.jsx(ie,{size:48,className:"text-gray-400 mx-auto mb-4"}),at.jsx("p",{className:"text-gray-400",children:"Character management coming soon!"}),at.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Create characters to see them here"})]})]})})]})]})},ei=g({apiKey:"AIzaSyAVJvau3Hit06q1pNYCTOF-pVuutmk4oNQ",authDomain:"mythseekers-rpg.firebaseapp.com",databaseURL:"https://mythseekers-rpg-default-rtdb.firebaseio.com",projectId:"mythseekers-rpg",storageBucket:"mythseekers-rpg.firebasestorage.app",messagingSenderId:"659018227506",appId:"1:659018227506:web:82425e7adaf80c2e3c412b",measurementId:"G-E3T1V81ZX3"}),ti=q(ei),ni=$e(ei);o(ei);const ii=new class{constructor(){t(this,"aiDungeonMaster",Ze(ni,"aiDungeonMaster"))}async complete(e,t){var n,i;try{if(!t||!t.isMultiplayer)return await new Promise(e=>setTimeout(e,1e3+2e3*Math.random())),this.generateLocalResponse(e);const r=new Promise((e,t)=>{setTimeout(()=>{t(new Error("Firebase function timeout"))},15e3)}),a=this.aiDungeonMaster({prompt:e,campaignId:t.id,playerName:(null==(i=null==(n=t.players)?void 0:n[0])?void 0:i.name)||t.playerName||"Player"});try{return(await Promise.race([a,r])).data}catch(s){return await new Promise(e=>setTimeout(e,1e3+2e3*Math.random())),this.generateLocalResponse(e)}}catch(r){return JSON.stringify(this.generateFallbackResponse())}}generateLocalResponse(e){try{const t=this.parsePromptContext(e),n=e.includes("INITIAL SCENE REQUIREMENTS")?this.generateInitialScene(t):this.generateDynamicResponse(t);return JSON.stringify(n)}catch(t){return JSON.stringify(this.generateFallbackResponse())}}parsePromptContext(e){const t=e.match(/Player Level: (\d+) ([^,\n]+)/),n=e.match(/Player Stats: STR (\d+), DEX (\d+), INT (\d+), CHA (\d+)/),i=e.match(/Location: ([^\n]+)/),s=e.match(/Time: ([^\n]+)/),r=e.match(/Weather: ([^\n]+)/),a=e.match(/\*\*PLAYER INPUT:\*\* "([^"]+)"/),o=a?a[1]:"",l=e.match(/for a ([^ ]+) campaign/),c=l?l[1]:"fantasy",h=e.match(/\*\*CUSTOM CAMPAIGN PROMPT:\*\*\n([^*]+?)(?=\*\*|$)/),u=h?h[1].trim():"";return{character:{level:t?parseInt(t[1]):1,class:t?t[2]:"Adventurer",stats:n?{strength:parseInt(n[1]),dexterity:parseInt(n[2]),intelligence:parseInt(n[3]),charisma:parseInt(n[4])}:{strength:10,dexterity:10,intelligence:10,charisma:10}},worldState:{location:i?i[1].trim():"unknown",time:s?s[1].trim():"day",weather:r?r[1].trim():"clear"},playerInput:o,theme:c,customPrompt:u}}generateInitialScene(e){const{character:t,worldState:n,theme:i,customPrompt:s}=e,r=this.generateLocation(n.location,i),a=this.generateNPC(t,i),o=this.generateConflict(i,s),l=[`You find yourself in ${r.name}, where ${r.atmosphere}. ${a.name}, a ${a.role.toLowerCase()}, approaches you with ${a.mood} in their eyes. "${a.greeting}" they say, their voice ${a.voice}.`,`As you enter ${r.name}, ${r.description}. ${a.name} spots you and immediately makes their way over. "${a.greeting}" they ${a.action}, their ${a.personality} nature evident in every gesture.`,`${r.name} ${r.activity}. ${a.name} rushes toward you, their face ${a.expression}. "${a.greeting}" they ${a.action}, clearly ${a.motivation}.`],c=[`Accept ${a.name}'s request and ask for details`,"Express skepticism and demand more information",`Ask about the local situation and ${a.name}'s background`,"Request to see the area and gather your own intelligence"];return{narrative:l[Math.floor(Math.random()*l.length)],choices:c,environment:r.id,worldStateUpdates:{newLocation:r.id,newNPCs:[{name:a.name,role:a.role,personality:a.personality,currentMood:a.mood,currentAction:a.action}],consequences:[{type:"immediate",description:`You've been approached by ${a.name} about ${o.name}`,affectedAreas:[r.id]}]},atmosphere:{mood:r.mood,tension:"medium",environmentalDetails:r.details}}}generateDynamicResponse(e){const{character:t,worldState:n,playerInput:i,theme:s}=e,r=i.toLowerCase();return this.isCombatAction(r)?this.generateCombatResponse(e):this.isExplorationAction(r)?this.generateExplorationResponse(e):this.isSocialAction(r)?this.generateSocialResponse(e):this.isRestAction(r)?this.generateRestResponse(e):this.generateGeneralResponse(e)}isCombatAction(e){return["attack","fight","combat","battle","strike","slash","stab","shoot","cast","spell"].some(t=>e.includes(t))}isExplorationAction(e){return["explore","search","investigate","examine","look","check","find","discover"].some(t=>e.includes(t))}isSocialAction(e){return["talk","ask","tell","speak","negotiate","persuade","intimidate","charm","say","reply","respond","answer","question","stare","look","glance","nod","shake","smile","frown","laugh","cry","whisper","shout","greet","introduce","meet","converse","discuss","debate","argue","agree","disagree","accept","refuse","promise","threaten","warn","advise","suggest","propose","offer","request","demand","beg","apologize","thank","congratulate","comfort","encourage","scold"].some(t=>e.includes(t))}isRestAction(e){return["rest","sleep","heal","recover","meditate","camp"].some(t=>e.includes(t))}generateCombatResponse(e){const{character:t,worldState:n,theme:i}=e,s=this.generateEnemies(i,t.level,n.location),r=[`The tension erupts into violence! ${s.length>1?"Your enemies":"Your enemy"} ${s.length>1?"surround":"positions"} you, weapons drawn and eyes filled with determination. The ${t.class.toLowerCase()} in you recognizes this moment - it's time to prove your worth in battle.`,`Suddenly, ${s.length>1?"multiple figures":"a figure"} emerges from the shadows, ${s.length,"their"} intentions clear. Your ${t.class.toLowerCase()} instincts kick in as you prepare for combat.`,`The air crackles with anticipation as ${s.length>1?"your opponents":"your opponent"} ${s.length>1?"take":"takes"} up ${s.length,"their"} fighting stance. Your ${t.class.toLowerCase()} training prepares you for what comes next.`];return{narrative:r[Math.floor(Math.random()*r.length)],choices:["Engage in tactical combat using your class abilities","Attempt to intimidate or bluff your way out","Look for tactical advantages in the environment","Call for reinforcements or help"],combatEncounter:{active:!0,enemies:s},atmosphere:{mood:"tense",tension:"high",environmentalDetails:"The air is thick with the promise of violence and the sound of steel being drawn"}}}generateEnemies(e,t,n){var i;const s={fantasy:{tavern:["Drunken Brawler","Thief","Mercenary"],forest:["Bandit","Wolf","Goblin Scout"],dungeon:["Skeleton","Goblin Warrior","Dark Elf"],city:["City Guard","Thug","Assassin"]},scifi:{tavern:["Rogue Android","Space Pirate","Mutant"],forest:["Alien Scout","Rogue Drone","Wild Creature"],dungeon:["Security Bot","Alien Warrior","Mutant Beast"],city:["Security Officer","Gang Member","Rogue AI"]},horror:{tavern:["Cursed Patron","Shadow Creature","Undead"],forest:["Dark Entity","Cursed Beast","Shadow Walker"],dungeon:["Undead Warrior","Dark Spirit","Cursed Guardian"],city:["Corrupted Citizen","Shadow Stalker","Dark Entity"]}},r=(null==(i=s[e])?void 0:i[n])||s.fantasy.tavern,a=Math.min(t,3);return Array.from({length:a},(e,n)=>({name:r[n%r.length],health:20+5*t+Math.floor(10*Math.random()),attack:3+t+Math.floor(3*Math.random()),strength:12+Math.floor(6*Math.random()),dexterity:10+Math.floor(6*Math.random()),intelligence:8+Math.floor(6*Math.random()),armorClass:12+Math.floor(4*Math.random())}))}generateExplorationResponse(e){const{character:t,worldState:n,theme:i}=e,s=["You discover ancient markings that seem to tell a story of the area's history","A hidden passage reveals itself behind a loose stone, leading to unknown depths","You find evidence of recent activity - footprints, disturbed earth, or discarded items","The environment reveals subtle clues about what happened here recently","Your investigation uncovers a hidden cache or secret compartment","You notice environmental details that others might have missed"],r=[`Your careful investigation pays off! ${s[Math.floor(Math.random()*s.length)]}. Your ${t.class.toLowerCase()} instincts tell you this could be important.`,`Your ${t.class.toLowerCase()} training guides your search. ${s[Math.floor(Math.random()*s.length)]}, and you sense this discovery could change everything.`,`Your methodical approach reveals secrets others might miss. ${s[Math.floor(Math.random()*s.length)]}, and your ${t.class.toLowerCase()} experience helps you understand its significance.`];return{narrative:r[Math.floor(Math.random()*r.length)],choices:["Examine the discovery more closely for additional details","Document your findings and search for related clues","Investigate the surrounding area for more context","Report your discovery to relevant NPCs or allies"],atmosphere:{mood:"curious",tension:"low",environmentalDetails:"The area reveals its secrets to your careful observation and expertise"}}}generateSocialResponse(e){const{character:t,playerInput:n}=e,i=n.toLowerCase();if(i.includes("how dire")||i.includes("serious")||i.includes("dangerous"))return{narrative:`Captain Thorne's expression darkens as they lean in closer, their voice dropping to a grave whisper. "More dire than you can imagine. The ancient seals are weakening, and if they break completely, the entire region will be overrun. We've already lost three villages to the north. I need someone with your ${t.class.toLowerCase()} skills to help us investigate the source before it's too late."`,choices:["Accept the mission and ask for more details about the ancient seals","Request proof of the threat before committing","Ask about the rewards and support you'll receive","Decline politely, citing other pressing matters"],atmosphere:{mood:"urgent",tension:"high",environmentalDetails:"The tavern seems to grow quieter as Captain Thorne speaks, as if the very air holds its breath"}};if(i.includes("stare")||i.includes("look")||i.includes("glance"))return{narrative:`Your ${t.class.toLowerCase()} instincts tell you that Captain Thorne is genuine in their concern. Their weathered face shows the strain of someone who has seen too much, and their eyes carry the weight of responsibility. "I can see you're assessing the situation," they say, nodding approvingly. "That's exactly the kind of careful thinking we need right now."`,choices:["Ask about their military background and experience","Inquire about the specific nature of the threat","Request to see any evidence or reports they have","Ask about the political situation and who else is involved"],atmosphere:{mood:"respectful",tension:"medium",environmentalDetails:"The firelight casts dancing shadows that seem to emphasize the gravity of the situation"}};if(i.includes("why me")||i.includes("choose")||i.includes("select"))return{narrative:`"Why you?" Captain Thorne chuckles, but there's no humor in it. "I've been watching you since you walked in. The way you carry yourself, the way you observe your surroundings - you have the bearing of someone who knows how to handle themselves in dangerous situations. Plus, your ${t.class.toLowerCase()} background gives you skills we desperately need right now."`,choices:["Ask about what specific skills they think you can offer","Inquire about other potential allies or resources","Request more information about the mission parameters","Ask about the risks and potential consequences"],atmosphere:{mood:"analytical",tension:"medium",environmentalDetails:"The captain's assessment seems to carry the weight of experience and the urgency of someone who has seen too much"}};const s=[`Your diplomatic approach opens new possibilities. The person you're speaking with seems to respond well to your ${t.class.toLowerCase()} manner and ${t.stats.charisma>=14?"natural charisma":"earnest approach"}. They share information that could prove valuable.`,`Your ${t.class.toLowerCase()} background helps you connect with the person. They seem to trust your ${t.stats.charisma>=14?"charming":"honest"} nature and share insights about the local situation.`,`Your conversation reveals unexpected depths. Your ${t.class.toLowerCase()} experience and ${t.stats.intelligence>=14?"sharp mind":"practical knowledge"} help you understand the nuances of what they're telling you.`];return{narrative:s[Math.floor(Math.random()*s.length)],choices:["Ask for more specific details about their concerns","Offer assistance in return for their help","Request an introduction to other important people","Thank them and use this information strategically"],atmosphere:{mood:"cooperative",tension:"low",environmentalDetails:"The conversation creates a more relaxed and open atmosphere"}}}generateRestResponse(e){const{character:t,worldState:n}=e,i=[`You take a moment to rest and recover. The ${t.class.toLowerCase()} in you knows the value of preparation and recuperation. You feel your strength returning and your mind clearing.`,`Your ${t.class.toLowerCase()} training emphasizes the importance of rest. As you take this time to recover, you feel your energy returning and your focus sharpening.`,`The ${t.class.toLowerCase()} way teaches patience and preparation. This rest allows you to recover your strength and plan your next move with renewed clarity.`];return{narrative:i[Math.floor(Math.random()*i.length)],choices:["Continue resting to fully recover your strength","Use this time to plan your next move carefully","Check your equipment and supplies while resting","Resume your journey with renewed energy"],characterUpdates:[{playerId:"current",xpGain:5,xpReason:"Wise use of rest time and strategic thinking",statChanges:{health:10,mana:5}}],atmosphere:{mood:"peaceful",tension:"low",environmentalDetails:"The area provides a safe haven for rest and recovery"}}}generateGeneralResponse(e){const{character:t,worldState:n,theme:i,recentActions:s}=e,r=[`Your actions have consequences in this ${i} world. The story continues to unfold based on your choices, and your ${t.class.toLowerCase()} skills and level ${t.level} experience guide your path forward.`,`The world responds to your presence and actions. Your ${t.class.toLowerCase()} background and recent decisions shape how events unfold around you.`,`Your ${t.class.toLowerCase()} instincts serve you well as you navigate this situation. Your level ${t.level} experience and recent actions influence the world's response to your presence.`];return{narrative:r[Math.floor(Math.random()*r.length)],choices:["Continue with your current approach and see where it leads","Try a different strategy based on what you've learned","Seek advice from others who might have relevant experience","Take time to reflect on your options and their implications"],atmosphere:{mood:"neutral",tension:"low",environmentalDetails:"The world responds to your presence and actions in subtle ways"}}}generateLocation(e,t){const n={tavern:{fantasy:{name:"The Prancing Pony Tavern",atmosphere:"warm firelight dances across weathered faces",description:"bustles with activity and the sound of laughter",activity:"hums with the energy of travelers and locals",mood:"cozy",details:"The air is thick with the scent of ale and wood smoke"},scifi:{name:"The Stellar Lounge",atmosphere:"neon lights pulse to the rhythm of distant engines",description:"buzzes with the energy of space travelers",activity:"vibrates with the hum of technology and conversation",mood:"futuristic",details:"The air hums with the subtle energy of advanced life support systems"},horror:{name:"The Shadowed Inn",atmosphere:"flickering candles cast dancing shadows on the walls",description:"echoes with whispered conversations",activity:"pulses with an uneasy energy",mood:"foreboding",details:"The air is thick with the scent of old wood and something else, something older"},urban:{name:"The Midnight Bar",atmosphere:"dim lighting creates intimate corners for private conversations",description:"buzzes with the energy of city nightlife",activity:"throbs with the pulse of urban life",mood:"mysterious",details:"The air carries the mingled scents of coffee, alcohol, and urban mystery"},apocalypse:{name:"The Last Stop",atmosphere:"makeshift barricades and dim emergency lighting",description:"echoes with the sounds of survivors sharing stories",activity:"hums with the quiet desperation of those who remain",mood:"grim",details:"The air is thick with the scent of survival and the weight of lost civilization"},pirate:{name:"The Salty Dog",atmosphere:"lanterns swing gently with the rhythm of the sea",description:"roars with the laughter of sailors and adventurers",activity:"bustles with tales of treasure and adventure",mood:"adventurous",details:"The air carries the salty tang of the ocean and the promise of fortune"}},forest:{fantasy:{name:"The Enchanted Grove",atmosphere:"ancient trees whisper secrets to the wind",description:"shimmers with magical energy and natural beauty",activity:"pulses with the life force of the forest",mood:"mystical",details:"The air is alive with the scent of earth, magic, and ancient wisdom"},scifi:{name:"The Bio-Dome Forest",atmosphere:"artificial sunlight filters through genetically enhanced foliage",description:"buzzes with the energy of engineered ecosystems",activity:"throbs with the pulse of controlled nature",mood:"synthetic",details:"The air carries the scent of purified oxygen and technological harmony"},horror:{name:"The Twisted Woods",atmosphere:"malformed trees reach like skeletal fingers toward the sky",description:"echoes with unnatural sounds and distant screams",activity:"pulses with dark energy and malevolent presence",mood:"terrifying",details:"The air is thick with the scent of decay and something far worse"}},dungeon:{fantasy:{name:"The Ancient Crypts",atmosphere:"torchlight flickers against ancient stone walls",description:"echoes with the whispers of forgotten souls",activity:"pulses with the energy of ancient magic",mood:"mysterious",details:"The air is thick with the dust of ages and the weight of history"},scifi:{name:"The Abandoned Facility",atmosphere:"emergency lighting casts eerie shadows on metal walls",description:"buzzes with the remnants of advanced technology",activity:"throbs with the pulse of malfunctioning systems",mood:"technological",details:"The air hums with the energy of dormant machines and lost knowledge"},horror:{name:"The Cursed Catacombs",atmosphere:"darkness seems to swallow the light whole",description:"echoes with the sounds of things that should not exist",activity:"pulses with malevolent energy and dark magic",mood:"horrifying",details:"The air is thick with the scent of death and the presence of evil"}},city:{fantasy:{name:"The Grand Bazaar",atmosphere:"colorful stalls and the sounds of commerce fill the air",description:"bustles with merchants, travelers, and city life",activity:"hums with the energy of trade and opportunity",mood:"lively",details:"The air carries the scent of spices, goods, and the promise of fortune"},scifi:{name:"The Mega-City District",atmosphere:"neon lights and holographic advertisements create a dazzling display",description:"buzzes with the energy of advanced civilization",activity:"throbs with the pulse of technological progress",mood:"futuristic",details:"The air hums with the energy of countless machines and digital life"},horror:{name:"The Forgotten Quarter",atmosphere:"abandoned buildings and broken streetlights create an eerie silence",description:"echoes with the sounds of things that lurk in the shadows",activity:"pulses with the energy of fear and desperation",mood:"terrifying",details:"The air is thick with the scent of decay and the weight of forgotten lives"},urban:{name:"The Midnight Bar",atmosphere:"dim lighting creates intimate corners for private conversations",description:"buzzes with the energy of city nightlife",activity:"throbs with the pulse of urban life",mood:"mysterious",details:"The air carries the mingled scents of coffee, alcohol, and urban mystery"},apocalypse:{name:"The Last Stop",atmosphere:"makeshift barricades and dim emergency lighting",description:"echoes with the sounds of survivors sharing stories",activity:"hums with the quiet desperation of those who remain",mood:"grim",details:"The air is thick with the scent of survival and the weight of lost civilization"},pirate:{name:"The Salty Dog",atmosphere:"lanterns swing gently with the rhythm of the sea",description:"roars with the laughter of sailors and adventurers",activity:"bustles with tales of treasure and adventure",mood:"adventurous",details:"The air carries the salty tang of the ocean and the promise of fortune"}}},i=n[e];return{...(null==i?void 0:i[t])||n.tavern.fantasy,id:e}}generateNPC(e,t){const n={fantasy:[{name:"Eldric the Sage",role:"Wise Scholar",personality:"scholarly and contemplative",mood:"concerned wisdom",action:"approaches you thoughtfully",greeting:"I have been studying the ancient texts, and I believe I have found something that requires your attention",voice:"carries the weight of centuries of knowledge",expression:"lined with the wisdom of age",motivation:"desperate to share their discovery"},{name:"Captain Thorne",role:"Veteran Warrior",personality:"battle-hardened but honorable",mood:"urgent determination",action:"strides toward you with purpose",greeting:"We need someone with your skills. The situation is more dire than most realize",voice:"carries the authority of command",expression:"marked by years of conflict",motivation:"seeking a capable ally for a dangerous mission"},{name:"Lady Seraphina",role:"Noble Diplomat",personality:"graceful and politically savvy",mood:"calculated concern",action:"glides toward you with practiced elegance",greeting:"Your reputation precedes you. I believe we may be able to help each other in these troubled times",voice:"carries the refinement of noble breeding",expression:"shows the careful control of one used to court intrigue",motivation:"seeking a trustworthy agent for delicate matters"}],scifi:[{name:"Commander Nova",role:"AI Coordinator",personality:"logical and efficient",mood:"digital urgency",action:"approaches with calculated precision",greeting:"My sensors have detected an anomaly that requires immediate attention",voice:"carries the precision of advanced algorithms",expression:"displays subtle digital patterns",motivation:"programmed to seek assistance for critical situations"},{name:"Dr. Zara Chen",role:"Research Scientist",personality:"brilliant but socially awkward",mood:"scientific excitement mixed with concern",action:"approaches with the energy of one who has made a breakthrough",greeting:"You won't believe what I've discovered! But we need someone with your skills to investigate further",voice:"carries the enthusiasm of scientific discovery",expression:"shows the intensity of someone who has been working too long",motivation:"desperate to share their findings and get help"},{name:"Captain Vega",role:"Space Fleet Commander",personality:"disciplined and strategic",mood:"military urgency",action:"marches toward you with purpose",greeting:"We have a situation that requires immediate action. Your skills are exactly what we need",voice:"carries the authority of military command",expression:"shows the stress of someone carrying heavy responsibility",motivation:"seeking a capable operative for a critical mission"}],horror:[{name:"Father Marcus",role:"Local Priest",personality:"haunted but determined",mood:"desperate hope",action:"emerges from the shadows",greeting:"The darkness has returned, and we need someone who can face it",voice:"carries the weight of terrible knowledge",expression:"haunted by what they have seen",motivation:"seeking someone to help fight the darkness"},{name:"Dr. Sarah Blackwood",role:"Paranormal Investigator",personality:"obsessive and driven",mood:"frantic determination",action:"rushes toward you with barely contained energy",greeting:"I've been tracking this for months! The signs are all there, and now it's happening again",voice:"carries the intensity of someone who has seen too much",expression:"shows the strain of someone who hasn't slept in days",motivation:"desperate to stop the cycle of horror"},{name:"The Caretaker",role:"Groundskeeper",personality:"mysterious and knowing",mood:"ominous warning",action:"materializes from the darkness",greeting:"You shouldn't be here. But since you are, perhaps you can help with what's coming",voice:"carries the weight of ancient secrets",expression:"shows the wisdom of one who has seen generations pass",motivation:"seeking someone to break an ancient curse"}],urban:[{name:"Detective Mike Torres",role:"Homicide Detective",personality:"world-weary but determined",mood:"professional concern",action:"approaches with the practiced ease of a cop",greeting:"I've got a case that's got me stumped. I think you might be able to help",voice:"carries the gravel of too many late nights",expression:"shows the weariness of someone who has seen too much",motivation:"seeking help with an unsolvable case"},{name:"Madame Celeste",role:"Fortune Teller",personality:"mysterious and theatrical",mood:"prophetic urgency",action:"emerges from behind her curtain with dramatic flair",greeting:"The cards have been trying to tell me something about you. There's danger ahead",voice:"carries the mystery of the unknown",expression:"shows the intensity of someone who sees beyond the veil",motivation:"seeking to prevent a terrible fate"},{name:'Marcus "The Fixer"',role:"Information Broker",personality:"smooth and calculating",mood:"businesslike interest",action:"approaches with the confidence of someone who knows everyone",greeting:"I hear you're looking for work. I might have something that pays well",voice:"carries the smooth confidence of a dealmaker",expression:"shows the careful calculation of a businessman",motivation:"seeking a reliable operative for a lucrative job"}],apocalypse:[{name:"Commander Hayes",role:"Survival Leader",personality:"pragmatic and protective",mood:"urgent concern",action:"approaches with the authority of someone used to making life-or-death decisions",greeting:"We're running out of time and supplies. I need someone who can handle themselves",voice:"carries the weight of leadership in desperate times",expression:"shows the stress of someone responsible for others' survival",motivation:"seeking help to protect the community"},{name:"Dr. Elena Rodriguez",role:"Medical Researcher",personality:"desperate but hopeful",mood:"scientific urgency",action:"approaches with the energy of someone who has made a breakthrough",greeting:"I think I've found a way to help, but I need someone to get the supplies",voice:"carries the hope of someone who refuses to give up",expression:"shows the determination of someone fighting against impossible odds",motivation:"seeking help to save lives"},{name:"Scout",role:"Wasteland Scout",personality:"cautious and observant",mood:"warning concern",action:"emerges from the shadows with practiced stealth",greeting:"You need to know what's coming. It's worse than we thought",voice:"carries the urgency of someone who has seen terrible things",expression:"shows the alertness of someone who lives by their wits",motivation:"seeking to warn others of impending danger"}],pirate:[{name:"Captain Blackbeard",role:"Pirate Captain",personality:"charismatic and ruthless",mood:"adventurous excitement",action:"swaggers toward you with the confidence of a legend",greeting:"Ahoy there! I've got a tale of treasure that'll make your eyes sparkle",voice:"carries the rum-soaked authority of a sea captain",expression:"shows the cunning of someone who has survived countless battles",motivation:"seeking a crew for a legendary treasure hunt"},{name:"Madame Fortune",role:"Port Town Proprietor",personality:"shrewd and well-connected",mood:"businesslike interest",action:"approaches with the practiced grace of a successful merchant",greeting:"I hear you're looking for adventure. I might have just the thing",voice:"carries the smooth confidence of someone who knows every secret",expression:"shows the wisdom of someone who has seen fortunes made and lost",motivation:"seeking a reliable partner for a profitable venture"},{name:"The Navigator",role:"Mysterious Seafarer",personality:"enigmatic and knowledgeable",mood:"prophetic warning",action:"emerges from the shadows with the grace of one who knows the sea",greeting:"The tides are changing, and not for the better. You'll need a guide",voice:"carries the mystery of one who has sailed to the edge of the world",expression:"shows the wisdom of someone who has seen things beyond mortal ken",motivation:"seeking someone to help prevent a maritime disaster"}]},i=n[t]||n.fantasy;return i[Math.floor(Math.random()*i.length)]}generateConflict(e,t){const n={fantasy:[{name:"Ancient Prophecy",description:"A prophecy foretells great danger"},{name:"Missing Artifact",description:"A powerful artifact has disappeared"},{name:"Political Intrigue",description:"Noble houses vie for power"},{name:"Monster Threat",description:"Creatures threaten the realm"},{name:"Dark Magic",description:"Forbidden magic has been unleashed"},{name:"Dragon Awakening",description:"An ancient dragon has stirred from its slumber"}],scifi:[{name:"System Malfunction",description:"Critical systems are failing"},{name:"Alien Invasion",description:"Unknown forces approach"},{name:"Resource Shortage",description:"Essential supplies are running low"},{name:"Political Crisis",description:"Factions struggle for control"},{name:"AI Rebellion",description:"Artificial intelligences have become hostile"},{name:"Space Anomaly",description:"A mysterious phenomenon threatens the sector"}],horror:[{name:"Supernatural Threat",description:"Dark forces have awakened"},{name:"Dark Ritual",description:"An ancient ritual has begun"},{name:"Missing People",description:"Citizens are disappearing"},{name:"Ancient Curse",description:"A curse has been unleashed"},{name:"Cult Activity",description:"A sinister cult is growing in power"},{name:"Haunted Location",description:"A place has become possessed by evil"}],urban:[{name:"Criminal Syndicate",description:"A powerful crime organization is expanding"},{name:"Corrupt Officials",description:"Government officials are involved in illegal activities"},{name:"Supernatural Crime",description:"Supernatural forces are behind recent crimes"},{name:"Urban Legend",description:"A local legend has become real"},{name:"Corporate Conspiracy",description:"A corporation is hiding dangerous secrets"},{name:"Underground Network",description:"A secret network operates beneath the city"}],apocalypse:[{name:"Resource Crisis",description:"Essential resources are running out"},{name:"Hostile Faction",description:"A dangerous group threatens the community"},{name:"Environmental Hazard",description:"A new environmental threat has emerged"},{name:"Disease Outbreak",description:"A deadly disease is spreading"},{name:"Radiation Zone",description:"A radioactive area is expanding"},{name:"Mutant Threat",description:"Mutated creatures are becoming more aggressive"}],pirate:[{name:"Treasure Hunt",description:"A legendary treasure has been discovered"},{name:"Naval Conflict",description:"Pirate fleets are at war"},{name:"Cursed Island",description:"An island holds dark secrets"},{name:"Sea Monster",description:"A sea creature threatens shipping lanes"},{name:"Navy Pursuit",description:"The navy is hunting pirates"},{name:"Lost Fleet",description:"A fleet has disappeared in mysterious circumstances"}]},i=n[e]||n.fantasy;return i[Math.floor(Math.random()*i.length)]}async generateEnhancedDynamicResponse(e){var t;try{const n=Ze(ni,"geminiAIFunction"),i=`\n${e}\n\nRESPONSE GUIDELINES:\n- Write in an engaging, natural DM voice\n- Use vivid sensory details and immersive descriptions  \n- Include appropriate character reactions and consequences\n- Balance narrative flow with player agency\n- Incorporate humor and personality as specified\n- If dice rolls are needed, mention them naturally\n- End with a clear situation for player response\n\nRESPONSE FORMAT:\nNARRATIVE: [Your main story response with rich details and character]\nNPC_DIALOGUE: [Any NPC speech in quotes, showing personality]\nSYSTEM_ACTION: [Any dice rolls, stat changes, or game mechanics needed]\nMOOD: [How this affects scene tension: +1 for more intense, 0 for same, -1 for less intense]\n\nGenerate an immersive, personalized response that makes the player feel like they're at a table with the best human DM:\n`,s=null==(t=(await n({prompt:i,context:{maxTokens:800,temperature:.8,systemRole:"dynamic_dm"}})).data)?void 0:t.response;if(!s)throw new Error("No response from AI service");return s}catch(n){return'\nNARRATIVE: The mystical energies around you shimmer and shift as your action resonates through the fabric of reality. Though the path ahead seems uncertain, your determination guides you forward into the unknown.\n\nNPC_DIALOGUE: "Interesting..." murmurs a nearby figure. "The threads of fate are weaving around you in unexpected ways."\n\nSYSTEM_ACTION: Continue with current action, maintain story flow\n\nMOOD: 0\n'}}generateFallbackResponse(){return{narrative:"The adventure begins... (AI temporarily unavailable)",choices:["Explore ahead","Gather information","Prepare equipment"],atmosphere:{mood:"mysterious",tension:"medium",environmentalDetails:"The path ahead is shrouded in uncertainty."},worldStateUpdates:{newLocation:"Starting Point",consequences:[]}}}async generateQuest(e,t){try{await new Promise(e=>setTimeout(e,20+300*Math.random()));const n=this.generateDynamicQuest(e,t);return JSON.stringify(n)}catch(n){return JSON.stringify(this.generateFallbackQuest())}}generateDynamicQuest(e,t){const{playerLevel:n,playerLocation:i,playerActions:s,worldState:r}=t,a=(null==s?void 0:s.slice(-5))||[],o=a.some(e=>"kill"===e.type),l=a.some(e=>"explore"===e.type),c=a.some(e=>"talk"===e.type);let h="side",u="medium",d=[];o?(h="main",u="hard",d=[{type:"investigate",description:"Investigate the source of recent attacks",target:"threat_source",quantity:1},{type:"collect",description:"Gather evidence of the threat",target:"evidence",quantity:3}]):l?(h="side",u="medium",d=[{type:"explore",description:"Map the newly discovered area",target:"new_area",quantity:1},{type:"collect",description:"Gather rare resources from the area",target:"rare_resources",quantity:5}]):c?(h="faction",u="easy",d=[{type:"talk",description:"Strengthen relationships with local NPCs",target:"local_npcs",quantity:2},{type:"deliver",description:"Deliver important message",target:"important_message",quantity:1}]):d=[{type:"explore",description:"Explore the surrounding area",target:"surrounding_area",quantity:1},{type:"collect",description:"Gather basic resources",target:"basic_resources",quantity:3}];const p=["The Hidden Threat","Secrets of the Land","Alliance Building","Resource Gathering","Exploration Mission"],m=Math.floor(Math.random()*p.length);return{title:p[m],description:["Recent events have revealed a hidden danger that requires your attention.","The land holds many secrets waiting to be discovered.","Building alliances with local factions could prove beneficial.","Gathering resources is essential for survival and progress.","Exploring new areas may reveal valuable opportunities."][m],type:h,difficulty:u,objectives:d,rewards:{experience:50*n,gold:25*n,items:[{name:"Quest Reward",quantity:1,rarity:"common"}],reputation:{Local_Faction:10}},reasoning:"Generated based on recent player actions and current context",relevance:.8,complexity:2,estimatedDuration:20,riskLevel:"medium",potentialOutcomes:[{condition:"success",consequences:[{type:"reputation",target:"Local_Faction",value:10,description:"Improved standing with local faction"}],probability:.7}]}}generateFallbackQuest(){return{title:"Basic Quest",description:"A simple quest to help you get started.",type:"side",difficulty:"easy",objectives:[{type:"explore",description:"Explore the area",target:"area",quantity:1}],rewards:{experience:50,gold:25,items:[]},reasoning:"Fallback quest generated due to AI error,",relevance:.5,complexity:1,estimatedDuration:10,riskLevel:"low",potentialOutcomes:[]}}};"undefined"!=typeof window&&(window.claude={complete:e=>ii.complete(e)});class si{constructor(e={}){t(this,"config"),this.config={memoryRetentionDays:30,emotionalDecayRate:.1,maxMemories:50,personalityStability:.8,...e}}createNPC(e){const t={joy:0,anger:0,fear:0,trust:0,respect:0,currentMood:"neutral",moodIntensity:5,lastMoodChange:new Date,stressLevel:3,confidence:5},n={openness:Math.floor(10*Math.random())+1,conscientiousness:Math.floor(10*Math.random())+1,extraversion:Math.floor(10*Math.random())+1,agreeableness:Math.floor(10*Math.random())+1,neuroticism:Math.floor(10*Math.random())+1};return{id:e.id||Date.now().toString(),name:e.name||"Unknown NPC",title:e.title,avatar:e.avatar,type:e.type||"neutral",personality:e.personality||"A mysterious individual",relationship:e.relationship||0,dialogue:e.dialogue||[],inventory:e.inventory||[],quests:e.quests||[],location:e.location,schedule:e.schedule,emotionalState:e.emotionalState||t,memories:e.memories||[],personalityTraits:e.personalityTraits||n,background:e.background||{origin:"Unknown",occupation:"Unknown",goals:[],fears:[],secrets:[]},interactionHistory:e.interactionHistory||[]}}updateEmotionalState(e,t){const n={...e.emotionalState};return Object.entries(t).forEach(([e,t])=>{if(["joy","anger","fear","trust","respect"].includes(e)){const i=e,s="number"==typeof n[i]?n[i]:Number(n[i])||0,r="number"==typeof t?t:Number(t)||0;n[i]=Math.max(-100,Math.min(100,s+r))}}),n.currentMood=this.calculateMood(n),n.lastMoodChange=new Date,n.moodIntensity=this.calculateMoodIntensity(n),n.stressLevel=this.calculateStressLevel(n),n.confidence=this.calculateConfidence(n),{...e,emotionalState:n}}addMemory(e,t){const n={...t,id:Date.now().toString(),timestamp:new Date},i=[...e.memories,n];return i.length>this.config.maxMemories&&i.splice(0,i.length-this.config.maxMemories),{...e,memories:i}}processEmotionalDecay(e,t=1){const n=Math.pow(1-this.config.emotionalDecayRate,t),i={...e.emotionalState};return["joy","anger","fear","trust","respect"].forEach(e=>{if("number"==typeof i[e]){const t=i[e]*n;i[e]=t}}),i.currentMood=this.calculateMood(i),i.moodIntensity=this.calculateMoodIntensity(i),{...e,emotionalState:i}}cleanOldMemories(e){const t=new Date;t.setDate(t.getDate()-this.config.memoryRetentionDays);const n=e.memories.filter(e=>e.timestamp>t);return{...e,memories:n}}getDisposition(e){const{emotionalState:t,relationship:n}=e,{trust:i,respect:s,fear:r,joy:a}=t;return n>70&&i>50&&a>30?"loving":n>30&&i>20?"friendly":r>50||n<-30?"hostile":r>30?"fearful":"neutral"}getEmotionalSummary(e){const{emotionalState:t}=e,{joy:n,anger:i,fear:s,trust:r,respect:a}=t,o=[];return n>30&&o.push("joyful"),i>30&&o.push("angry"),s>30&&o.push("fearful"),r>30&&o.push("trusting"),a>30&&o.push("respectful"),0===o.length?"neutral":o.join(", ")}getRelevantMemories(e,t,n=5){return e.memories.filter(e=>e.description.toLowerCase().includes(t.toLowerCase())||e.context.toLowerCase().includes(t.toLowerCase())).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime()).slice(0,n)}getPersonalityInfluence(e,t){const{personalityTraits:n}=e;let i=0;switch(t){case"social":i=(n.extraversion+n.agreeableness)/2;break;case"conflict":i=n.neuroticism-n.agreeableness;break;case"exploration":i=n.openness;break;case"responsibility":i=n.conscientiousness;break;default:i=5}return Math.max(0,Math.min(10,i))}calculateMood(e){const{joy:t,anger:n,fear:i,trust:s,respect:r}=e;return t>50&&s>30?"friendly":t>70?"excited":n>50?"hostile":i>50?"anxious":r>50&&s>20?"confident":s<-30?"suspicious":t<-30?"sad":"neutral"}calculateMoodIntensity(e){const{joy:t,anger:n,fear:i,trust:s,respect:r}=e,a=Math.max(Math.abs(t),Math.abs(n),Math.abs(i),Math.abs(s),Math.abs(r));return Math.min(10,Math.floor(a/10))}calculateStressLevel(e){const{anger:t,fear:n}=e,i=[Math.abs(t),Math.abs(n)],s=i.reduce((e,t)=>e+t,0)/i.length;return Math.min(10,Math.floor(s/10))}calculateConfidence(e){const{respect:t,trust:n,joy:i}=e,s=[t,n,i],r=s.reduce((e,t)=>e+t,0)/s.length;return Math.min(10,Math.max(0,Math.floor((r+100)/20)))}generateResponse(e,t){const n=this.getDisposition(e),i=this.getEmotionalSummary(e);this.getPersonalityInfluence(e,"social");const s={loving:["I'm so glad to see you! You've always been kind to me.","You're like family to me. How can I help you today?","My heart warms when I see you approach."],friendly:["Hello there! It's good to see you again.","Welcome! How can I assist you today?","Greetings, friend. What brings you here?"],neutral:["Hello. What do you need?","I see you've returned. What is it?","Yes? How can I help you?"],fearful:["Oh! You startled me... What do you want?","Please, don't hurt me. I'll help if I can.","I... I'm not sure what you want from me."],hostile:["What do you want? I don't have time for this.","You again. What trouble are you causing now?","Leave me alone. I have nothing to say to you."]},r=s[n]||s.neutral,a=r[Math.floor(Math.random()*r.length)];return"neutral"!==i?`${a} (${e.name} seems ${i})`:a}saveNPCState(e){try{const t=JSON.stringify(e);localStorage.setItem(`npc_${e.id}`,t)}catch(t){}}loadNPCState(e){try{const t=localStorage.getItem(`npc_${e}`);if(t){const e=JSON.parse(t);return e.emotionalState.lastMoodChange=new Date(e.emotionalState.lastMoodChange),e.memories=e.memories.map(e=>({...e,timestamp:new Date(e.timestamp)})),e.interactionHistory=e.interactionHistory.map(e=>({...e,timestamp:new Date(e.timestamp)})),e}}catch(t){}return null}}const ri=new si,ai=class e{constructor(){t(this,"sentimentKeywords",{}),t(this,"intentPatterns",{}),t(this,"entityMatchers",{}),t(this,"npcService"),this.initializeNLPComponents(),this.npcService=new si}static getInstance(){return e.instance||(e.instance=new e),e.instance}initializeNLPComponents(){this.sentimentKeywords={frustrated:["stuck","confused","annoyed","tired","bored","what","help","don't understand"],excited:["awesome","amazing","cool","yes!","let's go","epic","love this","fantastic"],confused:["what","how","why","huh","confused","lost","don't get it"],bored:["boring","meh","whatever","ok","sure","I guess"],engaged:["tell me more","what happens","I want to","let me","can I","interesting"]},this.intentPatterns={attack:[/I attack/i,/I fight/i,/I strike/i,/I hit/i,/combat/i,/charge/i],investigate:[/I look/i,/I search/i,/I examine/i,/I check/i,/I investigate/i,/perception/i],talk_to_npc:[/I talk to/i,/I speak with/i,/I ask/i,/I tell/i,/conversation/i,/say/i],ask_question:[/what is/i,/who is/i,/where is/i,/how do/i,/can I/i,/\?/],use_skill:[/I use/i,/skill check/i,/I try to/i,/attempt/i,/roll/i],cast_spell:[/I cast/i,/spell/i,/magic/i,/incantation/i],move:[/I go/i,/I move/i,/I walk/i,/I run/i,/direction/i,/north|south|east|west/i]},this.entityMatchers={characters:/\b[A-Z][a-z]+\s+[A-Z][a-z]+\b/g,items:/\b(sword|shield|potion|staff|bow|armor|helmet|ring|amulet|scroll)\b/gi,locations:/\b(forest|cave|castle|tavern|dungeon|mountain|river|bridge|door|room)\b/gi,actions:/\b(attack|defend|cast|drink|equip|move|search|talk|investigate|climb|jump)\b/gi,spells:/\b(fireball|heal|magic missile|shield|invisibility|teleport|charm)\b/gi,skills:/\b(perception|stealth|athletics|acrobatics|persuasion|deception|insight)\b/gi}}async processPlayerInput(e){try{const t=this.analyzeSentiment(e.message),n=this.recognizeIntent(e.message),i=this.extractEntities(e.message),s=await this.getGameState(e.campaignId),r=await this.getPlayerProfile(e.playerId),a=await this.getDMPersona(e.campaignId),o=this.constructRichPrompt({originalInput:e.message,sentiment:t,intent:n,entities:i,gameState:s,playerProfile:r,dmPersona:a}),l=await ii.generateEnhancedDynamicResponse(o),c=await this.processAIResponse(l,{sentiment:t,intent:n,gameState:s,playerProfile:r,campaignId:e.campaignId});return await this.executeSystemActions(c.system_actions,e.campaignId),await this.updateGameState(e.campaignId,c.game_state_updates),await this.logInteraction(e,c),c}catch(t){return this.generateFallbackResponse(e.message)}}analyzeSentiment(e){const t=e.toLowerCase();let n="neutral",i=0;for(const[l,c]of Object.entries(this.sentimentKeywords)){const e=c.filter(e=>t.includes(e.toLowerCase())).length;e>i&&(i=e,n=l)}const s=(e.match(/!/g)||[]).length,r=(e.match(/\?/g)||[]).length,a=(e.match(/[A-Z]/g)||[]).length/e.length,o=i>0?.7+.1*i:.3;return{emotion:n,intensity:Math.min(1,.3*s+.2*r+.5*a+.4*i),confidence:Math.min(1,o)}}recognizeIntent(e){let t="other",n=0;for(const[i,s]of Object.entries(this.intentPatterns)){const r=s.filter(t=>t.test(e)).length,a=r>0?.8+.1*r:0;a>n&&(n=a,t=i)}return{intent:t,confidence:Math.min(1,n)}}extractEntities(e){const t={characters:[],items:[],locations:[],actions:[],spells:[],skills:[]};for(const[n,i]of Object.entries(this.entityMatchers)){const s=e.match(i)||[];t[n]=[...new Set(s.map(e=>e.toLowerCase()))]}return t}async getGameState(e){try{return this.getDefaultGameState()}catch(t){return this.getDefaultGameState()}}async getPlayerProfile(e){try{return this.getDefaultPlayerProfile()}catch(t){return this.getDefaultPlayerProfile()}}async getDMPersona(e){try{return this.getDefaultDMPersona()}catch(t){return this.getDefaultDMPersona()}}constructRichPrompt(e){const{originalInput:t,sentiment:n,intent:i,entities:s,gameState:r,playerProfile:a,dmPersona:o}=e;return`\n🎲 DYNAMIC DM SYSTEM 🎲\n\nPLAYER INPUT: "${t}"\n\nEMOTIONAL CONTEXT:\n- Sentiment: ${n.emotion} (intensity: ${n.intensity.toFixed(2)})\n- Player seems: ${"frustrated"===n.emotion?"They might need help or encouragement":"excited"===n.emotion?"They're engaged! Keep the energy up":"confused"===n.emotion?"Provide clear guidance":"Maintain current flow"}\n\nINTENT & ENTITIES:\n- Primary Intent: ${i.intent}\n- Detected: Characters[${s.characters.join(", ")}] Items[${s.items.join(", ")}] Locations[${s.locations.join(", ")}]\n\nCURRENT SITUATION:\n- Location: ${r.current_location.description}\n- Active NPCs: ${r.active_npcs.map(e=>`${e.name}(${e.status})`).join(", ")}\n- Current Scene: ${r.campaign_context.current_scene}\n- Tension Level: ${r.campaign_context.tension_level}/10\n\nPLAYER PERSONALITY:\n- Prefers: ${a.preferences.combat_preference} combat, ${a.preferences.roleplay_preference} roleplay\n- Humor Style: ${a.preferences.humor_style}\n- Backstory Elements: ${a.backstory_keywords.join(", ")}\n\nDM PERSONA SETTINGS:\n- Tone: ${o.tone}\n- Humor Level: ${o.humor_level}\n- Descriptiveness: ${o.descriptiveness}\n- Challenge: ${o.challenge_level}\n\nINSTRUCTIONS:\nGenerate a response that:\n1. ${"frustrated"===n.emotion?"Provides gentle guidance or lowers difficulty slightly":"excited"===n.emotion?"Maintains high energy and dramatic tension":"confused"===n.emotion?"Clarifies the situation clearly":"Continues the narrative flow"}\n\n2. Matches the ${o.tone} tone with ${o.humor_level} humor\n\n3. ${"attack"===i.intent?"Describes combat outcome, possibly rolling dice":"investigate"===i.intent?"Reveals information based on perception":"talk_to_npc"===i.intent?"Provides NPC dialogue and personality":"Responds appropriately to the detected intent"}\n\n4. Weaves in relevant backstory elements: ${a.backstory_keywords.slice(0,2).join(", ")}\n\n5. Uses vivid, ${o.descriptiveness} descriptions\n\nFormat your response as:\nNARRATIVE: [Main story response]\nNPC_DIALOGUE: [If applicable, NPC speech in quotes]\nSYSTEM_ACTION: [Any dice rolls, stat changes, or effects needed]\nMOOD: [How this affects scene tension: +1/0/-1]\n`}async processAIResponse(e,t){const n=this.extractSection(e,"NARRATIVE")||e,i=this.extractSection(e,"NPC_DIALOGUE"),s=this.extractSection(e,"SYSTEM_ACTION"),r=this.extractSection(e,"MOOD"),a=[],o={};if(s&&(s.includes("roll")&&a.push({type:"dice_roll",parameters:{dice:"1d20",reason:"action_resolution"}}),(s.includes("damage")||s.includes("heal"))&&a.push({type:"stat_update",parameters:{type:"health",change:this.extractNumber(s)}})),r){const e=this.extractNumber(r);0!==e&&(o.campaign_context={...t.gameState.campaign_context,tension_level:Math.max(0,Math.min(10,t.gameState.campaign_context.tension_level+e))})}return{narrative_text:n,npc_dialogue:i,system_actions:a,game_state_updates:o,mood_adjustment:r?{tension_delta:this.extractNumber(r),engagement_boost:"excited"===t.sentiment.emotion}:void 0}}async processNPCInteractions(e,t,n){const i=[];for(const r of e)try{let e=this.npcService.createNPC({name:r});const s=this.analyzeEmotionalImpact(t,n);e=this.npcService.updateEmotionalState(e,s),e=this.npcService.addMemory(e,{type:"conversation",description:`Player said:${t}"`,context:"player_interaction",emotionalImpact:s,relationshipChange:this.calculateMemoryImportance(t,s)}),i.push({id:e.id,name:e.name,hp:10,status:this.npcService.getDisposition(e),personality:e.personality,emotionalState:e.emotionalState})}catch(s){}return i}analyzeEmotionalImpact(e,t){const n={joy:0,anger:0,fear:0,trust:0,respect:0},i=this.analyzeSentiment(e),s=this.analyzeSentiment(t);"excited"===i.emotion&&"excited"===s.emotion?(n.joy+=10,n.trust+=5):"frustrated"===i.emotion&&"frustrated"===s.emotion?(n.anger+=10,n.fear+=5):"confused"===i.emotion&&(n.fear+=5,n.trust-=5);const r=["help","save","protect","friend","ally","respectful"];return["attack","kill","hurt","destroy","threaten"].some(t=>e.toLowerCase().includes(t))&&(n.fear+=15,n.trust-=10),r.some(t=>e.toLowerCase().includes(t))&&(n.trust+=10,n.joy+=5),r.some(t=>e.toLowerCase().includes(t))&&(n.respect+=10,n.trust+=5),n}calculateMemoryImportance(e,t){const n=Math.abs(t.joy)+Math.abs(t.anger)+Math.abs(t.fear)+Math.abs(t.trust)+Math.abs(t.respect);return Math.min(10,Math.max(1,Math.floor(n/10)))}extractSection(e,t){const n=new RegExp(`${t}:\\s*(.+?)(?=\\n[A-Z_]+:|$)`,"s"),i=e.match(n);return i?i[1].trim():void 0}extractNumber(e){const t=e.match(/[+-]?\d+/);return t?parseInt(t[0]):0}async executeSystemActions(e,t){for(const n of e)n.type}async updateGameState(e,t){Object.keys(t).length}async logInteraction(e,t){e.message,t.narrative_text,t.system_actions,t.mood_adjustment}generateFallbackResponse(e){return{narrative_text:"The mists of magic swirl around you as reality shifts. Something unexpected has occurred, but your adventure continues...",system_actions:[],game_state_updates:{}}}getDefaultGameState(){return{current_location:{id:"starting_area",description:"You find yourself in a mystical realm where adventure awaits.",encounters:[],npcs:[],items:[]},active_npcs:[],party_position:{x:0,y:0},active_quests:[],inventory:[],campaign_context:{theme:"Fantasy",current_scene:"Beginning of Adventure",tension_level:3,last_major_event:"Campaign started"}}}getDefaultPlayerProfile(){return{character_sheet:{name:"Adventurer",class:"Fighter",level:1,stats:{strength:12,dexterity:12,constitution:12,intelligence:12,wisdom:12,charisma:12},abilities:[]},preferences:{combat_preference:"medium",roleplay_preference:"medium",puzzle_preference:"medium",humor_style:"witty",narrative_style:"immersive"},backstory_keywords:[],out_of_character_notes:[],interaction_history:[]}}getDefaultDMPersona(){return{tone:"friendly",humor_level:"medium",descriptiveness:"moderate",challenge_level:"moderate",narrative_focus:"balanced",improvisation_style:"moderate"}}};t(ai,"instance");const oi=ai.getInstance();function li(e,t,{checkForDefaultPrevented:n=!0}={}){return function(i){if(null==e||e(i),!1===n||!i.defaultPrevented)return null==t?void 0:t(i)}}function ci(e,t){if("function"==typeof e)return e(t);null!=e&&(e.current=t)}function hi(...e){return t=>{let n=!1;const i=e.map(e=>{const i=ci(e,t);return n||"function"!=typeof i||(n=!0),i});if(n)return()=>{for(let t=0;t<i.length;t++){const n=i[t];"function"==typeof n?n():ci(e[t],null)}}}}function ui(...e){return n.useCallback(hi(...e),e)}function di(e,t=[]){let i=[];const s=()=>{const t=i.map(e=>n.createContext(e));return function(i){const s=(null==i?void 0:i[e])||t;return n.useMemo(()=>({[`__scope${e}`]:{...i,[e]:s}}),[i,s])}};return s.scopeName=e,[function(t,s){const r=n.createContext(s),a=i.length;i=[...i,s];const o=t=>{var i;const{scope:s,children:o,...l}=t,c=(null==(i=null==s?void 0:s[e])?void 0:i[a])||r,h=n.useMemo(()=>l,Object.values(l));return at.jsx(c.Provider,{value:h,children:o})};return o.displayName=t+"Provider",[o,function(i,o){var l;const c=(null==(l=null==o?void 0:o[e])?void 0:l[a])||r,h=n.useContext(c);if(h)return h;if(void 0!==s)return s;throw new Error(`\`${i}\` must be used within \`${t}\``)}]},pi(s,...t)]}function pi(...e){const t=e[0];if(1===e.length)return t;const i=()=>{const i=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){const s=i.reduce((t,{useScope:n,scopeName:i})=>({...t,...n(e)[`__scope${i}`]}),{});return n.useMemo(()=>({[`__scope${t.scopeName}`]:s}),[s])}};return i.scopeName=t.scopeName,i}function mi(e){const t=fi(e),i=n.forwardRef((e,i)=>{const{children:s,...r}=e,a=n.Children.toArray(s),o=a.find(xi);if(o){const e=o.props.children,s=a.map(t=>t===o?n.Children.count(e)>1?n.Children.only(null):n.isValidElement(e)?e.props.children:null:t);return at.jsx(t,{...r,ref:i,children:n.isValidElement(e)?n.cloneElement(e,void 0,s):null})}return at.jsx(t,{...r,ref:i,children:s})});return i.displayName=`${e}.Slot`,i}function fi(e){const t=n.forwardRef((e,t)=>{const{children:i,...s}=e;if(n.isValidElement(i)){const e=function(e){var t,n;let i=null==(t=Object.getOwnPropertyDescriptor(e.props,"ref"))?void 0:t.get,s=i&&"isReactWarning"in i&&i.isReactWarning;return s?e.ref:(i=null==(n=Object.getOwnPropertyDescriptor(e,"ref"))?void 0:n.get,s=i&&"isReactWarning"in i&&i.isReactWarning,s?e.props.ref:e.props.ref||e.ref)}(i),r=function(e,t){const n={...t};for(const i in t){const s=e[i],r=t[i];/^on[A-Z]/.test(i)?s&&r?n[i]=(...e)=>{const t=r(...e);return s(...e),t}:s&&(n[i]=s):"style"===i?n[i]={...s,...r}:"className"===i&&(n[i]=[s,r].filter(Boolean).join(" "))}return{...e,...n}}(s,i.props);return i.type!==n.Fragment&&(r.ref=t?hi(t,e):e),n.cloneElement(i,r)}return n.Children.count(i)>1?n.Children.only(null):null});return t.displayName=`${e}.SlotClone`,t}var gi=Symbol("radix.slottable");function vi(e){const t=({children:e})=>at.jsx(at.Fragment,{children:e});return t.displayName=`${e}.Slottable`,t.__radixId=gi,t}function xi(e){return n.isValidElement(e)&&"function"==typeof e.type&&"__radixId"in e.type&&e.type.__radixId===gi}var yi=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((e,t)=>{const i=mi(`Primitive.${t}`),s=n.forwardRef((e,n)=>{const{asChild:s,...r}=e,a=s?i:t;return"undefined"!=typeof window&&(window[Symbol.for("radix-ui")]=!0),at.jsx(a,{...r,ref:n})});return s.displayName=`Primitive.${t}`,{...e,[t]:s}},{});function _i(e){const t=n.useRef(e);return n.useEffect(()=>{t.current=e}),n.useMemo(()=>(...e)=>{var n;return null==(n=t.current)?void 0:n.call(t,...e)},[])}var bi,wi="dismissableLayer.update",Si=n.createContext({layers:new Set,layersWithOutsidePointerEventsDisabled:new Set,branches:new Set}),Mi=n.forwardRef((e,t)=>{const{disableOutsidePointerEvents:i=!1,onEscapeKeyDown:s,onPointerDownOutside:r,onFocusOutside:a,onInteractOutside:o,onDismiss:l,...c}=e,h=n.useContext(Si),[u,d]=n.useState(null),p=(null==u?void 0:u.ownerDocument)??(null==globalThis?void 0:globalThis.document),[,m]=n.useState({}),f=ui(t,e=>d(e)),g=Array.from(h.layers),[v]=[...h.layersWithOutsidePointerEventsDisabled].slice(-1),x=g.indexOf(v),y=u?g.indexOf(u):-1,_=h.layersWithOutsidePointerEventsDisabled.size>0,b=y>=x,w=function(e,t=(null==globalThis?void 0:globalThis.document)){const i=_i(e),s=n.useRef(!1),r=n.useRef(()=>{});return n.useEffect(()=>{const e=e=>{if(e.target&&!s.current){let n=function(){Ei("dismissableLayer.pointerDownOutside",i,s,{discrete:!0})};const s={originalEvent:e};"touch"===e.pointerType?(t.removeEventListener("click",r.current),r.current=n,t.addEventListener("click",r.current,{once:!0})):n()}else t.removeEventListener("click",r.current);s.current=!1},n=window.setTimeout(()=>{t.addEventListener("pointerdown",e)},0);return()=>{window.clearTimeout(n),t.removeEventListener("pointerdown",e),t.removeEventListener("click",r.current)}},[t,i]),{onPointerDownCapture:()=>s.current=!0}}(e=>{const t=e.target,n=[...h.branches].some(e=>e.contains(t));b&&!n&&(null==r||r(e),null==o||o(e),e.defaultPrevented||null==l||l())},p),S=function(e,t=(null==globalThis?void 0:globalThis.document)){const i=_i(e),s=n.useRef(!1);return n.useEffect(()=>{const e=e=>{e.target&&!s.current&&Ei("dismissableLayer.focusOutside",i,{originalEvent:e},{discrete:!1})};return t.addEventListener("focusin",e),()=>t.removeEventListener("focusin",e)},[t,i]),{onFocusCapture:()=>s.current=!0,onBlurCapture:()=>s.current=!1}}(e=>{const t=e.target;[...h.branches].some(e=>e.contains(t))||(null==a||a(e),null==o||o(e),e.defaultPrevented||null==l||l())},p);return function(e,t=(null==globalThis?void 0:globalThis.document)){const i=_i(e);n.useEffect(()=>{const e=e=>{"Escape"===e.key&&i(e)};return t.addEventListener("keydown",e,{capture:!0}),()=>t.removeEventListener("keydown",e,{capture:!0})},[i,t])}(e=>{y===h.layers.size-1&&(null==s||s(e),!e.defaultPrevented&&l&&(e.preventDefault(),l()))},p),n.useEffect(()=>{if(u)return i&&(0===h.layersWithOutsidePointerEventsDisabled.size&&(bi=p.body.style.pointerEvents,p.body.style.pointerEvents="none"),h.layersWithOutsidePointerEventsDisabled.add(u)),h.layers.add(u),Ti(),()=>{i&&1===h.layersWithOutsidePointerEventsDisabled.size&&(p.body.style.pointerEvents=bi)}},[u,p,i,h]),n.useEffect(()=>()=>{u&&(h.layers.delete(u),h.layersWithOutsidePointerEventsDisabled.delete(u),Ti())},[u,h]),n.useEffect(()=>{const e=()=>m({});return document.addEventListener(wi,e),()=>document.removeEventListener(wi,e)},[]),at.jsx(yi.div,{...c,ref:f,style:{pointerEvents:_?b?"auto":"none":void 0,...e.style},onFocusCapture:li(e.onFocusCapture,S.onFocusCapture),onBlurCapture:li(e.onBlurCapture,S.onBlurCapture),onPointerDownCapture:li(e.onPointerDownCapture,w.onPointerDownCapture)})});function Ti(){const e=new CustomEvent(wi);document.dispatchEvent(e)}function Ei(e,t,n,{discrete:s}){const r=n.originalEvent.target,a=new CustomEvent(e,{bubbles:!1,cancelable:!0,detail:n});t&&r.addEventListener(e,t,{once:!0}),s?function(e,t){e&&i.flushSync(()=>e.dispatchEvent(t))}(r,a):r.dispatchEvent(a)}Mi.displayName="DismissableLayer",n.forwardRef((e,t)=>{const i=n.useContext(Si),s=n.useRef(null),r=ui(t,s);return n.useEffect(()=>{const e=s.current;if(e)return i.branches.add(e),()=>{i.branches.delete(e)}},[i.branches]),at.jsx(yi.div,{...e,ref:r})}).displayName="DismissableLayerBranch";var Ci=(null==globalThis?void 0:globalThis.document)?n.useLayoutEffect:()=>{},Ai=s[" useId ".trim().toString()]||(()=>{}),Ni=0;const Ri=["top","right","bottom","left"],Pi=Math.min,Ii=Math.max,ji=Math.round,Di=Math.floor,ki=e=>({x:e,y:e}),Li={left:"right",right:"left",bottom:"top",top:"bottom"},Oi={start:"end",end:"start"};function Ui(e,t,n){return Ii(e,Pi(t,n))}function Fi(e,t){return"function"==typeof e?e(t):e}function Bi(e){return e.split("-")[0]}function zi(e){return e.split("-")[1]}function Vi(e){return"x"===e?"y":"x"}function Hi(e){return"y"===e?"height":"width"}const Wi=new Set(["top","bottom"]);function Gi(e){return Wi.has(Bi(e))?"y":"x"}function qi(e){return Vi(Gi(e))}function Xi(e){return e.replace(/start|end/g,e=>Oi[e])}const Yi=["left","right"],$i=["right","left"],Zi=["top","bottom"],Ki=["bottom","top"];function Ji(e){return e.replace(/left|right|bottom|top/g,e=>Li[e])}function Qi(e){return"number"!=typeof e?function(e){return{top:0,right:0,bottom:0,left:0,...e}}(e):{top:e,right:e,bottom:e,left:e}}function es(e){const{x:t,y:n,width:i,height:s}=e;return{width:i,height:s,top:n,left:t,right:t+i,bottom:n+s,x:t,y:n}}function ts(e,t,n){let{reference:i,floating:s}=e;const r=Gi(t),a=qi(t),o=Hi(a),l=Bi(t),c="y"===r,h=i.x+i.width/2-s.width/2,u=i.y+i.height/2-s.height/2,d=i[o]/2-s[o]/2;let p;switch(l){case"top":p={x:h,y:i.y-s.height};break;case"bottom":p={x:h,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:u};break;case"left":p={x:i.x-s.width,y:u};break;default:p={x:i.x,y:i.y}}switch(zi(t)){case"start":p[a]-=d*(n&&c?-1:1);break;case"end":p[a]+=d*(n&&c?-1:1)}return p}async function ns(e,t){var n;void 0===t&&(t={});const{x:i,y:s,platform:r,rects:a,elements:o,strategy:l}=e,{boundary:c="clippingAncestors",rootBoundary:h="viewport",elementContext:u="floating",altBoundary:d=!1,padding:p=0}=Fi(t,e),m=Qi(p),f=o[d?"floating"===u?"reference":"floating":u],g=es(await r.getClippingRect({element:null==(n=await(null==r.isElement?void 0:r.isElement(f)))||n?f:f.contextElement||await(null==r.getDocumentElement?void 0:r.getDocumentElement(o.floating)),boundary:c,rootBoundary:h,strategy:l})),v="floating"===u?{x:i,y:s,width:a.floating.width,height:a.floating.height}:a.reference,x=await(null==r.getOffsetParent?void 0:r.getOffsetParent(o.floating)),y=await(null==r.isElement?void 0:r.isElement(x))&&await(null==r.getScale?void 0:r.getScale(x))||{x:1,y:1},_=es(r.convertOffsetParentRelativeRectToViewportRelativeRect?await r.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:v,offsetParent:x,strategy:l}):v);return{top:(g.top-_.top+m.top)/y.y,bottom:(_.bottom-g.bottom+m.bottom)/y.y,left:(g.left-_.left+m.left)/y.x,right:(_.right-g.right+m.right)/y.x}}function is(e,t){return{top:e.top-t.height,right:e.right-t.width,bottom:e.bottom-t.height,left:e.left-t.width}}function ss(e){return Ri.some(t=>e[t]>=0)}const rs=new Set(["left","top"]);function as(){return"undefined"!=typeof window}function os(e){return hs(e)?(e.nodeName||"").toLowerCase():"#document"}function ls(e){var t;return(null==e||null==(t=e.ownerDocument)?void 0:t.defaultView)||window}function cs(e){var t;return null==(t=(hs(e)?e.ownerDocument:e.document)||window.document)?void 0:t.documentElement}function hs(e){return!!as()&&(e instanceof Node||e instanceof ls(e).Node)}function us(e){return!!as()&&(e instanceof Element||e instanceof ls(e).Element)}function ds(e){return!!as()&&(e instanceof HTMLElement||e instanceof ls(e).HTMLElement)}function ps(e){return!(!as()||"undefined"==typeof ShadowRoot)&&(e instanceof ShadowRoot||e instanceof ls(e).ShadowRoot)}const ms=new Set(["inline","contents"]);function fs(e){const{overflow:t,overflowX:n,overflowY:i,display:s}=Cs(e);return/auto|scroll|overlay|hidden|clip/.test(t+i+n)&&!ms.has(s)}const gs=new Set(["table","td","th"]);function vs(e){return gs.has(os(e))}const xs=[":popover-open",":modal"];function ys(e){return xs.some(t=>{try{return e.matches(t)}catch(n){return!1}})}const _s=["transform","translate","scale","rotate","perspective"],bs=["transform","translate","scale","rotate","perspective","filter"],ws=["paint","layout","strict","content"];function Ss(e){const t=Ms(),n=us(e)?Cs(e):e;return _s.some(e=>!!n[e]&&"none"!==n[e])||!!n.containerType&&"normal"!==n.containerType||!t&&!!n.backdropFilter&&"none"!==n.backdropFilter||!t&&!!n.filter&&"none"!==n.filter||bs.some(e=>(n.willChange||"").includes(e))||ws.some(e=>(n.contain||"").includes(e))}function Ms(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}const Ts=new Set(["html","body","#document"]);function Es(e){return Ts.has(os(e))}function Cs(e){return ls(e).getComputedStyle(e)}function As(e){return us(e)?{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}:{scrollLeft:e.scrollX,scrollTop:e.scrollY}}function Ns(e){if("html"===os(e))return e;const t=e.assignedSlot||e.parentNode||ps(e)&&e.host||cs(e);return ps(t)?t.host:t}function Rs(e){const t=Ns(e);return Es(t)?e.ownerDocument?e.ownerDocument.body:e.body:ds(t)&&fs(t)?t:Rs(t)}function Ps(e,t,n){var i;void 0===t&&(t=[]),void 0===n&&(n=!0);const s=Rs(e),r=s===(null==(i=e.ownerDocument)?void 0:i.body),a=ls(s);if(r){const e=Is(a);return t.concat(a,a.visualViewport||[],fs(s)?s:[],e&&n?Ps(e):[])}return t.concat(s,Ps(s,[],n))}function Is(e){return e.parent&&Object.getPrototypeOf(e.parent)?e.frameElement:null}function js(e){const t=Cs(e);let n=parseFloat(t.width)||0,i=parseFloat(t.height)||0;const s=ds(e),r=s?e.offsetWidth:n,a=s?e.offsetHeight:i,o=ji(n)!==r||ji(i)!==a;return o&&(n=r,i=a),{width:n,height:i,$:o}}function Ds(e){return us(e)?e:e.contextElement}function ks(e){const t=Ds(e);if(!ds(t))return ki(1);const n=t.getBoundingClientRect(),{width:i,height:s,$:r}=js(t);let a=(r?ji(n.width):n.width)/i,o=(r?ji(n.height):n.height)/s;return a&&Number.isFinite(a)||(a=1),o&&Number.isFinite(o)||(o=1),{x:a,y:o}}const Ls=ki(0);function Os(e){const t=ls(e);return Ms()&&t.visualViewport?{x:t.visualViewport.offsetLeft,y:t.visualViewport.offsetTop}:Ls}function Us(e,t,n,i){void 0===t&&(t=!1),void 0===n&&(n=!1);const s=e.getBoundingClientRect(),r=Ds(e);let a=ki(1);t&&(i?us(i)&&(a=ks(i)):a=ks(e));const o=function(e,t,n){return void 0===t&&(t=!1),!(!n||t&&n!==ls(e))&&t}(r,n,i)?Os(r):ki(0);let l=(s.left+o.x)/a.x,c=(s.top+o.y)/a.y,h=s.width/a.x,u=s.height/a.y;if(r){const e=ls(r),t=i&&us(i)?ls(i):i;let n=e,s=Is(n);for(;s&&i&&t!==n;){const e=ks(s),t=s.getBoundingClientRect(),i=Cs(s),r=t.left+(s.clientLeft+parseFloat(i.paddingLeft))*e.x,a=t.top+(s.clientTop+parseFloat(i.paddingTop))*e.y;l*=e.x,c*=e.y,h*=e.x,u*=e.y,l+=r,c+=a,n=ls(s),s=Is(n)}}return es({width:h,height:u,x:l,y:c})}function Fs(e,t){const n=As(e).scrollLeft;return t?t.left+n:Us(cs(e)).left+n}function Bs(e,t,n){void 0===n&&(n=!1);const i=e.getBoundingClientRect();return{x:i.left+t.scrollLeft-(n?0:Fs(e,i)),y:i.top+t.scrollTop}}const zs=new Set(["absolute","fixed"]);function Vs(e,t,n){let i;if("viewport"===t)i=function(e,t){const n=ls(e),i=cs(e),s=n.visualViewport;let r=i.clientWidth,a=i.clientHeight,o=0,l=0;if(s){r=s.width,a=s.height;const e=Ms();(!e||e&&"fixed"===t)&&(o=s.offsetLeft,l=s.offsetTop)}return{width:r,height:a,x:o,y:l}}(e,n);else if("document"===t)i=function(e){const t=cs(e),n=As(e),i=e.ownerDocument.body,s=Ii(t.scrollWidth,t.clientWidth,i.scrollWidth,i.clientWidth),r=Ii(t.scrollHeight,t.clientHeight,i.scrollHeight,i.clientHeight);let a=-n.scrollLeft+Fs(e);const o=-n.scrollTop;return"rtl"===Cs(i).direction&&(a+=Ii(t.clientWidth,i.clientWidth)-s),{width:s,height:r,x:a,y:o}}(cs(e));else if(us(t))i=function(e,t){const n=Us(e,!0,"fixed"===t),i=n.top+e.clientTop,s=n.left+e.clientLeft,r=ds(e)?ks(e):ki(1);return{width:e.clientWidth*r.x,height:e.clientHeight*r.y,x:s*r.x,y:i*r.y}}(t,n);else{const n=Os(e);i={x:t.x-n.x,y:t.y-n.y,width:t.width,height:t.height}}return es(i)}function Hs(e,t){const n=Ns(e);return!(n===t||!us(n)||Es(n))&&("fixed"===Cs(n).position||Hs(n,t))}function Ws(e,t,n){const i=ds(t),s=cs(t),r="fixed"===n,a=Us(e,!0,r,t);let o={scrollLeft:0,scrollTop:0};const l=ki(0);function c(){l.x=Fs(s)}if(i||!i&&!r)if(("body"!==os(t)||fs(s))&&(o=As(t)),i){const e=Us(t,!0,r,t);l.x=e.x+t.clientLeft,l.y=e.y+t.clientTop}else s&&c();r&&!i&&s&&c();const h=!s||i||r?ki(0):Bs(s,o);return{x:a.left+o.scrollLeft-l.x-h.x,y:a.top+o.scrollTop-l.y-h.y,width:a.width,height:a.height}}function Gs(e){return"static"===Cs(e).position}function qs(e,t){if(!ds(e)||"fixed"===Cs(e).position)return null;if(t)return t(e);let n=e.offsetParent;return cs(e)===n&&(n=n.ownerDocument.body),n}function Xs(e,t){const n=ls(e);if(ys(e))return n;if(!ds(e)){let t=Ns(e);for(;t&&!Es(t);){if(us(t)&&!Gs(t))return t;t=Ns(t)}return n}let i=qs(e,t);for(;i&&vs(i)&&Gs(i);)i=qs(i,t);return i&&Es(i)&&Gs(i)&&!Ss(i)?n:i||function(e){let t=Ns(e);for(;ds(t)&&!Es(t);){if(Ss(t))return t;if(ys(t))return null;t=Ns(t)}return null}(e)||n}const Ys={convertOffsetParentRelativeRectToViewportRelativeRect:function(e){let{elements:t,rect:n,offsetParent:i,strategy:s}=e;const r="fixed"===s,a=cs(i),o=!!t&&ys(t.floating);if(i===a||o&&r)return n;let l={scrollLeft:0,scrollTop:0},c=ki(1);const h=ki(0),u=ds(i);if((u||!u&&!r)&&(("body"!==os(i)||fs(a))&&(l=As(i)),ds(i))){const e=Us(i);c=ks(i),h.x=e.x+i.clientLeft,h.y=e.y+i.clientTop}const d=!a||u||r?ki(0):Bs(a,l,!0);return{width:n.width*c.x,height:n.height*c.y,x:n.x*c.x-l.scrollLeft*c.x+h.x+d.x,y:n.y*c.y-l.scrollTop*c.y+h.y+d.y}},getDocumentElement:cs,getClippingRect:function(e){let{element:t,boundary:n,rootBoundary:i,strategy:s}=e;const r=[..."clippingAncestors"===n?ys(t)?[]:function(e,t){const n=t.get(e);if(n)return n;let i=Ps(e,[],!1).filter(e=>us(e)&&"body"!==os(e)),s=null;const r="fixed"===Cs(e).position;let a=r?Ns(e):e;for(;us(a)&&!Es(a);){const t=Cs(a),n=Ss(a);n||"fixed"!==t.position||(s=null),(r?!n&&!s:!n&&"static"===t.position&&s&&zs.has(s.position)||fs(a)&&!n&&Hs(e,a))?i=i.filter(e=>e!==a):s=t,a=Ns(a)}return t.set(e,i),i}(t,this._c):[].concat(n),i],a=r[0],o=r.reduce((e,n)=>{const i=Vs(t,n,s);return e.top=Ii(i.top,e.top),e.right=Pi(i.right,e.right),e.bottom=Pi(i.bottom,e.bottom),e.left=Ii(i.left,e.left),e},Vs(t,a,s));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}},getOffsetParent:Xs,getElementRects:async function(e){const t=this.getOffsetParent||Xs,n=this.getDimensions,i=await n(e.floating);return{reference:Ws(e.reference,await t(e.floating),e.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}},getClientRects:function(e){return Array.from(e.getClientRects())},getDimensions:function(e){const{width:t,height:n}=js(e);return{width:t,height:n}},getScale:ks,isElement:us,isRTL:function(e){return"rtl"===Cs(e).direction}};function $s(e,t){return e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}const Zs=function(e){return void 0===e&&(e=0),{name:"offset",options:e,async fn(t){var n,i;const{x:s,y:r,placement:a,middlewareData:o}=t,l=await async function(e,t){const{placement:n,platform:i,elements:s}=e,r=await(null==i.isRTL?void 0:i.isRTL(s.floating)),a=Bi(n),o=zi(n),l="y"===Gi(n),c=rs.has(a)?-1:1,h=r&&l?-1:1,u=Fi(t,e);let{mainAxis:d,crossAxis:p,alignmentAxis:m}="number"==typeof u?{mainAxis:u,crossAxis:0,alignmentAxis:null}:{mainAxis:u.mainAxis||0,crossAxis:u.crossAxis||0,alignmentAxis:u.alignmentAxis};return o&&"number"==typeof m&&(p="end"===o?-1*m:m),l?{x:p*h,y:d*c}:{x:d*c,y:p*h}}(t,e);return a===(null==(n=o.offset)?void 0:n.placement)&&null!=(i=o.arrow)&&i.alignmentOffset?{}:{x:s+l.x,y:r+l.y,data:{...l,placement:a}}}}},Ks=function(e){return void 0===e&&(e={}),{name:"shift",options:e,async fn(t){const{x:n,y:i,placement:s}=t,{mainAxis:r=!0,crossAxis:a=!1,limiter:o={fn:e=>{let{x:t,y:n}=e;return{x:t,y:n}}},...l}=Fi(e,t),c={x:n,y:i},h=await ns(t,l),u=Gi(Bi(s)),d=Vi(u);let p=c[d],m=c[u];if(r){const e="y"===d?"bottom":"right";p=Ui(p+h["y"===d?"top":"left"],p,p-h[e])}if(a){const e="y"===u?"bottom":"right";m=Ui(m+h["y"===u?"top":"left"],m,m-h[e])}const f=o.fn({...t,[d]:p,[u]:m});return{...f,data:{x:f.x-n,y:f.y-i,enabled:{[d]:r,[u]:a}}}}}},Js=function(e){return void 0===e&&(e={}),{name:"flip",options:e,async fn(t){var n,i;const{placement:s,middlewareData:r,rects:a,initialPlacement:o,platform:l,elements:c}=t,{mainAxis:h=!0,crossAxis:u=!0,fallbackPlacements:d,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:m="none",flipAlignment:f=!0,...g}=Fi(e,t);if(null!=(n=r.arrow)&&n.alignmentOffset)return{};const v=Bi(s),x=Gi(o),y=Bi(o)===o,_=await(null==l.isRTL?void 0:l.isRTL(c.floating)),b=d||(y||!f?[Ji(o)]:function(e){const t=Ji(e);return[Xi(e),t,Xi(t)]}(o)),w="none"!==m;!d&&w&&b.push(...function(e,t,n,i){const s=zi(e);let r=function(e,t,n){switch(e){case"top":case"bottom":return n?t?$i:Yi:t?Yi:$i;case"left":case"right":return t?Zi:Ki;default:return[]}}(Bi(e),"start"===n,i);return s&&(r=r.map(e=>e+"-"+s),t&&(r=r.concat(r.map(Xi)))),r}(o,f,m,_));const S=[o,...b],M=await ns(t,g),T=[];let E=(null==(i=r.flip)?void 0:i.overflows)||[];if(h&&T.push(M[v]),u){const e=function(e,t,n){void 0===n&&(n=!1);const i=zi(e),s=qi(e),r=Hi(s);let a="x"===s?i===(n?"end":"start")?"right":"left":"start"===i?"bottom":"top";return t.reference[r]>t.floating[r]&&(a=Ji(a)),[a,Ji(a)]}(s,a,_);T.push(M[e[0]],M[e[1]])}if(E=[...E,{placement:s,overflows:T}],!T.every(e=>e<=0)){var C,A;const e=((null==(C=r.flip)?void 0:C.index)||0)+1,t=S[e];if(t&&("alignment"!==u||x===Gi(t)||E.every(e=>e.overflows[0]>0&&Gi(e.placement)===x)))return{data:{index:e,overflows:E},reset:{placement:t}};let n=null==(A=E.filter(e=>e.overflows[0]<=0).sort((e,t)=>e.overflows[1]-t.overflows[1])[0])?void 0:A.placement;if(!n)switch(p){case"bestFit":{var N;const e=null==(N=E.filter(e=>{if(w){const t=Gi(e.placement);return t===x||"y"===t}return!0}).map(e=>[e.placement,e.overflows.filter(e=>e>0).reduce((e,t)=>e+t,0)]).sort((e,t)=>e[1]-t[1])[0])?void 0:N[0];e&&(n=e);break}case"initialPlacement":n=o}if(s!==n)return{reset:{placement:n}}}return{}}}},Qs=function(e){return void 0===e&&(e={}),{name:"size",options:e,async fn(t){var n,i;const{placement:s,rects:r,platform:a,elements:o}=t,{apply:l=()=>{},...c}=Fi(e,t),h=await ns(t,c),u=Bi(s),d=zi(s),p="y"===Gi(s),{width:m,height:f}=r.floating;let g,v;"top"===u||"bottom"===u?(g=u,v=d===(await(null==a.isRTL?void 0:a.isRTL(o.floating))?"start":"end")?"left":"right"):(v=u,g="end"===d?"top":"bottom");const x=f-h.top-h.bottom,y=m-h.left-h.right,_=Pi(f-h[g],x),b=Pi(m-h[v],y),w=!t.middlewareData.shift;let S=_,M=b;if(null!=(n=t.middlewareData.shift)&&n.enabled.x&&(M=y),null!=(i=t.middlewareData.shift)&&i.enabled.y&&(S=x),w&&!d){const e=Ii(h.left,0),t=Ii(h.right,0),n=Ii(h.top,0),i=Ii(h.bottom,0);p?M=m-2*(0!==e||0!==t?e+t:Ii(h.left,h.right)):S=f-2*(0!==n||0!==i?n+i:Ii(h.top,h.bottom))}await l({...t,availableWidth:M,availableHeight:S});const T=await a.getDimensions(o.floating);return m!==T.width||f!==T.height?{reset:{rects:!0}}:{}}}},er=function(e){return void 0===e&&(e={}),{name:"hide",options:e,async fn(t){const{rects:n}=t,{strategy:i="referenceHidden",...s}=Fi(e,t);switch(i){case"referenceHidden":{const e=is(await ns(t,{...s,elementContext:"reference"}),n.reference);return{data:{referenceHiddenOffsets:e,referenceHidden:ss(e)}}}case"escaped":{const e=is(await ns(t,{...s,altBoundary:!0}),n.floating);return{data:{escapedOffsets:e,escaped:ss(e)}}}default:return{}}}}},tr=e=>({name:"arrow",options:e,async fn(t){const{x:n,y:i,placement:s,rects:r,platform:a,elements:o,middlewareData:l}=t,{element:c,padding:h=0}=Fi(e,t)||{};if(null==c)return{};const u=Qi(h),d={x:n,y:i},p=qi(s),m=Hi(p),f=await a.getDimensions(c),g="y"===p,v=g?"top":"left",x=g?"bottom":"right",y=g?"clientHeight":"clientWidth",_=r.reference[m]+r.reference[p]-d[p]-r.floating[m],b=d[p]-r.reference[p],w=await(null==a.getOffsetParent?void 0:a.getOffsetParent(c));let S=w?w[y]:0;S&&await(null==a.isElement?void 0:a.isElement(w))||(S=o.floating[y]||r.floating[m]);const M=_/2-b/2,T=S/2-f[m]/2-1,E=Pi(u[v],T),C=Pi(u[x],T),A=E,N=S-f[m]-C,R=S/2-f[m]/2+M,P=Ui(A,R,N),I=!l.arrow&&null!=zi(s)&&R!==P&&r.reference[m]/2-(R<A?E:C)-f[m]/2<0,j=I?R<A?R-A:R-N:0;return{[p]:d[p]+j,data:{[p]:P,centerOffset:R-P-j,...I&&{alignmentOffset:j}},reset:I}}}),nr=function(e){return void 0===e&&(e={}),{options:e,fn(t){const{x:n,y:i,placement:s,rects:r,middlewareData:a}=t,{offset:o=0,mainAxis:l=!0,crossAxis:c=!0}=Fi(e,t),h={x:n,y:i},u=Gi(s),d=Vi(u);let p=h[d],m=h[u];const f=Fi(o,t),g="number"==typeof f?{mainAxis:f,crossAxis:0}:{mainAxis:0,crossAxis:0,...f};if(l){const e="y"===d?"height":"width",t=r.reference[d]-r.floating[e]+g.mainAxis,n=r.reference[d]+r.reference[e]-g.mainAxis;p<t?p=t:p>n&&(p=n)}if(c){var v,x;const e="y"===d?"width":"height",t=rs.has(Bi(s)),n=r.reference[u]-r.floating[e]+(t&&(null==(v=a.offset)?void 0:v[u])||0)+(t?0:g.crossAxis),i=r.reference[u]+r.reference[e]+(t?0:(null==(x=a.offset)?void 0:x[u])||0)-(t?g.crossAxis:0);m<n?m=n:m>i&&(m=i)}return{[d]:p,[u]:m}}}};var ir="undefined"!=typeof document?n.useLayoutEffect:function(){};function sr(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("function"==typeof e&&e.toString()===t.toString())return!0;let n,i,s;if(e&&t&&"object"==typeof e){if(Array.isArray(e)){if(n=e.length,n!==t.length)return!1;for(i=n;0!==i--;)if(!sr(e[i],t[i]))return!1;return!0}if(s=Object.keys(e),n=s.length,n!==Object.keys(t).length)return!1;for(i=n;0!==i--;)if(!{}.hasOwnProperty.call(t,s[i]))return!1;for(i=n;0!==i--;){const n=s[i];if(!("_owner"===n&&e.$$typeof||sr(e[n],t[n])))return!1}return!0}return e!=e&&t!=t}function rr(e){return"undefined"==typeof window?1:(e.ownerDocument.defaultView||window).devicePixelRatio||1}function ar(e,t){const n=rr(e);return Math.round(t*n)/n}function or(e){const t=n.useRef(e);return ir(()=>{t.current=e}),t}const lr=e=>({name:"arrow",options:e,fn(t){const{element:n,padding:i}="function"==typeof e?e(t):e;return n&&(s=n,{}.hasOwnProperty.call(s,"current"))?null!=n.current?tr({element:n.current,padding:i}).fn(t):{}:n?tr({element:n,padding:i}).fn(t):{};var s}}),cr=(e,t)=>({...Ks(e),options:[e,t]}),hr=(e,t)=>({...nr(e),options:[e,t]}),ur=(e,t)=>({...Js(e),options:[e,t]}),dr=(e,t)=>({...Qs(e),options:[e,t]}),pr=(e,t)=>({...er(e),options:[e,t]}),mr=(e,t)=>({...lr(e),options:[e,t]});var fr=n.forwardRef((e,t)=>{const{children:n,width:i=10,height:s=5,...r}=e;return at.jsx(yi.svg,{...r,ref:t,width:i,height:s,viewBox:"0 0 30 10",preserveAspectRatio:"none",children:e.asChild?n:at.jsx("polygon",{points:"0,0 30,0 15,10"})})});fr.displayName="Arrow";var gr=fr,vr="Popper",[xr,yr]=di(vr),[_r,br]=xr(vr),wr=e=>{const{__scopePopper:t,children:i}=e,[s,r]=n.useState(null);return at.jsx(_r,{scope:t,anchor:s,onAnchorChange:r,children:i})};wr.displayName=vr;var Sr="PopperAnchor",Mr=n.forwardRef((e,t)=>{const{__scopePopper:i,virtualRef:s,...r}=e,a=br(Sr,i),o=n.useRef(null),l=ui(t,o);return n.useEffect(()=>{a.onAnchorChange((null==s?void 0:s.current)||o.current)}),s?null:at.jsx(yi.div,{...r,ref:l})});Mr.displayName=Sr;var Tr="PopperContent",[Er,Cr]=xr(Tr),Ar=n.forwardRef((e,t)=>{var s,r,a,o,l,c;const{__scopePopper:h,side:u="bottom",sideOffset:d=0,align:p="center",alignOffset:m=0,arrowPadding:f=0,avoidCollisions:g=!0,collisionBoundary:v=[],collisionPadding:x=0,sticky:y="partial",hideWhenDetached:_=!1,updatePositionStrategy:b="optimized",onPlaced:w,...S}=e,M=br(Tr,h),[T,E]=n.useState(null),C=ui(t,e=>E(e)),[A,N]=n.useState(null),R=function(e){const[t,i]=n.useState(void 0);return Ci(()=>{if(e){i({width:e.offsetWidth,height:e.offsetHeight});const t=new ResizeObserver(t=>{if(!Array.isArray(t))return;if(!t.length)return;const n=t[0];let s,r;if("borderBoxSize"in n){const e=n.borderBoxSize,t=Array.isArray(e)?e[0]:e;s=t.inlineSize,r=t.blockSize}else s=e.offsetWidth,r=e.offsetHeight;i({width:s,height:r})});return t.observe(e,{box:"border-box"}),()=>t.unobserve(e)}i(void 0)},[e]),t}(A),P=(null==R?void 0:R.width)??0,I=(null==R?void 0:R.height)??0,j=u+("center"!==p?"-"+p:""),D="number"==typeof x?x:{top:0,right:0,bottom:0,left:0,...x},k=Array.isArray(v)?v:[v],L=k.length>0,O={padding:D,boundary:k.filter(Ir),altBoundary:L},{refs:U,floatingStyles:F,placement:B,isPositioned:z,middlewareData:V}=function(e){void 0===e&&(e={});const{placement:t="bottom",strategy:s="absolute",middleware:r=[],platform:a,elements:{reference:o,floating:l}={},transform:c=!0,whileElementsMounted:h,open:u}=e,[d,p]=n.useState({x:0,y:0,strategy:s,placement:t,middlewareData:{},isPositioned:!1}),[m,f]=n.useState(r);sr(m,r)||f(r);const[g,v]=n.useState(null),[x,y]=n.useState(null),_=n.useCallback(e=>{e!==M.current&&(M.current=e,v(e))},[]),b=n.useCallback(e=>{e!==T.current&&(T.current=e,y(e))},[]),w=o||g,S=l||x,M=n.useRef(null),T=n.useRef(null),E=n.useRef(d),C=null!=h,A=or(h),N=or(a),R=or(u),P=n.useCallback(()=>{if(!M.current||!T.current)return;const e={placement:t,strategy:s,middleware:m};N.current&&(e.platform=N.current),((e,t,n)=>{const i=new Map,s={platform:Ys,...n},r={...s.platform,_c:i};return(async(e,t,n)=>{const{placement:i="bottom",strategy:s="absolute",middleware:r=[],platform:a}=n,o=r.filter(Boolean),l=await(null==a.isRTL?void 0:a.isRTL(t));let c=await a.getElementRects({reference:e,floating:t,strategy:s}),{x:h,y:u}=ts(c,i,l),d=i,p={},m=0;for(let f=0;f<o.length;f++){const{name:n,fn:r}=o[f],{x:g,y:v,data:x,reset:y}=await r({x:h,y:u,initialPlacement:i,placement:d,strategy:s,middlewareData:p,rects:c,platform:a,elements:{reference:e,floating:t}});h=null!=g?g:h,u=null!=v?v:u,p={...p,[n]:{...p[n],...x}},y&&m<=50&&(m++,"object"==typeof y&&(y.placement&&(d=y.placement),y.rects&&(c=!0===y.rects?await a.getElementRects({reference:e,floating:t,strategy:s}):y.rects),({x:h,y:u}=ts(c,d,l))),f=-1)}return{x:h,y:u,placement:d,strategy:s,middlewareData:p}})(e,t,{...s,platform:r})})(M.current,T.current,e).then(e=>{const t={...e,isPositioned:!1!==R.current};I.current&&!sr(E.current,t)&&(E.current=t,i.flushSync(()=>{p(t)}))})},[m,t,s,N,R]);ir(()=>{!1===u&&E.current.isPositioned&&(E.current.isPositioned=!1,p(e=>({...e,isPositioned:!1})))},[u]);const I=n.useRef(!1);ir(()=>(I.current=!0,()=>{I.current=!1}),[]),ir(()=>{if(w&&(M.current=w),S&&(T.current=S),w&&S){if(A.current)return A.current(w,S,P);P()}},[w,S,P,A,C]);const j=n.useMemo(()=>({reference:M,floating:T,setReference:_,setFloating:b}),[_,b]),D=n.useMemo(()=>({reference:w,floating:S}),[w,S]),k=n.useMemo(()=>{const e={position:s,left:0,top:0};if(!D.floating)return e;const t=ar(D.floating,d.x),n=ar(D.floating,d.y);return c?{...e,transform:"translate("+t+"px, "+n+"px)",...rr(D.floating)>=1.5&&{willChange:"transform"}}:{position:s,left:t,top:n}},[s,c,D.floating,d.x,d.y]);return n.useMemo(()=>({...d,update:P,refs:j,elements:D,floatingStyles:k}),[d,P,j,D,k])}({strategy:"fixed",placement:j,whileElementsMounted:(...e)=>function(e,t,n,i){void 0===i&&(i={});const{ancestorScroll:s=!0,ancestorResize:r=!0,elementResize:a="function"==typeof ResizeObserver,layoutShift:o="function"==typeof IntersectionObserver,animationFrame:c=!1}=i,h=Ds(e),u=s||r?[...h?Ps(h):[],...Ps(t)]:[];u.forEach(e=>{s&&e.addEventListener("scroll",n,{passive:!0}),r&&e.addEventListener("resize",n)});const d=h&&o?function(e,t){let n,i=null;const s=cs(e);function r(){var e;clearTimeout(n),null==(e=i)||e.disconnect(),i=null}return function a(o,c){void 0===o&&(o=!1),void 0===c&&(c=1),r();const h=e.getBoundingClientRect(),{left:u,top:d,width:p,height:m}=h;if(o||t(),!p||!m)return;const f={rootMargin:-Di(d)+"px "+-Di(s.clientWidth-(u+p))+"px "+-Di(s.clientHeight-(d+m))+"px "+-Di(u)+"px",threshold:Ii(0,Pi(1,c))||1};let g=!0;function v(t){const i=t[0].intersectionRatio;if(i!==c){if(!g)return a();i?a(!1,i):n=setTimeout(()=>{a(!1,1e-7)},1e3)}1!==i||$s(h,e.getBoundingClientRect())||a(),g=!1}try{i=new IntersectionObserver(v,{...f,root:s.ownerDocument})}catch(l){i=new IntersectionObserver(v,f)}i.observe(e)}(!0),r}(h,n):null;let p,m=-1,f=null;a&&(f=new ResizeObserver(e=>{let[i]=e;i&&i.target===h&&f&&(f.unobserve(t),cancelAnimationFrame(m),m=requestAnimationFrame(()=>{var e;null==(e=f)||e.observe(t)})),n()}),h&&!c&&f.observe(h),f.observe(t));let g=c?Us(e):null;return c&&function t(){const i=Us(e);g&&!$s(g,i)&&n(),g=i,p=requestAnimationFrame(t)}(),n(),()=>{var e;u.forEach(e=>{s&&e.removeEventListener("scroll",n),r&&e.removeEventListener("resize",n)}),null==d||d(),null==(e=f)||e.disconnect(),f=null,c&&cancelAnimationFrame(p)}}(...e,{animationFrame:"always"===b}),elements:{reference:M.anchor},middleware:[(H={mainAxis:d+I,alignmentAxis:m},{...Zs(H),options:[H,undefined]}),g&&cr({mainAxis:!0,crossAxis:!1,limiter:"partial"===y?hr():void 0,...O}),g&&ur({...O}),dr({...O,apply:({elements:e,rects:t,availableWidth:n,availableHeight:i})=>{const{width:s,height:r}=t.reference,a=e.floating.style;a.setProperty("--radix-popper-available-width",`${n}px`),a.setProperty("--radix-popper-available-height",`${i}px`),a.setProperty("--radix-popper-anchor-width",`${s}px`),a.setProperty("--radix-popper-anchor-height",`${r}px`)}}),A&&mr({element:A,padding:f}),jr({arrowWidth:P,arrowHeight:I}),_&&pr({strategy:"referenceHidden",...O})]});var H;const[W,G]=Dr(B),q=_i(w);Ci(()=>{z&&(null==q||q())},[z,q]);const X=null==(s=V.arrow)?void 0:s.x,Y=null==(r=V.arrow)?void 0:r.y,$=0!==(null==(a=V.arrow)?void 0:a.centerOffset),[Z,K]=n.useState();return Ci(()=>{T&&K(window.getComputedStyle(T).zIndex)},[T]),at.jsx("div",{ref:U.setFloating,"data-radix-popper-content-wrapper":"",style:{...F,transform:z?F.transform:"translate(0, -200%)",minWidth:"max-content",zIndex:Z,"--radix-popper-transform-origin":[null==(o=V.transformOrigin)?void 0:o.x,null==(l=V.transformOrigin)?void 0:l.y].join(" "),...(null==(c=V.hide)?void 0:c.referenceHidden)&&{visibility:"hidden",pointerEvents:"none"}},dir:e.dir,children:at.jsx(Er,{scope:h,placedSide:W,onArrowChange:N,arrowX:X,arrowY:Y,shouldHideArrow:$,children:at.jsx(yi.div,{"data-side":W,"data-align":G,...S,ref:C,style:{...S.style,animation:z?void 0:"none"}})})})});Ar.displayName=Tr;var Nr="PopperArrow",Rr={top:"bottom",right:"left",bottom:"top",left:"right"},Pr=n.forwardRef(function(e,t){const{__scopePopper:n,...i}=e,s=Cr(Nr,n),r=Rr[s.placedSide];return at.jsx("span",{ref:s.onArrowChange,style:{position:"absolute",left:s.arrowX,top:s.arrowY,[r]:0,transformOrigin:{top:"",right:"0 0",bottom:"center 0",left:"100% 0"}[s.placedSide],transform:{top:"translateY(100%)",right:"translateY(50%) rotate(90deg) translateX(-50%)",bottom:"rotate(180deg)",left:"translateY(50%) rotate(-90deg) translateX(50%)"}[s.placedSide],visibility:s.shouldHideArrow?"hidden":void 0},children:at.jsx(gr,{...i,ref:t,style:{...i.style,display:"block"}})})});function Ir(e){return null!==e}Pr.displayName=Nr;var jr=e=>({name:"transformOrigin",options:e,fn(t){var n,i,s;const{placement:r,rects:a,middlewareData:o}=t,l=0!==(null==(n=o.arrow)?void 0:n.centerOffset),c=l?0:e.arrowWidth,h=l?0:e.arrowHeight,[u,d]=Dr(r),p={start:"0%",center:"50%",end:"100%"}[d],m=((null==(i=o.arrow)?void 0:i.x)??0)+c/2,f=((null==(s=o.arrow)?void 0:s.y)??0)+h/2;let g="",v="";return"bottom"===u?(g=l?p:`${m}px`,v=-h+"px"):"top"===u?(g=l?p:`${m}px`,v=`${a.floating.height+h}px`):"right"===u?(g=-h+"px",v=l?p:`${f}px`):"left"===u&&(g=`${a.floating.width+h}px`,v=l?p:`${f}px`),{data:{x:g,y:v}}}});function Dr(e){const[t,n="center"]=e.split("-");return[t,n]}var kr=wr,Lr=Mr,Or=Ar,Ur=Pr,Fr=n.forwardRef((e,t)=>{var i;const{container:s,...a}=e,[o,l]=n.useState(!1);Ci(()=>l(!0),[]);const c=s||o&&(null==(i=null==globalThis?void 0:globalThis.document)?void 0:i.body);return c?r.createPortal(at.jsx(yi.div,{...a,ref:t}),c):null});Fr.displayName="Portal";var Br=e=>{const{present:t,children:i}=e,s=function(e){const[t,i]=n.useState(),s=n.useRef(null),r=n.useRef(e),a=n.useRef("none"),o=e?"mounted":"unmounted",[l,c]=function(e,t){return n.useReducer((e,n)=>t[e][n]??e,e)}(o,{mounted:{UNMOUNT:"unmounted",ANIMATION_OUT:"unmountSuspended"},unmountSuspended:{MOUNT:"mounted",ANIMATION_END:"unmounted"},unmounted:{MOUNT:"mounted"}});return n.useEffect(()=>{const e=zr(s.current);a.current="mounted"===l?e:"none"},[l]),Ci(()=>{const t=s.current,n=r.current;if(n!==e){const i=a.current,s=zr(t);e?c("MOUNT"):"none"===s||"none"===(null==t?void 0:t.display)?c("UNMOUNT"):c(n&&i!==s?"ANIMATION_OUT":"UNMOUNT"),r.current=e}},[e,c]),Ci(()=>{if(t){let e;const n=t.ownerDocument.defaultView??window,i=i=>{const a=zr(s.current).includes(i.animationName);if(i.target===t&&a&&(c("ANIMATION_END"),!r.current)){const i=t.style.animationFillMode;t.style.animationFillMode="forwards",e=n.setTimeout(()=>{"forwards"===t.style.animationFillMode&&(t.style.animationFillMode=i)})}},o=e=>{e.target===t&&(a.current=zr(s.current))};return t.addEventListener("animationstart",o),t.addEventListener("animationcancel",i),t.addEventListener("animationend",i),()=>{n.clearTimeout(e),t.removeEventListener("animationstart",o),t.removeEventListener("animationcancel",i),t.removeEventListener("animationend",i)}}c("ANIMATION_END")},[t,c]),{isPresent:["mounted","unmountSuspended"].includes(l),ref:n.useCallback(e=>{s.current=e?getComputedStyle(e):null,i(e)},[])}}(t),r="function"==typeof i?i({present:s.isPresent}):n.Children.only(i),a=ui(s.ref,function(e){var t,n;let i=null==(t=Object.getOwnPropertyDescriptor(e.props,"ref"))?void 0:t.get,s=i&&"isReactWarning"in i&&i.isReactWarning;return s?e.ref:(i=null==(n=Object.getOwnPropertyDescriptor(e,"ref"))?void 0:n.get,s=i&&"isReactWarning"in i&&i.isReactWarning,s?e.props.ref:e.props.ref||e.ref)}(r));return"function"==typeof i||s.isPresent?n.cloneElement(r,{ref:a}):null};function zr(e){return(null==e?void 0:e.animationName)||"none"}Br.displayName="Presence";var Vr=s[" useInsertionEffect ".trim().toString()]||Ci;var Hr=Object.freeze({position:"absolute",border:0,width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",wordWrap:"normal"}),Wr=n.forwardRef((e,t)=>at.jsx(yi.span,{...e,ref:t,style:{...Hr,...e.style}}));Wr.displayName="VisuallyHidden";var Gr=Wr,[qr,Xr]=di("Tooltip",[yr]),Yr=yr(),$r="TooltipProvider",Zr=700,Kr="tooltip.open",[Jr,Qr]=qr($r),ea=e=>{const{__scopeTooltip:t,delayDuration:i=Zr,skipDelayDuration:s=300,disableHoverableContent:r=!1,children:a}=e,o=n.useRef(!0),l=n.useRef(!1),c=n.useRef(0);return n.useEffect(()=>{const e=c.current;return()=>window.clearTimeout(e)},[]),at.jsx(Jr,{scope:t,isOpenDelayedRef:o,delayDuration:i,onOpen:n.useCallback(()=>{window.clearTimeout(c.current),o.current=!1},[]),onClose:n.useCallback(()=>{window.clearTimeout(c.current),c.current=window.setTimeout(()=>o.current=!0,s)},[s]),isPointerInTransitRef:l,onPointerInTransitChange:n.useCallback(e=>{l.current=e},[]),disableHoverableContent:r,children:a})};ea.displayName=$r;var ta="Tooltip",[na,ia]=qr(ta),sa=e=>{const{__scopeTooltip:t,children:i,open:s,defaultOpen:r,onOpenChange:a,disableHoverableContent:o,delayDuration:l}=e,c=Qr(ta,e.__scopeTooltip),h=Yr(t),[u,d]=n.useState(null),p=function(e){const[t,i]=n.useState(Ai());return Ci(()=>{i(e=>e??String(Ni++))},[e]),t?`radix-${t}`:""}(),m=n.useRef(0),f=o??c.disableHoverableContent,g=l??c.delayDuration,v=n.useRef(!1),[x,y]=function({prop:e,defaultProp:t,onChange:i=()=>{},caller:s}){const[r,a,o]=function({defaultProp:e,onChange:t}){const[i,s]=n.useState(e),r=n.useRef(i),a=n.useRef(t);return Vr(()=>{a.current=t},[t]),n.useEffect(()=>{var e;r.current!==i&&(null==(e=a.current)||e.call(a,i),r.current=i)},[i,r]),[i,s,a]}({defaultProp:t,onChange:i}),l=void 0!==e,c=l?e:r;{const t=n.useRef(void 0!==e);n.useEffect(()=>{t.current,t.current=l},[l,s])}const h=n.useCallback(t=>{var n;if(l){const i=function(e){return"function"==typeof e}(t)?t(e):t;i!==e&&(null==(n=o.current)||n.call(o,i))}else a(t)},[l,e,a,o]);return[c,h]}({prop:s,defaultProp:r??!1,onChange:e=>{e?(c.onOpen(),document.dispatchEvent(new CustomEvent(Kr))):c.onClose(),null==a||a(e)},caller:ta}),_=n.useMemo(()=>x?v.current?"delayed-open":"instant-open":"closed",[x]),b=n.useCallback(()=>{window.clearTimeout(m.current),m.current=0,v.current=!1,y(!0)},[y]),w=n.useCallback(()=>{window.clearTimeout(m.current),m.current=0,y(!1)},[y]),S=n.useCallback(()=>{window.clearTimeout(m.current),m.current=window.setTimeout(()=>{v.current=!0,y(!0),m.current=0},g)},[g,y]);return n.useEffect(()=>()=>{m.current&&(window.clearTimeout(m.current),m.current=0)},[]),at.jsx(kr,{...h,children:at.jsx(na,{scope:t,contentId:p,open:x,stateAttribute:_,trigger:u,onTriggerChange:d,onTriggerEnter:n.useCallback(()=>{c.isOpenDelayedRef.current?S():b()},[c.isOpenDelayedRef,S,b]),onTriggerLeave:n.useCallback(()=>{f?w():(window.clearTimeout(m.current),m.current=0)},[w,f]),onOpen:b,onClose:w,disableHoverableContent:f,children:i})})};sa.displayName=ta;var ra="TooltipTrigger",aa=n.forwardRef((e,t)=>{const{__scopeTooltip:i,...s}=e,r=ia(ra,i),a=Qr(ra,i),o=Yr(i),l=ui(t,n.useRef(null),r.onTriggerChange),c=n.useRef(!1),h=n.useRef(!1),u=n.useCallback(()=>c.current=!1,[]);return n.useEffect(()=>()=>document.removeEventListener("pointerup",u),[u]),at.jsx(Lr,{asChild:!0,...o,children:at.jsx(yi.button,{"aria-describedby":r.open?r.contentId:void 0,"data-state":r.stateAttribute,...s,ref:l,onPointerMove:li(e.onPointerMove,e=>{"touch"!==e.pointerType&&(h.current||a.isPointerInTransitRef.current||(r.onTriggerEnter(),h.current=!0))}),onPointerLeave:li(e.onPointerLeave,()=>{r.onTriggerLeave(),h.current=!1}),onPointerDown:li(e.onPointerDown,()=>{r.open&&r.onClose(),c.current=!0,document.addEventListener("pointerup",u,{once:!0})}),onFocus:li(e.onFocus,()=>{c.current||r.onOpen()}),onBlur:li(e.onBlur,r.onClose),onClick:li(e.onClick,r.onClose)})})});aa.displayName=ra;var oa="TooltipPortal",[la,ca]=qr(oa,{forceMount:void 0}),ha=e=>{const{__scopeTooltip:t,forceMount:n,children:i,container:s}=e,r=ia(oa,t);return at.jsx(la,{scope:t,forceMount:n,children:at.jsx(Br,{present:n||r.open,children:at.jsx(Fr,{asChild:!0,container:s,children:i})})})};ha.displayName=oa;var ua="TooltipContent",da=n.forwardRef((e,t)=>{const n=ca(ua,e.__scopeTooltip),{forceMount:i=n.forceMount,side:s="top",...r}=e,a=ia(ua,e.__scopeTooltip);return at.jsx(Br,{present:i||a.open,children:a.disableHoverableContent?at.jsx(va,{side:s,...r,ref:t}):at.jsx(pa,{side:s,...r,ref:t})})}),pa=n.forwardRef((e,t)=>{const i=ia(ua,e.__scopeTooltip),s=Qr(ua,e.__scopeTooltip),r=n.useRef(null),a=ui(t,r),[o,l]=n.useState(null),{trigger:c,onClose:h}=i,u=r.current,{onPointerInTransitChange:d}=s,p=n.useCallback(()=>{l(null),d(!1)},[d]),m=n.useCallback((e,t)=>{const n=e.currentTarget,i={x:e.clientX,y:e.clientY},s=function(e,t,n=5){const i=[];switch(t){case"top":i.push({x:e.x-n,y:e.y+n},{x:e.x+n,y:e.y+n});break;case"bottom":i.push({x:e.x-n,y:e.y-n},{x:e.x+n,y:e.y-n});break;case"left":i.push({x:e.x+n,y:e.y-n},{x:e.x+n,y:e.y+n});break;case"right":i.push({x:e.x-n,y:e.y-n},{x:e.x-n,y:e.y+n})}return i}(i,function(e,t){const n=Math.abs(t.top-e.y),i=Math.abs(t.bottom-e.y),s=Math.abs(t.right-e.x),r=Math.abs(t.left-e.x);switch(Math.min(n,i,s,r)){case r:return"left";case s:return"right";case n:return"top";case i:return"bottom";default:throw new Error("unreachable")}}(i,n.getBoundingClientRect())),r=function(e){const t=e.slice();return t.sort((e,t)=>e.x<t.x?-1:e.x>t.x?1:e.y<t.y?-1:e.y>t.y?1:0),function(e){if(e.length<=1)return e.slice();const t=[];for(let i=0;i<e.length;i++){const n=e[i];for(;t.length>=2;){const e=t[t.length-1],i=t[t.length-2];if(!((e.x-i.x)*(n.y-i.y)>=(e.y-i.y)*(n.x-i.x)))break;t.pop()}t.push(n)}t.pop();const n=[];for(let i=e.length-1;i>=0;i--){const t=e[i];for(;n.length>=2;){const e=n[n.length-1],i=n[n.length-2];if(!((e.x-i.x)*(t.y-i.y)>=(e.y-i.y)*(t.x-i.x)))break;n.pop()}n.push(t)}return n.pop(),1===t.length&&1===n.length&&t[0].x===n[0].x&&t[0].y===n[0].y?t:t.concat(n)}(t)}([...s,...function(e){const{top:t,right:n,bottom:i,left:s}=e;return[{x:s,y:t},{x:n,y:t},{x:n,y:i},{x:s,y:i}]}(t.getBoundingClientRect())]);l(r),d(!0)},[d]);return n.useEffect(()=>()=>p(),[p]),n.useEffect(()=>{if(c&&u){const e=e=>m(e,u),t=e=>m(e,c);return c.addEventListener("pointerleave",e),u.addEventListener("pointerleave",t),()=>{c.removeEventListener("pointerleave",e),u.removeEventListener("pointerleave",t)}}},[c,u,m,p]),n.useEffect(()=>{if(o){const e=e=>{const t=e.target,n={x:e.clientX,y:e.clientY},i=(null==c?void 0:c.contains(t))||(null==u?void 0:u.contains(t)),s=!function(e,t){const{x:n,y:i}=e;let s=!1;for(let r=0,a=t.length-1;r<t.length;a=r++){const e=t[r],o=t[a],l=e.x,c=e.y,h=o.x,u=o.y;c>i!=u>i&&n<(h-l)*(i-c)/(u-c)+l&&(s=!s)}return s}(n,o);i?p():s&&(p(),h())};return document.addEventListener("pointermove",e),()=>document.removeEventListener("pointermove",e)}},[c,u,o,h,p]),at.jsx(va,{...e,ref:a})}),[ma,fa]=qr(ta,{isInside:!1}),ga=vi("TooltipContent"),va=n.forwardRef((e,t)=>{const{__scopeTooltip:i,children:s,"aria-label":r,onEscapeKeyDown:a,onPointerDownOutside:o,...l}=e,c=ia(ua,i),h=Yr(i),{onClose:u}=c;return n.useEffect(()=>(document.addEventListener(Kr,u),()=>document.removeEventListener(Kr,u)),[u]),n.useEffect(()=>{if(c.trigger){const e=e=>{const t=e.target;(null==t?void 0:t.contains(c.trigger))&&u()};return window.addEventListener("scroll",e,{capture:!0}),()=>window.removeEventListener("scroll",e,{capture:!0})}},[c.trigger,u]),at.jsx(Mi,{asChild:!0,disableOutsidePointerEvents:!1,onEscapeKeyDown:a,onPointerDownOutside:o,onFocusOutside:e=>e.preventDefault(),onDismiss:u,children:at.jsxs(Or,{"data-state":c.stateAttribute,...h,...l,ref:t,style:{...l.style,"--radix-tooltip-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-tooltip-content-available-width":"var(--radix-popper-available-width)","--radix-tooltip-content-available-height":"var(--radix-popper-available-height)","--radix-tooltip-trigger-width":"var(--radix-popper-anchor-width)","--radix-tooltip-trigger-height":"var(--radix-popper-anchor-height)"},children:[at.jsx(ga,{children:s}),at.jsx(ma,{scope:i,isInside:!0,children:at.jsx(Gr,{id:c.contentId,role:"tooltip",children:r||s})})]})})});da.displayName=ua;var xa="TooltipArrow",ya=n.forwardRef((e,t)=>{const{__scopeTooltip:n,...i}=e,s=Yr(n);return fa(xa,n).isInside?null:at.jsx(Ur,{...s,...i,ref:t})});ya.displayName=xa;var _a=ea,ba=sa,wa=aa,Sa=ha,Ma=da,Ta=ya;const Ea=({children:e,content:t,side:n="top",align:i="center",delayDuration:s=500,className:r="",ariaLabel:a})=>at.jsx(_a,{children:at.jsxs(ba,{delayDuration:s,children:[at.jsx(wa,{asChild:!0,children:at.jsx("div",{className:r,tabIndex:0,role:"button","aria-label":a||t,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||e.preventDefault()},children:e})}),at.jsx(Sa,{children:at.jsxs(Ma,{side:n,align:i,sideOffset:5,className:"z-50 px-3 py-2 text-sm text-white bg-gray-900/95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-700/50 max-w-xs break-words animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 md:max-w-sm lg:max-w-md","aria-describedby":"tooltip-content",children:[at.jsx("span",{id:"tooltip-content",className:"leading-relaxed",children:t}),at.jsx(Ta,{className:"fill-gray-900/95"})]})})]})});class Ca extends a.Component{constructor(e){super(e),t(this,"resetError",()=>{this.setState({hasError:!1,error:null,errorInfo:null})}),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){"undefined"!=typeof window&&window.gtag&&window.gtag("event","exception",{description:e.message,fatal:!0}),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?this.props.fallback?at.jsx(this.props.fallback,{error:this.state.error,resetError:this.resetError}):at.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-950 via-red-900 to-red-800 flex items-center justify-center p-4",children:at.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 text-center",children:[at.jsx("div",{className:"text-red-400 mb-6",children:at.jsx(ce,{size:64,className:"mx-auto"})}),at.jsx("h1",{className:"text-2xl font-bold text-white mb-4",children:"Oops! Something went wrong"}),at.jsx("p",{className:"text-red-200 mb-6",children:"We're sorry, but something went wrong."}),!1,at.jsxs("div",{className:"space-y-3",children:[at.jsxs("button",{onClick:this.resetError,className:"w-full px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all flex items-center justify-center space-x-2",children:[at.jsx(he,{size:20}),at.jsx("span",{children:"Try Again"})]}),at.jsxs("button",{onClick:()=>window.location.href="/",className:"w-full px-6 py-3 bg-white/20 text-white rounded-xl font-semibold hover:bg-white/30 transition-all flex items-center justify-center space-x-2",children:[at.jsx(ue,{size:20}),at.jsx("span",{children:"Go Home"})]})]}),at.jsx("p",{className:"text-red-300 text-sm mt-6",children:"If this problem persists, please contact support."})]})}):this.props.children}}const Aa=({messages:e,onDismiss:t})=>at.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:e.map(e=>at.jsx(Na,{toast:e,onDismiss:t},e.id))}),Na=({toast:e,onDismiss:t})=>{const[i,s]=n.useState(!1),[r,a]=n.useState(!1),[o,l]=n.useState(!1);n.useEffect(()=>{if(s(!0),!e.showIntroControls){const n=setTimeout(()=>{o||(s(!1),setTimeout(()=>t(e.id),300))},e.duration||4e3);return()=>clearTimeout(n)}},[e.id,e.duration,t,e.showIntroControls,o]);const c=()=>{s(!1),setTimeout(()=>t(e.id),300)};return at.jsx("div",{className:`${(()=>{switch(e.type){case"achievement":return"bg-gradient-to-r from-yellow-600 to-orange-600";case"success":return"bg-gradient-to-r from-green-600 to-emerald-600";case"warning":return"bg-gradient-to-r from-orange-600 to-red-600";case"fun":return"bg-gradient-to-r from-purple-600 to-pink-600";default:return"bg-gradient-to-r from-blue-600 to-indigo-600"}})()} text-white rounded-lg shadow-lg border border-white/20 backdrop-blur-sm transform transition-all duration-300 ${i?"translate-x-0 opacity-100":"translate-x-full opacity-0"}`,style:{minWidth:"320px",maxWidth:"420px"},onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:at.jsx("div",{className:"p-4",children:at.jsxs("div",{className:"flex items-start space-x-3",children:[at.jsx("div",{className:"flex-shrink-0 mt-0.5",children:(()=>{if(e.icon)return e.icon;switch(e.type){case"achievement":return at.jsx(te,{className:"w-5 h-5 text-yellow-400"});case"success":return at.jsx(ee,{className:"w-5 h-5 text-green-400"});case"warning":return at.jsx(ge,{className:"w-5 h-5 text-orange-400"});case"fun":return at.jsx(fe,{className:"w-5 h-5 text-purple-400"});default:return at.jsx(me,{className:"w-5 h-5 text-blue-400"})}})()}),at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsx("h4",{className:"text-sm font-semibold mb-1",children:e.title}),at.jsx("p",{className:"text-xs text-white/90 leading-relaxed",children:e.message}),e.action&&at.jsx("button",{onClick:e.action.onClick,className:"mt-2 px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs font-medium transition-colors",children:e.action.label}),e.showIntroControls&&at.jsxs("div",{className:"mt-3 space-y-3 border-t border-white/20 pt-3",children:[at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("button",{onClick:()=>a(!r),className:"w-4 h-4 rounded border-2 flex items-center justify-center transition-colors "+(r?"bg-white border-white":"border-white/60 hover:border-white"),children:r&&at.jsx(de,{className:"w-2.5 h-2.5 text-gray-900"})}),at.jsx("label",{onClick:()=>a(!r),className:"text-xs text-white/80 cursor-pointer hover:text-white transition-colors",children:"Don't show me again"})]}),at.jsxs("div",{className:"flex space-x-2",children:[at.jsx("button",{onClick:()=>{r&&e.onDontShowAgain?e.onDontShowAgain():e.onSkipIntro&&e.onSkipIntro(),s(!1),setTimeout(()=>t(e.id),300)},className:"flex-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-xs font-medium transition-colors",children:"Skip Intro"}),at.jsx("button",{onClick:c,className:"px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs font-medium transition-colors",children:"Dismiss"})]})]})]}),at.jsx("button",{onClick:c,className:"flex-shrink-0 text-white/70 hover:text-white transition-colors p-1 hover:bg-white/10 rounded",title:"Dismiss",children:at.jsx(pe,{className:"w-4 h-4"})})]})})})},Ra=new class{constructor(){t(this,"gameId",null),t(this,"playerId",null),t(this,"listeners",{}),t(this,"presenceRef",null),t(this,"messagesRef",null),t(this,"stateRef",null),t(this,"eventsRef",null),t(this,"isConnected",!1)}async initializeGame(e,t){this.gameId=e,this.playerId=t.id,this.presenceRef=X(ti,`games/${e}/presence/${t.id}`),await Y(this.presenceRef,{id:t.id,name:t.name,characterId:t.characterId,isOnline:!0,lastSeen:Date.now(),status:"idle"});const n=X(ti,`games/${e}/presence/${t.id}`);await $(n).update({isOnline:!1,lastSeen:Date.now()}),this.setupRealtimeListeners(),this.isConnected=!0}setupRealtimeListeners(){if(!this.gameId)return;const e=X(ti,`games/${this.gameId}/presence`);this.listeners.presence=Z(e,e=>{const t=e.val();this.handlePresenceUpdate(t)});const t=X(ti,`games/${this.gameId}/messages`);this.listeners.messages=Z(t,e=>{const t=e.val();this.handleMessageUpdate(t)});const n=X(ti,`games/${this.gameId}/sharedState`);this.listeners.state=Z(n,e=>{const t=e.val();this.handleStateUpdate(t)});const i=X(ti,`games/${this.gameId}/events`);this.listeners.events=Z(i,e=>{const t=e.val();this.handleEventUpdate(t)})}async sendMessage(e){if(!this.gameId||!this.isConnected)return;const t=X(ti,`games/${this.gameId}/messages`),n=K(t);await Y(n,{...e,id:n.key,timestamp:Date.now()})}async updatePresence(e,t){if(!this.gameId||!this.playerId||!this.isConnected)return;const n={status:e,lastSeen:Date.now()};t&&(n.position=t),await J(X(ti,`games/${this.gameId}/presence/${this.playerId}`),n)}async updateSharedState(e){if(!this.gameId||!this.isConnected)return;const t=X(ti,`games/${this.gameId}/sharedState`);await J(t,{...e,lastUpdated:Date.now()})}async broadcastEvent(e){if(!this.gameId||!this.isConnected)return;const t=X(ti,`games/${this.gameId}/events`),n=K(t);await Y(n,{...e,timestamp:Date.now()})}async startCombat(e){if(this.gameId&&this.isConnected){await this.updateSharedState({combatState:{isActive:!0,participants:e.participants,currentTurn:e.currentTurn,round:1}}),await this.broadcastEvent({type:"combat_start",data:e});for(const t of e.participants)await J(X(ti,`games/${this.gameId}/presence/${t}`),{status:"in-combat",lastSeen:Date.now()})}}async endCombat(e){if(!this.gameId||!this.isConnected)return;await this.updateSharedState({combatState:{isActive:!1,participants:[],currentTurn:null,round:0}}),await this.broadcastEvent({type:"combat_end",data:e});const t=X(ti,`games/${this.gameId}/presence`),n=await Q(t);if(n.exists()){const e=n.val(),i={};Object.keys(e).forEach(e=>{i[`${e}/status`]="idle",i[`${e}/lastSeen`]=Date.now()}),await J(t,i)}}async updatePlayerPosition(e){this.gameId&&this.playerId&&this.isConnected&&(await this.updatePresence("exploring",e),await this.broadcastEvent({type:"movement",data:{playerId:this.playerId,position:e,timestamp:Date.now()}}))}async getOnlinePlayers(){if(!this.gameId)return[];const e=X(ti,`games/${this.gameId}/presence`),t=await Q(e);if(!t.exists())return[];const n=t.val();return Object.values(n).filter(e=>e.isOnline)}async getRecentMessages(e=50){if(!this.gameId)return[];const t=X(ti,`games/${this.gameId}/messages`),n=await Q(t);if(!n.exists())return[];const i=n.val();return Object.values(i).sort((e,t)=>t.timestamp-e.timestamp).slice(0,e)}async getSharedState(){if(!this.gameId)return null;const e=X(ti,`games/${this.gameId}/sharedState`),t=await Q(e);return t.exists()?t.val():null}handlePresenceUpdate(e){}handleMessageUpdate(e){}handleStateUpdate(e){}handleEventUpdate(e){}onPresenceUpdate(e){this.handlePresenceUpdate=e}onMessageUpdate(e){this.handleMessageUpdate=e}onStateUpdate(e){this.handleStateUpdate=e}onEventUpdate(e){this.handleEventUpdate=e}async disconnect(){this.gameId&&this.playerId&&(await J(X(ti,`games/${this.gameId}/presence/${this.playerId}`),{isOnline:!1,lastSeen:Date.now()}),Object.values(this.listeners).forEach(e=>{"function"==typeof e&&e()}),this.listeners={},this.isConnected=!1,this.gameId=null,this.playerId=null)}isGameConnected(){return this.isConnected&&null!==this.gameId}getCurrentGameId(){return this.gameId}getCurrentPlayerId(){return this.playerId}},Pa=e=>"string"!=typeof e?"":e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi,"").replace(/<embed\b[^<]*(?:(?!<\/embed>)<[^<]*)*<\/embed>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").replace(/<[^>]*>/g,"").trim(),Ia=["badword1","badword2","badword3","spam","scam","hack","crack"];class ja{constructor(e=5,n=6e4){t(this,"attempts",new Map),this.maxAttempts=e,this.windowMs=n}isAllowed(e){const t=Date.now(),n=this.attempts.get(e);return!n||t>n.resetTime?(this.attempts.set(e,{count:1,resetTime:t+this.windowMs}),!0):!(n.count>=this.maxAttempts||(n.count++,0))}reset(e){this.attempts.delete(e)}getRemainingAttempts(e){const t=this.attempts.get(e);return t?Math.max(0,this.maxAttempts-t.count):this.maxAttempts}getTimeUntilReset(e){const t=this.attempts.get(e);return t?Math.max(0,t.resetTime-Date.now()):0}}const Da="@firebase/installations",ka="0.6.9",La=`w:${ka}`,Oa="FIS_v2",Ua=new b("installations","Installations",{"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."});function Fa(e){return e instanceof w&&e.code.includes("request-failed")}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Ba({projectId:e}){return`https://firebaseinstallations.googleapis.com/v1/projects/${e}/installations`}function za(e){return{token:e.token,requestStatus:2,expiresIn:(t=e.expiresIn,Number(t.replace("s","000"))),creationTime:Date.now()};var t}async function Va(e,t){const n=(await t.json()).error;return Ua.create("request-failed",{requestName:e,serverCode:n.code,serverMessage:n.message,serverStatus:n.status})}function Ha({apiKey:e}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":e})}async function Wa(e){const t=await e();return t.status>=500&&t.status<600?e():t}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function Ga(e){return new Promise(t=>{setTimeout(t,e)})}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const qa=/^[cdef][\w-]{21}$/;function Xa(){try{const e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;const t=function(e){var t;return(t=e,btoa(String.fromCharCode(...t)).replace(/\+/g,"-").replace(/\//g,"_")).substr(0,22)}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(e);return qa.test(t)?t:""}catch(e){return""}}function Ya(e){return`${e.appName}!${e.appId}`}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $a=new Map;function Za(e,t){const n=Ya(e);Ka(n,t),function(e,t){const n=(!Ja&&"BroadcastChannel"in self&&(Ja=new BroadcastChannel("[Firebase] FID Change"),Ja.onmessage=e=>{Ka(e.data.key,e.data.fid)}),Ja);n&&n.postMessage({key:e,fid:t}),0===$a.size&&Ja&&(Ja.close(),Ja=null)}(n,t)}function Ka(e,t){const n=$a.get(e);if(n)for(const i of n)i(t)}let Ja=null;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Qa="firebase-installations-store";let eo=null;function to(){return eo||(eo=S("firebase-installations-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(Qa)}})),eo}async function no(e,t){const n=Ya(e),i=(await to()).transaction(Qa,"readwrite"),s=i.objectStore(Qa),r=await s.get(n);return await s.put(t,n),await i.done,r&&r.fid===t.fid||Za(e,t.fid),t}async function io(e){const t=Ya(e),n=(await to()).transaction(Qa,"readwrite");await n.objectStore(Qa).delete(t),await n.done}async function so(e,t){const n=Ya(e),i=(await to()).transaction(Qa,"readwrite"),s=i.objectStore(Qa),r=await s.get(n),a=t(r);return void 0===a?await s.delete(n):await s.put(a,n),await i.done,!a||r&&r.fid===a.fid||Za(e,a.fid),a}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ro(e){let t;const n=await so(e.appConfig,n=>{const i=function(e){return lo(e||{fid:Xa(),registrationStatus:0})}(n),s=function(e,t){if(0===t.registrationStatus){if(!navigator.onLine)return{installationEntry:t,registrationPromise:Promise.reject(Ua.create("app-offline"))};const n={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},i=async function(e,t){try{const n=
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */await async function({appConfig:e,heartbeatServiceProvider:t},{fid:n}){const i=Ba(e),s=Ha(e),r=t.getImmediate({optional:!0});if(r){const e=await r.getHeartbeatsHeader();e&&s.append("x-firebase-client",e)}const a={fid:n,authVersion:Oa,appId:e.appId,sdkVersion:La},o={method:"POST",headers:s,body:JSON.stringify(a)},l=await Wa(()=>fetch(i,o));if(l.ok){const e=await l.json();return{fid:e.fid||n,registrationStatus:2,refreshToken:e.refreshToken,authToken:za(e.authToken)}}throw await Va("Create Installation",l)}(e,t);return no(e.appConfig,n)}catch(CT){throw Fa(CT)&&409===CT.customData.serverCode?await io(e.appConfig):await no(e.appConfig,{fid:t.fid,registrationStatus:0}),CT}}(e,n);return{installationEntry:n,registrationPromise:i}}return 1===t.registrationStatus?{installationEntry:t,registrationPromise:ao(e)}:{installationEntry:t}}(e,i);return t=s.registrationPromise,s.installationEntry});return""===n.fid?{installationEntry:await t}:{installationEntry:n,registrationPromise:t}}async function ao(e){let t=await oo(e.appConfig);for(;1===t.registrationStatus;)await Ga(100),t=await oo(e.appConfig);if(0===t.registrationStatus){const{installationEntry:t,registrationPromise:n}=await ro(e);return n||t}return t}function oo(e){return so(e,e=>{if(!e)throw Ua.create("installation-not-found");return lo(e)})}function lo(e){return 1===(t=e).registrationStatus&&t.registrationTime+1e4<Date.now()?{fid:e.fid,registrationStatus:0}:e;var t;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */}async function co({appConfig:e,heartbeatServiceProvider:t},n){const i=function(e,{fid:t}){return`${Ba(e)}/${t}/authTokens:generate`}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(e,n),s=function(e,{refreshToken:t}){const n=Ha(e);return n.append("Authorization",function(e){return`${Oa} ${e}`}(t)),n}(e,n),r=t.getImmediate({optional:!0});if(r){const e=await r.getHeartbeatsHeader();e&&s.append("x-firebase-client",e)}const a={installation:{sdkVersion:La,appId:e.appId}},o={method:"POST",headers:s,body:JSON.stringify(a)},l=await Wa(()=>fetch(i,o));if(l.ok)return za(await l.json());throw await Va("Generate Auth Token",l)}async function ho(e,t=!1){let n;const i=await so(e.appConfig,i=>{if(!po(i))throw Ua.create("not-registered");const s=i.authToken;if(!t&&(2===(r=s).requestStatus&&!function(e){const t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+36e5}(r)))return i;var r;if(1===s.requestStatus)return n=async function(e,t){let n=await uo(e.appConfig);for(;1===n.authToken.requestStatus;)await Ga(100),n=await uo(e.appConfig);const i=n.authToken;return 0===i.requestStatus?ho(e,t):i}(e,t),i;{if(!navigator.onLine)throw Ua.create("app-offline");const t=function(e){const t={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},e),{authToken:t})}(i);return n=async function(e,t){try{const n=await co(e,t),i=Object.assign(Object.assign({},t),{authToken:n});return await no(e.appConfig,i),n}catch(CT){if(!Fa(CT)||401!==CT.customData.serverCode&&404!==CT.customData.serverCode){const n=Object.assign(Object.assign({},t),{authToken:{requestStatus:0}});await no(e.appConfig,n)}else await io(e.appConfig);throw CT}}(e,t),t}});return n?await n:i.authToken}function uo(e){return so(e,e=>{if(!po(e))throw Ua.create("not-registered");return 1===(t=e.authToken).requestStatus&&t.requestTime+1e4<Date.now()?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e;var t;
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */})}function po(e){return void 0!==e&&2===e.registrationStatus}function mo(e){return Ua.create("missing-app-config-values",{valueName:e})}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fo="installations";x(new y(fo,e=>{const t=e.getProvider("app").getImmediate(),n=
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function(e){if(!e||!e.options)throw mo("App Configuration");if(!e.name)throw mo("App Name");const t=["projectId","apiKey","appId"];for(const n of t)if(!e.options[n])throw mo(n);return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}(t);return{app:t,appConfig:n,heartbeatServiceProvider:_(t,"heartbeat"),_delete:()=>Promise.resolve()}},"PUBLIC")),x(new y("installations-internal",e=>{const t=e.getProvider("app").getImmediate(),n=_(t,fo).getImmediate();return{getId:()=>async function(e){const t=e,{installationEntry:n,registrationPromise:i}=await ro(t);return i?i.catch(console.error):ho(t).catch(console.error),n.fid}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(n),getToken:e=>async function(e,t=!1){const n=e;return await async function(e){const{registrationPromise:t}=await ro(e);t&&await t}(n),(await ho(n,t)).token}(n,e)}},"PRIVATE")),v(Da,ka),v(Da,ka,"esm2017");
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const go="analytics",vo="https://www.googletagmanager.com/gtag/js",xo=new C("@firebase/analytics"),yo=new b("analytics","Analytics",{"already-exists":"A Firebase Analytics instance with the appId {$id}  already exists. Only one Firebase Analytics instance can be created for each appId.","already-initialized":"initializeAnalytics() cannot be called again with different options than those it was initially called with. It can be called again with the same options to return the existing instance, or getAnalytics() can be used to get a reference to the already-initialized instance.","already-initialized-settings":"Firebase Analytics has already been initialized.settings() must be called before initializing any Analytics instanceor it will have no effect.","interop-component-reg-failed":"Firebase Analytics Interop Component failed to instantiate: {$reason}","invalid-analytics-context":"Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","indexeddb-unavailable":"IndexedDB unavailable or restricted in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","fetch-throttle":"The config fetch request timed out while in an exponential backoff state. Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.","config-fetch-failed":"Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}","no-api-key":'The "apiKey" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid API key.',"no-app-id":'The "appId" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid app ID.',"no-client-id":'The "client_id" field is empty.',"invalid-gtag-resource":"Trusted Types detected an invalid gtag resource: {$gtagURL}."});
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function _o(e){if(!e.startsWith(vo)){const t=yo.create("invalid-gtag-resource",{gtagURL:e});return xo.warn(t.message),""}return e}function bo(e){return Promise.all(e.map(e=>e.catch(e=>e)))}const wo=new class{constructor(e={},t=1e3){this.throttleMetadata=e,this.intervalMillis=t}getThrottleMetadata(e){return this.throttleMetadata[e]}setThrottleMetadata(e,t){this.throttleMetadata[e]=t}deleteThrottleMetadata(e){delete this.throttleMetadata[e]}};function So(e){return new Headers({Accept:"application/json","x-goog-api-key":e})}async function Mo(e,t=wo,n){const{appId:i,apiKey:s,measurementId:r}=e.options;if(!i)throw yo.create("no-app-id");if(!s){if(r)return{measurementId:r,appId:i};throw yo.create("no-api-key")}const a=t.getThrottleMetadata(i)||{backoffCount:0,throttleEndTimeMillis:Date.now()},o=new Eo;return setTimeout(async()=>{o.abort()},void 0!==n?n:6e4),To({appId:i,apiKey:s,measurementId:r},a,o,t)}async function To(e,{throttleEndTimeMillis:t,backoffCount:n},i,s=wo){var r;const{appId:a,measurementId:o}=e;try{await function(e,t){return new Promise((n,i)=>{const s=Math.max(t-Date.now(),0),r=setTimeout(n,s);e.addEventListener(()=>{clearTimeout(r),i(yo.create("fetch-throttle",{throttleEndTimeMillis:t}))})})}(i,t)}catch(CT){if(o)return xo.warn(`Timed out fetching this Firebase app's measurement ID from the server. Falling back to the measurement ID ${o} provided in the "measurementId" field in the local Firebase config. [${null==CT?void 0:CT.message}]`),{appId:a,measurementId:o};throw CT}try{const t=await async function(e){var t;const{appId:n,apiKey:i}=e,s={method:"GET",headers:So(i)},r="https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig".replace("{app-id}",n),a=await fetch(r,s);if(200!==a.status&&304!==a.status){let e="";try{const n=await a.json();(null===(t=n.error)||void 0===t?void 0:t.message)&&(e=n.error.message)}catch(o){}throw yo.create("config-fetch-failed",{httpStatus:a.status,responseMessage:e})}return a.json()}(e);return s.deleteThrottleMetadata(a),t}catch(CT){const l=CT;if(!function(e){if(!(e instanceof w&&e.customData))return!1;const t=Number(e.customData.httpStatus);return 429===t||500===t||503===t||504===t}(l)){if(s.deleteThrottleMetadata(a),o)return xo.warn(`Failed to fetch this Firebase app's measurement ID from the server. Falling back to the measurement ID ${o} provided in the "measurementId" field in the local Firebase config. [${null==l?void 0:l.message}]`),{appId:a,measurementId:o};throw CT}const c=503===Number(null===(r=null==l?void 0:l.customData)||void 0===r?void 0:r.httpStatus)?N(n,s.intervalMillis,30):N(n,s.intervalMillis),h={throttleEndTimeMillis:Date.now()+c,backoffCount:n+1};return s.setThrottleMetadata(a,h),xo.debug(`Calling attemptFetch again in ${c} millis`),To(e,h,i,s)}}class Eo{constructor(){this.listeners=[]}addEventListener(e){this.listeners.push(e)}abort(){this.listeners.forEach(e=>e())}}async function Co(e,t,n,i,s,r,a){var o;const l=Mo(e);l.then(t=>{n[t.measurementId]=t.appId,e.options.measurementId&&t.measurementId!==e.options.measurementId&&xo.warn(`The measurement ID in the local Firebase config (${e.options.measurementId}) does not match the measurement ID fetched from the server (${t.measurementId}). To ensure analytics events are always sent to the correct Analytics property, update the measurement ID field in the local config or remove it from the local config.`)}).catch(e=>xo.error(e)),t.push(l);const c=
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
async function(){if(!R())return xo.warn(yo.create("indexeddb-unavailable",{errorInfo:"IndexedDB is not available in this environment."}).message),!1;try{await P()}catch(CT){return xo.warn(yo.create("indexeddb-unavailable",{errorInfo:null==CT?void 0:CT.toString()}).message),!1}return!0}().then(e=>e?i.getId():void 0),[h,u]=await Promise.all([l,c]);(function(e){const t=window.document.getElementsByTagName("script");for(const n of Object.values(t))if(n.src&&n.src.includes(vo)&&n.src.includes(e))return n;return null}
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */)(r)||function(e,t){const n=function(e,t){let n;return window.trustedTypes&&(n=window.trustedTypes.createPolicy("firebase-js-sdk-policy",t)),n}(0,{createScriptURL:_o}),i=document.createElement("script"),s=`${vo}?l=${e}&id=${t}`;i.src=n?null==n?void 0:n.createScriptURL(s):s,i.async=!0,document.head.appendChild(i)}(r,h.measurementId),s("js",new Date);const d=null!==(o=null==a?void 0:a.config)&&void 0!==o?o:{};return d.origin="firebase",d.update=!0,null!=u&&(d.firebase_id=u),s("config",h.measurementId,d),h.measurementId}
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Ao=class{constructor(e){this.app=e}_delete(){return delete No[this.app.options.appId],Promise.resolve()}},No={},Ro=[];const Po={};let Io,jo,Do="dataLayer",ko=!1;function Lo(e,t,n){!function(){const e=[];if(A()&&e.push("This is a browser extension environment."),I()||e.push("Cookies are not available."),e.length>0){const t=e.map((e,t)=>`(${t+1}) ${e}`).join(" "),n=yo.create("invalid-analytics-context",{errorInfo:t});xo.warn(n.message)}}();const i=e.options.appId;if(!i)throw yo.create("no-app-id");if(!e.options.apiKey){if(!e.options.measurementId)throw yo.create("no-api-key");xo.warn(`The "apiKey" field is empty in the local Firebase config. This is needed to fetch the latest measurement ID for this Firebase app. Falling back to the measurement ID ${e.options.measurementId} provided in the "measurementId" field in the local Firebase config.`)}if(null!=No[i])throw yo.create("already-exists",{id:i});if(!ko){!function(e){let t=[];Array.isArray(window[e])?t=window[e]:window[e]=t}(Do);const{wrappedGtag:e,gtagCore:t}=function(e,t,n,i,s){let r=function(...e){window[i].push(arguments)};return window[s]&&"function"==typeof window[s]&&(r=window[s]),window[s]=function(e,t,n,i){return async function(s,...r){try{if("event"===s){const[i,s]=r;await async function(e,t,n,i,s){try{let r=[];if(s&&s.send_to){let e=s.send_to;Array.isArray(e)||(e=[e]);const i=await bo(n);for(const n of e){const e=i.find(e=>e.measurementId===n),s=e&&t[e.appId];if(!s){r=[];break}r.push(s)}}0===r.length&&(r=Object.values(t)),await Promise.all(r),e("event",i,s||{})}catch(CT){xo.error(CT)}}(e,t,n,i,s)}else if("config"===s){const[s,a]=r;await async function(e,t,n,i,s,r){const a=i[s];try{if(a)await t[a];else{const e=(await bo(n)).find(e=>e.measurementId===s);e&&await t[e.appId]}}catch(CT){xo.error(CT)}e("config",s,r)}(e,t,n,i,s,a)}else if("consent"===s){const[t,n]=r;e("consent",t,n)}else if("get"===s){const[t,n,i]=r;e("get",t,n,i)}else if("set"===s){const[t]=r;e("set",t)}else e(s,...r)}catch(CT){xo.error(CT)}}}(r,e,t,n),{gtagCore:r,wrappedGtag:window[s]}}(No,Ro,Po,Do,"gtag");jo=e,Io=t,ko=!0}return No[i]=Co(e,Ro,Po,t,Io,Do,n),new Ao(e)}function Oo(e,t,n,i){e=M(e),async function(e,t,n,i,s){if(s&&s.global)e("event",n,i);else{const s=await t;e("event",n,Object.assign(Object.assign({},i),{send_to:s}))}}(jo,No[e.app.options.appId],t,n,i).catch(e=>xo.error(e))}const Uo="@firebase/analytics",Fo="0.10.8";x(new y(go,(e,{options:t})=>Lo(e.getProvider("app").getImmediate(),e.getProvider("installations-internal").getImmediate(),t),"PUBLIC")),x(new y("analytics-internal",function(e){try{const t=e.getProvider(go).getImmediate();return{logEvent:(e,n,i)=>Oo(t,e,n,i)}}catch(CT){throw yo.create("interop-component-reg-failed",{reason:CT})}},"PRIVATE")),v(Uo,Fo),v(Uo,Fo,"esm2017");const Bo=g({apiKey:"AIzaSyAVJvau3Hit06q1pNYCTOF-pVuutmk4oNQ",authDomain:"mythseekers-rpg.firebaseapp.com",databaseURL:"https://mythseekers-rpg-default-rtdb.firebaseio.com",projectId:"mythseekers-rpg",storageBucket:"mythseekers-rpg.firebasestorage.app",messagingSenderId:"659018227506",appId:"1:659018227506:web:82425e7adaf80c2e3c412b",measurementId:"G-E3T1V81ZX3"}),zo=new class{constructor(){t(this,"analytics",null),t(this,"isInitialized",!1),this.initializeAnalytics()}initializeAnalytics(){try{"undefined"!=typeof window&&Bo&&(this.analytics=function(e=T()){e=M(e);const t=_(e,go);return t.isInitialized()?t.getImmediate():function(e,t={}){const n=_(e,go);if(n.isInitialized()){const e=n.getImmediate();if(E(t,n.getOptions()))return e;throw yo.create("already-initialized")}return n.initialize({options:t})}(e)}(Bo),this.isInitialized=!0)}catch(e){}}setUserId(e){if(this.analytics&&this.isInitialized)try{t=this.analytics,n=e,t=M(t),async function(e,t,n,i){if(i&&i.global)return e("set",{user_id:n}),Promise.resolve();e("config",await t,{update:!0,user_id:n})}(jo,No[t.app.options.appId],n,i).catch(e=>xo.error(e))}catch(s){}var t,n,i}setUserProperties(e){if(this.analytics&&this.isInitialized)try{!function(e,t,n){e=M(e),async function(e,t,n,i){if(i&&i.global){const t={};for(const e of Object.keys(n))t[`user_properties.${e}`]=n[e];return e("set",t),Promise.resolve()}e("config",await t,{update:!0,user_properties:n})}(jo,No[e.app.options.appId],t,n).catch(e=>xo.error(e))}(this.analytics,e)}catch(t){}}trackPageView(e,t){this.logEvent("page_view",{page_name:e,page_title:t||e,timestamp:Date.now()})}trackUserAction(e,t){this.logEvent("user_action",{action:e,...t,timestamp:Date.now()})}trackGameEvent(e,t){this.logEvent("game_event",{event:e,...t,timestamp:Date.now()})}trackPerformance(e,t,n){this.logEvent("performance",{metric:e,value:t,...n,timestamp:Date.now()})}trackError(e,t){this.logEvent("error",{error_message:e.message,error_stack:e.stack,error_name:e.name,...t,timestamp:Date.now()})}trackFeatureUsage(e,t,n){this.logEvent("feature_usage",{feature:e,action:t,...n,timestamp:Date.now()})}trackConversion(e,t,n){this.logEvent("conversion",{conversion_type:e,value:t,currency:n||"USD",timestamp:Date.now()})}trackEngagement(e,t,n){this.logEvent("engagement",{metric:e,value:t,...n,timestamp:Date.now()})}logEvent(e,t){if(this.analytics&&this.isInitialized)try{Oo(this.analytics,e,t)}catch(n){}}trackCoreWebVitals(e,t){this.trackPerformance(`web_vital_${e.toLowerCase()}`,t)}trackBundleLoad(e,t,n){this.trackPerformance("bundle_load",t,{bundle_name:e,bundle_size:n})}trackAPIPerformance(e,t,n){this.trackPerformance("api_response_time",t,{endpoint:e,status_code:n})}trackOnboardingStep(e,t,n){this.trackUserAction("onboarding_step",{step:e,completed:t,time_spent:n})}trackCharacterCreation(e,t){this.trackGameEvent("character_created",{character_class:e,time_spent:t})}trackCampaignEvent(e,t,n){this.trackGameEvent(e,{campaign_id:t,...n})}trackCombatEvent(e,t){this.trackGameEvent(`combat_${e}`,t)}trackAIInteraction(e,t,n){this.trackPerformance("ai_response_time",t,{interaction_type:e,success:n})}trackMultiplayerEvent(e,t){this.trackGameEvent(`multiplayer_${e}`,t)}trackAccessibilityUsage(e,t){this.trackFeatureUsage("accessibility",e,{enabled:t})}trackDeviceInfo(){if("undefined"!=typeof window){const e=navigator.userAgent,t=`${screen.width}x${screen.height}`,n=`${window.innerWidth}x${window.innerHeight}`;this.setUserProperties({device_type:this.getDeviceType(),browser:this.getBrowserInfo(),screen_resolution:t,viewport_size:n,user_agent:e.substring(0,100)})}}getDeviceType(){if("undefined"==typeof window)return"unknown";const e=navigator.userAgent.toLowerCase();return/mobile|android|iphone|ipad|phone/i.test(e)?"mobile":/tablet|ipad/i.test(e)?"tablet":"desktop"}getBrowserInfo(){if("undefined"==typeof window)return"unknown";const e=navigator.userAgent;return e.includes("Chrome")?"chrome":e.includes("Firefox")?"firefox":e.includes("Safari")?"safari":e.includes("Edge")?"edge":"other"}trackSessionStart(){this.trackUserAction("session_start",{session_id:this.generateSessionId(),referrer:document.referrer||"direct"})}trackSessionEnd(e){this.trackUserAction("session_end",{session_duration:e})}generateSessionId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}trackUserPreference(e,t){this.trackUserAction("preference_changed",{preference:e,value:String(t)})}trackSearch(e,t){this.trackUserAction("search",{query:e.substring(0,50),results_count:t})}trackHelpUsage(e,t){this.trackFeatureUsage("help",t,{topic:e})}trackTutorialCompletion(e,t,n){this.trackUserAction("tutorial_completion",{tutorial_name:e,completed:t,steps_completed:n})}};class Vo{constructor(){t(this,"state"),this.state={isActive:!1,currentTurn:0,turnOrder:[],currentCombatantIndex:0,combatants:[],battleMap:this.createDefaultBattleMap(),combatLog:[],round:1,lineOfSightCache:{}}}createDefaultBattleMap(){const e=[];for(let t=0;t<8;t++){const n=[];for(let e=0;e<12;e++){let i="floor";0===e||11===e||0===t||7===t?i="wall":Math.random()<.1&&(i="difficult"),n.push({type:i,elevation:0,cover:0,occupied:!1})}e.push(n)}return{width:12,height:8,tiles:e}}startCombat(e,t){const n=this.assignStartingPositions(e,t||this.state.battleMap),i=this.calculateInitiativeOrder(n),s=n.map(e=>({...e,currentActionPoints:{...e.actionPoints},isActive:!1,hasActed:!1}));return this.state={isActive:!0,currentTurn:0,turnOrder:i,currentCombatantIndex:0,combatants:s,battleMap:t||this.state.battleMap,combatLog:[],round:1,lineOfSightCache:{}},this.setActiveCombatant(0),this.getState()}assignStartingPositions(e,t){const n=[...e],i=Math.floor(t.width/2),s=Math.floor(t.height/2);return n.filter(e=>"player"===e.type).forEach((e,t)=>{e.position={x:Math.max(1,i-3+t),y:s}}),n.filter(e=>"enemy"===e.type).forEach((e,n)=>{e.position={x:Math.min(t.width-2,i+3-n),y:s}}),n}calculateInitiativeOrder(e){return e.map(e=>({id:e.id,initiative:this.rollInitiative(e)})).sort((e,t)=>t.initiative-e.initiative).map(e=>e.id)}rollInitiative(e){const t=Math.floor((e.stats.dexterity-10)/2);return Math.floor(20*Math.random())+1+t}getState(){return{...this.state}}getActiveCombatant(){if(!this.state.isActive||0===this.state.turnOrder.length)return null;const e=this.state.turnOrder[this.state.currentCombatantIndex];return this.state.combatants.find(t=>t.id===e)||null}isPlayerTurn(){const e=this.getActiveCombatant();return"player"===(null==e?void 0:e.type)}executeAction(e){const t=this.getActiveCombatant();if(!t)return{success:!1,message:"No active combatant"};switch(e.type){case"move":return this.executeMove(t,e);case"attack":return this.executeAttack(t,e);case"skill":return this.executeSkill(t,e);case"end-turn":return this.endTurn();default:return{success:!1,message:"Unknown action type"}}}executeMove(e,t){if(e.currentActionPoints.move<=0)return{success:!1,message:"No movement points remaining"};if(!t.target||"string"==typeof t.target)return{success:!1,message:"Invalid move target"};const n=t.target.x,i=t.target.y;if(n<0||n>=this.state.battleMap.width||i<0||i>=this.state.battleMap.height)return{success:!1,message:"Target position out of bounds"};const s=this.state.battleMap.tiles[i][n];if("wall"===s.type||s.occupied)return{success:!1,message:"Cannot move to occupied or wall tile"};const r=Math.abs(n-e.position.x)+Math.abs(i-e.position.y),a="difficult"===s.type?2*r:r;if(a>e.currentActionPoints.move)return{success:!1,message:"Not enough movement points"};const o=this.state.combatants.map(t=>t.id===e.id?{...t,position:{x:n,y:i},currentActionPoints:{...t.currentActionPoints,move:t.currentActionPoints.move-a}}:t);return this.state.combatants=o,this.addCombatLog(e.id,"move",`${e.name} moved to (${n}, ${i})`),{success:!0,message:`${e.name} moved to (${n}, ${i})`,newState:this.getState()}}calculateLineOfSight(e,t){const n=`${e.x},${e.y}-${t.x},${t.y}`;if(this.state.lineOfSightCache[n])return this.state.lineOfSightCache[n].has("visible");const i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y),r=e.x<t.x?1:-1,a=e.y<t.y?1:-1;let o=i-s,l=e.x,c=e.y;for(;l!==t.x||c!==t.y;){if(l>=0&&l<this.state.battleMap.width&&c>=0&&c<this.state.battleMap.height){const e=this.state.battleMap.tiles[c][l];if("wall"===e.type||e.cover>=3)return this.state.lineOfSightCache[n]=new Set(["blocked"]),!1}const e=2*o;e>-s&&(o-=s,l+=r),e<i&&(o+=i,c+=a)}return this.state.lineOfSightCache[n]=new Set(["visible"]),!0}getVisibleTargets(e){return this.state.combatants.filter(t=>!(t.id===e.id||t.health<=0)&&this.calculateLineOfSight(e.position,t.position))}calculateFlankingBonus(e,t){const n=this.state.combatants.filter(t=>t.type===e.type&&t.id!==e.id&&t.health>0);for(const i of n){const n=Math.abs(i.position.x-t.position.x)+Math.abs(i.position.y-t.position.y),s=Math.abs(e.position.x-t.position.x)+Math.abs(e.position.y-t.position.y);if(n<=1&&s<=1){const n=i.position.x-t.position.x,s=i.position.y-t.position.y,r=e.position.x-t.position.x,a=e.position.y-t.position.y;if((n*r<0||s*a<0)&&(0!==n||0!==r)&&(0!==s||0!==a))return 2}}return 0}getEnemyAIAction(e){const t=this.getVisibleTargets(e);if(0===t.length)return this.getMovementTowardsPlayers(e);const n={personality:"aggressive",preferredRange:"melee",targetPriority:"closest",retreatThreshold:.3,flankingBonus:!0};if(e.health/e.maxHealth<n.retreatThreshold)return{type:"move",target:void 0};const i=this.selectTarget(t,n.targetPriority,e);switch(n.personality){case"aggressive":default:return this.getAggressiveAction(e,i,n);case"defensive":return this.getDefensiveAction(e,i,n);case"tactical":return this.getTacticalAction(e,i,n);case"cowardly":return this.getCowardlyAction(e,i,n)}}selectTarget(e,t,n){switch(t){case"weakest":return e.reduce((e,t)=>t.health<e.health?t:e);case"strongest":return e.reduce((e,t)=>t.health>e.health?t:e);case"closest":return e.reduce((e,t)=>{const i=Math.abs(e.position.x-n.position.x)+Math.abs(e.position.y-n.position.y);return Math.abs(t.position.x-n.position.x)+Math.abs(t.position.y-n.position.y)<i?t:e});case"threat":return e.reduce((e,t)=>2*(t.maxHealth-t.health)+t.stats.strength>2*(e.maxHealth-e.health)+e.stats.strength?t:e);default:return e[0]}}getAggressiveAction(e,t,n){if(Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y)<=e.reach&&e.currentActionPoints.action>0)return{type:"attack",target:t.position};if(e.currentActionPoints.move>0){const n=this.findPathToTarget(e,t);if(n.length>1)return{type:"move",target:n[1],path:n}}return{type:"end-turn"}}getDefensiveAction(e,t,n){const i=Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y);if(i<=1&&e.currentActionPoints.move>0){const n=this.findRetreatPosition(e,t);if(n)return{type:"move",target:n}}else if(i<=e.reach&&e.currentActionPoints.action>0)return{type:"attack",target:t.position};return{type:"end-turn"}}getTacticalAction(e,t,n){const i=this.calculateFlankingBonus(e,t),s=this.state.battleMap.tiles[e.position.y][e.position.x],r=this.state.battleMap.tiles[t.position.y][t.position.x],a=r.cover,o=s.cover,l=s.elevation,c=r.elevation;if(i>0&&e.currentActionPoints.action>0&&a<2)return{type:"attack",target:t.position};if(l>c&&e.currentActionPoints.action>0)return{type:"attack",target:t.position};const h=this.findTacticalPosition(e,t);return h&&e.currentActionPoints.move>0?{type:"move",target:h}:o>=1&&e.currentActionPoints.action>0?{type:"attack",target:t.position}:{type:"end-turn"}}getCowardlyAction(e,t,n){if(Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y)<=2){const n=this.findRetreatPosition(e,t);if(n&&e.currentActionPoints.move>0)return{type:"move",target:n}}return t.health/t.maxHealth<.3&&e.currentActionPoints.action>0?{type:"attack",target:t.position}:{type:"end-turn"}}findPathToTarget(e,t){const n=[{x:e.position.x,y:e.position.y,g:0,h:0,f:0,parent:null}],i=new Set,s=new Map,r=new Map,a=new Map;for(r.set(`${e.position.x},${e.position.y}`,0),a.set(`${e.position.x},${e.position.y}`,this.heuristic(e.position,t.position));n.length>0;){n.sort((e,t)=>e.f-t.f);const o=n.shift(),l=`${o.x},${o.y}`;if(o.x===t.position.x&&o.y===t.position.y){const t=[];let n={x:o.x,y:o.y};for(;s.has(`${n.x},${n.y}`);)t.unshift(n),n=s.get(`${n.x},${n.y}`);return t.unshift({x:e.position.x,y:e.position.y}),t}i.add(l);const c=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const e of c){const c={x:o.x+e.dx,y:o.y+e.dy},h=`${c.x},${c.y}`;if(c.x<0||c.x>=this.state.battleMap.width||c.y<0||c.y>=this.state.battleMap.height||i.has(h))continue;const u=this.state.battleMap.tiles[c.y][c.x];if("wall"===u.type||u.occupied)continue;const d=r.get(l)+("difficult"===u.type?2:1);(!r.has(h)||d<r.get(h))&&(s.set(h,{x:o.x,y:o.y}),r.set(h,d),a.set(h,d+this.heuristic(c,t.position)),n.find(e=>e.x===c.x&&e.y===c.y)||n.push({x:c.x,y:c.y,g:d,h:this.heuristic(c,t.position),f:d+this.heuristic(c,t.position),parent:null}))}}return[{x:e.position.x,y:e.position.y}]}heuristic(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}findRetreatPosition(e,t){const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const i of n){const n=e.position.x+i.dx,s=e.position.y+i.dy;if(n>=0&&n<this.state.battleMap.width&&s>=0&&s<this.state.battleMap.height){const e=this.state.battleMap.tiles[s][n];if("wall"!==e.type&&!e.occupied&&Math.abs(n-t.position.x)+Math.abs(s-t.position.y)>1)return{x:n,y:s}}}return null}findTacticalPosition(e,t){const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];let i=null,s=-1/0;for(const r of n){const n=e.position.x+r.dx,a=e.position.y+r.dy;if(n<0||n>=this.state.battleMap.width||a<0||a>=this.state.battleMap.height)continue;const o=this.state.battleMap.tiles[a][n];if("wall"===o.type||o.occupied)continue;const l=2*o.cover+(o.elevation>this.state.battleMap.tiles[e.position.y][e.position.x].elevation?1:0)-(Math.abs(n-t.position.x)+Math.abs(a-t.position.y));l>s&&(s=l,i={x:n,y:a})}return i}getMovementTowardsPlayers(e){const t=this.state.combatants.filter(e=>"player"===e.type&&e.health>0);if(0===t.length)return{type:"end-turn"};const n=t.reduce((t,n)=>{const i=Math.abs(t.position.x-e.position.x)+Math.abs(t.position.y-e.position.y);return Math.abs(n.position.x-e.position.x)+Math.abs(n.position.y-e.position.y)<i?n:t}),i=this.findPathToTarget(e,n);return i.length>1&&e.currentActionPoints.move>0?{type:"move",target:i[1],path:i}:{type:"end-turn"}}executeAttack(e,t){if(e.currentActionPoints.action<=0)return{success:!1,message:"No action points remaining"};if(!t.target||"string"==typeof t.target)return{success:!1,message:"Invalid attack target"};const n=t.target.x,i=t.target.y,s=this.state.combatants.find(t=>t.position.x===n&&t.position.y===i&&t.id!==e.id);if(!s)return{success:!1,message:"No target at specified position"};if(!this.calculateLineOfSight(e.position,s.position))return{success:!1,message:"Target not in line of sight"};if(Math.abs(n-e.position.x)+Math.abs(i-e.position.y)>e.reach)return{success:!1,message:"Target out of range"};const r=Math.floor(20*Math.random())+1,a=Math.floor((e.stats.strength-10)/2),o=this.calculateFlankingBonus(e,s);if(r+a+o>=s.stats.armorClass){const t=this.calculateDamage(e),n=this.state.combatants.map(e=>{if(e.id===s.id){const n=Math.max(0,e.health-t);return{...e,health:n}}return e});this.state.combatants=n;const i=o>0?" (flanking!)":"";this.addCombatLog(e.id,"attack",`${e.name} hit ${s.name} for ${t} damage${i}`),s.health-t<=0&&this.addCombatLog(s.id,"defeat",`${s.name} was defeated!`);const r=this.state.combatants.find(t=>t.id===e.id);return r&&r.currentActionPoints.action--,{success:!0,message:`${e.name} hit ${s.name} for ${t} damage${i}`,newState:this.getState()}}{this.addCombatLog(e.id,"attack",`${e.name} missed ${s.name}`);const t=this.state.combatants.find(t=>t.id===e.id);return t&&t.currentActionPoints.action--,{success:!0,message:`${e.name} missed ${s.name}`,newState:this.getState()}}}executeSkill(e,t){if(e.currentActionPoints.action<=0)return{success:!1,message:"No action points remaining"};if(!t.skillId)return{success:!1,message:"No skill specified"};const n=e.skills[t.skillId];if(!n)return{success:!1,message:"Skill not found"};this.addCombatLog(e.id,"skill",`${e.name} used ${n.name}`);const i=this.state.combatants.find(t=>t.id===e.id);return i&&i.currentActionPoints.action--,{success:!0,message:`${e.name} used ${n.name}`,newState:this.getState()}}endTurn(){var e;const t=this.getActiveCombatant();if(!t)return{success:!1,message:"No active combatant"};const n=this.state.combatants.map(e=>e.id===t.id?{...e,hasActed:!0}:e);return this.state.combatants=n,this.addCombatLog(t.id,"end-turn",`${t.name} ended their turn`),this.state.currentCombatantIndex=(this.state.currentCombatantIndex+1)%this.state.turnOrder.length,0===this.state.currentCombatantIndex&&(this.state.round++,this.startNewRound()),this.setActiveCombatant(this.state.currentCombatantIndex),{success:!0,message:`Turn ended. Next: ${(null==(e=this.getActiveCombatant())?void 0:e.name)||"Unknown"}`,newState:this.getState()}}startNewRound(){this.state.combatants=this.state.combatants.map(e=>({...e,currentActionPoints:{...e.actionPoints},hasActed:!1})),this.addCombatLog("system","round",`Round ${this.state.round} begins!`)}setActiveCombatant(e){this.state.combatants=this.state.combatants.map(e=>({...e,isActive:!1}));const t=this.state.turnOrder[e],n=this.state.combatants.find(e=>e.id===t);n&&(n.isActive=!0)}calculateDamage(e){const t=Math.floor((e.stats.strength-10)/2);return Math.max(1,Math.floor(6*Math.random())+1+t)}addCombatLog(e,t,n){const i={id:Date.now().toString(),turn:this.state.currentTurn,combatantId:e,action:t,result:n,timestamp:Date.now()};this.state.combatLog.push(i)}endCombat(){return this.state.isActive=!1,this.getState()}checkCombatEnd(){const e=this.state.combatants.filter(e=>"player"===e.type),t=this.state.combatants.filter(e=>"enemy"===e.type),n=e.filter(e=>e.health>0),i=t.filter(e=>e.health>0);return 0===n.length?{ended:!0,winner:"enemies"}:0===i.length?{ended:!0,winner:"players"}:{ended:!1}}executeAITurn(){const e=this.getActiveCombatant();if(!e||"enemy"!==e.type)return{success:!1,message:"No enemy combatant active"};const t=this.getEnemyAIAction(e);return t?this.executeAction(t):this.endTurn()}}const Ho=({onOpenAuth:e})=>at.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-900 to-black text-white flex flex-col items-center justify-center font-inter",children:[at.jsxs("section",{className:"relative w-full py-20 px-4 text-center overflow-hidden",children:[at.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-900/30 to-blue-900/30 opacity-70 animate-pulse-slow"}),at.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-transparent via-transparent to-black"}),at.jsxs("div",{className:"relative z-10 max-w-4xl mx-auto",children:[at.jsx("h1",{className:"text-5xl md:text-7xl font-extrabold mb-6 leading-tight tracking-tighter drop-shadow-lg animate-fade-in-up",children:"MythSeeker: Your Epic Adventures Await"}),at.jsx("p",{className:"text-xl md:text-2xl text-gray-300 mb-10 leading-relaxed animate-fade-in-up delay-200",children:"Unleash limitless stories with an AI Dungeon Master, dynamic worlds, and seamless multiplayer."}),at.jsx("button",{onClick:e,className:"px-10 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xl font-bold rounded-full shadow-lg hover:from-purple-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-300 animate-bounce-in",children:"Start Your Adventure Now"})]})]}),at.jsx("section",{className:"w-full py-16 px-4 bg-gray-950/70 backdrop-blur-sm border-t border-b border-gray-800",children:at.jsxs("div",{className:"max-w-6xl mx-auto",children:[at.jsx("h2",{className:"text-4xl font-bold text-center mb-12 text-purple-300 drop-shadow-md animate-fade-in",children:"Why Choose MythSeeker?"}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10",children:[at.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-300",children:[at.jsx("div",{className:"text-purple-400 mb-4 flex justify-center",children:at.jsx(fe,{size:48})}),at.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"AI Dungeon Master"}),at.jsx("p",{className:"text-gray-300 text-center",children:"Experience dynamic, adaptive storytelling tailored to your choices. No two campaigns are ever the same!"})]}),at.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-400",children:[at.jsx("div",{className:"text-blue-400 mb-4 flex justify-center",children:at.jsx(ie,{size:48})}),at.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Seamless Multiplayer"}),at.jsx("p",{className:"text-gray-300 text-center",children:"Play with friends in real-time. Share your epic quests and overcome challenges together."})]}),at.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-500",children:[at.jsx("div",{className:"text-green-400 mb-4 flex justify-center",children:at.jsx(ve,{size:48})}),at.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Living Worlds"}),at.jsx("p",{className:"text-gray-300 text-center",children:"Explore vast, evolving worlds where your actions have lasting consequences."})]}),at.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-600",children:[at.jsx("div",{className:"text-red-400 mb-4 flex justify-center",children:at.jsx(xe,{size:48})}),at.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Engaging Combat"}),at.jsx("p",{className:"text-gray-300 text-center",children:"Dive into tactical turn-based combat with dynamic environments and challenging foes."})]}),at.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-700",children:[at.jsx("div",{className:"text-yellow-400 mb-4 flex justify-center",children:at.jsx(ye,{size:48})}),at.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Rich Lore & Quests"}),at.jsx("p",{className:"text-gray-300 text-center",children:"Uncover deep lore and embark on procedurally generated quests that keep you on the edge of your seat."})]}),at.jsxs("div",{className:"bg-gray-800/50 p-8 rounded-xl shadow-xl border border-gray-700/50 transform hover:scale-[1.02] transition-transform duration-300 animate-fade-in delay-800",children:[at.jsx("div",{className:"text-cyan-400 mb-4 flex justify-center",children:at.jsx(_e,{size:48})}),at.jsx("h3",{className:"text-2xl font-semibold mb-3 text-center",children:"Campaign Log"}),at.jsx("p",{className:"text-gray-300 text-center",children:"Keep track of your adventures, character progress, and world events with an intuitive campaign log."})]})]})]})}),at.jsx("section",{className:"w-full py-20 px-4 text-center bg-gray-900",children:at.jsxs("div",{className:"max-w-3xl mx-auto",children:[at.jsx("h2",{className:"text-4xl font-bold mb-6 text-indigo-300 drop-shadow-md animate-fade-in",children:"Ready to Forge Your Legend?"}),at.jsx("p",{className:"text-xl text-gray-300 mb-10 animate-fade-in delay-200",children:"Join thousands of adventurers already exploring endless possibilities in MythSeeker."}),at.jsx("button",{onClick:e,className:"px-12 py-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-2xl font-bold rounded-full shadow-xl hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-300 animate-bounce-in delay-300",children:"Play Free Now"})]})}),at.jsxs("footer",{className:"w-full py-8 px-4 bg-black text-gray-500 text-center text-sm",children:[at.jsxs("p",{children:["© ",(new Date).getFullYear()," MythSeeker. All rights reserved."]}),at.jsxs("div",{className:"mt-2 space-x-4",children:[at.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Privacy Policy"}),at.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Terms of Service"}),at.jsx("a",{href:"#",className:"hover:text-white transition-colors",children:"Contact Us"})]})]}),at.jsx("style",{dangerouslySetInnerHTML:{__html:"\n            @keyframes fadeIn {\n              from { opacity: 0; }\n              to { opacity: 1; }\n            }\n            @keyframes fadeInUp {\n              from { opacity: 0; transform: translateY(20px); }\n              to { opacity: 1; transform: translateY(0); }\n            }\n            @keyframes bounceIn {\n              0%, 20%, 40%, 60%, 80%, 100% {\n                transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);\n              }\n              0% {\n                opacity: 0;\n                transform: scale3d(0.3, 0.3, 0.3);\n              }\n              20% {\n                transform: scale3d(1.1, 1.1, 1.1);\n              }\n              40% {\n                transform: scale3d(0.9, 0.9, 0.9);\n              }\n              60% {\n                opacity: 1;\n                transform: scale3d(1.03, 1.03, 1.03);\n              }\n              80% {\n                transform: scale3d(0.97, 0.97, 0.97);\n              }\n              100% {\n                opacity: 1;\n                transform: scale3d(1, 1, 1);\n              }\n            }\n            @keyframes pulseSlow {\n              0%, 100% { opacity: 0.7; }\n              50% { opacity: 0.9; }\n            }\n            .animate-fade-in { animation: fadeIn 1s ease-out forwards; }\n            .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }\n            .animate-fade-in-up.delay-200 { animation-delay: 0.2s; }\n            .animate-bounce-in { animation: bounceIn 1s; }\n            .animate-bounce-in.delay-300 { animation-delay: 0.3s; }\n            .animate-pulse-slow { animation: pulseSlow 4s infinite alternate; }\n          "}})]}),Wo=({user:e,campaigns:t,characters:i,onNavigate:s,onCreateCampaign:r,onCreateCharacter:a,onJoinCampaign:o,onResumeCampaign:l,onOpenDiceRoller:c,onOpenProfile:h,onOpenSettings:u,onOpenAchievements:d,onOpenHelp:p})=>{const[m,f]=n.useState([]),[g,v]=n.useState([]),[x,y]=n.useState({totalPlayTime:"0h 0m",campaignsCompleted:0,charactersCreated:0,diceRolls:0,achievements:0});n.useEffect(()=>{f(t.filter(e=>"active"===e.status||"waiting"===e.status)),v([{type:"campaign_joined",title:'Joined "Lost Mines"',time:"2 hours ago",icon:at.jsx(be,{className:"w-4 h-4"})},{type:"character_created",title:'Created "Thorin Stonefist"',time:"1 day ago",icon:at.jsx(we,{className:"w-4 h-4"})},{type:"achievement",title:'Unlocked "First Steps"',time:"2 days ago",icon:at.jsx(re,{className:"w-4 h-4"})},{type:"dice_roll",title:"Rolled 20 on d20!",time:"3 days ago",icon:at.jsx(ae,{className:"w-4 h-4"})}])},[t]);const _=[{id:"resume",title:"Resume Adventure",description:"Continue your latest campaign",icon:at.jsx(Se,{className:"w-6 h-6"}),action:()=>{m.length>0?l(m[0].id):r()},color:"from-emerald-500 to-teal-600",gradient:"bg-gradient-to-r from-emerald-500 to-teal-600",badge:m.length>0?`${m.length} Active`:void 0},{id:"new-campaign",title:"New Campaign",description:"Start a fresh adventure",icon:at.jsx(Me,{className:"w-6 h-6"}),action:r,color:"from-blue-500 to-indigo-600",gradient:"bg-gradient-to-r from-blue-500 to-indigo-600"},{id:"join-campaign",title:"Join Campaign",description:"Enter with a friend's code",icon:at.jsx(ie,{className:"w-6 h-6"}),action:o,color:"from-purple-500 to-pink-600",gradient:"bg-gradient-to-r from-purple-500 to-pink-600"},{id:"dice-roller",title:"Dice Roller",description:"Roll some dice!",icon:at.jsx(ae,{className:"w-6 h-6"}),action:c,color:"from-orange-500 to-red-600",gradient:"bg-gradient-to-r from-orange-500 to-red-600"}],b=[{id:"campaigns",title:"Campaigns",description:"Manage your adventures",icon:at.jsx(be,{className:"w-8 h-8"}),path:"/campaigns",color:"from-blue-500 to-indigo-600",gradient:"bg-gradient-to-br from-blue-500 to-indigo-600",stats:[{label:"Active",value:m.length},{label:"Total",value:t.length}]},{id:"characters",title:"Characters",description:"Your heroes and companions",icon:at.jsx(we,{className:"w-8 h-8"}),path:"/characters",color:"from-green-500 to-emerald-600",gradient:"bg-gradient-to-br from-green-500 to-emerald-600",stats:[{label:"Created",value:i.length},{label:"Active",value:i.filter(e=>e.isActive).length}]},{id:"party",title:"Party",description:"Team up with friends",icon:at.jsx(ie,{className:"w-8 h-8"}),path:"/party",color:"from-purple-500 to-pink-600",gradient:"bg-gradient-to-br from-purple-500 to-pink-600",stats:[{label:"Members",value:"3-6"},{label:"Online",value:"2"}]},{id:"world",title:"World",description:"Explore the realm",icon:at.jsx(ve,{className:"w-8 h-8"}),path:"/world",color:"from-teal-500 to-cyan-600",gradient:"bg-gradient-to-br from-teal-500 to-cyan-600",stats:[{label:"Locations",value:"12"},{label:"Discovered",value:"8"}]},{id:"combat",title:"Combat",description:"Battle system & tactics",icon:at.jsx(le,{className:"w-8 h-8"}),path:"/combat",color:"from-red-500 to-pink-600",gradient:"bg-gradient-to-br from-red-500 to-pink-600",stats:[{label:"Encounters",value:"5"},{label:"Victories",value:"4"}]},{id:"magic",title:"Magic",description:"Spells & abilities",icon:at.jsx(xe,{className:"w-8 h-8"}),path:"/magic",color:"from-indigo-500 to-purple-600",gradient:"bg-gradient-to-br from-indigo-500 to-purple-600",stats:[{label:"Spells",value:"24"},{label:"Prepared",value:"8"}]},{id:"dm-center",title:"DM Center",description:"Dungeon Master tools",icon:at.jsx(Te,{className:"w-8 h-8"}),path:"/dm-center",color:"from-yellow-500 to-orange-600",gradient:"bg-gradient-to-br from-yellow-500 to-orange-600",isNew:!0},{id:"achievements",title:"Achievements",description:"Track your progress",icon:at.jsx(re,{className:"w-8 h-8"}),path:"/achievements",color:"from-amber-500 to-yellow-600",gradient:"bg-gradient-to-br from-amber-500 to-yellow-600",stats:[{label:"Unlocked",value:x.achievements},{label:"Total",value:"50"}]}];return at.jsxs("div",{className:"h-full overflow-y-auto bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 text-white",children:[at.jsxs("div",{className:"relative overflow-hidden",children:[at.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-blue-600/20 to-purple-600/20"}),at.jsx("div",{className:"relative px-6 py-8",children:at.jsxs("div",{className:"max-w-7xl mx-auto",children:[at.jsxs("div",{className:"mb-8",children:[at.jsxs("h1",{className:"text-4xl font-bold mb-2",children:[(()=>{const e=(new Date).getHours();return e<12?"Good morning":e<17?"Good afternoon":"Good evening"})(),", ",(null==e?void 0:e.displayName)||"Adventurer","! 👋"]}),at.jsx("p",{className:"text-blue-200 text-lg",children:"Ready for your next epic adventure?"})]}),at.jsxs("div",{className:"mb-8",children:[at.jsxs("h2",{className:"text-2xl font-semibold mb-4 flex items-center",children:[at.jsx(me,{className:"w-6 h-6 mr-2 text-yellow-400"}),"Quick Actions"]}),at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:_.map(e=>at.jsxs("button",{onClick:e.action,className:`relative group p-6 rounded-xl ${e.gradient} hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl`,children:[at.jsxs("div",{className:"flex items-center justify-between mb-3",children:[at.jsx("div",{className:"p-2 bg-white/20 rounded-lg",children:e.icon}),e.badge&&at.jsx("span",{className:"px-2 py-1 bg-white/20 rounded-full text-xs font-medium",children:e.badge})]}),at.jsx("h3",{className:"font-semibold text-lg mb-1",children:e.title}),at.jsx("p",{className:"text-white/80 text-sm",children:e.description}),at.jsx(Ee,{className:"w-4 h-4 absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity"})]},e.id))})]})]})})]}),at.jsx("div",{className:"px-6 pb-8",children:at.jsx("div",{className:"max-w-7xl mx-auto",children:at.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[at.jsxs("div",{className:"lg:col-span-2",children:[at.jsxs("div",{className:"flex items-center justify-between mb-6",children:[at.jsxs("h2",{className:"text-2xl font-semibold flex items-center",children:[at.jsx(Ce,{className:"w-6 h-6 mr-2 text-blue-400"}),"Game Features"]}),at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("button",{className:"p-2 hover:bg-white/10 rounded-lg transition-colors",children:at.jsx(Ae,{className:"w-4 h-4"})}),at.jsx("button",{className:"p-2 hover:bg-white/10 rounded-lg transition-colors",children:at.jsx(Ne,{className:"w-4 h-4"})})]})]}),at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:b.map(e=>at.jsxs("button",{onClick:()=>s(e.path),className:"group relative p-6 rounded-xl bg-slate-800/50 hover:bg-slate-800/70 transition-all duration-200 border border-slate-700/50 hover:border-slate-600/50",children:[e.isNew&&at.jsx("span",{className:"absolute -top-2 -right-2 px-2 py-1 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs font-medium",children:"NEW"}),at.jsxs("div",{className:"flex items-start justify-between mb-4",children:[at.jsx("div",{className:`p-3 rounded-lg ${e.gradient}`,children:e.icon}),at.jsx(Re,{className:"w-5 h-5 text-slate-400 group-hover:text-white transition-colors"})]}),at.jsx("h3",{className:"font-semibold text-lg mb-2 text-left",children:e.title}),at.jsx("p",{className:"text-slate-300 text-sm mb-4 text-left",children:e.description}),e.stats&&at.jsx("div",{className:"flex space-x-4",children:e.stats.map((e,t)=>at.jsxs("div",{className:"text-left",children:[at.jsx("div",{className:"text-lg font-semibold text-white",children:e.value}),at.jsx("div",{className:"text-xs text-slate-400",children:e.label})]},t))})]},e.id))})]}),at.jsxs("div",{className:"space-y-6",children:[at.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[at.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[at.jsx(Se,{className:"w-5 h-5 mr-2 text-green-400"}),"Active Campaigns"]}),0===m.length?at.jsxs("div",{className:"text-center py-4",children:[at.jsx(be,{className:"w-8 h-8 text-slate-400 mx-auto mb-2"}),at.jsx("p",{className:"text-slate-300 text-sm mb-3",children:"No active campaigns"}),at.jsx("button",{onClick:r,className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors",children:"Create Campaign"})]}):at.jsxs("div",{className:"space-y-3",children:[m.slice(0,3).map(e=>at.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/30 rounded-lg",children:[at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsx("h4",{className:"font-medium text-sm truncate",children:e.name}),at.jsx("p",{className:"text-xs text-slate-400",children:e.theme})]}),at.jsx("button",{onClick:()=>l(e.id),className:"ml-2 p-1.5 bg-green-600 hover:bg-green-700 rounded text-white transition-colors",children:at.jsx(Se,{className:"w-3 h-3"})})]},e.id)),m.length>3&&at.jsxs("button",{onClick:()=>s("/campaigns"),className:"w-full text-center text-sm text-blue-400 hover:text-blue-300 transition-colors",children:["View all ",m.length," campaigns"]})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[at.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[at.jsx(se,{className:"w-5 h-5 mr-2 text-orange-400"}),"Recent Activity"]}),at.jsx("div",{className:"space-y-3",children:g.map((e,t)=>at.jsxs("div",{className:"flex items-start space-x-3",children:[at.jsx("div",{className:"p-1.5 bg-slate-700/50 rounded-lg",children:e.icon}),at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsx("p",{className:"text-sm font-medium truncate",children:e.title}),at.jsx("p",{className:"text-xs text-slate-400",children:e.time})]})]},t))})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[at.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[at.jsx(Pe,{className:"w-5 h-5 mr-2 text-slate-400"}),"Quick Settings"]}),at.jsxs("div",{className:"space-y-3",children:[at.jsxs("button",{onClick:c,className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(ae,{className:"w-4 h-4 text-green-400"}),at.jsx("span",{className:"text-sm",children:"Dice Roller"})]}),at.jsx(Re,{className:"w-4 h-4 text-slate-400"})]}),at.jsxs("button",{onClick:h,className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(we,{className:"w-4 h-4 text-blue-400"}),at.jsx("span",{className:"text-sm",children:"Profile"})]}),at.jsx(Re,{className:"w-4 h-4 text-slate-400"})]}),at.jsxs("button",{onClick:d,className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(re,{className:"w-4 h-4 text-yellow-400"}),at.jsx("span",{className:"text-sm",children:"Achievements"})]}),at.jsx(Re,{className:"w-4 h-4 text-slate-400"})]})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-6 border border-slate-700/50",children:[at.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center",children:[at.jsx(Ie,{className:"w-5 h-5 mr-2 text-purple-400"}),"Your Stats"]}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(se,{className:"w-4 h-4 text-blue-400"}),at.jsx("span",{className:"text-sm",children:"Play Time"})]}),at.jsx("span",{className:"font-semibold",children:x.totalPlayTime})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(re,{className:"w-4 h-4 text-yellow-400"}),at.jsx("span",{className:"text-sm",children:"Achievements"})]}),at.jsxs("span",{className:"font-semibold",children:[x.achievements,"/50"]})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(ae,{className:"w-4 h-4 text-green-400"}),at.jsx("span",{className:"text-sm",children:"Dice Rolls"})]}),at.jsx("span",{className:"font-semibold",children:x.diceRolls})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(be,{className:"w-4 h-4 text-purple-400"}),at.jsx("span",{className:"text-sm",children:"Campaigns"})]}),at.jsx("span",{className:"font-semibold",children:x.campaignsCompleted})]})]})]})]})]})})})]})},Go="178",qo=0,Xo=1,Yo=2,$o=100,Zo=101,Ko=102,Jo=200,Qo=201,el=202,tl=203,nl=204,il=205,sl=206,rl=207,al=208,ol=209,ll=210,cl=211,hl=212,ul=213,dl=214,pl=0,ml=1,fl=2,gl=3,vl=4,xl=5,yl=6,_l=7,bl=301,wl=302,Sl=306,Ml=1e3,Tl=1001,El=1002,Cl=1003,Al=1004,Nl=1005,Rl=1006,Pl=1007,Il=1008,jl=1009,Dl=1012,kl=1013,Ll=1014,Ol=1015,Ul=1016,Fl=1017,Bl=1018,zl=1020,Vl=1023,Hl=1026,Wl=1027,Gl=1029,ql=1031,Xl=1033,Yl=33776,$l=33777,Zl=33778,Kl=33779,Jl=35840,Ql=35841,ec=35842,tc=35843,nc=36196,ic=37492,sc=37496,rc=37808,ac=37809,oc=37810,lc=37811,cc=37812,hc=37813,uc=37814,dc=37815,pc=37816,mc=37817,fc=37818,gc=37819,vc=37820,xc=37821,yc=36492,_c=36494,bc=36495,wc=36284,Sc=36285,Mc=36286,Tc="",Ec="srgb",Cc="srgb-linear",Ac="linear",Nc="srgb",Rc=7680,Pc=512,Ic=513,jc=514,Dc=515,kc=516,Lc=517,Oc=518,Uc=519,Fc="300 es",Bc=2e3,zc=2001;class Vc{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){const n=this._listeners;return void 0!==n&&void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){const n=this._listeners;if(void 0===n)return;const i=n[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const n=t[e.type];if(void 0!==n){e.target=this;const t=n.slice(0);for(let n=0,i=t.length;n<i;n++)t[n].call(this,e);e.target=null}}}const Hc=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],Wc=Math.PI/180,Gc=180/Math.PI;function qc(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(Hc[255&e]+Hc[e>>8&255]+Hc[e>>16&255]+Hc[e>>24&255]+"-"+Hc[255&t]+Hc[t>>8&255]+"-"+Hc[t>>16&15|64]+Hc[t>>24&255]+"-"+Hc[63&n|128]+Hc[n>>8&255]+"-"+Hc[n>>16&255]+Hc[n>>24&255]+Hc[255&i]+Hc[i>>8&255]+Hc[i>>16&255]+Hc[i>>24&255]).toLowerCase()}function Xc(e,t,n){return Math.max(t,Math.min(n,e))}function Yc(e,t,n){return(1-n)*e+n*t}function $c(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Zc(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const Kc=Wc;class Jc{constructor(e=0,t=0){Jc.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6],this.y=i[1]*t+i[4]*n+i[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Xc(this.x,e.x,t.x),this.y=Xc(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=Xc(this.x,e,t),this.y=Xc(this.y,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Xc(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Xc(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),i=Math.sin(t),s=this.x-e.x,r=this.y-e.y;return this.x=s*n-r*i+e.x,this.y=s*i+r*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Qc{constructor(e=0,t=0,n=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=i}static slerpFlat(e,t,n,i,s,r,a){let o=n[i+0],l=n[i+1],c=n[i+2],h=n[i+3];const u=s[r+0],d=s[r+1],p=s[r+2],m=s[r+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=c,void(e[t+3]=h);if(1===a)return e[t+0]=u,e[t+1]=d,e[t+2]=p,void(e[t+3]=m);if(h!==m||o!==u||l!==d||c!==p){let e=1-a;const t=o*u+l*d+c*p+h*m,n=t>=0?1:-1,i=1-t*t;if(i>Number.EPSILON){const s=Math.sqrt(i),r=Math.atan2(s,t*n);e=Math.sin(e*r)/s,a=Math.sin(a*r)/s}const s=a*n;if(o=o*e+u*s,l=l*e+d*s,c=c*e+p*s,h=h*e+m*s,e===1-a){const e=1/Math.sqrt(o*o+l*l+c*c+h*h);o*=e,l*=e,c*=e,h*=e}}e[t]=o,e[t+1]=l,e[t+2]=c,e[t+3]=h}static multiplyQuaternionsFlat(e,t,n,i,s,r){const a=n[i],o=n[i+1],l=n[i+2],c=n[i+3],h=s[r],u=s[r+1],d=s[r+2],p=s[r+3];return e[t]=a*p+c*h+o*d-l*u,e[t+1]=o*p+c*u+l*h-a*d,e[t+2]=l*p+c*d+a*u-o*h,e[t+3]=c*p-a*h-o*u-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,i=e._y,s=e._z,r=e._order,a=Math.cos,o=Math.sin,l=a(n/2),c=a(i/2),h=a(s/2),u=o(n/2),d=o(i/2),p=o(s/2);switch(r){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],i=t[4],s=t[8],r=t[1],a=t[5],o=t[9],l=t[2],c=t[6],h=t[10],u=n+a+h;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(c-o)*e,this._y=(s-l)*e,this._z=(r-i)*e}else if(n>a&&n>h){const e=2*Math.sqrt(1+n-a-h);this._w=(c-o)/e,this._x=.25*e,this._y=(i+r)/e,this._z=(s+l)/e}else if(a>h){const e=2*Math.sqrt(1+a-n-h);this._w=(s-l)/e,this._x=(i+r)/e,this._y=.25*e,this._z=(o+c)/e}else{const e=2*Math.sqrt(1+h-n-a);this._w=(r-i)/e,this._x=(s+l)/e,this._y=(o+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<1e-8?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Xc(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const i=Math.min(1,t/n);return this.slerp(e,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,i=e._y,s=e._z,r=e._w,a=t._x,o=t._y,l=t._z,c=t._w;return this._x=n*c+r*a+i*l-s*o,this._y=i*c+r*o+s*a-n*l,this._z=s*c+r*l+n*o-i*a,this._w=r*c-n*a-i*o-s*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,i=this._y,s=this._z,r=this._w;let a=r*e._w+n*e._x+i*e._y+s*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=r,this._x=n,this._y=i,this._z=s,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*r+t*this._w,this._x=e*n+t*this._x,this._y=e*i+t*this._y,this._z=e*s+t*this._z,this.normalize(),this}const l=Math.sqrt(o),c=Math.atan2(l,a),h=Math.sin((1-t)*c)/l,u=Math.sin(t*c)/l;return this._w=r*h+this._w*u,this._x=n*h+this._x*u,this._y=i*h+this._y*u,this._z=s*h+this._z*u,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),i=Math.sqrt(1-n),s=Math.sqrt(n);return this.set(i*Math.sin(e),i*Math.cos(e),s*Math.sin(t),s*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class eh{constructor(e=0,t=0,n=0){eh.prototype.isVector3=!0,this.x=e,this.y=t,this.z=n}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(nh.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(nh.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,i=this.z,s=e.elements;return this.x=s[0]*t+s[3]*n+s[6]*i,this.y=s[1]*t+s[4]*n+s[7]*i,this.z=s[2]*t+s[5]*n+s[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,s=e.elements,r=1/(s[3]*t+s[7]*n+s[11]*i+s[15]);return this.x=(s[0]*t+s[4]*n+s[8]*i+s[12])*r,this.y=(s[1]*t+s[5]*n+s[9]*i+s[13])*r,this.z=(s[2]*t+s[6]*n+s[10]*i+s[14])*r,this}applyQuaternion(e){const t=this.x,n=this.y,i=this.z,s=e.x,r=e.y,a=e.z,o=e.w,l=2*(r*i-a*n),c=2*(a*t-s*i),h=2*(s*n-r*t);return this.x=t+o*l+r*h-a*c,this.y=n+o*c+a*l-s*h,this.z=i+o*h+s*c-r*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,i=this.z,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*i,this.y=s[1]*t+s[5]*n+s[9]*i,this.z=s[2]*t+s[6]*n+s[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Xc(this.x,e.x,t.x),this.y=Xc(this.y,e.y,t.y),this.z=Xc(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=Xc(this.x,e,t),this.y=Xc(this.y,e,t),this.z=Xc(this.z,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Xc(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,s=e.z,r=t.x,a=t.y,o=t.z;return this.x=i*o-s*a,this.y=s*r-n*o,this.z=n*a-i*r,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return th.copy(this).projectOnVector(e),this.sub(th)}reflect(e){return this.sub(th.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Xc(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const i=Math.sin(t)*e;return this.x=i*Math.sin(n),this.y=Math.cos(t)*e,this.z=i*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=i,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const th=new eh,nh=new Qc;class ih{constructor(e,t,n,i,s,r,a,o,l){ih.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,n,i,s,r,a,o,l)}set(e,t,n,i,s,r,a,o,l){const c=this.elements;return c[0]=e,c[1]=i,c[2]=a,c[3]=t,c[4]=s,c[5]=o,c[6]=n,c[7]=r,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,s=this.elements,r=n[0],a=n[3],o=n[6],l=n[1],c=n[4],h=n[7],u=n[2],d=n[5],p=n[8],m=i[0],f=i[3],g=i[6],v=i[1],x=i[4],y=i[7],_=i[2],b=i[5],w=i[8];return s[0]=r*m+a*v+o*_,s[3]=r*f+a*x+o*b,s[6]=r*g+a*y+o*w,s[1]=l*m+c*v+h*_,s[4]=l*f+c*x+h*b,s[7]=l*g+c*y+h*w,s[2]=u*m+d*v+p*_,s[5]=u*f+d*x+p*b,s[8]=u*g+d*y+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],i=e[2],s=e[3],r=e[4],a=e[5],o=e[6],l=e[7],c=e[8];return t*r*c-t*a*l-n*s*c+n*a*o+i*s*l-i*r*o}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],s=e[3],r=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=c*r-a*l,u=a*o-c*s,d=l*s-r*o,p=t*h+n*u+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return e[0]=h*m,e[1]=(i*l-c*n)*m,e[2]=(a*n-i*r)*m,e[3]=u*m,e[4]=(c*t-i*o)*m,e[5]=(i*s-a*t)*m,e[6]=d*m,e[7]=(n*o-l*t)*m,e[8]=(r*t-n*s)*m,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,i,s,r,a){const o=Math.cos(s),l=Math.sin(s);return this.set(n*o,n*l,-n*(o*r+l*a)+r+e,-i*l,i*o,-i*(-l*r+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(sh.makeScale(e,t)),this}rotate(e){return this.premultiply(sh.makeRotation(-e)),this}translate(e,t){return this.premultiply(sh.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let i=0;i<9;i++)if(t[i]!==n[i])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const sh=new ih;function rh(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function ah(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function oh(){const e=ah("canvas");return e.style.display="block",e}const lh={};function ch(e){e in lh||(lh[e]=!0)}const hh=(new ih).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),uh=(new ih).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function dh(){const e={enabled:!0,workingColorSpace:Cc,spaces:{},convert:function(e,t,n){return!1!==this.enabled&&t!==n&&t&&n?(this.spaces[t].transfer===Nc&&(e.r=mh(e.r),e.g=mh(e.g),e.b=mh(e.b)),this.spaces[t].primaries!==this.spaces[n].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[n].fromXYZ)),this.spaces[n].transfer===Nc&&(e.r=fh(e.r),e.g=fh(e.g),e.b=fh(e.b)),e):e},workingToColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},colorSpaceToWorking:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===Tc?Ac:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,n){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[n].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(t,n){return ch("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),e.workingToColorSpace(t,n)},toWorkingColorSpace:function(t,n){return ch("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),e.colorSpaceToWorking(t,n)}},t=[.64,.33,.3,.6,.15,.06],n=[.2126,.7152,.0722],i=[.3127,.329];return e.define({[Cc]:{primaries:t,whitePoint:i,transfer:Ac,toXYZ:hh,fromXYZ:uh,luminanceCoefficients:n,workingColorSpaceConfig:{unpackColorSpace:Ec},outputColorSpaceConfig:{drawingBufferColorSpace:Ec}},[Ec]:{primaries:t,whitePoint:i,transfer:Nc,toXYZ:hh,fromXYZ:uh,luminanceCoefficients:n,outputColorSpaceConfig:{drawingBufferColorSpace:Ec}}}),e}const ph=dh();function mh(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function fh(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let gh;class vh{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let n;if(e instanceof HTMLCanvasElement)n=e;else{void 0===gh&&(gh=ah("canvas")),gh.width=e.width,gh.height=e.height;const t=gh.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),n=gh}return n.toDataURL(t)}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=ah("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height),s=i.data;for(let e=0;e<s.length;e++)s[e]=255*mh(s[e]/255);return n.putImageData(i,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*mh(t[e]/255)):t[e]=mh(t[e]);return{data:t,width:e.width,height:e.height}}return e}}let xh=0,yh=class{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:xh++}),this.uuid=qc(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight):null!==t?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},i=this.data;if(null!==i){let e;if(Array.isArray(i)){e=[];for(let t=0,n=i.length;t<n;t++)i[t].isDataTexture?e.push(_h(i[t].image)):e.push(_h(i[t]))}else e=_h(i);n.url=e}return t||(e.images[this.uuid]=n),n}};function _h(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?vh.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:{}}let bh=0;const wh=new eh;class Sh extends Vc{constructor(e=Sh.DEFAULT_IMAGE,t=Sh.DEFAULT_MAPPING,n=1001,i=1001,s=1006,r=1008,a=1023,o=1009,l=Sh.DEFAULT_ANISOTROPY,c=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:bh++}),this.uuid=qc(),this.name="",this.source=new yh(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=n,this.wrapT=i,this.magFilter=s,this.minFilter=r,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new Jc(0,0),this.repeat=new Jc(1,1),this.center=new Jc(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new ih,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(wh).x}get height(){return this.source.getSize(wh).y}get depth(){return this.source.getSize(wh).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const n=e[t];if(void 0===n)continue;const i=this[t];void 0!==i&&(i&&n&&i.isVector2&&n.isVector2||i&&n&&i.isVector3&&n.isVector3||i&&n&&i.isMatrix3&&n.isMatrix3?i.copy(n):this[t]=n)}}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Ml:e.x=e.x-Math.floor(e.x);break;case Tl:e.x=e.x<0?0:1;break;case El:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case Ml:e.y=e.y-Math.floor(e.y);break;case Tl:e.y=e.y<0?0:1;break;case El:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}Sh.DEFAULT_IMAGE=null,Sh.DEFAULT_MAPPING=300,Sh.DEFAULT_ANISOTROPY=1;class Mh{constructor(e=0,t=0,n=0,i=1){Mh.prototype.isVector4=!0,this.x=e,this.y=t,this.z=n,this.w=i}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,s=this.w,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i+r[12]*s,this.y=r[1]*t+r[5]*n+r[9]*i+r[13]*s,this.z=r[2]*t+r[6]*n+r[10]*i+r[14]*s,this.w=r[3]*t+r[7]*n+r[11]*i+r[15]*s,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,i,s;const r=.01,a=.1,o=e.elements,l=o[0],c=o[4],h=o[8],u=o[1],d=o[5],p=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(c-u)<r&&Math.abs(h-m)<r&&Math.abs(p-f)<r){if(Math.abs(c+u)<a&&Math.abs(h+m)<a&&Math.abs(p+f)<a&&Math.abs(l+d+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(d+1)/2,v=(g+1)/2,x=(c+u)/4,y=(h+m)/4,_=(p+f)/4;return e>o&&e>v?e<r?(n=0,i=.707106781,s=.707106781):(n=Math.sqrt(e),i=x/n,s=y/n):o>v?o<r?(n=.707106781,i=0,s=.707106781):(i=Math.sqrt(o),n=x/i,s=_/i):v<r?(n=.707106781,i=.707106781,s=0):(s=Math.sqrt(v),n=y/s,i=_/s),this.set(n,i,s,t),this}let v=Math.sqrt((f-p)*(f-p)+(h-m)*(h-m)+(u-c)*(u-c));return Math.abs(v)<.001&&(v=1),this.x=(f-p)/v,this.y=(h-m)/v,this.z=(u-c)/v,this.w=Math.acos((l+d+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Xc(this.x,e.x,t.x),this.y=Xc(this.y,e.y,t.y),this.z=Xc(this.z,e.z,t.z),this.w=Xc(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=Xc(this.x,e,t),this.y=Xc(this.y,e,t),this.z=Xc(this.z,e,t),this.w=Xc(this.w,e,t),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Xc(n,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Th extends Vc{constructor(e=1,t=1,n={}){super(),n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Rl,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},n),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=n.depth,this.scissor=new Mh(0,0,e,t),this.scissorTest=!1,this.viewport=new Mh(0,0,e,t);const i={width:e,height:t,depth:n.depth},s=new Sh(i);this.textures=[];const r=n.count;for(let a=0;a<r;a++)this.textures[a]=s.clone(),this.textures[a].isRenderTargetTexture=!0,this.textures[a].renderTarget=this;this._setTextureOptions(n),this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=n.depthTexture,this.samples=n.samples,this.multiview=n.multiview}_setTextureOptions(e={}){const t={minFilter:Rl,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(t.mapping=e.mapping),void 0!==e.wrapS&&(t.wrapS=e.wrapS),void 0!==e.wrapT&&(t.wrapT=e.wrapT),void 0!==e.wrapR&&(t.wrapR=e.wrapR),void 0!==e.magFilter&&(t.magFilter=e.magFilter),void 0!==e.minFilter&&(t.minFilter=e.minFilter),void 0!==e.format&&(t.format=e.format),void 0!==e.type&&(t.type=e.type),void 0!==e.anisotropy&&(t.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(t.colorSpace=e.colorSpace),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(t.internalFormat=e.internalFormat);for(let n=0;n<this.textures.length;n++)this.textures[n].setValues(t)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let i=0,s=this.textures.length;i<s;i++)this.textures[i].image.width=e,this.textures[i].image.height=t,this.textures[i].image.depth=n,this.textures[i].isArrayTexture=this.textures[i].image.depth>1;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,n=e.textures.length;t<n;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const n=Object.assign({},e.textures[t].image);this.textures[t].source=new yh(n)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Eh extends Th{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}}class Ch extends Sh{constructor(e=null,t=1,n=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=Cl,this.minFilter=Cl,this.wrapR=Tl,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class Ah extends Sh{constructor(e=null,t=1,n=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=Cl,this.minFilter=Cl,this.wrapR=Tl,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Nh{constructor(e=new eh(1/0,1/0,1/0),t=new eh(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(Ph.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(Ph.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=Ph.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const i=n.getAttribute("position");if(!0===t&&void 0!==i&&!0!==e.isInstancedMesh)for(let t=0,n=i.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,Ph):Ph.fromBufferAttribute(i,t),Ph.applyMatrix4(e.matrixWorld),this.expandByPoint(Ph);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Ih.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),Ih.copy(n.boundingBox)),Ih.applyMatrix4(e.matrixWorld),this.union(Ih)}const i=e.children;for(let s=0,r=i.length;s<r;s++)this.expandByObject(i[s],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,Ph),Ph.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Fh),Bh.subVectors(this.max,Fh),jh.subVectors(e.a,Fh),Dh.subVectors(e.b,Fh),kh.subVectors(e.c,Fh),Lh.subVectors(Dh,jh),Oh.subVectors(kh,Dh),Uh.subVectors(jh,kh);let t=[0,-Lh.z,Lh.y,0,-Oh.z,Oh.y,0,-Uh.z,Uh.y,Lh.z,0,-Lh.x,Oh.z,0,-Oh.x,Uh.z,0,-Uh.x,-Lh.y,Lh.x,0,-Oh.y,Oh.x,0,-Uh.y,Uh.x,0];return!!Hh(t,jh,Dh,kh,Bh)&&(t=[1,0,0,0,1,0,0,0,1],!!Hh(t,jh,Dh,kh,Bh)&&(zh.crossVectors(Lh,Oh),t=[zh.x,zh.y,zh.z],Hh(t,jh,Dh,kh,Bh)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Ph).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(Ph).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Rh[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Rh[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Rh[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Rh[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Rh[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Rh[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Rh[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Rh[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Rh)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const Rh=[new eh,new eh,new eh,new eh,new eh,new eh,new eh,new eh],Ph=new eh,Ih=new Nh,jh=new eh,Dh=new eh,kh=new eh,Lh=new eh,Oh=new eh,Uh=new eh,Fh=new eh,Bh=new eh,zh=new eh,Vh=new eh;function Hh(e,t,n,i,s){for(let r=0,a=e.length-3;r<=a;r+=3){Vh.fromArray(e,r);const a=s.x*Math.abs(Vh.x)+s.y*Math.abs(Vh.y)+s.z*Math.abs(Vh.z),o=t.dot(Vh),l=n.dot(Vh),c=i.dot(Vh);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>a)return!1}return!0}const Wh=new Nh,Gh=new eh,qh=new eh;class Xh{constructor(e=new eh,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):Wh.setFromPoints(e).getCenter(n);let i=0;for(let s=0,r=e.length;s<r;s++)i=Math.max(i,n.distanceToSquared(e[s]));return this.radius=Math.sqrt(i),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Gh.subVectors(e,this.center);const t=Gh.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector(Gh,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(qh.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Gh.copy(e.center).add(qh)),this.expandByPoint(Gh.copy(e.center).sub(qh))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const Yh=new eh,$h=new eh,Zh=new eh,Kh=new eh,Jh=new eh,Qh=new eh,eu=new eh;class tu{constructor(e=new eh,t=new eh(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Yh)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Yh.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Yh.copy(this.origin).addScaledVector(this.direction,t),Yh.distanceToSquared(e))}distanceSqToSegment(e,t,n,i){$h.copy(e).add(t).multiplyScalar(.5),Zh.copy(t).sub(e).normalize(),Kh.copy(this.origin).sub($h);const s=.5*e.distanceTo(t),r=-this.direction.dot(Zh),a=Kh.dot(this.direction),o=-Kh.dot(Zh),l=Kh.lengthSq(),c=Math.abs(1-r*r);let h,u,d,p;if(c>0)if(h=r*o-a,u=r*a-o,p=s*c,h>=0)if(u>=-p)if(u<=p){const e=1/c;h*=e,u*=e,d=h*(h+r*u+2*a)+u*(r*h+u+2*o)+l}else u=s,h=Math.max(0,-(r*u+a)),d=-h*h+u*(u+2*o)+l;else u=-s,h=Math.max(0,-(r*u+a)),d=-h*h+u*(u+2*o)+l;else u<=-p?(h=Math.max(0,-(-r*s+a)),u=h>0?-s:Math.min(Math.max(-s,-o),s),d=-h*h+u*(u+2*o)+l):u<=p?(h=0,u=Math.min(Math.max(-s,-o),s),d=u*(u+2*o)+l):(h=Math.max(0,-(r*s+a)),u=h>0?s:Math.min(Math.max(-s,-o),s),d=-h*h+u*(u+2*o)+l);else u=r>0?-s:s,h=Math.max(0,-(r*u+a)),d=-h*h+u*(u+2*o)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,h),i&&i.copy($h).addScaledVector(Zh,u),d}intersectSphere(e,t){Yh.subVectors(e.center,this.origin);const n=Yh.dot(this.direction),i=Yh.dot(Yh)-n*n,s=e.radius*e.radius;if(i>s)return null;const r=Math.sqrt(s-i),a=n-r,o=n+r;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,i,s,r,a,o;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(n=(e.min.x-u.x)*l,i=(e.max.x-u.x)*l):(n=(e.max.x-u.x)*l,i=(e.min.x-u.x)*l),c>=0?(s=(e.min.y-u.y)*c,r=(e.max.y-u.y)*c):(s=(e.max.y-u.y)*c,r=(e.min.y-u.y)*c),n>r||s>i?null:((s>n||isNaN(n))&&(n=s),(r<i||isNaN(i))&&(i=r),h>=0?(a=(e.min.z-u.z)*h,o=(e.max.z-u.z)*h):(a=(e.max.z-u.z)*h,o=(e.min.z-u.z)*h),n>o||a>i?null:((a>n||n!=n)&&(n=a),(o<i||i!=i)&&(i=o),i<0?null:this.at(n>=0?n:i,t)))}intersectsBox(e){return null!==this.intersectBox(e,Yh)}intersectTriangle(e,t,n,i,s){Jh.subVectors(t,e),Qh.subVectors(n,e),eu.crossVectors(Jh,Qh);let r,a=this.direction.dot(eu);if(a>0){if(i)return null;r=1}else{if(!(a<0))return null;r=-1,a=-a}Kh.subVectors(this.origin,e);const o=r*this.direction.dot(Qh.crossVectors(Kh,Qh));if(o<0)return null;const l=r*this.direction.dot(Jh.cross(Kh));if(l<0)return null;if(o+l>a)return null;const c=-r*Kh.dot(eu);return c<0?null:this.at(c/a,s)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class nu{constructor(e,t,n,i,s,r,a,o,l,c,h,u,d,p,m,f){nu.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,n,i,s,r,a,o,l,c,h,u,d,p,m,f)}set(e,t,n,i,s,r,a,o,l,c,h,u,d,p,m,f){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=s,g[5]=r,g[9]=a,g[13]=o,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new nu).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,i=1/iu.setFromMatrixColumn(e,0).length(),s=1/iu.setFromMatrixColumn(e,1).length(),r=1/iu.setFromMatrixColumn(e,2).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[3]=0,t[4]=n[4]*s,t[5]=n[5]*s,t[6]=n[6]*s,t[7]=0,t[8]=n[8]*r,t[9]=n[9]*r,t[10]=n[10]*r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,i=e.y,s=e.z,r=Math.cos(n),a=Math.sin(n),o=Math.cos(i),l=Math.sin(i),c=Math.cos(s),h=Math.sin(s);if("XYZ"===e.order){const e=r*c,n=r*h,i=a*c,s=a*h;t[0]=o*c,t[4]=-o*h,t[8]=l,t[1]=n+i*l,t[5]=e-s*l,t[9]=-a*o,t[2]=s-e*l,t[6]=i+n*l,t[10]=r*o}else if("YXZ"===e.order){const e=o*c,n=o*h,i=l*c,s=l*h;t[0]=e+s*a,t[4]=i*a-n,t[8]=r*l,t[1]=r*h,t[5]=r*c,t[9]=-a,t[2]=n*a-i,t[6]=s+e*a,t[10]=r*o}else if("ZXY"===e.order){const e=o*c,n=o*h,i=l*c,s=l*h;t[0]=e-s*a,t[4]=-r*h,t[8]=i+n*a,t[1]=n+i*a,t[5]=r*c,t[9]=s-e*a,t[2]=-r*l,t[6]=a,t[10]=r*o}else if("ZYX"===e.order){const e=r*c,n=r*h,i=a*c,s=a*h;t[0]=o*c,t[4]=i*l-n,t[8]=e*l+s,t[1]=o*h,t[5]=s*l+e,t[9]=n*l-i,t[2]=-l,t[6]=a*o,t[10]=r*o}else if("YZX"===e.order){const e=r*o,n=r*l,i=a*o,s=a*l;t[0]=o*c,t[4]=s-e*h,t[8]=i*h+n,t[1]=h,t[5]=r*c,t[9]=-a*c,t[2]=-l*c,t[6]=n*h+i,t[10]=e-s*h}else if("XZY"===e.order){const e=r*o,n=r*l,i=a*o,s=a*l;t[0]=o*c,t[4]=-h,t[8]=l*c,t[1]=e*h+s,t[5]=r*c,t[9]=n*h-i,t[2]=i*h-n,t[6]=a*c,t[10]=s*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(ru,e,au)}lookAt(e,t,n){const i=this.elements;return cu.subVectors(e,t),0===cu.lengthSq()&&(cu.z=1),cu.normalize(),ou.crossVectors(n,cu),0===ou.lengthSq()&&(1===Math.abs(n.z)?cu.x+=1e-4:cu.z+=1e-4,cu.normalize(),ou.crossVectors(n,cu)),ou.normalize(),lu.crossVectors(cu,ou),i[0]=ou.x,i[4]=lu.x,i[8]=cu.x,i[1]=ou.y,i[5]=lu.y,i[9]=cu.y,i[2]=ou.z,i[6]=lu.z,i[10]=cu.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,s=this.elements,r=n[0],a=n[4],o=n[8],l=n[12],c=n[1],h=n[5],u=n[9],d=n[13],p=n[2],m=n[6],f=n[10],g=n[14],v=n[3],x=n[7],y=n[11],_=n[15],b=i[0],w=i[4],S=i[8],M=i[12],T=i[1],E=i[5],C=i[9],A=i[13],N=i[2],R=i[6],P=i[10],I=i[14],j=i[3],D=i[7],k=i[11],L=i[15];return s[0]=r*b+a*T+o*N+l*j,s[4]=r*w+a*E+o*R+l*D,s[8]=r*S+a*C+o*P+l*k,s[12]=r*M+a*A+o*I+l*L,s[1]=c*b+h*T+u*N+d*j,s[5]=c*w+h*E+u*R+d*D,s[9]=c*S+h*C+u*P+d*k,s[13]=c*M+h*A+u*I+d*L,s[2]=p*b+m*T+f*N+g*j,s[6]=p*w+m*E+f*R+g*D,s[10]=p*S+m*C+f*P+g*k,s[14]=p*M+m*A+f*I+g*L,s[3]=v*b+x*T+y*N+_*j,s[7]=v*w+x*E+y*R+_*D,s[11]=v*S+x*C+y*P+_*k,s[15]=v*M+x*A+y*I+_*L,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],i=e[8],s=e[12],r=e[1],a=e[5],o=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+s*o*h-i*l*h-s*a*u+n*l*u+i*a*d-n*o*d)+e[7]*(+t*o*d-t*l*u+s*r*u-i*r*d+i*l*c-s*o*c)+e[11]*(+t*l*h-t*a*d-s*r*h+n*r*d+s*a*c-n*l*c)+e[15]*(-i*a*c-t*o*h+t*a*u+i*r*h-n*r*u+n*o*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],s=e[3],r=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11],p=e[12],m=e[13],f=e[14],g=e[15],v=h*f*l-m*u*l+m*o*d-a*f*d-h*o*g+a*u*g,x=p*u*l-c*f*l-p*o*d+r*f*d+c*o*g-r*u*g,y=c*m*l-p*h*l+p*a*d-r*m*d-c*a*g+r*h*g,_=p*h*o-c*m*o-p*a*u+r*m*u+c*a*f-r*h*f,b=t*v+n*x+i*y+s*_;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/b;return e[0]=v*w,e[1]=(m*u*s-h*f*s-m*i*d+n*f*d+h*i*g-n*u*g)*w,e[2]=(a*f*s-m*o*s+m*i*l-n*f*l-a*i*g+n*o*g)*w,e[3]=(h*o*s-a*u*s-h*i*l+n*u*l+a*i*d-n*o*d)*w,e[4]=x*w,e[5]=(c*f*s-p*u*s+p*i*d-t*f*d-c*i*g+t*u*g)*w,e[6]=(p*o*s-r*f*s-p*i*l+t*f*l+r*i*g-t*o*g)*w,e[7]=(r*u*s-c*o*s+c*i*l-t*u*l-r*i*d+t*o*d)*w,e[8]=y*w,e[9]=(p*h*s-c*m*s-p*n*d+t*m*d+c*n*g-t*h*g)*w,e[10]=(r*m*s-p*a*s+p*n*l-t*m*l-r*n*g+t*a*g)*w,e[11]=(c*a*s-r*h*s-c*n*l+t*h*l+r*n*d-t*a*d)*w,e[12]=_*w,e[13]=(c*m*i-p*h*i+p*n*u-t*m*u-c*n*f+t*h*f)*w,e[14]=(p*a*i-r*m*i-p*n*o+t*m*o+r*n*f-t*a*f)*w,e[15]=(r*h*i-c*a*i+c*n*o-t*h*o-r*n*u+t*a*u)*w,this}scale(e){const t=this.elements,n=e.x,i=e.y,s=e.z;return t[0]*=n,t[4]*=i,t[8]*=s,t[1]*=n,t[5]*=i,t[9]*=s,t[2]*=n,t[6]*=i,t[10]*=s,t[3]*=n,t[7]*=i,t[11]*=s,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,i))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),i=Math.sin(t),s=1-n,r=e.x,a=e.y,o=e.z,l=s*r,c=s*a;return this.set(l*r+n,l*a-i*o,l*o+i*a,0,l*a+i*o,c*a+n,c*o-i*r,0,l*o-i*a,c*o+i*r,s*o*o+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,i,s,r){return this.set(1,n,s,0,e,1,r,0,t,i,1,0,0,0,0,1),this}compose(e,t,n){const i=this.elements,s=t._x,r=t._y,a=t._z,o=t._w,l=s+s,c=r+r,h=a+a,u=s*l,d=s*c,p=s*h,m=r*c,f=r*h,g=a*h,v=o*l,x=o*c,y=o*h,_=n.x,b=n.y,w=n.z;return i[0]=(1-(m+g))*_,i[1]=(d+y)*_,i[2]=(p-x)*_,i[3]=0,i[4]=(d-y)*b,i[5]=(1-(u+g))*b,i[6]=(f+v)*b,i[7]=0,i[8]=(p+x)*w,i[9]=(f-v)*w,i[10]=(1-(u+m))*w,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,n){const i=this.elements;let s=iu.set(i[0],i[1],i[2]).length();const r=iu.set(i[4],i[5],i[6]).length(),a=iu.set(i[8],i[9],i[10]).length();this.determinant()<0&&(s=-s),e.x=i[12],e.y=i[13],e.z=i[14],su.copy(this);const o=1/s,l=1/r,c=1/a;return su.elements[0]*=o,su.elements[1]*=o,su.elements[2]*=o,su.elements[4]*=l,su.elements[5]*=l,su.elements[6]*=l,su.elements[8]*=c,su.elements[9]*=c,su.elements[10]*=c,t.setFromRotationMatrix(su),n.x=s,n.y=r,n.z=a,this}makePerspective(e,t,n,i,s,r,a=2e3){const o=this.elements,l=2*s/(t-e),c=2*s/(n-i),h=(t+e)/(t-e),u=(n+i)/(n-i);let d,p;if(a===Bc)d=-(r+s)/(r-s),p=-2*r*s/(r-s);else{if(a!==zc)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);d=-r/(r-s),p=-r*s/(r-s)}return o[0]=l,o[4]=0,o[8]=h,o[12]=0,o[1]=0,o[5]=c,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,n,i,s,r,a=2e3){const o=this.elements,l=1/(t-e),c=1/(n-i),h=1/(r-s),u=(t+e)*l,d=(n+i)*c;let p,m;if(a===Bc)p=(r+s)*h,m=-2*h;else{if(a!==zc)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=s*h,m=-1*h}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=m,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let i=0;i<16;i++)if(t[i]!==n[i])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}const iu=new eh,su=new nu,ru=new eh(0,0,0),au=new eh(1,1,1),ou=new eh,lu=new eh,cu=new eh,hu=new nu,uu=new Qc;class du{constructor(e=0,t=0,n=0,i=du.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=n,this._order=i}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,i=this._order){return this._x=e,this._y=t,this._z=n,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const i=e.elements,s=i[0],r=i[4],a=i[8],o=i[1],l=i[5],c=i[9],h=i[2],u=i[6],d=i[10];switch(t){case"XYZ":this._y=Math.asin(Xc(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-r,s)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Xc(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-h,s),this._z=0);break;case"ZXY":this._x=Math.asin(Xc(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-h,d),this._z=Math.atan2(-r,l)):(this._y=0,this._z=Math.atan2(o,s));break;case"ZYX":this._y=Math.asin(-Xc(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,s)):(this._x=0,this._z=Math.atan2(-r,l));break;case"YZX":this._z=Math.asin(Xc(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-h,s)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-Xc(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(a,s)):(this._x=Math.atan2(-c,d),this._y=0)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return hu.makeRotationFromQuaternion(e),this.setFromRotationMatrix(hu,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return uu.setFromEuler(this),this.setFromQuaternion(uu,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}du.DEFAULT_ORDER="XYZ";class pu{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let mu=0;const fu=new eh,gu=new Qc,vu=new nu,xu=new eh,yu=new eh,_u=new eh,bu=new Qc,wu=new eh(1,0,0),Su=new eh(0,1,0),Mu=new eh(0,0,1),Tu={type:"added"},Eu={type:"removed"},Cu={type:"childadded",child:null},Au={type:"childremoved",child:null};class Nu extends Vc{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:mu++}),this.uuid=qc(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Nu.DEFAULT_UP.clone();const e=new eh,t=new du,n=new Qc,i=new eh(1,1,1);t._onChange(function(){n.setFromEuler(t,!1)}),n._onChange(function(){t.setFromQuaternion(n,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new nu},normalMatrix:{value:new ih}}),this.matrix=new nu,this.matrixWorld=new nu,this.matrixAutoUpdate=Nu.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Nu.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new pu,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return gu.setFromAxisAngle(e,t),this.quaternion.multiply(gu),this}rotateOnWorldAxis(e,t){return gu.setFromAxisAngle(e,t),this.quaternion.premultiply(gu),this}rotateX(e){return this.rotateOnAxis(wu,e)}rotateY(e){return this.rotateOnAxis(Su,e)}rotateZ(e){return this.rotateOnAxis(Mu,e)}translateOnAxis(e,t){return fu.copy(e).applyQuaternion(this.quaternion),this.position.add(fu.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(wu,e)}translateY(e){return this.translateOnAxis(Su,e)}translateZ(e){return this.translateOnAxis(Mu,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(vu.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?xu.copy(e):xu.set(e,t,n);const i=this.parent;this.updateWorldMatrix(!0,!1),yu.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?vu.lookAt(yu,xu,this.up):vu.lookAt(xu,yu,this.up),this.quaternion.setFromRotationMatrix(vu),i&&(vu.extractRotation(i.matrixWorld),gu.setFromRotationMatrix(vu),this.quaternion.premultiply(gu.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this||e&&e.isObject3D&&(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Tu),Cu.child=e,this.dispatchEvent(Cu),Cu.child=null),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Eu),Au.child=e,this.dispatchEvent(Au),Au.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),vu.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),vu.multiply(e.parent.matrixWorld)),e.applyMatrix4(vu),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Tu),Cu.child=e,this.dispatchEvent(Cu),Cu.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,i=this.children.length;n<i;n++){const i=this.children[n].getObjectByProperty(e,t);if(void 0!==i)return i}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const i=this.children;for(let s=0,r=i.length;s<r;s++)i[s].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(yu,e,_u),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(yu,bu,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].updateMatrixWorld(e)}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++)e[t].updateWorldMatrix(!1,!0)}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};function s(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map(e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0})),i.instanceInfo=this._instanceInfo.map(e=>({...e})),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(e),i.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(i.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(i.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=s(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,i=n.length;t<i;t++){const i=n[t];s(e.shapes,i)}else s(e.shapes,n)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(s(e.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,i=this.material.length;n<i;n++)t.push(s(e.materials,this.material[n]));i.material=t}else i.material=s(e.materials,this.material);if(this.children.length>0){i.children=[];for(let t=0;t<this.children.length;t++)i.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){i.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];i.animations.push(s(e.animations,n))}}if(t){const t=r(e.geometries),i=r(e.materials),s=r(e.textures),a=r(e.images),o=r(e.shapes),l=r(e.skeletons),c=r(e.animations),h=r(e.nodes);t.length>0&&(n.geometries=t),i.length>0&&(n.materials=i),s.length>0&&(n.textures=s),a.length>0&&(n.images=a),o.length>0&&(n.shapes=o),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),h.length>0&&(n.nodes=h)}return n.object=i,n;function r(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let n=0;n<e.children.length;n++){const t=e.children[n];this.add(t.clone())}return this}}Nu.DEFAULT_UP=new eh(0,1,0),Nu.DEFAULT_MATRIX_AUTO_UPDATE=!0,Nu.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Ru=new eh,Pu=new eh,Iu=new eh,ju=new eh,Du=new eh,ku=new eh,Lu=new eh,Ou=new eh,Uu=new eh,Fu=new eh,Bu=new Mh,zu=new Mh,Vu=new Mh;class Hu{constructor(e=new eh,t=new eh,n=new eh){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,i){i.subVectors(n,t),Ru.subVectors(e,t),i.cross(Ru);const s=i.lengthSq();return s>0?i.multiplyScalar(1/Math.sqrt(s)):i.set(0,0,0)}static getBarycoord(e,t,n,i,s){Ru.subVectors(i,t),Pu.subVectors(n,t),Iu.subVectors(e,t);const r=Ru.dot(Ru),a=Ru.dot(Pu),o=Ru.dot(Iu),l=Pu.dot(Pu),c=Pu.dot(Iu),h=r*l-a*a;if(0===h)return s.set(0,0,0),null;const u=1/h,d=(l*o-a*c)*u,p=(r*c-a*o)*u;return s.set(1-d-p,p,d)}static containsPoint(e,t,n,i){return null!==this.getBarycoord(e,t,n,i,ju)&&ju.x>=0&&ju.y>=0&&ju.x+ju.y<=1}static getInterpolation(e,t,n,i,s,r,a,o){return null===this.getBarycoord(e,t,n,i,ju)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(s,ju.x),o.addScaledVector(r,ju.y),o.addScaledVector(a,ju.z),o)}static getInterpolatedAttribute(e,t,n,i,s,r){return Bu.setScalar(0),zu.setScalar(0),Vu.setScalar(0),Bu.fromBufferAttribute(e,t),zu.fromBufferAttribute(e,n),Vu.fromBufferAttribute(e,i),r.setScalar(0),r.addScaledVector(Bu,s.x),r.addScaledVector(zu,s.y),r.addScaledVector(Vu,s.z),r}static isFrontFacing(e,t,n,i){return Ru.subVectors(n,t),Pu.subVectors(e,t),Ru.cross(Pu).dot(i)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,i){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,n,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Ru.subVectors(this.c,this.b),Pu.subVectors(this.a,this.b),.5*Ru.cross(Pu).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Hu.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Hu.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,n,i,s){return Hu.getInterpolation(e,this.a,this.b,this.c,t,n,i,s)}containsPoint(e){return Hu.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Hu.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,i=this.b,s=this.c;let r,a;Du.subVectors(i,n),ku.subVectors(s,n),Ou.subVectors(e,n);const o=Du.dot(Ou),l=ku.dot(Ou);if(o<=0&&l<=0)return t.copy(n);Uu.subVectors(e,i);const c=Du.dot(Uu),h=ku.dot(Uu);if(c>=0&&h<=c)return t.copy(i);const u=o*h-c*l;if(u<=0&&o>=0&&c<=0)return r=o/(o-c),t.copy(n).addScaledVector(Du,r);Fu.subVectors(e,s);const d=Du.dot(Fu),p=ku.dot(Fu);if(p>=0&&d<=p)return t.copy(s);const m=d*l-o*p;if(m<=0&&l>=0&&p<=0)return a=l/(l-p),t.copy(n).addScaledVector(ku,a);const f=c*p-d*h;if(f<=0&&h-c>=0&&d-p>=0)return Lu.subVectors(s,i),a=(h-c)/(h-c+(d-p)),t.copy(i).addScaledVector(Lu,a);const g=1/(f+m+u);return r=m*g,a=u*g,t.copy(n).addScaledVector(Du,r).addScaledVector(ku,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const Wu={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Gu={h:0,s:0,l:0},qu={h:0,s:0,l:0};function Xu(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}class Yu{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=Ec){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,ph.colorSpaceToWorking(this,t),this}setRGB(e,t,n,i=ph.workingColorSpace){return this.r=e,this.g=t,this.b=n,ph.colorSpaceToWorking(this,i),this}setHSL(e,t,n,i=ph.workingColorSpace){if(e=(e%(s=1)+s)%s,t=Xc(t,0,1),n=Xc(n,0,1),0===t)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+t):n+t-n*t,s=2*n-i;this.r=Xu(s,i,e+1/3),this.g=Xu(s,i,e),this.b=Xu(s,i,e-1/3)}var s;return ph.colorSpaceToWorking(this,i),this}setStyle(e,t=Ec){function n(e){void 0!==e&&parseFloat(e)}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let e;const s=i[1],r=i[2];switch(s){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return n(e[4]),this.setRGB(Math.min(255,parseInt(e[1],10))/255,Math.min(255,parseInt(e[2],10))/255,Math.min(255,parseInt(e[3],10))/255,t);if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return n(e[4]),this.setRGB(Math.min(100,parseInt(e[1],10))/100,Math.min(100,parseInt(e[2],10))/100,Math.min(100,parseInt(e[3],10))/100,t);break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return n(e[4]),this.setHSL(parseFloat(e[1])/360,parseFloat(e[2])/100,parseFloat(e[3])/100,t)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=i[1],n=e.length;if(3===n)return this.setRGB(parseInt(e.charAt(0),16)/15,parseInt(e.charAt(1),16)/15,parseInt(e.charAt(2),16)/15,t);if(6===n)return this.setHex(parseInt(e,16),t)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=Ec){const n=Wu[e.toLowerCase()];return void 0!==n&&this.setHex(n,t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=mh(e.r),this.g=mh(e.g),this.b=mh(e.b),this}copyLinearToSRGB(e){return this.r=fh(e.r),this.g=fh(e.g),this.b=fh(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=Ec){return ph.workingToColorSpace($u.copy(this),e),65536*Math.round(Xc(255*$u.r,0,255))+256*Math.round(Xc(255*$u.g,0,255))+Math.round(Xc(255*$u.b,0,255))}getHexString(e=Ec){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=ph.workingColorSpace){ph.workingToColorSpace($u.copy(this),t);const n=$u.r,i=$u.g,s=$u.b,r=Math.max(n,i,s),a=Math.min(n,i,s);let o,l;const c=(a+r)/2;if(a===r)o=0,l=0;else{const e=r-a;switch(l=c<=.5?e/(r+a):e/(2-r-a),r){case n:o=(i-s)/e+(i<s?6:0);break;case i:o=(s-n)/e+2;break;case s:o=(n-i)/e+4}o/=6}return e.h=o,e.s=l,e.l=c,e}getRGB(e,t=ph.workingColorSpace){return ph.workingToColorSpace($u.copy(this),t),e.r=$u.r,e.g=$u.g,e.b=$u.b,e}getStyle(e=Ec){ph.workingToColorSpace($u.copy(this),e);const t=$u.r,n=$u.g,i=$u.b;return e!==Ec?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*i)})`}offsetHSL(e,t,n){return this.getHSL(Gu),this.setHSL(Gu.h+e,Gu.s+t,Gu.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(Gu),e.getHSL(qu);const n=Yc(Gu.h,qu.h,t),i=Yc(Gu.s,qu.s,t),s=Yc(Gu.l,qu.l,t);return this.setHSL(n,i,s),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,i=this.b,s=e.elements;return this.r=s[0]*t+s[3]*n+s[6]*i,this.g=s[1]*t+s[4]*n+s[7]*i,this.b=s[2]*t+s[5]*n+s[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const $u=new Yu;Yu.NAMES=Wu;let Zu=0;class Ku extends Vc{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Zu++}),this.uuid=qc(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=$o,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Yu(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Rc,this.stencilZFail=Rc,this.stencilZPass=Rc,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n)continue;const i=this[t];void 0!==i&&(i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[t]=n)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function i(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(n.dispersion=this.dispersion),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),0!==this.side&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),204!==this.blendSrc&&(n.blendSrc=this.blendSrc),205!==this.blendDst&&(n.blendDst=this.blendDst),this.blendEquation!==$o&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Rc&&(n.stencilFail=this.stencilFail),this.stencilZFail!==Rc&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==Rc&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=i(e.textures),s=i(e.images);t.length>0&&(n.textures=t),s.length>0&&(n.images=s)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let i=0;i!==e;++i)n[i]=t[i].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class Ju extends Ku{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Yu(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new du,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const Qu=new eh,ed=new Jc;let td=0;class nd{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:td++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=35044,this.updateRanges=[],this.gpuType=Ol,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let i=0,s=this.itemSize;i<s;i++)this.array[e+i]=t.array[n+i];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)ed.fromBufferAttribute(this,t),ed.applyMatrix3(e),this.setXY(t,ed.x,ed.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)Qu.fromBufferAttribute(this,t),Qu.applyMatrix3(e),this.setXYZ(t,Qu.x,Qu.y,Qu.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)Qu.fromBufferAttribute(this,t),Qu.applyMatrix4(e),this.setXYZ(t,Qu.x,Qu.y,Qu.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Qu.fromBufferAttribute(this,t),Qu.applyNormalMatrix(e),this.setXYZ(t,Qu.x,Qu.y,Qu.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Qu.fromBufferAttribute(this,t),Qu.transformDirection(e),this.setXYZ(t,Qu.x,Qu.y,Qu.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=$c(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=Zc(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=$c(t,this.array)),t}setX(e,t){return this.normalized&&(t=Zc(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=$c(t,this.array)),t}setY(e,t){return this.normalized&&(t=Zc(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=$c(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Zc(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=$c(t,this.array)),t}setW(e,t){return this.normalized&&(t=Zc(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=Zc(t,this.array),n=Zc(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,i){return e*=this.itemSize,this.normalized&&(t=Zc(t,this.array),n=Zc(n,this.array),i=Zc(i,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this}setXYZW(e,t,n,i,s){return e*=this.itemSize,this.normalized&&(t=Zc(t,this.array),n=Zc(n,this.array),i=Zc(i,this.array),s=Zc(s,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this.array[e+3]=s,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class id extends nd{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class sd extends nd{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class rd extends nd{constructor(e,t,n){super(new Float32Array(e),t,n)}}let ad=0;const od=new nu,ld=new Nu,cd=new eh,hd=new Nh,ud=new Nh,dd=new eh;class pd extends Vc{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:ad++}),this.uuid=qc(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(rh(e)?sd:id)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new ih).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(e),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return od.makeRotationFromQuaternion(e),this.applyMatrix4(od),this}rotateX(e){return od.makeRotationX(e),this.applyMatrix4(od),this}rotateY(e){return od.makeRotationY(e),this.applyMatrix4(od),this}rotateZ(e){return od.makeRotationZ(e),this.applyMatrix4(od),this}translate(e,t,n){return od.makeTranslation(e,t,n),this.applyMatrix4(od),this}scale(e,t,n){return od.makeScale(e,t,n),this.applyMatrix4(od),this}lookAt(e){return ld.lookAt(e),ld.updateMatrix(),this.applyMatrix4(ld.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(cd).negate(),this.translate(cd.x,cd.y,cd.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];t.push(i.x,i.y,i.z||0)}this.setAttribute("position",new rd(t,3))}else{const n=Math.min(e.length,t.count);for(let i=0;i<n;i++){const n=e[i];t.setXYZ(i,n.x,n.y,n.z||0)}e.length,t.count,t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Nh);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingBox.set(new eh(-1/0,-1/0,-1/0),new eh(1/0,1/0,1/0));else{if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];hd.setFromBufferAttribute(n),this.morphTargetsRelative?(dd.addVectors(this.boundingBox.min,hd.min),this.boundingBox.expandByPoint(dd),dd.addVectors(this.boundingBox.max,hd.max),this.boundingBox.expandByPoint(dd)):(this.boundingBox.expandByPoint(hd.min),this.boundingBox.expandByPoint(hd.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Xh);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingSphere.set(new eh,1/0);else if(e){const n=this.boundingSphere.center;if(hd.setFromBufferAttribute(e),t)for(let e=0,s=t.length;e<s;e++){const n=t[e];ud.setFromBufferAttribute(n),this.morphTargetsRelative?(dd.addVectors(hd.min,ud.min),hd.expandByPoint(dd),dd.addVectors(hd.max,ud.max),hd.expandByPoint(dd)):(hd.expandByPoint(ud.min),hd.expandByPoint(ud.max))}hd.getCenter(n);let i=0;for(let t=0,s=e.count;t<s;t++)dd.fromBufferAttribute(e,t),i=Math.max(i,n.distanceToSquared(dd));if(t)for(let s=0,r=t.length;s<r;s++){const r=t[s],a=this.morphTargetsRelative;for(let t=0,s=r.count;t<s;t++)dd.fromBufferAttribute(r,t),a&&(cd.fromBufferAttribute(e,t),dd.add(cd)),i=Math.max(i,n.distanceToSquared(dd))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return;const n=t.position,i=t.normal,s=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new nd(new Float32Array(4*n.count),4));const r=this.getAttribute("tangent"),a=[],o=[];for(let S=0;S<n.count;S++)a[S]=new eh,o[S]=new eh;const l=new eh,c=new eh,h=new eh,u=new Jc,d=new Jc,p=new Jc,m=new eh,f=new eh;function g(e,t,i){l.fromBufferAttribute(n,e),c.fromBufferAttribute(n,t),h.fromBufferAttribute(n,i),u.fromBufferAttribute(s,e),d.fromBufferAttribute(s,t),p.fromBufferAttribute(s,i),c.sub(l),h.sub(l),d.sub(u),p.sub(u);const r=1/(d.x*p.y-p.x*d.y);isFinite(r)&&(m.copy(c).multiplyScalar(p.y).addScaledVector(h,-d.y).multiplyScalar(r),f.copy(h).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(r),a[e].add(m),a[t].add(m),a[i].add(m),o[e].add(f),o[t].add(f),o[i].add(f))}let v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let S=0,M=v.length;S<M;++S){const t=v[S],n=t.start;for(let i=n,s=n+t.count;i<s;i+=3)g(e.getX(i+0),e.getX(i+1),e.getX(i+2))}const x=new eh,y=new eh,_=new eh,b=new eh;function w(e){_.fromBufferAttribute(i,e),b.copy(_);const t=a[e];x.copy(t),x.sub(_.multiplyScalar(_.dot(t))).normalize(),y.crossVectors(b,t);const n=y.dot(o[e])<0?-1:1;r.setXYZW(e,x.x,x.y,x.z,n)}for(let S=0,M=v.length;S<M;++S){const t=v[S],n=t.start;for(let i=n,s=n+t.count;i<s;i+=3)w(e.getX(i+0)),w(e.getX(i+1)),w(e.getX(i+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new nd(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const i=new eh,s=new eh,r=new eh,a=new eh,o=new eh,l=new eh,c=new eh,h=new eh;if(e)for(let u=0,d=e.count;u<d;u+=3){const d=e.getX(u+0),p=e.getX(u+1),m=e.getX(u+2);i.fromBufferAttribute(t,d),s.fromBufferAttribute(t,p),r.fromBufferAttribute(t,m),c.subVectors(r,s),h.subVectors(i,s),c.cross(h),a.fromBufferAttribute(n,d),o.fromBufferAttribute(n,p),l.fromBufferAttribute(n,m),a.add(c),o.add(c),l.add(c),n.setXYZ(d,a.x,a.y,a.z),n.setXYZ(p,o.x,o.y,o.z),n.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,u=t.count;e<u;e+=3)i.fromBufferAttribute(t,e+0),s.fromBufferAttribute(t,e+1),r.fromBufferAttribute(t,e+2),c.subVectors(r,s),h.subVectors(i,s),c.cross(h),n.setXYZ(e+0,c.x,c.y,c.z),n.setXYZ(e+1,c.x,c.y,c.z),n.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)dd.fromBufferAttribute(e,t),dd.normalize(),e.setXYZ(t,dd.x,dd.y,dd.z)}toNonIndexed(){function e(e,t){const n=e.array,i=e.itemSize,s=e.normalized,r=new n.constructor(t.length*i);let a=0,o=0;for(let l=0,c=t.length;l<c;l++){a=e.isInterleavedBufferAttribute?t[l]*e.data.stride+e.offset:t[l]*i;for(let e=0;e<i;e++)r[o++]=n[a++]}return new nd(r,i,s)}if(null===this.index)return this;const t=new pd,n=this.index.array,i=this.attributes;for(const a in i){const s=e(i[a],n);t.setAttribute(a,s)}const s=this.morphAttributes;for(const a in s){const i=[],r=s[a];for(let t=0,s=r.length;t<s;t++){const s=e(r[t],n);i.push(s)}t.morphAttributes[a]=i}t.morphTargetsRelative=this.morphTargetsRelative;const r=this.groups;for(let a=0,o=r.length;a<o;a++){const e=r[a];t.addGroup(e.start,e.count,e.materialIndex)}return t}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const o in n){const t=n[o];e.data.attributes[o]=t.toJSON(e.data)}const i={};let s=!1;for(const o in this.morphAttributes){const t=this.morphAttributes[o],n=[];for(let i=0,s=t.length;i<s;i++){const s=t[i];n.push(s.toJSON(e.data))}n.length>0&&(i[o]=n,s=!0)}s&&(e.data.morphAttributes=i,e.data.morphTargetsRelative=this.morphTargetsRelative);const r=this.groups;r.length>0&&(e.data.groups=JSON.parse(JSON.stringify(r)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere=a.toJSON()),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone());const i=e.attributes;for(const l in i){const e=i[l];this.setAttribute(l,e.clone(t))}const s=e.morphAttributes;for(const l in s){const e=[],n=s[l];for(let i=0,s=n.length;i<s;i++)e.push(n[i].clone(t));this.morphAttributes[l]=e}this.morphTargetsRelative=e.morphTargetsRelative;const r=e.groups;for(let l=0,c=r.length;l<c;l++){const e=r[l];this.addGroup(e.start,e.count,e.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const md=new nu,fd=new tu,gd=new Xh,vd=new eh,xd=new eh,yd=new eh,_d=new eh,bd=new eh,wd=new eh,Sd=new eh,Md=new eh;class Td extends Nu{constructor(e=new pd,t=new Ju){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,i=n.attributes.position,s=n.morphAttributes.position,r=n.morphTargetsRelative;t.fromBufferAttribute(i,e);const a=this.morphTargetInfluences;if(s&&a){wd.set(0,0,0);for(let n=0,i=s.length;n<i;n++){const i=a[n],o=s[n];0!==i&&(bd.fromBufferAttribute(o,e),r?wd.addScaledVector(bd,i):wd.addScaledVector(bd.sub(t),i))}t.add(wd)}return t}raycast(e,t){const n=this.geometry,i=this.material,s=this.matrixWorld;if(void 0!==i){if(null===n.boundingSphere&&n.computeBoundingSphere(),gd.copy(n.boundingSphere),gd.applyMatrix4(s),fd.copy(e.ray).recast(e.near),!1===gd.containsPoint(fd.origin)){if(null===fd.intersectSphere(gd,vd))return;if(fd.origin.distanceToSquared(vd)>(e.far-e.near)**2)return}md.copy(s).invert(),fd.copy(e.ray).applyMatrix4(md),null!==n.boundingBox&&!1===fd.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,fd)}}_computeIntersections(e,t,n){let i;const s=this.geometry,r=this.material,a=s.index,o=s.attributes.position,l=s.attributes.uv,c=s.attributes.uv1,h=s.attributes.normal,u=s.groups,d=s.drawRange;if(null!==a)if(Array.isArray(r))for(let p=0,m=u.length;p<m;p++){const s=u[p],o=r[s.materialIndex];for(let r=Math.max(s.start,d.start),u=Math.min(a.count,Math.min(s.start+s.count,d.start+d.count));r<u;r+=3)i=Ed(this,o,e,n,l,c,h,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=s.materialIndex,t.push(i))}else for(let p=Math.max(0,d.start),m=Math.min(a.count,d.start+d.count);p<m;p+=3)i=Ed(this,r,e,n,l,c,h,a.getX(p),a.getX(p+1),a.getX(p+2)),i&&(i.faceIndex=Math.floor(p/3),t.push(i));else if(void 0!==o)if(Array.isArray(r))for(let p=0,m=u.length;p<m;p++){const s=u[p],a=r[s.materialIndex];for(let r=Math.max(s.start,d.start),u=Math.min(o.count,Math.min(s.start+s.count,d.start+d.count));r<u;r+=3)i=Ed(this,a,e,n,l,c,h,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=s.materialIndex,t.push(i))}else for(let p=Math.max(0,d.start),m=Math.min(o.count,d.start+d.count);p<m;p+=3)i=Ed(this,r,e,n,l,c,h,p,p+1,p+2),i&&(i.faceIndex=Math.floor(p/3),t.push(i))}}function Ed(e,t,n,i,s,r,a,o,l,c){e.getVertexPosition(o,xd),e.getVertexPosition(l,yd),e.getVertexPosition(c,_d);const h=function(e,t,n,i,s,r,a,o){let l;if(l=1===t.side?i.intersectTriangle(a,r,s,!0,o):i.intersectTriangle(s,r,a,0===t.side,o),null===l)return null;Md.copy(o),Md.applyMatrix4(e.matrixWorld);const c=n.ray.origin.distanceTo(Md);return c<n.near||c>n.far?null:{distance:c,point:Md.clone(),object:e}}(e,t,n,i,xd,yd,_d,Sd);if(h){const e=new eh;Hu.getBarycoord(Sd,xd,yd,_d,e),s&&(h.uv=Hu.getInterpolatedAttribute(s,o,l,c,e,new Jc)),r&&(h.uv1=Hu.getInterpolatedAttribute(r,o,l,c,e,new Jc)),a&&(h.normal=Hu.getInterpolatedAttribute(a,o,l,c,e,new eh),h.normal.dot(i.direction)>0&&h.normal.multiplyScalar(-1));const t={a:o,b:l,c:c,normal:new eh,materialIndex:0};Hu.getNormal(xd,yd,_d,t.normal),h.face=t,h.barycoord=e}return h}class Cd extends pd{constructor(e=1,t=1,n=1,i=1,s=1,r=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:i,heightSegments:s,depthSegments:r};const a=this;i=Math.floor(i),s=Math.floor(s),r=Math.floor(r);const o=[],l=[],c=[],h=[];let u=0,d=0;function p(e,t,n,i,s,r,p,m,f,g,v){const x=r/f,y=p/g,_=r/2,b=p/2,w=m/2,S=f+1,M=g+1;let T=0,E=0;const C=new eh;for(let a=0;a<M;a++){const r=a*y-b;for(let o=0;o<S;o++){const u=o*x-_;C[e]=u*i,C[t]=r*s,C[n]=w,l.push(C.x,C.y,C.z),C[e]=0,C[t]=0,C[n]=m>0?1:-1,c.push(C.x,C.y,C.z),h.push(o/f),h.push(1-a/g),T+=1}}for(let a=0;a<g;a++)for(let e=0;e<f;e++){const t=u+e+S*a,n=u+e+S*(a+1),i=u+(e+1)+S*(a+1),s=u+(e+1)+S*a;o.push(t,n,s),o.push(n,i,s),E+=6}a.addGroup(d,E,v),d+=E,u+=T}p("z","y","x",-1,-1,n,t,e,r,s,0),p("z","y","x",1,-1,n,t,-e,r,s,1),p("x","z","y",1,1,e,n,t,i,r,2),p("x","z","y",1,-1,e,n,-t,i,r,3),p("x","y","z",1,-1,e,t,n,i,s,4),p("x","y","z",-1,-1,e,t,-n,i,s,5),this.setIndex(o),this.setAttribute("position",new rd(l,3)),this.setAttribute("normal",new rd(c,3)),this.setAttribute("uv",new rd(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Cd(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Ad(e){const t={};for(const n in e){t[n]={};for(const i in e[n]){const s=e[n][i];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?t[n][i]=null:t[n][i]=s.clone():Array.isArray(s)?t[n][i]=s.slice():t[n][i]=s}}return t}function Nd(e){const t={};for(let n=0;n<e.length;n++){const i=Ad(e[n]);for(const e in i)t[e]=i[e]}return t}function Rd(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:ph.workingColorSpace}const Pd={clone:Ad,merge:Nd};class Id extends Ku{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Ad(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?t.uniforms[i]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?t.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?t.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?t.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?t.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?t.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?t.uniforms[i]={type:"m4",value:n.toArray()}:t.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const n={};for(const i in this.extensions)!0===this.extensions[i]&&(n[i]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}class jd extends Nu{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new nu,this.projectionMatrix=new nu,this.projectionMatrixInverse=new nu,this.coordinateSystem=Bc}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const Dd=new eh,kd=new Jc,Ld=new Jc;class Od extends jd{constructor(e=50,t=1,n=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*Gc*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*Wc*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*Gc*Math.atan(Math.tan(.5*Wc*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){Dd.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(Dd.x,Dd.y).multiplyScalar(-e/Dd.z),Dd.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(Dd.x,Dd.y).multiplyScalar(-e/Dd.z)}getViewSize(e,t){return this.getViewBounds(e,kd,Ld),t.subVectors(Ld,kd)}setViewOffset(e,t,n,i,s,r){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*Wc*this.fov)/this.zoom,n=2*t,i=this.aspect*n,s=-.5*i;const r=this.view;if(null!==this.view&&this.view.enabled){const e=r.fullWidth,a=r.fullHeight;s+=r.offsetX*i/e,t-=r.offsetY*n/a,i*=r.width/e,n*=r.height/a}const a=this.filmOffset;0!==a&&(s+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+i,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const Ud=-90;class Fd extends Nu{constructor(e,t,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new Od(Ud,1,e,t);i.layers=this.layers,this.add(i);const s=new Od(Ud,1,e,t);s.layers=this.layers,this.add(s);const r=new Od(Ud,1,e,t);r.layers=this.layers,this.add(r);const a=new Od(Ud,1,e,t);a.layers=this.layers,this.add(a);const o=new Od(Ud,1,e,t);o.layers=this.layers,this.add(o);const l=new Od(Ud,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[n,i,s,r,a,o]=t;for(const l of t)this.remove(l);if(e===Bc)n.up.set(0,1,0),n.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),r.up.set(0,0,1),r.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==zc)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);n.up.set(0,-1,0),n.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),r.up.set(0,0,-1),r.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const l of t)this.add(l),l.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:i}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[s,r,a,o,l,c]=this.children,h=e.getRenderTarget(),u=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const m=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,i),e.render(t,s),e.setRenderTarget(n,1,i),e.render(t,r),e.setRenderTarget(n,2,i),e.render(t,a),e.setRenderTarget(n,3,i),e.render(t,o),e.setRenderTarget(n,4,i),e.render(t,l),n.texture.generateMipmaps=m,e.setRenderTarget(n,5,i),e.render(t,c),e.setRenderTarget(h,u,d),e.xr.enabled=p,n.texture.needsPMREMUpdate=!0}}class Bd extends Sh{constructor(e=[],t=301,n,i,s,r,a,o,l,c){super(e,t,n,i,s,r,a,o,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class zd extends Eh{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},i=[n,n,n,n,n,n];this.texture=new Bd(i),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={tEquirect:{value:null}},i="\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",s="\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t",r=new Cd(5,5,5),a=new Id({name:"CubemapFromEquirect",uniforms:Ad(n),vertexShader:i,fragmentShader:s,side:1,blending:0});a.uniforms.tEquirect.value=t;const o=new Td(r,a),l=t.minFilter;return t.minFilter===Il&&(t.minFilter=Rl),new Fd(1,10,this).update(e,o),t.minFilter=l,o.geometry.dispose(),o.material.dispose(),this}clear(e,t=!0,n=!0,i=!0){const s=e.getRenderTarget();for(let r=0;r<6;r++)e.setRenderTarget(this,r),e.clear(t,n,i);e.setRenderTarget(s)}}class Vd extends Nu{constructor(){super(),this.isGroup=!0,this.type="Group"}}const Hd={type:"move"};class Wd{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Vd,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Vd,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new eh,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new eh),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Vd,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new eh,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new eh),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,n){let i=null,s=null,r=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){r=!0;for(const r of e.hand.values()){const e=t.getJointPose(r,n),i=this._getHandJoint(l,r);null!==e&&(i.matrix.fromArray(e.transform.matrix),i.matrix.decompose(i.position,i.rotation,i.scale),i.matrixWorldNeedsUpdate=!0,i.jointRadius=e.radius),i.visible=null!==e}const i=l.joints["index-finger-tip"],s=l.joints["thumb-tip"],a=i.position.distanceTo(s.position),o=.02,c=.005;l.inputState.pinching&&a>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(s=t.getPose(e.gripSpace,n),null!==s&&(o.matrix.fromArray(s.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,s.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(s.linearVelocity)):o.hasLinearVelocity=!1,s.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(s.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(i=t.getPose(e.targetRaySpace,n),null===i&&null!==s&&(i=s),null!==i&&(a.matrix.fromArray(i.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,i.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(i.linearVelocity)):a.hasLinearVelocity=!1,i.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(i.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(Hd)))}return null!==a&&(a.visible=null!==i),null!==o&&(o.visible=null!==s),null!==l&&(l.visible=null!==r),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const n=new Vd;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}}class Gd extends Nu{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new du,this.environmentIntensity=1,this.environmentRotation=new du,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}const qd=new eh,Xd=new eh,Yd=new ih;class $d{constructor(e=new eh(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,i){return this.normal.set(e,t,n),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const i=qd.subVectors(n,t).cross(Xd.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(qd),i=this.normal.dot(n);if(0===i)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const s=-(e.start.dot(this.normal)+this.constant)/i;return s<0||s>1?null:t.copy(e.start).addScaledVector(n,s)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||Yd.getNormalMatrix(e),i=this.coplanarPoint(qd).applyMatrix4(e),s=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(s),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const Zd=new Xh,Kd=new Jc(.5,.5),Jd=new eh;class Qd{constructor(e=new $d,t=new $d,n=new $d,i=new $d,s=new $d,r=new $d){this.planes=[e,t,n,i,s,r]}set(e,t,n,i,s,r){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(n),a[3].copy(i),a[4].copy(s),a[5].copy(r),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,i=e.elements,s=i[0],r=i[1],a=i[2],o=i[3],l=i[4],c=i[5],h=i[6],u=i[7],d=i[8],p=i[9],m=i[10],f=i[11],g=i[12],v=i[13],x=i[14],y=i[15];if(n[0].setComponents(o-s,u-l,f-d,y-g).normalize(),n[1].setComponents(o+s,u+l,f+d,y+g).normalize(),n[2].setComponents(o+r,u+c,f+p,y+v).normalize(),n[3].setComponents(o-r,u-c,f-p,y-v).normalize(),n[4].setComponents(o-a,u-h,f-m,y-x).normalize(),t===Bc)n[5].setComponents(o+a,u+h,f+m,y+x).normalize();else{if(t!==zc)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(a,h,m,x).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),Zd.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),Zd.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(Zd)}intersectsSprite(e){Zd.center.set(0,0,0);const t=Kd.distanceTo(e.center);return Zd.radius=.7071067811865476+t,Zd.applyMatrix4(e.matrixWorld),this.intersectsSphere(Zd)}intersectsSphere(e){const t=this.planes,n=e.center,i=-e.radius;for(let s=0;s<6;s++)if(t[s].distanceToPoint(n)<i)return!1;return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const i=t[n];if(Jd.x=i.normal.x>0?e.max.x:e.min.x,Jd.y=i.normal.y>0?e.max.y:e.min.y,Jd.z=i.normal.z>0?e.max.z:e.min.z,i.distanceToPoint(Jd)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class ep extends Sh{constructor(e,t,n=1014,i,s,r,a=1003,o=1003,l,c=1026,h=1){if(c!==Hl&&c!==Wl)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:t,depth:h},i,s,r,a,o,c,n,l),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new yh(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class tp extends pd{constructor(e=[],t=[],n=1,i=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:n,detail:i};const s=[],r=[];function a(e,t,n,i){const s=i+1,r=[];for(let a=0;a<=s;a++){r[a]=[];const i=e.clone().lerp(n,a/s),o=t.clone().lerp(n,a/s),l=s-a;for(let e=0;e<=l;e++)r[a][e]=0===e&&a===s?i:i.clone().lerp(o,e/l)}for(let a=0;a<s;a++)for(let e=0;e<2*(s-a)-1;e++){const t=Math.floor(e/2);e%2==0?(o(r[a][t+1]),o(r[a+1][t]),o(r[a][t])):(o(r[a][t+1]),o(r[a+1][t+1]),o(r[a+1][t]))}}function o(e){s.push(e.x,e.y,e.z)}function l(t,n){const i=3*t;n.x=e[i+0],n.y=e[i+1],n.z=e[i+2]}function c(e,t,n,i){i<0&&1===e.x&&(r[t]=e.x-1),0===n.x&&0===n.z&&(r[t]=i/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}function u(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}!function(e){const n=new eh,i=new eh,s=new eh;for(let r=0;r<t.length;r+=3)l(t[r+0],n),l(t[r+1],i),l(t[r+2],s),a(n,i,s,e)}(i),function(e){const t=new eh;for(let n=0;n<s.length;n+=3)t.x=s[n+0],t.y=s[n+1],t.z=s[n+2],t.normalize().multiplyScalar(e),s[n+0]=t.x,s[n+1]=t.y,s[n+2]=t.z}(n),function(){const e=new eh;for(let t=0;t<s.length;t+=3){e.x=s[t+0],e.y=s[t+1],e.z=s[t+2];const n=h(e)/2/Math.PI+.5,i=u(e)/Math.PI+.5;r.push(n,1-i)}(function(){const e=new eh,t=new eh,n=new eh,i=new eh,a=new Jc,o=new Jc,l=new Jc;for(let u=0,d=0;u<s.length;u+=9,d+=6){e.set(s[u+0],s[u+1],s[u+2]),t.set(s[u+3],s[u+4],s[u+5]),n.set(s[u+6],s[u+7],s[u+8]),a.set(r[d+0],r[d+1]),o.set(r[d+2],r[d+3]),l.set(r[d+4],r[d+5]),i.copy(e).add(t).add(n).divideScalar(3);const p=h(i);c(a,d+0,e,p),c(o,d+2,t,p),c(l,d+4,n,p)}})(),function(){for(let e=0;e<r.length;e+=6){const t=r[e+0],n=r[e+2],i=r[e+4],s=Math.max(t,n,i),a=Math.min(t,n,i);s>.9&&a<.1&&(t<.2&&(r[e+0]+=1),n<.2&&(r[e+2]+=1),i<.2&&(r[e+4]+=1))}}()}(),this.setAttribute("position",new rd(s,3)),this.setAttribute("normal",new rd(s.slice(),3)),this.setAttribute("uv",new rd(r,2)),0===i?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new tp(e.vertices,e.indices,e.radius,e.details)}}class np extends tp{constructor(e=1,t=0){const n=(1+Math.sqrt(5))/2,i=1/n;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-n,0,-i,n,0,i,-n,0,i,n,-i,-n,0,-i,n,0,i,-n,0,i,n,0,-n,0,-i,n,0,-i,-n,0,i,n,0,i],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new np(e.radius,e.detail)}}class ip extends tp{constructor(e=1,t=0){const n=(1+Math.sqrt(5))/2;super([-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new ip(e.radius,e.detail)}}class sp extends tp{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new sp(e.radius,e.detail)}}class rp extends pd{constructor(e=1,t=1,n=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:i};const s=e/2,r=t/2,a=Math.floor(n),o=Math.floor(i),l=a+1,c=o+1,h=e/a,u=t/o,d=[],p=[],m=[],f=[];for(let g=0;g<c;g++){const e=g*u-r;for(let t=0;t<l;t++){const n=t*h-s;p.push(n,-e,0),m.push(0,0,1),f.push(t/a),f.push(1-g/o)}}for(let g=0;g<o;g++)for(let e=0;e<a;e++){const t=e+l*g,n=e+l*(g+1),i=e+1+l*(g+1),s=e+1+l*g;d.push(t,n,s),d.push(n,i,s)}this.setIndex(d),this.setAttribute("position",new rd(p,3)),this.setAttribute("normal",new rd(m,3)),this.setAttribute("uv",new rd(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new rp(e.width,e.height,e.widthSegments,e.heightSegments)}}class ap extends tp{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new ap(e.radius,e.detail)}}class op extends Ku{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new Yu(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Yu(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Jc(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new du,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class lp extends Ku{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class cp extends Ku{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class hp extends Nu{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Yu(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}const up=new nu,dp=new eh,pp=new eh;class mp{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Jc(512,512),this.mapType=jl,this.map=null,this.mapPass=null,this.matrix=new nu,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Qd,this._frameExtents=new Jc(1,1),this._viewportCount=1,this._viewports=[new Mh(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;dp.setFromMatrixPosition(e.matrixWorld),t.position.copy(dp),pp.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(pp),t.updateMatrixWorld(),up.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(up),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(up)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class fp extends jd{constructor(e=-1,t=1,n=1,i=-1,s=.1,r=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=i,this.near=s,this.far=r,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,i,s,r){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let s=n-e,r=n+e,a=i+t,o=i-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;s+=e*this.view.offsetX,r=s+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(s,r,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class gp extends mp{constructor(){super(new fp(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class vp extends hp{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Nu.DEFAULT_UP),this.updateMatrix(),this.target=new Nu,this.shadow=new gp}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class xp extends hp{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class yp extends Od{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class _p{constructor(e=1,t=0,n=0){this.radius=e,this.phi=t,this.theta=n}set(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Xc(this.phi,e,Math.PI-e),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+t*t+n*n),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(Xc(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class bp extends Vc{constructor(e,t=null){super(),this.object=e,this.domElement=t,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(e){void 0!==e&&(null!==this.domElement&&this.disconnect(),this.domElement=e)}disconnect(){}dispose(){}update(){}}function wp(e,t,n,i){const s=function(e){switch(e){case jl:case 1010:return{byteLength:1,components:1};case Dl:case 1011:case Ul:return{byteLength:2,components:1};case Fl:case Bl:return{byteLength:2,components:4};case Ll:case kl:case Ol:return{byteLength:4,components:1};case 35902:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(i);switch(n){case 1021:return e*t;case 1028:case Gl:return e*t/s.components*s.byteLength;case 1030:case ql:return e*t*2/s.components*s.byteLength;case 1022:return e*t*3/s.components*s.byteLength;case Vl:case Xl:return e*t*4/s.components*s.byteLength;case Yl:case $l:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Zl:case Kl:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Ql:case tc:return Math.max(e,16)*Math.max(t,8)/4;case Jl:case ec:return Math.max(e,8)*Math.max(t,8)/2;case nc:case ic:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case sc:case rc:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case ac:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case oc:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case lc:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case cc:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case hc:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case uc:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case dc:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case pc:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case mc:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case fc:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case gc:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case vc:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case xc:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case yc:case _c:case bc:return Math.ceil(e/4)*Math.ceil(t/4)*16;case 36283:case wc:return Math.ceil(e/4)*Math.ceil(t/4)*8;case Sc:case Mc:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${n} format.`)}
/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
function Sp(){let e=null,t=!1,n=null,i=null;function s(t,r){n(t,r),i=e.requestAnimationFrame(s)}return{start:function(){!0!==t&&null!==n&&(i=e.requestAnimationFrame(s),t=!0)},stop:function(){e.cancelAnimationFrame(i),t=!1},setAnimationLoop:function(e){n=e},setContext:function(t){e=t}}}function Mp(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(n){n.isInterleavedBufferAttribute&&(n=n.data);const i=t.get(n);i&&(e.deleteBuffer(i.buffer),t.delete(n))},update:function(n,i){if(n.isInterleavedBufferAttribute&&(n=n.data),n.isGLBufferAttribute){const e=t.get(n);return void((!e||e.version<n.version)&&t.set(n,{buffer:n.buffer,type:n.type,bytesPerElement:n.elementSize,version:n.version}))}const s=t.get(n);if(void 0===s)t.set(n,function(t,n){const i=t.array,s=t.usage,r=i.byteLength,a=e.createBuffer();let o;if(e.bindBuffer(n,a),e.bufferData(n,i,s),t.onUploadCallback(),i instanceof Float32Array)o=e.FLOAT;else if("undefined"!=typeof Float16Array&&i instanceof Float16Array)o=e.HALF_FLOAT;else if(i instanceof Uint16Array)o=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(i instanceof Int16Array)o=e.SHORT;else if(i instanceof Uint32Array)o=e.UNSIGNED_INT;else if(i instanceof Int32Array)o=e.INT;else if(i instanceof Int8Array)o=e.BYTE;else if(i instanceof Uint8Array)o=e.UNSIGNED_BYTE;else{if(!(i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+i);o=e.UNSIGNED_BYTE}return{buffer:a,type:o,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version,size:r}}(n,i));else if(s.version<n.version){if(s.size!==n.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,n,i){const s=n.array,r=n.updateRanges;if(e.bindBuffer(i,t),0===r.length)e.bufferSubData(i,0,s);else{r.sort((e,t)=>e.start-t.start);let t=0;for(let e=1;e<r.length;e++){const n=r[t],i=r[e];i.start<=n.start+n.count+1?n.count=Math.max(n.count,i.start+i.count-n.start):(++t,r[t]=i)}r.length=t+1;for(let n=0,a=r.length;n<a;n++){const t=r[n];e.bufferSubData(i,t.start*s.BYTES_PER_ELEMENT,s,t.start,t.count)}n.clearUpdateRanges()}n.onUploadCallback()}(s.buffer,n,i),s.version=n.version}}}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Go}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__=Go));const Tp={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\t\n\t\tfloat lightToPositionLength = length( lightToPosition );\n\t\tif ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\t\tdp += shadowBias;\n\t\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t#else\n\t\t\t\tshadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t#else\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},Ep={common:{diffuse:{value:new Yu(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new ih},alphaMap:{value:null},alphaMapTransform:{value:new ih},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new ih}},envmap:{envMap:{value:null},envMapRotation:{value:new ih},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new ih}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new ih}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new ih},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new ih},normalScale:{value:new Jc(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new ih},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new ih}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new ih}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new ih}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Yu(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Yu(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new ih},alphaTest:{value:0},uvTransform:{value:new ih}},sprite:{diffuse:{value:new Yu(16777215)},opacity:{value:1},center:{value:new Jc(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new ih},alphaMap:{value:null},alphaMapTransform:{value:new ih},alphaTest:{value:0}}},Cp={basic:{uniforms:Nd([Ep.common,Ep.specularmap,Ep.envmap,Ep.aomap,Ep.lightmap,Ep.fog]),vertexShader:Tp.meshbasic_vert,fragmentShader:Tp.meshbasic_frag},lambert:{uniforms:Nd([Ep.common,Ep.specularmap,Ep.envmap,Ep.aomap,Ep.lightmap,Ep.emissivemap,Ep.bumpmap,Ep.normalmap,Ep.displacementmap,Ep.fog,Ep.lights,{emissive:{value:new Yu(0)}}]),vertexShader:Tp.meshlambert_vert,fragmentShader:Tp.meshlambert_frag},phong:{uniforms:Nd([Ep.common,Ep.specularmap,Ep.envmap,Ep.aomap,Ep.lightmap,Ep.emissivemap,Ep.bumpmap,Ep.normalmap,Ep.displacementmap,Ep.fog,Ep.lights,{emissive:{value:new Yu(0)},specular:{value:new Yu(1118481)},shininess:{value:30}}]),vertexShader:Tp.meshphong_vert,fragmentShader:Tp.meshphong_frag},standard:{uniforms:Nd([Ep.common,Ep.envmap,Ep.aomap,Ep.lightmap,Ep.emissivemap,Ep.bumpmap,Ep.normalmap,Ep.displacementmap,Ep.roughnessmap,Ep.metalnessmap,Ep.fog,Ep.lights,{emissive:{value:new Yu(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Tp.meshphysical_vert,fragmentShader:Tp.meshphysical_frag},toon:{uniforms:Nd([Ep.common,Ep.aomap,Ep.lightmap,Ep.emissivemap,Ep.bumpmap,Ep.normalmap,Ep.displacementmap,Ep.gradientmap,Ep.fog,Ep.lights,{emissive:{value:new Yu(0)}}]),vertexShader:Tp.meshtoon_vert,fragmentShader:Tp.meshtoon_frag},matcap:{uniforms:Nd([Ep.common,Ep.bumpmap,Ep.normalmap,Ep.displacementmap,Ep.fog,{matcap:{value:null}}]),vertexShader:Tp.meshmatcap_vert,fragmentShader:Tp.meshmatcap_frag},points:{uniforms:Nd([Ep.points,Ep.fog]),vertexShader:Tp.points_vert,fragmentShader:Tp.points_frag},dashed:{uniforms:Nd([Ep.common,Ep.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Tp.linedashed_vert,fragmentShader:Tp.linedashed_frag},depth:{uniforms:Nd([Ep.common,Ep.displacementmap]),vertexShader:Tp.depth_vert,fragmentShader:Tp.depth_frag},normal:{uniforms:Nd([Ep.common,Ep.bumpmap,Ep.normalmap,Ep.displacementmap,{opacity:{value:1}}]),vertexShader:Tp.meshnormal_vert,fragmentShader:Tp.meshnormal_frag},sprite:{uniforms:Nd([Ep.sprite,Ep.fog]),vertexShader:Tp.sprite_vert,fragmentShader:Tp.sprite_frag},background:{uniforms:{uvTransform:{value:new ih},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Tp.background_vert,fragmentShader:Tp.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new ih}},vertexShader:Tp.backgroundCube_vert,fragmentShader:Tp.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Tp.cube_vert,fragmentShader:Tp.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Tp.equirect_vert,fragmentShader:Tp.equirect_frag},distanceRGBA:{uniforms:Nd([Ep.common,Ep.displacementmap,{referencePosition:{value:new eh},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Tp.distanceRGBA_vert,fragmentShader:Tp.distanceRGBA_frag},shadow:{uniforms:Nd([Ep.lights,Ep.fog,{color:{value:new Yu(0)},opacity:{value:1}}]),vertexShader:Tp.shadow_vert,fragmentShader:Tp.shadow_frag}};Cp.physical={uniforms:Nd([Cp.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new ih},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new ih},clearcoatNormalScale:{value:new Jc(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new ih},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new ih},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new ih},sheen:{value:0},sheenColor:{value:new Yu(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new ih},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new ih},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new ih},transmissionSamplerSize:{value:new Jc},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new ih},attenuationDistance:{value:0},attenuationColor:{value:new Yu(0)},specularColor:{value:new Yu(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new ih},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new ih},anisotropyVector:{value:new Jc},anisotropyMap:{value:null},anisotropyMapTransform:{value:new ih}}]),vertexShader:Tp.meshphysical_vert,fragmentShader:Tp.meshphysical_frag};const Ap={r:0,b:0,g:0},Np=new du,Rp=new nu;function Pp(e,t,n,i,s,r,a){const o=new Yu(0);let l,c,h=!0===r?0:1,u=null,d=0,p=null;function m(e){let i=!0===e.isScene?e.background:null;return i&&i.isTexture&&(i=(e.backgroundBlurriness>0?n:t).get(i)),i}function f(t,n){t.getRGB(Ap,Rd(e)),i.buffers.color.setClear(Ap.r,Ap.g,Ap.b,n,a)}return{getClearColor:function(){return o},setClearColor:function(e,t=1){o.set(e),h=t,f(o,h)},getClearAlpha:function(){return h},setClearAlpha:function(e){h=e,f(o,h)},render:function(t){let n=!1;const s=m(t);null===s?f(o,h):s&&s.isColor&&(f(s,1),n=!0);const r=e.xr.getEnvironmentBlendMode();"additive"===r?i.buffers.color.setClear(0,0,0,1,a):"alpha-blend"===r&&i.buffers.color.setClear(0,0,0,0,a),(e.autoClear||n)&&(i.buffers.depth.setTest(!0),i.buffers.depth.setMask(!0),i.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,n){const i=m(n);i&&(i.isCubeTexture||i.mapping===Sl)?(void 0===c&&(c=new Td(new Cd(1,1,1),new Id({name:"BackgroundCubeMaterial",uniforms:Ad(Cp.backgroundCube.uniforms),vertexShader:Cp.backgroundCube.vertexShader,fragmentShader:Cp.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(c)),Np.copy(n.backgroundRotation),Np.x*=-1,Np.y*=-1,Np.z*=-1,i.isCubeTexture&&!1===i.isRenderTargetTexture&&(Np.y*=-1,Np.z*=-1),c.material.uniforms.envMap.value=i,c.material.uniforms.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=n.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,c.material.uniforms.backgroundRotation.value.setFromMatrix4(Rp.makeRotationFromEuler(Np)),c.material.toneMapped=ph.getTransfer(i.colorSpace)!==Nc,u===i&&d===i.version&&p===e.toneMapping||(c.material.needsUpdate=!0,u=i,d=i.version,p=e.toneMapping),c.layers.enableAll(),t.unshift(c,c.geometry,c.material,0,0,null)):i&&i.isTexture&&(void 0===l&&(l=new Td(new rp(2,2),new Id({name:"BackgroundMaterial",uniforms:Ad(Cp.background.uniforms),vertexShader:Cp.background.vertexShader,fragmentShader:Cp.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(l)),l.material.uniforms.t2D.value=i,l.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,l.material.toneMapped=ph.getTransfer(i.colorSpace)!==Nc,!0===i.matrixAutoUpdate&&i.updateMatrix(),l.material.uniforms.uvTransform.value.copy(i.matrix),u===i&&d===i.version&&p===e.toneMapping||(l.material.needsUpdate=!0,u=i,d=i.version,p=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==c&&(c.geometry.dispose(),c.material.dispose(),c=void 0),void 0!==l&&(l.geometry.dispose(),l.material.dispose(),l=void 0)}}}function Ip(e,t){const n=e.getParameter(e.MAX_VERTEX_ATTRIBS),i={},s=c(null);let r=s,a=!1;function o(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function c(e){const t=[],i=[],s=[];for(let r=0;r<n;r++)t[r]=0,i[r]=0,s[r]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:s,object:e,attributes:{},index:null}}function h(){const e=r.newAttributes;for(let t=0,n=e.length;t<n;t++)e[t]=0}function u(e){d(e,0)}function d(t,n){const i=r.newAttributes,s=r.enabledAttributes,a=r.attributeDivisors;i[t]=1,0===s[t]&&(e.enableVertexAttribArray(t),s[t]=1),a[t]!==n&&(e.vertexAttribDivisor(t,n),a[t]=n)}function p(){const t=r.newAttributes,n=r.enabledAttributes;for(let i=0,s=n.length;i<s;i++)n[i]!==t[i]&&(e.disableVertexAttribArray(i),n[i]=0)}function m(t,n,i,s,r,a,o){!0===o?e.vertexAttribIPointer(t,n,i,r,a):e.vertexAttribPointer(t,n,i,s,r,a)}function f(){g(),a=!0,r!==s&&(r=s,o(r.object))}function g(){s.geometry=null,s.program=null,s.wireframe=!1}return{setup:function(n,s,l,f,g){let v=!1;const x=function(t,n,s){const r=!0===s.wireframe;let a=i[t.id];void 0===a&&(a={},i[t.id]=a);let o=a[n.id];void 0===o&&(o={},a[n.id]=o);let l=o[r];return void 0===l&&(l=c(e.createVertexArray()),o[r]=l),l}(f,l,s);r!==x&&(r=x,o(r.object)),v=function(e,t,n,i){const s=r.attributes,a=t.attributes;let o=0;const l=n.getAttributes();for(const r in l)if(l[r].location>=0){const t=s[r];let n=a[r];if(void 0===n&&("instanceMatrix"===r&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===r&&e.instanceColor&&(n=e.instanceColor)),void 0===t)return!0;if(t.attribute!==n)return!0;if(n&&t.data!==n.data)return!0;o++}return r.attributesNum!==o||r.index!==i}(n,f,l,g),v&&function(e,t,n,i){const s={},a=t.attributes;let o=0;const l=n.getAttributes();for(const r in l)if(l[r].location>=0){let t=a[r];void 0===t&&("instanceMatrix"===r&&e.instanceMatrix&&(t=e.instanceMatrix),"instanceColor"===r&&e.instanceColor&&(t=e.instanceColor));const n={};n.attribute=t,t&&t.data&&(n.data=t.data),s[r]=n,o++}r.attributes=s,r.attributesNum=o,r.index=i}(n,f,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(v||a)&&(a=!1,function(n,i,s,r){h();const a=r.attributes,o=s.getAttributes(),l=i.defaultAttributeValues;for(const c in o){const i=o[c];if(i.location>=0){let s=a[c];if(void 0===s&&("instanceMatrix"===c&&n.instanceMatrix&&(s=n.instanceMatrix),"instanceColor"===c&&n.instanceColor&&(s=n.instanceColor)),void 0!==s){const a=s.normalized,o=s.itemSize,l=t.get(s);if(void 0===l)continue;const c=l.buffer,h=l.type,p=l.bytesPerElement,f=h===e.INT||h===e.UNSIGNED_INT||s.gpuType===kl;if(s.isInterleavedBufferAttribute){const t=s.data,l=t.stride,g=s.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<i.locationSize;e++)d(i.location+e,t.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===r._maxInstanceCount&&(r._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<i.locationSize;e++)u(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<i.locationSize;e++)m(i.location+e,o/i.locationSize,h,a,l*p,(g+o/i.locationSize*e)*p,f)}else{if(s.isInstancedBufferAttribute){for(let e=0;e<i.locationSize;e++)d(i.location+e,s.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===r._maxInstanceCount&&(r._maxInstanceCount=s.meshPerAttribute*s.count)}else for(let e=0;e<i.locationSize;e++)u(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<i.locationSize;e++)m(i.location+e,o/i.locationSize,h,a,o*p,o/i.locationSize*e*p,f)}}else if(void 0!==l){const t=l[c];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(i.location,t);break;case 3:e.vertexAttrib3fv(i.location,t);break;case 4:e.vertexAttrib4fv(i.location,t);break;default:e.vertexAttrib1fv(i.location,t)}}}}p()}(n,s,l,f),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:f,resetDefaultState:g,dispose:function(){f();for(const e in i){const t=i[e];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete i[e]}},releaseStatesOfGeometry:function(e){if(void 0===i[e.id])return;const t=i[e.id];for(const n in t){const e=t[n];for(const t in e)l(e[t].object),delete e[t];delete t[n]}delete i[e.id]},releaseStatesOfProgram:function(e){for(const t in i){const n=i[t];if(void 0===n[e.id])continue;const s=n[e.id];for(const e in s)l(s[e].object),delete s[e];delete n[e.id]}},initAttributes:h,enableAttribute:u,disableUnusedAttributes:p}}function jp(e,t,n){let i;function s(t,s,r){0!==r&&(e.drawArraysInstanced(i,t,s,r),n.update(s,i,r))}this.setMode=function(e){i=e},this.render=function(t,s){e.drawArrays(i,t,s),n.update(s,i,1)},this.renderInstances=s,this.renderMultiDraw=function(e,s,r){if(0===r)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(i,e,0,s,0,r);let a=0;for(let t=0;t<r;t++)a+=s[t];n.update(a,i,1)},this.renderMultiDrawInstances=function(e,r,a,o){if(0===a)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)s(e[t],r[t],o[t]);else{l.multiDrawArraysInstancedWEBGL(i,e,0,r,0,o,0,a);let t=0;for(let e=0;e<a;e++)t+=r[e]*o[e];n.update(t,i,1)}}}function Dp(e,t,n,i){let s;function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let a=void 0!==n.precision?n.precision:"highp";const o=r(a);o!==a&&(a=o);const l=!0===n.logarithmicDepthBuffer,c=!0===n.reverseDepthBuffer&&t.has("EXT_clip_control"),h=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==s)return s;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");s=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else s=0;return s},getMaxPrecision:r,textureFormatReadable:function(t){return t===Vl||i.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(n){const s=n===Ul&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(n!==jl&&i.convert(n)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&n!==Ol&&!s)},precision:a,logarithmicDepthBuffer:l,reverseDepthBuffer:c,maxTextures:h,maxVertexTextures:u,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),vertexTextures:u>0,maxSamples:e.getParameter(e.MAX_SAMPLES)}}function kp(e){const t=this;let n=null,i=0,s=!1,r=!1;const a=new $d,o=new ih,l={value:null,needsUpdate:!1};function c(e,n,i,s){const r=null!==e?e.length:0;let c=null;if(0!==r){if(c=l.value,!0!==s||null===c){const t=i+4*r,s=n.matrixWorldInverse;o.getNormalMatrix(s),(null===c||c.length<t)&&(c=new Float32Array(t));for(let n=0,l=i;n!==r;++n,l+=4)a.copy(e[n]).applyMatrix4(s,o),a.normal.toArray(c,l),c[l+3]=a.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=r,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const n=0!==e.length||t||0!==i||s;return s=t,i=e.length,n},this.beginShadows=function(){r=!0,c(null)},this.endShadows=function(){r=!1},this.setGlobalState=function(e,t){n=c(e,t,0)},this.setState=function(a,o,h){const u=a.clippingPlanes,d=a.clipIntersection,p=a.clipShadows,m=e.get(a);if(!s||null===u||0===u.length||r&&!p)r?c(null):(l.value!==n&&(l.value=n,l.needsUpdate=i>0),t.numPlanes=i,t.numIntersection=0);else{const e=r?0:i,t=4*e;let s=m.clippingState||null;l.value=s,s=c(u,o,t,h);for(let i=0;i!==t;++i)s[i]=n[i];m.clippingState=s,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function Lp(e){let t=new WeakMap;function n(e,t){return 303===t?e.mapping=bl:304===t&&(e.mapping=wl),e}function i(e){const n=e.target;n.removeEventListener("dispose",i);const s=t.get(n);void 0!==s&&(t.delete(n),s.dispose())}return{get:function(s){if(s&&s.isTexture){const r=s.mapping;if(303===r||304===r){if(t.has(s))return n(t.get(s).texture,s.mapping);{const r=s.image;if(r&&r.height>0){const a=new zd(r.height);return a.fromEquirectangularTexture(e,s),t.set(s,a),s.addEventListener("dispose",i),n(a.texture,s.mapping)}return null}}}return s},dispose:function(){t=new WeakMap}}}const Op=[.125,.215,.35,.446,.526,.582],Up=new fp,Fp=new Yu;let Bp=null,zp=0,Vp=0,Hp=!1;const Wp=(1+Math.sqrt(5))/2,Gp=1/Wp,qp=[new eh(-Wp,Gp,0),new eh(Wp,Gp,0),new eh(-Gp,0,Wp),new eh(Gp,0,Wp),new eh(0,Wp,-Gp),new eh(0,Wp,Gp),new eh(-1,1,-1),new eh(1,1,-1),new eh(-1,1,1),new eh(1,1,1)],Xp=new eh;class Yp{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,i=100,s={}){const{size:r=256,position:a=Xp}=s;Bp=this._renderer.getRenderTarget(),zp=this._renderer.getActiveCubeFace(),Vp=this._renderer.getActiveMipmapLevel(),Hp=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(r);const o=this._allocateTargets();return o.depthBuffer=!0,this._sceneToCubeUV(e,n,i,o,a),t>0&&this._blur(o,0,0,t),this._applyPMREM(o),this._cleanup(o),o}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Jp(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Kp(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(Bp,zp,Vp),this._renderer.xr.enabled=Hp,e.scissorTest=!1,Zp(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===bl||e.mapping===wl?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),Bp=this._renderer.getRenderTarget(),zp=this._renderer.getActiveCubeFace(),Vp=this._renderer.getActiveMipmapLevel(),Hp=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:Rl,minFilter:Rl,generateMipmaps:!1,type:Ul,format:Vl,colorSpace:Cc,depthBuffer:!1},i=$p(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=$p(e,t,n);const{_lodMax:i}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],n=[],i=[];let s=e;const r=e-4+1+Op.length;for(let a=0;a<r;a++){const r=Math.pow(2,s);n.push(r);let o=1/r;a>e-4?o=Op[a-e+4-1]:0===a&&(o=0),i.push(o);const l=1/(r-2),c=-l,h=1+l,u=[c,c,h,c,h,h,c,c,h,h,c,h],d=6,p=6,m=3,f=2,g=1,v=new Float32Array(m*p*d),x=new Float32Array(f*p*d),y=new Float32Array(g*p*d);for(let e=0;e<d;e++){const t=e%3*2/3-1,n=e>2?0:-1,i=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0];v.set(i,m*p*e),x.set(u,f*p*e);const s=[e,e,e,e,e,e];y.set(s,g*p*e)}const _=new pd;_.setAttribute("position",new nd(v,m)),_.setAttribute("uv",new nd(x,f)),_.setAttribute("faceIndex",new nd(y,g)),t.push(_),s>4&&s--}return{lodPlanes:t,sizeLods:n,sigmas:i}}(i)),this._blurMaterial=function(e,t,n){const i=new Float32Array(20),s=new eh(0,1,0);return new Id({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:i},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}(i,e,t)}return i}_compileMaterial(e){const t=new Td(this._lodPlanes[0],e);this._renderer.compile(t,Up)}_sceneToCubeUV(e,t,n,i,s){const r=new Od(90,1,t,n),a=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],l=this._renderer,c=l.autoClear,h=l.toneMapping;l.getClearColor(Fp),l.toneMapping=0,l.autoClear=!1;const u=new Ju({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),d=new Td(new Cd,u);let p=!1;const m=e.background;m?m.isColor&&(u.color.copy(m),e.background=null,p=!0):(u.color.copy(Fp),p=!0);for(let f=0;f<6;f++){const t=f%3;0===t?(r.up.set(0,a[f],0),r.position.set(s.x,s.y,s.z),r.lookAt(s.x+o[f],s.y,s.z)):1===t?(r.up.set(0,0,a[f]),r.position.set(s.x,s.y,s.z),r.lookAt(s.x,s.y+o[f],s.z)):(r.up.set(0,a[f],0),r.position.set(s.x,s.y,s.z),r.lookAt(s.x,s.y,s.z+o[f]));const n=this._cubeSize;Zp(i,t*n,f>2?n:0,n,n),l.setRenderTarget(i),p&&l.render(d,r),l.render(e,r)}d.geometry.dispose(),d.material.dispose(),l.toneMapping=h,l.autoClear=c,e.background=m}_textureToCubeUV(e,t){const n=this._renderer,i=e.mapping===bl||e.mapping===wl;i?(null===this._cubemapMaterial&&(this._cubemapMaterial=Jp()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=Kp());const s=i?this._cubemapMaterial:this._equirectMaterial,r=new Td(this._lodPlanes[0],s);s.uniforms.envMap.value=e;const a=this._cubeSize;Zp(t,0,0,3*a,2*a),n.setRenderTarget(t),n.render(r,Up)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const i=this._lodPlanes.length;for(let s=1;s<i;s++){const t=Math.sqrt(this._sigmas[s]*this._sigmas[s]-this._sigmas[s-1]*this._sigmas[s-1]),n=qp[(i-s-1)%qp.length];this._blur(e,s-1,s,t,n)}t.autoClear=n}_blur(e,t,n,i,s){const r=this._pingPongRenderTarget;this._halfBlur(e,r,t,n,i,"latitudinal",s),this._halfBlur(r,e,n,n,i,"longitudinal",s)}_halfBlur(e,t,n,i,s,r,a){const o=this._renderer,l=this._blurMaterial,c=new Td(this._lodPlanes[i],l),h=l.uniforms,u=this._sizeLods[n]-1,d=isFinite(s)?Math.PI/(2*u):2*Math.PI/39,p=s/d,m=isFinite(s)?1+Math.floor(3*p):20,f=[];let g=0;for(let y=0;y<20;++y){const e=y/p,t=Math.exp(-e*e/2);f.push(t),0===y?g+=t:y<m&&(g+=2*t)}for(let y=0;y<f.length;y++)f[y]=f[y]/g;h.envMap.value=e.texture,h.samples.value=m,h.weights.value=f,h.latitudinal.value="latitudinal"===r,a&&(h.poleAxis.value=a);const{_lodMax:v}=this;h.dTheta.value=d,h.mipInt.value=v-n;const x=this._sizeLods[i];Zp(t,3*x*(i>v-4?i-v+4:0),4*(this._cubeSize-x),3*x,2*x),o.setRenderTarget(t),o.render(c,Up)}}function $p(e,t,n){const i=new Eh(e,t,n);return i.texture.mapping=Sl,i.texture.name="PMREM.cubeUv",i.scissorTest=!0,i}function Zp(e,t,n,i,s){e.viewport.set(t,n,i,s),e.scissor.set(t,n,i,s)}function Kp(){return new Id({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Jp(){return new Id({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Qp(e){let t=new WeakMap,n=null;function i(e){const n=e.target;n.removeEventListener("dispose",i);const s=t.get(n);void 0!==s&&(t.delete(n),s.dispose())}return{get:function(s){if(s&&s.isTexture){const r=s.mapping,a=303===r||304===r,o=r===bl||r===wl;if(a||o){let r=t.get(s);const l=void 0!==r?r.texture.pmremVersion:0;if(s.isRenderTargetTexture&&s.pmremVersion!==l)return null===n&&(n=new Yp(e)),r=a?n.fromEquirectangular(s,r):n.fromCubemap(s,r),r.texture.pmremVersion=s.pmremVersion,t.set(s,r),r.texture;if(void 0!==r)return r.texture;{const l=s.image;return a&&l&&l.height>0||o&&l&&function(e){let t=0;for(let n=0;n<6;n++)void 0!==e[n]&&t++;return 6===t}(l)?(null===n&&(n=new Yp(e)),r=a?n.fromEquirectangular(s):n.fromCubemap(s),r.texture.pmremVersion=s.pmremVersion,t.set(s,r),s.addEventListener("dispose",i),r.texture):null}}}return s},dispose:function(){t=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function em(e){const t={};function n(n){if(void 0!==t[n])return t[n];let i;switch(n){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(n)}return t[n]=i,i}return{has:function(e){return null!==n(e)},init:function(){n("EXT_color_buffer_float"),n("WEBGL_clip_cull_distance"),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture"),n("WEBGL_render_shared_exponent")},get:function(e){const t=n(e);return null===t&&ch("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function tm(e,t,n,i){const s={},r=new WeakMap;function a(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const n in o.attributes)t.remove(o.attributes[n]);o.removeEventListener("dispose",a),delete s[o.id];const l=r.get(o);l&&(t.remove(l),r.delete(o)),i.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,n.memory.geometries--}function o(e){const n=[],i=e.index,s=e.attributes.position;let a=0;if(null!==i){const e=i.array;a=i.version;for(let t=0,i=e.length;t<i;t+=3){const i=e[t+0],s=e[t+1],r=e[t+2];n.push(i,s,s,r,r,i)}}else{if(void 0===s)return;{const e=s.array;a=s.version;for(let t=0,i=e.length/3-1;t<i;t+=3){const e=t+0,i=t+1,s=t+2;n.push(e,i,i,s,s,e)}}}const o=new(rh(n)?sd:id)(n,1);o.version=a;const l=r.get(e);l&&t.remove(l),r.set(e,o)}return{get:function(e,t){return!0===s[t.id]||(t.addEventListener("dispose",a),s[t.id]=!0,n.memory.geometries++),t},update:function(n){const i=n.attributes;for(const s in i)t.update(i[s],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){const t=r.get(e);if(t){const n=e.index;null!==n&&t.version<n.version&&o(e)}else o(e);return r.get(e)}}}function nm(e,t,n){let i,s,r;function a(t,a,o){0!==o&&(e.drawElementsInstanced(i,a,s,t*r,o),n.update(a,i,o))}this.setMode=function(e){i=e},this.setIndex=function(e){s=e.type,r=e.bytesPerElement},this.render=function(t,a){e.drawElements(i,a,s,t*r),n.update(a,i,1)},this.renderInstances=a,this.renderMultiDraw=function(e,r,a){if(0===a)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(i,r,0,s,e,0,a);let o=0;for(let t=0;t<a;t++)o+=r[t];n.update(o,i,1)},this.renderMultiDrawInstances=function(e,o,l,c){if(0===l)return;const h=t.get("WEBGL_multi_draw");if(null===h)for(let t=0;t<e.length;t++)a(e[t]/r,o[t],c[t]);else{h.multiDrawElementsInstancedWEBGL(i,o,0,s,e,0,c,0,l);let t=0;for(let e=0;e<l;e++)t+=o[e]*c[e];n.update(t,i,1)}}}function im(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(n,i,s){switch(t.calls++,i){case e.TRIANGLES:t.triangles+=s*(n/3);break;case e.LINES:t.lines+=s*(n/2);break;case e.LINE_STRIP:t.lines+=s*(n-1);break;case e.LINE_LOOP:t.lines+=s*n;break;case e.POINTS:t.points+=s*n}}}}function sm(e,t,n){const i=new WeakMap,s=new Mh;return{update:function(r,a,o){const l=r.morphTargetInfluences,c=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color,h=void 0!==c?c.length:0;let u=i.get(a);if(void 0===u||u.count!==h){let e=function(){v.dispose(),i.delete(a),a.removeEventListener("dispose",e)};void 0!==u&&u.texture.dispose();const n=void 0!==a.morphAttributes.position,r=void 0!==a.morphAttributes.normal,o=void 0!==a.morphAttributes.color,l=a.morphAttributes.position||[],c=a.morphAttributes.normal||[],d=a.morphAttributes.color||[];let p=0;!0===n&&(p=1),!0===r&&(p=2),!0===o&&(p=3);let m=a.attributes.position.count*p,f=1;m>t.maxTextureSize&&(f=Math.ceil(m/t.maxTextureSize),m=t.maxTextureSize);const g=new Float32Array(m*f*4*h),v=new Ch(g,m,f,h);v.type=Ol,v.needsUpdate=!0;const x=4*p;for(let t=0;t<h;t++){const e=l[t],i=c[t],a=d[t],h=m*f*4*t;for(let t=0;t<e.count;t++){const l=t*x;!0===n&&(s.fromBufferAttribute(e,t),g[h+l+0]=s.x,g[h+l+1]=s.y,g[h+l+2]=s.z,g[h+l+3]=0),!0===r&&(s.fromBufferAttribute(i,t),g[h+l+4]=s.x,g[h+l+5]=s.y,g[h+l+6]=s.z,g[h+l+7]=0),!0===o&&(s.fromBufferAttribute(a,t),g[h+l+8]=s.x,g[h+l+9]=s.y,g[h+l+10]=s.z,g[h+l+11]=4===a.itemSize?s.w:1)}}u={count:h,texture:v,size:new Jc(m,f)},i.set(a,u),a.addEventListener("dispose",e)}if(!0===r.isInstancedMesh&&null!==r.morphTexture)o.getUniforms().setValue(e,"morphTexture",r.morphTexture,n);else{let t=0;for(let e=0;e<l.length;e++)t+=l[e];const n=a.morphTargetsRelative?1:1-t;o.getUniforms().setValue(e,"morphTargetBaseInfluence",n),o.getUniforms().setValue(e,"morphTargetInfluences",l)}o.getUniforms().setValue(e,"morphTargetsTexture",u.texture,n),o.getUniforms().setValue(e,"morphTargetsTextureSize",u.size)}}}function rm(e,t,n,i){let s=new WeakMap;function r(e){const t=e.target;t.removeEventListener("dispose",r),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(a){const o=i.render.frame,l=a.geometry,c=t.get(a,l);if(s.get(c)!==o&&(t.update(c),s.set(c,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",r)&&a.addEventListener("dispose",r),s.get(a)!==o&&(n.update(a.instanceMatrix,e.ARRAY_BUFFER),null!==a.instanceColor&&n.update(a.instanceColor,e.ARRAY_BUFFER),s.set(a,o))),a.isSkinnedMesh){const e=a.skeleton;s.get(e)!==o&&(e.update(),s.set(e,o))}return c},dispose:function(){s=new WeakMap}}}const am=new Sh,om=new ep(1,1),lm=new Ch,cm=new Ah,hm=new Bd,um=[],dm=[],pm=new Float32Array(16),mm=new Float32Array(9),fm=new Float32Array(4);function gm(e,t,n){const i=e[0];if(i<=0||i>0)return e;const s=t*n;let r=um[s];if(void 0===r&&(r=new Float32Array(s),um[s]=r),0!==t){i.toArray(r,0);for(let i=1,s=0;i!==t;++i)s+=n,e[i].toArray(r,s)}return r}function vm(e,t){if(e.length!==t.length)return!1;for(let n=0,i=e.length;n<i;n++)if(e[n]!==t[n])return!1;return!0}function xm(e,t){for(let n=0,i=t.length;n<i;n++)e[n]=t[n]}function ym(e,t){let n=dm[t];void 0===n&&(n=new Int32Array(t),dm[t]=n);for(let i=0;i!==t;++i)n[i]=e.allocateTextureUnit();return n}function _m(e,t){const n=this.cache;n[0]!==t&&(e.uniform1f(this.addr,t),n[0]=t)}function bm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(vm(n,t))return;e.uniform2fv(this.addr,t),xm(n,t)}}function wm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else if(void 0!==t.r)n[0]===t.r&&n[1]===t.g&&n[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),n[0]=t.r,n[1]=t.g,n[2]=t.b);else{if(vm(n,t))return;e.uniform3fv(this.addr,t),xm(n,t)}}function Sm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(vm(n,t))return;e.uniform4fv(this.addr,t),xm(n,t)}}function Mm(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(vm(n,t))return;e.uniformMatrix2fv(this.addr,!1,t),xm(n,t)}else{if(vm(n,i))return;fm.set(i),e.uniformMatrix2fv(this.addr,!1,fm),xm(n,i)}}function Tm(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(vm(n,t))return;e.uniformMatrix3fv(this.addr,!1,t),xm(n,t)}else{if(vm(n,i))return;mm.set(i),e.uniformMatrix3fv(this.addr,!1,mm),xm(n,i)}}function Em(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(vm(n,t))return;e.uniformMatrix4fv(this.addr,!1,t),xm(n,t)}else{if(vm(n,i))return;pm.set(i),e.uniformMatrix4fv(this.addr,!1,pm),xm(n,i)}}function Cm(e,t){const n=this.cache;n[0]!==t&&(e.uniform1i(this.addr,t),n[0]=t)}function Am(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(vm(n,t))return;e.uniform2iv(this.addr,t),xm(n,t)}}function Nm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(vm(n,t))return;e.uniform3iv(this.addr,t),xm(n,t)}}function Rm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(vm(n,t))return;e.uniform4iv(this.addr,t),xm(n,t)}}function Pm(e,t){const n=this.cache;n[0]!==t&&(e.uniform1ui(this.addr,t),n[0]=t)}function Im(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(vm(n,t))return;e.uniform2uiv(this.addr,t),xm(n,t)}}function jm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(vm(n,t))return;e.uniform3uiv(this.addr,t),xm(n,t)}}function Dm(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(vm(n,t))return;e.uniform4uiv(this.addr,t),xm(n,t)}}function km(e,t,n){const i=this.cache,s=n.allocateTextureUnit();let r;i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),this.type===e.SAMPLER_2D_SHADOW?(om.compareFunction=515,r=om):r=am,n.setTexture2D(t||r,s)}function Lm(e,t,n){const i=this.cache,s=n.allocateTextureUnit();i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),n.setTexture3D(t||cm,s)}function Om(e,t,n){const i=this.cache,s=n.allocateTextureUnit();i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),n.setTextureCube(t||hm,s)}function Um(e,t,n){const i=this.cache,s=n.allocateTextureUnit();i[0]!==s&&(e.uniform1i(this.addr,s),i[0]=s),n.setTexture2DArray(t||lm,s)}function Fm(e,t){e.uniform1fv(this.addr,t)}function Bm(e,t){const n=gm(t,this.size,2);e.uniform2fv(this.addr,n)}function zm(e,t){const n=gm(t,this.size,3);e.uniform3fv(this.addr,n)}function Vm(e,t){const n=gm(t,this.size,4);e.uniform4fv(this.addr,n)}function Hm(e,t){const n=gm(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,n)}function Wm(e,t){const n=gm(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,n)}function Gm(e,t){const n=gm(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,n)}function qm(e,t){e.uniform1iv(this.addr,t)}function Xm(e,t){e.uniform2iv(this.addr,t)}function Ym(e,t){e.uniform3iv(this.addr,t)}function $m(e,t){e.uniform4iv(this.addr,t)}function Zm(e,t){e.uniform1uiv(this.addr,t)}function Km(e,t){e.uniform2uiv(this.addr,t)}function Jm(e,t){e.uniform3uiv(this.addr,t)}function Qm(e,t){e.uniform4uiv(this.addr,t)}function ef(e,t,n){const i=this.cache,s=t.length,r=ym(n,s);vm(i,r)||(e.uniform1iv(this.addr,r),xm(i,r));for(let a=0;a!==s;++a)n.setTexture2D(t[a]||am,r[a])}function tf(e,t,n){const i=this.cache,s=t.length,r=ym(n,s);vm(i,r)||(e.uniform1iv(this.addr,r),xm(i,r));for(let a=0;a!==s;++a)n.setTexture3D(t[a]||cm,r[a])}function nf(e,t,n){const i=this.cache,s=t.length,r=ym(n,s);vm(i,r)||(e.uniform1iv(this.addr,r),xm(i,r));for(let a=0;a!==s;++a)n.setTextureCube(t[a]||hm,r[a])}function sf(e,t,n){const i=this.cache,s=t.length,r=ym(n,s);vm(i,r)||(e.uniform1iv(this.addr,r),xm(i,r));for(let a=0;a!==s;++a)n.setTexture2DArray(t[a]||lm,r[a])}class rf{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return _m;case 35664:return bm;case 35665:return wm;case 35666:return Sm;case 35674:return Mm;case 35675:return Tm;case 35676:return Em;case 5124:case 35670:return Cm;case 35667:case 35671:return Am;case 35668:case 35672:return Nm;case 35669:case 35673:return Rm;case 5125:return Pm;case 36294:return Im;case 36295:return jm;case 36296:return Dm;case 35678:case 36198:case 36298:case 36306:case 35682:return km;case 35679:case 36299:case 36307:return Lm;case 35680:case 36300:case 36308:case 36293:return Om;case 36289:case 36303:case 36311:case 36292:return Um}}(t.type)}}class af{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return Fm;case 35664:return Bm;case 35665:return zm;case 35666:return Vm;case 35674:return Hm;case 35675:return Wm;case 35676:return Gm;case 5124:case 35670:return qm;case 35667:case 35671:return Xm;case 35668:case 35672:return Ym;case 35669:case 35673:return $m;case 5125:return Zm;case 36294:return Km;case 36295:return Jm;case 36296:return Qm;case 35678:case 36198:case 36298:case 36306:case 35682:return ef;case 35679:case 36299:case 36307:return tf;case 35680:case 36300:case 36308:case 36293:return nf;case 36289:case 36303:case 36311:case 36292:return sf}}(t.type)}}class of{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,n){const i=this.seq;for(let s=0,r=i.length;s!==r;++s){const r=i[s];r.setValue(e,t[r.id],n)}}}const lf=/(\w+)(\])?(\[|\.)?/g;function cf(e,t){e.seq.push(t),e.map[t.id]=t}function hf(e,t,n){const i=e.name,s=i.length;for(lf.lastIndex=0;;){const r=lf.exec(i),a=lf.lastIndex;let o=r[1];const l="]"===r[2],c=r[3];if(l&&(o|=0),void 0===c||"["===c&&a+2===s){cf(n,void 0===c?new rf(o,e,t):new af(o,e,t));break}{let e=n.map[o];void 0===e&&(e=new of(o),cf(n,e)),n=e}}}class uf{constructor(e,t){this.seq=[],this.map={};const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){const n=e.getActiveUniform(t,i);hf(n,e.getUniformLocation(t,n.name),this)}}setValue(e,t,n,i){const s=this.map[t];void 0!==s&&s.setValue(e,n,i)}setOptional(e,t,n){const i=t[n];void 0!==i&&this.setValue(e,n,i)}static upload(e,t,n,i){for(let s=0,r=t.length;s!==r;++s){const r=t[s],a=n[r.id];!1!==a.needsUpdate&&r.setValue(e,a.value,i)}}static seqWithValue(e,t){const n=[];for(let i=0,s=e.length;i!==s;++i){const s=e[i];s.id in t&&n.push(s)}return n}}function df(e,t,n){const i=e.createShader(t);return e.shaderSource(i,n),e.compileShader(i),i}let pf=0;const mf=new ih;function ff(e,t,n){const i=e.getShaderParameter(t,e.COMPILE_STATUS),s=e.getShaderInfoLog(t).trim();if(i&&""===s)return"";const r=/ERROR: 0:(\d+)/.exec(s);if(r){const i=parseInt(r[1]);return n.toUpperCase()+"\n\n"+s+"\n\n"+function(e,t){const n=e.split("\n"),i=[],s=Math.max(t-6,0),r=Math.min(t+6,n.length);for(let a=s;a<r;a++){const e=a+1;i.push(`${e===t?">":" "} ${e}: ${n[a]}`)}return i.join("\n")}(e.getShaderSource(t),i)}return s}function gf(e,t){const n=function(e){ph._getMatrix(mf,ph.workingColorSpace,e);const t=`mat3( ${mf.elements.map(e=>e.toFixed(4))} )`;switch(ph.getTransfer(e)){case Ac:return[t,"LinearTransferOETF"];case Nc:return[t,"sRGBTransferOETF"];default:return[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${n[1]}( vec4( value.rgb * ${n[0]}, value.a ) );`,"}"].join("\n")}function vf(e,t){let n;switch(t){case 1:default:n="Linear";break;case 2:n="Reinhard";break;case 3:n="Cineon";break;case 4:n="ACESFilmic";break;case 6:n="AgX";break;case 7:n="Neutral";break;case 5:n="Custom"}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}const xf=new eh;function yf(e){return""!==e}function _f(e,t){const n=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,n).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function bf(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const wf=/^[ \t]*#include +<([\w\d./]+)>/gm;function Sf(e){return e.replace(wf,Tf)}const Mf=new Map;function Tf(e,t){let n=Tp[t];if(void 0===n){const e=Mf.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");n=Tp[e]}return Sf(n)}const Ef=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Cf(e){return e.replace(Ef,Af)}function Af(e,t,n,i){let s="";for(let r=parseInt(t);r<parseInt(n);r++)s+=i.replace(/\[\s*i\s*\]/g,"[ "+r+" ]").replace(/UNROLLED_LOOP_INDEX/g,r);return s}function Nf(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Rf(e,t,n,i){const s=e.getContext(),r=n.defines;let a=n.vertexShader,o=n.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(n),c=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case bl:case wl:t="ENVMAP_TYPE_CUBE";break;case Sl:t="ENVMAP_TYPE_CUBE_UV"}return t}(n),h=function(e){let t="ENVMAP_MODE_REFLECTION";return e.envMap&&e.envMapMode===wl&&(t="ENVMAP_MODE_REFRACTION"),t}(n),u=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(n),d=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const n=Math.log2(t)-2,i=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:i,maxMip:n}}(n),p=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(yf).join("\n")}(n),m=function(e){const t=[];for(const n in e){const i=e[n];!1!==i&&t.push("#define "+n+" "+i)}return t.join("\n")}(r),f=s.createProgram();let g,v,x=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(g=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m].filter(yf).join("\n"),g.length>0&&(g+="\n"),v=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m].filter(yf).join("\n"),v.length>0&&(v+="\n")):(g=[Nf(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m,n.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",n.batching?"#define USE_BATCHING":"",n.batchingColor?"#define USE_BATCHING_COLOR":"",n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.instancingMorph?"#define USE_INSTANCING_MORPH":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+h:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.displacementMap?"#define USE_DISPLACEMENTMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.mapUv?"#define MAP_UV "+n.mapUv:"",n.alphaMapUv?"#define ALPHAMAP_UV "+n.alphaMapUv:"",n.lightMapUv?"#define LIGHTMAP_UV "+n.lightMapUv:"",n.aoMapUv?"#define AOMAP_UV "+n.aoMapUv:"",n.emissiveMapUv?"#define EMISSIVEMAP_UV "+n.emissiveMapUv:"",n.bumpMapUv?"#define BUMPMAP_UV "+n.bumpMapUv:"",n.normalMapUv?"#define NORMALMAP_UV "+n.normalMapUv:"",n.displacementMapUv?"#define DISPLACEMENTMAP_UV "+n.displacementMapUv:"",n.metalnessMapUv?"#define METALNESSMAP_UV "+n.metalnessMapUv:"",n.roughnessMapUv?"#define ROUGHNESSMAP_UV "+n.roughnessMapUv:"",n.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+n.anisotropyMapUv:"",n.clearcoatMapUv?"#define CLEARCOATMAP_UV "+n.clearcoatMapUv:"",n.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+n.clearcoatNormalMapUv:"",n.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+n.clearcoatRoughnessMapUv:"",n.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+n.iridescenceMapUv:"",n.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+n.iridescenceThicknessMapUv:"",n.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+n.sheenColorMapUv:"",n.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+n.sheenRoughnessMapUv:"",n.specularMapUv?"#define SPECULARMAP_UV "+n.specularMapUv:"",n.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+n.specularColorMapUv:"",n.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+n.specularIntensityMapUv:"",n.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+n.transmissionMapUv:"",n.thicknessMapUv?"#define THICKNESSMAP_UV "+n.thicknessMapUv:"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(yf).join("\n"),v=[Nf(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,m,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+c:"",n.envMap?"#define "+h:"",n.envMap?"#define "+u:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.dispersion?"#define USE_DISPERSION":"",n.iridescence?"#define USE_IRIDESCENCE":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor||n.batchingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==n.toneMapping?"#define TONE_MAPPING":"",0!==n.toneMapping?Tp.tonemapping_pars_fragment:"",0!==n.toneMapping?vf("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",Tp.colorspace_pars_fragment,gf("linearToOutputTexel",n.outputColorSpace),(ph.getLuminanceCoefficients(xf),["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${xf.x.toFixed(4)}, ${xf.y.toFixed(4)}, ${xf.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(yf).join("\n")),a=Sf(a),a=_f(a,n),a=bf(a,n),o=Sf(o),o=_f(o,n),o=bf(o,n),a=Cf(a),o=Cf(o),!0!==n.isRawShaderMaterial&&(x="#version 300 es\n",g=[p,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["#define varying in",n.glslVersion===Fc?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===Fc?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);const y=x+g+a,_=x+v+o,b=df(s,s.VERTEX_SHADER,y),w=df(s,s.FRAGMENT_SHADER,_);function S(t){if(e.debug.checkShaderErrors){const n=s.getProgramInfoLog(f).trim(),i=s.getShaderInfoLog(b).trim(),r=s.getShaderInfoLog(w).trim();let a=!0,o=!0;!1===s.getProgramParameter(f,s.LINK_STATUS)?(a=!1,"function"==typeof e.debug.onShaderError?e.debug.onShaderError(s,f,b,w):(ff(s,b,"vertex"),ff(s,w,"fragment"))):""!==n||""!==i&&""!==r||(o=!1),o&&(t.diagnostics={runnable:a,programLog:n,vertexShader:{log:i,prefix:g},fragmentShader:{log:r,prefix:v}})}s.deleteShader(b),s.deleteShader(w),M=new uf(s,f),T=function(e,t){const n={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let s=0;s<i;s++){const i=e.getActiveAttrib(t,s),r=i.name;let a=1;i.type===e.FLOAT_MAT2&&(a=2),i.type===e.FLOAT_MAT3&&(a=3),i.type===e.FLOAT_MAT4&&(a=4),n[r]={type:i.type,location:e.getAttribLocation(t,r),locationSize:a}}return n}(s,f)}let M,T;s.attachShader(f,b),s.attachShader(f,w),void 0!==n.index0AttributeName?s.bindAttribLocation(f,0,n.index0AttributeName):!0===n.morphTargets&&s.bindAttribLocation(f,0,"position"),s.linkProgram(f),this.getUniforms=function(){return void 0===M&&S(this),M},this.getAttributes=function(){return void 0===T&&S(this),T};let E=!1===n.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===E&&(E=s.getProgramParameter(f,37297)),E},this.destroy=function(){i.releaseStatesOfProgram(this),s.deleteProgram(f),this.program=void 0},this.type=n.shaderType,this.name=n.shaderName,this.id=pf++,this.cacheKey=t,this.usedTimes=1,this.program=f,this.vertexShader=b,this.fragmentShader=w,this}let Pf=0;class If{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,n=e.fragmentShader,i=this._getShaderStage(t),s=this._getShaderStage(n),r=this._getShaderCacheForMaterial(e);return!1===r.has(i)&&(r.add(i),i.usedTimes++),!1===r.has(s)&&(r.add(s),s.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const n of t)n.usedTimes--,0===n.usedTimes&&this.shaderCache.delete(n.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let n=t.get(e);return void 0===n&&(n=new Set,t.set(e,n)),n}_getShaderStage(e){const t=this.shaderCache;let n=t.get(e);return void 0===n&&(n=new jf(e),t.set(e,n)),n}}class jf{constructor(e){this.id=Pf++,this.code=e,this.usedTimes=0}}function Df(e,t,n,i,s,r,a){const o=new pu,l=new If,c=new Set,h=[],u=s.logarithmicDepthBuffer,d=s.vertexTextures;let p=s.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function f(e){return c.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(r,o,h,g,v){const x=g.fog,y=v.geometry,_=r.isMeshStandardMaterial?g.environment:null,b=(r.isMeshStandardMaterial?n:t).get(r.envMap||_),w=b&&b.mapping===Sl?b.image.height:null,S=m[r.type];null!==r.precision&&(p=s.getMaxPrecision(r.precision),r.precision);const M=y.morphAttributes.position||y.morphAttributes.normal||y.morphAttributes.color,T=void 0!==M?M.length:0;let E,C,A,N,R=0;if(void 0!==y.morphAttributes.position&&(R=1),void 0!==y.morphAttributes.normal&&(R=2),void 0!==y.morphAttributes.color&&(R=3),S){const e=Cp[S];E=e.vertexShader,C=e.fragmentShader}else E=r.vertexShader,C=r.fragmentShader,l.update(r),A=l.getVertexShaderID(r),N=l.getFragmentShaderID(r);const P=e.getRenderTarget(),I=e.state.buffers.depth.getReversed(),j=!0===v.isInstancedMesh,D=!0===v.isBatchedMesh,k=!!r.map,L=!!r.matcap,O=!!b,U=!!r.aoMap,F=!!r.lightMap,B=!!r.bumpMap,z=!!r.normalMap,V=!!r.displacementMap,H=!!r.emissiveMap,W=!!r.metalnessMap,G=!!r.roughnessMap,q=r.anisotropy>0,X=r.clearcoat>0,Y=r.dispersion>0,$=r.iridescence>0,Z=r.sheen>0,K=r.transmission>0,J=q&&!!r.anisotropyMap,Q=X&&!!r.clearcoatMap,ee=X&&!!r.clearcoatNormalMap,te=X&&!!r.clearcoatRoughnessMap,ne=$&&!!r.iridescenceMap,ie=$&&!!r.iridescenceThicknessMap,se=Z&&!!r.sheenColorMap,re=Z&&!!r.sheenRoughnessMap,ae=!!r.specularMap,oe=!!r.specularColorMap,le=!!r.specularIntensityMap,ce=K&&!!r.transmissionMap,he=K&&!!r.thicknessMap,ue=!!r.gradientMap,de=!!r.alphaMap,pe=r.alphaTest>0,me=!!r.alphaHash,fe=!!r.extensions;let ge=0;r.toneMapped&&(null!==P&&!0!==P.isXRRenderTarget||(ge=e.toneMapping));const ve={shaderID:S,shaderType:r.type,shaderName:r.name,vertexShader:E,fragmentShader:C,defines:r.defines,customVertexShaderID:A,customFragmentShaderID:N,isRawShaderMaterial:!0===r.isRawShaderMaterial,glslVersion:r.glslVersion,precision:p,batching:D,batchingColor:D&&null!==v._colorsTexture,instancing:j,instancingColor:j&&null!==v.instanceColor,instancingMorph:j&&null!==v.morphTexture,supportsVertexTextures:d,outputColorSpace:null===P?e.outputColorSpace:!0===P.isXRRenderTarget?P.texture.colorSpace:Cc,alphaToCoverage:!!r.alphaToCoverage,map:k,matcap:L,envMap:O,envMapMode:O&&b.mapping,envMapCubeUVHeight:w,aoMap:U,lightMap:F,bumpMap:B,normalMap:z,displacementMap:d&&V,emissiveMap:H,normalMapObjectSpace:z&&1===r.normalMapType,normalMapTangentSpace:z&&0===r.normalMapType,metalnessMap:W,roughnessMap:G,anisotropy:q,anisotropyMap:J,clearcoat:X,clearcoatMap:Q,clearcoatNormalMap:ee,clearcoatRoughnessMap:te,dispersion:Y,iridescence:$,iridescenceMap:ne,iridescenceThicknessMap:ie,sheen:Z,sheenColorMap:se,sheenRoughnessMap:re,specularMap:ae,specularColorMap:oe,specularIntensityMap:le,transmission:K,transmissionMap:ce,thicknessMap:he,gradientMap:ue,opaque:!1===r.transparent&&1===r.blending&&!1===r.alphaToCoverage,alphaMap:de,alphaTest:pe,alphaHash:me,combine:r.combine,mapUv:k&&f(r.map.channel),aoMapUv:U&&f(r.aoMap.channel),lightMapUv:F&&f(r.lightMap.channel),bumpMapUv:B&&f(r.bumpMap.channel),normalMapUv:z&&f(r.normalMap.channel),displacementMapUv:V&&f(r.displacementMap.channel),emissiveMapUv:H&&f(r.emissiveMap.channel),metalnessMapUv:W&&f(r.metalnessMap.channel),roughnessMapUv:G&&f(r.roughnessMap.channel),anisotropyMapUv:J&&f(r.anisotropyMap.channel),clearcoatMapUv:Q&&f(r.clearcoatMap.channel),clearcoatNormalMapUv:ee&&f(r.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:te&&f(r.clearcoatRoughnessMap.channel),iridescenceMapUv:ne&&f(r.iridescenceMap.channel),iridescenceThicknessMapUv:ie&&f(r.iridescenceThicknessMap.channel),sheenColorMapUv:se&&f(r.sheenColorMap.channel),sheenRoughnessMapUv:re&&f(r.sheenRoughnessMap.channel),specularMapUv:ae&&f(r.specularMap.channel),specularColorMapUv:oe&&f(r.specularColorMap.channel),specularIntensityMapUv:le&&f(r.specularIntensityMap.channel),transmissionMapUv:ce&&f(r.transmissionMap.channel),thicknessMapUv:he&&f(r.thicknessMap.channel),alphaMapUv:de&&f(r.alphaMap.channel),vertexTangents:!!y.attributes.tangent&&(z||q),vertexColors:r.vertexColors,vertexAlphas:!0===r.vertexColors&&!!y.attributes.color&&4===y.attributes.color.itemSize,pointsUvs:!0===v.isPoints&&!!y.attributes.uv&&(k||de),fog:!!x,useFog:!0===r.fog,fogExp2:!!x&&x.isFogExp2,flatShading:!0===r.flatShading&&!1===r.wireframe,sizeAttenuation:!0===r.sizeAttenuation,logarithmicDepthBuffer:u,reverseDepthBuffer:I,skinning:!0===v.isSkinnedMesh,morphTargets:void 0!==y.morphAttributes.position,morphNormals:void 0!==y.morphAttributes.normal,morphColors:void 0!==y.morphAttributes.color,morphTargetsCount:T,morphTextureStride:R,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:r.dithering,shadowMapEnabled:e.shadowMap.enabled&&h.length>0,shadowMapType:e.shadowMap.type,toneMapping:ge,decodeVideoTexture:k&&!0===r.map.isVideoTexture&&ph.getTransfer(r.map.colorSpace)===Nc,decodeVideoTextureEmissive:H&&!0===r.emissiveMap.isVideoTexture&&ph.getTransfer(r.emissiveMap.colorSpace)===Nc,premultipliedAlpha:r.premultipliedAlpha,doubleSided:2===r.side,flipSided:1===r.side,useDepthPacking:r.depthPacking>=0,depthPacking:r.depthPacking||0,index0AttributeName:r.index0AttributeName,extensionClipCullDistance:fe&&!0===r.extensions.clipCullDistance&&i.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(fe&&!0===r.extensions.multiDraw||D)&&i.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:i.has("KHR_parallel_shader_compile"),customProgramCacheKey:r.customProgramCacheKey()};return ve.vertexUv1s=c.has(1),ve.vertexUv2s=c.has(2),ve.vertexUv3s=c.has(3),c.clear(),ve},getProgramCacheKey:function(t){const n=[];if(t.shaderID?n.push(t.shaderID):(n.push(t.customVertexShaderID),n.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)n.push(e),n.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(n,t),function(e,t){o.disableAll(),t.supportsVertexTextures&&o.enable(0),t.instancing&&o.enable(1),t.instancingColor&&o.enable(2),t.instancingMorph&&o.enable(3),t.matcap&&o.enable(4),t.envMap&&o.enable(5),t.normalMapObjectSpace&&o.enable(6),t.normalMapTangentSpace&&o.enable(7),t.clearcoat&&o.enable(8),t.iridescence&&o.enable(9),t.alphaTest&&o.enable(10),t.vertexColors&&o.enable(11),t.vertexAlphas&&o.enable(12),t.vertexUv1s&&o.enable(13),t.vertexUv2s&&o.enable(14),t.vertexUv3s&&o.enable(15),t.vertexTangents&&o.enable(16),t.anisotropy&&o.enable(17),t.alphaHash&&o.enable(18),t.batching&&o.enable(19),t.dispersion&&o.enable(20),t.batchingColor&&o.enable(21),t.gradientMap&&o.enable(22),e.push(o.mask),o.disableAll(),t.fog&&o.enable(0),t.useFog&&o.enable(1),t.flatShading&&o.enable(2),t.logarithmicDepthBuffer&&o.enable(3),t.reverseDepthBuffer&&o.enable(4),t.skinning&&o.enable(5),t.morphTargets&&o.enable(6),t.morphNormals&&o.enable(7),t.morphColors&&o.enable(8),t.premultipliedAlpha&&o.enable(9),t.shadowMapEnabled&&o.enable(10),t.doubleSided&&o.enable(11),t.flipSided&&o.enable(12),t.useDepthPacking&&o.enable(13),t.dithering&&o.enable(14),t.transmission&&o.enable(15),t.sheen&&o.enable(16),t.opaque&&o.enable(17),t.pointsUvs&&o.enable(18),t.decodeVideoTexture&&o.enable(19),t.decodeVideoTextureEmissive&&o.enable(20),t.alphaToCoverage&&o.enable(21),e.push(o.mask)}(n,t),n.push(e.outputColorSpace)),n.push(t.customProgramCacheKey),n.join()},getUniforms:function(e){const t=m[e.type];let n;if(t){const e=Cp[t];n=Pd.clone(e.uniforms)}else n=e.uniforms;return n},acquireProgram:function(t,n){let i;for(let e=0,s=h.length;e<s;e++){const t=h[e];if(t.cacheKey===n){i=t,++i.usedTimes;break}}return void 0===i&&(i=new Rf(e,n,t,r),h.push(i)),i},releaseProgram:function(e){if(0===--e.usedTimes){const t=h.indexOf(e);h[t]=h[h.length-1],h.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:h,dispose:function(){l.dispose()}}}function kf(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let n=e.get(t);return void 0===n&&(n={},e.set(t,n)),n},remove:function(t){e.delete(t)},update:function(t,n,i){e.get(t)[n]=i},dispose:function(){e=new WeakMap}}}function Lf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Of(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Uf(){const e=[];let t=0;const n=[],i=[],s=[];function r(n,i,s,r,a,o){let l=e[t];return void 0===l?(l={id:n.id,object:n,geometry:i,material:s,groupOrder:r,renderOrder:n.renderOrder,z:a,group:o},e[t]=l):(l.id=n.id,l.object=n,l.geometry=i,l.material=s,l.groupOrder=r,l.renderOrder=n.renderOrder,l.z=a,l.group=o),t++,l}return{opaque:n,transmissive:i,transparent:s,init:function(){t=0,n.length=0,i.length=0,s.length=0},push:function(e,t,a,o,l,c){const h=r(e,t,a,o,l,c);a.transmission>0?i.push(h):!0===a.transparent?s.push(h):n.push(h)},unshift:function(e,t,a,o,l,c){const h=r(e,t,a,o,l,c);a.transmission>0?i.unshift(h):!0===a.transparent?s.unshift(h):n.unshift(h)},finish:function(){for(let n=t,i=e.length;n<i;n++){const t=e[n];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){n.length>1&&n.sort(e||Lf),i.length>1&&i.sort(t||Of),s.length>1&&s.sort(t||Of)}}}function Ff(){let e=new WeakMap;return{get:function(t,n){const i=e.get(t);let s;return void 0===i?(s=new Uf,e.set(t,[s])):n>=i.length?(s=new Uf,i.push(s)):s=i[n],s},dispose:function(){e=new WeakMap}}}function Bf(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":n={direction:new eh,color:new Yu};break;case"SpotLight":n={position:new eh,direction:new eh,color:new Yu,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new eh,color:new Yu,distance:0,decay:0};break;case"HemisphereLight":n={direction:new eh,skyColor:new Yu,groundColor:new Yu};break;case"RectAreaLight":n={color:new Yu,position:new eh,halfWidth:new eh,halfHeight:new eh}}return e[t.id]=n,n}}}let zf=0;function Vf(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Hf(e){const t=new Bf,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":case"SpotLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Jc};break;case"PointLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Jc,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=n,n}}}(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let o=0;o<9;o++)i.probe.push(new eh);const s=new eh,r=new nu,a=new nu;return{setup:function(s){let r=0,a=0,o=0;for(let e=0;e<9;e++)i.probe[e].set(0,0,0);let l=0,c=0,h=0,u=0,d=0,p=0,m=0,f=0,g=0,v=0,x=0;s.sort(Vf);for(let e=0,_=s.length;e<_;e++){const y=s[e],_=y.color,b=y.intensity,w=y.distance,S=y.shadow&&y.shadow.map?y.shadow.map.texture:null;if(y.isAmbientLight)r+=_.r*b,a+=_.g*b,o+=_.b*b;else if(y.isLightProbe){for(let e=0;e<9;e++)i.probe[e].addScaledVector(y.sh.coefficients[e],b);x++}else if(y.isDirectionalLight){const e=t.get(y);if(e.color.copy(y.color).multiplyScalar(y.intensity),y.castShadow){const e=y.shadow,t=n.get(y);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,i.directionalShadow[l]=t,i.directionalShadowMap[l]=S,i.directionalShadowMatrix[l]=y.shadow.matrix,p++}i.directional[l]=e,l++}else if(y.isSpotLight){const e=t.get(y);e.position.setFromMatrixPosition(y.matrixWorld),e.color.copy(_).multiplyScalar(b),e.distance=w,e.coneCos=Math.cos(y.angle),e.penumbraCos=Math.cos(y.angle*(1-y.penumbra)),e.decay=y.decay,i.spot[h]=e;const s=y.shadow;if(y.map&&(i.spotLightMap[g]=y.map,g++,s.updateMatrices(y),y.castShadow&&v++),i.spotLightMatrix[h]=s.matrix,y.castShadow){const e=n.get(y);e.shadowIntensity=s.intensity,e.shadowBias=s.bias,e.shadowNormalBias=s.normalBias,e.shadowRadius=s.radius,e.shadowMapSize=s.mapSize,i.spotShadow[h]=e,i.spotShadowMap[h]=S,f++}h++}else if(y.isRectAreaLight){const e=t.get(y);e.color.copy(_).multiplyScalar(b),e.halfWidth.set(.5*y.width,0,0),e.halfHeight.set(0,.5*y.height,0),i.rectArea[u]=e,u++}else if(y.isPointLight){const e=t.get(y);if(e.color.copy(y.color).multiplyScalar(y.intensity),e.distance=y.distance,e.decay=y.decay,y.castShadow){const e=y.shadow,t=n.get(y);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,i.pointShadow[c]=t,i.pointShadowMap[c]=S,i.pointShadowMatrix[c]=y.shadow.matrix,m++}i.point[c]=e,c++}else if(y.isHemisphereLight){const e=t.get(y);e.skyColor.copy(y.color).multiplyScalar(b),e.groundColor.copy(y.groundColor).multiplyScalar(b),i.hemi[d]=e,d++}}u>0&&(!0===e.has("OES_texture_float_linear")?(i.rectAreaLTC1=Ep.LTC_FLOAT_1,i.rectAreaLTC2=Ep.LTC_FLOAT_2):(i.rectAreaLTC1=Ep.LTC_HALF_1,i.rectAreaLTC2=Ep.LTC_HALF_2)),i.ambient[0]=r,i.ambient[1]=a,i.ambient[2]=o;const y=i.hash;y.directionalLength===l&&y.pointLength===c&&y.spotLength===h&&y.rectAreaLength===u&&y.hemiLength===d&&y.numDirectionalShadows===p&&y.numPointShadows===m&&y.numSpotShadows===f&&y.numSpotMaps===g&&y.numLightProbes===x||(i.directional.length=l,i.spot.length=h,i.rectArea.length=u,i.point.length=c,i.hemi.length=d,i.directionalShadow.length=p,i.directionalShadowMap.length=p,i.pointShadow.length=m,i.pointShadowMap.length=m,i.spotShadow.length=f,i.spotShadowMap.length=f,i.directionalShadowMatrix.length=p,i.pointShadowMatrix.length=m,i.spotLightMatrix.length=f+g-v,i.spotLightMap.length=g,i.numSpotLightShadowsWithMaps=v,i.numLightProbes=x,y.directionalLength=l,y.pointLength=c,y.spotLength=h,y.rectAreaLength=u,y.hemiLength=d,y.numDirectionalShadows=p,y.numPointShadows=m,y.numSpotShadows=f,y.numSpotMaps=g,y.numLightProbes=x,i.version=zf++)},setupView:function(e,t){let n=0,o=0,l=0,c=0,h=0;const u=t.matrixWorldInverse;for(let d=0,p=e.length;d<p;d++){const t=e[d];if(t.isDirectionalLight){const e=i.directional[n];e.direction.setFromMatrixPosition(t.matrixWorld),s.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(s),e.direction.transformDirection(u),n++}else if(t.isSpotLight){const e=i.spot[l];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),e.direction.setFromMatrixPosition(t.matrixWorld),s.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(s),e.direction.transformDirection(u),l++}else if(t.isRectAreaLight){const e=i.rectArea[c];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),a.identity(),r.copy(t.matrixWorld),r.premultiply(u),a.extractRotation(r),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),e.halfWidth.applyMatrix4(a),e.halfHeight.applyMatrix4(a),c++}else if(t.isPointLight){const e=i.point[o];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),o++}else if(t.isHemisphereLight){const e=i.hemi[h];e.direction.setFromMatrixPosition(t.matrixWorld),e.direction.transformDirection(u),h++}}},state:i}}function Wf(e){const t=new Hf(e),n=[],i=[],s={lightsArray:n,shadowsArray:i,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){s.camera=e,n.length=0,i.length=0},state:s,setupLights:function(){t.setup(n)},setupLightsView:function(e){t.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){i.push(e)}}}function Gf(e){let t=new WeakMap;return{get:function(n,i=0){const s=t.get(n);let r;return void 0===s?(r=new Wf(e),t.set(n,[r])):i>=s.length?(r=new Wf(e),s.push(r)):r=s[i],r},dispose:function(){t=new WeakMap}}}function qf(e,t,n){let i=new Qd;const s=new Jc,r=new Jc,a=new Mh,o=new lp({depthPacking:3201}),l=new cp,c={},h=n.maxTextureSize,u={[qo]:1,[Xo]:0,[Yo]:2},d=new Id({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Jc},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const m=new pd;m.setAttribute("position",new nd(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new Td(m,d),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let v=this.type;function x(n,i){const r=t.update(f);d.defines.VSM_SAMPLES!==n.blurSamples&&(d.defines.VSM_SAMPLES=n.blurSamples,p.defines.VSM_SAMPLES=n.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),null===n.mapPass&&(n.mapPass=new Eh(s.x,s.y)),d.uniforms.shadow_pass.value=n.map.texture,d.uniforms.resolution.value=n.mapSize,d.uniforms.radius.value=n.radius,e.setRenderTarget(n.mapPass),e.clear(),e.renderBufferDirect(i,null,r,d,f,null),p.uniforms.shadow_pass.value=n.mapPass.texture,p.uniforms.resolution.value=n.mapSize,p.uniforms.radius.value=n.radius,e.setRenderTarget(n.map),e.clear(),e.renderBufferDirect(i,null,r,p,f,null)}function y(t,n,i,s){let r=null;const a=!0===i.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==a)r=a;else if(r=!0===i.isPointLight?l:o,e.localClippingEnabled&&!0===n.clipShadows&&Array.isArray(n.clippingPlanes)&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0||n.map&&n.alphaTest>0||!0===n.alphaToCoverage){const e=r.uuid,t=n.uuid;let i=c[e];void 0===i&&(i={},c[e]=i);let s=i[t];void 0===s&&(s=r.clone(),i[t]=s,n.addEventListener("dispose",b)),r=s}return r.visible=n.visible,r.wireframe=n.wireframe,r.side=3===s?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:u[n.side],r.alphaMap=n.alphaMap,r.alphaTest=!0===n.alphaToCoverage?.5:n.alphaTest,r.map=n.map,r.clipShadows=n.clipShadows,r.clippingPlanes=n.clippingPlanes,r.clipIntersection=n.clipIntersection,r.displacementMap=n.displacementMap,r.displacementScale=n.displacementScale,r.displacementBias=n.displacementBias,r.wireframeLinewidth=n.wireframeLinewidth,r.linewidth=n.linewidth,!0===i.isPointLight&&!0===r.isMeshDistanceMaterial&&(e.properties.get(r).light=i),r}function _(n,s,r,a,o){if(!1===n.visible)return;if(n.layers.test(s.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&3===o)&&(!n.frustumCulled||i.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,n.matrixWorld);const i=t.update(n),l=n.material;if(Array.isArray(l)){const t=i.groups;for(let c=0,h=t.length;c<h;c++){const h=t[c],u=l[h.materialIndex];if(u&&u.visible){const t=y(n,u,a,o);n.onBeforeShadow(e,n,s,r,i,t,h),e.renderBufferDirect(r,null,i,t,n,h),n.onAfterShadow(e,n,s,r,i,t,h)}}}else if(l.visible){const t=y(n,l,a,o);n.onBeforeShadow(e,n,s,r,i,t,null),e.renderBufferDirect(r,null,i,t,n,null),n.onAfterShadow(e,n,s,r,i,t,null)}}const l=n.children;for(let e=0,t=l.length;e<t;e++)_(l[e],s,r,a,o)}function b(e){e.target.removeEventListener("dispose",b);for(const t in c){const n=c[t],i=e.target.uuid;i in n&&(n[i].dispose(),delete n[i])}}this.render=function(t,n,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),c=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),d=e.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=3!==v&&3===this.type,m=3===v&&3!==this.type;for(let f=0,g=t.length;f<g;f++){const l=t[f],c=l.shadow;if(void 0===c)continue;if(!1===c.autoUpdate&&!1===c.needsUpdate)continue;s.copy(c.mapSize);const u=c.getFrameExtents();if(s.multiply(u),r.copy(c.mapSize),(s.x>h||s.y>h)&&(s.x>h&&(r.x=Math.floor(h/u.x),s.x=r.x*u.x,c.mapSize.x=r.x),s.y>h&&(r.y=Math.floor(h/u.y),s.y=r.y*u.y,c.mapSize.y=r.y)),null===c.map||!0===p||!0===m){const e=3!==this.type?{minFilter:Cl,magFilter:Cl}:{};null!==c.map&&c.map.dispose(),c.map=new Eh(s.x,s.y,e),c.map.texture.name=l.name+".shadowMap",c.camera.updateProjectionMatrix()}e.setRenderTarget(c.map),e.clear();const g=c.getViewportCount();for(let e=0;e<g;e++){const t=c.getViewport(e);a.set(r.x*t.x,r.y*t.y,r.x*t.z,r.y*t.w),d.viewport(a),c.updateMatrices(l,e),i=c.getFrustum(),_(n,o,c.camera,l,this.type)}!0!==c.isPointLightShadow&&3===this.type&&x(c,o),c.needsUpdate=!1}v=this.type,g.needsUpdate=!1,e.setRenderTarget(l,c,u)}}const Xf={[pl]:1,[fl]:6,[vl]:7,[gl]:5,[ml]:0,[yl]:2,[_l]:4,[xl]:3};function Yf(e,t){const n=new function(){let t=!1;const n=new Mh;let i=null;const s=new Mh(0,0,0,0);return{setMask:function(n){i===n||t||(e.colorMask(n,n,n,n),i=n)},setLocked:function(e){t=e},setClear:function(t,i,r,a,o){!0===o&&(t*=a,i*=a,r*=a),n.set(t,i,r,a),!1===s.equals(n)&&(e.clearColor(t,i,r,a),s.copy(n))},reset:function(){t=!1,i=null,s.set(-1,0,0,0)}}},i=new function(){let n=!1,i=!1,s=null,r=null,a=null;return{setReversed:function(e){if(i!==e){const n=t.get("EXT_clip_control");e?n.clipControlEXT(n.LOWER_LEFT_EXT,n.ZERO_TO_ONE_EXT):n.clipControlEXT(n.LOWER_LEFT_EXT,n.NEGATIVE_ONE_TO_ONE_EXT),i=e;const s=a;a=null,this.setClear(s)}},getReversed:function(){return i},setTest:function(t){t?B(e.DEPTH_TEST):z(e.DEPTH_TEST)},setMask:function(t){s===t||n||(e.depthMask(t),s=t)},setFunc:function(t){if(i&&(t=Xf[t]),r!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}r=t}},setLocked:function(e){n=e},setClear:function(t){a!==t&&(i&&(t=1-t),e.clearDepth(t),a=t)},reset:function(){n=!1,s=null,r=null,a=null,i=!1}}},s=new function(){let t=!1,n=null,i=null,s=null,r=null,a=null,o=null,l=null,c=null;return{setTest:function(n){t||(n?B(e.STENCIL_TEST):z(e.STENCIL_TEST))},setMask:function(i){n===i||t||(e.stencilMask(i),n=i)},setFunc:function(t,n,a){i===t&&s===n&&r===a||(e.stencilFunc(t,n,a),i=t,s=n,r=a)},setOp:function(t,n,i){a===t&&o===n&&l===i||(e.stencilOp(t,n,i),a=t,o=n,l=i)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,n=null,i=null,s=null,r=null,a=null,o=null,l=null,c=null}}},r=new WeakMap,a=new WeakMap;let o={},l={},c=new WeakMap,h=[],u=null,d=!1,p=null,m=null,f=null,g=null,v=null,x=null,y=null,_=new Yu(0,0,0),b=0,w=!1,S=null,M=null,T=null,E=null,C=null;const A=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let N=!1,R=0;const P=e.getParameter(e.VERSION);-1!==P.indexOf("WebGL")?(R=parseFloat(/^WebGL (\d)/.exec(P)[1]),N=R>=1):-1!==P.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL ES (\d)/.exec(P)[1]),N=R>=2);let I=null,j={};const D=e.getParameter(e.SCISSOR_BOX),k=e.getParameter(e.VIEWPORT),L=(new Mh).fromArray(D),O=(new Mh).fromArray(k);function U(t,n,i,s){const r=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let o=0;o<i;o++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(n,0,e.RGBA,1,1,s,0,e.RGBA,e.UNSIGNED_BYTE,r):e.texImage2D(n+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,r);return a}const F={};function B(t){!0!==o[t]&&(e.enable(t),o[t]=!0)}function z(t){!1!==o[t]&&(e.disable(t),o[t]=!1)}F[e.TEXTURE_2D]=U(e.TEXTURE_2D,e.TEXTURE_2D,1),F[e.TEXTURE_CUBE_MAP]=U(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),F[e.TEXTURE_2D_ARRAY]=U(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),F[e.TEXTURE_3D]=U(e.TEXTURE_3D,e.TEXTURE_3D,1,1),n.setClear(0,0,0,1),i.setClear(1),s.setClear(0),B(e.DEPTH_TEST),i.setFunc(3),G(!1),q(1),B(e.CULL_FACE),W(0);const V={[$o]:e.FUNC_ADD,[Zo]:e.FUNC_SUBTRACT,[Ko]:e.FUNC_REVERSE_SUBTRACT};V[103]=e.MIN,V[104]=e.MAX;const H={[Jo]:e.ZERO,[Qo]:e.ONE,[el]:e.SRC_COLOR,[nl]:e.SRC_ALPHA,[ll]:e.SRC_ALPHA_SATURATE,[al]:e.DST_COLOR,[sl]:e.DST_ALPHA,[tl]:e.ONE_MINUS_SRC_COLOR,[il]:e.ONE_MINUS_SRC_ALPHA,[ol]:e.ONE_MINUS_DST_COLOR,[rl]:e.ONE_MINUS_DST_ALPHA,[cl]:e.CONSTANT_COLOR,[hl]:e.ONE_MINUS_CONSTANT_COLOR,[ul]:e.CONSTANT_ALPHA,[dl]:e.ONE_MINUS_CONSTANT_ALPHA};function W(t,n,i,s,r,a,o,l,c,h){if(0!==t){if(!1===d&&(B(e.BLEND),d=!0),5===t)r=r||n,a=a||i,o=o||s,n===m&&r===v||(e.blendEquationSeparate(V[n],V[r]),m=n,v=r),i===f&&s===g&&a===x&&o===y||(e.blendFuncSeparate(H[i],H[s],H[a],H[o]),f=i,g=s,x=a,y=o),!1!==l.equals(_)&&c===b||(e.blendColor(l.r,l.g,l.b,c),_.copy(l),b=c),p=t,w=!1;else if(t!==p||h!==w){if(m===$o&&v===$o||(e.blendEquation(e.FUNC_ADD),m=$o,v=$o),h)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE,e.ONE,e.ONE)}f=null,g=null,x=null,y=null,_.set(0,0,0),b=0,p=t,w=h}}else!0===d&&(z(e.BLEND),d=!1)}function G(t){S!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),S=t)}function q(t){0!==t?(B(e.CULL_FACE),t!==M&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):z(e.CULL_FACE),M=t}function X(t,n,i){t?(B(e.POLYGON_OFFSET_FILL),E===n&&C===i||(e.polygonOffset(n,i),E=n,C=i)):z(e.POLYGON_OFFSET_FILL)}return{buffers:{color:n,depth:i,stencil:s},enable:B,disable:z,bindFramebuffer:function(t,n){return l[t]!==n&&(e.bindFramebuffer(t,n),l[t]=n,t===e.DRAW_FRAMEBUFFER&&(l[e.FRAMEBUFFER]=n),t===e.FRAMEBUFFER&&(l[e.DRAW_FRAMEBUFFER]=n),!0)},drawBuffers:function(t,n){let i=h,s=!1;if(t){i=c.get(n),void 0===i&&(i=[],c.set(n,i));const r=t.textures;if(i.length!==r.length||i[0]!==e.COLOR_ATTACHMENT0){for(let t=0,n=r.length;t<n;t++)i[t]=e.COLOR_ATTACHMENT0+t;i.length=r.length,s=!0}}else i[0]!==e.BACK&&(i[0]=e.BACK,s=!0);s&&e.drawBuffers(i)},useProgram:function(t){return u!==t&&(e.useProgram(t),u=t,!0)},setBlending:W,setMaterial:function(t,r){2===t.side?z(e.CULL_FACE):B(e.CULL_FACE);let a=1===t.side;r&&(a=!a),G(a),1===t.blending&&!1===t.transparent?W(0):W(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),n.setMask(t.colorWrite);const o=t.stencilWrite;s.setTest(o),o&&(s.setMask(t.stencilWriteMask),s.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),s.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),X(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?B(e.SAMPLE_ALPHA_TO_COVERAGE):z(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:G,setCullFace:q,setLineWidth:function(t){t!==T&&(N&&e.lineWidth(t),T=t)},setPolygonOffset:X,setScissorTest:function(t){t?B(e.SCISSOR_TEST):z(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+A-1),I!==t&&(e.activeTexture(t),I=t)},bindTexture:function(t,n,i){void 0===i&&(i=null===I?e.TEXTURE0+A-1:I);let s=j[i];void 0===s&&(s={type:void 0,texture:void 0},j[i]=s),s.type===t&&s.texture===n||(I!==i&&(e.activeTexture(i),I=i),e.bindTexture(t,n||F[t]),s.type=t,s.texture=n)},unbindTexture:function(){const t=j[I];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(t){}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(t){}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(t){}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(t){}},updateUBOMapping:function(t,n){let i=a.get(n);void 0===i&&(i=new WeakMap,a.set(n,i));let s=i.get(t);void 0===s&&(s=e.getUniformBlockIndex(n,t.name),i.set(t,s))},uniformBlockBinding:function(t,n){const i=a.get(n).get(t);r.get(n)!==i&&(e.uniformBlockBinding(n,i,t.__bindingPointIndex),r.set(n,i))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(t){}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(t){}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(t){}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(t){}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(t){}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(t){}},scissor:function(t){!1===L.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),L.copy(t))},viewport:function(t){!1===O.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),O.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),i.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),o={},I=null,j={},l={},c=new WeakMap,h=[],u=null,d=!1,p=null,m=null,f=null,g=null,v=null,x=null,y=null,_=new Yu(0,0,0),b=0,w=!1,S=null,M=null,T=null,E=null,C=null,L.set(0,0,e.canvas.width,e.canvas.height),O.set(0,0,e.canvas.width,e.canvas.height),n.reset(),i.reset(),s.reset()}}}function $f(e,t,n,i,s,r,a){const o=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),c=new Jc,h=new WeakMap;let u;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(W){}function m(e,t){return p?new OffscreenCanvas(e,t):ah("canvas")}function f(e,t,n){let i=1;const s=H(e);if((s.width>n||s.height>n)&&(i=n/Math.max(s.width,s.height)),i<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const n=Math.floor(i*s.width),r=Math.floor(i*s.height);void 0===u&&(u=m(n,r));const a=t?m(n,r):u;return a.width=n,a.height=r,a.getContext("2d").drawImage(e,0,0,n,r),a}return e}return e}function g(e){return e.generateMipmaps}function v(t){e.generateMipmap(t)}function x(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function y(n,i,s,r,a=!1){if(null!==n&&void 0!==e[n])return e[n];let o=i;if(i===e.RED&&(s===e.FLOAT&&(o=e.R32F),s===e.HALF_FLOAT&&(o=e.R16F),s===e.UNSIGNED_BYTE&&(o=e.R8)),i===e.RED_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.R8UI),s===e.UNSIGNED_SHORT&&(o=e.R16UI),s===e.UNSIGNED_INT&&(o=e.R32UI),s===e.BYTE&&(o=e.R8I),s===e.SHORT&&(o=e.R16I),s===e.INT&&(o=e.R32I)),i===e.RG&&(s===e.FLOAT&&(o=e.RG32F),s===e.HALF_FLOAT&&(o=e.RG16F),s===e.UNSIGNED_BYTE&&(o=e.RG8)),i===e.RG_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.RG8UI),s===e.UNSIGNED_SHORT&&(o=e.RG16UI),s===e.UNSIGNED_INT&&(o=e.RG32UI),s===e.BYTE&&(o=e.RG8I),s===e.SHORT&&(o=e.RG16I),s===e.INT&&(o=e.RG32I)),i===e.RGB_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.RGB8UI),s===e.UNSIGNED_SHORT&&(o=e.RGB16UI),s===e.UNSIGNED_INT&&(o=e.RGB32UI),s===e.BYTE&&(o=e.RGB8I),s===e.SHORT&&(o=e.RGB16I),s===e.INT&&(o=e.RGB32I)),i===e.RGBA_INTEGER&&(s===e.UNSIGNED_BYTE&&(o=e.RGBA8UI),s===e.UNSIGNED_SHORT&&(o=e.RGBA16UI),s===e.UNSIGNED_INT&&(o=e.RGBA32UI),s===e.BYTE&&(o=e.RGBA8I),s===e.SHORT&&(o=e.RGBA16I),s===e.INT&&(o=e.RGBA32I)),i===e.RGB&&s===e.UNSIGNED_INT_5_9_9_9_REV&&(o=e.RGB9_E5),i===e.RGBA){const t=a?Ac:ph.getTransfer(r);s===e.FLOAT&&(o=e.RGBA32F),s===e.HALF_FLOAT&&(o=e.RGBA16F),s===e.UNSIGNED_BYTE&&(o=t===Nc?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(o=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(o=e.RGB5_A1)}return o!==e.R16F&&o!==e.R32F&&o!==e.RG16F&&o!==e.RG32F&&o!==e.RGBA16F&&o!==e.RGBA32F||t.get("EXT_color_buffer_float"),o}function _(t,n){let i;return t?null===n||n===Ll||n===zl?i=e.DEPTH24_STENCIL8:n===Ol?i=e.DEPTH32F_STENCIL8:n===Dl&&(i=e.DEPTH24_STENCIL8):null===n||n===Ll||n===zl?i=e.DEPTH_COMPONENT24:n===Ol?i=e.DEPTH_COMPONENT32F:n===Dl&&(i=e.DEPTH_COMPONENT16),i}function b(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==Cl&&e.minFilter!==Rl?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function w(e){const t=e.target;t.removeEventListener("dispose",w),function(e){const t=i.get(e);if(void 0===t.__webglInit)return;const n=e.source,s=d.get(n);if(s){const i=s[t.__cacheKey];i.usedTimes--,0===i.usedTimes&&M(e),0===Object.keys(s).length&&d.delete(n)}i.remove(e)}(t),t.isVideoTexture&&h.delete(t)}function S(t){const n=t.target;n.removeEventListener("dispose",S),function(t){const n=i.get(t);if(t.depthTexture&&(t.depthTexture.dispose(),i.remove(t.depthTexture)),t.isWebGLCubeRenderTarget)for(let i=0;i<6;i++){if(Array.isArray(n.__webglFramebuffer[i]))for(let t=0;t<n.__webglFramebuffer[i].length;t++)e.deleteFramebuffer(n.__webglFramebuffer[i][t]);else e.deleteFramebuffer(n.__webglFramebuffer[i]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[i])}else{if(Array.isArray(n.__webglFramebuffer))for(let t=0;t<n.__webglFramebuffer.length;t++)e.deleteFramebuffer(n.__webglFramebuffer[t]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let t=0;t<n.__webglColorRenderbuffer.length;t++)n.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[t]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}const s=t.textures;for(let r=0,o=s.length;r<o;r++){const t=i.get(s[r]);t.__webglTexture&&(e.deleteTexture(t.__webglTexture),a.memory.textures--),i.remove(s[r])}i.remove(t)}(n)}function M(t){const n=i.get(t);e.deleteTexture(n.__webglTexture);const s=t.source;delete d.get(s)[n.__cacheKey],a.memory.textures--}let T=0;function E(t,s){const r=i.get(t);if(t.isVideoTexture&&function(e){const t=a.render.frame;h.get(e)!==t&&(h.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&r.__version!==t.version){const e=t.image;if(null===e);else if(!1!==e.complete)return void j(r,t,s)}n.bindTexture(e.TEXTURE_2D,r.__webglTexture,e.TEXTURE0+s)}const C={[Ml]:e.REPEAT,[Tl]:e.CLAMP_TO_EDGE,[El]:e.MIRRORED_REPEAT},A={[Cl]:e.NEAREST,[Al]:e.NEAREST_MIPMAP_NEAREST,[Nl]:e.NEAREST_MIPMAP_LINEAR,[Rl]:e.LINEAR,[Pl]:e.LINEAR_MIPMAP_NEAREST,[Il]:e.LINEAR_MIPMAP_LINEAR},N={[Pc]:e.NEVER,[Uc]:e.ALWAYS,[Ic]:e.LESS,[Dc]:e.LEQUAL,[jc]:e.EQUAL,[Oc]:e.GEQUAL,[kc]:e.GREATER,[Lc]:e.NOTEQUAL};function R(n,r){if(r.type===Ol&&!1===t.has("OES_texture_float_linear")&&(r.magFilter===Rl||r.magFilter===Pl||r.magFilter===Nl||r.magFilter===Il||r.minFilter===Rl||r.minFilter===Pl||r.minFilter===Nl||r.minFilter),e.texParameteri(n,e.TEXTURE_WRAP_S,C[r.wrapS]),e.texParameteri(n,e.TEXTURE_WRAP_T,C[r.wrapT]),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,C[r.wrapR]),e.texParameteri(n,e.TEXTURE_MAG_FILTER,A[r.magFilter]),e.texParameteri(n,e.TEXTURE_MIN_FILTER,A[r.minFilter]),r.compareFunction&&(e.texParameteri(n,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,N[r.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(r.magFilter===Cl)return;if(r.minFilter!==Nl&&r.minFilter!==Il)return;if(r.type===Ol&&!1===t.has("OES_texture_float_linear"))return;if(r.anisotropy>1||i.get(r).__currentAnisotropy){const a=t.get("EXT_texture_filter_anisotropic");e.texParameterf(n,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r.anisotropy,s.getMaxAnisotropy())),i.get(r).__currentAnisotropy=r.anisotropy}}}function P(t,n){let i=!1;void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",w));const s=n.source;let r=d.get(s);void 0===r&&(r={},d.set(s,r));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(n);if(o!==t.__cacheKey){void 0===r[o]&&(r[o]={texture:e.createTexture(),usedTimes:0},a.memory.textures++,i=!0),r[o].usedTimes++;const s=r[t.__cacheKey];void 0!==s&&(r[t.__cacheKey].usedTimes--,0===s.usedTimes&&M(n)),t.__cacheKey=o,t.__webglTexture=r[o].texture}return i}function I(e,t,n){return Math.floor(Math.floor(e/n)/t)}function j(t,a,o){let l=e.TEXTURE_2D;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),a.isData3DTexture&&(l=e.TEXTURE_3D);const c=P(t,a),h=a.source;n.bindTexture(l,t.__webglTexture,e.TEXTURE0+o);const u=i.get(h);if(h.version!==u.__version||!0===c){n.activeTexture(e.TEXTURE0+o);const t=ph.getPrimaries(ph.workingColorSpace),i=a.colorSpace===Tc?null:ph.getPrimaries(a.colorSpace),d=a.colorSpace===Tc||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);let p=f(a.image,!1,s.maxTextureSize);p=V(a,p);const m=r.convert(a.format,a.colorSpace),x=r.convert(a.type);let w,S=y(a.internalFormat,m,x,a.colorSpace,a.isVideoTexture);R(l,a);const M=a.mipmaps,T=!0!==a.isVideoTexture,E=void 0===u.__version||!0===c,C=h.dataReady,A=b(a,p);if(a.isDepthTexture)S=_(a.format===Wl,a.type),E&&(T?n.texStorage2D(e.TEXTURE_2D,1,S,p.width,p.height):n.texImage2D(e.TEXTURE_2D,0,S,p.width,p.height,0,m,x,null));else if(a.isDataTexture)if(M.length>0){T&&E&&n.texStorage2D(e.TEXTURE_2D,A,S,M[0].width,M[0].height);for(let t=0,i=M.length;t<i;t++)w=M[t],T?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,m,x,w.data):n.texImage2D(e.TEXTURE_2D,t,S,w.width,w.height,0,m,x,w.data);a.generateMipmaps=!1}else T?(E&&n.texStorage2D(e.TEXTURE_2D,A,S,p.width,p.height),C&&function(t,i,s,r){const a=t.updateRanges;if(0===a.length)n.texSubImage2D(e.TEXTURE_2D,0,0,0,i.width,i.height,s,r,i.data);else{a.sort((e,t)=>e.start-t.start);let o=0;for(let e=1;e<a.length;e++){const t=a[o],n=a[e],s=t.start+t.count,r=I(n.start,i.width,4),l=I(t.start,i.width,4);n.start<=s+1&&r===l&&I(n.start+n.count-1,i.width,4)===r?t.count=Math.max(t.count,n.start+n.count-t.start):(++o,a[o]=n)}a.length=o+1;const l=e.getParameter(e.UNPACK_ROW_LENGTH),c=e.getParameter(e.UNPACK_SKIP_PIXELS),h=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,i.width);for(let t=0,u=a.length;t<u;t++){const o=a[t],l=Math.floor(o.start/4),c=Math.ceil(o.count/4),h=l%i.width,u=Math.floor(l/i.width),d=c,p=1;e.pixelStorei(e.UNPACK_SKIP_PIXELS,h),e.pixelStorei(e.UNPACK_SKIP_ROWS,u),n.texSubImage2D(e.TEXTURE_2D,0,h,u,d,p,s,r,i.data)}t.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,l),e.pixelStorei(e.UNPACK_SKIP_PIXELS,c),e.pixelStorei(e.UNPACK_SKIP_ROWS,h)}}(a,p,m,x)):n.texImage2D(e.TEXTURE_2D,0,S,p.width,p.height,0,m,x,p.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){T&&E&&n.texStorage3D(e.TEXTURE_2D_ARRAY,A,S,M[0].width,M[0].height,p.depth);for(let t=0,i=M.length;t<i;t++)if(w=M[t],a.format!==Vl){if(null!==m)if(T){if(C)if(a.layerUpdates.size>0){const i=wp(w.width,w.height,a.format,a.type);for(const s of a.layerUpdates){const r=w.data.subarray(s*i/w.data.BYTES_PER_ELEMENT,(s+1)*i/w.data.BYTES_PER_ELEMENT);n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,s,w.width,w.height,1,m,r)}a.clearLayerUpdates()}else n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,w.width,w.height,p.depth,m,w.data)}else n.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,S,w.width,w.height,p.depth,0,w.data,0,0)}else T?C&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,w.width,w.height,p.depth,m,x,w.data):n.texImage3D(e.TEXTURE_2D_ARRAY,t,S,w.width,w.height,p.depth,0,m,x,w.data)}else{T&&E&&n.texStorage2D(e.TEXTURE_2D,A,S,M[0].width,M[0].height);for(let t=0,i=M.length;t<i;t++)w=M[t],a.format!==Vl?null!==m&&(T?C&&n.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,m,w.data):n.compressedTexImage2D(e.TEXTURE_2D,t,S,w.width,w.height,0,w.data)):T?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,w.width,w.height,m,x,w.data):n.texImage2D(e.TEXTURE_2D,t,S,w.width,w.height,0,m,x,w.data)}else if(a.isDataArrayTexture)if(T){if(E&&n.texStorage3D(e.TEXTURE_2D_ARRAY,A,S,p.width,p.height,p.depth),C)if(a.layerUpdates.size>0){const t=wp(p.width,p.height,a.format,a.type);for(const i of a.layerUpdates){const s=p.data.subarray(i*t/p.data.BYTES_PER_ELEMENT,(i+1)*t/p.data.BYTES_PER_ELEMENT);n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,i,p.width,p.height,1,m,x,s)}a.clearLayerUpdates()}else n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,p.width,p.height,p.depth,m,x,p.data)}else n.texImage3D(e.TEXTURE_2D_ARRAY,0,S,p.width,p.height,p.depth,0,m,x,p.data);else if(a.isData3DTexture)T?(E&&n.texStorage3D(e.TEXTURE_3D,A,S,p.width,p.height,p.depth),C&&n.texSubImage3D(e.TEXTURE_3D,0,0,0,0,p.width,p.height,p.depth,m,x,p.data)):n.texImage3D(e.TEXTURE_3D,0,S,p.width,p.height,p.depth,0,m,x,p.data);else if(a.isFramebufferTexture){if(E)if(T)n.texStorage2D(e.TEXTURE_2D,A,S,p.width,p.height);else{let t=p.width,i=p.height;for(let s=0;s<A;s++)n.texImage2D(e.TEXTURE_2D,s,S,t,i,0,m,x,null),t>>=1,i>>=1}}else if(M.length>0){if(T&&E){const t=H(M[0]);n.texStorage2D(e.TEXTURE_2D,A,S,t.width,t.height)}for(let t=0,i=M.length;t<i;t++)w=M[t],T?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,m,x,w):n.texImage2D(e.TEXTURE_2D,t,S,m,x,w);a.generateMipmaps=!1}else if(T){if(E){const t=H(p);n.texStorage2D(e.TEXTURE_2D,A,S,t.width,t.height)}C&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,m,x,p)}else n.texImage2D(e.TEXTURE_2D,0,S,m,x,p);g(a)&&v(l),u.__version=h.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}function D(t,s,a,l,c,h){const u=r.convert(a.format,a.colorSpace),d=r.convert(a.type),p=y(a.internalFormat,u,d,a.colorSpace),m=i.get(s),f=i.get(a);if(f.__renderTarget=s,!m.__hasExternalTextures){const t=Math.max(1,s.width>>h),i=Math.max(1,s.height>>h);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?n.texImage3D(c,h,p,t,i,s.depth,0,u,d,null):n.texImage2D(c,h,p,t,i,0,u,d,null)}n.bindFramebuffer(e.FRAMEBUFFER,t),z(s)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,f.__webglTexture,0,B(s)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,f.__webglTexture,h),n.bindFramebuffer(e.FRAMEBUFFER,null)}function k(t,n,i){if(e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer){const s=n.depthTexture,r=s&&s.isDepthTexture?s.type:null,a=_(n.stencilBuffer,r),l=n.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=B(n);z(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,c,a,n.width,n.height):i?e.renderbufferStorageMultisample(e.RENDERBUFFER,c,a,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,a,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,t)}else{const t=n.textures;for(let s=0;s<t.length;s++){const a=t[s],l=r.convert(a.format,a.colorSpace),c=r.convert(a.type),h=y(a.internalFormat,l,c,a.colorSpace),u=B(n);i&&!1===z(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,u,h,n.width,n.height):z(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,u,h,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,h,n.width,n.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function L(t,s){if(s&&s.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(e.FRAMEBUFFER,t),!s.depthTexture||!s.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const r=i.get(s.depthTexture);r.__renderTarget=s,r.__webglTexture&&s.depthTexture.image.width===s.width&&s.depthTexture.image.height===s.height||(s.depthTexture.image.width=s.width,s.depthTexture.image.height=s.height,s.depthTexture.needsUpdate=!0),E(s.depthTexture,0);const a=r.__webglTexture,l=B(s);if(s.depthTexture.format===Hl)z(s)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0);else{if(s.depthTexture.format!==Wl)throw new Error("Unknown depthTexture format");z(s)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0)}}function O(t){const s=i.get(t),r=!0===t.isWebGLCubeRenderTarget;if(s.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(s.__depthDisposeCallback&&s.__depthDisposeCallback(),e){const t=()=>{delete s.__boundDepthTexture,delete s.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),s.__depthDisposeCallback=t}s.__boundDepthTexture=e}if(t.depthTexture&&!s.__autoAllocateDepthBuffer){if(r)throw new Error("target.depthTexture not supported in Cube render targets");const e=t.texture.mipmaps;e&&e.length>0?L(s.__webglFramebuffer[0],t):L(s.__webglFramebuffer,t)}else if(r){s.__webglDepthbuffer=[];for(let i=0;i<6;i++)if(n.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer[i]),void 0===s.__webglDepthbuffer[i])s.__webglDepthbuffer[i]=e.createRenderbuffer(),k(s.__webglDepthbuffer[i],t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,r=s.__webglDepthbuffer[i];e.bindRenderbuffer(e.RENDERBUFFER,r),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,r)}}else{const i=t.texture.mipmaps;if(i&&i.length>0?n.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer[0]):n.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer),void 0===s.__webglDepthbuffer)s.__webglDepthbuffer=e.createRenderbuffer(),k(s.__webglDepthbuffer,t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,i=s.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,i)}}n.bindFramebuffer(e.FRAMEBUFFER,null)}const U=[],F=[];function B(e){return Math.min(s.maxSamples,e.samples)}function z(e){const n=i.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function V(e,t){const n=e.colorSpace;return e.format,e.type,!0===e.isCompressedTexture||!0===e.isVideoTexture||n!==Cc&&n!==Tc&&ph.getTransfer(n),t}function H(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(c.width=e.naturalWidth||e.width,c.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(c.width=e.displayWidth,c.height=e.displayHeight):(c.width=e.width,c.height=e.height),c}this.allocateTextureUnit=function(){const e=T;return s.maxTextures,T+=1,e},this.resetTextureUnits=function(){T=0},this.setTexture2D=E,this.setTexture2DArray=function(t,s){const r=i.get(t);t.version>0&&r.__version!==t.version?j(r,t,s):n.bindTexture(e.TEXTURE_2D_ARRAY,r.__webglTexture,e.TEXTURE0+s)},this.setTexture3D=function(t,s){const r=i.get(t);t.version>0&&r.__version!==t.version?j(r,t,s):n.bindTexture(e.TEXTURE_3D,r.__webglTexture,e.TEXTURE0+s)},this.setTextureCube=function(t,a){const o=i.get(t);t.version>0&&o.__version!==t.version?function(t,a,o){if(6!==a.image.length)return;const l=P(t,a),c=a.source;n.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+o);const h=i.get(c);if(c.version!==h.__version||!0===l){n.activeTexture(e.TEXTURE0+o);const t=ph.getPrimaries(ph.workingColorSpace),i=a.colorSpace===Tc?null:ph.getPrimaries(a.colorSpace),u=a.colorSpace===Tc||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,u);const d=a.isCompressedTexture||a.image[0].isCompressedTexture,p=a.image[0]&&a.image[0].isDataTexture,m=[];for(let e=0;e<6;e++)m[e]=d||p?p?a.image[e].image:a.image[e]:f(a.image[e],!0,s.maxCubemapSize),m[e]=V(a,m[e]);const x=m[0],_=r.convert(a.format,a.colorSpace),w=r.convert(a.type),S=y(a.internalFormat,_,w,a.colorSpace),M=!0!==a.isVideoTexture,T=void 0===h.__version||!0===l,E=c.dataReady;let C,A=b(a,x);if(R(e.TEXTURE_CUBE_MAP,a),d){M&&T&&n.texStorage2D(e.TEXTURE_CUBE_MAP,A,S,x.width,x.height);for(let t=0;t<6;t++){C=m[t].mipmaps;for(let i=0;i<C.length;i++){const s=C[i];a.format!==Vl?null!==_&&(M?E&&n.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,s.width,s.height,_,s.data):n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,S,s.width,s.height,0,s.data)):M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,s.width,s.height,_,w,s.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,S,s.width,s.height,0,_,w,s.data)}}}else{if(C=a.mipmaps,M&&T){C.length>0&&A++;const t=H(m[0]);n.texStorage2D(e.TEXTURE_CUBE_MAP,A,S,t.width,t.height)}for(let t=0;t<6;t++)if(p){M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,m[t].width,m[t].height,_,w,m[t].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,S,m[t].width,m[t].height,0,_,w,m[t].data);for(let i=0;i<C.length;i++){const s=C[i].image[t].image;M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,s.width,s.height,_,w,s.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,S,s.width,s.height,0,_,w,s.data)}}else{M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,_,w,m[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,S,_,w,m[t]);for(let i=0;i<C.length;i++){const s=C[i];M?E&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,_,w,s.image[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,S,_,w,s.image[t])}}}g(a)&&v(e.TEXTURE_CUBE_MAP),h.__version=c.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}(o,t,a):n.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture,e.TEXTURE0+a)},this.rebindTextures=function(t,n,s){const r=i.get(t);void 0!==n&&D(r.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==s&&O(t)},this.setupRenderTarget=function(t){const s=t.texture,o=i.get(t),l=i.get(s);t.addEventListener("dispose",S);const c=t.textures,h=!0===t.isWebGLCubeRenderTarget,u=c.length>1;if(u||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=s.version,a.memory.textures++),h){o.__webglFramebuffer=[];for(let t=0;t<6;t++)if(s.mipmaps&&s.mipmaps.length>0){o.__webglFramebuffer[t]=[];for(let n=0;n<s.mipmaps.length;n++)o.__webglFramebuffer[t][n]=e.createFramebuffer()}else o.__webglFramebuffer[t]=e.createFramebuffer()}else{if(s.mipmaps&&s.mipmaps.length>0){o.__webglFramebuffer=[];for(let t=0;t<s.mipmaps.length;t++)o.__webglFramebuffer[t]=e.createFramebuffer()}else o.__webglFramebuffer=e.createFramebuffer();if(u)for(let t=0,n=c.length;t<n;t++){const n=i.get(c[t]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),a.memory.textures++)}if(t.samples>0&&!1===z(t)){o.__webglMultisampledFramebuffer=e.createFramebuffer(),o.__webglColorRenderbuffer=[],n.bindFramebuffer(e.FRAMEBUFFER,o.__webglMultisampledFramebuffer);for(let n=0;n<c.length;n++){const i=c[n];o.__webglColorRenderbuffer[n]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,o.__webglColorRenderbuffer[n]);const s=r.convert(i.format,i.colorSpace),a=r.convert(i.type),l=y(i.internalFormat,s,a,i.colorSpace,!0===t.isXRRenderTarget),h=B(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,h,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.RENDERBUFFER,o.__webglColorRenderbuffer[n])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(o.__webglDepthRenderbuffer=e.createRenderbuffer(),k(o.__webglDepthRenderbuffer,t,!0)),n.bindFramebuffer(e.FRAMEBUFFER,null)}}if(h){n.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),R(e.TEXTURE_CUBE_MAP,s);for(let n=0;n<6;n++)if(s.mipmaps&&s.mipmaps.length>0)for(let i=0;i<s.mipmaps.length;i++)D(o.__webglFramebuffer[n][i],t,s,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,i);else D(o.__webglFramebuffer[n],t,s,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0);g(s)&&v(e.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(u){for(let s=0,r=c.length;s<r;s++){const r=c[s],a=i.get(r);n.bindTexture(e.TEXTURE_2D,a.__webglTexture),R(e.TEXTURE_2D,r),D(o.__webglFramebuffer,t,r,e.COLOR_ATTACHMENT0+s,e.TEXTURE_2D,0),g(r)&&v(e.TEXTURE_2D)}n.unbindTexture()}else{let i=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(i=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),n.bindTexture(i,l.__webglTexture),R(i,s),s.mipmaps&&s.mipmaps.length>0)for(let n=0;n<s.mipmaps.length;n++)D(o.__webglFramebuffer[n],t,s,e.COLOR_ATTACHMENT0,i,n);else D(o.__webglFramebuffer,t,s,e.COLOR_ATTACHMENT0,i,0);g(s)&&v(i),n.unbindTexture()}t.depthBuffer&&O(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let s=0,r=t.length;s<r;s++){const r=t[s];if(g(r)){const t=x(e),s=i.get(r).__webglTexture;n.bindTexture(t,s),v(t),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===z(t)){const s=t.textures,r=t.width,a=t.height;let o=e.COLOR_BUFFER_BIT;const c=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,h=i.get(t),u=s.length>1;if(u)for(let t=0;t<s.length;t++)n.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),n.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);n.bindFramebuffer(e.READ_FRAMEBUFFER,h.__webglMultisampledFramebuffer);const d=t.texture.mipmaps;d&&d.length>0?n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer[0]):n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer);for(let n=0;n<s.length;n++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),u){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,h.__webglColorRenderbuffer[n]);const t=i.get(s[n]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,r,a,0,0,r,a,o,e.NEAREST),!0===l&&(U.length=0,F.length=0,U.push(e.COLOR_ATTACHMENT0+n),t.depthBuffer&&!1===t.resolveDepthBuffer&&(U.push(c),F.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,F)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,U))}if(n.bindFramebuffer(e.READ_FRAMEBUFFER,null),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),u)for(let t=0;t<s.length;t++){n.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,h.__webglColorRenderbuffer[t]);const r=i.get(s[t]).__webglTexture;n.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,r,0)}n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[n])}},this.setupDepthRenderbuffer=O,this.setupFrameBufferTexture=D,this.useMultisampledRTT=z}function Zf(e,t){return{convert:function(n,i=""){let s;const r=ph.getTransfer(i);if(n===jl)return e.UNSIGNED_BYTE;if(n===Fl)return e.UNSIGNED_SHORT_4_4_4_4;if(n===Bl)return e.UNSIGNED_SHORT_5_5_5_1;if(35902===n)return e.UNSIGNED_INT_5_9_9_9_REV;if(1010===n)return e.BYTE;if(1011===n)return e.SHORT;if(n===Dl)return e.UNSIGNED_SHORT;if(n===kl)return e.INT;if(n===Ll)return e.UNSIGNED_INT;if(n===Ol)return e.FLOAT;if(n===Ul)return e.HALF_FLOAT;if(1021===n)return e.ALPHA;if(1022===n)return e.RGB;if(n===Vl)return e.RGBA;if(n===Hl)return e.DEPTH_COMPONENT;if(n===Wl)return e.DEPTH_STENCIL;if(1028===n)return e.RED;if(n===Gl)return e.RED_INTEGER;if(1030===n)return e.RG;if(n===ql)return e.RG_INTEGER;if(n===Xl)return e.RGBA_INTEGER;if(n===Yl||n===$l||n===Zl||n===Kl)if(r===Nc){if(s=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===s)return null;if(n===Yl)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===$l)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===Zl)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===Kl)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(s=t.get("WEBGL_compressed_texture_s3tc"),null===s)return null;if(n===Yl)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===$l)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===Zl)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===Kl)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(n===Jl||n===Ql||n===ec||n===tc){if(s=t.get("WEBGL_compressed_texture_pvrtc"),null===s)return null;if(n===Jl)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===Ql)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===ec)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===tc)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(n===nc||n===ic||n===sc){if(s=t.get("WEBGL_compressed_texture_etc"),null===s)return null;if(n===nc||n===ic)return r===Nc?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(n===sc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC}if(n===rc||n===ac||n===oc||n===lc||n===cc||n===hc||n===uc||n===dc||n===pc||n===mc||n===fc||n===gc||n===vc||n===xc){if(s=t.get("WEBGL_compressed_texture_astc"),null===s)return null;if(n===rc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===ac)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===oc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===lc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===cc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===hc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===uc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===dc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===pc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===mc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===fc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===gc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===vc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===xc)return r===Nc?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===yc||n===_c||n===bc){if(s=t.get("EXT_texture_compression_bptc"),null===s)return null;if(n===yc)return r===Nc?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(n===_c)return s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(n===bc)return s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===n||n===wc||n===Sc||n===Mc){if(s=t.get("EXT_texture_compression_rgtc"),null===s)return null;if(n===yc)return s.COMPRESSED_RED_RGTC1_EXT;if(n===wc)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(n===Sc)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(n===Mc)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return n===zl?e.UNSIGNED_INT_24_8:void 0!==e[n]?e[n]:null}}}class Kf{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,n){if(null===this.texture){const i=new Sh;e.properties.get(i).__webglTexture=t.texture,t.depthNear===n.depthNear&&t.depthFar===n.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=i}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,n=new Id({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new Td(new rp(20,20),n)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class Jf extends Vc{constructor(e,t){super();const n=this;let i=null,s=1,r=null,a="local-floor",o=1,l=null,c=null,h=null,u=null,d=null,p=null;const m=new Kf,f=t.getContextAttributes();let g=null,v=null;const x=[],y=[],_=new Jc;let b=null;const w=new Od;w.viewport=new Mh;const S=new Od;S.viewport=new Mh;const M=[w,S],T=new yp;let E=null,C=null;function A(e){const t=y.indexOf(e.inputSource);if(-1===t)return;const n=x[t];void 0!==n&&(n.update(e.inputSource,e.frame,l||r),n.dispatchEvent({type:e.type,data:e.inputSource}))}function N(){i.removeEventListener("select",A),i.removeEventListener("selectstart",A),i.removeEventListener("selectend",A),i.removeEventListener("squeeze",A),i.removeEventListener("squeezestart",A),i.removeEventListener("squeezeend",A),i.removeEventListener("end",N),i.removeEventListener("inputsourceschange",R);for(let e=0;e<x.length;e++){const t=y[e];null!==t&&(y[e]=null,x[e].disconnect(t))}E=null,C=null,m.reset(),e.setRenderTarget(g),d=null,u=null,h=null,i=null,v=null,k.stop(),n.isPresenting=!1,e.setPixelRatio(b),e.setSize(_.width,_.height,!1),n.dispatchEvent({type:"sessionend"})}function R(e){for(let t=0;t<e.removed.length;t++){const n=e.removed[t],i=y.indexOf(n);i>=0&&(y[i]=null,x[i].disconnect(n))}for(let t=0;t<e.added.length;t++){const n=e.added[t];let i=y.indexOf(n);if(-1===i){for(let e=0;e<x.length;e++){if(e>=y.length){y.push(n),i=e;break}if(null===y[e]){y[e]=n,i=e;break}}if(-1===i)break}const s=x[i];s&&s.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=x[e];return void 0===t&&(t=new Wd,x[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=x[e];return void 0===t&&(t=new Wd,x[e]=t),t.getGripSpace()},this.getHand=function(e){let t=x[e];return void 0===t&&(t=new Wd,x[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){s=e,n.isPresenting},this.setReferenceSpaceType=function(e){a=e,n.isPresenting},this.getReferenceSpace=function(){return l||r},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==u?u:d},this.getBinding=function(){return h},this.getFrame=function(){return p},this.getSession=function(){return i},this.setSession=async function(c){if(i=c,null!==i){if(g=e.getRenderTarget(),i.addEventListener("select",A),i.addEventListener("selectstart",A),i.addEventListener("selectend",A),i.addEventListener("squeeze",A),i.addEventListener("squeezestart",A),i.addEventListener("squeezeend",A),i.addEventListener("end",N),i.addEventListener("inputsourceschange",R),!0!==f.xrCompatible&&await t.makeXRCompatible(),b=e.getPixelRatio(),e.getSize(_),"undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype){let n=null,r=null,a=null;f.depth&&(a=f.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,n=f.stencil?Wl:Hl,r=f.stencil?zl:Ll);const o={colorFormat:t.RGBA8,depthFormat:a,scaleFactor:s};h=new XRWebGLBinding(i,t),u=h.createProjectionLayer(o),i.updateRenderState({layers:[u]}),e.setPixelRatio(1),e.setSize(u.textureWidth,u.textureHeight,!1),v=new Eh(u.textureWidth,u.textureHeight,{format:Vl,type:jl,depthTexture:new ep(u.textureWidth,u.textureHeight,r,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:f.stencil,colorSpace:e.outputColorSpace,samples:f.antialias?4:0,resolveDepthBuffer:!1===u.ignoreDepthValues,resolveStencilBuffer:!1===u.ignoreDepthValues})}else{const n={antialias:f.antialias,alpha:!0,depth:f.depth,stencil:f.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(i,t,n),i.updateRenderState({baseLayer:d}),e.setPixelRatio(1),e.setSize(d.framebufferWidth,d.framebufferHeight,!1),v=new Eh(d.framebufferWidth,d.framebufferHeight,{format:Vl,type:jl,colorSpace:e.outputColorSpace,stencilBuffer:f.stencil,resolveDepthBuffer:!1===d.ignoreDepthValues,resolveStencilBuffer:!1===d.ignoreDepthValues})}v.isXRRenderTarget=!0,this.setFoveation(o),l=null,r=await i.requestReferenceSpace(a),k.setContext(i),k.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==i)return i.environmentBlendMode},this.getDepthTexture=function(){return m.getDepthTexture()};const P=new eh,I=new eh;function j(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===i)return;let t=e.near,n=e.far;null!==m.texture&&(m.depthNear>0&&(t=m.depthNear),m.depthFar>0&&(n=m.depthFar)),T.near=S.near=w.near=t,T.far=S.far=w.far=n,E===T.near&&C===T.far||(i.updateRenderState({depthNear:T.near,depthFar:T.far}),E=T.near,C=T.far),w.layers.mask=2|e.layers.mask,S.layers.mask=4|e.layers.mask,T.layers.mask=w.layers.mask|S.layers.mask;const s=e.parent,r=T.cameras;j(T,s);for(let i=0;i<r.length;i++)j(r[i],s);2===r.length?function(e,t,n){P.setFromMatrixPosition(t.matrixWorld),I.setFromMatrixPosition(n.matrixWorld);const i=P.distanceTo(I),s=t.projectionMatrix.elements,r=n.projectionMatrix.elements,a=s[14]/(s[10]-1),o=s[14]/(s[10]+1),l=(s[9]+1)/s[5],c=(s[9]-1)/s[5],h=(s[8]-1)/s[0],u=(r[8]+1)/r[0],d=a*h,p=a*u,m=i/(-h+u),f=m*-h;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===s[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=a+m,n=o+m,s=d-f,r=p+(i-f),h=l*o/n*t,u=c*o/n*t;e.projectionMatrix.makePerspective(s,r,h,u,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(T,w,S):T.projectionMatrix.copy(w.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld)),e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*Gc*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,T,s)},this.getCamera=function(){return T},this.getFoveation=function(){if(null!==u||null!==d)return o},this.setFoveation=function(e){o=e,null!==u&&(u.fixedFoveation=e),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==m.texture},this.getDepthSensingMesh=function(){return m.getMesh(T)};let D=null;const k=new Sp;k.setAnimationLoop(function(t,s){if(c=s.getViewerPose(l||r),p=s,null!==c){const t=c.views;null!==d&&(e.setRenderTargetFramebuffer(v,d.framebuffer),e.setRenderTarget(v));let n=!1;t.length!==T.cameras.length&&(T.cameras.length=0,n=!0);for(let i=0;i<t.length;i++){const s=t[i];let r=null;if(null!==d)r=d.getViewport(s);else{const t=h.getViewSubImage(u,s);r=t.viewport,0===i&&(e.setRenderTargetTextures(v,t.colorTexture,t.depthStencilTexture),e.setRenderTarget(v))}let a=M[i];void 0===a&&(a=new Od,a.layers.enable(i),a.viewport=new Mh,M[i]=a),a.matrix.fromArray(s.transform.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale),a.projectionMatrix.fromArray(s.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix).invert(),a.viewport.set(r.x,r.y,r.width,r.height),0===i&&(T.matrix.copy(a.matrix),T.matrix.decompose(T.position,T.quaternion,T.scale)),!0===n&&T.cameras.push(a)}const s=i.enabledFeatures;if(s&&s.includes("depth-sensing")&&"gpu-optimized"==i.depthUsage&&h){const n=h.getDepthInformation(t[0]);n&&n.isValid&&n.texture&&m.init(e,n,i.renderState)}}for(let e=0;e<x.length;e++){const t=y[e],n=x[e];null!==t&&void 0!==n&&n.update(t,s,l||r)}D&&D(t,s),s.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:s}),p=null}),this.setAnimationLoop=function(e){D=e},this.dispose=function(){}}}const Qf=new du,eg=new nu;function tg(e,t){function n(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function i(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map,n(i.map,e.mapTransform)),i.alphaMap&&(e.alphaMap.value=i.alphaMap,n(i.alphaMap,e.alphaMapTransform)),i.bumpMap&&(e.bumpMap.value=i.bumpMap,n(i.bumpMap,e.bumpMapTransform),e.bumpScale.value=i.bumpScale,1===i.side&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,n(i.normalMap,e.normalMapTransform),e.normalScale.value.copy(i.normalScale),1===i.side&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,n(i.displacementMap,e.displacementMapTransform),e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap,n(i.emissiveMap,e.emissiveMapTransform)),i.specularMap&&(e.specularMap.value=i.specularMap,n(i.specularMap,e.specularMapTransform)),i.alphaTest>0&&(e.alphaTest.value=i.alphaTest);const s=t.get(i),r=s.envMap,a=s.envMapRotation;r&&(e.envMap.value=r,Qf.copy(a),Qf.x*=-1,Qf.y*=-1,Qf.z*=-1,r.isCubeTexture&&!1===r.isRenderTargetTexture&&(Qf.y*=-1,Qf.z*=-1),e.envMapRotation.value.setFromMatrix4(eg.makeRotationFromEuler(Qf)),e.flipEnvMap.value=r.isCubeTexture&&!1===r.isRenderTargetTexture?-1:1,e.reflectivity.value=i.reflectivity,e.ior.value=i.ior,e.refractionRatio.value=i.refractionRatio),i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity,n(i.lightMap,e.lightMapTransform)),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity,n(i.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,n){n.color.getRGB(t.fogColor.value,Rd(e)),n.isFog?(t.fogNear.value=n.near,t.fogFar.value=n.far):n.isFogExp2&&(t.fogDensity.value=n.density)},refreshMaterialUniforms:function(e,s,r,a,o){s.isMeshBasicMaterial||s.isMeshLambertMaterial?i(e,s):s.isMeshToonMaterial?(i(e,s),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,s)):s.isMeshPhongMaterial?(i(e,s),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,s)):s.isMeshStandardMaterial?(i(e,s),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,n(t.metalnessMap,e.metalnessMapTransform)),e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,n(t.roughnessMap,e.roughnessMapTransform)),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,s),s.isMeshPhysicalMaterial&&function(e,t,i){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,n(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,n(t.sheenRoughnessMap,e.sheenRoughnessMapTransform))),t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,n(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,n(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,n(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate())),t.dispersion>0&&(e.dispersion.value=t.dispersion),t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,n(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,n(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform))),t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=i.texture,e.transmissionSamplerSize.value.set(i.width,i.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,n(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,n(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor)),t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,n(t.anisotropyMap,e.anisotropyMapTransform))),e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,n(t.specularColorMap,e.specularColorMapTransform)),t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,n(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,s,o)):s.isMeshMatcapMaterial?(i(e,s),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,s)):s.isMeshDepthMaterial?i(e,s):s.isMeshDistanceMaterial?(i(e,s),function(e,n){const i=t.get(n).light;e.referencePosition.value.setFromMatrixPosition(i.matrixWorld),e.nearDistance.value=i.shadow.camera.near,e.farDistance.value=i.shadow.camera.far}(e,s)):s.isMeshNormalMaterial?i(e,s):s.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform))}(e,s),s.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,s)):s.isPointsMaterial?function(e,t,i,s){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*s,t.map&&(e.map.value=t.map,n(t.map,e.uvTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform)),t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,s,r,a):s.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform)),t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,s):s.isShadowMaterial?(e.color.value.copy(s.color),e.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function ng(e,t,n,i){let s={},r={},a=[];const o=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,n,i){const s=e.value,r=t+"_"+n;if(void 0===i[r])return i[r]="number"==typeof s||"boolean"==typeof s?s:s.clone(),!0;{const e=i[r];if("number"==typeof s||"boolean"==typeof s){if(e!==s)return i[r]=s,!0}else if(!1===e.equals(s))return e.copy(s),!0}return!1}function c(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture,t}function h(t){const n=t.target;n.removeEventListener("dispose",h);const i=a.indexOf(n.__bindingPointIndex);a.splice(i,1),e.deleteBuffer(s[n.id]),delete s[n.id],delete r[n.id]}return{bind:function(e,t){const n=t.program;i.uniformBlockBinding(e,n)},update:function(n,u){let d=s[n.id];void 0===d&&(function(e){const t=e.uniforms;let n=0;for(let s=0,r=t.length;s<r;s++){const e=Array.isArray(t[s])?t[s]:[t[s]];for(let t=0,i=e.length;t<i;t++){const i=e[t],s=Array.isArray(i.value)?i.value:[i.value];for(let e=0,t=s.length;e<t;e++){const t=c(s[e]),r=n%16,a=r%t.boundary,o=r+a;n+=a,0!==o&&16-o<t.storage&&(n+=16-o),i.__data=new Float32Array(t.storage/Float32Array.BYTES_PER_ELEMENT),i.__offset=n,n+=t.storage}}}const i=n%16;i>0&&(n+=16-i),e.__size=n,e.__cache={}}(n),d=function(t){const n=function(){for(let e=0;e<o;e++)if(-1===a.indexOf(e))return a.push(e),e;return 0}();t.__bindingPointIndex=n;const i=e.createBuffer(),s=t.__size,r=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,i),e.bufferData(e.UNIFORM_BUFFER,s,r),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,i),i}(n),s[n.id]=d,n.addEventListener("dispose",h));const p=u.program;i.updateUBOMapping(n,p);const m=t.render.frame;r[n.id]!==m&&(function(t){const n=s[t.id],i=t.uniforms,r=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let s=0,a=i.length;s<a;s++){const t=Array.isArray(i[s])?i[s]:[i[s]];for(let n=0,i=t.length;n<i;n++){const i=t[n];if(!0===l(i,s,n,r)){const t=i.__offset,n=Array.isArray(i.value)?i.value:[i.value];let s=0;for(let r=0;r<n.length;r++){const a=n[r],o=c(a);"number"==typeof a||"boolean"==typeof a?(i.__data[0]=a,e.bufferSubData(e.UNIFORM_BUFFER,t+s,i.__data)):a.isMatrix3?(i.__data[0]=a.elements[0],i.__data[1]=a.elements[1],i.__data[2]=a.elements[2],i.__data[3]=0,i.__data[4]=a.elements[3],i.__data[5]=a.elements[4],i.__data[6]=a.elements[5],i.__data[7]=0,i.__data[8]=a.elements[6],i.__data[9]=a.elements[7],i.__data[10]=a.elements[8],i.__data[11]=0):(a.toArray(i.__data,s),s+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,i.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),r[n.id]=m)},dispose:function(){for(const t in s)e.deleteBuffer(s[t]);a=[],s={},r={}}}}class ig{constructor(e={}){const{canvas:t=oh(),context:n=null,depth:i=!0,stencil:s=!1,alpha:r=!1,antialias:a=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:l=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:h=!1,reverseDepthBuffer:u=!1}=e;let d;if(this.isWebGLRenderer=!0,null!==n){if("undefined"!=typeof WebGLRenderingContext&&n instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");d=n.getContextAttributes().alpha}else d=r;const p=new Uint32Array(4),m=new Int32Array(4);let f=null,g=null;const v=[],x=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=0,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const y=this;let _=!1;this._outputColorSpace=Ec;let b=0,w=0,S=null,M=-1,T=null;const E=new Mh,C=new Mh;let A=null;const N=new Yu(0);let R=0,P=t.width,I=t.height,j=1,D=null,k=null;const L=new Mh(0,0,P,I),O=new Mh(0,0,P,I);let U=!1;const F=new Qd;let B=!1,z=!1;const V=new nu,H=new nu,W=new eh,G=new Mh,q={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let X=!1;function Y(){return null===S?j:1}let $,Z,K,J,Q,ee,te,ne,ie,se,re,ae,oe,le,ce,he,ue,de,pe,me,fe,ge,ve,xe,ye=n;function _e(e,n){return t.getContext(e,n)}try{const e={alpha:!0,depth:i,stencil:s,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:h};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${Go}`),t.addEventListener("webglcontextlost",Se,!1),t.addEventListener("webglcontextrestored",Me,!1),t.addEventListener("webglcontextcreationerror",Te,!1),null===ye){const t="webgl2";if(ye=_e(t,e),null===ye)throw _e(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(He){throw He}function be(){$=new em(ye),$.init(),ge=new Zf(ye,$),Z=new Dp(ye,$,e,ge),K=new Yf(ye,$),Z.reverseDepthBuffer&&u&&K.buffers.depth.setReversed(!0),J=new im(ye),Q=new kf,ee=new $f(ye,$,K,Q,Z,ge,J),te=new Lp(y),ne=new Qp(y),ie=new Mp(ye),ve=new Ip(ye,ie),se=new tm(ye,ie,J,ve),re=new rm(ye,se,ie,J),pe=new sm(ye,Z,ee),he=new kp(Q),ae=new Df(y,te,ne,$,Z,ve,he),oe=new tg(y,Q),le=new Ff,ce=new Gf($),de=new Pp(y,te,ne,K,re,d,o),ue=new qf(y,re,Z),xe=new ng(ye,J,Z,K),me=new jp(ye,$,J),fe=new nm(ye,$,J),J.programs=ae.programs,y.capabilities=Z,y.extensions=$,y.properties=Q,y.renderLists=le,y.shadowMap=ue,y.state=K,y.info=J}be();const we=new Jf(y,ye);function Se(e){e.preventDefault(),_=!0}function Me(){_=!1;const e=J.autoReset,t=ue.enabled,n=ue.autoUpdate,i=ue.needsUpdate,s=ue.type;be(),J.autoReset=e,ue.enabled=t,ue.autoUpdate=n,ue.needsUpdate=i,ue.type=s}function Te(e){}function Ee(e){const t=e.target;t.removeEventListener("dispose",Ee),function(e){(function(e){const t=Q.get(e).programs;void 0!==t&&(t.forEach(function(e){ae.releaseProgram(e)}),e.isShaderMaterial&&ae.releaseShaderCache(e))})(e),Q.remove(e)}(t)}function Ce(e,t,n){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Oe(e,t,n),e.side=0,e.needsUpdate=!0,Oe(e,t,n),e.side=2):Oe(e,t,n)}this.xr=we,this.getContext=function(){return ye},this.getContextAttributes=function(){return ye.getContextAttributes()},this.forceContextLoss=function(){const e=$.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=$.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return j},this.setPixelRatio=function(e){void 0!==e&&(j=e,this.setSize(P,I,!1))},this.getSize=function(e){return e.set(P,I)},this.setSize=function(e,n,i=!0){we.isPresenting||(P=e,I=n,t.width=Math.floor(e*j),t.height=Math.floor(n*j),!0===i&&(t.style.width=e+"px",t.style.height=n+"px"),this.setViewport(0,0,e,n))},this.getDrawingBufferSize=function(e){return e.set(P*j,I*j).floor()},this.setDrawingBufferSize=function(e,n,i){P=e,I=n,j=i,t.width=Math.floor(e*i),t.height=Math.floor(n*i),this.setViewport(0,0,e,n)},this.getCurrentViewport=function(e){return e.copy(E)},this.getViewport=function(e){return e.copy(L)},this.setViewport=function(e,t,n,i){e.isVector4?L.set(e.x,e.y,e.z,e.w):L.set(e,t,n,i),K.viewport(E.copy(L).multiplyScalar(j).round())},this.getScissor=function(e){return e.copy(O)},this.setScissor=function(e,t,n,i){e.isVector4?O.set(e.x,e.y,e.z,e.w):O.set(e,t,n,i),K.scissor(C.copy(O).multiplyScalar(j).round())},this.getScissorTest=function(){return U},this.setScissorTest=function(e){K.setScissorTest(U=e)},this.setOpaqueSort=function(e){D=e},this.setTransparentSort=function(e){k=e},this.getClearColor=function(e){return e.copy(de.getClearColor())},this.setClearColor=function(){de.setClearColor(...arguments)},this.getClearAlpha=function(){return de.getClearAlpha()},this.setClearAlpha=function(){de.setClearAlpha(...arguments)},this.clear=function(e=!0,t=!0,n=!0){let i=0;if(e){let e=!1;if(null!==S){const t=S.texture.format;e=t===Xl||t===ql||t===Gl}if(e){const e=S.texture.type,t=e===jl||e===Ll||e===Dl||e===zl||e===Fl||e===Bl,n=de.getClearColor(),i=de.getClearAlpha(),s=n.r,r=n.g,a=n.b;t?(p[0]=s,p[1]=r,p[2]=a,p[3]=i,ye.clearBufferuiv(ye.COLOR,0,p)):(m[0]=s,m[1]=r,m[2]=a,m[3]=i,ye.clearBufferiv(ye.COLOR,0,m))}else i|=ye.COLOR_BUFFER_BIT}t&&(i|=ye.DEPTH_BUFFER_BIT),n&&(i|=ye.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),ye.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Se,!1),t.removeEventListener("webglcontextrestored",Me,!1),t.removeEventListener("webglcontextcreationerror",Te,!1),de.dispose(),le.dispose(),ce.dispose(),Q.dispose(),te.dispose(),ne.dispose(),re.dispose(),ve.dispose(),xe.dispose(),ae.dispose(),we.dispose(),we.removeEventListener("sessionstart",Ne),we.removeEventListener("sessionend",Re),Pe.stop()},this.renderBufferDirect=function(e,t,n,i,s,r){null===t&&(t=q);const a=s.isMesh&&s.matrixWorld.determinant()<0,o=function(e,t,n,i,s){!0!==t.isScene&&(t=q),ee.resetTextureUnits();const r=t.fog,a=i.isMeshStandardMaterial?t.environment:null,o=null===S?y.outputColorSpace:!0===S.isXRRenderTarget?S.texture.colorSpace:Cc,l=(i.isMeshStandardMaterial?ne:te).get(i.envMap||a),c=!0===i.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,h=!!n.attributes.tangent&&(!!i.normalMap||i.anisotropy>0),u=!!n.morphAttributes.position,d=!!n.morphAttributes.normal,p=!!n.morphAttributes.color;let m=0;i.toneMapped&&(null!==S&&!0!==S.isXRRenderTarget||(m=y.toneMapping));const f=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,v=void 0!==f?f.length:0,x=Q.get(i),_=g.state.lights;if(!0===B&&(!0===z||e!==T)){const t=e===T&&i.id===M;he.setState(i,e,t)}let b=!1;i.version===x.__version?x.needsLights&&x.lightsStateVersion!==_.state.version||x.outputColorSpace!==o||s.isBatchedMesh&&!1===x.batching?b=!0:s.isBatchedMesh||!0!==x.batching?s.isBatchedMesh&&!0===x.batchingColor&&null===s.colorTexture||s.isBatchedMesh&&!1===x.batchingColor&&null!==s.colorTexture||s.isInstancedMesh&&!1===x.instancing?b=!0:s.isInstancedMesh||!0!==x.instancing?s.isSkinnedMesh&&!1===x.skinning?b=!0:s.isSkinnedMesh||!0!==x.skinning?s.isInstancedMesh&&!0===x.instancingColor&&null===s.instanceColor||s.isInstancedMesh&&!1===x.instancingColor&&null!==s.instanceColor||s.isInstancedMesh&&!0===x.instancingMorph&&null===s.morphTexture||s.isInstancedMesh&&!1===x.instancingMorph&&null!==s.morphTexture||x.envMap!==l||!0===i.fog&&x.fog!==r?b=!0:void 0===x.numClippingPlanes||x.numClippingPlanes===he.numPlanes&&x.numIntersection===he.numIntersection?(x.vertexAlphas!==c||x.vertexTangents!==h||x.morphTargets!==u||x.morphNormals!==d||x.morphColors!==p||x.toneMapping!==m||x.morphTargetsCount!==v)&&(b=!0):b=!0:b=!0:b=!0:b=!0:(b=!0,x.__version=i.version);let w=x.currentProgram;!0===b&&(w=Oe(i,t,s));let E=!1,C=!1,A=!1;const N=w.getUniforms(),R=x.uniforms;if(K.useProgram(w.program)&&(E=!0,C=!0,A=!0),i.id!==M&&(M=i.id,C=!0),E||T!==e){K.buffers.depth.getReversed()?(V.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}(V),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}(V),N.setValue(ye,"projectionMatrix",V)):N.setValue(ye,"projectionMatrix",e.projectionMatrix),N.setValue(ye,"viewMatrix",e.matrixWorldInverse);const t=N.map.cameraPosition;void 0!==t&&t.setValue(ye,W.setFromMatrixPosition(e.matrixWorld)),Z.logarithmicDepthBuffer&&N.setValue(ye,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&N.setValue(ye,"isOrthographic",!0===e.isOrthographicCamera),T!==e&&(T=e,C=!0,A=!0)}if(s.isSkinnedMesh){N.setOptional(ye,s,"bindMatrix"),N.setOptional(ye,s,"bindMatrixInverse");const e=s.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),N.setValue(ye,"boneTexture",e.boneTexture,ee))}s.isBatchedMesh&&(N.setOptional(ye,s,"batchingTexture"),N.setValue(ye,"batchingTexture",s._matricesTexture,ee),N.setOptional(ye,s,"batchingIdTexture"),N.setValue(ye,"batchingIdTexture",s._indirectTexture,ee),N.setOptional(ye,s,"batchingColorTexture"),null!==s._colorsTexture&&N.setValue(ye,"batchingColorTexture",s._colorsTexture,ee));const P=n.morphAttributes;var D,k;if(void 0===P.position&&void 0===P.normal&&void 0===P.color||pe.update(s,n,w),(C||x.receiveShadow!==s.receiveShadow)&&(x.receiveShadow=s.receiveShadow,N.setValue(ye,"receiveShadow",s.receiveShadow)),i.isMeshGouraudMaterial&&null!==i.envMap&&(R.envMap.value=l,R.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1),i.isMeshStandardMaterial&&null===i.envMap&&null!==t.environment&&(R.envMapIntensity.value=t.environmentIntensity),C&&(N.setValue(ye,"toneMappingExposure",y.toneMappingExposure),x.needsLights&&(k=A,(D=R).ambientLightColor.needsUpdate=k,D.lightProbe.needsUpdate=k,D.directionalLights.needsUpdate=k,D.directionalLightShadows.needsUpdate=k,D.pointLights.needsUpdate=k,D.pointLightShadows.needsUpdate=k,D.spotLights.needsUpdate=k,D.spotLightShadows.needsUpdate=k,D.rectAreaLights.needsUpdate=k,D.hemisphereLights.needsUpdate=k),r&&!0===i.fog&&oe.refreshFogUniforms(R,r),oe.refreshMaterialUniforms(R,i,j,I,g.state.transmissionRenderTarget[e.id]),uf.upload(ye,Ue(x),R,ee)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(uf.upload(ye,Ue(x),R,ee),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&N.setValue(ye,"center",s.center),N.setValue(ye,"modelViewMatrix",s.modelViewMatrix),N.setValue(ye,"normalMatrix",s.normalMatrix),N.setValue(ye,"modelMatrix",s.matrixWorld),i.isShaderMaterial||i.isRawShaderMaterial){const e=i.uniformsGroups;for(let t=0,n=e.length;t<n;t++){const n=e[t];xe.update(n,w),xe.bind(n,w)}}return w}(e,t,n,i,s);K.setMaterial(i,a);let l=n.index,c=1;if(!0===i.wireframe){if(l=se.getWireframeAttribute(n),void 0===l)return;c=2}const h=n.drawRange,u=n.attributes.position;let d=h.start*c,p=(h.start+h.count)*c;null!==r&&(d=Math.max(d,r.start*c),p=Math.min(p,(r.start+r.count)*c)),null!==l?(d=Math.max(d,0),p=Math.min(p,l.count)):null!=u&&(d=Math.max(d,0),p=Math.min(p,u.count));const m=p-d;if(m<0||m===1/0)return;let f;ve.setup(s,i,o,n,l);let v=me;if(null!==l&&(f=ie.get(l),v=fe,v.setIndex(f)),s.isMesh)!0===i.wireframe?(K.setLineWidth(i.wireframeLinewidth*Y()),v.setMode(ye.LINES)):v.setMode(ye.TRIANGLES);else if(s.isLine){let e=i.linewidth;void 0===e&&(e=1),K.setLineWidth(e*Y()),s.isLineSegments?v.setMode(ye.LINES):s.isLineLoop?v.setMode(ye.LINE_LOOP):v.setMode(ye.LINE_STRIP)}else s.isPoints?v.setMode(ye.POINTS):s.isSprite&&v.setMode(ye.TRIANGLES);if(s.isBatchedMesh)if(null!==s._multiDrawInstances)ch("THREE.WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),v.renderMultiDrawInstances(s._multiDrawStarts,s._multiDrawCounts,s._multiDrawCount,s._multiDrawInstances);else if($.get("WEBGL_multi_draw"))v.renderMultiDraw(s._multiDrawStarts,s._multiDrawCounts,s._multiDrawCount);else{const e=s._multiDrawStarts,t=s._multiDrawCounts,n=s._multiDrawCount,r=l?ie.get(l).bytesPerElement:1,a=Q.get(i).currentProgram.getUniforms();for(let i=0;i<n;i++)a.setValue(ye,"_gl_DrawID",i),v.render(e[i]/r,t[i])}else if(s.isInstancedMesh)v.renderInstances(d,m,s.count);else if(n.isInstancedBufferGeometry){const e=void 0!==n._maxInstanceCount?n._maxInstanceCount:1/0,t=Math.min(n.instanceCount,e);v.renderInstances(d,m,t)}else v.render(d,m)},this.compile=function(e,t,n=null){null===n&&(n=e),g=ce.get(n),g.init(t),x.push(g),n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))}),e!==n&&e.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(g.pushLight(e),e.castShadow&&g.pushShadow(e))}),g.setupLights();const i=new Set;return e.traverse(function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let s=0;s<t.length;s++){const r=t[s];Ce(r,n,e),i.add(r)}else Ce(t,n,e),i.add(t)}),g=x.pop(),i},this.compileAsync=function(e,t,n=null){const i=this.compile(e,t,n);return new Promise(t=>{function n(){i.forEach(function(e){Q.get(e).currentProgram.isReady()&&i.delete(e)}),0!==i.size?setTimeout(n,10):t(e)}null!==$.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)})};let Ae=null;function Ne(){Pe.stop()}function Re(){Pe.start()}const Pe=new Sp;function Ie(e,t,n,i){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)g.pushLight(e),e.castShadow&&g.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||F.intersectsSprite(e)){i&&G.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);const t=re.update(e),s=e.material;s.visible&&f.push(e,t,s,n,G.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||F.intersectsObject(e))){const t=re.update(e),s=e.material;if(i&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),G.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),G.copy(t.boundingSphere.center)),G.applyMatrix4(e.matrixWorld).applyMatrix4(H)),Array.isArray(s)){const i=t.groups;for(let r=0,a=i.length;r<a;r++){const a=i[r],o=s[a.materialIndex];o&&o.visible&&f.push(e,t,o,n,G.z,a)}}else s.visible&&f.push(e,t,s,n,G.z,null)}const s=e.children;for(let r=0,a=s.length;r<a;r++)Ie(s[r],t,n,i)}function je(e,t,n,i){const s=e.opaque,r=e.transmissive,a=e.transparent;g.setupLightsView(n),!0===B&&he.setGlobalState(y.clippingPlanes,n),i&&K.viewport(E.copy(i)),s.length>0&&ke(s,t,n),r.length>0&&ke(r,t,n),a.length>0&&ke(a,t,n),K.buffers.depth.setTest(!0),K.buffers.depth.setMask(!0),K.buffers.color.setMask(!0),K.setPolygonOffset(!1)}function De(e,t,n,i){if(null!==(!0===n.isScene?n.overrideMaterial:null))return;void 0===g.state.transmissionRenderTarget[i.id]&&(g.state.transmissionRenderTarget[i.id]=new Eh(1,1,{generateMipmaps:!0,type:$.has("EXT_color_buffer_half_float")||$.has("EXT_color_buffer_float")?Ul:jl,minFilter:Il,samples:4,stencilBuffer:s,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:ph.workingColorSpace}));const r=g.state.transmissionRenderTarget[i.id],a=i.viewport||E;r.setSize(a.z*y.transmissionResolutionScale,a.w*y.transmissionResolutionScale);const o=y.getRenderTarget(),l=y.getActiveCubeFace(),c=y.getActiveMipmapLevel();y.setRenderTarget(r),y.getClearColor(N),R=y.getClearAlpha(),R<1&&y.setClearColor(16777215,.5),y.clear(),X&&de.render(n);const h=y.toneMapping;y.toneMapping=0;const u=i.viewport;if(void 0!==i.viewport&&(i.viewport=void 0),g.setupLightsView(i),!0===B&&he.setGlobalState(y.clippingPlanes,i),ke(e,n,i),ee.updateMultisampleRenderTarget(r),ee.updateRenderTargetMipmap(r),!1===$.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let s=0,r=t.length;s<r;s++){const r=t[s],a=r.object,o=r.geometry,l=r.material,c=r.group;if(2===l.side&&a.layers.test(i.layers)){const t=l.side;l.side=1,l.needsUpdate=!0,Le(a,n,i,o,l,c),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(ee.updateMultisampleRenderTarget(r),ee.updateRenderTargetMipmap(r))}y.setRenderTarget(o,l,c),y.setClearColor(N,R),void 0!==u&&(i.viewport=u),y.toneMapping=h}function ke(e,t,n){const i=!0===t.isScene?t.overrideMaterial:null;for(let s=0,r=e.length;s<r;s++){const r=e[s],a=r.object,o=r.geometry,l=r.group;let c=r.material;!0===c.allowOverride&&null!==i&&(c=i),a.layers.test(n.layers)&&Le(a,t,n,o,c,l)}}function Le(e,t,n,i,s,r){e.onBeforeRender(y,t,n,i,s,r),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),s.onBeforeRender(y,t,n,i,e,r),!0===s.transparent&&2===s.side&&!1===s.forceSinglePass?(s.side=1,s.needsUpdate=!0,y.renderBufferDirect(n,t,i,s,e,r),s.side=0,s.needsUpdate=!0,y.renderBufferDirect(n,t,i,s,e,r),s.side=2):y.renderBufferDirect(n,t,i,s,e,r),e.onAfterRender(y,t,n,i,s,r)}function Oe(e,t,n){!0!==t.isScene&&(t=q);const i=Q.get(e),s=g.state.lights,r=g.state.shadowsArray,a=s.state.version,o=ae.getParameters(e,s.state,r,t,n),l=ae.getProgramCacheKey(o);let c=i.programs;i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.envMap=(e.isMeshStandardMaterial?ne:te).get(e.envMap||i.environment),i.envMapRotation=null!==i.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===c&&(e.addEventListener("dispose",Ee),c=new Map,i.programs=c);let h=c.get(l);if(void 0!==h){if(i.currentProgram===h&&i.lightsStateVersion===a)return Fe(e,o),h}else o.uniforms=ae.getUniforms(e),e.onBeforeCompile(o,y),h=ae.acquireProgram(o,l),c.set(l,h),i.uniforms=o.uniforms;const u=i.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(u.clippingPlanes=he.uniform),Fe(e,o),i.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),i.lightsStateVersion=a,i.needsLights&&(u.ambientLightColor.value=s.state.ambient,u.lightProbe.value=s.state.probe,u.directionalLights.value=s.state.directional,u.directionalLightShadows.value=s.state.directionalShadow,u.spotLights.value=s.state.spot,u.spotLightShadows.value=s.state.spotShadow,u.rectAreaLights.value=s.state.rectArea,u.ltc_1.value=s.state.rectAreaLTC1,u.ltc_2.value=s.state.rectAreaLTC2,u.pointLights.value=s.state.point,u.pointLightShadows.value=s.state.pointShadow,u.hemisphereLights.value=s.state.hemi,u.directionalShadowMap.value=s.state.directionalShadowMap,u.directionalShadowMatrix.value=s.state.directionalShadowMatrix,u.spotShadowMap.value=s.state.spotShadowMap,u.spotLightMatrix.value=s.state.spotLightMatrix,u.spotLightMap.value=s.state.spotLightMap,u.pointShadowMap.value=s.state.pointShadowMap,u.pointShadowMatrix.value=s.state.pointShadowMatrix),i.currentProgram=h,i.uniformsList=null,h}function Ue(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=uf.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function Fe(e,t){const n=Q.get(e);n.outputColorSpace=t.outputColorSpace,n.batching=t.batching,n.batchingColor=t.batchingColor,n.instancing=t.instancing,n.instancingColor=t.instancingColor,n.instancingMorph=t.instancingMorph,n.skinning=t.skinning,n.morphTargets=t.morphTargets,n.morphNormals=t.morphNormals,n.morphColors=t.morphColors,n.morphTargetsCount=t.morphTargetsCount,n.numClippingPlanes=t.numClippingPlanes,n.numIntersection=t.numClipIntersection,n.vertexAlphas=t.vertexAlphas,n.vertexTangents=t.vertexTangents,n.toneMapping=t.toneMapping}Pe.setAnimationLoop(function(e){Ae&&Ae(e)}),"undefined"!=typeof self&&Pe.setContext(self),this.setAnimationLoop=function(e){Ae=e,we.setAnimationLoop(e),null===e?Pe.stop():Pe.start()},we.addEventListener("sessionstart",Ne),we.addEventListener("sessionend",Re),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return;if(!0===_)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===we.enabled&&!0===we.isPresenting&&(!0===we.cameraAutoUpdate&&we.updateCamera(t),t=we.getCamera()),!0===e.isScene&&e.onBeforeRender(y,e,t,S),g=ce.get(e,x.length),g.init(t),x.push(g),H.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),F.setFromProjectionMatrix(H),z=this.localClippingEnabled,B=he.init(this.clippingPlanes,z),f=le.get(e,v.length),f.init(),v.push(f),!0===we.enabled&&!0===we.isPresenting){const e=y.xr.getDepthSensingMesh();null!==e&&Ie(e,t,-1/0,y.sortObjects)}Ie(e,t,0,y.sortObjects),f.finish(),!0===y.sortObjects&&f.sort(D,k),X=!1===we.enabled||!1===we.isPresenting||!1===we.hasDepthSensing(),X&&de.addToRenderList(f,e),this.info.render.frame++,!0===B&&he.beginShadows();const n=g.state.shadowsArray;ue.render(n,e,t),!0===B&&he.endShadows(),!0===this.info.autoReset&&this.info.reset();const i=f.opaque,s=f.transmissive;if(g.setupLights(),t.isArrayCamera){const n=t.cameras;if(s.length>0)for(let t=0,r=n.length;t<r;t++)De(i,s,e,n[t]);X&&de.render(e);for(let t=0,i=n.length;t<i;t++){const i=n[t];je(f,e,i,i.viewport)}}else s.length>0&&De(i,s,e,t),X&&de.render(e),je(f,e,t);null!==S&&0===w&&(ee.updateMultisampleRenderTarget(S),ee.updateRenderTargetMipmap(S)),!0===e.isScene&&e.onAfterRender(y,e,t),ve.resetDefaultState(),M=-1,T=null,x.pop(),x.length>0?(g=x[x.length-1],!0===B&&he.setGlobalState(y.clippingPlanes,g.state.camera)):g=null,v.pop(),f=v.length>0?v[v.length-1]:null},this.getActiveCubeFace=function(){return b},this.getActiveMipmapLevel=function(){return w},this.getRenderTarget=function(){return S},this.setRenderTargetTextures=function(e,t,n){const i=Q.get(e);i.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===i.__autoAllocateDepthBuffer&&(i.__useRenderToTexture=!1),Q.get(e.texture).__webglTexture=t,Q.get(e.depthTexture).__webglTexture=i.__autoAllocateDepthBuffer?void 0:n,i.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,t){const n=Q.get(e);n.__webglFramebuffer=t,n.__useDefaultFramebuffer=void 0===t};const Be=ye.createFramebuffer();this.setRenderTarget=function(e,t=0,n=0){S=e,b=t,w=n;let i=!0,s=null,r=!1,a=!1;if(e){const o=Q.get(e);if(void 0!==o.__useDefaultFramebuffer)K.bindFramebuffer(ye.FRAMEBUFFER,null),i=!1;else if(void 0===o.__webglFramebuffer)ee.setupRenderTarget(e);else if(o.__hasExternalTextures)ee.rebindTextures(e,Q.get(e.texture).__webglTexture,Q.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(o.__boundDepthTexture!==t){if(null!==t&&Q.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");ee.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(a=!0);const c=Q.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(s=Array.isArray(c[t])?c[t][n]:c[t],r=!0):s=e.samples>0&&!1===ee.useMultisampledRTT(e)?Q.get(e).__webglMultisampledFramebuffer:Array.isArray(c)?c[n]:c,E.copy(e.viewport),C.copy(e.scissor),A=e.scissorTest}else E.copy(L).multiplyScalar(j).floor(),C.copy(O).multiplyScalar(j).floor(),A=U;if(0!==n&&(s=Be),K.bindFramebuffer(ye.FRAMEBUFFER,s)&&i&&K.drawBuffers(e,s),K.viewport(E),K.scissor(C),K.setScissorTest(A),r){const i=Q.get(e.texture);ye.framebufferTexture2D(ye.FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.__webglTexture,n)}else if(a){const i=Q.get(e.texture),s=t;ye.framebufferTextureLayer(ye.FRAMEBUFFER,ye.COLOR_ATTACHMENT0,i.__webglTexture,n,s)}else if(null!==e&&0!==n){const t=Q.get(e.texture);ye.framebufferTexture2D(ye.FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_2D,t.__webglTexture,n)}M=-1},this.readRenderTargetPixels=function(e,t,n,i,s,r,a,o=0){if(!e||!e.isWebGLRenderTarget)return;let l=Q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(l=l[a]),l){K.bindFramebuffer(ye.FRAMEBUFFER,l);try{const a=e.textures[o],l=a.format,c=a.type;if(!Z.textureFormatReadable(l))return;if(!Z.textureTypeReadable(c))return;t>=0&&t<=e.width-i&&n>=0&&n<=e.height-s&&(e.textures.length>1&&ye.readBuffer(ye.COLOR_ATTACHMENT0+o),ye.readPixels(t,n,i,s,ge.convert(l),ge.convert(c),r))}finally{const e=null!==S?Q.get(S).__webglFramebuffer:null;K.bindFramebuffer(ye.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,n,i,s,r,a,o=0){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=Q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(l=l[a]),l){if(t>=0&&t<=e.width-i&&n>=0&&n<=e.height-s){K.bindFramebuffer(ye.FRAMEBUFFER,l);const a=e.textures[o],c=a.format,h=a.type;if(!Z.textureFormatReadable(c))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!Z.textureTypeReadable(h))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const u=ye.createBuffer();ye.bindBuffer(ye.PIXEL_PACK_BUFFER,u),ye.bufferData(ye.PIXEL_PACK_BUFFER,r.byteLength,ye.STREAM_READ),e.textures.length>1&&ye.readBuffer(ye.COLOR_ATTACHMENT0+o),ye.readPixels(t,n,i,s,ge.convert(c),ge.convert(h),0);const d=null!==S?Q.get(S).__webglFramebuffer:null;K.bindFramebuffer(ye.FRAMEBUFFER,d);const p=ye.fenceSync(ye.SYNC_GPU_COMMANDS_COMPLETE,0);return ye.flush(),await function(e,t){return new Promise(function(n,i){setTimeout(function s(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:i();break;case e.TIMEOUT_EXPIRED:setTimeout(s,4);break;default:n()}},4)})}(ye,p),ye.bindBuffer(ye.PIXEL_PACK_BUFFER,u),ye.getBufferSubData(ye.PIXEL_PACK_BUFFER,0,r),ye.deleteBuffer(u),ye.deleteSync(p),r}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,n=0){const i=Math.pow(2,-n),s=Math.floor(e.image.width*i),r=Math.floor(e.image.height*i),a=null!==t?t.x:0,o=null!==t?t.y:0;ee.setTexture2D(e,0),ye.copyTexSubImage2D(ye.TEXTURE_2D,n,0,0,a,o,s,r),K.unbindTexture()};const ze=ye.createFramebuffer(),Ve=ye.createFramebuffer();this.copyTextureToTexture=function(e,t,n=null,i=null,s=0,r=null){let a,o,l,c,h,u,d,p,m;null===r&&(0!==s?(ch("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),r=s,s=0):r=0);const f=e.isCompressedTexture?e.mipmaps[r]:e.image;if(null!==n)a=n.max.x-n.min.x,o=n.max.y-n.min.y,l=n.isBox3?n.max.z-n.min.z:1,c=n.min.x,h=n.min.y,u=n.isBox3?n.min.z:0;else{const t=Math.pow(2,-s);a=Math.floor(f.width*t),o=Math.floor(f.height*t),l=e.isDataArrayTexture?f.depth:e.isData3DTexture?Math.floor(f.depth*t):1,c=0,h=0,u=0}null!==i?(d=i.x,p=i.y,m=i.z):(d=0,p=0,m=0);const g=ge.convert(t.format),v=ge.convert(t.type);let x;t.isData3DTexture?(ee.setTexture3D(t,0),x=ye.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(ee.setTexture2DArray(t,0),x=ye.TEXTURE_2D_ARRAY):(ee.setTexture2D(t,0),x=ye.TEXTURE_2D),ye.pixelStorei(ye.UNPACK_FLIP_Y_WEBGL,t.flipY),ye.pixelStorei(ye.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),ye.pixelStorei(ye.UNPACK_ALIGNMENT,t.unpackAlignment);const y=ye.getParameter(ye.UNPACK_ROW_LENGTH),_=ye.getParameter(ye.UNPACK_IMAGE_HEIGHT),b=ye.getParameter(ye.UNPACK_SKIP_PIXELS),w=ye.getParameter(ye.UNPACK_SKIP_ROWS),S=ye.getParameter(ye.UNPACK_SKIP_IMAGES);ye.pixelStorei(ye.UNPACK_ROW_LENGTH,f.width),ye.pixelStorei(ye.UNPACK_IMAGE_HEIGHT,f.height),ye.pixelStorei(ye.UNPACK_SKIP_PIXELS,c),ye.pixelStorei(ye.UNPACK_SKIP_ROWS,h),ye.pixelStorei(ye.UNPACK_SKIP_IMAGES,u);const M=e.isDataArrayTexture||e.isData3DTexture,T=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const n=Q.get(e),i=Q.get(t),f=Q.get(n.__renderTarget),g=Q.get(i.__renderTarget);K.bindFramebuffer(ye.READ_FRAMEBUFFER,f.__webglFramebuffer),K.bindFramebuffer(ye.DRAW_FRAMEBUFFER,g.__webglFramebuffer);for(let v=0;v<l;v++)M&&(ye.framebufferTextureLayer(ye.READ_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,Q.get(e).__webglTexture,s,u+v),ye.framebufferTextureLayer(ye.DRAW_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,Q.get(t).__webglTexture,r,m+v)),ye.blitFramebuffer(c,h,a,o,d,p,a,o,ye.DEPTH_BUFFER_BIT,ye.NEAREST);K.bindFramebuffer(ye.READ_FRAMEBUFFER,null),K.bindFramebuffer(ye.DRAW_FRAMEBUFFER,null)}else if(0!==s||e.isRenderTargetTexture||Q.has(e)){const n=Q.get(e),i=Q.get(t);K.bindFramebuffer(ye.READ_FRAMEBUFFER,ze),K.bindFramebuffer(ye.DRAW_FRAMEBUFFER,Ve);for(let e=0;e<l;e++)M?ye.framebufferTextureLayer(ye.READ_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,n.__webglTexture,s,u+e):ye.framebufferTexture2D(ye.READ_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_2D,n.__webglTexture,s),T?ye.framebufferTextureLayer(ye.DRAW_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,i.__webglTexture,r,m+e):ye.framebufferTexture2D(ye.DRAW_FRAMEBUFFER,ye.COLOR_ATTACHMENT0,ye.TEXTURE_2D,i.__webglTexture,r),0!==s?ye.blitFramebuffer(c,h,a,o,d,p,a,o,ye.COLOR_BUFFER_BIT,ye.NEAREST):T?ye.copyTexSubImage3D(x,r,d,p,m+e,c,h,a,o):ye.copyTexSubImage2D(x,r,d,p,c,h,a,o);K.bindFramebuffer(ye.READ_FRAMEBUFFER,null),K.bindFramebuffer(ye.DRAW_FRAMEBUFFER,null)}else T?e.isDataTexture||e.isData3DTexture?ye.texSubImage3D(x,r,d,p,m,a,o,l,g,v,f.data):t.isCompressedArrayTexture?ye.compressedTexSubImage3D(x,r,d,p,m,a,o,l,g,f.data):ye.texSubImage3D(x,r,d,p,m,a,o,l,g,v,f):e.isDataTexture?ye.texSubImage2D(ye.TEXTURE_2D,r,d,p,a,o,g,v,f.data):e.isCompressedTexture?ye.compressedTexSubImage2D(ye.TEXTURE_2D,r,d,p,f.width,f.height,g,f.data):ye.texSubImage2D(ye.TEXTURE_2D,r,d,p,a,o,g,v,f);ye.pixelStorei(ye.UNPACK_ROW_LENGTH,y),ye.pixelStorei(ye.UNPACK_IMAGE_HEIGHT,_),ye.pixelStorei(ye.UNPACK_SKIP_PIXELS,b),ye.pixelStorei(ye.UNPACK_SKIP_ROWS,w),ye.pixelStorei(ye.UNPACK_SKIP_IMAGES,S),0===r&&t.generateMipmaps&&ye.generateMipmap(x),K.unbindTexture()},this.copyTextureToTexture3D=function(e,t,n=null,i=null,s=0){return ch('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,n,i,s)},this.initRenderTarget=function(e){void 0===Q.get(e).__webglFramebuffer&&ee.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?ee.setTextureCube(e,0):e.isData3DTexture?ee.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?ee.setTexture2DArray(e,0):ee.setTexture2D(e,0),K.unbindTexture()},this.resetState=function(){b=0,w=0,S=null,K.reset(),ve.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Bc}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=ph._getDrawingBufferColorSpace(e),t.unpackColorSpace=ph._getUnpackColorSpace()}}function sg(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var rg={exports:{}}.exports=function e(t,n,i){function s(a,o){if(!n[a]){if(!t[a]){if(!o&&sg)return sg(a);if(r)return r(a,!0);throw new Error("Cannot find module '"+a+"'")}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){return s(t[a][1][e]||e)},l,l.exports,e,t,n,i)}return n[a].exports}for(var r=sg,a=0;a<i.length;a++)s(i[a]);return s}({1:[function(e,t,n){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,n){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(e,t,n){var i=e("../math/Vec3");function s(e){e=e||{},this.lowerBound=new i,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new i,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=s;var r=new i;s.prototype.setFromPoints=function(e,t,n,i){var s=this.lowerBound,a=this.upperBound,o=n;s.copy(e[0]),o&&o.vmult(s,s),a.copy(s);for(var l=1;l<e.length;l++){var c=e[l];o&&(o.vmult(c,r),c=r),c.x>a.x&&(a.x=c.x),c.x<s.x&&(s.x=c.x),c.y>a.y&&(a.y=c.y),c.y<s.y&&(s.y=c.y),c.z>a.z&&(a.z=c.z),c.z<s.z&&(s.z=c.z)}return t&&(t.vadd(s,s),t.vadd(a,a)),i&&(s.x-=i,s.y-=i,s.z-=i,a.x+=i,a.y+=i,a.z+=i),this},s.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},s.prototype.clone=function(){return(new s).copy(this)},s.prototype.extend=function(e){var t=e.lowerBound.x;this.lowerBound.x>t&&(this.lowerBound.x=t);var n=e.upperBound.x;this.upperBound.x<n&&(this.upperBound.x=n),t=e.lowerBound.y,this.lowerBound.y>t&&(this.lowerBound.y=t),n=e.upperBound.y,this.upperBound.y<n&&(this.upperBound.y=n),t=e.lowerBound.z,this.lowerBound.z>t&&(this.lowerBound.z=t),n=e.upperBound.z,this.upperBound.z<n&&(this.upperBound.z=n)},s.prototype.overlaps=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,s=e.upperBound;return(i.x<=n.x&&n.x<=s.x||t.x<=s.x&&s.x<=n.x)&&(i.y<=n.y&&n.y<=s.y||t.y<=s.y&&s.y<=n.y)&&(i.z<=n.z&&n.z<=s.z||t.z<=s.z&&s.z<=n.z)},s.prototype.contains=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,s=e.upperBound;return t.x<=i.x&&n.x>=s.x&&t.y<=i.y&&n.y>=s.y&&t.z<=i.z&&n.z>=s.z},s.prototype.getCorners=function(e,t,n,i,s,r,a,o){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),n.set(c.x,c.y,l.z),i.set(l.x,c.y,c.z),s.set(c.x,l.y,l.z),r.set(l.x,c.y,l.z),a.set(l.x,l.y,c.z),o.copy(c)};var a=[new i,new i,new i,new i,new i,new i,new i,new i];s.prototype.toLocalFrame=function(e,t){var n=a,i=n[0],s=n[1],r=n[2],o=n[3],l=n[4],c=n[5],h=n[6],u=n[7];this.getCorners(i,s,r,o,l,c,h,u);for(var d=0;8!==d;d++){var p=n[d];e.pointToLocal(p,p)}return t.setFromPoints(n)},s.prototype.toWorldFrame=function(e,t){var n=a,i=n[0],s=n[1],r=n[2],o=n[3],l=n[4],c=n[5],h=n[6],u=n[7];this.getCorners(i,s,r,o,l,c,h,u);for(var d=0;8!==d;d++){var p=n[d];e.pointToWorld(p,p)}return t.setFromPoints(n)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(e,t,n){function i(){this.matrix=[]}t.exports=i,i.prototype.get=function(e,t){if(e=e.index,(t=t.index)>e){var n=t;t=e,e=n}return this.matrix[(e*(e+1)>>1)+t-1]},i.prototype.set=function(e,t,n){if(e=e.index,(t=t.index)>e){var i=t;t=e,e=i}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0},i.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},i.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,n){var i=e("../objects/Body"),s=e("../math/Vec3"),r=e("../math/Quaternion");function a(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),t.exports=a,a.prototype.collisionPairs=function(e,t,n){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var o=i.STATIC|i.KINEMATIC;a.prototype.needBroadphaseCollision=function(e,t){return 0!==(e.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&e.collisionFilterMask)&&(0===(e.type&o)&&e.sleepState!==i.SLEEPING||0===(t.type&o)&&t.sleepState!==i.SLEEPING)},a.prototype.intersectionTest=function(e,t,n,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,n,i):this.doBoundingSphereBroadphase(e,t,n,i)};var l=new s;new s,new r,new s,a.prototype.doBoundingSphereBroadphase=function(e,t,n,i){var s=l;t.position.vsub(e.position,s);var r=Math.pow(e.boundingRadius+t.boundingRadius,2);s.norm2()<r&&(n.push(e),i.push(t))},a.prototype.doBoundingBoxBroadphase=function(e,t,n,i){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(n.push(e),i.push(t))};var c={keys:[]},h=[],u=[];a.prototype.makePairsUnique=function(e,t){for(var n=c,i=h,s=u,r=e.length,a=0;a!==r;a++)i[a]=e[a],s[a]=t[a];for(e.length=0,t.length=0,a=0;a!==r;a++){var o=i[a].id,l=s[a].id;n[d=o<l?o+","+l:l+","+o]=a,n.keys.push(d)}for(a=0;a!==n.keys.length;a++){var d=n.keys.pop(),p=n[d];e.push(i[p]),t.push(s[p]),delete n[d]}},a.prototype.setWorld=function(e){};var d=new s;a.boundingSphereCheck=function(e,t){var n=d;return e.position.vsub(t.position,n),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>n.norm2()},a.prototype.aabbQuery=function(e,t,n){return[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(e,t,n){t.exports=a;var i=e("./Broadphase"),s=e("../math/Vec3"),r=e("../shapes/Shape");function a(e,t,n,r,a){i.apply(this),this.nx=n||10,this.ny=r||10,this.nz=a||10,this.aabbMin=e||new s(100,100,100),this.aabbMax=t||new s(-100,-100,-100);var o=this.nx*this.ny*this.nz;if(o<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=o,this.binLengths.length=o;for(var l=0;l<o;l++)this.bins[l]=[],this.binLengths[l]=0}a.prototype=new i,a.prototype.constructor=a;var o=new s;new s,a.prototype.collisionPairs=function(e,t,n){var i=e.numObjects(),s=e.bodies,a=this.aabbMax,l=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,d=h*u,p=u,m=a.x,f=a.y,g=a.z,v=l.x,x=l.y,y=l.z,_=c/(m-v),b=h/(f-x),w=u/(g-y),S=(m-v)/c,M=(f-x)/h,T=(g-y)/u,E=.5*Math.sqrt(S*S+M*M+T*T),C=r.types,A=C.SPHERE,N=C.PLANE;C.BOX,C.COMPOUND,C.CONVEXPOLYHEDRON;for(var R=this.bins,P=this.binLengths,I=this.bins.length,j=0;j!==I;j++)P[j]=0;var D=Math.ceil;function k(e,t,n,i,s,r,a){var o=(e-v)*_|0,l=(t-x)*b|0,m=(n-y)*w|0,f=D((i-v)*_),g=D((s-x)*b),S=D((r-y)*w);o<0?o=0:o>=c&&(o=c-1),l<0?l=0:l>=h&&(l=h-1),m<0?m=0:m>=u&&(m=u-1),f<0?f=0:f>=c&&(f=c-1),g<0?g=0:g>=h&&(g=h-1),S<0?S=0:S>=u&&(S=u-1),l*=p,m*=1,f*=d,g*=p,S*=1;for(var M=o*=d;M<=f;M+=d)for(var T=l;T<=g;T+=p)for(var E=m;E<=S;E+=1){var C=M+T+E;R[C][P[C]++]=a}}for(l=Math.min,a=Math.max,j=0;j!==i;j++){var L=(te=s[j]).shape;switch(L.type){case A:var O=te.position.x,U=te.position.y,F=te.position.z,B=L.radius;k(O-B,U-B,F-B,O+B,U+B,F+B,te);break;case N:L.worldNormalNeedsUpdate&&L.computeWorldNormal(te.quaternion);var z=L.worldNormal,V=v+.5*S-te.position.x,H=x+.5*M-te.position.y,W=y+.5*T-te.position.z,G=o;G.set(V,H,W);for(var q=0,X=0;q!==c;q++,X+=d,G.y=H,G.x+=S)for(var Y=0,$=0;Y!==h;Y++,$+=p,G.z=W,G.y+=M)for(var Z=0,K=0;Z!==u;Z++,K+=1,G.z+=T)if(G.dot(z)<E){var J=X+$+K;R[J][P[J]++]=te}break;default:te.aabbNeedsUpdate&&te.computeAABB(),k(te.aabb.lowerBound.x,te.aabb.lowerBound.y,te.aabb.lowerBound.z,te.aabb.upperBound.x,te.aabb.upperBound.y,te.aabb.upperBound.z,te)}}for(j=0;j!==I;j++){var Q=P[j];if(Q>1){var ee=R[j];for(q=0;q!==Q;q++){var te=ee[q];for(Y=0;Y!==q;Y++){var ne=ee[Y];this.needBroadphaseCollision(te,ne)&&this.intersectionTest(te,ne,t,n)}}}}this.makePairsUnique(t,n)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(e,t,n){t.exports=r;var i=e("./Broadphase"),s=e("./AABB");function r(){i.apply(this)}r.prototype=new i,r.prototype.constructor=r,r.prototype.collisionPairs=function(e,t,n){var i,s,r,a,o=e.bodies,l=o.length;for(i=0;i!==l;i++)for(s=0;s!==i;s++)r=o[i],a=o[s],this.needBroadphaseCollision(r,a)&&this.intersectionTest(r,a,t,n)},new s,r.prototype.aabbQuery=function(e,t,n){n=n||[];for(var i=0;i<e.bodies.length;i++){var s=e.bodies[i];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&n.push(s)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,n){function i(){this.matrix={}}t.exports=i,i.prototype.get=function(e,t){if(e=e.id,(t=t.id)>e){var n=t;t=e,e=n}return e+"-"+t in this.matrix},i.prototype.set=function(e,t,n){if(e=e.id,(t=t.id)>e){var i=t;t=e,e=i}n?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,n){t.exports=c;var i=e("../math/Vec3"),s=e("../math/Quaternion"),r=e("../math/Transform");e("../shapes/ConvexPolyhedron"),e("../shapes/Box");var a=e("../collision/RaycastResult"),o=e("../shapes/Shape"),l=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new i,this.to=t?t.clone():new i,this._direction=new i,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new a,this.hasHit=!1,this.callback=function(e){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var h=new l,u=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new a,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(h),u.length=0,e.broadphase.aabbQuery(e,h,u),this.intersectBodies(u),this.hasHit};var d=new i,p=new i;function m(e,t,n,i){i.vsub(t,D),n.vsub(t,d),e.vsub(t,p);var s,r,a=D.dot(D),o=D.dot(d),l=D.dot(p),c=d.dot(d),h=d.dot(p);return(s=c*l-o*h)>=0&&(r=a*h-o*l)>=0&&s+r<a*c-o*o}c.pointInTriangle=m;var f=new i,g=new s;c.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var n=this.checkCollisionResponse;if((!n||e.collisionResponse)&&0!==(this.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&this.collisionFilterMask))for(var i=f,s=g,r=0,a=e.shapes.length;r<a;r++){var o=e.shapes[r];if((!n||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[r],s),e.quaternion.vmult(e.shapeOffsets[r],i),i.vadd(e.position,i),this.intersectShape(o,s,i,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var n=0,i=e.length;!this.result._shouldStop&&n<i;n++)this.intersectBody(e[n])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,n,i){if(!(function(e,t,n){n.vsub(e,D);var i=D.dot(t);return t.mult(i,k),k.vadd(e,k),n.distanceTo(k)}(this.from,this._direction,n)>e.boundingSphereRadius)){var s=this[e.type];s&&s.call(this,e,t,n,i)}},new i,new i;var v=new i,x=new i,y=new i,_=new i;new i,new a,c.prototype.intersectBox=function(e,t,n,i){return this.intersectConvex(e.convexPolyhedronRepresentation,t,n,i)},c.prototype[o.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,n,s){var r=this.from,a=this.to,o=this._direction,l=new i(0,0,1);t.vmult(l,l);var c=new i;r.vsub(n,c);var h=c.dot(l);if(a.vsub(n,c),!(h*c.dot(l)>0||r.distanceTo(a)<h)){var u=l.dot(o);if(!(Math.abs(u)<this.precision)){var d=new i,p=new i,m=new i;r.vsub(n,d);var f=-l.dot(d)/u;o.scale(f,p),r.vadd(p,m),this.reportIntersection(l,m,e,s,-1)}}},c.prototype[o.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,n=this.from;e.lowerBound.x=Math.min(t.x,n.x),e.lowerBound.y=Math.min(t.y,n.y),e.lowerBound.z=Math.min(t.z,n.z),e.upperBound.x=Math.max(t.x,n.x),e.upperBound.y=Math.max(t.y,n.y),e.upperBound.z=Math.max(t.z,n.z)};var b={faceList:[0]};c.prototype.intersectHeightfield=function(e,t,n,s){e.data,e.elementSize;var a=new i,o=new c(this.from,this.to);r.pointToLocalFrame(n,t,o.from,o.from),r.pointToLocalFrame(n,t,o.to,o.to);var l=[],h=null,u=null,d=null,p=null,m=e.getIndexOfPosition(o.from.x,o.from.y,l,!1);if(m&&(h=l[0],u=l[1],d=l[0],p=l[1]),(m=e.getIndexOfPosition(o.to.x,o.to.y,l,!1))&&((null===h||l[0]<h)&&(h=l[0]),(null===d||l[0]>d)&&(d=l[0]),(null===u||l[1]<u)&&(u=l[1]),(null===p||l[1]>p)&&(p=l[1])),null!==h){var f=[];e.getRectMinMax(h,u,d,p,f);for(var g=h;g<=d;g++)for(var v=u;v<=p;v++){if(this.result._shouldStop)return;if(e.getConvexTrianglePillar(g,v,!1),r.pointToWorldFrame(n,t,e.pillarOffset,a),this.intersectConvex(e.pillarConvex,t,a,s,b),this.result._shouldStop)return;e.getConvexTrianglePillar(g,v,!0),r.pointToWorldFrame(n,t,e.pillarOffset,a),this.intersectConvex(e.pillarConvex,t,a,s,b)}}},c.prototype[o.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var w=new i,S=new i;c.prototype.intersectSphere=function(e,t,n,i){var s=this.from,r=this.to,a=e.radius,o=Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2)+Math.pow(r.z-s.z,2),l=2*((r.x-s.x)*(s.x-n.x)+(r.y-s.y)*(s.y-n.y)+(r.z-s.z)*(s.z-n.z)),c=Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2)+Math.pow(s.z-n.z,2)-Math.pow(a,2),h=Math.pow(l,2)-4*o*c,u=w,d=S;if(!(h<0))if(0===h)s.lerp(r,h,u),u.vsub(n,d),d.normalize(),this.reportIntersection(d,u,e,i,-1);else{var p=(-l-Math.sqrt(h))/(2*o),m=(-l+Math.sqrt(h))/(2*o);if(p>=0&&p<=1&&(s.lerp(r,p,u),u.vsub(n,d),d.normalize(),this.reportIntersection(d,u,e,i,-1)),this.result._shouldStop)return;m>=0&&m<=1&&(s.lerp(r,m,u),u.vsub(n,d),d.normalize(),this.reportIntersection(d,u,e,i,-1))}},c.prototype[o.types.SPHERE]=c.prototype.intersectSphere;var M=new i;new i,new i;var T=new i;c.prototype.intersectConvex=function(e,t,n,i,s){for(var r=M,a=T,o=s&&s.faceList||null,l=e.faces,c=e.vertices,h=e.faceNormals,u=this._direction,d=this.from,p=this.to,f=d.distanceTo(p),g=o?o.length:l.length,b=this.result,w=0;!b._shouldStop&&w<g;w++){var S=o?o[w]:w,E=l[S],C=h[S],A=t,N=n;a.copy(c[E[0]]),A.vmult(a,a),a.vadd(N,a),a.vsub(d,a),A.vmult(C,r);var R=u.dot(r);if(!(Math.abs(R)<this.precision)){var P=r.dot(a)/R;if(!(P<0)){u.mult(P,v),v.vadd(d,v),x.copy(c[E[0]]),A.vmult(x,x),N.vadd(x,x);for(var I=1;!b._shouldStop&&I<E.length-1;I++){y.copy(c[E[I]]),_.copy(c[E[I+1]]),A.vmult(y,y),A.vmult(_,_),N.vadd(y,y),N.vadd(_,_);var j=v.distanceTo(d);!m(v,x,y,_)&&!m(v,y,x,_)||j>f||this.reportIntersection(r,v,e,i,S)}}}}},c.prototype[o.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var E=new i,C=new i,A=new i,N=new i,R=new i,P=new i;new l;var I=[],j=new r;c.prototype.intersectTrimesh=function(e,t,n,i,s){var a=E,o=I,l=j,c=T,h=C,u=A,d=N,p=P,f=R;s&&s.faceList;var g=e.indices;e.vertices,e.faceNormals;var b=this.from,w=this.to,S=this._direction;l.position.copy(n),l.quaternion.copy(t),r.vectorToLocalFrame(n,t,S,h),r.pointToLocalFrame(n,t,b,u),r.pointToLocalFrame(n,t,w,d);var M=u.distanceSquared(d);e.tree.rayQuery(this,l,o);for(var D=0,k=o.length;!this.result._shouldStop&&D!==k;D++){var L=o[D];e.getNormal(L,a),e.getVertex(g[3*L],x),x.vsub(u,c);var O=h.dot(a),U=a.dot(c)/O;if(!(U<0)){h.scale(U,v),v.vadd(u,v),e.getVertex(g[3*L+1],y),e.getVertex(g[3*L+2],_);var F=v.distanceSquared(u);!m(v,y,x,_)&&!m(v,x,y,_)||F>M||(r.vectorToWorldFrame(t,a,f),r.pointToWorldFrame(n,t,v,p),this.reportIntersection(f,p,e,i,L))}}o.length=0},c.prototype[o.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,n,i,s){var r=this.from,a=this.to,o=r.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==s?s:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(r,a,e,t,n,i,o),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(o<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(r,a,e,t,n,i,o));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(r,a,e,t,n,i,o),l._shouldStop=!0}};var D=new i,k=new i},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(e,t,n){var i=e("../math/Vec3");function s(){this.rayFromWorld=new i,this.rayToWorld=new i,this.hitNormalWorld=new i,this.hitPointWorld=new i,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}t.exports=s,s.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},s.prototype.abort=function(){this._shouldStop=!0},s.prototype.set=function(e,t,n,i,s,r,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(i),this.shape=s,this.body=r,this.distance=a}},{"../math/Vec3":30}],11:[function(e,t,n){e("../shapes/Shape");var i=e("../collision/Broadphase");function s(e){i.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var n=t.indexOf(e.body);-1!==n&&t.splice(n,1)},e&&this.setWorld(e)}t.exports=s,s.prototype=new i,s.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},s.insertionSortX=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.x<=i.aabb.lowerBound.x);s--)e[s+1]=e[s];e[s+1]=i}return e},s.insertionSortY=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.y<=i.aabb.lowerBound.y);s--)e[s+1]=e[s];e[s+1]=i}return e},s.insertionSortZ=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.z<=i.aabb.lowerBound.z);s--)e[s+1]=e[s];e[s+1]=i}return e},s.prototype.collisionPairs=function(e,t,n){var i,r,a=this.axisList,o=a.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),i=0;i!==o;i++){var c=a[i];for(r=i+1;r<o;r++){var h=a[r];if(this.needBroadphaseCollision(c,h)){if(!s.checkBounds(c,h,l))break;this.intersectionTest(c,h,t,n)}}}},s.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,i=0;i!==n;i++){var r=e[i];r.aabbNeedsUpdate&&r.computeAABB()}0===t?s.insertionSortX(e):1===t?s.insertionSortY(e):2===t&&s.insertionSortZ(e)},s.checkBounds=function(e,t,n){var i,s;0===n?(i=e.position.x,s=t.position.x):1===n?(i=e.position.y,s=t.position.y):2===n&&(i=e.position.z,s=t.position.z);var r=e.boundingRadius;return s-t.boundingRadius<i+r},s.prototype.autoDetectAxis=function(){for(var e=0,t=0,n=0,i=0,s=0,r=0,a=this.axisList,o=a.length,l=1/o,c=0;c!==o;c++){var h=a[c],u=h.position.x;e+=u,t+=u*u;var d=h.position.y;n+=d,i+=d*d;var p=h.position.z;s+=p,r+=p*p}var m=t-e*e*l,f=i-n*n*l,g=r-s*s*l;this.axisIndex=m>f?m>g?0:2:f>g?1:2},s.prototype.aabbQuery=function(e,t,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,s="x";1===i&&(s="y"),2===i&&(s="z");var r=this.axisList;t.lowerBound[s],t.upperBound[s];for(var a=0;a<r.length;a++){var o=r[a];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&n.push(o)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(e,t,n){t.exports=o,e("./Constraint");var i=e("./PointToPointConstraint"),s=e("../equations/ConeEquation"),r=e("../equations/RotationalEquation");e("../equations/ContactEquation");var a=e("../math/Vec3");function o(e,t,n){var o=void 0!==(n=n||{}).maxForce?n.maxForce:1e6,l=n.pivotA?n.pivotA.clone():new a,c=n.pivotB?n.pivotB.clone():new a;this.axisA=n.axisA?n.axisA.clone():new a,this.axisB=n.axisB?n.axisB.clone():new a,i.call(this,e,l,t,c,o),this.collideConnected=!!n.collideConnected,this.angle=void 0!==n.angle?n.angle:0;var h=this.coneEquation=new s(e,t,n),u=this.twistEquation=new r(e,t,n);this.twistAngle=void 0!==n.twistAngle?n.twistAngle:0,h.maxForce=0,h.minForce=-o,u.maxForce=0,u.minForce=-o,this.equations.push(h,u)}o.prototype=new i,o.constructor=o,new a,new a,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.coneEquation,s=this.twistEquation;i.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,n.axisA),t.vectorToWorldFrame(this.axisB,n.axisB),this.axisA.tangents(s.axisA,s.axisA),e.vectorToWorldFrame(s.axisA,s.axisA),this.axisB.tangents(s.axisB,s.axisB),t.vectorToWorldFrame(s.axisB,s.axisB),n.angle=this.angle,s.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(e,t,n){t.exports=s;var i=e("../utils/Utils");function s(e,t,n){n=i.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=s.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}s.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},s.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},s.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},s.idCounter=0},{"../utils/Utils":53}],14:[function(e,t,n){t.exports=r;var i=e("./Constraint"),s=e("../equations/ContactEquation");function r(e,t,n,r){i.call(this,e,t),void 0===n&&(n=e.position.distanceTo(t.position)),void 0===r&&(r=1e6),this.distance=n;var a=this.distanceEquation=new s(e,t);this.equations.push(a),a.minForce=-r,a.maxForce=r}r.prototype=new i,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.distanceEquation,i=.5*this.distance,s=n.ni;t.position.vsub(e.position,s),s.normalize(),s.mult(i,n.ri),s.mult(-i,n.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(e,t,n){t.exports=o,e("./Constraint");var i=e("./PointToPointConstraint"),s=e("../equations/RotationalEquation"),r=e("../equations/RotationalMotorEquation");e("../equations/ContactEquation");var a=e("../math/Vec3");function o(e,t,n){var o=void 0!==(n=n||{}).maxForce?n.maxForce:1e6,l=n.pivotA?n.pivotA.clone():new a,c=n.pivotB?n.pivotB.clone():new a;i.call(this,e,l,t,c,o),(this.axisA=n.axisA?n.axisA.clone():new a(1,0,0)).normalize(),(this.axisB=n.axisB?n.axisB.clone():new a(1,0,0)).normalize();var h=this.rotationalEquation1=new s(e,t,n),u=this.rotationalEquation2=new s(e,t,n),d=this.motorEquation=new r(e,t,o);d.enabled=!1,this.equations.push(h,u,d)}o.prototype=new i,o.constructor=o,o.prototype.enableMotor=function(){this.motorEquation.enabled=!0},o.prototype.disableMotor=function(){this.motorEquation.enabled=!1},o.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},o.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var l=new a,c=new a;o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.motorEquation,s=this.rotationalEquation1,r=this.rotationalEquation2,a=l,o=c,h=this.axisA,u=this.axisB;i.prototype.update.call(this),e.quaternion.vmult(h,a),t.quaternion.vmult(u,o),a.tangents(s.axisA,r.axisA),s.axisB.copy(o),r.axisB.copy(o),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,n.axisA),t.quaternion.vmult(this.axisB,n.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(e,t,n){t.exports=a,e("./Constraint");var i=e("./PointToPointConstraint"),s=e("../equations/RotationalEquation");e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation");var r=e("../math/Vec3");function a(e,t,n){var a=void 0!==(n=n||{}).maxForce?n.maxForce:1e6,o=new r,l=new r,c=new r;e.position.vadd(t.position,c),c.scale(.5,c),t.pointToLocalFrame(c,l),e.pointToLocalFrame(c,o),i.call(this,e,o,t,l,a);var h=this.rotationalEquation1=new s(e,t,n),u=this.rotationalEquation2=new s(e,t,n),d=this.rotationalEquation3=new s(e,t,n);this.equations.push(h,u,d)}a.prototype=new i,a.constructor=a,new r,new r,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB;this.motorEquation;var n=this.rotationalEquation1,s=this.rotationalEquation2,a=this.rotationalEquation3;i.prototype.update.call(this),e.vectorToWorldFrame(r.UNIT_X,n.axisA),t.vectorToWorldFrame(r.UNIT_Y,n.axisB),e.vectorToWorldFrame(r.UNIT_Y,s.axisA),t.vectorToWorldFrame(r.UNIT_Z,s.axisB),e.vectorToWorldFrame(r.UNIT_Z,a.axisA),t.vectorToWorldFrame(r.UNIT_X,a.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(e,t,n){t.exports=a;var i=e("./Constraint"),s=e("../equations/ContactEquation"),r=e("../math/Vec3");function a(e,t,n,a,o){i.call(this,e,n),o=void 0!==o?o:1e6,this.pivotA=t?t.clone():new r,this.pivotB=a?a.clone():new r;var l=this.equationX=new s(e,n),c=this.equationY=new s(e,n),h=this.equationZ=new s(e,n);this.equations.push(l,c,h),l.minForce=c.minForce=h.minForce=-o,l.maxForce=c.maxForce=h.maxForce=o,l.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}a.prototype=new i,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.equationX,i=this.equationY,s=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri),t.quaternion.vmult(this.pivotB,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),s.ri.copy(n.ri),s.rj.copy(n.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(e,t,n){t.exports=r;var i=e("../math/Vec3");e("../math/Mat3");var s=e("./Equation");function r(e,t,n){var r=void 0!==(n=n||{}).maxForce?n.maxForce:1e6;s.call(this,e,t,-r,r),this.axisA=n.axisA?n.axisA.clone():new i(1,0,0),this.axisB=n.axisB?n.axisB.clone():new i(0,1,0),this.angle=void 0!==n.angle?n.angle:0}r.prototype=new s,r.prototype.constructor=r;var a=new i,o=new i;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,s=this.axisB,r=a,l=o,c=this.jacobianElementA,h=this.jacobianElementB;return i.cross(s,r),s.cross(i,l),c.rotational.copy(l),h.rotational.copy(r),-(Math.cos(this.angle)-i.dot(s))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(e,t,n){t.exports=r;var i=e("./Equation"),s=e("../math/Vec3");function r(e,t,n){n=void 0!==n?n:1e6,i.call(this,e,t,0,n),this.restitution=0,this.ri=new s,this.rj=new s,this.ni=new s}e("../math/Mat3"),r.prototype=new i,r.prototype.constructor=r;var a=new s,o=new s,l=new s;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.bi,s=this.bj,r=this.ri,c=this.rj,h=a,u=o,d=i.velocity,p=i.angularVelocity;i.force,i.torque;var m=s.velocity,f=s.angularVelocity;s.force,s.torque;var g=l,v=this.jacobianElementA,x=this.jacobianElementB,y=this.ni;r.cross(y,h),c.cross(y,u),y.negate(v.spatial),h.negate(v.rotational),x.spatial.copy(y),x.rotational.copy(u),g.copy(s.position),g.vadd(c,g),g.vsub(i.position,g),g.vsub(r,g);var _=y.dot(g),b=this.restitution+1;return-_*t-(b*m.dot(y)-b*d.dot(y)+f.dot(u)-p.dot(h))*n-e*this.computeGiMf()};var c=new s,h=new s,u=new s,d=new s,p=new s;r.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=h,n=u,i=d,s=p;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(i,t),e.vsub(t,s),this.ni.dot(s)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(e,t,n){t.exports=r;var i=e("../math/JacobianElement"),s=e("../math/Vec3");function r(e,t,n,s){this.id=r.id++,this.minForce=void 0===n?-1e6:n,this.maxForce=void 0===s?1e6:s,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new i,this.jacobianElementB=new i,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(e,t,n){var i=t,s=e,r=n;this.a=4/(r*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(r*r*s*(1+4*i))},r.prototype.computeB=function(e,t,n){var i=this.computeGW();return-this.computeGq()*e-i*t-this.computeGiMf()*n},r.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.position,r=i.position;return e.spatial.dot(s)+t.spatial.dot(r)};var a=new s;r.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.velocity,r=i.velocity,o=n.angularVelocity||a,l=i.angularVelocity||a;return e.multiplyVectors(s,o)+t.multiplyVectors(r,l)},r.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.vlambda,r=i.vlambda,o=n.wlambda||a,l=i.wlambda||a;return e.multiplyVectors(s,o)+t.multiplyVectors(r,l)};var o=new s,l=new s,c=new s,h=new s;r.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.force,r=n.torque,a=i.force,u=i.torque,d=n.invMassSolve,p=i.invMassSolve;return n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(r,c):c.set(0,0,0),i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(u,h):h.set(0,0,0),s.mult(d,o),a.mult(p,l),e.multiplyVectors(o,c)+t.multiplyVectors(l,h)};var u=new s;r.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,s=n.invMassSolve,r=i.invMassSolve,a=n.invInertiaWorldSolve,o=i.invInertiaWorldSolve,l=s+r;return a&&(a.vmult(e.rotational,u),l+=u.dot(e.rotational)),o&&(o.vmult(t.rotational,u),l+=u.dot(t.rotational)),l};var d=new s;new s,new s,new s,new s,new s,r.prototype.addToWlambda=function(e){var t=this.jacobianElementA,n=this.jacobianElementB,i=this.bi,s=this.bj,r=d;t.spatial.mult(i.invMassSolve*e,r),i.vlambda.vadd(r,i.vlambda),n.spatial.mult(s.invMassSolve*e,r),s.vlambda.vadd(r,s.vlambda),i.invInertiaWorldSolve&&(i.invInertiaWorldSolve.vmult(t.rotational,r),r.mult(e,r),i.wlambda.vadd(r,i.wlambda)),s.invInertiaWorldSolve&&(s.invInertiaWorldSolve.vmult(n.rotational,r),r.mult(e,r),s.wlambda.vadd(r,s.wlambda))},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(e,t,n){t.exports=r;var i=e("./Equation"),s=e("../math/Vec3");function r(e,t,n){i.call(this,e,t,-n,n),this.ri=new s,this.rj=new s,this.t=new s}e("../math/Mat3"),r.prototype=new i,r.prototype.constructor=r;var a=new s,o=new s;r.prototype.computeB=function(e){this.a;var t=this.b;this.bi,this.bj;var n=this.ri,i=this.rj,s=a,r=o,l=this.t;n.cross(l,s),i.cross(l,r);var c=this.jacobianElementA,h=this.jacobianElementB;return l.negate(c.spatial),s.negate(c.rotational),h.spatial.copy(l),h.rotational.copy(r),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(e,t,n){t.exports=r;var i=e("../math/Vec3");e("../math/Mat3");var s=e("./Equation");function r(e,t,n){var r=void 0!==(n=n||{}).maxForce?n.maxForce:1e6;s.call(this,e,t,-r,r),this.axisA=n.axisA?n.axisA.clone():new i(1,0,0),this.axisB=n.axisB?n.axisB.clone():new i(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new s,r.prototype.constructor=r;var a=new i,o=new i;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,s=this.axisB,r=a,l=o,c=this.jacobianElementA,h=this.jacobianElementB;return i.cross(s,r),s.cross(i,l),c.rotational.copy(l),h.rotational.copy(r),-(Math.cos(this.maxAngle)-i.dot(s))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(e,t,n){t.exports=r;var i=e("../math/Vec3");e("../math/Mat3");var s=e("./Equation");function r(e,t,n){n=void 0!==n?n:1e6,s.call(this,e,t,-n,n),this.axisA=new i,this.axisB=new i,this.targetVelocity=0}r.prototype=new s,r.prototype.constructor=r,r.prototype.computeB=function(e){this.a;var t=this.b;this.bi,this.bj;var n=this.axisA,i=this.axisB,s=this.jacobianElementA,r=this.jacobianElementB;return s.rotational.copy(n),i.negate(r.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(e,t,n){var i=e("../utils/Utils");function s(e,t,n){n=i.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=s.idCounter++,this.materials=[e,t],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}t.exports=s,s.idCounter=0},{"../utils/Utils":53}],25:[function(e,t,n){function i(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=i.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1}t.exports=i,i.idCounter=0},{}],26:[function(e,t,n){t.exports=s;var i=e("./Vec3");function s(){this.spatial=new i,this.rotational=new i}s.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},s.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(e,t,n){t.exports=s;var i=e("./Vec3");function s(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}s.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},s.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},s.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},s.prototype.getTrace=function(e){e=e||new i;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},s.prototype.vmult=function(e,t){t=t||new i;var n=this.elements,s=e.x,r=e.y,a=e.z;return t.x=n[0]*s+n[1]*r+n[2]*a,t.y=n[3]*s+n[4]*r+n[5]*a,t.z=n[6]*s+n[7]*r+n[8]*a,t},s.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},s.prototype.mmult=function(e,t){for(var n=t||new s,i=0;i<3;i++)for(var r=0;r<3;r++){for(var a=0,o=0;o<3;o++)a+=e.elements[i+3*o]*this.elements[o+3*r];n.elements[i+3*r]=a}return n},s.prototype.scale=function(e,t){t=t||new s;for(var n=this.elements,i=t.elements,r=0;3!==r;r++)i[3*r+0]=e.x*n[3*r+0],i[3*r+1]=e.y*n[3*r+1],i[3*r+2]=e.z*n[3*r+2];return t},s.prototype.solve=function(e,t){t=t||new i;for(var n,s=[],r=0;r<12;r++)s.push(0);for(r=0;r<3;r++)for(n=0;n<3;n++)s[r+4*n]=this.elements[r+3*n];s[3]=e.x,s[7]=e.y,s[11]=e.z;var a,o,l=3,c=l;do{if(0===s[(r=c-l)+4*r])for(n=r+1;n<c;n++)if(0!==s[r+4*n]){a=4;do{s[(o=4-a)+4*r]+=s[o+4*n]}while(--a);break}if(0!==s[r+4*r])for(n=r+1;n<c;n++){var h=s[r+4*n]/s[r+4*r];a=4;do{s[(o=4-a)+4*n]=o<=r?0:s[o+4*n]-s[o+4*r]*h}while(--a)}}while(--l);if(t.z=s[11]/s[10],t.y=(s[7]-s[6]*t.z)/s[5],t.x=(s[3]-s[2]*t.z-s[1]*t.y)/s[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},s.prototype.e=function(e,t,n){if(void 0===n)return this.elements[t+3*e];this.elements[t+3*e]=n},s.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},s.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},s.prototype.reverse=function(e){e=e||new s;for(var t,n=[],i=0;i<18;i++)n.push(0);for(i=0;i<3;i++)for(t=0;t<3;t++)n[i+6*t]=this.elements[i+3*t];n[3]=1,n[9]=0,n[15]=0,n[4]=0,n[10]=1,n[16]=0,n[5]=0,n[11]=0,n[17]=1;var r,a,o=3,l=o;do{if(0===n[(i=l-o)+6*i])for(t=i+1;t<l;t++)if(0!==n[i+6*t]){r=6;do{n[(a=6-r)+6*i]+=n[a+6*t]}while(--r);break}if(0!==n[i+6*i])for(t=i+1;t<l;t++){var c=n[i+6*t]/n[i+6*i];r=6;do{n[(a=6-r)+6*t]=a<=i?0:n[a+6*t]-n[a+6*i]*c}while(--r)}}while(--o);i=2;do{t=i-1;do{c=n[i+6*t]/n[i+6*i],r=6;do{n[(a=6-r)+6*t]=n[a+6*t]-n[a+6*i]*c}while(--r)}while(t--)}while(--i);i=2;do{c=1/n[i+6*i],r=6;do{n[(a=6-r)+6*i]=n[a+6*i]*c}while(--r)}while(i--);i=2;do{t=2;do{if(a=n[3+t+6*i],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(i,t,a)}while(t--)}while(i--);return e},s.prototype.setRotationFromQuaternion=function(e){var t=e.x,n=e.y,i=e.z,s=e.w,r=t+t,a=n+n,o=i+i,l=t*r,c=t*a,h=t*o,u=n*a,d=n*o,p=i*o,m=s*r,f=s*a,g=s*o,v=this.elements;return v[0]=1-(u+p),v[1]=c-g,v[2]=h+f,v[3]=c+g,v[4]=1-(l+p),v[5]=d-m,v[6]=h-f,v[7]=d+m,v[8]=1-(l+u),this},s.prototype.transpose=function(e){for(var t=(e=e||new s).elements,n=this.elements,i=0;3!==i;i++)for(var r=0;3!==r;r++)t[3*i+r]=n[3*r+i];return e}},{"./Vec3":30}],28:[function(e,t,n){t.exports=s;var i=e("./Vec3");function s(e,t,n,i){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==n?n:0,this.w=void 0!==i?i:1}s.prototype.set=function(e,t,n,i){this.x=e,this.y=t,this.z=n,this.w=i},s.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},s.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},s.prototype.setFromAxisAngle=function(e,t){var n=Math.sin(.5*t);this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*t)},s.prototype.toAxisAngle=function(e){e=e||new i,this.normalize();var t=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return n<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,t]};var r=new i,a=new i;s.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var n=r,i=a;e.tangents(n,i),this.setFromAxisAngle(n,Math.PI)}else{var s=e.cross(t);this.x=s.x,this.y=s.y,this.z=s.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}};var o=new i,l=new i,c=new i;s.prototype.mult=function(e,t){t=t||new s;var n=this.w,i=o,r=l,a=c;return i.set(this.x,this.y,this.z),r.set(e.x,e.y,e.z),t.w=n*e.w-i.dot(r),i.cross(r,a),t.x=n*r.x+e.w*i.x+a.x,t.y=n*r.y+e.w*i.y+a.y,t.z=n*r.z+e.w*i.z+a.z,t},s.prototype.inverse=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;e=e||new s,this.conjugate(e);var a=1/(t*t+n*n+i*i+r*r);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},s.prototype.conjugate=function(e){return(e=e||new s).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},s.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e)},s.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e)},s.prototype.vmult=function(e,t){t=t||new i;var n=e.x,s=e.y,r=e.z,a=this.x,o=this.y,l=this.z,c=this.w,h=c*n+o*r-l*s,u=c*s+l*n-a*r,d=c*r+a*s-o*n,p=-a*n-o*s-l*r;return t.x=h*c+p*-a+u*-l-d*-o,t.y=u*c+p*-o+d*-a-h*-l,t.z=d*c+p*-l+h*-o-u*-a,t},s.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},s.prototype.toEuler=function(e,t){var n,i,s;t=t||"YZX";var r=this.x,a=this.y,o=this.z,l=this.w;if("YZX"!==t)throw new Error("Euler order "+t+" not supported yet.");var c=r*a+o*l;if(c>.499&&(n=2*Math.atan2(r,l),i=Math.PI/2,s=0),c<-.499&&(n=-2*Math.atan2(r,l),i=-Math.PI/2,s=0),isNaN(n)){var h=r*r,u=a*a,d=o*o;n=Math.atan2(2*a*l-2*r*o,1-2*u-2*d),i=Math.asin(2*c),s=Math.atan2(2*r*l-2*a*o,1-2*h-2*d)}e.y=n,e.z=i,e.x=s},s.prototype.setFromEuler=function(e,t,n,i){i=i||"XYZ";var s=Math.cos(e/2),r=Math.cos(t/2),a=Math.cos(n/2),o=Math.sin(e/2),l=Math.sin(t/2),c=Math.sin(n/2);return"XYZ"===i?(this.x=o*r*a+s*l*c,this.y=s*l*a-o*r*c,this.z=s*r*c+o*l*a,this.w=s*r*a-o*l*c):"YXZ"===i?(this.x=o*r*a+s*l*c,this.y=s*l*a-o*r*c,this.z=s*r*c-o*l*a,this.w=s*r*a+o*l*c):"ZXY"===i?(this.x=o*r*a-s*l*c,this.y=s*l*a+o*r*c,this.z=s*r*c+o*l*a,this.w=s*r*a-o*l*c):"ZYX"===i?(this.x=o*r*a-s*l*c,this.y=s*l*a+o*r*c,this.z=s*r*c-o*l*a,this.w=s*r*a+o*l*c):"YZX"===i?(this.x=o*r*a+s*l*c,this.y=s*l*a+o*r*c,this.z=s*r*c-o*l*a,this.w=s*r*a-o*l*c):"XZY"===i&&(this.x=o*r*a-s*l*c,this.y=s*l*a-o*r*c,this.z=s*r*c+o*l*a,this.w=s*r*a+o*l*c),this},s.prototype.clone=function(){return new s(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(e,t,n){var i=e("./Vec3"),s=e("./Quaternion");function r(e){e=e||{},this.position=new i,e.position&&this.position.copy(e.position),this.quaternion=new s,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=r;var a=new s;r.pointToLocalFrame=function(e,t,n,s){return s=s||new i,n.vsub(e,s),t.conjugate(a),a.vmult(s,s),s},r.prototype.pointToLocal=function(e,t){return r.pointToLocalFrame(this.position,this.quaternion,e,t)},r.pointToWorldFrame=function(e,t,n,s){return s=s||new i,t.vmult(n,s),s.vadd(e,s),s},r.prototype.pointToWorld=function(e,t){return r.pointToWorldFrame(this.position,this.quaternion,e,t)},r.prototype.vectorToWorldFrame=function(e,t){return t=t||new i,this.quaternion.vmult(e,t),t},r.vectorToWorldFrame=function(e,t,n){return e.vmult(t,n),n},r.vectorToLocalFrame=function(e,t,n,s){return s=s||new i,t.w*=-1,t.vmult(n,s),t.w*=-1,s}},{"./Quaternion":28,"./Vec3":30}],30:[function(e,t,n){t.exports=s;var i=e("./Mat3");function s(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0}s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1),s.prototype.cross=function(e,t){var n=e.x,i=e.y,r=e.z,a=this.x,o=this.y,l=this.z;return(t=t||new s).x=o*r-l*i,t.y=l*n-a*r,t.z=a*i-o*n,t},s.prototype.set=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},s.prototype.setZero=function(){this.x=this.y=this.z=0},s.prototype.vadd=function(e,t){if(!t)return new s(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},s.prototype.vsub=function(e,t){if(!t)return new s(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},s.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},s.prototype.normalize=function(){var e=this.x,t=this.y,n=this.z,i=Math.sqrt(e*e+t*t+n*n);if(i>0){var s=1/i;this.x*=s,this.y*=s,this.z*=s}else this.x=0,this.y=0,this.z=0;return i},s.prototype.unit=function(e){e=e||new s;var t=this.x,n=this.y,i=this.z,r=Math.sqrt(t*t+n*n+i*i);return r>0?(r=1/r,e.x=t*r,e.y=n*r,e.z=i*r):(e.x=1,e.y=0,e.z=0),e},s.prototype.norm=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},s.prototype.length=s.prototype.norm,s.prototype.norm2=function(){return this.dot(this)},s.prototype.lengthSquared=s.prototype.norm2,s.prototype.distanceTo=function(e){var t=this.x,n=this.y,i=this.z,s=e.x,r=e.y,a=e.z;return Math.sqrt((s-t)*(s-t)+(r-n)*(r-n)+(a-i)*(a-i))},s.prototype.distanceSquared=function(e){var t=this.x,n=this.y,i=this.z,s=e.x,r=e.y,a=e.z;return(s-t)*(s-t)+(r-n)*(r-n)+(a-i)*(a-i)},s.prototype.mult=function(e,t){t=t||new s;var n=this.x,i=this.y,r=this.z;return t.x=e*n,t.y=e*i,t.z=e*r,t},s.prototype.scale=s.prototype.mult,s.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},s.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},s.prototype.negate=function(e){return(e=e||new s).x=-this.x,e.y=-this.y,e.z=-this.z,e};var r=new s,a=new s;s.prototype.tangents=function(e,t){var n=this.norm();if(n>0){var i=r,s=1/n;i.set(this.x*s,this.y*s,this.z*s);var o=a;Math.abs(i.x)<.9?(o.set(1,0,0),i.cross(o,e)):(o.set(0,1,0),i.cross(o,e)),i.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},s.prototype.toString=function(){return this.x+","+this.y+","+this.z},s.prototype.toArray=function(){return[this.x,this.y,this.z]},s.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},s.prototype.lerp=function(e,t,n){var i=this.x,s=this.y,r=this.z;n.x=i+(e.x-i)*t,n.y=s+(e.y-s)*t,n.z=r+(e.z-r)*t},s.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},s.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var o=new s;s.prototype.isAntiparallelTo=function(e,t){return this.negate(o),o.almostEquals(e,t)},s.prototype.clone=function(){return new s(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(e,t,n){t.exports=c;var i=e("../utils/EventTarget");e("../shapes/Shape");var s=e("../math/Vec3"),r=e("../math/Mat3"),a=e("../math/Quaternion");e("../material/Material");var o=e("../collision/AABB"),l=e("../shapes/Box");function c(e){e=e||{},i.apply(this),this.id=c.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:1,this.collisionResponse=!0,this.position=new s,e.position&&this.position.copy(e.position),this.previousPosition=new s,this.initPosition=new s,this.velocity=new s,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new s,this.force=new s;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?c.STATIC:c.DYNAMIC,typeof e.type==typeof c.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new a,e.quaternion&&this.quaternion.copy(e.quaternion),this.initQuaternion=new a,this.angularVelocity=new s,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new s,this.interpolatedPosition=new s,this.interpolatedQuaternion=new a,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.aabb=new o,this.aabbNeedsUpdate=!0,this.wlambda=new s,e.shape&&this.addShape(e.shape),this.updateMassProperties()}c.prototype=new i,c.prototype.constructor=c,c.DYNAMIC=1,c.STATIC=2,c.KINEMATIC=4,c.AWAKE=0,c.SLEEPY=1,c.SLEEPING=2,c.idCounter=0,c.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,e===c.SLEEPING&&this.dispatchEvent({type:"wakeup"})},c.prototype.sleep=function(){this.sleepState=c.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},c.sleepyEvent={type:"sleepy"},c.sleepEvent={type:"sleep"},c.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);t===c.AWAKE&&n<i?(this.sleepState=c.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(c.sleepyEvent)):t===c.SLEEPY&&n>i?this.wakeUp():t===c.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(c.sleepEvent))}},c.prototype.updateSolveMassProperties=function(){this.sleepState===c.SLEEPING||this.type===c.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},c.prototype.pointToLocalFrame=function(e,t){return t=t||new s,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},c.prototype.vectorToLocalFrame=function(e,t){return t=t||new s,this.quaternion.conjugate().vmult(e,t),t},c.prototype.pointToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},c.prototype.vectorToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t};var h=new s,u=new a;c.prototype.addShape=function(e,t,n){var i=new s,r=new a;return t&&i.copy(t),n&&r.copy(n),this.shapes.push(e),this.shapeOffsets.push(i),this.shapeOrientations.push(r),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},c.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,n=e.length,i=0,s=0;s!==n;s++){var r=e[s];r.updateBoundingSphereRadius();var a=t[s].norm(),o=r.boundingSphereRadius;a+o>i&&(i=a+o)}this.boundingRadius=i};var d=new o;c.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,n=this.shapeOrientations,i=e.length,s=h,r=u,a=this.quaternion,o=this.aabb,l=d,c=0;c!==i;c++){var p=e[c];n[c].mult(a,r),r.vmult(t[c],s),s.vadd(this.position,s),p.calculateWorldAABB(s,r,l.lowerBound,l.upperBound),0===c?o.copy(l):o.extend(l)}this.aabbNeedsUpdate=!1};var p=new r,m=new r;new r,c.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var n=p,i=m;n.setRotationFromQuaternion(this.quaternion),n.transpose(i),n.scale(t,n),n.mmult(i,this.invInertiaWorld)}};var f=new s,g=new s;c.prototype.applyForce=function(e,t){if(this.type===c.DYNAMIC){var n=f;t.vsub(this.position,n);var i=g;n.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new s,x=new s;c.prototype.applyLocalForce=function(e,t){if(this.type===c.DYNAMIC){var n=v,i=x;this.vectorToWorldFrame(e,n),this.pointToWorldFrame(t,i),this.applyForce(n,i)}};var y=new s,_=new s,b=new s;c.prototype.applyImpulse=function(e,t){if(this.type===c.DYNAMIC){var n=y;t.vsub(this.position,n);var i=_;i.copy(e),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity);var s=b;n.cross(e,s),this.invInertiaWorld.vmult(s,s),this.angularVelocity.vadd(s,this.angularVelocity)}};var w=new s,S=new s;c.prototype.applyLocalImpulse=function(e,t){if(this.type===c.DYNAMIC){var n=w,i=S;this.vectorToWorldFrame(e,n),this.pointToWorldFrame(t,i),this.applyImpulse(n,i)}};var M=new s;c.prototype.updateMassProperties=function(){var e=M;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,n=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0),this.updateInertiaWorld(!0)},c.prototype.getVelocityAtWorldPoint=function(e,t){var n=new s;return e.vsub(this.position,n),this.angularVelocity.cross(n,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(e,t,n){e("./Body");var i=e("../math/Vec3"),s=e("../math/Quaternion");e("../collision/RaycastResult");var r=e("../collision/Ray"),a=e("../objects/WheelInfo");function o(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=o,new i,new i,new i;var l=new i,c=new i,h=new i;new r,o.prototype.addWheel=function(e){var t=new a(e=e||{}),n=this.wheelInfos.length;return this.wheelInfos.push(t),n},o.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new i,o.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},o.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},o.prototype.addToWorld=function(e){this.constraints,e.add(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},o.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},o.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,n=t.length,s=this.chassisBody,r=0;r<n;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*s.velocity.norm();var a=new i;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<n;r++)this.castRay(t[r]);this.updateSuspension(e);var o=new i,l=new i;for(r=0;r<n;r++){var c=(p=t[r]).suspensionForce;c>p.maxSuspensionForce&&(c=p.maxSuspensionForce),p.raycastResult.hitNormalWorld.scale(c*e,o),p.raycastResult.hitPointWorld.vsub(s.position,l),s.applyImpulse(o,p.raycastResult.hitPointWorld)}this.updateFriction(e);var h=new i,u=new i,d=new i;for(r=0;r<n;r++){var p=t[r];s.getVelocityAtWorldPoint(p.chassisConnectionPointWorld,d);var m=1;if(1===this.indexUpAxis&&(m=-1),p.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var f=u.dot(p.raycastResult.hitNormalWorld);p.raycastResult.hitNormalWorld.scale(f,h),u.vsub(h,u);var g=u.dot(d);p.deltaRotation=m*g*e/p.radius}!p.sliding&&p.isInContact||0===p.engineForce||!p.useCustomSlidingRotationalSpeed||(p.deltaRotation=(p.engineForce>0?1:-1)*p.customSlidingRotationalSpeed*e),Math.abs(p.brake)>Math.abs(p.engineForce)&&(p.deltaRotation=0),p.rotation+=p.deltaRotation,p.deltaRotation*=.99}},o.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,n=this.wheelInfos,i=n.length,s=0;s<i;s++){var r=n[s];if(r.isInContact){var a,o=r.suspensionRestLength-r.suspensionLength;a=r.suspensionStiffness*o*r.clippedInvContactDotSuspension;var l=r.suspensionRelativeVelocity;a-=(l<0?r.dampingCompression:r.dampingRelaxation)*l,r.suspensionForce=a*t,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}},o.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new i,d=new i;o.prototype.castRay=function(e){var t=u,n=d;this.updateWheelTransformWorld(e);var s=this.chassisBody,r=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var o=e.chassisConnectionPointWorld;o.vadd(t,n);var l=e.raycastResult;l.reset();var c=s.collisionResponse;s.collisionResponse=!1,this.world.rayTest(o,n,l),s.collisionResponse=c;var h=l.body;if(e.raycastResult.groundObject=0,h){r=l.distance,e.raycastResult.hitNormalWorld=l.hitNormalWorld,e.isInContact=!0;var p=l.distance;e.suspensionLength=p-e.radius;var m=e.suspensionRestLength-e.maxSuspensionTravel,f=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<m&&(e.suspensionLength=m),e.suspensionLength>f&&(e.suspensionLength=f,e.raycastResult.reset());var g=e.raycastResult.hitNormalWorld.dot(e.directionWorld),v=new i;s.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,v);var x=e.raycastResult.hitNormalWorld.dot(v);if(g>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var y=-1/g;e.suspensionRelativeVelocity=x*y,e.clippedInvContactDotSuspension=y}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return r},o.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},o.prototype.updateWheelTransform=function(e){var t=l,n=c,i=h,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),r.directionLocal.scale(-1,t),n.copy(r.axleLocal),t.cross(n,i),i.normalize(),n.normalize();var a=r.steering,o=new s;o.setFromAxisAngle(t,a);var u=new s;u.setFromAxisAngle(n,r.rotation);var d=r.worldTransform.quaternion;this.chassisBody.quaternion.mult(o,d),d.mult(u,d),d.normalize();var p=r.worldTransform.position;p.copy(r.directionWorld),p.scale(r.suspensionLength,p),p.vadd(r.chassisConnectionPointWorld,p)};var p=[new i(1,0,0),new i(0,1,0),new i(0,0,1)];o.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var m=new i,f=[],g=[];o.prototype.updateFriction=function(e){for(var t=m,n=this.wheelInfos,s=n.length,r=this.chassisBody,a=g,o=f,l=0;l<s;l++){var c=(E=n[l]).raycastResult.body;E.sideImpulse=0,E.forwardImpulse=0,a[l]||(a[l]=new i),o[l]||(o[l]=new i)}for(l=0;l<s;l++)if(c=(E=n[l]).raycastResult.body){var h=o[l];this.getWheelTransformWorld(l).vectorToWorldFrame(p[this.indexRightAxis],h);var u=E.raycastResult.hitNormalWorld,d=h.dot(u);u.scale(d,t),h.vsub(t,h),h.normalize(),u.cross(h,a[l]),a[l].normalize(),E.sideImpulse=N(r,E.raycastResult.hitPointWorld,c,E.raycastResult.hitPointWorld,h),E.sideImpulse*=1}for(this.sliding=!1,l=0;l<s;l++){c=(E=n[l]).raycastResult.body;var v=0;if(E.slipInfo=1,c){var x=E.brake?E.brake:0;v=_(r,c,E.raycastResult.hitPointWorld,a[l],x);var y=x/(v+=E.engineForce*e);E.slipInfo*=y}if(E.forwardImpulse=0,E.skidInfo=1,c){E.skidInfo=1;var b=E.suspensionForce*e*E.frictionSlip,w=b*b;E.forwardImpulse=v;var S=.5*E.forwardImpulse,M=1*E.sideImpulse,T=S*S+M*M;E.sliding=!1,T>w&&(this.sliding=!0,E.sliding=!0,y=b/Math.sqrt(T),E.skidInfo*=y)}}if(this.sliding)for(l=0;l<s;l++)0!==(E=n[l]).sideImpulse&&E.skidInfo<1&&(E.forwardImpulse*=E.skidInfo,E.sideImpulse*=E.skidInfo);for(l=0;l<s;l++){var E=n[l],C=new i;if(C.copy(E.raycastResult.hitPointWorld),0!==E.forwardImpulse){var A=new i;a[l].scale(E.forwardImpulse,A),r.applyImpulse(A,C)}if(0!==E.sideImpulse){c=E.raycastResult.body;var R=new i;R.copy(E.raycastResult.hitPointWorld);var P=new i;o[l].scale(E.sideImpulse,P),r.pointToLocalFrame(C,C),C["xyz"[this.indexUpAxis]]*=E.rollInfluence,r.pointToWorldFrame(C,C),r.applyImpulse(P,C),P.scale(-1,P),c.applyImpulse(P,R)}}};var v=new i,x=new i,y=new i;function _(e,t,n,i,s){var r=0,a=n,o=v,l=x,c=y;return e.getVelocityAtWorldPoint(a,o),t.getVelocityAtWorldPoint(a,l),o.vsub(l,c),s<(r=-i.dot(c)*(1/(T(e,n,i)+T(t,n,i))))&&(r=s),r<-s&&(r=-s),r}var b=new i,w=new i,S=new i,M=new i;function T(e,t,n){var i=b,s=w,r=S,a=M;return t.vsub(e.position,i),i.cross(n,s),e.invInertiaWorld.vmult(s,a),a.cross(i,r),e.invMass+n.dot(r)}var E=new i,C=new i,A=new i;function N(e,t,n,i,s,r){if(s.norm2()>1.1)return 0;var a=E,o=C,l=A;return e.getVelocityAtWorldPoint(t,a),n.getVelocityAtWorldPoint(i,o),a.vsub(o,l),-.2*s.dot(l)*(1/(e.invMass+n.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(e,t,n){var i=e("./Body"),s=e("../shapes/Sphere"),r=e("../shapes/Box"),a=e("../math/Vec3"),o=e("../constraints/HingeConstraint");function l(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new a(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new r(new a(5,2,.5));this.chassisBody=new i(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}t.exports=l,l.prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new i(1,new s(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0),new a;var n=void 0!==e.position?e.position.clone():new a,r=new a;this.chassisBody.pointToWorldFrame(n,r),t.position.set(r.x,r.y,r.z);var l=void 0!==e.axis?e.axis.clone():new a(0,1,0);this.wheelAxes.push(l);var c=new o(this.chassisBody,t,{pivotA:n,axisA:l,pivotB:a.ZERO,axisB:l,collideConnected:!1});return this.constraints.push(c),this.wheelBodies.length-1},l.prototype.setSteeringValue=function(e,t){var n=this.wheelAxes[t],i=Math.cos(e),s=Math.sin(e),r=n.x,a=n.y;this.constraints[t].axisA.set(i*r-s*a,s*r+i*a,0)},l.prototype.setMotorSpeed=function(e,t){var n=this.constraints[t];n.enableMotor(),n.motorTargetVelocity=e},l.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var c=new a;l.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},l.prototype.applyWheelForce=function(e,t){var n=this.wheelAxes[t],i=this.wheelBodies[t],s=i.torque;n.scale(e,c),i.vectorToWorldFrame(c,c),s.vadd(c,s)},l.prototype.addToWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.add(n[i]);for(i=0;i<t.length;i++)e.addConstraint(t[i]);e.addEventListener("preStep",this._update.bind(this))},l.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},l.prototype.removeFromWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.remove(n[i]);for(i=0;i<t.length;i++)e.removeConstraint(t[i])};var h=new a;l.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],n=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,h),n.dot(h)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(e,t,n){t.exports=s,e("../shapes/Shape");var i=e("../math/Vec3");function s(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),s.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},s.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new i;s.prototype.getNeighbors=function(e,t){for(var n=this.particles.length,i=e.id,s=this.smoothingRadius*this.smoothingRadius,a=r,o=0;o!==n;o++){var l=this.particles[o];l.position.vsub(e.position,a),i!==l.id&&a.norm2()<s&&t.push(l)}};var a=new i,o=new i,l=new i,c=new i,h=new i,u=new i;s.prototype.update=function(){for(var e=this.particles.length,t=a,n=this.speedOfSound,i=this.eps,s=0;s!==e;s++){var r=this.particles[s];(M=this.neighbors[s]).length=0,this.getNeighbors(r,M),M.push(this.particles[s]);for(var d=M.length,p=0,m=0;m!==d;m++){r.position.vsub(M[m].position,t);var f=t.norm(),g=this.w(f);p+=M[m].mass*g}this.densities[s]=p,this.pressures[s]=n*n*(this.densities[s]-this.density)}var v=o,x=l,y=c,_=h,b=u;for(s=0;s!==e;s++){var w,S,M,T=this.particles[s];for(v.set(0,0,0),x.set(0,0,0),d=(M=this.neighbors[s]).length,m=0;m!==d;m++){var E=M[m];T.position.vsub(E.position,_);var C=_.norm();w=-E.mass*(this.pressures[s]/(this.densities[s]*this.densities[s]+i)+this.pressures[m]/(this.densities[m]*this.densities[m]+i)),this.gradw(_,y),y.mult(w,y),v.vadd(y,v),E.velocity.vsub(T.velocity,b),b.mult(1/(1e-4+this.densities[s]*this.densities[m])*this.viscosity*E.mass,b),S=this.nablaw(C),b.mult(S,b),x.vadd(b,x)}x.mult(T.mass,x),v.mult(T.mass,v),T.force.vadd(x,T.force),T.force.vadd(v,T.force)}},s.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},s.prototype.gradw=function(e,t){var n=e.norm(),i=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-n*n,2),t)},s.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(e,t,n){var i=e("../math/Vec3");function s(e,t,n){n=n||{},this.restLength="number"==typeof n.restLength?n.restLength:1,this.stiffness=n.stiffness||100,this.damping=n.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new i,this.localAnchorB=new i,n.localAnchorA&&this.localAnchorA.copy(n.localAnchorA),n.localAnchorB&&this.localAnchorB.copy(n.localAnchorB),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB)}t.exports=s,s.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},s.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},s.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},s.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var r=new i,a=new i,o=new i,l=new i,c=new i,h=new i,u=new i,d=new i,p=new i,m=new i,f=new i;s.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,n=this.restLength,i=this.bodyA,s=this.bodyB,g=r,v=a,x=o,y=l,_=f,b=c,w=h,S=u,M=d,T=p,E=m;this.getWorldAnchorA(b),this.getWorldAnchorB(w),b.vsub(i.position,S),w.vsub(s.position,M),w.vsub(b,g);var C=g.norm();v.copy(g),v.normalize(),s.velocity.vsub(i.velocity,x),s.angularVelocity.cross(M,_),x.vadd(_,x),i.angularVelocity.cross(S,_),x.vsub(_,x),v.mult(-e*(C-n)-t*x.dot(v),y),i.force.vsub(y,i.force),s.force.vadd(y,s.force),S.cross(y,T),M.cross(y,E),i.torque.vsub(T,i.torque),s.torque.vadd(E,s.torque)}},{"../math/Vec3":30}],36:[function(e,t,n){var i=e("../math/Vec3"),s=e("../math/Transform"),r=e("../collision/RaycastResult"),a=e("../utils/Utils");function o(e){e=a.defaults(e,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,axleWorld:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new s,this.isInContact=!1}t.exports=o;var l=new i,c=new i;l=new i,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var n=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,l);var i=t.hitNormalWorld.dot(l);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var s=-1/n;this.suspensionRelativeVelocity=i*s,this.clippedInvContactDotSuspension=s}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(e,t,n){t.exports=a;var i=e("./Shape"),s=e("../math/Vec3"),r=e("./ConvexPolyhedron");function a(e){i.call(this),this.type=i.types.BOX,this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}a.prototype=new i,a.prototype.constructor=a,a.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,n=this.halfExtents.z,i=s,a=[new i(-e,-t,-n),new i(e,-t,-n),new i(e,t,-n),new i(-e,t,-n),new i(-e,-t,n),new i(e,-t,n),new i(e,t,n),new i(-e,t,n)];new i(0,0,1),new i(0,1,0),new i(1,0,0);var o=new r(a,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]);this.convexPolyhedronRepresentation=o,o.material=this.material},a.prototype.calculateLocalInertia=function(e,t){return t=t||new s,a.calculateInertia(this.halfExtents,e,t),t},a.calculateInertia=function(e,t,n){var i=e;n.x=1/12*t*(2*i.y*2*i.y+2*i.z*2*i.z),n.y=1/12*t*(2*i.x*2*i.x+2*i.z*2*i.z),n.z=1/12*t*(2*i.y*2*i.y+2*i.x*2*i.x)},a.prototype.getSideNormals=function(e,t){var n=e,i=this.halfExtents;if(n[0].set(i.x,0,0),n[1].set(0,i.y,0),n[2].set(0,0,i.z),n[3].set(-i.x,0,0),n[4].set(0,-i.y,0),n[5].set(0,0,-i.z),void 0!==t)for(var s=0;s!==n.length;s++)t.vmult(n[s],n[s]);return n},a.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var o=new s;new s,a.prototype.forEachWorldCorner=function(e,t,n){for(var i=this.halfExtents,s=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],r=0;r<s.length;r++)o.set(s[r][0],s[r][1],s[r][2]),t.vmult(o,o),e.vadd(o,o),n(o.x,o.y,o.z)};var l=[new s,new s,new s,new s,new s,new s,new s,new s];a.prototype.calculateWorldAABB=function(e,t,n,i){var s=this.halfExtents;l[0].set(s.x,s.y,s.z),l[1].set(-s.x,s.y,s.z),l[2].set(-s.x,-s.y,s.z),l[3].set(-s.x,-s.y,-s.z),l[4].set(s.x,-s.y,-s.z),l[5].set(s.x,s.y,-s.z),l[6].set(-s.x,s.y,-s.z),l[7].set(s.x,-s.y,s.z);var r=l[0];t.vmult(r,r),e.vadd(r,r),i.copy(r),n.copy(r);for(var a=1;a<8;a++){r=l[a],t.vmult(r,r),e.vadd(r,r);var o=r.x,c=r.y,h=r.z;o>i.x&&(i.x=o),c>i.y&&(i.y=c),h>i.z&&(i.z=h),o<n.x&&(n.x=o),c<n.y&&(n.y=c),h<n.z&&(n.z=h)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(e,t,n){t.exports=a;var i=e("./Shape"),s=e("../math/Vec3");e("../math/Quaternion");var r=e("../math/Transform");function a(e,t,n){i.call(this),this.type=i.types.CONVEXPOLYHEDRON,this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=n?n.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}a.prototype=new i,a.prototype.constructor=a;var o=new s;a.prototype.computeEdges=function(){var e=this.faces,t=this.vertices;t.length;var n=this.uniqueEdges;n.length=0;for(var i=o,s=0;s!==e.length;s++)for(var r=e[s],a=r.length,l=0;l!==a;l++){var c=(l+1)%a;t[r[l]].vsub(t[r[c]],i),i.normalize();for(var h=!1,u=0;u!==n.length;u++)if(n[u].almostEquals(i)||n[u].almostEquals(i)){h=!0;break}h||n.push(i.clone())}},a.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var n=this.faceNormals[e]||new s;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n;var i=this.vertices[this.faces[e][0]];if(n.dot(i)<0)for(t=0;t<this.faces[e].length;t++);}};var l=new s,c=new s;a.computeNormal=function(e,t,n,i){t.vsub(e,c),n.vsub(t,l),l.cross(c,i),i.isZero()||i.normalize()},a.prototype.getFaceNormal=function(e,t){var n=this.faces[e],i=this.vertices[n[0]],s=this.vertices[n[1]],r=this.vertices[n[2]];return a.computeNormal(i,s,r,t)};var h=new s;a.prototype.clipAgainstHull=function(e,t,n,i,r,a,o,l,c){for(var u=h,d=-1,p=-Number.MAX_VALUE,m=0;m<n.faces.length;m++){u.copy(n.faceNormals[m]),r.vmult(u,u);var f=u.dot(a);f>p&&(p=f,d=m)}for(var g=[],v=n.faces[d],x=v.length,y=0;y<x;y++){var _=n.vertices[v[y]],b=new s;b.copy(_),r.vmult(b,b),i.vadd(b,b),g.push(b)}d>=0&&this.clipFaceAgainstHull(a,e,t,g,o,l,c)};var u=new s,d=new s,p=new s,m=new s,f=new s,g=new s;a.prototype.findSeparatingAxis=function(e,t,n,i,s,r,a,o){var l=u,c=d,h=p,v=m,x=f,y=g,_=Number.MAX_VALUE,b=this;if(b.uniqueAxes)for(S=0;S!==b.uniqueAxes.length;S++){if(n.vmult(b.uniqueAxes[S],l),!1===(E=b.testSepAxis(l,e,t,n,i,s)))return!1;E<_&&(_=E,r.copy(l))}else for(var w=a?a.length:b.faces.length,S=0;S<w;S++){var M=a?a[S]:S;if(l.copy(b.faceNormals[M]),n.vmult(l,l),!1===(E=b.testSepAxis(l,e,t,n,i,s)))return!1;E<_&&(_=E,r.copy(l))}if(e.uniqueAxes)for(S=0;S!==e.uniqueAxes.length;S++){if(s.vmult(e.uniqueAxes[S],c),!1===(E=b.testSepAxis(c,e,t,n,i,s)))return!1;E<_&&(_=E,r.copy(c))}else{var T=o?o.length:e.faces.length;for(S=0;S<T;S++){var E;if(M=o?o[S]:S,c.copy(e.faceNormals[M]),s.vmult(c,c),!1===(E=b.testSepAxis(c,e,t,n,i,s)))return!1;E<_&&(_=E,r.copy(c))}}for(var C=0;C!==b.uniqueEdges.length;C++){n.vmult(b.uniqueEdges[C],v);for(var A=0;A!==e.uniqueEdges.length;A++)if(s.vmult(e.uniqueEdges[A],x),v.cross(x,y),!y.almostZero()){y.normalize();var N=b.testSepAxis(y,e,t,n,i,s);if(!1===N)return!1;N<_&&(_=N,r.copy(y))}}return i.vsub(t,h),h.dot(r)>0&&r.negate(r),!0};var v=[],x=[];a.prototype.testSepAxis=function(e,t,n,i,s,r){a.project(this,e,n,i,v),a.project(t,e,s,r,x);var o=v[0]-x[1],l=x[0]-v[1];return o<l?o:l};var y=new s,_=new s;a.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y,_);var n=_.x-y.x,i=_.y-y.y,s=_.z-y.z;t.x=1/12*e*(2*i*2*i+2*s*2*s),t.y=1/12*e*(2*n*2*n+2*s*2*s),t.z=1/12*e*(2*i*2*i+2*n*2*n)},a.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],n=this.faceNormals[e],i=this.vertices[t[0]];return-n.dot(i)};var b=new s,w=new s,S=new s,M=new s,T=new s,E=new s,C=new s,A=new s;a.prototype.clipFaceAgainstHull=function(e,t,n,i,s,r,a){for(var o=b,l=w,c=S,h=M,u=T,d=E,p=C,m=A,f=this,g=i,v=[],x=-1,y=Number.MAX_VALUE,_=0;_<f.faces.length;_++){o.copy(f.faceNormals[_]),n.vmult(o,o);var N=o.dot(e);N<y&&(y=N,x=_)}if(!(x<0)){var R=f.faces[x];R.connectedFaces=[];for(var P=0;P<f.faces.length;P++)for(var I=0;I<f.faces[P].length;I++)-1!==R.indexOf(f.faces[P][I])&&P!==x&&-1===R.connectedFaces.indexOf(P)&&R.connectedFaces.push(P);g.length;for(var j=R.length,D=0;D<j;D++){var k=f.vertices[R[D]],L=f.vertices[R[(D+1)%j]];k.vsub(L,l),c.copy(l),n.vmult(c,c),t.vadd(c,c),h.copy(this.faceNormals[x]),n.vmult(h,h),t.vadd(h,h),c.cross(h,u),u.negate(u),d.copy(k),n.vmult(d,d),t.vadd(d,d),d.dot(u);var O=R.connectedFaces[D];p.copy(this.faceNormals[O]);var U=this.getPlaneConstantOfFace(O);m.copy(p),n.vmult(m,m);var F=U-m.dot(t);for(this.clipFaceAgainstPlane(g,v,m,F);g.length;)g.shift();for(;v.length;)g.push(v.shift())}for(p.copy(this.faceNormals[x]),U=this.getPlaneConstantOfFace(x),m.copy(p),n.vmult(m,m),F=U-m.dot(t),P=0;P<g.length;P++){var B=m.dot(g[P])+F;if(B<=s&&(B=s),B<=r){var z=g[P];if(B<=0){var V={point:z,normal:m,depth:B};a.push(V)}}}}},a.prototype.clipFaceAgainstPlane=function(e,t,n,i){var r,a,o=e.length;if(o<2)return t;var l=e[e.length-1],c=e[0];r=n.dot(l)+i;for(var h=0;h<o;h++){if(c=e[h],a=n.dot(c)+i,r<0)if(a<0)(u=new s).copy(c),t.push(u);else{var u=new s;l.lerp(c,r/(r-a),u),t.push(u)}else a<0&&(u=new s,l.lerp(c,r/(r-a),u),t.push(u),t.push(c));l=c,r=a}return t},a.prototype.computeWorldVertices=function(e,t){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new s);for(var i=this.vertices,r=this.worldVertices,a=0;a!==n;a++)t.vmult(i[a],r[a]),e.vadd(r[a],r[a]);this.worldVerticesNeedsUpdate=!1},new s,a.prototype.computeLocalAABB=function(e,t){var n=this.vertices.length,i=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;s<n;s++){var r=i[s];r.x<e.x?e.x=r.x:r.x>t.x&&(t.x=r.x),r.y<e.y?e.y=r.y:r.y>t.y&&(t.y=r.y),r.z<e.z?e.z=r.z:r.z>t.z&&(t.z=r.z)}},a.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new s);for(var n=this.faceNormals,i=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(n[r],i[r]);this.worldFaceNormalsNeedsUpdate=!1},a.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=0,i=t.length;n!==i;n++){var s=t[n].norm2();s>e&&(e=s)}this.boundingSphereRadius=Math.sqrt(e)};var N=new s;a.prototype.calculateWorldAABB=function(e,t,n,i){for(var s,r,a,o,l,c,h=this.vertices.length,u=this.vertices,d=0;d<h;d++){N.copy(u[d]),t.vmult(N,N),e.vadd(N,N);var p=N;p.x<s||void 0===s?s=p.x:(p.x>o||void 0===o)&&(o=p.x),p.y<r||void 0===r?r=p.y:(p.y>l||void 0===l)&&(l=p.y),p.z<a||void 0===a?a=p.z:(p.z>c||void 0===c)&&(c=p.z)}n.set(s,r,a),i.set(o,l,c)},a.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},a.prototype.getAveragePointLocal=function(e){e=e||new s;for(var t=this.vertices.length,n=this.vertices,i=0;i<t;i++)e.vadd(n[i],e);return e.mult(1/t,e),e},a.prototype.transformAllPoints=function(e,t){var n=this.vertices.length,i=this.vertices;if(t){for(var s=0;s<n;s++){var r=i[s];t.vmult(r,r)}for(s=0;s<this.faceNormals.length;s++)r=this.faceNormals[s],t.vmult(r,r)}if(e)for(s=0;s<n;s++)(r=i[s]).vadd(e,r)};var R=new s,P=new s,I=new s;a.prototype.pointIsInside=function(e){var t=this.vertices.length,n=this.vertices,i=this.faces,s=this.faceNormals,r=this.faces.length,a=R;this.getAveragePointLocal(a);for(var o=0;o<r;o++){this.faces[o].length,t=s[o];var l=n[i[o][0]],c=P;e.vsub(l,c);var h=t.dot(c),u=I;a.vsub(l,u);var d=t.dot(u);if(h<0&&d>0||h>0&&d<0)return!1}return-1},new s;var j=new s,D=new s;a.project=function(e,t,n,i,s){var a=e.vertices.length,o=j,l=0,c=0,h=D,u=e.vertices;h.setZero(),r.vectorToLocalFrame(n,i,t,o),r.pointToLocalFrame(n,i,h,h);var d=h.dot(o);c=l=u[0].dot(o);for(var p=1;p<a;p++){var m=u[p].dot(o);m>l&&(l=m),m<c&&(c=m)}if((c-=d)>(l-=d)){var f=c;c=l,l=f}s[0]=l,s[1]=c}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(e,t,n){t.exports=a;var i=e("./Shape"),s=e("../math/Vec3");e("../math/Quaternion");var r=e("./ConvexPolyhedron");function a(e,t,n,a){var o=a,l=[],c=[],h=[],u=[],d=[],p=Math.cos,m=Math.sin;l.push(new s(t*p(0),t*m(0),.5*-n)),u.push(0),l.push(new s(e*p(0),e*m(0),.5*n)),d.push(1);for(var f=0;f<o;f++){var g=2*Math.PI/o*(f+1),v=2*Math.PI/o*(f+.5);f<o-1?(l.push(new s(t*p(g),t*m(g),.5*-n)),u.push(2*f+2),l.push(new s(e*p(g),e*m(g),.5*n)),d.push(2*f+3),h.push([2*f+2,2*f+3,2*f+1,2*f])):h.push([0,1,2*f+1,2*f]),(o%2==1||f<o/2)&&c.push(new s(p(v),m(v),0))}h.push(d),c.push(new s(0,0,1));var x=[];for(f=0;f<u.length;f++)x.push(u[u.length-f-1]);h.push(x),this.type=i.types.CONVEXPOLYHEDRON,r.call(this,l,h,c)}a.prototype=new r},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(e,t,n){var i=e("./Shape"),s=e("./ConvexPolyhedron"),r=e("../math/Vec3"),a=e("../utils/Utils");function o(e,t){t=a.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,i.call(this),this.pillarConvex=new s,this.pillarOffset=new r,this.type=i.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}t.exports=o,o.prototype=new i,o.prototype.update=function(){this._cachedPillars={}},o.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var s=e[n][i];s<t&&(t=s)}this.minValue=t},o.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var s=e[n][i];s>t&&(t=s)}this.maxValue=t},o.prototype.setHeightValueAtIndex=function(e,t,n){this.data[e][t]=n,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},o.prototype.getRectMinMax=function(e,t,n,i,s){s=s||[];for(var r=this.data,a=this.minValue,o=e;o<=n;o++)for(var l=t;l<=i;l++){var c=r[o][l];c>a&&(a=c)}s[0]=this.minValue,s[1]=a},o.prototype.getIndexOfPosition=function(e,t,n,i){var s=this.elementSize,r=this.data,a=Math.floor(e/s),o=Math.floor(t/s);return n[0]=a,n[1]=o,i&&(a<0&&(a=0),o<0&&(o=0),a>=r.length-1&&(a=r.length-1),o>=r[0].length-1&&(o=r[0].length-1)),!(a<0||o<0||a>=r.length-1||o>=r[0].length-1)},o.prototype.getHeightAt=function(e,t,n){var i=[];this.getIndexOfPosition(e,t,i,n);var s=[];return this.getRectMinMax(i[0],i[1]+1,i[0],i[1]+1,s),(s[0]+s[1])/2},o.prototype.getCacheConvexTrianglePillarKey=function(e,t,n){return e+"_"+t+"_"+(n?1:0)},o.prototype.getCachedConvexTrianglePillar=function(e,t,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},o.prototype.setCachedConvexTrianglePillar=function(e,t,n,i,s){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]={convex:i,offset:s}},o.prototype.clearCachedConvexTrianglePillar=function(e,t,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},o.prototype.getConvexTrianglePillar=function(e,t,n){var i=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){if(o=this.getCachedConvexTrianglePillar(e,t,n))return this.pillarConvex=o.convex,void(this.pillarOffset=o.offset);i=new s,a=new r,this.pillarConvex=i,this.pillarOffset=a}var o=this.data,l=this.elementSize,c=i.faces;i.vertices.length=6;for(var h=0;h<6;h++)i.vertices[h]||(i.vertices[h]=new r);for(c.length=5,h=0;h<5;h++)c[h]||(c[h]=[]);var u=i.vertices,d=(Math.min(o[e][t],o[e+1][t],o[e][t+1],o[e+1][t+1])-this.minValue)/2+this.minValue;n?(a.set((e+.75)*l,(t+.75)*l,d),u[0].set(.25*l,.25*l,o[e+1][t+1]-d),u[1].set(-.75*l,.25*l,o[e][t+1]-d),u[2].set(.25*l,-.75*l,o[e+1][t]-d),u[3].set(.25*l,.25*l,-d-1),u[4].set(-.75*l,.25*l,-d-1),u[5].set(.25*l,-.75*l,-d-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=2,c[2][1]=5,c[2][2]=3,c[2][3]=0,c[3][0]=3,c[3][1]=4,c[3][2]=1,c[3][3]=0,c[4][0]=1,c[4][1]=4,c[4][2]=5,c[4][3]=2):(a.set((e+.25)*l,(t+.25)*l,d),u[0].set(-.25*l,-.25*l,o[e][t]-d),u[1].set(.75*l,-.25*l,o[e+1][t]-d),u[2].set(-.25*l,.75*l,o[e][t+1]-d),u[3].set(-.25*l,-.25*l,-d-1),u[4].set(.75*l,-.25*l,-d-1),u[5].set(-.25*l,.75*l,-d-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=0,c[2][1]=2,c[2][2]=5,c[2][3]=3,c[3][0]=1,c[3][1]=0,c[3][2]=3,c[3][3]=4,c[4][0]=4,c[4][1]=5,c[4][2]=2,c[4][3]=1),i.computeNormals(),i.computeEdges(),i.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,n,i,a)},o.prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},o.prototype.volume=function(){return Number.MAX_VALUE},o.prototype.calculateWorldAABB=function(e,t,n,i){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},o.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new r(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(e,t,n){t.exports=r;var i=e("./Shape"),s=e("../math/Vec3");function r(){i.call(this),this.type=i.types.PARTICLE}r.prototype=new i,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){return(t=t||new s).set(0,0,0),t},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(e,t,n,i){n.copy(e),i.copy(e)}},{"../math/Vec3":30,"./Shape":43}],42:[function(e,t,n){t.exports=r;var i=e("./Shape"),s=e("../math/Vec3");function r(){i.call(this),this.type=i.types.PLANE,this.worldNormal=new s,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new i,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(e,t){return t||new s},r.prototype.volume=function(){return Number.MAX_VALUE};var a=new s;r.prototype.calculateWorldAABB=function(e,t,n,i){a.set(0,0,1),t.vmult(a,a);var s=Number.MAX_VALUE;n.set(-s,-s,-s),i.set(s,s,s),1===a.x&&(i.x=e.x),1===a.y&&(i.y=e.y),1===a.z&&(i.z=e.z),-1===a.x&&(n.x=e.x),-1===a.y&&(n.y=e.y),-1===a.z&&(n.z=e.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(e,t,n){t.exports=i;var i=e("./Shape");function i(){this.id=i.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(e,t,n){t.exports=r;var i=e("./Shape"),s=e("../math/Vec3");function r(e){if(i.call(this),this.radius=void 0!==e?Number(e):1,this.type=i.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new i,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){t=t||new s;var n=2*e*this.radius*this.radius/5;return t.x=n,t.y=n,t.z=n,t},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(e,t,n,i){for(var s=this.radius,r=["x","y","z"],a=0;a<r.length;a++){var o=r[a];n[o]=e[o]-s,i[o]=e[o]+s}}},{"../math/Vec3":30,"./Shape":43}],45:[function(e,t,n){t.exports=l;var i=e("./Shape"),s=e("../math/Vec3");e("../math/Quaternion");var r=e("../math/Transform"),a=e("../collision/AABB"),o=e("../utils/Octree");function l(e,t){i.call(this),this.type=i.types.TRIMESH,this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new a,this.edges=null,this.scale=new s(1,1,1),this.tree=new o,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}l.prototype=new i,l.prototype.constructor=l;var c=new s;l.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var n=new a,i=new s,r=new s,o=new s,l=[i,r,o],c=0;c<this.indices.length/3;c++){var h=3*c;this._getUnscaledVertex(this.indices[h],i),this._getUnscaledVertex(this.indices[h+1],r),this._getUnscaledVertex(this.indices[h+2],o),n.setFromPoints(l),e.insert(n,c)}e.removeEmptyNodes()};var h=new a;l.prototype.getTrianglesInAABB=function(e,t){h.copy(e);var n=this.scale,i=n.x,s=n.y,r=n.z,a=h.lowerBound,o=h.upperBound;return a.x/=i,a.y/=s,a.z/=r,o.x/=i,o.y/=s,o.z/=r,this.tree.aabbQuery(h,t)},l.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,n=e.x===e.y===e.z;t&&n||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},l.prototype.updateNormals=function(){for(var e=c,t=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,s=this.indices[i],r=this.indices[i+1],a=this.indices[i+2];this.getVertex(s,f),this.getVertex(r,g),this.getVertex(a,v),l.computeNormal(g,f,v,e),t[i]=e.x,t[i+1]=e.y,t[i+2]=e.z}},l.prototype.updateEdges=function(){for(var e={},t=function(t,n){e[s<r?s+"_"+r:r+"_"+s]=!0},n=0;n<this.indices.length/3;n++){var i=3*n,s=this.indices[i],r=this.indices[i+1];this.indices[i+2],t(),t(),t()}var a=Object.keys(e);for(this.edges=new Int16Array(2*a.length),n=0;n<a.length;n++){var o=a[n].split("_");this.edges[2*n]=parseInt(o[0],10),this.edges[2*n+1]=parseInt(o[1],10)}},l.prototype.getEdgeVertex=function(e,t,n){var i=this.edges[2*e+(t?1:0)];this.getVertex(i,n)};var u=new s,d=new s;l.prototype.getEdgeVector=function(e,t){var n=u,i=d;this.getEdgeVertex(e,0,n),this.getEdgeVertex(e,1,i),i.vsub(n,t)};var p=new s,m=new s;l.computeNormal=function(e,t,n,i){t.vsub(e,m),n.vsub(t,p),p.cross(m,i),i.isZero()||i.normalize()};var f=new s,g=new s,v=new s;l.prototype.getVertex=function(e,t){var n=this.scale;return this._getUnscaledVertex(e,t),t.x*=n.x,t.y*=n.y,t.z*=n.z,t},l.prototype._getUnscaledVertex=function(e,t){var n=3*e,i=this.vertices;return t.set(i[n],i[n+1],i[n+2])},l.prototype.getWorldVertex=function(e,t,n,i){return this.getVertex(e,i),r.pointToWorldFrame(t,n,i,i),i},l.prototype.getTriangleVertices=function(e,t,n,i){var s=3*e;this.getVertex(this.indices[s],t),this.getVertex(this.indices[s+1],n),this.getVertex(this.indices[s+2],i)},l.prototype.getNormal=function(e,t){var n=3*e;return t.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var x=new a;l.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(x);var n=x.upperBound.x-x.lowerBound.x,i=x.upperBound.y-x.lowerBound.y,s=x.upperBound.z-x.lowerBound.z;return t.set(1/12*e*(2*i*2*i+2*s*2*s),1/12*e*(2*n*2*n+2*s*2*s),1/12*e*(2*i*2*i+2*n*2*n))};var y=new s;l.prototype.computeLocalAABB=function(e){var t=e.lowerBound,n=e.upperBound,i=this.vertices.length;this.vertices;var s=y;this.getVertex(0,s),t.copy(s),n.copy(s);for(var r=0;r!==i;r++)this.getVertex(r,s),s.x<t.x?t.x=s.x:s.x>n.x&&(n.x=s.x),s.y<t.y?t.y=s.y:s.y>n.y&&(n.y=s.y),s.z<t.z?t.z=s.z:s.z>n.z&&(n.z=s.z)},l.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},l.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=new s,i=0,r=t.length/3;i!==r;i++){this.getVertex(i,n);var a=n.norm2();a>e&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new s;var _=new r,b=new a;l.prototype.calculateWorldAABB=function(e,t,n,i){var s=_,r=b;s.position=e,s.quaternion=t,this.aabb.toWorldFrame(s,r),n.copy(r.lowerBound),i.copy(r.upperBound)},l.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},l.createTorus=function(e,t,n,i,s){e=e||1,t=t||.5,n=n||8,i=i||6,s=s||2*Math.PI;for(var r=[],a=[],o=0;o<=n;o++)for(var c=0;c<=i;c++){var h=c/i*s,u=o/n*Math.PI*2,d=(e+t*Math.cos(u))*Math.cos(h),p=(e+t*Math.cos(u))*Math.sin(h),m=t*Math.sin(u);r.push(d,p,m)}for(o=1;o<=n;o++)for(c=1;c<=i;c++){var f=(i+1)*o+c-1,g=(i+1)*(o-1)+c-1,v=(i+1)*(o-1)+c,x=(i+1)*o+c;a.push(f,g,x),a.push(g,v,x)}return new l(r,a)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(e,t,n){t.exports=s,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver");function s(){i.call(this),this.iterations=10,this.tolerance=1e-7}s.prototype=new i;var r=[],a=[],o=[];s.prototype.solve=function(e,t){var n,i,s,l,c,h=0,u=this.iterations,d=this.tolerance*this.tolerance,p=this.equations,m=p.length,f=t.bodies,g=f.length,v=e;if(0!==m)for(var x=0;x!==g;x++)f[x].updateSolveMassProperties();var y=a,_=o,b=r;for(y.length=m,_.length=m,b.length=m,x=0;x!==m;x++){var w=p[x];b[x]=0,_[x]=w.computeB(v),y[x]=1/w.computeC()}if(0!==m){for(x=0;x!==g;x++){var S=(E=f[x]).vlambda,M=E.wlambda;S.set(0,0,0),M&&M.set(0,0,0)}for(h=0;h!==u;h++){l=0;for(var T=0;T!==m;T++)w=p[T],n=_[T],i=y[T],(c=b[T])+(s=i*(n-w.computeGWlambda()-w.eps*c))<w.minForce?s=w.minForce-c:c+s>w.maxForce&&(s=w.maxForce-c),b[T]+=s,l+=s>0?s:-s,w.addToWlambda(s);if(l*l<d)break}for(x=0;x!==g;x++){var E,C=(E=f[x]).velocity,A=E.angularVelocity;C.vadd(E.vlambda,C),A&&A.vadd(E.wlambda,A)}}return h}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(e,t,n){function i(){this.equations=[]}t.exports=i,i.prototype.solve=function(e,t){return 0},i.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},i.prototype.removeEquation=function(e){var t=this.equations,n=t.indexOf(e);-1!==n&&t.splice(n,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(e,t,n){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver"),s=e("../objects/Body");function r(e){for(i.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new i;var a=[],o=[],l={bodies:[]},c=s.STATIC;function h(e){for(var t=e.length,n=0;n!==t;n++){var i=e[n];if(!(i.visited||i.body.type&c))return i}return!1}var u=[];function d(e,t,n,i){for(u.push(e),e.visited=!0,t(e,n,i);u.length;)for(var s,r=u.pop();s=h(r.children);)s.visited=!0,t(s,n,i),u.push(s)}function p(e,t,n){t.push(e.body);for(var i=e.eqs.length,s=0;s!==i;s++){var r=e.eqs[s];-1===n.indexOf(r)&&n.push(r)}}function m(e,t){return t.id-e.id}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(e,t){for(var n=a,i=this.nodePool,s=t.bodies,r=this.equations,c=r.length,u=s.length,f=this.subsolver;i.length<u;)i.push(this.createNode());n.length=u;for(var g=0;g<u;g++)n[g]=i[g];for(g=0;g!==u;g++){var v=n[g];v.body=s[g],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var x=0;x!==c;x++){var y=r[x],_=(g=s.indexOf(y.bi),s.indexOf(y.bj)),b=n[g],w=n[_];b.children.push(w),b.eqs.push(y),w.children.push(b),w.eqs.push(y)}var S,M=0,T=o;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var E=l;S=h(n);){T.length=0,E.bodies.length=0,d(S,p,E.bodies,T);var C=T.length;for(T=T.sort(m),g=0;g!==C;g++)f.addEquation(T[g]);f.solve(e,E),f.removeAllEquations(),M++}return M}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(e,t,n){var i=function(){};t.exports=i,i.prototype={constructor:i,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var i=n[e].indexOf(t);return-1!==i&&n[e].splice(i,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var n=0,i=t.length;n<i;n++)t[n].call(this,e)}return this}}},{}],50:[function(e,t,n){var i=e("../collision/AABB"),s=e("../math/Vec3");function r(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new i,this.data=[],this.children=[]}function a(e,t){(t=t||{}).root=null,t.aabb=e,r.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}t.exports=a,a.prototype=new r,r.prototype.reset=function(e,t){this.children.length=this.data.length=0},r.prototype.insert=function(e,t,n){var i=this.data;if(n=n||0,!this.aabb.contains(e))return!1;var s=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var r=!1;s.length||(this.subdivide(),r=!0);for(var a=0;8!==a;a++)if(s[a].insert(e,t,n+1))return!0;r&&(s.length=0)}return i.push(t),!0};var o=new s;r.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,n=e.upperBound,a=this.children;a.push(new r({aabb:new i({lowerBound:new s(0,0,0)})}),new r({aabb:new i({lowerBound:new s(1,0,0)})}),new r({aabb:new i({lowerBound:new s(1,1,0)})}),new r({aabb:new i({lowerBound:new s(1,1,1)})}),new r({aabb:new i({lowerBound:new s(0,1,1)})}),new r({aabb:new i({lowerBound:new s(0,0,1)})}),new r({aabb:new i({lowerBound:new s(1,0,1)})}),new r({aabb:new i({lowerBound:new s(0,1,0)})})),n.vsub(t,o),o.scale(.5,o);for(var l=this.root||this,c=0;8!==c;c++){var h=a[c];h.root=l;var u=h.aabb.lowerBound;u.x*=o.x,u.y*=o.y,u.z*=o.z,u.vadd(t,u),u.vadd(o,h.aabb.upperBound)}},r.prototype.aabbQuery=function(e,t){this.data,this.children;for(var n=[this];n.length;){var i=n.pop();i.aabb.overlaps(e)&&Array.prototype.push.apply(t,i.data),Array.prototype.push.apply(n,i.children)}return t};var l=new i;r.prototype.rayQuery=function(e,t,n){return e.getAABB(l),l.toLocalFrame(t,l),this.aabbQuery(l,n),n},r.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),n=t.children.length-1;n>=0;n--)t.children[n].data.length||t.children.splice(n,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(e,t,n){function i(){this.objects=[],this.type=Object}t.exports=i,i.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t])},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(e,t,n){function i(){this.data={keys:[]}}t.exports=i,i.prototype.get=function(e,t){if(e>t){var n=t;t=e,e=n}return this.data[e+"-"+t]},i.prototype.set=function(e,t,n){if(e>t){var i=t;t=e,e=i}var s=e+"-"+t;this.get(e,t)||this.data.keys.push(s),this.data[s]=n},i.prototype.reset=function(){for(var e=this.data,t=e.keys;t.length>0;)delete e[t.pop()]}},{}],53:[function(e,t,n){function i(){}t.exports=i,i.defaults=function(e,t){for(var n in e=e||{},t)n in e||(e[n]=t[n]);return e}},{}],54:[function(e,t,n){t.exports=r;var i=e("../math/Vec3"),s=e("./Pool");function r(){s.call(this),this.type=i}r.prototype=new s,r.prototype.constructObject=function(){return new i}},{"../math/Vec3":30,"./Pool":51}],55:[function(e,t,n){t.exports=d;var i=e("../collision/AABB"),s=e("../shapes/Shape"),r=e("../collision/Ray"),a=e("../math/Vec3"),o=e("../math/Transform");e("../shapes/ConvexPolyhedron");var l=e("../math/Quaternion");e("../solver/Solver");var c=e("../utils/Vec3Pool"),h=e("../equations/ContactEquation"),u=e("../equations/FrictionEquation");function d(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}d.prototype.createContactEquation=function(e,t,n,i,s,r){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new h(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&i.collisionResponse;var o=this.currentContactMaterial;a.restitution=o.restitution,a.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var l=n.material||e.material,c=i.material||t.material;return l&&c&&l.restitution>=0&&c.restitution>=0&&(a.restitution=l.restitution*c.restitution),a.si=s||n,a.sj=r||i,a},d.prototype.createFrictionEquationsFromContact=function(e,t){var n=e.bi,i=e.bj,s=e.si,r=e.sj,a=this.world,o=this.currentContactMaterial,l=o.friction,c=s.material||n.material,h=r.material||i.material;if(c&&h&&c.friction>=0&&h.friction>=0&&(l=c.friction*h.friction),l>0){var d=l*a.gravity.length(),p=n.invMass+i.invMass;p>0&&(p=1/p);var m=this.frictionEquationPool,f=m.length?m.pop():new u(n,i,d*p),g=m.length?m.pop():new u(n,i,d*p);return f.bi=g.bi=n,f.bj=g.bj=i,f.minForce=g.minForce=-d*p,f.maxForce=g.maxForce=d*p,f.ri.copy(e.ri),f.rj.copy(e.rj),g.ri.copy(e.ri),g.rj.copy(e.rj),e.ni.tangents(f.t,g.t),f.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,a.dt),g.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,a.dt),f.enabled=g.enabled=e.enabled,t.push(f,g),!0}return!1};var p=new a,m=new a,f=new a;d.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var n=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];p.setZero(),m.setZero(),f.setZero();var s=t.bi;t.bj;for(var r=0;r!==e;r++)(t=this.result[this.result.length-1-r]).bodyA!==s?(p.vadd(t.ni,p),m.vadd(t.ri,m),f.vadd(t.rj,f)):(p.vsub(t.ni,p),m.vadd(t.rj,m),f.vadd(t.ri,f));var a=1/e;m.scale(a,n.ri),f.scale(a,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),p.normalize(),p.tangents(n.t,i.t)}};var g=new a,v=new a,x=new l,y=new l;d.prototype.getContacts=function(e,t,n,i,s,r,a){this.contactPointPool=s,this.frictionEquationPool=a,this.result=i,this.frictionResult=r;for(var o=x,l=y,c=g,h=v,u=0,d=e.length;u!==d;u++){var p=e[u],m=t[u],f=null;p.material&&m.material&&(f=n.getContactMaterial(p.material,m.material)||null);for(var _=0;_<p.shapes.length;_++){p.quaternion.mult(p.shapeOrientations[_],o),p.quaternion.vmult(p.shapeOffsets[_],c),c.vadd(p.position,c);for(var b=p.shapes[_],w=0;w<m.shapes.length;w++){m.quaternion.mult(m.shapeOrientations[w],l),m.quaternion.vmult(m.shapeOffsets[w],h),h.vadd(m.position,h);var S=m.shapes[w];if(!(c.distanceTo(h)>b.boundingSphereRadius+S.boundingSphereRadius)){var M=null;b.material&&S.material&&(M=n.getContactMaterial(b.material,S.material)||null),this.currentContactMaterial=M||f||n.defaultContactMaterial;var T=this[b.type|S.type];T&&(b.type<S.type?T.call(this,b,S,c,h,o,l,p,m,b,S):T.call(this,S,b,h,c,l,o,m,p,b,S))}}}}},d.prototype[s.types.BOX|s.types.BOX]=d.prototype.boxBox=function(e,t,n,i,s,r,a,o){e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,i,s,r,a,o,e,t)},d.prototype[s.types.BOX|s.types.CONVEXPOLYHEDRON]=d.prototype.boxConvex=function(e,t,n,i,s,r,a,o){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,n,i,s,r,a,o,e,t)},d.prototype[s.types.BOX|s.types.PARTICLE]=d.prototype.boxParticle=function(e,t,n,i,s,r,a,o){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,n,i,s,r,a,o,e,t)},d.prototype[s.types.SPHERE]=d.prototype.sphereSphere=function(e,t,n,i,s,r,a,o){var l=this.createContactEquation(a,o,e,t);i.vsub(n,l.ni),l.ni.normalize(),l.ri.copy(l.ni),l.rj.copy(l.ni),l.ri.mult(e.radius,l.ri),l.rj.mult(-t.radius,l.rj),l.ri.vadd(n,l.ri),l.ri.vsub(a.position,l.ri),l.rj.vadd(i,l.rj),l.rj.vsub(o.position,l.rj),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)};var _=new a,b=new a,w=new a;d.prototype[s.types.PLANE|s.types.TRIMESH]=d.prototype.planeTrimesh=function(e,t,n,i,s,r,l,c){var h=new a,u=_;u.set(0,0,1),s.vmult(u,u);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,h);var p=new a;p.copy(h),o.pointToWorldFrame(i,r,p,h);var m=b;if(h.vsub(n,m),u.dot(m)<=0){var f=this.createContactEquation(l,c,e,t);f.ni.copy(u);var g=w;u.scale(m.dot(u),g),h.vsub(g,g),f.ri.copy(g),f.ri.vsub(l.position,f.ri),f.rj.copy(h),f.rj.vsub(c.position,f.rj),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}}};var S=new a,M=new a;new a;var T=new a,E=new a,C=new a,A=new a,N=new a,R=new a,P=new a,I=new a,j=new a,D=new a,k=new a,L=new i,O=[];d.prototype[s.types.SPHERE|s.types.TRIMESH]=d.prototype.sphereTrimesh=function(e,t,n,i,s,a,l,c){var h=C,u=A,d=N,p=R,m=P,f=I,g=L,v=E,x=M,y=O;o.pointToLocalFrame(i,a,n,m);var _=e.radius;g.lowerBound.set(m.x-_,m.y-_,m.z-_),g.upperBound.set(m.x+_,m.y+_,m.z+_),t.getTrianglesInAABB(g,y);for(var b=T,w=e.radius*e.radius,U=0;U<y.length;U++)for(var F=0;F<3;F++)t.getVertex(t.indices[3*y[U]+F],b),b.vsub(m,x),x.norm2()<=w&&(v.copy(b),o.pointToWorldFrame(i,a,v,b),b.vsub(n,x),(V=this.createContactEquation(l,c,e,t)).ni.copy(x),V.ni.normalize(),V.ri.copy(V.ni),V.ri.scale(e.radius,V.ri),V.ri.vadd(n,V.ri),V.ri.vsub(l.position,V.ri),V.rj.copy(b),V.rj.vsub(c.position,V.rj),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult));for(U=0;U<y.length;U++)for(F=0;F<3;F++){t.getVertex(t.indices[3*y[U]+F],h),t.getVertex(t.indices[3*y[U]+(F+1)%3],u),u.vsub(h,d),m.vsub(u,f);var B=f.dot(d);m.vsub(h,f);var z=f.dot(d);if(z>0&&B<0&&(m.vsub(h,f),p.copy(d),p.normalize(),z=f.dot(p),p.scale(z,f),f.vadd(h,f),(Y=f.distanceTo(m))<e.radius)){var V=this.createContactEquation(l,c,e,t);f.vsub(m,V.ni),V.ni.normalize(),V.ni.scale(e.radius,V.ri),o.pointToWorldFrame(i,a,f,f),f.vsub(c.position,V.rj),o.vectorToWorldFrame(a,V.ni,V.ni),o.vectorToWorldFrame(a,V.ri,V.ri),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult)}}for(var H=j,W=D,G=k,q=S,X=(U=0,y.length);U!==X;U++){t.getTriangleVertices(y[U],H,W,G),t.getNormal(y[U],q),m.vsub(H,f);var Y=f.dot(q);q.scale(Y,f),m.vsub(f,f),Y=f.distanceTo(m),r.pointInTriangle(f,H,W,G)&&Y<e.radius&&(V=this.createContactEquation(l,c,e,t),f.vsub(m,V.ni),V.ni.normalize(),V.ni.scale(e.radius,V.ri),o.pointToWorldFrame(i,a,f,f),f.vsub(c.position,V.rj),o.vectorToWorldFrame(a,V.ni,V.ni),o.vectorToWorldFrame(a,V.ri,V.ri),this.result.push(V),this.createFrictionEquationsFromContact(V,this.frictionResult))}y.length=0};var U=new a,F=new a;d.prototype[s.types.SPHERE|s.types.PLANE]=d.prototype.spherePlane=function(e,t,n,i,s,r,a,o){var l=this.createContactEquation(a,o,e,t);if(l.ni.set(0,0,1),r.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(e.radius,l.ri),n.vsub(i,U),l.ni.mult(l.ni.dot(U),F),U.vsub(F,l.rj),-U.dot(l.ni)<=e.radius){var c=l.ri,h=l.rj;c.vadd(n,c),c.vsub(a.position,c),h.vadd(i,h),h.vsub(o.position,h),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var B=new a,z=new a,V=new a;function H(e,t,n){for(var i=null,s=e.length,r=0;r!==s;r++){var a=e[r],o=B;e[(r+1)%s].vsub(a,o);var l=z;o.cross(t,l);var c=V;n.vsub(a,c);var h=l.dot(c);if(!(null===i||h>0&&!0===i||h<=0&&!1===i))return!1;null===i&&(i=h>0)}return!0}var W=new a,G=new a,q=new a,X=new a,Y=[new a,new a,new a,new a,new a,new a],$=new a,Z=new a,K=new a,J=new a;d.prototype[s.types.SPHERE|s.types.BOX]=d.prototype.sphereBox=function(e,t,n,i,s,r,a,o){var l=this.v3pool,c=Y;n.vsub(i,W),t.getSideNormals(c,r);for(var h=e.radius,u=!1,d=Z,p=K,m=J,f=null,g=0,v=0,x=0,y=null,_=0,b=c.length;_!==b&&!1===u;_++){var w=G;w.copy(c[_]);var S=w.norm();w.normalize();var M=W.dot(w);if(M<S+h&&M>0){var T=q,E=X;T.copy(c[(_+1)%3]),E.copy(c[(_+2)%3]);var C=T.norm(),A=E.norm();T.normalize(),E.normalize();var N=W.dot(T),R=W.dot(E);if(N<C&&N>-C&&R<A&&R>-A){var P=Math.abs(M-S-h);(null===y||P<y)&&(y=P,v=N,x=R,f=S,d.copy(w),p.copy(T),m.copy(E),g++)}}}if(g){u=!0;var I=this.createContactEquation(a,o,e,t);d.mult(-h,I.ri),I.ni.copy(d),I.ni.negate(I.ni),d.mult(f,d),p.mult(v,p),d.vadd(p,d),m.mult(x,m),d.vadd(m,I.rj),I.ri.vadd(n,I.ri),I.ri.vsub(a.position,I.ri),I.rj.vadd(i,I.rj),I.rj.vsub(o.position,I.rj),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult)}for(var j=l.get(),D=$,k=0;2!==k&&!u;k++)for(var L=0;2!==L&&!u;L++)for(var O=0;2!==O&&!u;O++)j.set(0,0,0),k?j.vadd(c[0],j):j.vsub(c[0],j),L?j.vadd(c[1],j):j.vsub(c[1],j),O?j.vadd(c[2],j):j.vsub(c[2],j),i.vadd(j,D),D.vsub(n,D),D.norm2()<h*h&&(u=!0,(I=this.createContactEquation(a,o,e,t)).ri.copy(D),I.ri.normalize(),I.ni.copy(I.ri),I.ri.mult(h,I.ri),I.rj.copy(j),I.ri.vadd(n,I.ri),I.ri.vsub(a.position,I.ri),I.rj.vadd(i,I.rj),I.rj.vsub(o.position,I.rj),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult));l.release(j),j=null;var U=l.get(),F=l.get(),B=(I=l.get(),l.get()),z=(P=l.get(),c.length);for(k=0;k!==z&&!u;k++)for(L=0;L!==z&&!u;L++)if(k%3!=L%3){c[L].cross(c[k],U),U.normalize(),c[k].vadd(c[L],F),I.copy(n),I.vsub(F,I),I.vsub(i,I);var V=I.dot(U);for(U.mult(V,B),O=0;O===k%3||O===L%3;)O++;P.copy(n),P.vsub(B,P),P.vsub(F,P),P.vsub(i,P);var H=Math.abs(V),Q=P.norm();if(H<c[O].norm()&&Q<h){u=!0;var ee=this.createContactEquation(a,o,e,t);F.vadd(B,ee.rj),ee.rj.copy(ee.rj),P.negate(ee.ni),ee.ni.normalize(),ee.ri.copy(ee.rj),ee.ri.vadd(i,ee.ri),ee.ri.vsub(n,ee.ri),ee.ri.normalize(),ee.ri.mult(h,ee.ri),ee.ri.vadd(n,ee.ri),ee.ri.vsub(a.position,ee.ri),ee.rj.vadd(i,ee.rj),ee.rj.vsub(o.position,ee.rj),this.result.push(ee),this.createFrictionEquationsFromContact(ee,this.frictionResult)}}l.release(U,F,I,B,P)};var Q=new a,ee=new a,te=new a,ne=new a,ie=new a,se=new a,re=new a,ae=new a,oe=new a,le=new a;d.prototype[s.types.SPHERE|s.types.CONVEXPOLYHEDRON]=d.prototype.sphereConvex=function(e,t,n,i,s,r,a,o){var l=this.v3pool;n.vsub(i,Q);for(var c=t.faceNormals,h=t.faces,u=t.vertices,d=e.radius,p=0;p!==u.length;p++){var m=u[p],f=ie;r.vmult(m,f),i.vadd(f,f);var g=ne;if(f.vsub(n,g),g.norm2()<d*d)return v=!0,(P=this.createContactEquation(a,o,e,t)).ri.copy(g),P.ri.normalize(),P.ni.copy(P.ri),P.ri.mult(d,P.ri),f.vsub(i,P.rj),P.ri.vadd(n,P.ri),P.ri.vsub(a.position,P.ri),P.rj.vadd(i,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),void this.createFrictionEquationsFromContact(P,this.frictionResult)}for(var v=!1,x=(p=0,h.length);p!==x&&!1===v;p++){var y=c[p],_=h[p],b=se;r.vmult(y,b);var w=re;r.vmult(u[_[0]],w),w.vadd(i,w);var S=ae;b.mult(-d,S),n.vadd(S,S);var M=oe;S.vsub(w,M);var T=M.dot(b),E=le;if(n.vsub(w,E),T<0&&E.dot(b)>0){for(var C=[],A=0,N=_.length;A!==N;A++){var R=l.get();r.vmult(u[_[A]],R),i.vadd(R,R),C.push(R)}if(H(C,b,n)){v=!0;var P=this.createContactEquation(a,o,e,t);b.mult(-d,P.ri),b.negate(P.ni);var I=l.get();b.mult(-T,I);var j=l.get();b.mult(-d,j),n.vsub(i,P.rj),P.rj.vadd(j,P.rj),P.rj.vadd(I,P.rj),P.rj.vadd(i,P.rj),P.rj.vsub(o.position,P.rj),P.ri.vadd(n,P.ri),P.ri.vsub(a.position,P.ri),l.release(I),l.release(j),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult),A=0;for(var D=C.length;A!==D;A++)l.release(C[A]);return}for(A=0;A!==_.length;A++){var k=l.get(),L=l.get();r.vmult(u[_[(A+1)%_.length]],k),r.vmult(u[_[(A+2)%_.length]],L),i.vadd(k,k),i.vadd(L,L);var O=ee;L.vsub(k,O);var U=te;O.unit(U);var F=l.get(),B=l.get();n.vsub(k,B);var z=B.dot(U);U.mult(z,F),F.vadd(k,F);var V=l.get();if(F.vsub(n,V),z>0&&z*z<O.norm2()&&V.norm2()<d*d){for(P=this.createContactEquation(a,o,e,t),F.vsub(i,P.rj),F.vsub(n,P.ni),P.ni.normalize(),P.ni.mult(d,P.ri),P.rj.vadd(i,P.rj),P.rj.vsub(o.position,P.rj),P.ri.vadd(n,P.ri),P.ri.vsub(a.position,P.ri),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult),A=0,D=C.length;A!==D;A++)l.release(C[A]);return l.release(k),l.release(L),l.release(F),l.release(V),void l.release(B)}l.release(k),l.release(L),l.release(F),l.release(V),l.release(B)}for(A=0,D=C.length;A!==D;A++)l.release(C[A])}}},new a,new a,d.prototype[s.types.PLANE|s.types.BOX]=d.prototype.planeBox=function(e,t,n,i,s,r,a,o){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.planeConvex(e,t.convexPolyhedronRepresentation,n,i,s,r,a,o)};var ce=new a,he=new a,ue=new a,de=new a;d.prototype[s.types.PLANE|s.types.CONVEXPOLYHEDRON]=d.prototype.planeConvex=function(e,t,n,i,s,r,a,o){var l=ce,c=he;c.set(0,0,1),s.vmult(c,c);for(var h=0,u=ue,d=0;d!==t.vertices.length;d++)if(l.copy(t.vertices[d]),r.vmult(l,l),i.vadd(l,l),l.vsub(n,u),c.dot(u)<=0){var p=this.createContactEquation(a,o,e,t),m=de;c.mult(c.dot(u),m),l.vsub(m,m),m.vsub(n,p.ri),p.ni.copy(c),l.vsub(i,p.rj),p.ri.vadd(n,p.ri),p.ri.vsub(a.position,p.ri),p.rj.vadd(i,p.rj),p.rj.vsub(o.position,p.rj),this.result.push(p),h++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(p,this.frictionResult)}this.enableFrictionReduction&&h&&this.createFrictionFromAverage(h)};var pe=new a,me=new a;d.prototype[s.types.CONVEXPOLYHEDRON]=d.prototype.convexConvex=function(e,t,n,i,s,r,a,o,l,c,h,u){var d=pe;if(!(n.distanceTo(i)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,n,s,i,r,d,h,u)){var p=[],m=me;e.clipAgainstHull(n,s,t,i,r,d,-100,100,p);for(var f=0,g=0;g!==p.length;g++){var v=this.createContactEquation(a,o,e,t,l,c),x=v.ri,y=v.rj;d.negate(v.ni),p[g].normal.negate(m),m.mult(p[g].depth,m),p[g].point.vadd(m,x),y.copy(p[g].point),x.vsub(n,x),y.vsub(i,y),x.vadd(n,x),x.vsub(a.position,x),y.vadd(i,y),y.vsub(o.position,y),this.result.push(v),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var fe=new a,ge=new a,ve=new a;d.prototype[s.types.PLANE|s.types.PARTICLE]=d.prototype.planeParticle=function(e,t,n,i,s,r,a,o){var l=fe;l.set(0,0,1),a.quaternion.vmult(l,l);var c=ge;if(i.vsub(a.position,c),l.dot(c)<=0){var h=this.createContactEquation(o,a,t,e);h.ni.copy(l),h.ni.negate(h.ni),h.ri.set(0,0,0);var u=ve;l.mult(l.dot(i),u),i.vsub(u,u),h.rj.copy(u),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var xe=new a;d.prototype[s.types.PARTICLE|s.types.SPHERE]=d.prototype.sphereParticle=function(e,t,n,i,s,r,a,o){var l=xe;if(l.set(0,0,1),i.vsub(n,l),l.norm2()<=e.radius*e.radius){var c=this.createContactEquation(o,a,t,e);l.normalize(),c.rj.copy(l),c.rj.mult(e.radius,c.rj),c.ni.copy(l),c.ni.negate(c.ni),c.ri.set(0,0,0),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var ye=new l,_e=new a;new a;var be=new a,we=new a,Se=new a;d.prototype[s.types.PARTICLE|s.types.CONVEXPOLYHEDRON]=d.prototype.convexParticle=function(e,t,n,i,s,r,a,o){var l=-1,c=be,h=Se,u=null,d=_e;if(d.copy(i),d.vsub(n,d),s.conjugate(ye),ye.vmult(d,d),e.pointIsInside(d)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,s),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(s);for(var p=0,m=e.faces.length;p!==m;p++){var f=[e.worldVertices[e.faces[p][0]]],g=e.worldFaceNormals[p];i.vsub(f[0],we);var v=-g.dot(we);(null===u||Math.abs(v)<Math.abs(u))&&(u=v,l=p,c.copy(g))}if(-1!==l){var x=this.createContactEquation(o,a,t,e);c.mult(u,h),h.vadd(i,h),h.vsub(n,h),x.rj.copy(h),c.negate(x.ni),x.ri.set(0,0,0);var y=x.ri,_=x.rj;y.vadd(i,y),y.vsub(o.position,y),_.vadd(n,_),_.vsub(a.position,_),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}}},d.prototype[s.types.BOX|s.types.HEIGHTFIELD]=d.prototype.boxHeightfield=function(e,t,n,i,s,r,a,o){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,i,s,r,a,o)};var Me=new a,Te=new a,Ee=[0];d.prototype[s.types.CONVEXPOLYHEDRON|s.types.HEIGHTFIELD]=d.prototype.convexHeightfield=function(e,t,n,i,s,r,a,l){var c=t.data,h=t.elementSize,u=e.boundingSphereRadius,d=Te,p=Ee,m=Me;o.pointToLocalFrame(i,r,n,m);var f=Math.floor((m.x-u)/h)-1,g=Math.ceil((m.x+u)/h)+1,v=Math.floor((m.y-u)/h)-1,x=Math.ceil((m.y+u)/h)+1;if(!(g<0||x<0||f>c.length||v>c[0].length)){f<0&&(f=0),g<0&&(g=0),v<0&&(v=0),x<0&&(x=0),f>=c.length&&(f=c.length-1),g>=c.length&&(g=c.length-1),x>=c[0].length&&(x=c[0].length-1),v>=c[0].length&&(v=c[0].length-1);var y=[];t.getRectMinMax(f,v,g,x,y);var _=y[0],b=y[1];if(!(m.z-u>b||m.z+u<_))for(var w=f;w<g;w++)for(var S=v;S<x;S++)t.getConvexTrianglePillar(w,S,!1),o.pointToWorldFrame(i,r,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,n,d,s,r,a,l,null,null,p,null),t.getConvexTrianglePillar(w,S,!0),o.pointToWorldFrame(i,r,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.convexConvex(e,t.pillarConvex,n,d,s,r,a,l,null,null,p,null)}};var Ce=new a,Ae=new a;d.prototype[s.types.SPHERE|s.types.HEIGHTFIELD]=d.prototype.sphereHeightfield=function(e,t,n,i,s,r,a,l){var c=t.data,h=e.radius,u=t.elementSize,d=Ae,p=Ce;o.pointToLocalFrame(i,r,n,p);var m=Math.floor((p.x-h)/u)-1,f=Math.ceil((p.x+h)/u)+1,g=Math.floor((p.y-h)/u)-1,v=Math.ceil((p.y+h)/u)+1;if(!(f<0||v<0||m>c.length||v>c[0].length)){m<0&&(m=0),f<0&&(f=0),g<0&&(g=0),v<0&&(v=0),m>=c.length&&(m=c.length-1),f>=c.length&&(f=c.length-1),v>=c[0].length&&(v=c[0].length-1),g>=c[0].length&&(g=c[0].length-1);var x=[];t.getRectMinMax(m,g,f,v,x);var y=x[0],_=x[1];if(!(p.z-h>_||p.z+h<y))for(var b=this.result,w=m;w<f;w++)for(var S=g;S<v;S++){var M=b.length;if(t.getConvexTrianglePillar(w,S,!1),o.pointToWorldFrame(i,r,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,n,d,s,r,a,l),t.getConvexTrianglePillar(w,S,!0),o.pointToWorldFrame(i,r,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&this.sphereConvex(e,t.pillarConvex,n,d,s,r,a,l),b.length-M>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(e,t,n){t.exports=x;var i=e("../shapes/Shape"),s=e("../math/Vec3"),r=e("../math/Quaternion"),a=e("../solver/GSSolver");e("../utils/Vec3Pool"),e("../equations/ContactEquation"),e("../equations/FrictionEquation");var o=e("./Narrowphase"),l=e("../utils/EventTarget"),c=e("../collision/ArrayCollisionMatrix"),h=e("../material/Material"),u=e("../material/ContactMaterial"),d=e("../objects/Body"),p=e("../utils/TupleDictionary"),m=e("../collision/RaycastResult"),f=e("../collision/AABB"),g=e("../collision/Ray"),v=e("../collision/NaiveBroadphase");function x(){l.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new s,this.broadphase=new v,this.bodies=[],this.solver=new a,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new c,this.collisionMatrixPrevious=new c,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new p,this.defaultMaterial=new h("default"),this.defaultContactMaterial=new u(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}x.prototype=new l,new f;var y=new g;if(x.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},x.prototype.numObjects=function(){return this.bodies.length},x.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset()},x.prototype.add=x.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof d&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.dispatchEvent(this.addBodyEvent))},x.prototype.addConstraint=function(e){this.constraints.push(e)},x.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},x.prototype.rayTest=function(e,t,n){n instanceof m?this.raycastClosest(e,t,{skipBackfaces:!0},n):this.raycastAll(e,t,{skipBackfaces:!0},n)},x.prototype.raycastAll=function(e,t,n,i){return n.mode=g.ALL,n.from=e,n.to=t,n.callback=i,y.intersectWorld(this,n)},x.prototype.raycastAny=function(e,t,n,i){return n.mode=g.ANY,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},x.prototype.raycastClosest=function(e,t,n,i){return n.mode=g.CLOSEST,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},x.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,n=this.bodies,i=n.indexOf(e);if(-1!==i){n.splice(i,1);for(var s=0;s!==n.length;s++)n[s].index=s;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,this.dispatchEvent(this.removeBodyEvent)}},x.prototype.removeBody=x.prototype.remove,x.prototype.addMaterial=function(e){this.materials.push(e)},x.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var _=Date.now();performance.timing&&performance.timing.navigationStart&&(_=performance.timing.navigationStart),performance.now=function(){return Date.now()-_}}var b=new s;x.prototype.step=function(e,t,n){if(n=n||10,0===(t=t||0))this.internalStep(e),this.time+=e;else{var i=Math.floor((this.time+t)/e)-Math.floor(this.time/e);i=Math.min(i,n);for(var s=performance.now(),r=0;r!==i&&(this.internalStep(e),!(performance.now()-s>1e3*e));r++);this.time+=t;for(var a=this.time%e/e,o=b,l=this.bodies,c=0;c!==l.length;c++){var h=l[c];h.type!==d.STATIC&&h.sleepState!==d.SLEEPING?(h.position.vsub(h.previousPosition,o),o.scale(a,o),h.position.vadd(o,h.interpolatedPosition)):(h.interpolatedPosition.copy(h.position),h.interpolatedQuaternion.copy(h.quaternion))}}};var w={type:"postStep"},S={type:"preStep"},M={type:"collide",body:null,contact:null},T=[],E=[],C=[],A=[];new s,new s,new s,new s,new s,new s,new s,new s,new s,new r;var N=new r,R=new r,P=new s;x.prototype.internalStep=function(e){this.dt=e;var t,n=this.contacts,s=C,r=A,a=this.numObjects(),o=this.bodies,l=this.solver,c=this.gravity,h=this.doProfiling,u=this.profile,p=d.DYNAMIC,m=this.constraints,f=E;c.norm();var g=c.x,v=c.y,x=c.z,y=0;for(h&&(t=performance.now()),y=0;y!==a;y++)if((B=o[y]).type&p){var _=B.force,b=B.mass;_.x+=b*g,_.y+=b*v,_.z+=b*x}y=0;for(var I=this.subsystems.length;y!==I;y++)this.subsystems[y].update();h&&(t=performance.now()),s.length=0,r.length=0,this.broadphase.collisionPairs(this,s,r),h&&(u.broadphase=performance.now()-t);var j=m.length;for(y=0;y!==j;y++)if(!(V=m[y]).collideConnected)for(var D=s.length-1;D>=0;D-=1)(V.bodyA===s[D]&&V.bodyB===r[D]||V.bodyB===s[D]&&V.bodyA===r[D])&&(s.splice(D,1),r.splice(D,1));this.collisionMatrixTick(),h&&(t=performance.now());var k=T,L=n.length;for(y=0;y!==L;y++)k.push(n[y]);n.length=0;var O=this.frictionEquations.length;for(y=0;y!==O;y++)f.push(this.frictionEquations[y]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(s,r,this,n,k,this.frictionEquations,f),h&&(u.narrowphase=performance.now()-t),h&&(t=performance.now()),y=0;y<this.frictionEquations.length;y++)l.addEquation(this.frictionEquations[y]);for(var U=n.length,F=0;F!==U;F++){var B=(V=n[F]).bi,z=V.bj;V.si,V.sj,(B.material&&z.material&&this.getContactMaterial(B.material,z.material)||this.defaultContactMaterial).friction,B.material&&z.material&&(B.material.friction>=0&&z.material.friction>=0&&(B.material.friction,z.material.friction),B.material.restitution>=0&&z.material.restitution>=0&&(V.restitution=B.material.restitution*z.material.restitution)),l.addEquation(V),B.allowSleep&&B.type===d.DYNAMIC&&B.sleepState===d.SLEEPING&&z.sleepState===d.AWAKE&&z.type!==d.STATIC&&z.velocity.norm2()+z.angularVelocity.norm2()>=2*Math.pow(z.sleepSpeedLimit,2)&&(B._wakeUpAfterNarrowphase=!0),z.allowSleep&&z.type===d.DYNAMIC&&z.sleepState===d.SLEEPING&&B.sleepState===d.AWAKE&&B.type!==d.STATIC&&B.velocity.norm2()+B.angularVelocity.norm2()>=2*Math.pow(B.sleepSpeedLimit,2)&&(z._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(B,z,!0),this.collisionMatrixPrevious.get(B,z)||(M.body=z,M.contact=V,B.dispatchEvent(M),M.body=B,z.dispatchEvent(M))}for(h&&(u.makeContactConstraints=performance.now()-t,t=performance.now()),y=0;y!==a;y++)(B=o[y])._wakeUpAfterNarrowphase&&(B.wakeUp(),B._wakeUpAfterNarrowphase=!1);for(j=m.length,y=0;y!==j;y++){var V;(V=m[y]).update(),D=0;for(var H=V.equations.length;D!==H;D++){var W=V.equations[D];l.addEquation(W)}}l.solve(e,this),h&&(u.solve=performance.now()-t),l.removeAllEquations();var G=Math.pow;for(y=0;y!==a;y++)if((B=o[y]).type&p){var q=G(1-B.linearDamping,e),X=B.velocity;X.mult(q,X);var Y=B.angularVelocity;if(Y){var $=G(1-B.angularDamping,e);Y.mult($,Y)}}for(this.dispatchEvent(S),y=0;y!==a;y++)(B=o[y]).preStep&&B.preStep.call(B);h&&(t=performance.now());var Z=N,K=R,J=this.stepnumber,Q=d.DYNAMIC|d.KINEMATIC,ee=J%(this.quatNormalizeSkip+1)===0,te=this.quatNormalizeFast,ne=.5*e;for(i.types.PLANE,i.types.CONVEXPOLYHEDRON,y=0;y!==a;y++){var ie=o[y],se=ie.force,re=ie.torque;if(ie.type&Q&&ie.sleepState!==d.SLEEPING){var ae=ie.velocity,oe=ie.angularVelocity,le=ie.position,ce=ie.quaternion,he=ie.invMass,ue=ie.invInertiaWorld;ae.x+=se.x*he*e,ae.y+=se.y*he*e,ae.z+=se.z*he*e,ie.angularVelocity&&(ue.vmult(re,P),P.mult(e,P),P.vadd(oe,oe)),le.x+=ae.x*e,le.y+=ae.y*e,le.z+=ae.z*e,ie.angularVelocity&&(Z.set(oe.x,oe.y,oe.z,0),Z.mult(ce,K),ce.x+=ne*K.x,ce.y+=ne*K.y,ce.z+=ne*K.z,ce.w+=ne*K.w,ee&&(te?ce.normalizeFast():ce.normalize())),ie.aabb&&(ie.aabbNeedsUpdate=!0),ie.updateInertiaWorld&&ie.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,h&&(u.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(w),y=0;y!==a;y++){var de=(B=o[y]).postStep;de&&de.call(B)}if(this.allowSleep)for(y=0;y!==a;y++)o[y].sleepTick(this.time)},x.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,n=0;n!==t;n++){var i=e[n];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2);const ag=(e,t,n)=>({endTime:t,insertTime:n,type:"exponentialRampToValue",value:e}),og=(e,t,n)=>({endTime:t,insertTime:n,type:"linearRampToValue",value:e}),lg=(e,t)=>({startTime:t,type:"setValue",value:e}),cg=(e,t,n)=>({duration:n,startTime:t,type:"setValueCurve",values:e}),hg=(e,t,{startTime:n,target:i,timeConstant:s})=>i+(t-i)*Math.exp((n-e)/s),ug=e=>"exponentialRampToValue"===e.type,dg=e=>"linearRampToValue"===e.type,pg=e=>ug(e)||dg(e),mg=e=>"setValue"===e.type,fg=e=>"setValueCurve"===e.type,gg=(e,t,n,i)=>{const s=e[t];return void 0===s?i:pg(s)||mg(s)?s.value:fg(s)?s.values[s.values.length-1]:hg(n,gg(e,t-1,s.startTime,i),s)},vg=(e,t,n,i,s)=>void 0===n?[i.insertTime,s]:pg(n)?[n.endTime,n.value]:mg(n)?[n.startTime,n.value]:fg(n)?[n.startTime+n.duration,n.values[n.values.length-1]]:[n.startTime,gg(e,t-1,n.startTime,s)],xg=e=>"cancelAndHold"===e.type,yg=e=>"cancelScheduledValues"===e.type,_g=e=>xg(e)||yg(e)?e.cancelTime:ug(e)||dg(e)?e.endTime:e.startTime,bg=(e,t,n,{endTime:i,value:s})=>n===s?s:0<n&&0<s||n<0&&s<0?n*(s/n)**((e-t)/(i-t)):0,wg=(e,t,n,{endTime:i,value:s})=>n+(e-t)/(i-t)*(s-n),Sg=e=>"setTarget"===e.type;class Mg{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=_g(e);if(xg(e)||yg(e)){const n=this._automationEvents.findIndex(n=>yg(e)&&fg(n)?n.startTime+n.duration>=t:_g(n)>=t),i=this._automationEvents[n];if(-1!==n&&(this._automationEvents=this._automationEvents.slice(0,n)),xg(e)){const e=this._automationEvents[this._automationEvents.length-1];if(void 0!==i&&pg(i)){if(void 0!==e&&Sg(e))throw new Error("The internal list is malformed.");const n=void 0===e?i.insertTime:fg(e)?e.startTime+e.duration:_g(e),s=void 0===e?this._defaultValue:fg(e)?e.values[e.values.length-1]:e.value,r=ug(i)?bg(t,n,s,i):wg(t,n,s,i),a=ug(i)?ag(r,t,this._currenTime):og(r,t,this._currenTime);this._automationEvents.push(a)}if(void 0!==e&&Sg(e)&&this._automationEvents.push(lg(this.getValue(t),t)),void 0!==e&&fg(e)&&e.startTime+e.duration>t){const n=t-e.startTime,i=(e.values.length-1)/e.duration,s=Math.max(2,1+Math.ceil(n*i)),r=n/(s-1)*i,a=e.values.slice(0,s);if(r<1)for(let t=1;t<s;t+=1){const n=r*t%1;a[t]=e.values[t-1]*(1-n)+e.values[t]*n}this._automationEvents[this._automationEvents.length-1]=cg(a,e.startTime,n)}}}else{const n=this._automationEvents.findIndex(e=>_g(e)>t),i=-1===n?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[n-1];if(void 0!==i&&fg(i)&&_g(i)+i.duration>t)return!1;const s=ug(e)?ag(e.value,e.endTime,this._currenTime):dg(e)?og(e.value,t,this._currenTime):e;if(-1===n)this._automationEvents.push(s);else{if(fg(e)&&t+e.duration>_g(this._automationEvents[n]))return!1;this._automationEvents.splice(n,0,s)}}return!0}flush(e){const t=this._automationEvents.findIndex(t=>_g(t)>e);if(t>1){const e=this._automationEvents.slice(t-1),n=e[0];Sg(n)&&e.unshift(lg(gg(this._automationEvents,t-2,n.startTime,this._defaultValue),n.startTime)),this._automationEvents=e}}getValue(e){if(0===this._automationEvents.length)return this._defaultValue;const t=this._automationEvents.findIndex(t=>_g(t)>e),n=this._automationEvents[t],i=(-1===t?this._automationEvents.length:t)-1,s=this._automationEvents[i];if(void 0!==s&&Sg(s)&&(void 0===n||!pg(n)||n.insertTime>e))return hg(e,gg(this._automationEvents,i-1,s.startTime,this._defaultValue),s);if(void 0!==s&&mg(s)&&(void 0===n||!pg(n)))return s.value;if(void 0!==s&&fg(s)&&(void 0===n||!pg(n)||s.startTime+s.duration>e))return e<s.startTime+s.duration?((e,{duration:t,startTime:n,values:i})=>((e,t)=>{const n=Math.floor(t),i=Math.ceil(t);return n===i?e[n]:(1-(t-n))*e[n]+(1-(i-t))*e[i]})(i,(e-n)/t*(i.length-1)))(e,s):s.values[s.values.length-1];if(void 0!==s&&pg(s)&&(void 0===n||!pg(n)))return s.value;if(void 0!==n&&ug(n)){const[t,r]=vg(this._automationEvents,i,s,n,this._defaultValue);return bg(e,t,r,n)}if(void 0!==n&&dg(n)){const[t,r]=vg(this._automationEvents,i,s,n,this._defaultValue);return wg(e,t,r,n)}return this._defaultValue}}const Tg=new WeakSet,Eg=new WeakMap,Cg=new WeakMap,Ag=new WeakMap,Ng=new WeakMap,Rg=new WeakMap,Pg=new WeakMap,Ig=new WeakMap,jg=new WeakMap,Dg=new WeakMap,kg={construct:()=>kg},Lg=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,Og=(e,t)=>{const n=[];let i=e.replace(/^[\s]+/,""),s=i.match(Lg);for(;null!==s;){const e=s[1].slice(1,-1),r=s[0].replace(/([\s]+)?;?$/,"").replace(e,new URL(e,t).toString());n.push(r),i=i.slice(s[0].length).replace(/^[\s]+/,""),s=i.match(Lg)}return[n.join(";"),i]},Ug=e=>{if(void 0!==e&&!Array.isArray(e))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Fg=e=>{if(!(e=>{try{new new Proxy(e,kg)}catch{return!1}return!0})(e))throw new TypeError("The given value for processorCtor should be a constructor.");if(null===e.prototype||"object"!=typeof e.prototype)throw new TypeError("The given value for processorCtor should have a prototype.")},Bg=(e,t)=>{const n=e.get(t);if(void 0===n)throw new Error("A value with the given key could not be found.");return n},zg=(e,t)=>{const n=Array.from(e).filter(t);if(n.length>1)throw Error("More than one element was found.");if(0===n.length)throw Error("No element was found.");const[i]=n;return e.delete(i),i},Vg=(e,t,n,i)=>{const s=Bg(e,t),r=zg(s,e=>e[0]===n&&e[1]===i);return 0===s.size&&e.delete(t),r},Hg=e=>Bg(Pg,e),Wg=e=>{if(Tg.has(e))throw new Error("The AudioNode is already stored.");Tg.add(e),Hg(e).forEach(e=>e(!0))},Gg=e=>"port"in e,qg=e=>{if(!Tg.has(e))throw new Error("The AudioNode is not stored.");Tg.delete(e),Hg(e).forEach(e=>e(!1))},Xg=(e,t)=>{!Gg(e)&&t.every(e=>0===e.size)&&qg(e)},Yg={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},$g=(e,t)=>e.context===t,Zg=e=>{try{e.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Kg=()=>new DOMException("","IndexSizeError"),Jg=e=>{var t;e.getChannelData=(t=e.getChannelData,n=>{try{return t.call(e,n)}catch(i){if(12===i.code)throw Kg();throw i}})},Qg={numberOfChannels:1},ev=-34028234663852886e22,tv=-ev,nv=e=>Tg.has(e),iv={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},sv=e=>Bg(Eg,e),rv=e=>Bg(Ag,e),av=(e,t)=>{const{activeInputs:n}=sv(e);n.forEach(n=>n.forEach(([n])=>{t.includes(e)||av(n,[...t,e])}));const i=(e=>"playbackRate"in e)(e)?[e.playbackRate]:Gg(e)?Array.from(e.parameters.values()):(e=>"frequency"in e&&"gain"in e)(e)?[e.Q,e.detune,e.frequency,e.gain]:(e=>"offset"in e)(e)?[e.offset]:(e=>!("frequency"in e)&&"gain"in e)(e)?[e.gain]:(e=>"detune"in e&&"frequency"in e&&!("gain"in e))(e)?[e.detune,e.frequency]:(e=>"pan"in e)(e)?[e.pan]:[];for(const s of i){const e=rv(s);void 0!==e&&e.activeInputs.forEach(([e])=>av(e,t))}nv(e)&&qg(e)},ov=e=>{av(e.destination,[])},lv=e=>"context"in e,cv=e=>lv(e[0]),hv=(e,t,n,i)=>{for(const s of e)if(n(s)){if(i)return!1;throw Error("The set contains at least one similar element.")}return e.add(t),!0},uv=(e,t,[n,i],s)=>{hv(e,[t,n,i],e=>e[0]===t&&e[1]===n,s)},dv=(e,[t,n,i],s)=>{const r=e.get(t);void 0===r?e.set(t,new Set([[n,i]])):hv(r,[n,i],e=>e[0]===n,s)},pv=e=>"inputs"in e,mv=(e,t,n,i)=>{if(pv(t)){const s=t.inputs[i];return e.connect(s,n,0),[s,n,0]}return e.connect(t,n,i),[t,n,i]},fv=(e,t,n)=>{for(const i of e)if(i[0]===t&&i[1]===n)return e.delete(i),i;return null},gv=(e,t)=>{if(!Hg(e).delete(t))throw new Error("Missing the expected event listener.")},vv=(e,t,n)=>{const i=Bg(e,t),s=zg(i,e=>e[0]===n);return 0===i.size&&e.delete(t),s},xv=(e,t,n,i)=>{pv(t)?e.disconnect(t.inputs[i],n,0):e.disconnect(t,n,i)},yv=e=>Bg(Cg,e),_v=e=>Bg(Ng,e),bv=e=>Ig.has(e),wv=e=>!Tg.has(e),Sv=(e,t)=>new Promise(n=>{if(null!==t)n(!0);else{const t=e.createScriptProcessor(256,1,1),i=e.createGain(),s=e.createBuffer(1,2,44100),r=s.getChannelData(0);r[0]=1,r[1]=1;const a=e.createBufferSource();a.buffer=s,a.loop=!0,a.connect(t).connect(e.destination),a.connect(i),a.disconnect(i),t.onaudioprocess=i=>{const s=i.inputBuffer.getChannelData(0);Array.prototype.some.call(s,e=>1===e)?n(!0):n(!1),a.stop(),t.onaudioprocess=null,a.disconnect(t),t.disconnect(e.destination)},a.start()}}),Mv=(e,t)=>{const n=new Map;for(const i of e)for(const e of i){const t=n.get(e);n.set(e,void 0===t?1:t+1)}n.forEach((e,n)=>t(n,e))},Tv=e=>"context"in e,Ev=(e,t,n,i,s)=>{const[r,a]=((e,t,n,i)=>{const{activeInputs:s,passiveInputs:r}=sv(t),a=fv(s[i],e,n);return null===a?[Vg(r,e,n,i)[2],!1]:[a[2],!0]})(e,n,i,s);if(null!==r&&(gv(e,r),!a||t||bv(e)||xv(yv(e),yv(n),i,s)),nv(n)){const{activeInputs:e}=sv(n);Xg(n,e)}},Cv=(e,t,n,i)=>{const[s,r]=((e,t,n)=>{const{activeInputs:i,passiveInputs:s}=rv(t),r=fv(i,e,n);return null===r?[vv(s,e,n)[1],!1]:[r[2],!0]})(e,n,i);null!==s&&(gv(e,s),!r||t||bv(e)||yv(e).disconnect(_v(n),i))};class Av{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((n,i)=>e.call(t,n,i,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const Nv={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function Rv(e,t,n,i,s){if("function"==typeof e.copyFromChannel)0===t[n].byteLength&&(t[n]=new Float32Array(128)),e.copyFromChannel(t[n],i,s);else{const r=e.getChannelData(i);if(0===t[n].byteLength)t[n]=r.slice(s,s+128);else{const e=new Float32Array(r.buffer,s*Float32Array.BYTES_PER_ELEMENT,128);t[n].set(e)}}}const Pv=(e,t,n,i,s)=>{"function"==typeof e.copyToChannel?0!==t[n].byteLength&&e.copyToChannel(t[n],i,s):0!==t[n].byteLength&&e.getChannelData(i).set(t[n],s)},Iv=(e,t)=>{const n=[];for(let i=0;i<e;i+=1){const e=[],s="number"==typeof t?t:t[i];for(let t=0;t<s;t+=1)e.push(new Float32Array(128));n.push(e)}return n},jv={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Dv={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},kv={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Lv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Ov={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Uv=e=>{const{port1:t,port2:n}=new MessageChannel;return new Promise(i=>{const s=()=>{n.onmessage=null,t.close(),n.close(),i()};n.onmessage=()=>s();try{t.postMessage(e,[e])}catch{}finally{s()}})},Fv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Bv=(e,t,n)=>{const i=t[n];if(void 0===i)throw e();return i},zv={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Vv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Hv=()=>new DOMException("","InvalidStateError"),Wv=()=>new DOMException("","InvalidAccessError"),Gv={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},qv=(e,t,n,i,s,r,a,o,l,c,h)=>{const u=c.length;let d=o;for(let p=0;p<u;p+=1){let o=n[0]*c[p];for(let t=1;t<s;t+=1){const i=d-t&l-1;o+=n[t]*r[i],o-=e[t]*a[i]}for(let e=s;e<i;e+=1)o+=n[e]*r[d-e&l-1];for(let n=s;n<t;n+=1)o-=e[n]*a[d-n&l-1];r[d]=c[p],a[d]=o,d=d+1&l-1,h[p]=o}return d},Xv={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Yv=e=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const n=e.decodeAudioData(t.buffer,()=>{});return void 0!==n&&(n.catch(()=>{}),!0)}catch{}return!1},$v=(e,t,n)=>{const i=t[n];void 0!==i&&i!==e[n]&&(e[n]=i)},Zv=(e,t)=>{$v(e,t,"channelCount"),$v(e,t,"channelCountMode"),$v(e,t,"channelInterpretation")},Kv=e=>"function"==typeof e.getFloatTimeDomainData,Jv=(e,t,n)=>{const i=t[n];void 0!==i&&i!==e[n].value&&(e[n].value=i)},Qv=e=>{var t;e.start=(t=e.start,(n=0,i=0,s)=>{if("number"==typeof s&&s<0||i<0||n<0)throw new RangeError("The parameters can't be negative.");t.call(e,n,i,s)})},ex=e=>{var t;e.stop=(t=e.stop,(n=0)=>{if(n<0)throw new RangeError("The parameter can't be negative.");t.call(e,n)})},tx=(e,t)=>null===e?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(e*t))))),nx=(e,t)=>{const n=e.createBiquadFilter();return Zv(n,t),Jv(n,t,"Q"),Jv(n,t,"detune"),Jv(n,t,"frequency"),Jv(n,t,"gain"),$v(n,t,"type"),n},ix=(e,t)=>{const n=e.createChannelSplitter(t.numberOfOutputs);return Zv(n,t),(e=>{const t=e.numberOfOutputs;Object.defineProperty(e,"channelCount",{get:()=>t,set:e=>{if(e!==t)throw Hv()}}),Object.defineProperty(e,"channelCountMode",{get:()=>"explicit",set:e=>{if("explicit"!==e)throw Hv()}}),Object.defineProperty(e,"channelInterpretation",{get:()=>"discrete",set:e=>{if("discrete"!==e)throw Hv()}})})(n),n},sx=(e,t)=>(e.connect=t.connect.bind(t),e.disconnect=t.disconnect.bind(t),e),rx=(e,t)=>{const n=e.createDelay(t.maxDelayTime);return Zv(n,t),Jv(n,t,"delayTime"),n},ax=(e,t)=>{const n=e.createGain();return Zv(n,t),Jv(n,t,"gain"),n};function ox(e,t){const n=t[0]*t[0]+t[1]*t[1];return[(e[0]*t[0]+e[1]*t[1])/n,(e[1]*t[0]-e[0]*t[1])/n]}function lx(e,t){return[e[0]*t[0]-e[1]*t[1],e[0]*t[1]+e[1]*t[0]]}function cx(e,t){let n=[0,0];for(let i=e.length-1;i>=0;i-=1)n=lx(n,t),n[0]+=e[i];return n}const hx=(e,t,n,i)=>e.createScriptProcessor(t,n,i),ux=()=>new DOMException("","NotSupportedError"),dx={numberOfChannels:1},px={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},mx={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},fx={disableNormalization:!1},gx={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},vx={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},xx=(e,t,n)=>void 0===e.copyFromChannel?e.getChannelData(n)[0]:(e.copyFromChannel(t,n),t[0]),yx=e=>{if(null===e)return!1;const t=e.length;return t%2!=0?0!==e[Math.floor(t/2)]:e[t/2-1]+e[t/2]!==0},_x=(e,t,n,i)=>{let s=e;for(;!s.hasOwnProperty(t);)s=Object.getPrototypeOf(s);const{get:r,set:a}=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(e,t,{get:n(r),set:i(a)})},bx=(e,t,n)=>{try{e.setValueAtTime(t,n)}catch(i){if(9!==i.code)throw i;bx(e,t,n+1e-7)}},wx=e=>{const t=e.createOscillator();try{t.start(-1)}catch(n){return n instanceof RangeError}return!1},Sx=e=>{const t=e.createBuffer(1,1,44100),n=e.createBufferSource();n.buffer=t,n.start(),n.stop();try{return n.stop(),!0}catch{return!1}},Mx=e=>{const t=e.createOscillator();try{t.stop(-1)}catch(n){return n instanceof RangeError}return!1},Tx=(e,t)=>{const n=t.createGain();e.connect(n);const i=(s=e.disconnect,()=>{s.call(e,n),e.removeEventListener("ended",i)});var s;e.addEventListener("ended",i),sx(e,n),e.stop=(t=>{let i=!1;return(s=0)=>{if(i)try{t.call(e,s)}catch{n.gain.setValueAtTime(0,s)}else t.call(e,s),i=!0}})(e.stop)},Ex=(e,t)=>n=>{const i={value:e};return Object.defineProperties(n,{currentTarget:i,target:i}),"function"==typeof t?t.call(e,n):t.handleEvent.call(e,n)},Cx=(Ax=hv,(e,t,[n,i,s],r)=>{Ax(e[i],[t,n,s],e=>e[0]===t&&e[1]===n,r)});var Ax;const Nx=(e=>(t,n,[i,s,r],a)=>{const o=t.get(i);void 0===o?t.set(i,new Set([[s,n,r]])):e(o,[s,n,r],e=>e[0]===s&&e[1]===n,a)})(hv),Rx=(Px=zg,(e,t,n,i)=>Px(e[i],e=>e[0]===t&&e[1]===n));var Px;const Ix=new WeakMap,jx=(Dx=Ix,e=>{var t;return null!==(t=Dx.get(e))&&void 0!==t?t:0});var Dx;const kx=(Lx=new Map,Ox=new WeakMap,(e,t)=>{const n=Ox.get(e);if(void 0!==n)return n;const i=Lx.get(e);if(void 0!==i)return i;try{const n=t();return n instanceof Promise?(Lx.set(e,n),n.catch(()=>!1).then(t=>(Lx.delete(e),Ox.set(e,t),t))):(Ox.set(e,n),n)}catch{return Ox.set(e,!1),!1}});var Lx,Ox;const Ux="undefined"==typeof window?null:window,Fx=(Bx=kx,zx=Kg,(e,t)=>{const n=e.createAnalyser();if(Zv(n,t),!(t.maxDecibels>t.minDecibels))throw zx();return $v(n,t,"fftSize"),$v(n,t,"maxDecibels"),$v(n,t,"minDecibels"),$v(n,t,"smoothingTimeConstant"),Bx(Kv,()=>Kv(n))||(e=>{e.getFloatTimeDomainData=t=>{const n=new Uint8Array(t.length);e.getByteTimeDomainData(n);const i=Math.max(n.length,e.fftSize);for(let e=0;e<i;e+=1)t[e]=.0078125*(n[e]-128);return t}})(n),n});var Bx,zx;const Vx=(Hx=sv,e=>{const t=Hx(e);if(null===t.renderer)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer});var Hx;const Wx=((e,t,n)=>async(i,s,r)=>{const a=e(i);await Promise.all(a.activeInputs.map((e,a)=>Array.from(e).map(async([e,o])=>{const l=t(e),c=await l.render(e,s),h=i.context.destination;n(e)||i===h&&n(i)||c.connect(r,o,a)})).reduce((e,t)=>[...e,...t],[]))})(sv,Vx,bv),Gx=(qx=Fx,Xx=yv,Yx=Wx,()=>{const e=new WeakMap;return{render(t,n){const i=e.get(n);return void 0!==i?Promise.resolve(i):(async(t,n)=>{let i=Xx(t);if(!$g(i,n)){const e={channelCount:i.channelCount,channelCountMode:i.channelCountMode,channelInterpretation:i.channelInterpretation,fftSize:i.fftSize,maxDecibels:i.maxDecibels,minDecibels:i.minDecibels,smoothingTimeConstant:i.smoothingTimeConstant};i=qx(n,e)}return e.set(n,i),await Yx(t,n,i),i})(t,n)}}});var qx,Xx,Yx;const $x=(Zx=Rg,e=>{const t=Zx.get(e);if(void 0===t)throw Hv();return t});var Zx;const Kx=null===(Jx=Ux)?null:Jx.hasOwnProperty("OfflineAudioContext")?Jx.OfflineAudioContext:Jx.hasOwnProperty("webkitOfflineAudioContext")?Jx.webkitOfflineAudioContext:null;var Jx;const Qx=(ey=Kx,e=>null!==ey&&e instanceof ey);var ey;const ty=new WeakMap,ny=(iy=Ex,class{constructor(e){this._nativeEventTarget=e,this._listeners=new WeakMap}addEventListener(e,t,n){if(null!==t){let i=this._listeners.get(t);void 0===i&&(i=iy(this,t),"function"==typeof t&&this._listeners.set(t,i)),this._nativeEventTarget.addEventListener(e,i,n)}}dispatchEvent(e){return this._nativeEventTarget.dispatchEvent(e)}removeEventListener(e,t,n){const i=null===t?void 0:this._listeners.get(t);this._nativeEventTarget.removeEventListener(e,void 0===i?null:i,n)}});var iy;const sy=(e=>null===e?null:e.hasOwnProperty("AudioContext")?e.AudioContext:e.hasOwnProperty("webkitAudioContext")?e.webkitAudioContext:null)(Ux),ry=(ay=sy,e=>null!==ay&&e instanceof ay);var ay;const oy=(e=>t=>null!==e&&"function"==typeof e.AudioNode&&t instanceof e.AudioNode)(Ux),ly=(e=>t=>null!==e&&"function"==typeof e.AudioParam&&t instanceof e.AudioParam)(Ux),cy=(e=>null===e?null:e.hasOwnProperty("AudioWorkletNode")?e.AudioWorkletNode:null)(Ux),hy=((e,t,n,i,s,r,a,o,l,c,h,u,d,p,m,f)=>class extends c{constructor(t,i,s,r){super(s),this._context=t,this._nativeAudioNode=s;const a=h(t);u(a)&&!0!==n(Sv,()=>Sv(a,f))&&(e=>{const t=new Map;var n,i;e.connect=(n=e.connect.bind(e),(e,i=0,s=0)=>{const r=Tv(e)?n(e,i,s):n(e,i),a=t.get(e);return void 0===a?t.set(e,[{input:s,output:i}]):a.every(e=>e.input!==s||e.output!==i)&&a.push({input:s,output:i}),r}),e.disconnect=(i=e.disconnect,(n,s,r)=>{if(i.apply(e),void 0===n)t.clear();else if("number"==typeof n)for(const[e,i]of t){const s=i.filter(e=>e.output!==n);0===s.length?t.delete(e):t.set(e,s)}else if(t.has(n))if(void 0===s)t.delete(n);else{const e=t.get(n);if(void 0!==e){const i=e.filter(e=>e.output!==s&&(e.input!==r||void 0===r));0===i.length?t.delete(n):t.set(n,i)}}for(const[i,a]of t)a.forEach(t=>{Tv(i)?e.connect(i,t.output,t.input):e.connect(i,t.output)})})})(s),Cg.set(this,s),Pg.set(this,new Set),"closed"!==t.state&&i&&Wg(this),e(this,r,s)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(e){this._nativeAudioNode.channelCount=e}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(e){this._nativeAudioNode.channelCountMode=e}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(e){this._nativeAudioNode.channelInterpretation=e}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(e,n=0,o=0){if(n<0||n>=this._nativeAudioNode.numberOfOutputs)throw s();const c=h(this._context),u=m(c);if(d(e)||p(e))throw r();if(lv(e)){const s=yv(e);try{const t=mv(this._nativeAudioNode,s,n,o),i=wv(this);(u||i)&&this._nativeAudioNode.disconnect(...t),"closed"!==this.context.state&&!i&&wv(e)&&Wg(e)}catch(g){if(12===g.code)throw r();throw g}if(t(this,e,n,o,u)){const t=l([this],e);Mv(t,i(u))}return e}const f=_v(e);if("playbackRate"===f.name&&1024===f.maxValue)throw a();try{this._nativeAudioNode.connect(f,n),(u||wv(this))&&this._nativeAudioNode.disconnect(f,n)}catch(g){if(12===g.code)throw r();throw g}if(((e,t,n,i)=>{const{activeInputs:s,passiveInputs:r}=rv(t),{outputs:a}=sv(e),o=Hg(e),l=a=>{const o=yv(e),l=_v(t);if(a){const t=vv(r,e,n);uv(s,e,t,!1),i||bv(e)||o.connect(l,n)}else{const t=((e,t,n)=>zg(e,e=>e[0]===t&&e[1]===n))(s,e,n);dv(r,t,!1),i||bv(e)||o.disconnect(l,n)}};return!!hv(a,[t,n],e=>e[0]===t&&e[1]===n,!0)&&(o.add(l),nv(e)?uv(s,e,[n,l],!0):dv(r,[e,n,l],!0),!0)})(this,e,n,u)){const t=l([this],e);Mv(t,i(u))}}disconnect(e,t,n){let i;const a=h(this._context),c=m(a);if(void 0===e)i=((e,t)=>{const n=sv(e),i=[];for(const s of n.outputs)cv(s)?Ev(e,t,...s):Cv(e,t,...s),i.push(s[0]);return n.outputs.clear(),i})(this,c);else if("number"==typeof e){if(e<0||e>=this.numberOfOutputs)throw s();i=((e,t,n)=>{const i=sv(e),s=[];for(const r of i.outputs)r[1]===n&&(cv(r)?Ev(e,t,...r):Cv(e,t,...r),s.push(r[0]),i.outputs.delete(r));return s})(this,c,e)}else{if(void 0!==t&&(t<0||t>=this.numberOfOutputs))throw s();if(lv(e)&&void 0!==n&&(n<0||n>=e.numberOfInputs))throw s();if(i=((e,t,n,i,s)=>{const r=sv(e);return Array.from(r.outputs).filter(e=>!(e[0]!==n||void 0!==i&&e[1]!==i||void 0!==s&&e[2]!==s)).map(n=>(cv(n)?Ev(e,t,...n):Cv(e,t,...n),r.outputs.delete(n),n[0]))})(this,c,e,t,n),0===i.length)throw r()}for(const s of i){const e=l([this],s);Mv(e,o)}}})((uy=Eg,(e,t,n)=>{const i=[];for(let s=0;s<n.numberOfInputs;s+=1)i.push(new Set);uy.set(e,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((e,t,n,i,s,r,a,o,l,c,h,u,d)=>{const p=new WeakMap;return(m,f,g,v,x)=>{const{activeInputs:y,passiveInputs:_}=r(f),{outputs:b}=r(m),w=o(m),S=r=>{const o=l(f),c=l(m);if(r){const t=Vg(_,m,g,v);e(y,m,t,!1),x||u(m)||n(c,o,g,v),d(f)&&Wg(f)}else{const e=i(y,m,g,v);t(_,v,e,!1),x||u(m)||s(c,o,g,v);const n=a(f);if(0===n)h(f)&&Xg(f,y);else{const e=p.get(f);void 0!==e&&clearTimeout(e),p.set(f,setTimeout(()=>{h(f)&&Xg(f,y)},1e3*n))}}};return!!c(b,[f,g,v],e=>e[0]===f&&e[1]===g&&e[2]===v,!0)&&(w.add(S),h(m)?e(y,m,[g,v,S],!0):t(_,v,[m,g,S],!0),!0)}})(Cx,Nx,mv,Rx,xv,sv,jx,Hg,yv,hv,nv,bv,wv),kx,((e,t,n,i,s,r)=>a=>(o,l)=>{const c=e.get(o);if(void 0===c){if(!a&&r(o)){const e=i(o),{outputs:r}=n(o);for(const n of r)if(cv(n)){const s=i(n[0]);t(e,s,n[1],n[2])}else{const t=s(n[0]);e.disconnect(t,n[1])}}e.set(o,l)}else e.set(o,c+l)})(Ig,xv,sv,yv,_v,nv),Kg,Wv,ux,((e,t,n,i,s,r,a,o)=>(l,c)=>{const h=t.get(l);if(void 0===h)throw new Error("Missing the expected cycle count.");const u=r(l.context),d=o(u);if(h===c){if(t.delete(l),!d&&a(l)){const t=i(l),{outputs:r}=n(l);for(const n of r)if(cv(n)){const s=i(n[0]);e(t,s,n[1],n[2])}else{const e=s(n[0]);t.connect(e,n[1])}}}else t.set(l,h-c)})(mv,Ig,sv,yv,_v,$x,nv,Qx),((e,t,n)=>function i(s,r){const a=lv(r)?r:n(e,r);if((e=>"delayTime"in e)(a))return[];if(s[0]===a)return[s];if(s.includes(a))return[];const{outputs:o}=t(a);return Array.from(o).map(e=>i([...s,a],e[0])).reduce((e,t)=>e.concat(t),[])})(ty,sv,Bg),ny,$x,ry,oy,ly,Qx,cy);var uy;const dy=((e,t,n,i,s,r)=>class extends e{constructor(e,n){const a=s(e),o={...Yg,...n},l=i(a,o);super(e,!1,l,r(a)?t():null),this._nativeAnalyserNode=l}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(e){this._nativeAnalyserNode.fftSize=e}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(e){const t=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=e,!(e>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=t,n()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(e){const t=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=e,!(this._nativeAnalyserNode.maxDecibels>e))throw this._nativeAnalyserNode.minDecibels=t,n()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(e){this._nativeAnalyserNode.smoothingTimeConstant=e}getByteFrequencyData(e){this._nativeAnalyserNode.getByteFrequencyData(e)}getByteTimeDomainData(e){this._nativeAnalyserNode.getByteTimeDomainData(e)}getFloatFrequencyData(e){this._nativeAnalyserNode.getFloatFrequencyData(e)}getFloatTimeDomainData(e){this._nativeAnalyserNode.getFloatTimeDomainData(e)}})(hy,Gx,Kg,Fx,$x,Qx),py=new WeakSet,my=(e=>null===e?null:e.hasOwnProperty("AudioBuffer")?e.AudioBuffer:null)(Ux),fy=(gy=new Uint32Array(1),e=>(gy[0]=e,gy[0]));var gy;const vy=((e,t)=>n=>{n.copyFromChannel=(i,s,r=0)=>{const a=e(r),o=e(s);if(o>=n.numberOfChannels)throw t();const l=n.length,c=n.getChannelData(o),h=i.length;for(let e=a<0?-a:0;e+a<l&&e<h;e+=1)i[e]=c[e+a]},n.copyToChannel=(i,s,r=0)=>{const a=e(r),o=e(s);if(o>=n.numberOfChannels)throw t();const l=n.length,c=n.getChannelData(o),h=i.length;for(let e=a<0?-a:0;e+a<l&&e<h;e+=1)c[e+a]=i[e]}})(fy,Kg),xy=(yy=fy,e=>{var t,n;e.copyFromChannel=(t=e.copyFromChannel,(n,i,s=0)=>{const r=yy(s),a=yy(i);if(r<e.length)return t.call(e,n,a,r)}),e.copyToChannel=(n=e.copyToChannel,(t,i,s=0)=>{const r=yy(s),a=yy(i);if(r<e.length)return n.call(e,t,a,r)})});var yy;const _y=((e,t,n,i,s,r,a,o)=>{let l=null;return class c{constructor(c){if(null===s)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:h,numberOfChannels:u,sampleRate:d}={...Qg,...c};null===l&&(l=new s(1,1,44100));const p=null!==i&&t(r,r)?new i({length:h,numberOfChannels:u,sampleRate:d}):l.createBuffer(u,h,d);if(0===p.numberOfChannels)throw n();return"function"!=typeof p.copyFromChannel?(a(p),Jg(p)):t(Zg,()=>Zg(p))||o(p),e.add(p),p}static[Symbol.hasInstance](t){return null!==t&&"object"==typeof t&&Object.getPrototypeOf(t)===c.prototype||e.has(t)}}})(py,kx,ux,my,Kx,(by=my,()=>{if(null===by)return!1;try{new by({length:1,sampleRate:44100})}catch{return!1}return!0}),vy,xy);var by;const wy=(Sy=ax,(e,t)=>{const n=Sy(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(n).connect(e.destination);const i=()=>{t.removeEventListener("ended",i),t.disconnect(n),n.disconnect()};t.addEventListener("ended",i)});var Sy;const My=(Ty=Vx,Ey=rv,Cy=bv,async(e,t,n)=>{const i=Ey(e);await Promise.all(Array.from(i.activeInputs).map(async([e,i])=>{const s=Ty(e),r=await s.render(e,t);Cy(e)||r.connect(n,i)}))});var Ty,Ey,Cy;const Ay=(Ny=My,(e,t,n)=>Ny(t,e,n));var Ny;const Ry=((e,t,n,i,s,r,a,o,l,c,h)=>(l,u)=>{const d=l.createBufferSource();return Zv(d,u),Jv(d,u,"playbackRate"),$v(d,u,"buffer"),$v(d,u,"loop"),$v(d,u,"loopEnd"),$v(d,u,"loopStart"),t(n,()=>n(l))||(e=>{e.start=(t=>{let n=!1;return(i=0,s=0,r)=>{if(n)throw Hv();t.call(e,i,s,r),n=!0}})(e.start)})(d),t(i,()=>i(l))||(e=>{var t;e.start=(t=e.start,(n=0,i=0,s)=>{const r=e.buffer,a=null===r?i:Math.min(r.duration,i);null!==r&&a>r.duration-.5/e.context.sampleRate?t.call(e,n,0,0):t.call(e,n,a,s)})})(d),t(s,()=>s(l))||c(d,l),t(r,()=>r(l))||Qv(d),t(a,()=>a(l))||h(d,l),t(o,()=>o(l))||ex(d),e(l,d),d})(wy,kx,e=>{const t=e.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},e=>{const t=e.createBufferSource(),n=e.createBuffer(1,1,44100);t.buffer=n;try{t.start(0,1)}catch{return!1}return!0},e=>{const t=e.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},wx,Sx,Mx,0,(Py=_x,(e,t)=>{const n=t.createBuffer(1,1,44100);null===e.buffer&&(e.buffer=n),Py(e,"buffer",t=>()=>{const i=t.call(e);return i===n?null:i},t=>i=>t.call(e,null===i?n:i))}),Tx);var Py;const Iy=((e,t)=>(n,i,s)=>(e(i).replay(s),t(i,n,s)))((e=>t=>{const n=e(t);if(null===n.renderer)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return n.renderer})(rv),My),jy=((e,t,n,i,s)=>()=>{const r=new WeakMap;let a=null,o=null;return{set start(e){a=e},set stop(e){o=e},render(l,c){const h=r.get(c);return void 0!==h?Promise.resolve(h):(async(l,c)=>{let h=n(l);const u=$g(h,c);if(!u){const e={buffer:h.buffer,channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,loop:h.loop,loopEnd:h.loopEnd,loopStart:h.loopStart,playbackRate:h.playbackRate.value};h=t(c,e),null!==a&&h.start(...a),null!==o&&h.stop(o)}return r.set(c,h),u?await e(c,l.playbackRate,h.playbackRate):await i(c,l.playbackRate,h.playbackRate),await s(l,c,h),h})(l,c)}}})(Ay,Ry,yv,Iy,Wx),Dy=((e,t,n,i,s,r,a,o,l,c,h,u,d)=>(i,r,a,o=null,l=null)=>{const p=a.value,m=new Mg(p),f=r?(e=>({replay(t){for(const n of e)if("exponentialRampToValue"===n.type){const{endTime:e,value:i}=n;t.exponentialRampToValueAtTime(i,e)}else if("linearRampToValue"===n.type){const{endTime:e,value:i}=n;t.linearRampToValueAtTime(i,e)}else if("setTarget"===n.type){const{startTime:e,target:i,timeConstant:s}=n;t.setTargetAtTime(i,e,s)}else if("setValue"===n.type){const{startTime:e,value:i}=n;t.setValueAtTime(i,e)}else{if("setValueCurve"!==n.type)throw new Error("Can't apply an unknown automation.");{const{duration:e,startTime:i,values:s}=n;t.setValueCurveAtTime(s,i,e)}}}}))(m):null,g={get defaultValue(){return p},get maxValue(){return null===o?a.maxValue:o},get minValue(){return null===l?a.minValue:l},get value(){return a.value},set value(e){a.value=e,g.setValueAtTime(e,i.context.currentTime)},cancelAndHoldAtTime(e){if("function"==typeof a.cancelAndHoldAtTime)null===f&&m.flush(i.context.currentTime),m.add(s(e)),a.cancelAndHoldAtTime(e);else{const t=Array.from(m).pop();null===f&&m.flush(i.context.currentTime),m.add(s(e));const n=Array.from(m).pop();a.cancelScheduledValues(e),t!==n&&void 0!==n&&("exponentialRampToValue"===n.type?a.exponentialRampToValueAtTime(n.value,n.endTime):"linearRampToValue"===n.type?a.linearRampToValueAtTime(n.value,n.endTime):"setValue"===n.type?a.setValueAtTime(n.value,n.startTime):"setValueCurve"===n.type&&a.setValueCurveAtTime(n.values,n.startTime,n.duration))}return g},cancelScheduledValues:e=>(null===f&&m.flush(i.context.currentTime),m.add((e=>({cancelTime:e,type:"cancelScheduledValues"}))(e)),a.cancelScheduledValues(e),g),exponentialRampToValueAtTime(e,t){if(0===e)throw new RangeError;if(!Number.isFinite(t)||t<0)throw new RangeError;const n=i.context.currentTime;return null===f&&m.flush(n),0===Array.from(m).length&&(m.add(c(p,n)),a.setValueAtTime(p,n)),m.add(((e,t)=>({endTime:t,type:"exponentialRampToValue",value:e}))(e,t)),a.exponentialRampToValueAtTime(e,t),g},linearRampToValueAtTime(e,t){const n=i.context.currentTime;return null===f&&m.flush(n),0===Array.from(m).length&&(m.add(c(p,n)),a.setValueAtTime(p,n)),m.add(((e,t)=>({endTime:t,type:"linearRampToValue",value:e}))(e,t)),a.linearRampToValueAtTime(e,t),g},setTargetAtTime:(e,t,n)=>(null===f&&m.flush(i.context.currentTime),m.add(((e,t,n)=>({startTime:t,target:e,timeConstant:n,type:"setTarget"}))(e,t,n)),a.setTargetAtTime(e,t,n),g),setValueAtTime:(e,t)=>(null===f&&m.flush(i.context.currentTime),m.add(c(e,t)),a.setValueAtTime(e,t),g),setValueCurveAtTime(e,t,n){const s=e instanceof Float32Array?e:new Float32Array(e);if(null!==u&&"webkitAudioContext"===u.name){const e=t+n,r=i.context.sampleRate,o=Math.ceil(t*r),l=Math.floor(e*r),c=l-o,u=new Float32Array(c);for(let i=0;i<c;i+=1){const e=(s.length-1)/n*((o+i)/r-t),a=Math.floor(e),l=Math.ceil(e);u[i]=a===l?s[a]:(1-(e-a))*s[a]+(1-(l-e))*s[l]}null===f&&m.flush(i.context.currentTime),m.add(h(u,t,n)),a.setValueCurveAtTime(u,t,n);const p=l/r;p<e&&d(g,u[u.length-1],p),d(g,s[s.length-1],e)}else null===f&&m.flush(i.context.currentTime),m.add(h(s,t,n)),a.setValueCurveAtTime(s,t,n);return g}};return n.set(g,a),t.set(g,i),e(g,f),g})((ky=Ag,(e,t)=>{ky.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),ty,Ng,0,e=>({cancelTime:e,type:"cancelAndHold"}),0,0,0,0,lg,cg,sy,bx);var ky;const Ly=((e,t,n,i,s,r,a,o)=>class extends e{constructor(e,i){const o=r(e),l={...iv,...i},c=s(o,l),h=a(o),u=h?t():null;super(e,!1,c,u),this._audioBufferSourceNodeRenderer=u,this._isBufferNullified=!1,this._isBufferSet=null!==l.buffer,this._nativeAudioBufferSourceNode=c,this._onended=null,this._playbackRate=n(this,h,c.playbackRate,tv,ev)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(e){if(this._nativeAudioBufferSourceNode.buffer=e,null!==e){if(this._isBufferSet)throw i();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(e){this._nativeAudioBufferSourceNode.loop=e}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(e){this._nativeAudioBufferSourceNode.loopEnd=e}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(e){this._nativeAudioBufferSourceNode.loopStart=e}get onended(){return this._onended}set onended(e){const t="function"==typeof e?o(this,e):null;this._nativeAudioBufferSourceNode.onended=t;const n=this._nativeAudioBufferSourceNode.onended;this._onended=null!==n&&n===t?e:n}get playbackRate(){return this._playbackRate}start(e=0,t=0,n){if(this._nativeAudioBufferSourceNode.start(e,t,n),null!==this._audioBufferSourceNodeRenderer&&(this._audioBufferSourceNodeRenderer.start=void 0===n?[e,t]:[e,t,n]),"closed"!==this.context.state){Wg(this);const e=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",e),nv(this)&&qg(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",e)}}stop(e=0){this._nativeAudioBufferSourceNode.stop(e),null!==this._audioBufferSourceNodeRenderer&&(this._audioBufferSourceNodeRenderer.stop=e)}})(hy,jy,Dy,Hv,Ry,$x,Qx,Ex),Oy=((e,t,n,i,s,r,a,o)=>class extends e{constructor(e,t){const n=r(e),i=a(n),l=s(n,t,i);super(e,!1,l,i?(e=>{const t=new WeakMap;return{render(n,i){const s=t.get(i);return void 0!==s?Promise.resolve(s):(async(n,i)=>{const s=i.destination;return t.set(i,s),await e(n,i,s),s})(n,i)}}})(o):null),this._isNodeOfNativeOfflineAudioContext=i,this._nativeAudioDestinationNode=l}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(e){if(this._isNodeOfNativeOfflineAudioContext)throw i();if(e>this._nativeAudioDestinationNode.maxChannelCount)throw n();this._nativeAudioDestinationNode.channelCount=e}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(e){if(this._isNodeOfNativeOfflineAudioContext)throw i();this._nativeAudioDestinationNode.channelCountMode=e}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(hy,0,Kg,Hv,((e,t)=>(n,i,s)=>{const r=n.destination;if(r.channelCount!==i)try{r.channelCount=i}catch{}s&&"explicit"!==r.channelCountMode&&(r.channelCountMode="explicit"),0===r.maxChannelCount&&Object.defineProperty(r,"maxChannelCount",{value:i});const a=e(n,{channelCount:i,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return t(a,"channelCount",e=>()=>e.call(a),e=>t=>{e.call(a,t);try{r.channelCount=t}catch(n){if(t>r.maxChannelCount)throw n}}),t(a,"channelCountMode",e=>()=>e.call(a),e=>t=>{e.call(a,t),r.channelCountMode=t}),t(a,"channelInterpretation",e=>()=>e.call(a),e=>t=>{e.call(a,t),r.channelInterpretation=t}),Object.defineProperty(a,"maxChannelCount",{get:()=>r.maxChannelCount}),a.connect(r),a})(ax,_x),$x,Qx,Wx),Uy=((e,t,n,i,s)=>()=>{const r=new WeakMap;return{render(a,o){const l=r.get(o);return void 0!==l?Promise.resolve(l):(async(a,o)=>{let l=n(a);const c=$g(l,o);if(!c){const e={Q:l.Q.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,detune:l.detune.value,frequency:l.frequency.value,gain:l.gain.value,type:l.type};l=t(o,e)}return r.set(o,l),c?(await e(o,a.Q,l.Q),await e(o,a.detune,l.detune),await e(o,a.frequency,l.frequency),await e(o,a.gain,l.gain)):(await i(o,a.Q,l.Q),await i(o,a.detune,l.detune),await i(o,a.frequency,l.frequency),await i(o,a.gain,l.gain)),await s(a,o,l),l})(a,o)}}})(Ay,nx,yv,Iy,Wx),Fy=(e=>(t,n)=>e.set(t,n))(Ix),By=(zy=hy,Vy=Dy,Hy=Uy,Wy=Wv,Gy=nx,qy=$x,Xy=Qx,Yy=Fy,class extends zy{constructor(e,t){const n=qy(e),i={...jv,...t},s=Gy(n,i),r=Xy(n);super(e,!1,s,r?Hy():null),this._Q=Vy(this,r,s.Q,tv,ev),this._detune=Vy(this,r,s.detune,1200*Math.log2(tv),-1200*Math.log2(tv)),this._frequency=Vy(this,r,s.frequency,e.sampleRate/2,0),this._gain=Vy(this,r,s.gain,40*Math.log10(tv),ev),this._nativeBiquadFilterNode=s,Yy(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(e){this._nativeBiquadFilterNode.type=e}getFrequencyResponse(e,t,n){try{this._nativeBiquadFilterNode.getFrequencyResponse(e,t,n)}catch(i){if(11===i.code)throw Wy();throw i}if(e.length!==t.length||t.length!==n.length)throw Wy()}});var zy,Vy,Hy,Wy,Gy,qy,Xy,Yy;const $y=((e,t)=>(n,i,s)=>{const r=new Set;var a,o;return n.connect=(a=n.connect,(s,o=0,l=0)=>{const c=0===r.size;if(t(s))return a.call(n,s,o,l),e(r,[s,o,l],e=>e[0]===s&&e[1]===o&&e[2]===l,!0),c&&i(),s;a.call(n,s,o),e(r,[s,o],e=>e[0]===s&&e[1]===o,!0),c&&i()}),n.disconnect=(o=n.disconnect,(e,i,a)=>{const l=r.size>0;if(void 0===e)o.apply(n),r.clear();else if("number"==typeof e){o.call(n,e);for(const t of r)t[1]===e&&r.delete(t)}else{t(e)?o.call(n,e,i,a):o.call(n,e,i);for(const t of r)t[0]!==e||void 0!==i&&t[1]!==i||void 0!==a&&t[2]!==a||r.delete(t)}const c=0===r.size;l&&c&&s()}),n})(hv,oy);var Zy,Ky;const Jy=((e,t)=>(n,i)=>{const s=n.createChannelMerger(i.numberOfInputs);return null!==e&&"webkitAudioContext"===e.name&&t(n,s),Zv(s,i),s})(sy,(Zy=Hv,Ky=$y,(e,t)=>{t.channelCount=1,t.channelCountMode="explicit",Object.defineProperty(t,"channelCount",{get:()=>1,set:()=>{throw Zy()}}),Object.defineProperty(t,"channelCountMode",{get:()=>"explicit",set:()=>{throw Zy()}});const n=e.createBufferSource();Ky(t,()=>{const e=t.numberOfInputs;for(let i=0;i<e;i+=1)n.connect(t,0,i)},()=>n.disconnect(t))})),Qy=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,r){const a=i.get(r);return void 0!==a?Promise.resolve(a):(async(s,r)=>{let a=t(s);if(!$g(a,r)){const t={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,numberOfInputs:a.numberOfInputs};a=e(r,t)}return i.set(r,a),await n(s,r,a),a})(s,r)}}})(Jy,yv,Wx),e_=((e,t,n,i,s)=>class extends e{constructor(e,r){const a=i(e),o={...Dv,...r};super(e,!1,n(a,o),s(a)?t():null)}})(hy,Qy,Jy,$x,Qx),t_=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,r){const a=i.get(r);return void 0!==a?Promise.resolve(a):(async(s,r)=>{let a=t(s);if(!$g(a,r)){const t={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,numberOfOutputs:a.numberOfOutputs};a=e(r,t)}return i.set(r,a),await n(s,r,a),a})(s,r)}}})(ix,yv,Wx),n_=((e,t,n,i,s)=>class extends e{constructor(e,r){const a=i(e),o=(e=>({...e,channelCount:e.numberOfOutputs}))({...kv,...r});super(e,!1,n(a,o),s(a)?t():null)}})(hy,t_,ix,$x,Qx),i_=((e,t,n,i)=>(s,{offset:r,...a})=>{const o=s.createBuffer(1,2,44100),l=t(s,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),c=n(s,{...a,gain:r}),h=o.getChannelData(0);h[0]=1,h[1]=1,l.buffer=o,l.loop=!0;const u={get bufferSize(){},get channelCount(){return c.channelCount},set channelCount(e){c.channelCount=e},get channelCountMode(){return c.channelCountMode},set channelCountMode(e){c.channelCountMode=e},get channelInterpretation(){return c.channelInterpretation},set channelInterpretation(e){c.channelInterpretation=e},get context(){return c.context},get inputs(){return[]},get numberOfInputs(){return l.numberOfInputs},get numberOfOutputs(){return c.numberOfOutputs},get offset(){return c.gain},get onended(){return l.onended},set onended(e){l.onended=e},addEventListener:(...e)=>l.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>l.dispatchEvent(e[0]),removeEventListener:(...e)=>l.removeEventListener(e[0],e[1],e[2]),start(e=0){l.start.call(l,e)},stop(e=0){l.stop.call(l,e)}};return e(s,l),i(sx(u,c),()=>l.connect(c),()=>l.disconnect(c))})(wy,Ry,ax,$y),s_=((e,t,n,i,s)=>(r,a)=>{if(void 0===r.createConstantSource)return n(r,a);const o=r.createConstantSource();return Zv(o,a),Jv(o,a,"offset"),t(i,()=>i(r))||Qv(o),t(s,()=>s(r))||ex(o),e(r,o),o})(wy,kx,i_,wx,Mx),r_=((e,t,n,i,s)=>()=>{const r=new WeakMap;let a=null,o=null;return{set start(e){a=e},set stop(e){o=e},render(l,c){const h=r.get(c);return void 0!==h?Promise.resolve(h):(async(l,c)=>{let h=n(l);const u=$g(h,c);if(!u){const e={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,offset:h.offset.value};h=t(c,e),null!==a&&h.start(a),null!==o&&h.stop(o)}return r.set(c,h),u?await e(c,l.offset,h.offset):await i(c,l.offset,h.offset),await s(l,c,h),h})(l,c)}}})(Ay,s_,yv,Iy,Wx),a_=((e,t,n,i,s,r,a)=>class extends e{constructor(e,a){const o=s(e),l={...Lv,...a},c=i(o,l),h=r(o),u=h?n():null;super(e,!1,c,u),this._constantSourceNodeRenderer=u,this._nativeConstantSourceNode=c,this._offset=t(this,h,c.offset,tv,ev),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(e){const t="function"==typeof e?a(this,e):null;this._nativeConstantSourceNode.onended=t;const n=this._nativeConstantSourceNode.onended;this._onended=null!==n&&n===t?e:n}start(e=0){if(this._nativeConstantSourceNode.start(e),null!==this._constantSourceNodeRenderer&&(this._constantSourceNodeRenderer.start=e),"closed"!==this.context.state){Wg(this);const e=()=>{this._nativeConstantSourceNode.removeEventListener("ended",e),nv(this)&&qg(this)};this._nativeConstantSourceNode.addEventListener("ended",e)}}stop(e=0){this._nativeConstantSourceNode.stop(e),null!==this._constantSourceNodeRenderer&&(this._constantSourceNodeRenderer.stop=e)}})(hy,Dy,r_,s_,$x,Qx,Ex),o_=((e,t)=>(n,i)=>{const s=n.createConvolver();if(Zv(s,i),i.disableNormalization===s.normalize&&(s.normalize=!i.disableNormalization),$v(s,i,"buffer"),i.channelCount>2)throw e();if(t(s,"channelCount",e=>()=>e.call(s),t=>n=>{if(n>2)throw e();return t.call(s,n)}),"max"===i.channelCountMode)throw e();return t(s,"channelCountMode",e=>()=>e.call(s),t=>n=>{if("max"===n)throw e();return t.call(s,n)}),s})(ux,_x),l_=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,r){const a=i.get(r);return void 0!==a?Promise.resolve(a):(async(s,r)=>{let a=t(s);if(!$g(a,r)){const t={buffer:a.buffer,channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,disableNormalization:!a.normalize};a=e(r,t)}return i.set(r,a),pv(a)?await n(s,r,a.inputs[0]):await n(s,r,a),a})(s,r)}}})(o_,yv,Wx),c_=((e,t,n,i,s,r)=>class extends e{constructor(e,a){const o=i(e),l={...Ov,...a},c=n(o,l);super(e,!1,c,s(o)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=c,null!==l.buffer&&r(this,l.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(e){if(this._nativeConvolverNode.buffer=e,null===e&&null!==this._nativeConvolverNode.buffer){const e=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=e.createBuffer(1,1,e.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,null===this._nativeConvolverNode.buffer?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(e){this._nativeConvolverNode.normalize=e}})(hy,l_,o_,$x,Qx,Fy),h_=((e,t,n,i,s)=>r=>{const a=new WeakMap;return{render(o,l){const c=a.get(l);return void 0!==c?Promise.resolve(c):(async(o,l)=>{let c=n(o);const h=$g(c,l);if(!h){const e={channelCount:c.channelCount,channelCountMode:c.channelCountMode,channelInterpretation:c.channelInterpretation,delayTime:c.delayTime.value,maxDelayTime:r};c=t(l,e)}return a.set(l,c),h?await e(l,o.delayTime,c.delayTime):await i(l,o.delayTime,c.delayTime),await s(o,l,c),c})(o,l)}}})(Ay,rx,yv,Iy,Wx),u_=((e,t,n,i,s,r,a)=>class extends e{constructor(e,o){const l=s(e),c={...Fv,...o},h=i(l,c),u=r(l);super(e,!1,h,u?n(c.maxDelayTime):null),this._delayTime=t(this,u,h.delayTime),a(this,c.maxDelayTime)}get delayTime(){return this._delayTime}})(hy,Dy,h_,rx,$x,Qx,Fy),d_=(p_=ux,(e,t)=>{const n=e.createDynamicsCompressor();if(Zv(n,t),t.channelCount>2)throw p_();if("max"===t.channelCountMode)throw p_();return Jv(n,t,"attack"),Jv(n,t,"knee"),Jv(n,t,"ratio"),Jv(n,t,"release"),Jv(n,t,"threshold"),n});var p_;const m_=((e,t,n,i,s)=>()=>{const r=new WeakMap;return{render(a,o){const l=r.get(o);return void 0!==l?Promise.resolve(l):(async(a,o)=>{let l=n(a);const c=$g(l,o);if(!c){const e={attack:l.attack.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,knee:l.knee.value,ratio:l.ratio.value,release:l.release.value,threshold:l.threshold.value};l=t(o,e)}return r.set(o,l),c?(await e(o,a.attack,l.attack),await e(o,a.knee,l.knee),await e(o,a.ratio,l.ratio),await e(o,a.release,l.release),await e(o,a.threshold,l.threshold)):(await i(o,a.attack,l.attack),await i(o,a.knee,l.knee),await i(o,a.ratio,l.ratio),await i(o,a.release,l.release),await i(o,a.threshold,l.threshold)),await s(a,o,l),l})(a,o)}}})(Ay,d_,yv,Iy,Wx),f_=((e,t,n,i,s,r,a,o)=>class extends e{constructor(e,s){const l=r(e),c={...zv,...s},h=i(l,c),u=a(l);super(e,!1,h,u?n():null),this._attack=t(this,u,h.attack),this._knee=t(this,u,h.knee),this._nativeDynamicsCompressorNode=h,this._ratio=t(this,u,h.ratio),this._release=t(this,u,h.release),this._threshold=t(this,u,h.threshold),o(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(e){const t=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=e,e>2)throw this._nativeDynamicsCompressorNode.channelCount=t,s()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(e){const t=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=e,"max"===e)throw this._nativeDynamicsCompressorNode.channelCountMode=t,s()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return"number"==typeof this._nativeDynamicsCompressorNode.reduction.value?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(hy,Dy,m_,d_,ux,$x,Qx,Fy),g_=((e,t,n,i,s)=>()=>{const r=new WeakMap;return{render(a,o){const l=r.get(o);return void 0!==l?Promise.resolve(l):(async(a,o)=>{let l=n(a);const c=$g(l,o);if(!c){const e={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,gain:l.gain.value};l=t(o,e)}return r.set(o,l),c?await e(o,a.gain,l.gain):await i(o,a.gain,l.gain),await s(a,o,l),l})(a,o)}}})(Ay,ax,yv,Iy,Wx),v_=((e,t,n,i,s,r)=>class extends e{constructor(e,a){const o=s(e),l={...Vv,...a},c=i(o,l),h=r(o);super(e,!1,c,h?n():null),this._gain=t(this,h,c.gain,tv,ev)}get gain(){return this._gain}})(hy,Dy,g_,ax,$x,Qx),x_=((e,t,n,i)=>(s,r,{channelCount:a,channelCountMode:o,channelInterpretation:l,feedback:c,feedforward:h})=>{const u=tx(r,s.sampleRate),d=c instanceof Float64Array?c:new Float64Array(c),p=h instanceof Float64Array?h:new Float64Array(h),m=d.length,f=p.length,g=Math.min(m,f);if(0===m||m>20)throw i();if(0===d[0])throw t();if(0===f||f>20)throw i();if(0===p[0])throw t();if(1!==d[0]){for(let e=0;e<f;e+=1)p[e]/=d[0];for(let e=1;e<m;e+=1)d[e]/=d[0]}const v=n(s,u,a,a);v.channelCount=a,v.channelCountMode=o,v.channelInterpretation=l;const x=[],y=[],_=[];for(let e=0;e<a;e+=1){x.push(0);const e=new Float32Array(32),t=new Float32Array(32);e.fill(0),t.fill(0),y.push(e),_.push(t)}v.onaudioprocess=e=>{const t=e.inputBuffer,n=e.outputBuffer,i=t.numberOfChannels;for(let s=0;s<i;s+=1){const e=t.getChannelData(s),i=n.getChannelData(s);x[s]=qv(d,m,p,f,g,y[s],_[s],x[s],32,e,i)}};const b=s.sampleRate/2;return sx({get bufferSize(){return u},get channelCount(){return v.channelCount},set channelCount(e){v.channelCount=e},get channelCountMode(){return v.channelCountMode},set channelCountMode(e){v.channelCountMode=e},get channelInterpretation(){return v.channelInterpretation},set channelInterpretation(e){v.channelInterpretation=e},get context(){return v.context},get inputs(){return[v]},get numberOfInputs(){return v.numberOfInputs},get numberOfOutputs(){return v.numberOfOutputs},addEventListener:(...e)=>v.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>v.dispatchEvent(e[0]),getFrequencyResponse(t,n,i){if(t.length!==n.length||n.length!==i.length)throw e();const s=t.length;for(let e=0;e<s;e+=1){const s=-Math.PI*(t[e]/b),r=[Math.cos(s),Math.sin(s)],a=ox(cx(p,r),cx(d,r));n[e]=Math.sqrt(a[0]*a[0]+a[1]*a[1]),i[e]=Math.atan2(a[1],a[0])}},removeEventListener:(...e)=>v.removeEventListener(e[0],e[1],e[2])},v)})(Wv,Hv,hx,ux),y_=((e,t,n,i)=>s=>e(Yv,()=>Yv(s))?Promise.resolve(e(i,i)).then(e=>{if(!e){const e=n(s,512,0,1);s.oncomplete=()=>{e.onaudioprocess=null,e.disconnect()},e.onaudioprocess=()=>s.currentTime,e.connect(s.destination)}return s.startRendering()}):new Promise(e=>{const n=t(s,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});s.oncomplete=t=>{n.disconnect(),e(t.renderedBuffer)},n.connect(s.destination),s.startRendering()}))(kx,ax,hx,((e,t)=>()=>{if(null===t)return Promise.resolve(!1);const n=new t(1,1,44100),i=e(n,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(e=>{n.oncomplete=()=>{i.disconnect(),e(0!==n.currentTime)},n.startRendering()})})(ax,Kx)),__=((e,t,n,i,s)=>(r,a)=>{const o=new WeakMap;let l=null;return{render(c,h){const u=o.get(h);return void 0!==u?Promise.resolve(u):(async(c,h)=>{let u=null,d=t(c);const p=$g(d,h);if(void 0===h.createIIRFilter?u=e(h,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(d=h.createIIRFilter(a,r)),o.set(h,null===u?d:u),null!==u){if(null===l){if(null===n)throw new Error("Missing the native OfflineAudioContext constructor.");const e=new n(c.context.destination.channelCount,c.context.length,h.sampleRate);l=(async()=>(await i(c,e,e.destination),((e,t,n,i)=>{const s=n instanceof Float64Array?n:new Float64Array(n),r=i instanceof Float64Array?i:new Float64Array(i),a=s.length,o=r.length,l=Math.min(a,o);if(1!==s[0]){for(let e=0;e<a;e+=1)r[e]/=s[0];for(let e=1;e<o;e+=1)s[e]/=s[0]}const c=new Float32Array(32),h=new Float32Array(32),u=t.createBuffer(e.numberOfChannels,e.length,e.sampleRate),d=e.numberOfChannels;for(let p=0;p<d;p+=1){const t=e.getChannelData(p),n=u.getChannelData(p);c.fill(0),h.fill(0),qv(s,a,r,o,l,c,h,0,32,t,n)}return u})(await s(e),h,r,a)))()}const e=await l;return u.buffer=e,u.start(0),u}return await i(c,h,d),d})(c,h)}}})(Ry,yv,Kx,Wx,y_);var b_;const w_=((e,t,n,i,s,r)=>class extends e{constructor(e,a){const o=i(e),l=s(o),c={...Gv,...a},h=t(o,l?null:e.baseLatency,c);super(e,!1,h,l?n(c.feedback,c.feedforward):null),(e=>{var t;e.getFrequencyResponse=(t=e.getFrequencyResponse,(n,i,s)=>{if(n.length!==i.length||i.length!==s.length)throw Wv();return t.call(e,n,i,s)})})(h),this._nativeIIRFilterNode=h,r(this,1)}getFrequencyResponse(e,t,n){return this._nativeIIRFilterNode.getFrequencyResponse(e,t,n)}})(hy,(b_=x_,(e,t,n)=>{if(void 0===e.createIIRFilter)return b_(e,t,n);const i=e.createIIRFilter(n.feedforward,n.feedback);return Zv(i,n),i}),__,$x,Qx,Fy),S_=((e,t,n,i,s,r,a,o)=>(l,c)=>{const h=c.listener,{forwardX:u,forwardY:d,forwardZ:p,positionX:m,positionY:f,positionZ:g,upX:v,upY:x,upZ:y}=void 0===h.forwardX?(()=>{const u=new Float32Array(1),d=t(c,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),p=a(c);let m=!1,f=[0,0,-1,0,1,0],g=[0,0,0];const v=()=>{if(m)return;m=!0;const e=i(c,256,9,0);e.onaudioprocess=({inputBuffer:e})=>{const t=[r(e,u,0),r(e,u,1),r(e,u,2),r(e,u,3),r(e,u,4),r(e,u,5)];t.some((e,t)=>e!==f[t])&&(h.setOrientation(...t),f=t);const n=[r(e,u,6),r(e,u,7),r(e,u,8)];n.some((e,t)=>e!==g[t])&&(h.setPosition(...n),g=n)},d.connect(e)},x=e=>t=>{t!==f[e]&&(f[e]=t,h.setOrientation(...f))},y=e=>t=>{t!==g[e]&&(g[e]=t,h.setPosition(...g))},_=(t,i,r)=>{const a=n(c,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:i});a.connect(d,0,t),a.start(),Object.defineProperty(a.offset,"defaultValue",{get:()=>i});const h=e({context:l},p,a.offset,tv,ev);var u,m,f,g,x,y,_;return o(h,"value",e=>()=>e.call(h),e=>t=>{try{e.call(h,t)}catch(n){if(9!==n.code)throw n}v(),p&&r(t)}),h.cancelAndHoldAtTime=(u=h.cancelAndHoldAtTime,p?()=>{throw s()}:(...e)=>{const t=u.apply(h,e);return v(),t}),h.cancelScheduledValues=(m=h.cancelScheduledValues,p?()=>{throw s()}:(...e)=>{const t=m.apply(h,e);return v(),t}),h.exponentialRampToValueAtTime=(f=h.exponentialRampToValueAtTime,p?()=>{throw s()}:(...e)=>{const t=f.apply(h,e);return v(),t}),h.linearRampToValueAtTime=(g=h.linearRampToValueAtTime,p?()=>{throw s()}:(...e)=>{const t=g.apply(h,e);return v(),t}),h.setTargetAtTime=(x=h.setTargetAtTime,p?()=>{throw s()}:(...e)=>{const t=x.apply(h,e);return v(),t}),h.setValueAtTime=(y=h.setValueAtTime,p?()=>{throw s()}:(...e)=>{const t=y.apply(h,e);return v(),t}),h.setValueCurveAtTime=(_=h.setValueCurveAtTime,p?()=>{throw s()}:(...e)=>{const t=_.apply(h,e);return v(),t}),h};return{forwardX:_(0,0,x(0)),forwardY:_(1,0,x(1)),forwardZ:_(2,-1,x(2)),positionX:_(6,0,y(0)),positionY:_(7,0,y(1)),positionZ:_(8,0,y(2)),upX:_(3,0,x(3)),upY:_(4,1,x(4)),upZ:_(5,0,x(5))}})():h;return{get forwardX(){return u},get forwardY(){return d},get forwardZ(){return p},get positionX(){return m},get positionY(){return f},get positionZ(){return g},get upX(){return v},get upY(){return x},get upZ(){return y}}})(Dy,Jy,s_,hx,ux,xx,Qx,_x),M_=new WeakMap,T_=((e,t,n,i,s,r)=>class extends n{constructor(n,r){super(n),this._nativeContext=n,Rg.set(this,n),i(n)&&s.set(n,new Set),this._destination=new e(this,r),this._listener=t(this,n),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(e){const t="function"==typeof e?r(this,e):null;this._nativeContext.onstatechange=t;const n=this._nativeContext.onstatechange;this._onstatechange=null!==n&&n===t?e:n}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(Oy,S_,ny,Qx,M_,Ex),E_=((e,t,n,i,s,r)=>(a,o)=>{const l=a.createOscillator();return Zv(l,o),Jv(l,o,"detune"),Jv(l,o,"frequency"),void 0!==o.periodicWave?l.setPeriodicWave(o.periodicWave):$v(l,o,"type"),t(n,()=>n(a))||Qv(l),t(i,()=>i(a))||r(l,a),t(s,()=>s(a))||ex(l),e(a,l),l})(wy,kx,wx,Sx,Mx,Tx),C_=((e,t,n,i,s)=>()=>{const r=new WeakMap;let a=null,o=null,l=null;return{set periodicWave(e){a=e},set start(e){o=e},set stop(e){l=e},render(c,h){const u=r.get(h);return void 0!==u?Promise.resolve(u):(async(c,h)=>{let u=n(c);const d=$g(u,h);if(!d){const e={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,detune:u.detune.value,frequency:u.frequency.value,periodicWave:null===a?void 0:a,type:u.type};u=t(h,e),null!==o&&u.start(o),null!==l&&u.stop(l)}return r.set(h,u),d?(await e(h,c.detune,u.detune),await e(h,c.frequency,u.frequency)):(await i(h,c.detune,u.detune),await i(h,c.frequency,u.frequency)),await s(c,h,u),u})(c,h)}}})(Ay,E_,yv,Iy,Wx),A_=((e,t,n,i,s,r,a)=>class extends e{constructor(e,a){const o=s(e),l={...px,...a},c=n(o,l),h=r(o),u=h?i():null,d=e.sampleRate/2;super(e,!1,c,u),this._detune=t(this,h,c.detune,153600,-153600),this._frequency=t(this,h,c.frequency,d,-d),this._nativeOscillatorNode=c,this._onended=null,this._oscillatorNodeRenderer=u,null!==this._oscillatorNodeRenderer&&void 0!==l.periodicWave&&(this._oscillatorNodeRenderer.periodicWave=l.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(e){const t="function"==typeof e?a(this,e):null;this._nativeOscillatorNode.onended=t;const n=this._nativeOscillatorNode.onended;this._onended=null!==n&&n===t?e:n}get type(){return this._nativeOscillatorNode.type}set type(e){this._nativeOscillatorNode.type=e,null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(e){this._nativeOscillatorNode.setPeriodicWave(e),null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.periodicWave=e)}start(e=0){if(this._nativeOscillatorNode.start(e),null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.start=e),"closed"!==this.context.state){Wg(this);const e=()=>{this._nativeOscillatorNode.removeEventListener("ended",e),nv(this)&&qg(this)};this._nativeOscillatorNode.addEventListener("ended",e)}}stop(e=0){this._nativeOscillatorNode.stop(e),null!==this._oscillatorNodeRenderer&&(this._oscillatorNodeRenderer.stop=e)}})(hy,Dy,E_,C_,$x,Qx,Ex),N_=(R_=Ry,(e,t)=>{const n=R_(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=e.createBuffer(1,2,44100);return n.buffer=i,n.loop=!0,n.connect(t),n.start(),()=>{n.stop(),n.disconnect(t)}});var R_;const P_=((e,t,n,i,s)=>(r,{curve:a,oversample:o,...l})=>{const c=r.createWaveShaper(),h=r.createWaveShaper();Zv(c,l),Zv(h,l);const u=n(r,{...l,gain:1}),d=n(r,{...l,gain:-1}),p=n(r,{...l,gain:1}),m=n(r,{...l,gain:-1});let f=null,g=!1,v=null;const x={get bufferSize(){},get channelCount(){return c.channelCount},set channelCount(e){u.channelCount=e,d.channelCount=e,c.channelCount=e,p.channelCount=e,h.channelCount=e,m.channelCount=e},get channelCountMode(){return c.channelCountMode},set channelCountMode(e){u.channelCountMode=e,d.channelCountMode=e,c.channelCountMode=e,p.channelCountMode=e,h.channelCountMode=e,m.channelCountMode=e},get channelInterpretation(){return c.channelInterpretation},set channelInterpretation(e){u.channelInterpretation=e,d.channelInterpretation=e,c.channelInterpretation=e,p.channelInterpretation=e,h.channelInterpretation=e,m.channelInterpretation=e},get context(){return c.context},get curve(){return v},set curve(n){if(null!==n&&n.length<2)throw t();if(null===n)c.curve=n,h.curve=n;else{const e=n.length,t=new Float32Array(e+2-e%2),i=new Float32Array(e+2-e%2);t[0]=n[0],i[0]=-n[e-1];const s=Math.ceil((e+1)/2),r=(e+1)/2-1;for(let a=1;a<s;a+=1){const o=a/s*r,l=Math.floor(o),c=Math.ceil(o);t[a]=l===c?n[l]:(1-(o-l))*n[l]+(1-(c-o))*n[c],i[a]=l===c?-n[e-1-l]:-(1-(o-l))*n[e-1-l]-(1-(c-o))*n[e-1-c]}t[s]=e%2==1?n[s-1]:(n[s-2]+n[s-1])/2,c.curve=t,h.curve=i}v=n,g&&(i(v)&&null===f?f=e(r,u):null!==f&&(f(),f=null))},get inputs(){return[u]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return c.numberOfOutputs},get oversample(){return c.oversample},set oversample(e){c.oversample=e,h.oversample=e},addEventListener:(...e)=>u.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>u.dispatchEvent(e[0]),removeEventListener:(...e)=>u.removeEventListener(e[0],e[1],e[2])};return null!==a&&(x.curve=a instanceof Float32Array?a:new Float32Array(a)),o!==x.oversample&&(x.oversample=o),s(sx(x,p),()=>{u.connect(c).connect(p),u.connect(d).connect(h).connect(m).connect(p),g=!0,i(v)&&(f=e(r,u))},()=>{u.disconnect(c),c.disconnect(p),u.disconnect(d),d.disconnect(h),h.disconnect(m),m.disconnect(p),g=!1,null!==f&&(f(),f=null)})})(N_,Hv,ax,yx,$y),I_=((e,t,n,i,s,r,a)=>(o,l)=>{const c=o.createWaveShaper();if(null!==r&&"webkitAudioContext"===r.name&&void 0===o.createGain().gain.automationRate)return n(o,l);Zv(c,l);const h=null===l.curve||l.curve instanceof Float32Array?l.curve:new Float32Array(l.curve);if(null!==h&&h.length<2)throw t();$v(c,{curve:h},"curve"),$v(c,l,"oversample");let u=null,d=!1;return a(c,"curve",e=>()=>e.call(c),t=>n=>(t.call(c,n),d&&(i(n)&&null===u?u=e(o,c):i(n)||null===u||(u(),u=null)),n)),s(c,()=>{d=!0,i(c.curve)&&(u=e(o,c))},()=>{d=!1,null!==u&&(u(),u=null)})})(N_,Hv,P_,yx,$y,sy,_x),j_=((e,t,n,i,s,r,a,o,l,c)=>(h,{coneInnerAngle:u,coneOuterAngle:d,coneOuterGain:p,distanceModel:m,maxDistance:f,orientationX:g,orientationY:v,orientationZ:x,panningModel:y,positionX:_,positionY:b,positionZ:w,refDistance:S,rolloffFactor:M,...T})=>{const E=h.createPanner();if(T.channelCount>2)throw a();if("max"===T.channelCountMode)throw a();Zv(E,T);const C={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},A=n(h,{...C,channelInterpretation:"speakers",numberOfInputs:6}),N=i(h,{...T,gain:1}),R=i(h,{...C,gain:1}),P=i(h,{...C,gain:0}),I=i(h,{...C,gain:0}),j=i(h,{...C,gain:0}),D=i(h,{...C,gain:0}),k=i(h,{...C,gain:0}),L=s(h,256,6,1),O=r(h,{...C,curve:new Float32Array([1,1]),oversample:"none"});let U=[g,v,x],F=[_,b,w];const B=new Float32Array(1);L.onaudioprocess=({inputBuffer:e})=>{const t=[l(e,B,0),l(e,B,1),l(e,B,2)];t.some((e,t)=>e!==U[t])&&(E.setOrientation(...t),U=t);const n=[l(e,B,3),l(e,B,4),l(e,B,5)];n.some((e,t)=>e!==F[t])&&(E.setPosition(...n),F=n)},Object.defineProperty(P.gain,"defaultValue",{get:()=>0}),Object.defineProperty(I.gain,"defaultValue",{get:()=>0}),Object.defineProperty(j.gain,"defaultValue",{get:()=>0}),Object.defineProperty(D.gain,"defaultValue",{get:()=>0}),Object.defineProperty(k.gain,"defaultValue",{get:()=>0});const z={get bufferSize(){},get channelCount(){return E.channelCount},set channelCount(e){if(e>2)throw a();N.channelCount=e,E.channelCount=e},get channelCountMode(){return E.channelCountMode},set channelCountMode(e){if("max"===e)throw a();N.channelCountMode=e,E.channelCountMode=e},get channelInterpretation(){return E.channelInterpretation},set channelInterpretation(e){N.channelInterpretation=e,E.channelInterpretation=e},get coneInnerAngle(){return E.coneInnerAngle},set coneInnerAngle(e){E.coneInnerAngle=e},get coneOuterAngle(){return E.coneOuterAngle},set coneOuterAngle(e){E.coneOuterAngle=e},get coneOuterGain(){return E.coneOuterGain},set coneOuterGain(e){if(e<0||e>1)throw t();E.coneOuterGain=e},get context(){return E.context},get distanceModel(){return E.distanceModel},set distanceModel(e){E.distanceModel=e},get inputs(){return[N]},get maxDistance(){return E.maxDistance},set maxDistance(e){if(e<0)throw new RangeError;E.maxDistance=e},get numberOfInputs(){return E.numberOfInputs},get numberOfOutputs(){return E.numberOfOutputs},get orientationX(){return R.gain},get orientationY(){return P.gain},get orientationZ(){return I.gain},get panningModel(){return E.panningModel},set panningModel(e){E.panningModel=e},get positionX(){return j.gain},get positionY(){return D.gain},get positionZ(){return k.gain},get refDistance(){return E.refDistance},set refDistance(e){if(e<0)throw new RangeError;E.refDistance=e},get rolloffFactor(){return E.rolloffFactor},set rolloffFactor(e){if(e<0)throw new RangeError;E.rolloffFactor=e},addEventListener:(...e)=>N.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>N.dispatchEvent(e[0]),removeEventListener:(...e)=>N.removeEventListener(e[0],e[1],e[2])};return u!==z.coneInnerAngle&&(z.coneInnerAngle=u),d!==z.coneOuterAngle&&(z.coneOuterAngle=d),p!==z.coneOuterGain&&(z.coneOuterGain=p),m!==z.distanceModel&&(z.distanceModel=m),f!==z.maxDistance&&(z.maxDistance=f),g!==z.orientationX.value&&(z.orientationX.value=g),v!==z.orientationY.value&&(z.orientationY.value=v),x!==z.orientationZ.value&&(z.orientationZ.value=x),y!==z.panningModel&&(z.panningModel=y),_!==z.positionX.value&&(z.positionX.value=_),b!==z.positionY.value&&(z.positionY.value=b),w!==z.positionZ.value&&(z.positionZ.value=w),S!==z.refDistance&&(z.refDistance=S),M!==z.rolloffFactor&&(z.rolloffFactor=M),1===U[0]&&0===U[1]&&0===U[2]||E.setOrientation(...U),0===F[0]&&0===F[1]&&0===F[2]||E.setPosition(...F),c(sx(z,E),()=>{N.connect(E),e(N,O,0,0),O.connect(R).connect(A,0,0),O.connect(P).connect(A,0,1),O.connect(I).connect(A,0,2),O.connect(j).connect(A,0,3),O.connect(D).connect(A,0,4),O.connect(k).connect(A,0,5),A.connect(L).connect(h.destination)},()=>{N.disconnect(E),o(N,O,0,0),O.disconnect(R),R.disconnect(A),O.disconnect(P),P.disconnect(A),O.disconnect(I),I.disconnect(A),O.disconnect(j),j.disconnect(A),O.disconnect(D),D.disconnect(A),O.disconnect(k),k.disconnect(A),A.disconnect(L),L.disconnect(h.destination)})})(mv,Hv,Jy,ax,hx,I_,ux,xv,xx,$y),D_=(k_=j_,(e,t)=>{const n=e.createPanner();return void 0===n.orientationX?k_(e,t):(Zv(n,t),Jv(n,t,"orientationX"),Jv(n,t,"orientationY"),Jv(n,t,"orientationZ"),Jv(n,t,"positionX"),Jv(n,t,"positionY"),Jv(n,t,"positionZ"),$v(n,t,"coneInnerAngle"),$v(n,t,"coneOuterAngle"),$v(n,t,"coneOuterGain"),$v(n,t,"distanceModel"),$v(n,t,"maxDistance"),$v(n,t,"panningModel"),$v(n,t,"refDistance"),$v(n,t,"rolloffFactor"),n)});var k_;const L_=((e,t,n,i,s,r,a,o,l,c)=>()=>{const h=new WeakMap;let u=null;return{render(d,p){const m=h.get(p);return void 0!==m?Promise.resolve(m):(async(d,p)=>{let m=null,f=r(d);const g={channelCount:f.channelCount,channelCountMode:f.channelCountMode,channelInterpretation:f.channelInterpretation},v={...g,coneInnerAngle:f.coneInnerAngle,coneOuterAngle:f.coneOuterAngle,coneOuterGain:f.coneOuterGain,distanceModel:f.distanceModel,maxDistance:f.maxDistance,panningModel:f.panningModel,refDistance:f.refDistance,rolloffFactor:f.rolloffFactor},x=$g(f,p);if("bufferSize"in f)m=i(p,{...g,gain:1});else if(!x){const e={...v,orientationX:f.orientationX.value,orientationY:f.orientationY.value,orientationZ:f.orientationZ.value,positionX:f.positionX.value,positionY:f.positionY.value,positionZ:f.positionZ.value};f=s(p,e)}if(h.set(p,null===m?f:m),null!==m){if(null===u){if(null===a)throw new Error("Missing the native OfflineAudioContext constructor.");const e=new a(6,d.context.length,p.sampleRate),i=t(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});i.connect(e.destination),u=(async()=>{const t=await Promise.all([d.orientationX,d.orientationY,d.orientationZ,d.positionX,d.positionY,d.positionZ].map(async(t,i)=>{const s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:0===i?1:0});return await o(e,t,s.offset),s}));for(let e=0;e<6;e+=1)t[e].connect(i,0,e),t[e].start(0);return c(e)})()}const e=await u,r=i(p,{...g,gain:1});await l(d,p,r);const h=[];for(let t=0;t<e.numberOfChannels;t+=1)h.push(e.getChannelData(t));let f=[h[0][0],h[1][0],h[2][0]],x=[h[3][0],h[4][0],h[5][0]],y=i(p,{...g,gain:1}),_=s(p,{...v,orientationX:f[0],orientationY:f[1],orientationZ:f[2],positionX:x[0],positionY:x[1],positionZ:x[2]});r.connect(y).connect(_.inputs[0]),_.connect(m);for(let t=128;t<e.length;t+=128){const e=[h[0][t],h[1][t],h[2][t]],n=[h[3][t],h[4][t],h[5][t]];if(e.some((e,t)=>e!==f[t])||n.some((e,t)=>e!==x[t])){f=e,x=n;const a=t/p.sampleRate;y.gain.setValueAtTime(0,a),y=i(p,{...g,gain:0}),_=s(p,{...v,orientationX:f[0],orientationY:f[1],orientationZ:f[2],positionX:x[0],positionY:x[1],positionZ:x[2]}),y.gain.setValueAtTime(1,a),r.connect(y).connect(_.inputs[0]),_.connect(m)}}return m}return x?(await e(p,d.orientationX,f.orientationX),await e(p,d.orientationY,f.orientationY),await e(p,d.orientationZ,f.orientationZ),await e(p,d.positionX,f.positionX),await e(p,d.positionY,f.positionY),await e(p,d.positionZ,f.positionZ)):(await o(p,d.orientationX,f.orientationX),await o(p,d.orientationY,f.orientationY),await o(p,d.orientationZ,f.orientationZ),await o(p,d.positionX,f.positionX),await o(p,d.positionY,f.positionY),await o(p,d.positionZ,f.positionZ)),pv(f)?await l(d,p,f.inputs[0]):await l(d,p,f),f})(d,p)}}})(Ay,Jy,s_,ax,D_,yv,Kx,Iy,Wx,y_),O_=((e,t,n,i,s,r,a)=>class extends e{constructor(e,o){const l=s(e),c={...mx,...o},h=n(l,c),u=r(l);super(e,!1,h,u?i():null),this._nativePannerNode=h,this._orientationX=t(this,u,h.orientationX,tv,ev),this._orientationY=t(this,u,h.orientationY,tv,ev),this._orientationZ=t(this,u,h.orientationZ,tv,ev),this._positionX=t(this,u,h.positionX,tv,ev),this._positionY=t(this,u,h.positionY,tv,ev),this._positionZ=t(this,u,h.positionZ,tv,ev),a(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(e){this._nativePannerNode.coneInnerAngle=e}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(e){this._nativePannerNode.coneOuterAngle=e}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(e){this._nativePannerNode.coneOuterGain=e}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(e){this._nativePannerNode.distanceModel=e}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(e){this._nativePannerNode.maxDistance=e}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(e){this._nativePannerNode.panningModel=e}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(e){this._nativePannerNode.refDistance=e}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(e){this._nativePannerNode.rolloffFactor=e}})(hy,Dy,D_,L_,$x,Qx,Fy),U_=(e=>(t,{disableNormalization:n,imag:i,real:s})=>{const r=i instanceof Float32Array?i:new Float32Array(i),a=s instanceof Float32Array?s:new Float32Array(s),o=t.createPeriodicWave(a,r,{disableNormalization:n});if(Array.from(i).length<2)throw e();return o})(Kg),F_=((e,t,n)=>class i{constructor(i,s){const r=t(i),a=(e=>{const{imag:t,real:n}=e;return void 0===t?void 0===n?{...e,imag:[0,0],real:[0,0]}:{...e,imag:Array.from(n,()=>0),real:n}:void 0===n?{...e,imag:t,real:Array.from(t,()=>0)}:{...e,imag:t,real:n}})({...fx,...s}),o=e(r,a);return n.add(o),o}static[Symbol.hasInstance](e){return null!==e&&"object"==typeof e&&Object.getPrototypeOf(e)===i.prototype||n.has(e)}})(U_,$x,new WeakSet),B_=((e,t,n,i,s,r)=>{const a=16385,o=new Float32Array([1,1]),l=Math.PI/2,c={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},h={...c,oversample:"none"},u=(e,r,u,d,p)=>{if(1===r)return((e,t,s,r)=>{const u=new Float32Array(a),d=new Float32Array(a);for(let n=0;n<a;n+=1){const e=n/16384*l;u[n]=Math.cos(e),d[n]=Math.sin(e)}const p=n(e,{...c,gain:0}),m=i(e,{...h,curve:u}),f=i(e,{...h,curve:o}),g=n(e,{...c,gain:0}),v=i(e,{...h,curve:d});return{connectGraph(){t.connect(p),t.connect(void 0===f.inputs?f:f.inputs[0]),t.connect(g),f.connect(s),s.connect(void 0===m.inputs?m:m.inputs[0]),s.connect(void 0===v.inputs?v:v.inputs[0]),m.connect(p.gain),v.connect(g.gain),p.connect(r,0,0),g.connect(r,0,1)},disconnectGraph(){t.disconnect(p),t.disconnect(void 0===f.inputs?f:f.inputs[0]),t.disconnect(g),f.disconnect(s),s.disconnect(void 0===m.inputs?m:m.inputs[0]),s.disconnect(void 0===v.inputs?v:v.inputs[0]),m.disconnect(p.gain),v.disconnect(g.gain),p.disconnect(r,0,0),g.disconnect(r,0,1)}}})(e,u,d,p);if(2===r)return((e,s,r,u)=>{const d=new Float32Array(a),p=new Float32Array(a),m=new Float32Array(a),f=new Float32Array(a),g=Math.floor(8192.5);for(let t=0;t<a;t+=1)if(t>g){const e=(t-g)/(16384-g)*l;d[t]=Math.cos(e),p[t]=Math.sin(e),m[t]=0,f[t]=1}else{const e=t/(16384-g)*l;d[t]=1,p[t]=0,m[t]=Math.cos(e),f[t]=Math.sin(e)}const v=t(e,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),x=n(e,{...c,gain:0}),y=i(e,{...h,curve:d}),_=n(e,{...c,gain:0}),b=i(e,{...h,curve:p}),w=i(e,{...h,curve:o}),S=n(e,{...c,gain:0}),M=i(e,{...h,curve:m}),T=n(e,{...c,gain:0}),E=i(e,{...h,curve:f});return{connectGraph(){s.connect(v),s.connect(void 0===w.inputs?w:w.inputs[0]),v.connect(x,0),v.connect(_,0),v.connect(S,1),v.connect(T,1),w.connect(r),r.connect(void 0===y.inputs?y:y.inputs[0]),r.connect(void 0===b.inputs?b:b.inputs[0]),r.connect(void 0===M.inputs?M:M.inputs[0]),r.connect(void 0===E.inputs?E:E.inputs[0]),y.connect(x.gain),b.connect(_.gain),M.connect(S.gain),E.connect(T.gain),x.connect(u,0,0),S.connect(u,0,0),_.connect(u,0,1),T.connect(u,0,1)},disconnectGraph(){s.disconnect(v),s.disconnect(void 0===w.inputs?w:w.inputs[0]),v.disconnect(x,0),v.disconnect(_,0),v.disconnect(S,1),v.disconnect(T,1),w.disconnect(r),r.disconnect(void 0===y.inputs?y:y.inputs[0]),r.disconnect(void 0===b.inputs?b:b.inputs[0]),r.disconnect(void 0===M.inputs?M:M.inputs[0]),r.disconnect(void 0===E.inputs?E:E.inputs[0]),y.disconnect(x.gain),b.disconnect(_.gain),M.disconnect(S.gain),E.disconnect(T.gain),x.disconnect(u,0,0),S.disconnect(u,0,0),_.disconnect(u,0,1),T.disconnect(u,0,1)}}})(e,u,d,p);throw s()};return(t,{channelCount:i,channelCountMode:a,pan:o,...l})=>{if("max"===a)throw s();const c=e(t,{...l,channelCount:1,channelCountMode:a,numberOfInputs:2}),h=n(t,{...l,channelCount:i,channelCountMode:a,gain:1}),d=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:o});let{connectGraph:p,disconnectGraph:m}=u(t,i,h,d,c);Object.defineProperty(d.gain,"defaultValue",{get:()=>0}),Object.defineProperty(d.gain,"maxValue",{get:()=>1}),Object.defineProperty(d.gain,"minValue",{get:()=>-1});const f={get bufferSize(){},get channelCount(){return h.channelCount},set channelCount(e){h.channelCount!==e&&(g&&m(),({connectGraph:p,disconnectGraph:m}=u(t,e,h,d,c)),g&&p()),h.channelCount=e},get channelCountMode(){return h.channelCountMode},set channelCountMode(e){if("clamped-max"===e||"max"===e)throw s();h.channelCountMode=e},get channelInterpretation(){return h.channelInterpretation},set channelInterpretation(e){h.channelInterpretation=e},get context(){return h.context},get inputs(){return[h]},get numberOfInputs(){return h.numberOfInputs},get numberOfOutputs(){return h.numberOfOutputs},get pan(){return d.gain},addEventListener:(...e)=>h.addEventListener(e[0],e[1],e[2]),dispatchEvent:(...e)=>h.dispatchEvent(e[0]),removeEventListener:(...e)=>h.removeEventListener(e[0],e[1],e[2])};let g=!1;return r(sx(f,c),()=>{p(),g=!0},()=>{m(),g=!1})}})(Jy,ix,ax,I_,ux,$y),z_=((e,t)=>(n,i)=>{const s=i.channelCountMode;if("clamped-max"===s)throw t();if(void 0===n.createStereoPanner)return e(n,i);const r=n.createStereoPanner();return Zv(r,i),Jv(r,i,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>s,set:e=>{if(e!==s)throw t()}}),r})(B_,ux),V_=((e,t,n,i,s)=>()=>{const r=new WeakMap;return{render(a,o){const l=r.get(o);return void 0!==l?Promise.resolve(l):(async(a,o)=>{let l=n(a);const c=$g(l,o);if(!c){const e={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,pan:l.pan.value};l=t(o,e)}return r.set(o,l),c?await e(o,a.pan,l.pan):await i(o,a.pan,l.pan),pv(l)?await s(a,o,l.inputs[0]):await s(a,o,l),l})(a,o)}}})(Ay,z_,yv,Iy,Wx),H_=((e,t,n,i,s,r)=>class extends e{constructor(e,a){const o=s(e),l={...gx,...a},c=n(o,l),h=r(o);super(e,!1,c,h?i():null),this._pan=t(this,h,c.pan)}get pan(){return this._pan}})(hy,Dy,z_,V_,$x,Qx),W_=((e,t,n)=>()=>{const i=new WeakMap;return{render(s,r){const a=i.get(r);return void 0!==a?Promise.resolve(a):(async(s,r)=>{let a=t(s);if(!$g(a,r)){const t={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,curve:a.curve,oversample:a.oversample};a=e(r,t)}return i.set(r,a),pv(a)?await n(s,r,a.inputs[0]):await n(s,r,a),a})(s,r)}}})(I_,yv,Wx),G_=((e,t,n,i,s,r,a)=>class extends e{constructor(e,t){const o=s(e),l={...vx,...t},c=n(o,l);super(e,!0,c,r(o)?i():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=c,a(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(e){if(null===e)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(e.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=e}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(e){this._nativeWaveShaperNode.oversample=e}})(hy,Hv,I_,W_,$x,Qx,Fy),q_=null!==Ux&&Ux.isSecureContext,X_=(e=>(t,n,i)=>{Object.defineProperties(e,{currentFrame:{configurable:!0,get:()=>Math.round(t*n)},currentTime:{configurable:!0,get:()=>t}});try{return i()}finally{null!==e&&(delete e.currentFrame,delete e.currentTime)}})(Ux),Y_=new WeakMap,$_=((e,t)=>n=>{let i=e.get(n);if(void 0!==i)return i;if(null===t)throw new Error("Missing the native OfflineAudioContext constructor.");return i=new t(1,1,44100),e.set(n,i),i})(Y_,Kx),Z_=q_?((e,t,n,i,s,r,a,o,l,c,h,u,d)=>{let p=0;return(m,f,g={credentials:"omit"})=>{const v=h.get(m);if(void 0!==v&&v.has(f))return Promise.resolve();const x=c.get(m);if(void 0!==x){const e=x.get(f);if(void 0!==e)return e}const y=r(m),_=void 0===y.audioWorklet?s(f).then(([e,t])=>{const[i,s]=Og(e,t);return n(`${i};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${s}\n})})(window,'_AWGS')`)}).then(()=>{const e=d._AWGS.pop();if(void 0===e)throw new SyntaxError;i(y.currentTime,y.sampleRate,()=>e(class{},void 0,(e,n)=>{if(""===e.trim())throw t();const i=jg.get(y);if(void 0!==i){if(i.has(e))throw t();Fg(n),Ug(n.parameterDescriptors),i.set(e,n)}else Fg(n),Ug(n.parameterDescriptors),jg.set(y,new Map([[e,n]]))},y.sampleRate,void 0,void 0))}):Promise.all([s(f),Promise.resolve(e(u,u))]).then(([[e,t],n])=>{const i=p+1;p=i;const[s,r]=Og(e,t),c=new Blob([`${s};((AudioWorkletProcessor,registerProcessor)=>{${r}\n})(${n?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${n?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${n?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${i}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),h=URL.createObjectURL(c);return y.audioWorklet.addModule(h,g).then(()=>{if(o(y))return y;const e=a(y);return e.audioWorklet.addModule(h,g).then(()=>e)}).then(e=>{if(null===l)throw new SyntaxError;try{new l(e,`__sac${i}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(h))});return void 0===x?c.set(m,new Map([[f,_]])):x.set(f,_),_.then(()=>{const e=h.get(m);void 0===e?h.set(m,new Set([f])):e.add(f)}).finally(()=>{const e=c.get(m);void 0!==e&&e.delete(f)}),_}})(kx,ux,(e=>t=>new Promise((n,i)=>{if(null===e)return void i(new SyntaxError);const s=e.document.head;if(null===s)i(new SyntaxError);else{const r=e.document.createElement("script"),a=new Blob([t],{type:"application/javascript"}),o=URL.createObjectURL(a),l=e.onerror,c=()=>{e.onerror=l,URL.revokeObjectURL(o)};e.onerror=(t,n,s,r,a)=>n===o||n===e.location.href&&1===s&&1===r?(c(),i(a),!1):null!==l?l(t,n,s,r,a):void 0,r.onerror=()=>{c(),i(new SyntaxError)},r.onload=()=>{c(),n()},r.src=o,r.type="module",s.appendChild(r)}}))(Ux),X_,(K_=()=>new DOMException("","AbortError"),async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw K_()}),$x,$_,Qx,cy,new WeakMap,new WeakMap,((e,t)=>async()=>{if(null===e)return!0;if(null===t)return!1;const n=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),i=new t(1,128,44100),s=URL.createObjectURL(n);let r=!1,a=!1;try{await i.audioWorklet.addModule(s);const t=new e(i,"a",{numberOfOutputs:0}),n=i.createOscillator();t.port.onmessage=()=>r=!0,t.onprocessorerror=()=>a=!0,n.connect(t),n.start(0),await i.startRendering(),await new Promise(e=>setTimeout(e))}catch{}finally{URL.revokeObjectURL(s)}return r&&!a})(cy,Kx),Ux):void 0;var K_;const J_=((e,t)=>n=>e(n)||t(n))(ry,Qx),Q_=((e,t,n,i,s,r,a,o,l,c,h)=>(n,i)=>{const u=a(n)?n:r(n);if(s.has(i)){const e=new DOMException("","DataCloneError");return Promise.reject(e)}try{s.add(i)}catch{}return t(l,()=>l(u))?u.decodeAudioData(i).then(n=>(Uv(i).catch(()=>{}),t(o,()=>o(n))||h(n),e.add(n),n)):new Promise((t,n)=>{const s=async()=>{try{await Uv(i)}catch{}},r=e=>{n(e),s()};try{u.decodeAudioData(i,n=>{"function"!=typeof n.copyFromChannel&&(c(n),Jg(n)),e.add(n),s().then(()=>t(n))},e=>{r(null===e?new DOMException("","EncodingError"):e)})}catch(a){r(a)}})})(py,kx,0,0,new WeakSet,$x,J_,Zg,Yv,vy,xy),eb=(tb=Z_,nb=dy,ib=_y,sb=Ly,rb=By,ab=e_,ob=n_,lb=a_,cb=c_,hb=Q_,ub=u_,db=f_,pb=v_,mb=w_,fb=T_,gb=A_,vb=O_,xb=F_,yb=H_,_b=G_,class extends fb{constructor(e,t){super(e,t),this._nativeContext=e,this._audioWorklet=void 0===tb?void 0:{addModule:(e,t)=>tb(this,e,t)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new nb(this)}createBiquadFilter(){return new rb(this)}createBuffer(e,t,n){return new ib({length:t,numberOfChannels:e,sampleRate:n})}createBufferSource(){return new sb(this)}createChannelMerger(e=6){return new ab(this,{numberOfInputs:e})}createChannelSplitter(e=6){return new ob(this,{numberOfOutputs:e})}createConstantSource(){return new lb(this)}createConvolver(){return new cb(this)}createDelay(e=1){return new ub(this,{maxDelayTime:e})}createDynamicsCompressor(){return new db(this)}createGain(){return new pb(this)}createIIRFilter(e,t){return new mb(this,{feedback:t,feedforward:e})}createOscillator(){return new gb(this)}createPanner(){return new vb(this)}createPeriodicWave(e,t,n={disableNormalization:!1}){return new xb(this,{...n,imag:t,real:e})}createStereoPanner(){return new yb(this)}createWaveShaper(){return new _b(this)}decodeAudioData(e,t,n){return hb(this._nativeContext,e).then(e=>("function"==typeof t&&t(e),e),e=>{throw"function"==typeof n&&n(e),e})}});var tb,nb,ib,sb,rb,ab,ob,lb,cb,hb,ub,db,pb,mb,fb,gb,vb,xb,yb,_b;const bb=((e,t,n,i)=>class extends e{constructor(e,t){const s=n(e),r=((e,t)=>e.createMediaElementSource(t.mediaElement))(s,t);if(i(s))throw TypeError();super(e,!0,r,null),this._nativeMediaElementAudioSourceNode=r}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(hy,0,$x,Qx),wb=((e,t,n,i)=>class extends e{constructor(e,t){const s=n(e);if(i(s))throw new TypeError;const r=((e,t)=>{const n=e.createMediaStreamDestination();return Zv(n,t),1===n.numberOfOutputs&&Object.defineProperty(n,"numberOfOutputs",{get:()=>0}),n})(s,{...Xv,...t});super(e,!1,r,null),this._nativeMediaStreamAudioDestinationNode=r}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(hy,0,$x,Qx),Sb=((e,t,n,i)=>class extends e{constructor(e,t){const s=n(e),r=((e,{mediaStream:t})=>{const n=t.getAudioTracks();n.sort((e,t)=>e.id<t.id?-1:e.id>t.id?1:0);const i=n.slice(0,1),s=e.createMediaStreamSource(new MediaStream(i));return Object.defineProperty(s,"mediaStream",{value:t}),s})(s,t);if(i(s))throw new TypeError;super(e,!0,r,null),this._nativeMediaStreamAudioSourceNode=r}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(hy,0,$x,Qx),Mb=((e,t)=>(n,{mediaStreamTrack:i})=>{if("function"==typeof n.createMediaStreamTrackSource)return n.createMediaStreamTrackSource(i);const s=new MediaStream([i]),r=n.createMediaStreamSource(s);if("audio"!==i.kind)throw e();if(t(n))throw new TypeError;return r})(Hv,Qx),Tb=((e,t,n)=>class extends e{constructor(e,i){const s=n(e);super(e,!0,t(s,i),null)}})(hy,Mb,$x),Eb=((e,t,n,i,s,r,a,o,l)=>class extends e{constructor(e={}){if(null===l)throw new Error("Missing the native AudioContext constructor.");let t;try{t=new l(e)}catch(r){if(12===r.code&&"sampleRate is not in range"===r.message)throw n();throw r}if(null===t)throw new DOMException("","UnknownError");if(!(e=>void 0===e||"number"==typeof e||"string"==typeof e&&("balanced"===e||"interactive"===e||"playback"===e))(e.latencyHint))throw new TypeError(`The provided value '${e.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(void 0!==e.sampleRate&&t.sampleRate!==e.sampleRate)throw n();super(t,2);const{latencyHint:i}=e,{sampleRate:s}=t;if(this._baseLatency="number"==typeof t.baseLatency?t.baseLatency:"balanced"===i?512/s:"interactive"===i||void 0===i?256/s:"playback"===i?1024/s:128*Math.max(2,Math.min(128,Math.round(i*s/128)))/s,this._nativeAudioContext=t,"webkitAudioContext"===l.name?(this._nativeGainNode=t.createGain(),this._nativeOscillatorNode=t.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(t.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,"running"===t.state){this._state="suspended";const e=()=>{"suspended"===this._state&&(this._state=null),t.removeEventListener("statechange",e)};t.addEventListener("statechange",e)}}get baseLatency(){return this._baseLatency}get state(){return null!==this._state?this._state:this._nativeAudioContext.state}close(){return"closed"===this.state?this._nativeAudioContext.close().then(()=>{throw t()}):("suspended"===this._state&&(this._state=null),this._nativeAudioContext.close().then(()=>{null!==this._nativeGainNode&&null!==this._nativeOscillatorNode&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),ov(this)}))}createMediaElementSource(e){return new s(this,{mediaElement:e})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(e){return new a(this,{mediaStream:e})}createMediaStreamTrackSource(e){return new o(this,{mediaStreamTrack:e})}resume(){return"suspended"===this._state?new Promise((e,t)=>{const n=()=>{this._nativeAudioContext.removeEventListener("statechange",n),"running"===this._nativeAudioContext.state?e():this.resume().then(e,t)};this._nativeAudioContext.addEventListener("statechange",n)}):this._nativeAudioContext.resume().catch(e=>{if(void 0===e||15===e.code)throw t();throw e})}suspend(){return this._nativeAudioContext.suspend().catch(e=>{if(void 0===e)throw t();throw e})}})(eb,Hv,ux,0,bb,wb,Sb,Tb,sy),Cb=(Ab=M_,e=>{const t=Ab.get(e);if(void 0===t)throw new Error("The context has no set of AudioWorkletNodes.");return t});var Ab;const Nb=(Rb=Cb,(e,t)=>{Rb(e).add(t)});var Rb;const Pb=(e=>(t,n,i=0,s=0)=>{const r=t[i];if(void 0===r)throw e();return Tv(n)?r.connect(n,0,s):r.connect(n,0)})(Kg),Ib=(e=>(t,n)=>{e(t).delete(n)})(Cb),jb=(e=>(t,n=void 0,i=void 0,s=0)=>void 0===n?t.forEach(e=>e.disconnect()):"number"==typeof n?Bv(e,t,n).disconnect():Tv(n)?void 0===i?t.forEach(e=>e.disconnect(n)):void 0===s?Bv(e,t,i).disconnect(n,0):Bv(e,t,i).disconnect(n,0,s):void 0===i?t.forEach(e=>e.disconnect(n)):Bv(e,t,i).disconnect(n,0))(Kg),Db=new WeakMap,kb=(Lb=Db,Ob=Bg,e=>Ob(Lb,e));var Lb,Ob;const Ub=((e,t,n,i,s,r,a,o,l,c,h,u,d)=>(p,m,f,g)=>{if(0===g.numberOfInputs&&0===g.numberOfOutputs)throw l();const v=Array.isArray(g.outputChannelCount)?g.outputChannelCount:Array.from(g.outputChannelCount);if(v.some(e=>e<1))throw l();if(v.length!==g.numberOfOutputs)throw t();if("explicit"!==g.channelCountMode)throw l();const x=g.channelCount*g.numberOfInputs,y=v.reduce((e,t)=>e+t,0),_=void 0===f.parameterDescriptors?0:f.parameterDescriptors.length;if(x+_>6||y>6)throw l();const b=new MessageChannel,w=[],S=[];for(let e=0;e<g.numberOfInputs;e+=1)w.push(a(p,{channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1})),S.push(s(p,{channelCount:g.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:g.channelCount}));const M=[];if(void 0!==f.parameterDescriptors)for(const{defaultValue:e,maxValue:t,minValue:n,name:i}of f.parameterDescriptors){const s=r(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:void 0!==g.parameterData[i]?g.parameterData[i]:void 0===e?0:e});Object.defineProperties(s.offset,{defaultValue:{get:()=>void 0===e?0:e},maxValue:{get:()=>void 0===t?tv:t},minValue:{get:()=>void 0===n?ev:n}}),M.push(s)}const T=i(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,x+_)}),E=tx(m,p.sampleRate),C=o(p,E,x+_,Math.max(1,y)),A=s(p,{channelCount:Math.max(1,y),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,y)}),N=[];for(let e=0;e<g.numberOfOutputs;e+=1)N.push(i(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:v[e]}));for(let e=0;e<g.numberOfInputs;e+=1){w[e].connect(S[e]);for(let t=0;t<g.channelCount;t+=1)S[e].connect(T,t,e*g.channelCount+t)}const R=new Av(void 0===f.parameterDescriptors?[]:f.parameterDescriptors.map(({name:e},t)=>{const n=M[t];return n.connect(T,0,x+t),n.start(0),[e,n.offset]}));T.connect(C);let P=g.channelInterpretation,I=null;const j=0===g.numberOfOutputs?[C]:N,D={get bufferSize(){return E},get channelCount(){return g.channelCount},set channelCount(e){throw n()},get channelCountMode(){return g.channelCountMode},set channelCountMode(e){throw n()},get channelInterpretation(){return P},set channelInterpretation(e){for(const t of w)t.channelInterpretation=e;P=e},get context(){return C.context},get inputs(){return w},get numberOfInputs(){return g.numberOfInputs},get numberOfOutputs(){return g.numberOfOutputs},get onprocessorerror(){return I},set onprocessorerror(e){"function"==typeof I&&D.removeEventListener("processorerror",I),I="function"==typeof e?e:null,"function"==typeof I&&D.addEventListener("processorerror",I)},get parameters(){return R},get port(){return b.port2},addEventListener:(...e)=>C.addEventListener(e[0],e[1],e[2]),connect:e.bind(null,j),disconnect:c.bind(null,j),dispatchEvent:(...e)=>C.dispatchEvent(e[0]),removeEventListener:(...e)=>C.removeEventListener(e[0],e[1],e[2])},k=new Map;var L,O;b.port1.addEventListener=(L=b.port1.addEventListener,(...e)=>{if("message"===e[0]){const t="function"==typeof e[1]?e[1]:"object"==typeof e[1]&&null!==e[1]&&"function"==typeof e[1].handleEvent?e[1].handleEvent:null;if(null!==t){const n=k.get(e[1]);void 0!==n?e[1]=n:(e[1]=e=>{h(p.currentTime,p.sampleRate,()=>t(e))},k.set(t,e[1]))}}return L.call(b.port1,e[0],e[1],e[2])}),b.port1.removeEventListener=(O=b.port1.removeEventListener,(...e)=>{if("message"===e[0]){const t=k.get(e[1]);void 0!==t&&(k.delete(e[1]),e[1]=t)}return O.call(b.port1,e[0],e[1],e[2])});let U=null;Object.defineProperty(b.port1,"onmessage",{get:()=>U,set:e=>{"function"==typeof U&&b.port1.removeEventListener("message",U),U="function"==typeof e?e:null,"function"==typeof U&&(b.port1.addEventListener("message",U),b.port1.start())}}),f.prototype.port=b.port1;let F=null;const B=((e,t,n,i)=>{let s=Dg.get(e);void 0===s&&(s=new WeakMap,Dg.set(e,s));const r=(async(e,t)=>{const n=await(e=>new Promise((t,n)=>{const{port1:i,port2:s}=new MessageChannel;i.onmessage=({data:e})=>{i.close(),s.close(),t(e)},i.onmessageerror=({data:e})=>{i.close(),s.close(),n(e)},s.postMessage(e)}))(t);return new e(n)})(n,i);return s.set(t,r),r})(p,D,f,g);B.then(e=>F=e);const z=Iv(g.numberOfInputs,g.channelCount),V=Iv(g.numberOfOutputs,v),H=void 0===f.parameterDescriptors?[]:f.parameterDescriptors.reduce((e,{name:t})=>({...e,[t]:new Float32Array(128)}),{});let W=!0;const G=()=>{g.numberOfOutputs>0&&C.disconnect(A);for(let e=0,t=0;e<g.numberOfOutputs;e+=1){const n=N[e];for(let i=0;i<v[e];i+=1)A.disconnect(n,t+i,i);t+=v[e]}},q=new Map;C.onaudioprocess=({inputBuffer:e,outputBuffer:t})=>{if(null!==F){const i=u(D);for(let s=0;s<E;s+=128){for(let t=0;t<g.numberOfInputs;t+=1)for(let n=0;n<g.channelCount;n+=1)Rv(e,z[t],n,n,s);void 0!==f.parameterDescriptors&&f.parameterDescriptors.forEach(({name:t},n)=>{Rv(e,H,t,x+n,s)});for(let e=0;e<g.numberOfInputs;e+=1)for(let t=0;t<v[e];t+=1)0===V[e][t].byteLength&&(V[e][t]=new Float32Array(128));try{const e=z.map((e,t)=>{if(i[t].size>0)return q.set(t,E/128),e;const n=q.get(t);return void 0===n?[]:(e.every(e=>e.every(e=>0===e))&&(1===n?q.delete(t):q.set(t,n-1)),e)}),n=h(p.currentTime+s/p.sampleRate,p.sampleRate,()=>F.process(e,V,H));W=n;for(let i=0,r=0;i<g.numberOfOutputs;i+=1){for(let e=0;e<v[i];e+=1)Pv(t,V[i],e,r+e,s);r+=v[i]}}catch(n){W=!1,D.dispatchEvent(new ErrorEvent("processorerror",{colno:n.colno,filename:n.filename,lineno:n.lineno,message:n.message}))}if(!W){for(let e=0;e<g.numberOfInputs;e+=1){w[e].disconnect(S[e]);for(let t=0;t<g.channelCount;t+=1)S[s].disconnect(T,t,e*g.channelCount+t)}if(void 0!==f.parameterDescriptors){const e=f.parameterDescriptors.length;for(let t=0;t<e;t+=1){const e=M[t];e.disconnect(T,0,x+t),e.stop()}}T.disconnect(C),C.onaudioprocess=null,X?G():Z();break}}}};let X=!1;const Y=a(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),$=()=>C.connect(Y).connect(p.destination),Z=()=>{C.disconnect(Y),Y.disconnect()};return $(),d(D,()=>{if(W){Z(),g.numberOfOutputs>0&&C.connect(A);for(let e=0,t=0;e<g.numberOfOutputs;e+=1){const n=N[e];for(let i=0;i<v[e];i+=1)A.connect(n,t+i,i);t+=v[e]}}X=!0},()=>{W&&($(),G()),X=!1})})(Pb,Kg,Hv,Jy,ix,s_,ax,hx,ux,jb,X_,kb,$y),Fb=((e,t,n,i,s)=>(r,a,o,l,c,h)=>{if(null!==o)try{const t=new o(r,l,h),i=new Map;let a=null;if(Object.defineProperties(t,{channelCount:{get:()=>h.channelCount,set:()=>{throw e()}},channelCountMode:{get:()=>"explicit",set:()=>{throw e()}},onprocessorerror:{get:()=>a,set:e=>{"function"==typeof a&&t.removeEventListener("processorerror",a),a="function"==typeof e?e:null,"function"==typeof a&&t.addEventListener("processorerror",a)}}}),t.addEventListener=(d=t.addEventListener,(...e)=>{if("processorerror"===e[0]){const t="function"==typeof e[1]?e[1]:"object"==typeof e[1]&&null!==e[1]&&"function"==typeof e[1].handleEvent?e[1].handleEvent:null;if(null!==t){const n=i.get(e[1]);void 0!==n?e[1]=n:(e[1]=n=>{"error"===n.type?(Object.defineProperties(n,{type:{value:"processorerror"}}),t(n)):t(new ErrorEvent(e[0],{...n}))},i.set(t,e[1]))}}return d.call(t,"error",e[1],e[2]),d.call(t,...e)}),t.removeEventListener=(u=t.removeEventListener,(...e)=>{if("processorerror"===e[0]){const t=i.get(e[1]);void 0!==t&&(i.delete(e[1]),e[1]=t)}return u.call(t,"error",e[1],e[2]),u.call(t,e[0],e[1],e[2])}),0!==h.numberOfOutputs){const e=n(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return t.connect(e).connect(r.destination),s(t,()=>e.disconnect(),()=>e.connect(r.destination))}return t}catch(p){if(11===p.code)throw i();throw p}var u,d;if(void 0===c)throw i();return(e=>{const{port1:t}=new MessageChannel;try{t.postMessage(e)}finally{t.close()}})(h),t(r,a,c,h)})(Hv,Ub,ax,ux,$y),Bb=((e,t,n,i,s,r,a,o,l,c,h,u,d,p,m,f)=>(g,v,x)=>{const y=new WeakMap;let _=null;return{render(b,w){o(w,b);const S=y.get(w);return void 0!==S?Promise.resolve(S):(async(o,b)=>{let w=h(o),S=null;const M=$g(w,b),T=Array.isArray(v.outputChannelCount)?v.outputChannelCount:Array.from(v.outputChannelCount);if(null===u){const e=T.reduce((e,t)=>e+t,0),n=s(b,{channelCount:Math.max(1,e),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,e)}),r=[];for(let t=0;t<o.numberOfOutputs;t+=1)r.push(i(b,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:T[t]}));const c=a(b,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1});c.connect=t.bind(null,r),c.disconnect=l.bind(null,r),S=[n,r,c]}else M||(w=new u(b,g));if(y.set(b,null===S?w:S[2]),null!==S){if(null===_){if(void 0===x)throw new Error("Missing the processor constructor.");if(null===d)throw new Error("Missing the native OfflineAudioContext constructor.");const e=o.channelCount*o.numberOfInputs,t=void 0===x.parameterDescriptors?0:x.parameterDescriptors.length,n=e+t,l=async()=>{const l=new d(n,128*Math.ceil(o.context.length/128),b.sampleRate),c=[],h=[];for(let e=0;e<v.numberOfInputs;e+=1)c.push(a(l,{channelCount:v.channelCount,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1})),h.push(s(l,{channelCount:v.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:v.channelCount}));const u=await Promise.all(Array.from(o.parameters.values()).map(async e=>{const t=r(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:e.value});return await p(l,e,t.offset),t})),g=i(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,e+t)});for(let e=0;e<v.numberOfInputs;e+=1){c[e].connect(h[e]);for(let t=0;t<v.channelCount;t+=1)h[e].connect(g,t,e*v.channelCount+t)}for(const[t,n]of u.entries())n.connect(g,0,e+t),n.start(0);return g.connect(l.destination),await Promise.all(c.map(e=>m(o,l,e))),f(l)};_=(async(e,t,n,i,s,r,a)=>{const o=null===t?128*Math.ceil(e.context.length/128):t.length,l=i.channelCount*i.numberOfInputs,c=s.reduce((e,t)=>e+t,0),h=0===c?null:n.createBuffer(c,o,n.sampleRate);if(void 0===r)throw new Error("Missing the processor constructor.");const u=sv(e),d=await((e,t)=>{const n=Bg(Dg,e),i=yv(t);return Bg(n,i)})(n,e),p=Iv(i.numberOfInputs,i.channelCount),m=Iv(i.numberOfOutputs,s),f=Array.from(e.parameters.keys()).reduce((e,t)=>({...e,[t]:new Float32Array(128)}),{});for(let v=0;v<o;v+=128){if(i.numberOfInputs>0&&null!==t)for(let e=0;e<i.numberOfInputs;e+=1)for(let n=0;n<i.channelCount;n+=1)Rv(t,p[e],n,n,v);void 0!==r.parameterDescriptors&&null!==t&&r.parameterDescriptors.forEach(({name:e},n)=>{Rv(t,f,e,l+n,v)});for(let e=0;e<i.numberOfInputs;e+=1)for(let t=0;t<s[e];t+=1)0===m[e][t].byteLength&&(m[e][t]=new Float32Array(128));try{const e=p.map((e,t)=>0===u.activeInputs[t].size?[]:e),t=a(v/n.sampleRate,n.sampleRate,()=>d.process(e,m,f));if(null!==h)for(let n=0,r=0;n<i.numberOfOutputs;n+=1){for(let e=0;e<s[n];e+=1)Pv(h,m[n],e,r+e,v);r+=s[n]}if(!t)break}catch(g){e.dispatchEvent(new ErrorEvent("processorerror",{colno:g.colno,filename:g.filename,lineno:g.lineno,message:g.message}));break}}return h})(o,0===n?null:await l(),b,v,T,x,c)}const e=await _,t=n(b,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[l,h,u]=S;null!==e&&(t.buffer=e,t.start(0)),t.connect(l);for(let n=0,i=0;n<o.numberOfOutputs;n+=1){const e=h[n];for(let t=0;t<T[n];t+=1)l.connect(e,i+t,t);i+=T[n]}return u}if(M)for(const[t,n]of o.parameters.entries())await e(b,n,w.parameters.get(t));else for(const[e,t]of o.parameters.entries())await p(b,t,w.parameters.get(e));return await m(o,b,w),w})(b,w)}}})(Ay,Pb,Ry,Jy,ix,s_,ax,Ib,jb,X_,yv,cy,Kx,Iy,Wx,y_),zb=(Vb=Y_,e=>Vb.get(e));var Vb;const Hb=(e=>(t,n)=>{e.set(t,n)})(Db),Wb=q_?((e,t,n,i,s,r,a,o,l,c,h,u,d,p)=>class extends t{constructor(t,h,d){var p;const m=o(t),f=l(m),g=(e=>({...e,outputChannelCount:void 0!==e.outputChannelCount?e.outputChannelCount:1===e.numberOfInputs&&1===e.numberOfOutputs?[e.channelCount]:Array.from({length:e.numberOfOutputs},()=>1)}))({...Nv,...d});(e=>{const{port1:t,port2:n}=new MessageChannel;try{t.postMessage(e)}finally{t.close(),n.close()}})(g);const v=jg.get(m),x=null==v?void 0:v.get(h),y=f||"closed"!==m.state?m:null!==(p=a(m))&&void 0!==p?p:m,_=s(y,f?null:t.baseLatency,c,h,x,g);super(t,!0,_,f?i(h,g,x):null);const b=[];_.parameters.forEach((e,t)=>{const i=n(this,f,e);b.push([t,i])}),this._nativeAudioWorkletNode=_,this._onprocessorerror=null,this._parameters=new Av(b),f&&e(m,this);const{activeInputs:w}=r(this);u(_,w)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(e){const t="function"==typeof e?p(this,e):null;this._nativeAudioWorkletNode.onprocessorerror=t;const n=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=null!==n&&n===t?e:n}get parameters(){return null===this._parameters?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(Nb,hy,Dy,Bb,Fb,sv,zb,$x,Qx,cy,0,Hb,0,Ex):void 0,Gb=((e,t)=>(n,i,s)=>{if(null===t)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(n,i,s)}catch(r){if("SyntaxError"===r.name)throw e();throw r}})(ux,Kx),qb=((e,t,n,i,s,r,a,o)=>(l,c)=>n(l).render(l,c).then(()=>Promise.all(Array.from(i(c)).map(e=>n(e).render(e,c)))).then(()=>s(c)).then(n=>("function"!=typeof n.copyFromChannel?(a(n),Jg(n)):t(r,()=>r(n))||o(n),e.add(n),n)))(py,kx,Vx,Cb,y_,Zg,vy,xy),Xb=((e,t,n,i,s)=>class extends e{constructor(e,n,s){let r;if("number"==typeof e&&void 0!==n&&void 0!==s)r={length:n,numberOfChannels:e,sampleRate:s};else{if("object"!=typeof e)throw new Error("The given parameters are not valid.");r=e}const{length:a,numberOfChannels:o,sampleRate:l}={...dx,...r},c=i(o,a,l);t(Yv,()=>Yv(c))||c.addEventListener("statechange",(()=>{let e=0;const t=n=>{"running"===this._state&&(e>0?(c.removeEventListener("statechange",t),n.stopImmediatePropagation(),this._waitForThePromiseToSettle(n)):e+=1)};return t})()),super(c,o),this._length=a,this._nativeOfflineAudioContext=c,this._state=null}get length(){return void 0===this._nativeOfflineAudioContext.length?this._length:this._nativeOfflineAudioContext.length}get state(){return null===this._state?this._nativeOfflineAudioContext.state:this._state}startRendering(){return"running"===this._state?Promise.reject(n()):(this._state="running",s(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,ov(this)}))}_waitForThePromiseToSettle(e){null===this._state?this._nativeOfflineAudioContext.dispatchEvent(e):setTimeout(()=>this._waitForThePromiseToSettle(e))}})(eb,kx,Hv,Gb,qb),Yb=((e,t)=>n=>{const i=e.get(n);return t(i)||t(n)})(Rg,ry),$b=(Zb=Cg,Kb=oy,e=>Zb.has(e)||Kb(e));var Zb,Kb;const Jb=(Qb=Ng,ew=ly,e=>Qb.has(e)||ew(e));var Qb,ew;const tw=((e,t)=>n=>{const i=e.get(n);return t(i)||t(n)})(Rg,Qx);function nw(e){return void 0===e}function iw(e){return void 0!==e}function sw(e){return"number"==typeof e}function rw(e){return"[object Object]"===Object.prototype.toString.call(e)&&e.constructor===Object}function aw(e){return Array.isArray(e)}function ow(e){return"string"==typeof e}function lw(e){return ow(e)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(e)}function cw(e,t){if(!e)throw new Error(t)}function hw(e,t,n=1/0){if(!(t<=e&&e<=n))throw new RangeError(`Value must be within [${t}, ${n}], got: ${e}`)}function uw(e){e.isOffline||"running"===e.state||gw('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let dw=!1,pw=!1;function mw(e){dw=e}let fw=console;function gw(...e){fw.warn(...e)}const vw="object"==typeof self?self:null,xw=vw&&(vw.hasOwnProperty("AudioContext")||vw.hasOwnProperty("webkitAudioContext"));class yw{constructor(e,t,n,i){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=n,this._createClock()}_createWorker(){const e=new Blob([`\n\t\t\t// the initial timeout time\n\t\t\tlet timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};\n\t\t\t// onmessage callback\n\t\t\tself.onmessage = function(msg){\n\t\t\t\ttimeoutTime = parseInt(msg.data);\n\t\t\t};\n\t\t\t// the tick function which posts a message\n\t\t\t// and schedules a new tick\n\t\t\tfunction tick(){\n\t\t\t\tsetTimeout(tick, timeoutTime);\n\t\t\t\tself.postMessage('tick');\n\t\t\t}\n\t\t\t// call tick initially\n\t\t\ttick();\n\t\t\t`],{type:"text/javascript"}),t=URL.createObjectURL(e),n=new Worker(t);n.onmessage=this._callback.bind(this),this._worker=n}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if("worker"===this._type)try{this._createWorker()}catch(CT){this._type="timeout",this._createClock()}else"timeout"===this._type&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),"worker"===this._type&&(null===(t=this._worker)||void 0===t||t.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function _w(e){return Jb(e)}function bw(e){return $b(e)}function ww(e){return tw(e)}function Sw(e){return Yb(e)}function Mw(e,t){return"value"===e||_w(t)||bw(t)||function(e){return e instanceof _y}(t)}function Tw(e,...t){if(!t.length)return e;const n=t.shift();if(rw(e)&&rw(n))for(const i in n)Mw(i,n[i])?e[i]=n[i]:rw(n[i])?(e[i]||Object.assign(e,{[i]:{}}),Tw(e[i],n[i])):Object.assign(e,{[i]:n[i]});return Tw(e,...t)}function Ew(e,t,n=[],i){const s={},r=Array.from(t);if(rw(r[0])&&i&&!Reflect.has(r[0],i)&&(Object.keys(r[0]).some(t=>Reflect.has(e,t))||(Tw(s,{[i]:r[0]}),n.splice(n.indexOf(i),1),r.shift())),1===r.length&&rw(r[0]))Tw(s,r[0]);else for(let a=0;a<n.length;a++)iw(r[a])&&(s[n[a]]=r[a]);return Tw(e,s)}function Cw(e,t){return nw(e)?t:e}function Aw(e,t){return t.forEach(t=>{Reflect.has(e,t)&&delete e[t]}),e}
/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class Nw{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||vw&&this.toString()===vw.TONE_DEBUG_CLASS)&&function(...e){fw.log(...e)}(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}Nw.version="15.1.22";const Rw=1e-6;function Pw(e,t){return e>t+Rw}function Iw(e,t){return Pw(e,t)||Dw(e,t)}function jw(e,t){return e+Rw<t}function Dw(e,t){return Math.abs(e-t)<Rw}class kw extends Nw{constructor(){super(),this.name="Timeline",this._timeline=[];const e=Ew(kw.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(cw(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];cw(Iw(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const e=this.length-this.memory;this._timeline.splice(0,e)}return this}remove(e){const t=this._timeline.indexOf(e);return-1!==t&&this._timeline.splice(t,1),this}get(e,t="time"){const n=this._search(e,t);return-1!==n?this._timeline[n]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const n=this._search(e,t);return n+1<this._timeline.length?this._timeline[n+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const n=this._search(e);return n-1>=0?this._timeline[n-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(Dw(this._timeline[t].time,e)){for(let n=t;n>=0&&Dw(this._timeline[n].time,e);n--)t=n;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else 1===this._timeline.length&&Iw(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(0===this._timeline.length)return-1;let n=0;const i=this._timeline.length;let s=i;if(i>0&&this._timeline[i-1][t]<=e)return i-1;for(;n<s;){let i=Math.floor(n+(s-n)/2);const r=this._timeline[i],a=this._timeline[i+1];if(Dw(r[t],e)){for(let n=i;n<this._timeline.length&&Dw(this._timeline[n][t],e);n++)i=n;return i}if(jw(r[t],e)&&Pw(a[t],e))return i;Pw(r[t],e)?s=i:n=i+1}return-1}_iterate(e,t=0,n=this._timeline.length-1){this._timeline.slice(t,n+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const n=this._search(e);return-1!==n&&this._iterate(t,0,n),this}forEachAfter(e,t){const n=this._search(e);return this._iterate(t,n+1),this}forEachBetween(e,t,n){let i=this._search(e),s=this._search(t);return-1!==i&&-1!==s?(this._timeline[i].time!==e&&(i+=1),this._timeline[s].time===t&&(s-=1),this._iterate(n,i,s)):-1===i&&this._iterate(n,0,s),this}forEachFrom(e,t){let n=this._search(e);for(;n>=0&&this._timeline[n].time>=e;)n--;return this._iterate(t,n+1),this}forEachAtTime(e,t){const n=this._search(e);if(-1!==n&&Dw(this._timeline[n].time,e)){let i=n;for(let t=n;t>=0&&Dw(this._timeline[t].time,e);t--)i=t;this._iterate(e=>{t(e)},i,n)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Lw=[];function Ow(e){Lw.push(e)}const Uw=[];function Fw(e){Uw.push(e)}class Bw extends Nw{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(e=>{nw(this._events)&&(this._events={}),this._events.hasOwnProperty(e)||(this._events[e]=[]),this._events[e].push(t)}),this}once(e,t){const n=(...i)=>{t(...i),this.off(e,n)};return this.on(e,n),this}off(e,t){return e.split(/\W+/).forEach(e=>{if(nw(this._events)&&(this._events={}),this._events.hasOwnProperty(e))if(nw(t))this._events[e]=[];else{const n=this._events[e];for(let e=n.length-1;e>=0;e--)n[e]===t&&n.splice(e,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const n=this._events[e].slice(0);for(let e=0,i=n.length;e<i;e++)n[e].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const n=Object.getOwnPropertyDescriptor(Bw.prototype,t);Object.defineProperty(e.prototype,t,n)})}dispose(){return super.dispose(),this._events=void 0,this}}class zw extends Bw{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Vw extends zw{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new kw,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const n=Ew(Vw.getDefaults(),arguments,["context"]);n.context?(this._context=n.context,this._latencyHint=(null===(e=arguments[0])||void 0===e?void 0:e.latencyHint)||""):(this._context=function(e){return new Eb(e)}({latencyHint:n.latencyHint}),this._latencyHint=n.latencyHint),this._ticker=new yw(this.emit.bind(this,"tick"),n.clockSource,n.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[(null===(t=arguments[0])||void 0===t?void 0:t.hasOwnProperty("updateInterval"))?"_lookAhead":"lookAhead"]=n.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var e;return this._initialized||(e=this,Lw.forEach(t=>t(e)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,n){return this._context.createBuffer(e,t,n)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,n){return this._context.createPeriodicWave(e,t,n)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return cw(Sw(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return cw(Sw(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return cw(Sw(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){cw(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){cw(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){cw(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){cw(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return function(e,t,n){return cw(iw(Wb),"AudioWorkletNode only works in a secure context (https or localhost)"),new(e instanceof(null==vw?void 0:vw.BaseAudioContext)?null==vw?void 0:vw.AudioWorkletNode:Wb)(e,t,n)}(this.rawContext,e,t)}addAudioWorkletModule(e){return m(this,void 0,void 0,function*(){cw(iw(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return m(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return Sw(this._context)?this._context.resume():Promise.resolve()}close(){return m(this,void 0,void 0,function*(){var e;Sw(this._context)&&"closed"!==this.state&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(e=this,Uw.forEach(t=>t(e)))})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),n=t.getChannelData(0);for(let s=0;s<n.length;s++)n[s]=e;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=t,i.loop=!0,i.start(0),this._constants.set(e,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,e=>{e.callback(),this._timeouts.remove(e)})}setTimeout(e,t){this._timeoutIds++;const n=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:n+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const n=++this._timeoutIds,i=()=>{const s=this.now();this._timeouts.add({callback:()=>{e(),i()},id:n,time:s+t})};return i(),n}}function Hw(e,t){aw(t)?t.forEach(t=>Hw(e,t)):Object.defineProperty(e,t,{enumerable:!0,writable:!1})}function Ww(e,t){aw(t)?t.forEach(t=>Ww(e,t)):Object.defineProperty(e,t,{writable:!0})}const Gw=()=>{};class qw extends Nw{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Gw;const e=Ew(qw.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,ow(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:Gw,onload:Gw,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:Zw().sampleRate}set(e){return e instanceof qw?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return m(this,void 0,void 0,function*(){const t=qw.load(e).then(e=>{this.set(e),this.onload(this)});qw.downloads.push(t);try{yield t}finally{const e=qw.downloads.indexOf(t);qw.downloads.splice(e,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=aw(e)&&e[0].length>0,n=t?e.length:1,i=t?e[0].length:e.length,s=Zw(),r=s.createBuffer(n,i,s.sampleRate),a=t||1!==n?e:[e];for(let o=0;o<n;o++)r.copyToChannel(a[o],o);return this._buffer=r,this}toMono(e){if(sw(e))this.fromArray(this.toArray(e));else{let e=new Float32Array(this.length);const t=this.numberOfChannels;for(let n=0;n<t;n++){const t=this.toArray(n);for(let n=0;n<t.length;n++)e[n]+=t[n]}e=e.map(e=>e/t),this.fromArray(e)}return this}toArray(e){if(sw(e))return this.getChannelData(e);if(1===this.numberOfChannels)return this.toArray(0);{const e=[];for(let t=0;t<this.numberOfChannels;t++)e[t]=this.getChannelData(t);return e}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){cw(this.loaded,"Buffer is not loaded");const n=Math.floor(e*this.sampleRate),i=Math.floor(t*this.sampleRate);cw(n<i,"The start time must be less than the end time");const s=i-n,r=Zw().createBuffer(this.numberOfChannels,s,this.sampleRate);for(let a=0;a<this.numberOfChannels;a++)r.copyToChannel(this.getChannelData(a).subarray(n,i),a);return new qw(r)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return(new qw).fromArray(e)}static fromUrl(e){return m(this,void 0,void 0,function*(){const t=new qw;return yield t.load(e)})}static load(e){return m(this,void 0,void 0,function*(){const t=""===qw.baseUrl||qw.baseUrl.endsWith("/")?qw.baseUrl:qw.baseUrl+"/",n=yield fetch(t+e);if(!n.ok)throw new Error(`could not load url: ${e}`);const i=yield n.arrayBuffer();return yield Zw().decodeAudioData(i)})}static supportsType(e){const t=e.split("."),n=t[t.length-1];return""!==document.createElement("audio").canPlayType("audio/"+n)}static loaded(){return m(this,void 0,void 0,function*(){for(yield Promise.resolve();qw.downloads.length;)yield qw.downloads[0]})}}qw.baseUrl="",qw.downloads=[];class Xw extends Vw{constructor(){var e,t,n;super({clockSource:"offline",context:ww(arguments[0])?arguments[0]:(e=arguments[0],t=arguments[1]*arguments[2],n=arguments[2],new Xb(e,t,n)),lookAhead:0,updateInterval:ww(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=ww(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return m(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const n=Math.floor(this.sampleRate/128);e&&t%n===0&&(yield new Promise(e=>setTimeout(e,1)))}})}render(){return m(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new qw(t)})}close(){return Promise.resolve()}}const Yw=new class extends zw{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,n){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,n){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return m(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}};let $w=Yw;function Zw(){return $w===Yw&&xw&&function(e,t=!1){t&&$w.dispose(),$w=Sw(e)?new Vw(e):ww(e)?new Xw(e):e}(new Vw),$w}function Kw(e){return Math.pow(2,e/12)}vw&&vw.TONE_SILENCE_LOGGING;let Jw=440;function Qw(e){return Math.round(eS(e))}function eS(e){return 69+12*Math.log2(e/Jw)}class tS extends Nw{constructor(e,t,n){super(),this.defaultUnits="s",this._val=t,this._units=n,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const n=parseInt(e,10),i="."===t?1.5:1;return 1===n?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/n)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(3*Math.floor(t)))},regexp:/^(\d+)t$/i},tr:{method:(e,t,n)=>{let i=0;return e&&"0"!==e&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&"0"!==t&&(i+=this._beatsToUnits(parseFloat(t))),n&&"0"!==n&&(i+=this._beatsToUnits(parseFloat(n)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof tS&&this.fromType(this._val),nw(this._val))return this._noArg();if(ow(this._val)&&nw(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(rw(this._val)){let e=0;for(const t in this._val)if(iw(this._val[t])){const n=this._val[t];e+=new this.constructor(this.context,t).valueOf()*n}return e}if(iw(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}return ow(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class nS extends tS{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new nS(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const n=new this.constructor(this.context,e).valueOf(),i=this.valueOf();return i+(Math.round(i/n)*n-i)*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let s=1;s<9;s++){const e=Math.pow(2,s);t.push(e+"n."),t.push(e+"n"),t.push(e+"t")}t.push("0");let n=t[0],i=new nS(this.context,t[0]).toSeconds();return t.forEach(t=>{const s=new nS(this.context,t).toSeconds();Math.abs(s-e)<Math.abs(i-e)&&(n=t,i=s)}),n}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const n=Math.floor(t/this._getTimeSignature());let i=t%1*4;t=Math.floor(t)%this._getTimeSignature();const s=i.toString();return s.length>3&&(i=parseFloat(parseFloat(s).toFixed(3))),[n,t,i].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Qw(this.toFrequency())}_now(){return this.context.now()}}class iS extends nS{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Jw}static set A4(e){!function(e){Jw=e}(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return"midi"===this.defaultUnits?e:iS.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const n=sS[e.toLowerCase()]+12*(parseInt(t,10)+1);return"midi"===this.defaultUnits?n:iS.mtof(n)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,n){let i=1;return e&&"0"!==e&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&"0"!==t&&(i*=this._beatsToUnits(parseFloat(t))),n&&"0"!==n&&(i*=this._beatsToUnits(parseFloat(n)/4)),i}}})}transpose(e){return new iS(this.context,this.valueOf()*Kw(e))}harmonize(e){return e.map(e=>this.transpose(e))}toMidi(){return Qw(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/iS.A4);let n=Math.round(12*t)+57;const i=Math.floor(n/12);return i<0&&(n+=-12*i),rS[n%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(60*e/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return function(e){return Jw*Math.pow(2,(e-69)/12)}(e)}static ftom(e){return Qw(e)}}const sS={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},rS=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class aS extends nS{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class oS extends Nw{constructor(){super();const e=Ew(oS.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:Zw()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return function(e){nw(e)&&dw&&!pw&&(pw=!0,gw("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}(e),new nS(this.context,e).toSeconds()}toFrequency(e){return new iS(this.context,e).toFrequency()}toTicks(e){return new aS(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(n=>{nw(e[n])&&delete t[n]}),t}get(){const e=this.constructor.getDefaults();return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const n=this[t];iw(n)&&iw(n.value)&&iw(n.setValueAtTime)?e[t]=n.value:n instanceof oS?e[t]=n._getPartialProperties(e[t]):aw(n)||sw(n)||ow(n)||"boolean"==typeof n?e[t]=n:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&iw(this[t])&&(this[t]&&iw(this[t].value)&&iw(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof oS?this[t].set(e[t]):this[t]=e[t])}),this}}class lS extends kw{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return null!==t?t.state:this._initial}setStateAtTime(e,t,n){return hw(t,0),this.add(Object.assign({},n,{state:e,time:t})),this}getLastState(e,t){for(let n=this._search(t);n>=0;n--){const t=this._timeline[n];if(t.state===e)return t}}getNextState(e,t){const n=this._search(t);if(-1!==n)for(let i=n;i<this._timeline.length;i++){const t=this._timeline[i];if(t.state===e)return t}}}class cS extends oS{constructor(){const e=Ew(cS.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,cw(iw(e.param)&&(_w(e.param)||e.param instanceof cS),"param must be an AudioParam");!_w(e.param);)e.param=e.param._param;this._swappable=!!iw(e.swappable)&&e.swappable,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new kw(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,iw(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(oS.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return iw(this._minValue)?this._minValue:"time"===this.units||"frequency"===this.units||"normalRange"===this.units||"positive"===this.units||"transportTime"===this.units||"ticks"===this.units||"bpm"===this.units||"hertz"===this.units||"samples"===this.units?0:"audioRange"===this.units?-1:"decibels"===this.units?-1/0:this._param.minValue}get maxValue(){return iw(this._maxValue)?this._maxValue:"normalRange"===this.units||"audioRange"===this.units?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return iw(this.maxValue)&&iw(this.minValue)&&hw(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?(t=e,Math.pow(10,t/20)):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e;var t}_toType(e){return this.convert&&"decibels"===this.units?(t=e,Math.log(t)/Math.LN10*20):e;var t}setValueAtTime(e,t){const n=this.toSeconds(t),i=this._fromType(e);return cw(isFinite(i)&&isFinite(n),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",e,n),this._events.add({time:n,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,n),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),n=this._events.getAfter(t),i=this._events.get(t);let s=this._initialValue;if(null===i)s=this._initialValue;else if("setTargetAtTime"!==i.type||null!==n&&"setValueAtTime"!==n.type)if(null===n)s=i.value;else if("linearRampToValueAtTime"===n.type||"exponentialRampToValueAtTime"===n.type){let e=i.value;if("setTargetAtTime"===i.type){const t=this._events.getBefore(i.time);e=null===t?this._initialValue:t.value}s="linearRampToValueAtTime"===n.type?this._linearInterpolate(i.time,e,n.time,n.value,t):this._exponentialInterpolate(i.time,e,n.time,n.value,t)}else s=i.value;else{const e=this._events.getBefore(i.time);let n;n=null===e?this._initialValue:e.value,"setTargetAtTime"===i.type&&(s=this._exponentialApproach(i.time,n,i.value,i.constant,t))}return this._toType(s)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),0===this._fromType(t)&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const n=this._fromType(e),i=this.toSeconds(t);return cw(isFinite(n)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(n),this._events.add({time:i,type:"linearRampToValueAtTime",value:n}),this.log(this.units,"linearRampToValueAtTime",e,i),this._param.linearRampToValueAtTime(n,i),this}exponentialRampToValueAtTime(e,t){let n=this._fromType(e);n=Dw(n,0)?this._minOutput:n,this._assertRange(n);const i=this.toSeconds(t);return cw(isFinite(n)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:n}),this.log(this.units,"exponentialRampToValueAtTime",e,i),this._param.exponentialRampToValueAtTime(n,i),this}exponentialRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialRampToValueAtTime(e,n+this.toSeconds(t)),this}linearRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.linearRampToValueAtTime(e,n+this.toSeconds(t)),this}targetRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialApproachValueAtTime(e,n,t),this}exponentialApproachValueAtTime(e,t,n){t=this.toSeconds(t),n=this.toSeconds(n);const i=Math.log(n+1)/Math.log(200);return this.setTargetAtTime(e,t,i),this.cancelAndHoldAtTime(t+.9*n),this.linearRampToValueAtTime(e,t+n),this}setTargetAtTime(e,t,n){const i=this._fromType(e);cw(isFinite(n)&&n>0,"timeConstant must be a number greater than 0");const s=this.toSeconds(t);return this._assertRange(i),cw(isFinite(i)&&isFinite(s),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:n,time:s,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",e,s,n),this._param.setTargetAtTime(i,s,n),this}setValueCurveAtTime(e,t,n,i=1){n=this.toSeconds(n),t=this.toSeconds(t);const s=this._fromType(e[0])*i;this.setValueAtTime(this._toType(s),t);const r=n/(e.length-1);for(let a=1;a<e.length;a++){const n=this._fromType(e[a])*i;this.linearRampToValueAtTime(this._toType(n),t+a*r)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return cw(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),n=this._fromType(this.getValueAtTime(t));cw(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+n);const i=this._events.get(t),s=this._events.getAfter(t);return i&&Dw(i.time,t)?s?(this._param.cancelScheduledValues(s.time),this._events.cancel(s.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):s&&(this._param.cancelScheduledValues(s.time),this._events.cancel(s.time),"linearRampToValueAtTime"===s.type?this.linearRampToValueAtTime(this._toType(n),t):"exponentialRampToValueAtTime"===s.type&&this.exponentialRampToValueAtTime(this._toType(n),t)),this._events.add({time:t,type:"setValueAtTime",value:n}),this._param.setValueAtTime(n,t),this}rampTo(e,t=.1,n){return"frequency"===this.units||"bpm"===this.units||"decibels"===this.units?this.exponentialRampTo(e,t,n):this.linearRampTo(e,t,n),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const n=this._events.get(t);if(n&&"setTargetAtTime"===n.type){const i=this._events.getAfter(n.time),s=i?i.time:t+2,r=(s-t)/10;for(let n=t;n<s;n+=r)e.linearRampToValueAtTime(this.getValueAtTime(n),n)}return this._events.forEachAfter(this.context.currentTime,t=>{"cancelScheduledValues"===t.type?e.cancelScheduledValues(t.time):"setTargetAtTime"===t.type?e.setTargetAtTime(t.value,t.time,t.constant):e[t.type](t.value,t.time)}),this}setParam(e){cw(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,n,i,s){return n+(t-n)*Math.exp(-(s-e)/i)}_linearInterpolate(e,t,n,i,s){return t+(s-e)/(n-e)*(i-t)}_exponentialInterpolate(e,t,n,i,s){return t*Math.pow(i/t,(s-e)/(n-e))}}class hS extends oS{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return iw(this.input)?_w(this.input)||this.input instanceof cS?1:this.input.numberOfInputs:0}get numberOfOutputs(){return iw(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return iw(e)&&(e instanceof hS||bw(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(t=>{t.channelCount=e.channelCount,t.channelCountMode=e.channelCountMode,t.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();cw(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,n=0){return dS(this,e,t,n),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return gw("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,n=0){return function(e,t,n=0,i=0){if(iw(t))for(;t instanceof hS;)t=t.input;for(;!bw(e);)iw(e.output)&&(e=e.output);_w(t)?e.disconnect(t,n):bw(t)?e.disconnect(t,n,i):e.disconnect()}(this,e,t,n),this}chain(...e){return uS(this,...e),this}fan(...e){return e.forEach(e=>this.connect(e)),this}dispose(){return super.dispose(),iw(this.input)&&(this.input instanceof hS?this.input.dispose():bw(this.input)&&this.input.disconnect()),iw(this.output)&&(this.output instanceof hS?this.output.dispose():bw(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function uS(...e){const t=e.shift();e.reduce((e,t)=>(e instanceof hS?e.connect(t):bw(e)&&dS(e,t),t),t)}function dS(e,t,n=0,i=0){for(cw(iw(e),"Cannot connect from undefined node"),cw(iw(t),"Cannot connect to undefined node"),(t instanceof hS||bw(t))&&cw(t.numberOfInputs>0,"Cannot connect to node with no inputs"),cw(e.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof hS||t instanceof cS;)iw(t.input)&&(t=t.input);for(;e instanceof hS;)iw(e.output)&&(e=e.output);_w(t)?e.connect(t,n):e.connect(t,n,i)}class pS extends hS{constructor(){const e=Ew(pS.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new cS({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),Hw(this,"gain")}static getDefaults(){return Object.assign(hS.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class mS extends hS{constructor(e){super(e),this.onended=Gw,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new pS({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(e){const t=this.toSeconds(e);return-1!==this._startTime&&t>=this._startTime&&(-1===this._stopTime||t<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(hS.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Gw})}_startGain(e,t=1){cw(-1===this._startTime,"Source cannot be started more than once");const n=this.toSeconds(this._fadeIn);return this._startTime=e+n,this._startTime=Math.max(this._startTime,this.context.currentTime),n>0?(this._gainNode.gain.setValueAtTime(0,e),"linear"===this._curve?this._gainNode.gain.linearRampToValueAtTime(t,e+n):this._gainNode.gain.exponentialApproachValueAtTime(t,e,n)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){cw(-1!==this._startTime,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?"linear"===this._curve?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const e="exponential"===this._curve?2*t:0;this._stopSource(this.now()+e),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Gw&&(this.onended(this),this.onended=Gw,!this.context.isOffline)){const e=()=>this.dispose();"undefined"!=typeof requestIdleCallback?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),cw(-1!==this._startTime,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Gw,this}}class fS extends mS{constructor(){const e=Ew(fS.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),dS(this._source,this._gainNode),this.offset=new cS({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(mS.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),"started"===this.state&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class gS extends hS{constructor(){const e=Ew(gS.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new fS({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(hS.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,n=0){return vS(this,e,t,n),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,n){return this._param.exponentialRampTo(e,t,n),this}linearRampTo(e,t,n){return this._param.linearRampTo(e,t,n),this}targetRampTo(e,t,n){return this._param.targetRampTo(e,t,n),this}exponentialApproachValueAtTime(e,t,n){return this._param.exponentialApproachValueAtTime(e,t,n),this}setTargetAtTime(e,t,n){return this._param.setTargetAtTime(e,t,n),this}setValueCurveAtTime(e,t,n,i){return this._param.setValueCurveAtTime(e,t,n,i),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,n){return this._param.rampTo(e,t,n),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function vS(e,t,n,i){(t instanceof cS||_w(t)||t instanceof gS&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof gS&&(t.overridden=!0)),dS(e,t,n,i)}class xS extends cS{constructor(){const e=Ew(xS.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new kw(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(cS.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,n){t=this.toSeconds(t),this.setRampPoint(t);const i=this._fromType(e),s=this._events.get(t),r=Math.round(Math.max(1/n,1));for(let a=0;a<=r;a++){const e=n*a+t,r=this._exponentialApproach(s.time,s.value,i,n,e);this.linearRampToValueAtTime(this._toType(r),e)}return this}setValueAtTime(e,t){const n=this.toSeconds(t);super.setValueAtTime(e,t);const i=this._events.get(n),s=this._events.previousEvent(i),r=this._getTicksUntilEvent(s,n);return i.ticks=Math.max(r,0),this}linearRampToValueAtTime(e,t){const n=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const i=this._events.get(n),s=this._events.previousEvent(i),r=this._getTicksUntilEvent(s,n);return i.ticks=Math.max(r,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const n=this._fromType(e),i=this._events.get(t),s=Math.round(Math.max(10*(t-i.time),1)),r=(t-i.time)/s;for(let a=0;a<=s;a++){const e=r*a+i.time,s=this._exponentialInterpolate(i.time,i.value,t,n,e);this.linearRampToValueAtTime(this._toType(s),e)}return this}_getTicksUntilEvent(e,t){if(null===e)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(nw(e.ticks)){const t=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(t,e.time)}const n=this._fromType(this.getValueAtTime(e.time));let i=this._fromType(this.getValueAtTime(t));const s=this._events.get(t);return s&&s.time===t&&"setValueAtTime"===s.type&&(i=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(n+i)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),n=this._events.get(t);return Math.max(this._getTicksUntilEvent(n,t),0)}getDurationOfTicks(e,t){const n=this.toSeconds(t),i=this.getTicksAtTime(t);return this.getTimeOfTick(i+e)-n}getTimeOfTick(e){const t=this._events.get(e,"ticks"),n=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&n&&"linearRampToValueAtTime"===n.type&&t.value!==n.value){const i=this._fromType(this.getValueAtTime(t.time)),s=(this._fromType(this.getValueAtTime(n.time))-i)/(n.time-t.time),r=Math.sqrt(Math.pow(i,2)-2*s*(t.ticks-e)),a=(-i+r)/s;return(a>0?a:(-i-r)/s)+t.time}return t?0===t.value?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const n=this.toSeconds(t),i=this.toSeconds(e),s=this.getTicksAtTime(n);return this.getTicksAtTime(n+i)-s}_fromType(e){return"bpm"===this.units&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return"bpm"===this.units&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class yS extends gS{constructor(){const e=Ew(yS.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new xS({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(gS.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class _S extends oS{constructor(){const e=Ew(_S.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new lS,this._tickOffset=new kw,this._ticksAtTime=new kw,this._secondsAtTime=new kw,this.frequency=new yS({context:this.context,units:e.units,value:e.frequency}),Hw(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},oS.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const n=this.toSeconds(e);return"started"!==this._state.getValueAtTime(n)&&(this._state.setStateAtTime("started",n),iw(t)&&this.setTicksAtTime(t,n),this._ticksAtTime.cancel(n),this._secondsAtTime.cancel(n)),this}stop(e){const t=this.toSeconds(e);if("stopped"===this._state.getValueAtTime(t)){const e=this._state.get(t);e&&e.time>0&&(this._tickOffset.cancel(e.time),this._state.cancel(e.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return"started"===this._state.getValueAtTime(t)&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),n=this._state.getLastState("stopped",t),i=this._ticksAtTime.get(t),s={state:"paused",time:t};this._state.add(s);let r=i||n,a=i?i.ticks:0,o=null;return this._state.forEachBetween(r.time,t+this.sampleTime,e=>{let t=r.time;const n=this._tickOffset.get(e.time);n&&n.time>=r.time&&(a=n.ticks,t=n.time),"started"===r.state&&"started"!==e.state&&(a+=this.frequency.getTicksAtTime(e.time)-this.frequency.getTicksAtTime(t),e.time!==s.time&&(o={state:e.state,time:e.time,ticks:a})),r=e}),this._state.remove(s),o&&this._ticksAtTime.add(o),a}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),n=this.frequency.timeToTicks(e,t);this.setTicksAtTime(n,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),n={state:"paused",time:e};this._state.add(n);const i=this._secondsAtTime.get(e);let s=i||t,r=i?i.seconds:0,a=null;return this._state.forEachBetween(s.time,e+this.sampleTime,e=>{let t=s.time;const i=this._tickOffset.get(e.time);i&&i.time>=s.time&&(r=i.seconds,t=i.time),"started"===s.state&&"started"!==e.state&&(r+=e.time-t,e.time!==n.time&&(a={state:e.state,time:e.time,seconds:r})),s=e}),this._state.remove(n),a&&this._secondsAtTime.add(a),r}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const n=this._tickOffset.get(t),i=this._state.get(t),s=Math.max(n.time,i.time),r=this.frequency.getTicksAtTime(s)+e-n.ticks;return this.frequency.getTimeOfTick(r)}forEachTickBetween(e,t,n){let i=this._state.get(e);this._state.forEachBetween(e,t,t=>{i&&"started"===i.state&&"started"!==t.state&&this.forEachTickBetween(Math.max(i.time,e),t.time-this.sampleTime,n),i=t});let s=null;if(i&&"started"===i.state){const r=Math.max(i.time,e),a=this.frequency.getTicksAtTime(r),o=a-this.frequency.getTicksAtTime(i.time);let l=Math.ceil(o)-o;l=Dw(l,1)?0:l;let c=this.frequency.getTimeOfTick(a+l);for(;c<t;){try{n(c,Math.round(this.getTicksAtTime(c)))}catch(CT){s=CT;break}c+=this.frequency.getDurationOfTicks(1,c)}}if(s)throw s;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class bS extends oS{constructor(){const e=Ew(bS.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=Gw,this._lastUpdate=0,this._state=new lS("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new _S({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Hw(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(oS.getDefaults(),{callback:Gw,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){uw(this.context);const n=this.toSeconds(e);return this.log("start",n),"started"!==this._state.getValueAtTime(n)&&(this._state.setStateAtTime("started",n),this._tickSource.start(n,t),n<this._lastUpdate&&this.emit("start",n,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return"started"===this._state.getValueAtTime(t)&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const n=this.toSeconds(t),i=this.getTicksAtTime(n);return this._tickSource.getTimeOfTick(i+e,n)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,e=>{switch(e.state){case"started":const t=this._tickSource.getTicksAtTime(e.time);this.emit("start",e.time,t);break;case"stopped":0!==e.time&&this.emit("stop",e.time);break;case"paused":this.emit("pause",e.time)}}),this._tickSource.forEachTickBetween(e,t,(e,t)=>{this.callback(e,t)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Bw.mixin(bS);class wS extends hS{constructor(){const e=Ew(wS.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new pS({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,Hw(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(hS.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class SS extends hS{constructor(){const e=Ew(SS.getDefaults(),arguments);super(e),this.name="Destination",this.input=new wS({context:this.context}),this.output=new pS({context:this.context}),this.volume=this.input.volume,uS(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(hS.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),uS(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}Ow(e=>{e.destination=new SS({context:e})}),Fw(e=>{e.destination.dispose()});class MS extends hS{constructor(){super(...arguments),this.name="Listener",this.positionX=new cS({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new cS({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new cS({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new cS({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new cS({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new cS({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new cS({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new cS({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new cS({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(hS.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}Ow(e=>{e.listener=new MS({context:e})}),Fw(e=>{e.listener.dispose()});class TS extends Nw{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=Ew(TS.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const n=e.urls[t];this.add(t,n,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Gw,onload:Gw,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return cw(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,0===this._loadingCount&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,n=Gw,i=Gw){return ow(t)?(this.baseUrl&&"data:audio/"===t.trim().substring(0,11).toLowerCase()&&(this.baseUrl=""),this._buffers.set(e.toString(),new qw(this.baseUrl+t,n,i))):this._buffers.set(e.toString(),new qw(t,n,i)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class ES extends aS{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class CS extends oS{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new kw,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),1===this._events.length&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}Ow(e=>{e.draw=new CS({context:e})}),Fw(e=>{e.draw.dispose()});class AS extends Nw{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){cw(iw(e.time),"Events must have a time property"),cw(iw(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new NS(e.time,e.time+e.duration,e);for(null===this._root?this._root=t:this._root.insert(t),this._length++;null!==t;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(null!==this._root){const t=[];this._root.search(e.time,t);for(const n of t)if(n.event===e){this._removeNode(n),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,e=>this.remove(e)),this}_setRoot(e){this._root=e,null!==this._root&&(this._root.parent=null)}_replaceNodeInParent(e,t){null!==e.parent?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(null===e.left&&null===e.right)this._replaceNodeInParent(e,null);else if(null===e.right)this._replaceNodeInParent(e,e.left);else if(null===e.left)this._replaceNodeInParent(e,e.right);else{let t,n=null;if(e.getBalance()>0)if(null===e.left.right)t=e.left,t.right=e.right,n=t;else{for(t=e.left.right;null!==t.right;)t=t.right;t.parent&&(t.parent.right=t.left,n=t.parent,t.left=e.left,t.right=e.right)}else if(null===e.right.left)t=e.right,t.left=e.left,n=t;else{for(t=e.right.left;null!==t.left;)t=t.left;t.parent&&(t.parent.left=t.right,n=t.parent,t.left=e.left,t.right=e.right)}null!==e.parent?e.isLeftChild()?e.parent.left=t:e.parent.right=t:this._setRoot(t),n&&this._rebalance(n)}e.dispose()}_rotateLeft(e){const t=e.parent,n=e.isLeftChild(),i=e.right;i&&(e.right=i.left,i.left=e),null!==t?n?t.left=i:t.right=i:this._setRoot(i)}_rotateRight(e){const t=e.parent,n=e.isLeftChild(),i=e.left;i&&(e.left=i.right,i.right=e),null!==t?n?t.left=i:t.right=i:this._setRoot(i)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(null!==this._root){const t=[];if(this._root.search(e,t),t.length>0){let e=t[0];for(let n=1;n<t.length;n++)t[n].low>e.low&&(e=t[n]);return e.event}}return null}forEach(e){if(null!==this._root){const t=[];this._root.traverse(e=>t.push(e)),t.forEach(t=>{t.event&&e(t.event)})}return this}forEachAtTime(e,t){if(null!==this._root){const n=[];this._root.search(e,n),n.forEach(e=>{e.event&&t(e.event)})}return this}forEachFrom(e,t){if(null!==this._root){const n=[];this._root.searchAfter(e,n),n.forEach(e=>{e.event&&t(e.event)})}return this}dispose(){return super.dispose(),null!==this._root&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class NS{constructor(e,t,n){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=n,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?null===this.left?this.left=e:this.left.insert(e):null===this.right?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(null!==this.left&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),this.low>e||null!==this.right&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),null!==this.left&&this.left.searchAfter(e,t)),null!==this.right&&this.right.searchAfter(e,t)}traverse(e){e(this),null!==this.left&&this.left.traverse(e),null!==this.right&&this.right.traverse(e)}updateHeight(){null!==this.left&&null!==this.right?this.height=Math.max(this.left.height,this.right.height)+1:null!==this.right?this.height=this.right.height+1:null!==this.left?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,null!==this.left&&(this.max=Math.max(this.max,this.left.max)),null!==this.right&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return null!==this.left&&null!==this.right?e=this.left.height-this.right.height:null!==this.left?e=this.left.height+1:null!==this.right&&(e=-(this.right.height+1)),e}isLeftChild(){return null!==this.parent&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,null!==e&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,null!==e&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class RS extends Nw{constructor(e){super(),this.name="TimelineValue",this._timeline=new kw({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class PS extends hS{constructor(){super(Ew(PS.getDefaults(),arguments,["context"]))}connect(e,t=0,n=0){return vS(this,e,t,n),this}}class IS extends PS{constructor(){const e=Ew(IS.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,aw(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):"function"==typeof e.mapping&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(gS.getDefaults(),{length:1024})}setMap(e,t=1024){const n=new Float32Array(t);for(let i=0,s=t;i<s;i++){const t=i/(s-1)*2-1;n[i]=e(t,i)}return this.curve=n,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){cw(["none","2x","4x"].some(t=>t.includes(e)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class jS extends PS{constructor(){const e=Ew(jS.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new IS({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(PS.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class DS{constructor(e,t){this.id=DS._eventId++,this._remainderTime=0;const n=Object.assign(DS.getDefaults(),t);this.transport=e,this.callback=n.callback,this._once=n.once,this.time=Math.floor(n.time),this._remainderTime=n.time-this.time}static getDefaults(){return{callback:Gw,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}DS._eventId=0;class kS extends DS{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const n=Object.assign(kS.getDefaults(),t);this.duration=n.duration,this._interval=n.interval,this._nextTick=n.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},DS.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return jw(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new ES(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){jw(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new ES(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);Pw(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class LS extends oS{constructor(){const e=Ew(LS.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new RS(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new kw,this._repeatedEvents=new AS,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new bS({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),Hw(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(oS.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(2*this._swingTicks)!=0){const n=t%(2*this._swingTicks)/(2*this._swingTicks),i=Math.sin(n*Math.PI)*this._swingAmount;e+=new ES(this.context,2*this._swingTicks/3).toSeconds()*i}mw(!0),this._timeline.forEachAtTime(t,t=>t.invoke(e)),mw(!1)}schedule(e,t){const n=new DS(this,{callback:e,time:new aS(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}scheduleRepeat(e,t,n,i=1/0){const s=new kS(this,{callback:e,duration:new nS(this.context,i).toTicks(),interval:new nS(this.context,t).toTicks(),time:new aS(this.context,n).toTicks()});return this._addEvent(s,this._repeatedEvents)}scheduleOnce(e,t){const n=new DS(this,{callback:e,once:!0,time:new aS(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,e=>this.clear(e.id)),this._repeatedEvents.forEachFrom(t,e=>this.clear(e.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new ES(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){let n;return this.context.resume(),iw(t)&&(n=this.toTicks(t)),this._clock.start(e,n),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),"started"!==this._clock.getStateAtTime(e)?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){aw(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new nS(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new nS(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new ES(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new ES(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),n=this._clock.frequency.timeToTicks(e,t);this.ticks=n}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if("started"===this.state){const n=this._clock.getTicksAtTime(t),i=t+this._clock.frequency.getDurationOfTicks(Math.ceil(n)-n,t);this.emit("stop",i),this._clock.setTicksAtTime(e,i),this.emit("start",i,this._clock.getSecondsAtTime(i))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),"started"!==this.state)return 0;{const t=this.now(),n=e-this.getTicksAtTime(t)%e;return this._clock.nextTickTime(n,t)}}syncSignal(e,t){const n=this.now();let i=this.bpm,s=1/(60/i.getValueAtTime(n)/this.PPQ),r=[];if("time"===e.units){const e=1/64/s,t=new pS(e),n=new jS(-1),a=new pS(e);i.chain(t,n,a),i=a,s=1/s,r=[t,n,a]}t||(t=0!==e.getValueAtTime(n)?e.getValueAtTime(n)/s:0);const a=new pS(t);return i.connect(a),a.connect(e._param),r.push(a),this._syncedSignals.push({initial:e.value,nodes:r,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const n=this._syncedSignals[t];n.signal===e&&(n.nodes.forEach(e=>e.dispose()),n.signal.value=n.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),Ww(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Bw.mixin(LS),Ow(e=>{e.transport=new LS({context:e})}),Fw(e=>{e.transport.dispose()});class OS extends hS{constructor(e){super(e),this.input=void 0,this._state=new lS("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Gw,this._syncedStop=Gw,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new wS({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,Hw(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(hS.getDefaults(),{mute:!1,onstop:Gw,volume:0})}get state(){return this._synced?"started"===this.context.transport.state?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,n){let i=nw(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(i=this._clampToCurrentTime(i),this._synced||"started"!==this._state.getValueAtTime(i))if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const e=this._state.get(i);e&&(e.offset=this.toSeconds(Cw(t,0)),e.duration=n?this.toSeconds(n):void 0);const s=this.context.transport.schedule(e=>{this._start(e,t,n)},i);this._scheduled.push(s),"started"===this.context.transport.state&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else uw(this.context),this._start(i,t,n);else cw(Pw(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,t,n);return this}stop(e){let t=nw(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),"started"===this._state.getValueAtTime(t)||iw(this._state.getNextState("started",t))){if(this.log("stop",t),this._synced){const e=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(e)}else this._stop(t);this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,n){return e=this.toSeconds(e),"started"===this._state.getValueAtTime(e)&&(this._state.cancel(e),this._restart(e,t,n)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(Pw(t,0)){const n=this._state.get(t);if(n&&"started"===n.state&&n.time!==t){const i=t-this.toSeconds(n.time);let s;n.duration&&(s=this.toSeconds(n.duration)-i),this._start(e,this.toSeconds(n.offset)+i,s)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));"started"===this._state.getValueAtTime(t)&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Gw,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class US extends mS{constructor(){const e=Ew(US.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,dS(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new cS({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new qw(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(mS.getDefaults(),{url:new qw,loop:!1,loopEnd:0,loopStart:0,onload:Gw,onerror:Gw,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,n,i=1){cw(this.buffer.loaded,"buffer is either not set or not loaded");const s=this.toSeconds(e);this._startGain(s,i),t=this.loop?Cw(t,this.loopStart):Cw(t,0);let r=Math.max(this.toSeconds(t),0);if(this.loop){const e=this.toSeconds(this.loopEnd)||this.buffer.duration,t=this.toSeconds(this.loopStart),n=e-t;Iw(r,e)&&(r=(r-t)%n+t),Dw(r,this.buffer.duration)&&(r=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,jw(r,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(s,r)),iw(n)){let e=this.toSeconds(n);e=Math.max(e,0),this.stop(s+e)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function FS(e,t){return m(this,void 0,void 0,function*(){const n=t/e.context.sampleRate,i=new Xw(1,n,e.context.sampleRate);return new e.constructor(Object.assign(e.get(),{frequency:2/n,detune:0,context:i})).toDestination().start(0),(yield i.render()).getChannelData(0)})}class BS extends mS{constructor(){const e=Ew(BS.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],dS(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new cS({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new cS({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),Hw(this,["frequency","detune"])}static getDefaults(){return Object.assign(mS.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),"started"===this.state&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class zS extends OS{constructor(){const e=Ew(zS.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new gS({context:this.context,units:"frequency",value:e.frequency}),Hw(this,"frequency"),this.detune=new gS({context:this.context,units:"cents",value:e.detune}),Hw(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&"custom"!==e.type&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(OS.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),n=new BS({context:this.context,onended:()=>this.onstop(this)});this._oscillator=n,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if("custom"===this._type)return zS._periodicWaveCache.find(e=>{return e.phase===this._phase&&(t=e.partials,n=this._partials,t.length===n.length&&t.every((e,t)=>n[t]===e));var t,n});{const e=zS._periodicWaveCache.find(e=>e.type===this._type&&e.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=-1!==["sine","square","sawtooth","triangle"].indexOf(e);if(0===this._phase&&t)this._wave=void 0,this._partialCount=0,null!==this._oscillator&&(this._oscillator.type=e);else{const t=this._getCachedPeriodicWave();if(iw(t)){const{partials:e,wave:n}=t;this._wave=n,this._partials=e,null!==this._oscillator&&this._oscillator.setPeriodicWave(this._wave)}else{const[t,n]=this._getRealImaginary(e,this._phase),i=this.context.createPeriodicWave(t,n);this._wave=i,null!==this._oscillator&&this._oscillator.setPeriodicWave(this._wave),zS._periodicWaveCache.push({imag:n,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:t,type:this._type,wave:this._wave}),zS._periodicWaveCache.length>100&&zS._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&"custom"!==this._type&&"custom"!==e?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){hw(e,0);let t=this._type;const n=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(n&&(t=n[1]),"custom"!==this._type)this.type=0===e?t:t+e.toString();else{const t=new Float32Array(e);this._partials.forEach((e,n)=>t[n]=e),this._partials=Array.from(t),this.type=this._type}}_getRealImaginary(e,t){let n=2048;const i=new Float32Array(n),s=new Float32Array(n);let r=1;if("custom"===e){if(r=this._partials.length+1,this._partialCount=this._partials.length,n=r,0===this._partials.length)return[i,s]}else{const t=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);t?(r=parseInt(t[2],10)+1,this._partialCount=parseInt(t[2],10),e=t[1],r=Math.max(r,2),n=r):this._partialCount=0,this._partials=[]}for(let a=1;a<n;++a){const n=2/(a*Math.PI);let o;switch(e){case"sine":o=a<=r?1:0,this._partials[a-1]=o;break;case"square":o=1&a?2*n:0,this._partials[a-1]=o;break;case"sawtooth":o=n*(1&a?1:-1),this._partials[a-1]=o;break;case"triangle":o=1&a?n*n*2*(a-1>>1&1?-1:1):0,this._partials[a-1]=o;break;case"custom":o=this._partials[a-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}0!==o?(i[a]=-o*Math.sin(t*a),s[a]=o*Math.cos(t*a)):(i[a]=0,s[a]=0)}return[i,s]}_inverseFFT(e,t,n){let i=0;const s=e.length;for(let r=0;r<s;r++)i+=e[r]*Math.cos(r*n)+t[r]*Math.sin(r*n);return i}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let n=0;const i=2*Math.PI;for(let r=0;r<32;r++)n=Math.max(this._inverseFFT(e,t,r/32*i),n);return s=-this._inverseFFT(e,t,this._phase)/n,Math.max(Math.min(s,1),-1);var s}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),null!==this._oscillator&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}zS._periodicWaveCache=[];class VS extends PS{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new IS({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class HS extends gS{constructor(){const e=Ew(HS.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new pS({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(gS.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class WS extends OS{constructor(){const e=Ew(WS.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new VS({context:this.context}),this._modulationNode=new pS({context:this.context}),this._carrier=new zS({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new zS({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new HS({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Hw(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(zS.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class GS extends OS{constructor(){const e=Ew(GS.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new pS({context:this.context,gain:0}),this._carrier=new zS({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new gS({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new zS({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new HS({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new HS({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Hw(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(zS.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class qS extends OS{constructor(){const e=Ew(qS.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new pS({context:this.context,gain:0}),this._thresh=new IS({context:this.context,mapping:e=>e<=0?-1:1}),this.width=new gS({context:this.context,units:"audioRange",value:e.width}),this._triangle=new zS({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Hw(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(OS.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class XS extends OS{constructor(){const e=Ew(XS.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new gS({context:this.context,units:"frequency",value:e.frequency}),this.detune=new gS({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,Hw(this,["frequency","detune"])}static getDefaults(){return Object.assign(zS.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,n=e/(this._oscillators.length-1);this._forEach((e,i)=>e.detune.value=t+n*i)}}get count(){return this._oscillators.length}set count(e){if(hw(e,1),this._oscillators.length!==e){this._forEach(e=>e.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const n=new zS({context:this.context,volume:-6-1.1*e,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:0===t?()=>this.onstop(this):Gw});"custom"===this.type&&(n.partials=this._partials),this.frequency.connect(n.frequency),this.detune.connect(n.detune),n.detune.overridden=!1,n.connect(this.output),this._oscillators[t]=n}this.spread=this._spread,"started"===this.state&&this._forEach(e=>e.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((e,t)=>e.phase=this._phase+t/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class YS extends OS{constructor(){const e=Ew(YS.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new HS({context:this.context,value:2}),this._pulse=new qS({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new zS({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Hw(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(OS.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const $S={am:WS,fat:XS,fm:GS,oscillator:zS,pulse:qS,pwm:YS};class ZS extends OS{constructor(){const e=Ew(ZS.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new gS({context:this.context,units:"frequency",value:e.frequency}),this.detune=new gS({context:this.context,units:"cents",value:e.detune}),Hw(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(zS.getDefaults(),GS.getDefaults(),WS.getDefaults(),XS.getDefaults(),qS.getDefaults(),YS.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(e=>this._sourceType===e)&&(e=this._sourceType),e+this._oscillator.type}set type(e){"fm"===e.substr(0,2)?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):"am"===e.substr(0,2)?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):"fat"===e.substr(0,3)?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):"pwm"===e?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):"pulse"===e?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=$S[e],n=this.now();if(this._oscillator){const e=this._oscillator;e.stop(n),this.context.setTimeout(()=>e.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),"started"===this.state&&this._oscillator.start(n)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";"pwm"!==this._oscillator.type&&"pulse"!==this._oscillator.type&&(t=this._oscillator.type),"fm"===e?this.type="fm"+t:"am"===e?this.type="am"+t:"fat"===e?this.type="fat"+t:"oscillator"===e?this.type=t:"pulse"===e?this.type="pulse":"pwm"===e&&(this.type="pwm")}_getOscType(e,t){return e instanceof $S[t]}get baseType(){return this._oscillator.baseType}set baseType(e){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||"pulse"===e||"pwm"===e||(this._oscillator.baseType=e)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(e){this._getOscType(this._oscillator,"fat")&&sw(e)&&(this._oscillator.count=e)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(e){this._getOscType(this._oscillator,"fat")&&sw(e)&&(this._oscillator.spread=e)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&ow(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return m(this,arguments,void 0,function*(e=1024){return FS(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function KS(e,t=1/0){const n=new WeakMap;return function(i,s){Reflect.defineProperty(i,s,{configurable:!0,enumerable:!0,get:function(){return n.get(this)},set:function(i){hw(i,e,t),n.set(this,i)}})}}function JS(e,t=1/0){const n=new WeakMap;return function(i,s){Reflect.defineProperty(i,s,{configurable:!0,enumerable:!0,get:function(){return n.get(this)},set:function(i){hw(this.toSeconds(i),e,t),n.set(this,i)}})}}class QS extends OS{constructor(){const e=Ew(QS.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new qw({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(OS.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Gw,onerror:Gw,playbackRate:1,reverse:!1})}load(e){return m(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=Gw){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),0!==this._activeSources.size||this._synced||"started"!==this._state.getValueAtTime(this.now())||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,n){return super.start(e,t,n),this}_start(e,t,n){t=this._loop?Cw(t,this._loopStart):Cw(t,0);const i=this.toSeconds(t),s=n;n=Cw(n,Math.max(this._buffer.duration-i,0));let r=this.toSeconds(n);r/=this._playbackRate,e=this.toSeconds(e);const a=new US({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(e+r),this._state.setStateAtTime("stopped",e+r,{implicitEnd:!0})),this._activeSources.add(a),this._loop&&nw(s)?a.start(e,i):a.start(e,i,r-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(e=>e.stop(t))}restart(e,t,n){return super.restart(e,t,n),this}_restart(e,t,n){var i;null===(i=[...this._activeSources].pop())||void 0===i||i.stop(e),this._start(e,t,n)}seek(e,t){const n=this.toSeconds(t);if("started"===this._state.getValueAtTime(n)){const t=this.toSeconds(e);this._stop(n),this._start(n,t)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&hw(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&hw(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const e=this._state.getNextState("stopped",this.now());e&&this._state.cancel(e.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),n=this._state.getNextState("stopped",t);n&&n.implicitEnd&&(this._state.cancel(n.time),this._activeSources.forEach(e=>e.cancelStop())),this._activeSources.forEach(n=>{n.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}f([JS(0)],QS.prototype,"fadeIn",void 0),f([JS(0)],QS.prototype,"fadeOut",void 0);class eM extends hS{constructor(){const e=Ew(eM.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new gS({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(hS.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(ow(e))return e;{let n;for(n in tM)if(tM[n][t]===e)return n;return e}}_setCurve(e,t,n){if(ow(n)&&Reflect.has(tM,n)){const i=tM[n];rw(i)?"_decayCurve"!==e&&(this[e]=i[t]):this[e]=i}else{if(!aw(n)||"_decayCurve"===e)throw new Error("Envelope: invalid curve: "+n);this[e]=n}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let n=this.toSeconds(this.attack);const i=this.toSeconds(this.decay),s=this.getValueAtTime(e);if(s>0&&(n=(1-s)/(1/n)),n<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if("linear"===this._attackCurve)this._sig.linearRampTo(t,n,e);else if("exponential"===this._attackCurve)this._sig.targetRampTo(t,n,e);else{this._sig.cancelAndHoldAtTime(e);let i=this._attackCurve;for(let e=1;e<i.length;e++)if(i[e-1]<=s&&s<=i[e]){i=this._attackCurve.slice(e),i[0]=s;break}this._sig.setValueCurveAtTime(i,e,n,t)}if(i&&this.sustain<1){const s=t*this.sustain,r=e+n;this.log("decay",r),"linear"===this._decayCurve?this._sig.linearRampToValueAtTime(s,i+r):this._sig.exponentialApproachValueAtTime(s,r,i)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const n=this.toSeconds(this.release);n<this.sampleTime?this._sig.setValueAtTime(0,e):"linear"===this._releaseCurve?this._sig.linearRampTo(0,n,e):"exponential"===this._releaseCurve?this._sig.targetRampTo(0,n,e):(cw(aw(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,n,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,n=1){return t=this.toSeconds(t),this.triggerAttack(t,n),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,n=0){return vS(this,e,t,n),this}asArray(){return m(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,n=new Xw(1,t,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),s=i+this.toSeconds(this.release),r=.1*s,a=s+r,o=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/a,decay:t*this.toSeconds(this.decay)/a,release:t*this.toSeconds(this.release)/a,context:n}));return o._sig.toDestination(),o.triggerAttackRelease(t*(i+r)/a,0),(yield n.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}f([JS(0)],eM.prototype,"attack",void 0),f([JS(0)],eM.prototype,"decay",void 0),f([KS(0,1)],eM.prototype,"sustain",void 0),f([JS(0)],eM.prototype,"release",void 0);const tM=(()=>{const e=128;let t,n;const i=[];for(t=0;t<e;t++)i[t]=Math.sin(t/127*(Math.PI/2));const s=[];for(t=0;t<127;t++){n=t/127;const e=Math.sin(n*(2*Math.PI)*6.4-Math.PI/2)+1;s[t]=e/10+.83*n}s[127]=1;const r=[];for(t=0;t<e;t++)r[t]=Math.ceil(t/127*5)/5;const a=[];for(t=0;t<e;t++)n=t/127,a[t]=.5*(1-Math.cos(Math.PI*n));const o=[];for(t=0;t<e;t++){n=t/127;const e=4*Math.pow(n,3)+.2,i=Math.cos(e*Math.PI*2*n);o[t]=Math.abs(i*(1-n))}function l(e){const t=new Array(e.length);for(let n=0;n<e.length;n++)t[n]=1-e[n];return t}return{bounce:{In:l(o),Out:o},cosine:{In:i,Out:(c=i,c.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:s,Out:l(s)},sine:{In:a,Out:l(a)},step:{In:r,Out:l(r)}};var c})();class nM extends hS{constructor(){const e=Ew(nM.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=e=>this._original_triggerRelease(e),this._volume=this.output=new wS({context:this.context,volume:e.volume}),this.volume=this._volume.volume,Hw(this,"volume")}static getDefaults(){return Object.assign(hS.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const n=this["_original_"+e]=this[e];this[e]=(...e)=>{const i=e[t],s=this.context.transport.schedule(i=>{e[t]=i,n.apply(this,e)},i);this._scheduledEvents.push(s)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,n,i){const s=this.toSeconds(n),r=this.toSeconds(t);return this.triggerAttack(e,s,i),this.triggerRelease(s+r),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class iM extends nM{constructor(){const e=Ew(iM.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(nM.getDefaults(),{detune:0,onsilence:Gw,portamento:0})}triggerAttack(e,t,n=1){this.log("triggerAttack",e,t,n);const i=this.toSeconds(t);return this._triggerEnvelopeAttack(i,n),this.setNote(e,i),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const n=this.toSeconds(t),i=e instanceof iS?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(n)>.05){const e=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,e,n)}else this.frequency.setValueAtTime(i,n);return this}}f([JS(0)],iM.prototype,"portamento",void 0);class sM extends eM{constructor(){super(Ew(sM.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new pS({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class rM extends iM{constructor(){const e=Ew(rM.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new ZS(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new sM(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),Hw(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(iM.getDefaults(),{envelope:Object.assign(Aw(eM.getDefaults(),Object.keys(hS.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Aw(ZS.getDefaults(),[...Object.keys(OS.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),0===this.envelope.sustain){const t=this.toSeconds(this.envelope.attack),n=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+t+n)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class aM extends rM{constructor(){const e=Ew(aM.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,Hw(this,["oscillator","envelope"])}static getDefaults(){return Tw(iM.getDefaults(),rM.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const n=this.toSeconds(t),i=this.toFrequency(e instanceof iS?e.toFrequency():e),s=i*this.octaves;return this.oscillator.frequency.setValueAtTime(s,n),this.oscillator.frequency.exponentialRampToValueAtTime(i,n+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}f([KS(0)],aM.prototype,"octaves",void 0),f([JS(0)],aM.prototype,"pitchDecay",void 0);const oM=new Set;function lM(e){oM.add(e)}function cM(e,t){const n=`registerProcessor("${e}", ${t})`;oM.add(n)}lM('\n\t/**\n\t * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. \n\t */\n\tclass ToneAudioWorkletProcessor extends AudioWorkletProcessor {\n\n\t\tconstructor(options) {\n\t\t\t\n\t\t\tsuper(options);\n\t\t\t/**\n\t\t\t * If the processor was disposed or not. Keep alive until it\'s disposed.\n\t\t\t */\n\t\t\tthis.disposed = false;\n\t\t   \t/** \n\t\t\t * The number of samples in the processing block\n\t\t\t */\n\t\t\tthis.blockSize = 128;\n\t\t\t/**\n\t\t\t * the sample rate\n\t\t\t */\n\t\t\tthis.sampleRate = sampleRate;\n\n\t\t\tthis.port.onmessage = (event) => {\n\t\t\t\t// when it receives a dispose \n\t\t\t\tif (event.data === "dispose") {\n\t\t\t\t\tthis.disposed = true;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n'),lM("\n\t/**\n\t * Abstract class for a single input/output processor. \n\t * has a 'generate' function which processes one sample at a time\n\t */\n\tclass SingleIOProcessor extends ToneAudioWorkletProcessor {\n\n\t\tconstructor(options) {\n\t\t\tsuper(Object.assign(options, {\n\t\t\t\tnumberOfInputs: 1,\n\t\t\t\tnumberOfOutputs: 1\n\t\t\t}));\n\t\t\t/**\n\t\t\t * Holds the name of the parameter and a single value of that\n\t\t\t * parameter at the current sample\n\t\t\t * @type { [name: string]: number }\n\t\t\t */\n\t\t\tthis.params = {}\n\t\t}\n\n\t\t/**\n\t\t * Generate an output sample from the input sample and parameters\n\t\t * @abstract\n\t\t * @param input number\n\t\t * @param channel number\n\t\t * @param parameters { [name: string]: number }\n\t\t * @returns number\n\t\t */\n\t\tgenerate(){}\n\n\t\t/**\n\t\t * Update the private params object with the \n\t\t * values of the parameters at the given index\n\t\t * @param parameters { [name: string]: Float32Array },\n\t\t * @param index number\n\t\t */\n\t\tupdateParams(parameters, index) {\n\t\t\tfor (const paramName in parameters) {\n\t\t\t\tconst param = parameters[paramName];\n\t\t\t\tif (param.length > 1) {\n\t\t\t\t\tthis.params[paramName] = parameters[paramName][index];\n\t\t\t\t} else {\n\t\t\t\t\tthis.params[paramName] = parameters[paramName][0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Process a single frame of the audio\n\t\t * @param inputs Float32Array[][]\n\t\t * @param outputs Float32Array[][]\n\t\t */\n\t\tprocess(inputs, outputs, parameters) {\n\t\t\tconst input = inputs[0];\n\t\t\tconst output = outputs[0];\n\t\t\t// get the parameter values\n\t\t\tconst channelCount = Math.max(input && input.length || 0, output.length);\n\t\t\tfor (let sample = 0; sample < this.blockSize; sample++) {\n\t\t\t\tthis.updateParams(parameters, sample);\n\t\t\t\tfor (let channel = 0; channel < channelCount; channel++) {\n\t\t\t\t\tconst inputSample = input && input.length ? input[channel][sample] : 0;\n\t\t\t\t\toutput[channel][sample] = this.generate(inputSample, channel, this.params);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn !this.disposed;\n\t\t}\n\t};\n"),lM("\n\t/**\n\t * A multichannel buffer for use within an AudioWorkletProcessor as a delay line\n\t */\n\tclass DelayLine {\n\t\t\n\t\tconstructor(size, channels) {\n\t\t\tthis.buffer = [];\n\t\t\tthis.writeHead = []\n\t\t\tthis.size = size;\n\n\t\t\t// create the empty channels\n\t\t\tfor (let i = 0; i < channels; i++) {\n\t\t\t\tthis.buffer[i] = new Float32Array(this.size);\n\t\t\t\tthis.writeHead[i] = 0;\n\t\t\t}\n\t\t}\n\n\t\t/**\n\t\t * Push a value onto the end\n\t\t * @param channel number\n\t\t * @param value number\n\t\t */\n\t\tpush(channel, value) {\n\t\t\tthis.writeHead[channel] += 1;\n\t\t\tif (this.writeHead[channel] > this.size) {\n\t\t\t\tthis.writeHead[channel] = 0;\n\t\t\t}\n\t\t\tthis.buffer[channel][this.writeHead[channel]] = value;\n\t\t}\n\n\t\t/**\n\t\t * Get the recorded value of the channel given the delay\n\t\t * @param channel number\n\t\t * @param delay number delay samples\n\t\t */\n\t\tget(channel, delay) {\n\t\t\tlet readHead = this.writeHead[channel] - Math.floor(delay);\n\t\t\tif (readHead < 0) {\n\t\t\t\treadHead += this.size;\n\t\t\t}\n\t\t\treturn this.buffer[channel][readHead];\n\t\t}\n\t}\n"),cM("feedback-comb-filter",'\n\tclass FeedbackCombFilterWorklet extends SingleIOProcessor {\n\n\t\tconstructor(options) {\n\t\t\tsuper(options);\n\t\t\tthis.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);\n\t\t}\n\n\t\tstatic get parameterDescriptors() {\n\t\t\treturn [{\n\t\t\t\tname: "delayTime",\n\t\t\t\tdefaultValue: 0.1,\n\t\t\t\tminValue: 0,\n\t\t\t\tmaxValue: 1,\n\t\t\t\tautomationRate: "k-rate"\n\t\t\t}, {\n\t\t\t\tname: "feedback",\n\t\t\t\tdefaultValue: 0.5,\n\t\t\t\tminValue: 0,\n\t\t\t\tmaxValue: 0.9999,\n\t\t\t\tautomationRate: "k-rate"\n\t\t\t}];\n\t\t}\n\n\t\tgenerate(input, channel, parameters) {\n\t\t\tconst delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);\n\t\t\tthis.delayLine.push(channel, input + delayedSample * parameters.feedback);\n\t\t\treturn delayedSample;\n\t\t}\n\t}\n');class hM extends nM{constructor(){const e=Ew(hM.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(n=>{const i=parseInt(n,10);if(cw(lw(n)||sw(i)&&isFinite(i),`url key is neither a note or midi pitch: ${n}`),lw(n)){const i=new iS(this.context,n).toMidi();t[i]=e.urls[n]}else sw(i)&&isFinite(i)&&(t[i]=e.urls[i])}),this._buffers=new TS({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(nM.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Gw,onerror:Gw,release:.1,urls:{}})}_findClosest(e){let t=0;for(;t<96;){if(this._buffers.has(e+t))return-t;if(this._buffers.has(e-t))return t;t++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,n=1){return this.log("triggerAttack",e,t,n),Array.isArray(e)||(e=[e]),e.forEach(e=>{const i=eS(new iS(this.context,e).toFrequency()),s=Math.round(i),r=i-s,a=this._findClosest(s),o=s-a,l=this._buffers.get(o),c=Kw(a+r),h=new US({url:l,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:c}).connect(this.output);h.start(t,0,l.duration/c,n),aw(this._activeSources.get(s))||this._activeSources.set(s,[]),this._activeSources.get(s).push(h),h.onended=()=>{if(this._activeSources&&this._activeSources.has(s)){const e=this._activeSources.get(s),t=e.indexOf(h);-1!==t&&e.splice(t,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(e=>{const n=new iS(this.context,e).toMidi();if(this._activeSources.has(n)&&this._activeSources.get(n).length){const e=this._activeSources.get(n);t=this.toSeconds(t),e.forEach(e=>{e.stop(t)}),this._activeSources.set(n,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(e=>{for(;e.length;)e.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,n,i=1){const s=this.toSeconds(n);return this.triggerAttack(e,s,i),aw(t)?(cw(aw(e),"notes must be an array when duration is array"),e.forEach((e,n)=>{const i=t[Math.min(n,t.length-1)];this.triggerRelease(e,s+this.toSeconds(i))})):this.triggerRelease(e,s+this.toSeconds(t)),this}add(e,t,n){if(cw(lw(e)||isFinite(e),`note must be a pitch or midi: ${e}`),lw(e)){const i=new iS(this.context,e).toMidi();this._buffers.add(i,t,n)}else this._buffers.add(e,t,n);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(e=>e.dispose())}),this._activeSources.clear(),this}}f([JS(0)],hM.prototype,"attack",void 0),f([JS(0)],hM.prototype,"release",void 0);class uM extends hS{constructor(){const e=Ew(uM.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new cS({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",Hw(this,"pan")}static getDefaults(){return Object.assign(hS.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}cM("bit-crusher","\n\tclass BitCrusherWorklet extends SingleIOProcessor {\n\n\t\tstatic get parameterDescriptors() {\n\t\t\treturn [{\n\t\t\t\tname: \"bits\",\n\t\t\t\tdefaultValue: 12,\n\t\t\t\tminValue: 1,\n\t\t\t\tmaxValue: 16,\n\t\t\t\tautomationRate: 'k-rate'\n\t\t\t}];\n\t\t}\n\n\t\tgenerate(input, _channel, parameters) {\n\t\t\tconst step = Math.pow(0.5, parameters.bits - 1);\n\t\t\tconst val = step * Math.floor(input / step + 0.5);\n\t\t\treturn val;\n\t\t}\n\t}\n");class dM extends hS{constructor(){const e=Ew(dM.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new pS({context:this.context}),dM._allSolos.has(this.context)||dM._allSolos.set(this.context,new Set),dM._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(hS.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),dM._allSolos.get(this.context).forEach(e=>e._updateSolo())}get muted(){return 0===this.input.gain.value}_addSolo(){dM._soloed.has(this.context)||dM._soloed.set(this.context,new Set),dM._soloed.get(this.context).add(this)}_removeSolo(){dM._soloed.has(this.context)&&dM._soloed.get(this.context).delete(this)}_isSoloed(){return dM._soloed.has(this.context)&&dM._soloed.get(this.context).has(this)}_noSolos(){return!dM._soloed.has(this.context)||dM._soloed.has(this.context)&&0===dM._soloed.get(this.context).size}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),dM._allSolos.get(this.context).delete(this),this._removeSolo(),this}}dM._allSolos=new Map,dM._soloed=new Map;class pM extends hS{constructor(){const e=Ew(pM.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new uM({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new wS({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,Hw(this,["pan","volume"])}static getDefaults(){return Object.assign(hS.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class mM extends hS{constructor(){const e=Ew(mM.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new dM({solo:e.solo,context:this.context}),this._panVol=this.output=new pM({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Hw(this,["pan","volume"])}static getDefaults(){return Object.assign(hS.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return mM.buses.has(e)||mM.buses.set(e,new pS({context:this.context})),mM.buses.get(e)}send(e,t=0){const n=this._getBus(e),i=new pS({context:this.context,units:"decibels",gain:t});return this.connect(i),i.connect(n),i}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}mM.buses=new Map,Zw().transport,Zw().destination,Zw().destination,Zw().listener,Zw().draw,Zw();const fM={type:"change"},gM={type:"start"},vM={type:"end"},xM=new tu,yM=new $d,_M=Math.cos(70*Kc),bM=new eh,wM=2*Math.PI,SM=-1,MM=1e-6;class TM extends bp{constructor(e,t=null){super(e,t),this.state=SM,this.target=new eh,this.cursor=new eh,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:0,MIDDLE:1,RIGHT:2},this.touches={ONE:0,TWO:2},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new eh,this._lastQuaternion=new Qc,this._lastTargetPosition=new eh,this._quat=(new Qc).setFromUnitVectors(e.up,new eh(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new _p,this._sphericalDelta=new _p,this._scale=1,this._panOffset=new eh,this._rotateStart=new Jc,this._rotateEnd=new Jc,this._rotateDelta=new Jc,this._panStart=new Jc,this._panEnd=new Jc,this._panDelta=new Jc,this._dollyStart=new Jc,this._dollyEnd=new Jc,this._dollyDelta=new Jc,this._dollyDirection=new eh,this._mouse=new Jc,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=CM.bind(this),this._onPointerDown=EM.bind(this),this._onPointerUp=AM.bind(this),this._onContextMenu=kM.bind(this),this._onMouseWheel=PM.bind(this),this._onKeyDown=IM.bind(this),this._onTouchStart=jM.bind(this),this._onTouchMove=DM.bind(this),this._onMouseDown=NM.bind(this),this._onMouseMove=RM.bind(this),this._interceptControlDown=LM.bind(this),this._interceptControlUp=OM.bind(this),null!==this.domElement&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){null!==this._domElementKeyEvents&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(fM),this.update(),this.state=SM}update(e=null){const t=this.object.position;bM.copy(t).sub(this.target),bM.applyQuaternion(this._quat),this._spherical.setFromVector3(bM),this.autoRotate&&this.state===SM&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let n=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(n)&&isFinite(i)&&(n<-Math.PI?n+=wM:n>Math.PI&&(n-=wM),i<-Math.PI?i+=wM:i>Math.PI&&(i-=wM),this._spherical.theta=n<=i?Math.max(n,Math.min(i,this._spherical.theta)):this._spherical.theta>(n+i)/2?Math.max(n,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),!0===this.enableDamping?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let s=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const e=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),s=e!=this._spherical.radius}if(bM.setFromSpherical(this._spherical),bM.applyQuaternion(this._quatInverse),t.copy(this.target).add(bM),this.object.lookAt(this.target),!0===this.enableDamping?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let e=null;if(this.object.isPerspectiveCamera){const t=bM.length();e=this._clampDistance(t*this._scale);const n=t-e;this.object.position.addScaledVector(this._dollyDirection,n),this.object.updateMatrixWorld(),s=!!n}else if(this.object.isOrthographicCamera){const t=new eh(this._mouse.x,this._mouse.y,0);t.unproject(this.object);const n=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),s=n!==this.object.zoom;const i=new eh(this._mouse.x,this._mouse.y,0);i.unproject(this.object),this.object.position.sub(i).add(t),this.object.updateMatrixWorld(),e=bM.length()}else this.zoomToCursor=!1;null!==e&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(e).add(this.object.position):(xM.origin.copy(this.object.position),xM.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(xM.direction))<_M?this.object.lookAt(this.target):(yM.setFromNormalAndCoplanarPoint(this.object.up,this.target),xM.intersectPlane(yM,this.target))))}else if(this.object.isOrthographicCamera){const e=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),e!==this.object.zoom&&(this.object.updateProjectionMatrix(),s=!0)}return this._scale=1,this._performCursorZoom=!1,!!(s||this._lastPosition.distanceToSquared(this.object.position)>MM||8*(1-this._lastQuaternion.dot(this.object.quaternion))>MM||this._lastTargetPosition.distanceToSquared(this.target)>MM)&&(this.dispatchEvent(fM),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0)}_getAutoRotationAngle(e){return null!==e?wM/60*this.autoRotateSpeed*e:wM/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(.01*e);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){bM.setFromMatrixColumn(t,0),bM.multiplyScalar(-e),this._panOffset.add(bM)}_panUp(e,t){!0===this.screenSpacePanning?bM.setFromMatrixColumn(t,1):(bM.setFromMatrixColumn(t,0),bM.crossVectors(this.object.up,bM)),bM.multiplyScalar(e),this._panOffset.add(bM)}_pan(e,t){const n=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;bM.copy(i).sub(this.target);let s=bM.length();s*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*s/n.clientHeight,this.object.matrix),this._panUp(2*t*s/n.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/n.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/n.clientHeight,this.object.matrix)):this.enablePan=!1}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:this.enableZoom=!1}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:this.enableZoom=!1}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const n=this.domElement.getBoundingClientRect(),i=e-n.left,s=t-n.top,r=n.width,a=n.height;this._mouse.x=i/r*2-1,this._mouse.y=-s/a*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(wM*this._rotateDelta.x/t.clientHeight),this._rotateUp(wM*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(wM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-wM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(wM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-wM*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(1===this._pointers.length)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateStart.set(n,i)}}_handleTouchStartPan(e){if(1===this._pointers.length)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panStart.set(n,i)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(n*n+i*i);this._dollyStart.set(0,s)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(1==this._pointers.length)this._rotateEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateEnd.set(n,i)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(wM*this._rotateDelta.x/t.clientHeight),this._rotateUp(wM*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(1===this._pointers.length)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),n=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panEnd.set(n,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),n=e.pageX-t.x,i=e.pageY-t.y,s=Math.sqrt(n*n+i*i);this._dollyEnd.set(0,s),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const r=.5*(e.pageX+t.x),a=.5*(e.pageY+t.y);this._updateZoomParameters(r,a)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return void this._pointers.splice(t,1)}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new Jc,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100}return e.ctrlKey&&!this._controlActive&&(n.deltaY*=10),n}}function EM(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._isTrackingPointer(e)||(this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e)))}function CM(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function AM(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(vM),this.state=SM;break;case 1:const t=this._pointers[0],n=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:n.x,pageY:n.y})}}function NM(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case 1:if(!1===this.enableZoom)return;this._handleMouseDownDolly(e),this.state=1;break;case 0:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=2}else{if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=0}break;case 2:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=0}else{if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=2}break;default:this.state=SM}this.state!==SM&&this.dispatchEvent(gM)}function RM(e){switch(this.state){case 0:if(!1===this.enableRotate)return;this._handleMouseMoveRotate(e);break;case 1:if(!1===this.enableZoom)return;this._handleMouseMoveDolly(e);break;case 2:if(!1===this.enablePan)return;this._handleMouseMovePan(e)}}function PM(e){!1!==this.enabled&&!1!==this.enableZoom&&this.state===SM&&(e.preventDefault(),this.dispatchEvent(gM),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(vM))}function IM(e){!1!==this.enabled&&this._handleKeyDown(e)}function jM(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case 0:if(!1===this.enableRotate)return;this._handleTouchStartRotate(e),this.state=3;break;case 1:if(!1===this.enablePan)return;this._handleTouchStartPan(e),this.state=4;break;default:this.state=SM}break;case 2:switch(this.touches.TWO){case 2:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchStartDollyPan(e),this.state=5;break;case 3:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchStartDollyRotate(e),this.state=6;break;default:this.state=SM}break;default:this.state=SM}this.state!==SM&&this.dispatchEvent(gM)}function DM(e){switch(this._trackPointer(e),this.state){case 3:if(!1===this.enableRotate)return;this._handleTouchMoveRotate(e),this.update();break;case 4:if(!1===this.enablePan)return;this._handleTouchMovePan(e),this.update();break;case 5:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchMoveDollyPan(e),this.update();break;case 6:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=SM}}function kM(e){!1!==this.enabled&&e.preventDefault()}function LM(e){"Control"===e.key&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function OM(e){"Control"===e.key&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const UM=new class{constructor(){t(this,"STORAGE_KEY","mythseeker_dice_rolls"),t(this,"STATS_KEY","mythseeker_dice_stats"),t(this,"SETTINGS_KEY","mythseeker_dice_settings")}getRolls(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}addRoll(e){const t={...e,id:this.generateId(),timestamp:Date.now()},n=this.getRolls();return n.unshift(t),n.length>1e3&&n.splice(1e3),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),this.updateStats(),t}getFilteredRolls(e){let t=this.getRolls();return e.sides&&(t=t.filter(t=>t.sides===e.sides)),e.campaignId&&(t=t.filter(t=>t.campaignId===e.campaignId)),e.characterId&&(t=t.filter(t=>t.characterId===e.characterId)),e.startDate&&(t=t.filter(t=>t.timestamp>=e.startDate)),e.endDate&&(t=t.filter(t=>t.timestamp<=e.endDate)),e.limit&&(t=t.slice(0,e.limit)),t}getStats(){try{const e=localStorage.getItem(this.STATS_KEY);return e?JSON.parse(e):this.calculateStats()}catch(e){return this.calculateStats()}}calculateStats(){var e;const t=this.getRolls();if(0===t.length)return{totalRolls:0,averageRoll:0,highestRoll:0,lowestRoll:0,mostRolledSides:0,rollDistribution:{},recentRolls:[]};const n=t.length,i=t.reduce((e,t)=>e+t.result,0)/n,s=Math.max(...t.map(e=>e.result)),r=Math.min(...t.map(e=>e.result)),a={};t.forEach(e=>{a[e.sides]=(a[e.sides]||0)+1});const o=(null==(e=Object.entries(a).sort(([,e],[,t])=>t-e)[0])?void 0:e[0])||"0";return{totalRolls:n,averageRoll:Math.round(100*i)/100,highestRoll:s,lowestRoll:r,mostRolledSides:parseInt(o),rollDistribution:a,recentRolls:t.slice(0,10)}}updateStats(){const e=this.calculateStats();localStorage.setItem(this.STATS_KEY,JSON.stringify(e))}getDiceSets(){const e=[{id:"classic",name:"Classic Purple",color:9133302,roughness:.5,metalness:.8,unlocked:!0,rarity:"common"},{id:"crystal",name:"Crystal Blue",color:3900150,roughness:.1,metalness:.9,emissive:934063,emissiveIntensity:.2,unlocked:!0,rarity:"common"},{id:"golden",name:"Golden",color:16498468,roughness:0,metalness:1,unlocked:!1,rarity:"rare"},{id:"emerald",name:"Emerald",color:1096065,roughness:0,metalness:.7,unlocked:!1,rarity:"rare"},{id:"ruby",name:"Ruby",color:15680580,roughness:0,metalness:.6,unlocked:!1,rarity:"epic"},{id:"obsidian",name:"Obsidian",color:2042167,roughness:.8,metalness:.3,unlocked:!1,rarity:"legendary"},{id:"wooden",name:"Wooden",color:9584654,roughness:.9,metalness:1,unlocked:!0,rarity:"common"},{id:"neon",name:"Neon Pink",color:15485081,roughness:.2,metalness:.8,emissive:15485081,emissiveIntensity:.3,unlocked:!1,rarity:"epic"}];try{const t=localStorage.getItem("mythseeker_dice_sets");if(t){const n=JSON.parse(t);return e.map(e=>({...e,...n.find(t=>t.id===e.id)}))}}catch(t){}return e}unlockDiceSet(e){const t=this.getDiceSets(),n=t.findIndex(t=>t.id===e);-1!==n&&(t[n].unlocked=!0,localStorage.setItem("mythseeker_dice_sets",JSON.stringify(t)))}getSettings(){try{const e=localStorage.getItem(this.SETTINGS_KEY);return e?JSON.parse(e):this.getDefaultSettings()}catch(e){return this.getDefaultSettings()}}updateSettings(e){localStorage.setItem(this.SETTINGS_KEY,JSON.stringify(e))}getDefaultSettings(){return{soundEnabled:!0,hapticEnabled:!0,shakeToRoll:!0,showHistory:!0,autoSaveRolls:!0,defaultSides:20,defaultDiceSet:"classic"}}clearData(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.STATS_KEY),localStorage.removeItem(this.SETTINGS_KEY)}exportData(){const e={rolls:this.getRolls(),stats:this.getStats(),settings:this.getSettings(),diceSets:this.getDiceSets(),exportDate:(new Date).toISOString()};return JSON.stringify(e,null,2)}importData(e){try{const t=JSON.parse(e);return t.rolls&&localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t.rolls)),t.stats&&localStorage.setItem(this.STATS_KEY,JSON.stringify(t.stats)),t.settings&&localStorage.setItem(this.SETTINGS_KEY,JSON.stringify(t.settings)),t.diceSets&&localStorage.setItem("mythseeker_dice_sets",JSON.stringify(t.diceSets)),!0}catch(t){return!1}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getRollStreak(){const e=this.getRolls();if(e.length<2)return{number:0,count:0};let t=1,n=1,i=e[0].result;for(let s=1;s<e.length;s++)e[s].result===e[s-1].result?(t++,t>n&&(n=t,i=e[s].result)):t=1;return{number:i,count:n}}getLuckyRolls(){const e=this.getRolls();return{natural20s:e.filter(e=>20===e.sides&&20===e.result).length,natural1s:e.filter(e=>1===e.result).length}}},FM=[{id:"classic",name:"Classic Purple",color:9133302,roughness:.5,metalness:.8},{id:"crystal",name:"Crystal Blue",color:3900150,roughness:.1,metalness:.9,emissive:934063,emissiveIntensity:.2},{id:"golden",name:"Golden",color:16498468,roughness:0,metalness:1},{id:"emerald",name:"Emerald",color:1096065,roughness:0,metalness:.7},{id:"ruby",name:"Ruby",color:15680580,roughness:0,metalness:.6},{id:"obsidian",name:"Obsidian",color:2042167,roughness:.8,metalness:.3},{id:"wooden",name:"Wooden",color:9584654,roughness:.9,metalness:1},{id:"neon",name:"Neon Pink",color:15485081,roughness:.2,metalness:.8,emissive:805017,emissiveIntensity:.3}],BM=({isOpen:e,onClose:t,onRollComplete:i,sides:s=6})=>{const r=n.useRef(null),[a,o]=n.useState(null),[l,c]=n.useState(!1),[h,u]=n.useState(0),[d,p]=n.useState(!1),[m,f]=n.useState(!1),[g,v]=n.useState(FM[0]),[x,y]=n.useState(!1),_=n.useRef(null),b=n.useRef(null),w=n.useRef(null),S=n.useRef(null),M=n.useRef(null),T=n.useRef(null),E=n.useRef(null),C=n.useRef(null),A=n.useRef(0),N=n.useRef(null),R=n.useRef(null),P=n.useRef(null),I=n.useRef({x:0,y:0,z:0}),j=n.useRef(null),D=n.useCallback(()=>{window.navigator.vibrate&&window.navigator.vibrate([30,50,30])},[]),k=n.useCallback((e,t)=>{if(!_.current||!S.current)return;let n,i;function s(e){const t=e.getAttribute("position"),n=[];for(let s=0;s<t.count;s++)n.push(new rg.Vec3(t.getX(s),t.getY(s),t.getZ(s)));const i=[];if(e.index){const t=e.index.array;for(let e=0;e<t.length;e+=3)i.push([t[e],t[e+1],t[e+2]])}return{vertices:n,faces:i}}switch(M.current&&(_.current.remove(M.current),M.current.geometry.dispose(),M.current.material.dispose()),T.current&&S.current.removeBody(T.current),e){case 4:{n=new ap(1);const{vertices:e,faces:t}=s(n);i=new rg.ConvexPolyhedron({vertices:e,faces:t});break}case 6:default:n=new Cd(1,1,1),i=new rg.Box(new rg.Vec3(.5,.5,.5));break;case 8:{n=new sp(1);const{vertices:e,faces:t}=s(n);i=new rg.ConvexPolyhedron({vertices:e,faces:t});break}case 10:{n=new np(1);const{vertices:e,faces:t}=s(n);i=new rg.ConvexPolyhedron({vertices:e,faces:t});break}case 12:{n=new np(1);const{vertices:e,faces:t}=s(n);i=new rg.ConvexPolyhedron({vertices:e,faces:t});break}case 20:{n=new ip(1);const{vertices:e,faces:t}=s(n);i=new rg.ConvexPolyhedron({vertices:e,faces:t});break}}const r=new op({color:t.color,roughness:t.roughness,metalness:t.metalness,emissive:t.emissive||0,emissiveIntensity:t.emissiveIntensity||0});M.current=new Td(n,r),_.current.add(M.current),T.current=new rg.Body({mass:1,shape:i}),T.current.position.set(0,5,0),S.current.addBody(T.current),T.current.applyImpulse(new rg.Vec3(.5*(Math.random()-.5),0,.5*(Math.random()-.5)),T.current.position)},[_,S]),L=n.useCallback(e=>{if(!e.accelerationIncludingGravity)return;const{x:t,y:n,z:i}=e.accelerationIncludingGravity,s={x:t||0,y:n||0,z:i||0};Math.abs(s.x-I.current.x)+Math.abs(s.y-I.current.y)+Math.abs(s.z-I.current.z)>15&&!l&&null===j.current&&(j.current=setTimeout(()=>{F(),j.current=null},100)),I.current=s},[l]);n.useEffect(()=>{if(!r.current)return;const e=()=>{if(w.current&&b.current&&r.current){const e=r.current.clientWidth,t=r.current.clientHeight;w.current.setSize(e,t,!1),b.current.aspect=e/t,b.current.updateProjectionMatrix()}};e();const t=new window.ResizeObserver(e);return t.observe(r.current),()=>t.disconnect()},[e]),n.useEffect(()=>{P.current||(P.current=new zS({frequency:200,type:"sine"}).toDestination())},[]);const O=n.useCallback(()=>{if(P.current){$w.resume();const e=Zw().now();P.current.frequency.setValueAtTime(200,e),P.current.frequency.exponentialRampTo(50,.3,e),P.current.volume.setValueAtTime(-10,e),P.current.volume.linearRampTo(-20,.3,e),P.current.start(e).stop(e+.3)}},[]);n.useEffect(()=>{if(!e||!r.current)return;_.current=new Gd,_.current.background=new Yu(1712172),b.current=new Od(75,1,.1,1e3),b.current.position.set(0,5,10),b.current.lookAt(0,0,0),w.current=new ig({canvas:r.current,antialias:!0}),w.current.setSize(r.current.clientWidth,r.current.clientHeight),w.current.setPixelRatio(window.devicePixelRatio),N.current=new TM(b.current,w.current.domElement),N.current.enableDamping=!0,N.current.dampingFactor=.05,N.current.screenSpacePanning=!1,N.current.maxPolarAngle=Math.PI/2,window.innerWidth<768&&(N.current.enableZoom=!1,N.current.enablePan=!1);const t=new xp(16777215,.5);_.current.add(t);const n=new vp(16777215,.8);n.position.set(5,10,7),_.current.add(n),S.current=new rg.World,S.current.gravity.set(0,-9.82,0),S.current.broadphase=new rg.NaiveBroadphase,S.current.solver.iterations=10;const i=new rg.Plane;C.current=new rg.Body({mass:0,shape:i}),C.current.quaternion.setFromAxisAngle(new rg.Vec3(1,0,0),-Math.PI/2),S.current.addBody(C.current);const a=new rp(20,20),l=new op({color:2963272,side:2});return E.current=new Td(a,l),E.current.rotation.x=-Math.PI/2,_.current.add(E.current),k(s,g),()=>{R.current&&cancelAnimationFrame(R.current),w.current&&w.current.dispose(),N.current&&N.current.dispose(),S.current&&(S.current.removeBody(T.current),S.current.removeBody(C.current)),_.current=null,b.current=null,w.current=null,S.current=null,M.current=null,T.current=null,E.current=null,C.current=null,o(null),c(!1)}},[e,s,g,k]),n.useEffect(()=>{e&&_.current&&S.current&&k(s,g)},[g,s,e,k]),n.useEffect(()=>{if(!(e&&w.current&&_.current&&b.current&&S.current&&M.current&&T.current))return;let t=!0;const n=()=>{if(t){if(R.current=requestAnimationFrame(n),S.current.step(1/60),M.current&&T.current&&(M.current.position.copy(T.current.position),M.current.quaternion.copy(T.current.quaternion),l&&T.current.sleepState===rg.Body.SLEEPING)){const e=U(T.current,s);null!==e&&(o(e),c(!1),O(),UM.addRoll({sides:s,result:e,diceSet:g.id,context:`3D Dice Roll - ${g.name}`}),i&&i(e))}N.current&&N.current.update(),w.current.render(_.current,b.current)}};return n(),()=>{t=!1,R.current&&cancelAnimationFrame(R.current)}},[e,s,l,O,i]),n.useEffect(()=>{if(!e)return;const t=window.innerWidth<768,n="undefined"!=typeof DeviceMotionEvent;if(t&&n){f(!0),p(!0),"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(e=>{"granted"===e&&window.addEventListener("devicemotion",L)}):window.addEventListener("devicemotion",L);const e=setTimeout(()=>p(!1),5e3);return()=>{window.removeEventListener("devicemotion",L),j.current&&clearTimeout(j.current),clearTimeout(e)}}},[e,L]);const U=(e,t)=>{const n=e.quaternion,i=new eh(0,1,0).applyQuaternion(n);let s=-1/0,r=null;const a={4:[{vector:new eh(0,1,0),value:1},{vector:new eh(.9428,-.3333,0),value:2},{vector:new eh(-.4714,-.3333,.8165),value:3},{vector:new eh(-.4714,-.3333,-.8165),value:4}],6:[{vector:new eh(0,1,0),value:6},{vector:new eh(0,-1,0),value:1},{vector:new eh(1,0,0),value:4},{vector:new eh(-1,0,0),value:3},{vector:new eh(0,0,1),value:2},{vector:new eh(0,0,-1),value:5}],8:[{vector:new eh(0,1,0),value:8},{vector:new eh(0,-1,0),value:1}],10:[{vector:new eh(0,1,0),value:10},{vector:new eh(0,-1,0),value:0}],12:[{vector:new eh(0,1,0),value:12},{vector:new eh(0,-1,0),value:1}],20:[{vector:new eh(0,1,0),value:20},{vector:new eh(0,-1,0),value:1}]}[t];if(!a)return Math.floor(Math.random()*t)+1;for(const o of a){const e=i.dot(o.vector);e>s&&(s=e,r=o.value)}return 10===t&&0===r?10:r},F=n.useCallback(()=>{if(!T.current||!S.current||l)return;if(Date.now()-A.current<2e3)return;c(!0),o(null),u(e=>e+1),A.current=Date.now(),D(),T.current.position.set(2*(Math.random()-.5),5+2*Math.random(),2*(Math.random()-.5)),T.current.velocity.set(0,0,0),T.current.angularVelocity.set(0,0,0);const e=5+5*Math.random(),t=.5+.5*Math.random();T.current.applyImpulse(new rg.Vec3((Math.random()-.5)*e,(.5*Math.random()+.5)*e,(Math.random()-.5)*e),T.current.position),T.current.applyTorque(new rg.Vec3((Math.random()-.5)*t,(Math.random()-.5)*t,(Math.random()-.5)*t)),T.current.wakeUp()},[l,D]);return e?at.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",children:at.jsxs("div",{className:"bg-gradient-to-br from-purple-900/90 to-blue-900/90 backdrop-blur-lg rounded-2xl p-8 border border-purple-400/30 shadow-2xl max-w-lg w-full mx-4 flex flex-col items-center",children:[at.jsxs("div",{className:"flex items-center justify-between w-full mb-6",children:[at.jsxs("h3",{className:"text-2xl font-bold mb-6 text-white text-center",children:["🎲 Roll d",s]}),at.jsx("button",{onClick:()=>y(!x),className:"px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors",children:"🎨 Dice"})]}),x&&at.jsxs("div",{className:"w-full mb-4 p-4 bg-gray-800 rounded-xl border border-gray-700 shadow-inner",children:[at.jsx("h4",{className:"text-white font-semibold mb-3 text-center",children:"Choose Your Dice Set"}),at.jsx("div",{className:"grid grid-cols-2 gap-2",children:FM.map(e=>at.jsxs("button",{onClick:()=>{v(e),y(!1)},className:"p-3 rounded-lg border-2 transition-all "+(g.id===e.id?"border-purple-400 bg-purple-600/20":"border-gray-600 hover:border-gray-500"),children:[at.jsx("div",{className:"text-white text-sm font-medium text-center",children:e.name}),at.jsx("div",{className:"w-12 h-12 rounded-full mx-auto mt-1",style:{backgroundColor:`#${e.color.toString(16).padStart(6,"0")}`}})]},e.id))})]}),d&&m&&at.jsx("div",{className:"mb-4 p-3 bg-blue-500 rounded-lg border border-blue-400/30 text-center",children:at.jsx("div",{className:"text-blue-300 text-sm font-medium",children:"📱 Shake your device to roll!"})}),at.jsx("div",{className:"w-full h-64 sm:h-80 md:h-96 bg-gray-800 rounded-xl overflow-hidden border border-gray-700 shadow-inner",children:at.jsx("canvas",{ref:r,className:"w-full h-full"})}),at.jsx("button",{onClick:F,disabled:l,className:"mt-6 px-8 py-4 bg-gradient-to-br from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed rounded-xl transition-all text-white font-bold text-lg shadow-lg transform hover:scale-105 disabled:transform-none",children:l?"Rolling...":"Roll Dice"}),null!==a&&at.jsxs("div",{className:"mt-6 p-4 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-xl border border-yellow-400/30 w-full text-center",children:[at.jsxs("div",{className:"text-3xl font-bold text-yellow-400 mb-2 animate-bounce",children:["🎯 Result: ",a]}),at.jsx("div",{className:"text-yellow-200",children:"Your fate is sealed!"})]}),at.jsx("button",{onClick:()=>t(a||void 0),className:"w-full mt-4 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-xl font-bold transition-all",children:"Close"})]})}):null},zM=({user:e,onSignOut:t})=>{const i=hn(),s=on(),[r,a]=n.useState(!1),[o,l]=n.useState(!1),c=[{id:"dashboard",label:"Dashboard",path:"/dashboard",icon:at.jsx(ue,{className:"w-5 h-5"}),description:"Main hub and overview"},{id:"campaigns",label:"Campaigns",path:"/campaigns",icon:at.jsx(be,{className:"w-5 h-5"}),description:"Manage your adventures"},{id:"characters",label:"Characters",path:"/characters",icon:at.jsx(we,{className:"w-5 h-5"}),description:"Your heroes and companions"},{id:"party",label:"Party",path:"/party",icon:at.jsx(ie,{className:"w-5 h-5"}),description:"Team up with friends"},{id:"world",label:"World",path:"/world",icon:at.jsx(ve,{className:"w-5 h-5"}),description:"Explore the realm"},{id:"combat",label:"Combat",path:"/combat",icon:at.jsx(le,{className:"w-5 h-5"}),description:"Battle system & tactics"},{id:"magic",label:"Magic",path:"/magic",icon:at.jsx(xe,{className:"w-5 h-5"}),description:"Spells & abilities"},{id:"dm-center",label:"DM Center",path:"/dm-center",icon:at.jsx(Te,{className:"w-5 h-5"}),description:"Dungeon Master tools",isNew:!0},{id:"achievements",label:"Achievements",path:"/achievements",icon:at.jsx(re,{className:"w-5 h-5"}),description:"Track your progress"},{id:"profile",label:"Profile",path:"/profile",icon:at.jsx(we,{className:"w-5 h-5"}),description:"Your account settings"},{id:"settings",label:"Settings",path:"/settings",icon:at.jsx(Pe,{className:"w-5 h-5"}),description:"App preferences"},{id:"help",label:"Help",path:"/help",icon:at.jsx(Le,{className:"w-5 h-5"}),description:"Support & documentation"}],h=e=>{i(e),a(!1)},u=async()=>{try{await Jn.signOut(),t()}catch(e){}},d=e=>s.pathname===e||s.pathname.startsWith(e+"/");return at.jsxs(at.Fragment,{children:[at.jsxs("nav",{className:"hidden md:flex flex-col bg-slate-800/90 backdrop-blur-sm border-r border-slate-700/50 h-screen sticky top-0 transition-all duration-300 "+(o?"w-16":"w-64"),children:[at.jsx("div",{className:"p-4 border-b border-slate-700/50 "+(o?"px-2":"px-6"),children:at.jsxs("div",{className:"flex items-center justify-between",children:[!o&&at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:at.jsx(fe,{className:"w-5 h-5 text-white"})}),at.jsxs("div",{children:[at.jsx("h1",{className:"text-lg font-bold text-white",children:"MythSeeker"}),at.jsx("p",{className:"text-xs text-slate-400",children:"RPG Adventure"})]})]}),o&&at.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mx-auto",children:at.jsx(fe,{className:"w-5 h-5 text-white"})}),at.jsx("button",{onClick:()=>l(!o),className:"p-1 text-slate-400 hover:text-white transition-colors",children:o?at.jsx(Re,{className:"w-4 h-4"}):at.jsx(je,{className:"w-4 h-4"})})]})}),at.jsx("div",{className:"p-4 border-b border-slate-700/50 "+(o?"px-2":""),children:at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0",children:(null==e?void 0:e.photoURL)?at.jsx("img",{src:e.photoURL,alt:e.displayName,className:"w-8 h-8 rounded-full"}):at.jsx(we,{className:"w-4 h-4 text-white"})}),!o&&at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsx("p",{className:"text-sm font-medium text-white truncate",children:(null==e?void 0:e.displayName)||"Adventurer"}),at.jsx("p",{className:"text-xs text-slate-400 truncate",children:null==e?void 0:e.email})]})]})}),at.jsx("div",{className:"flex-1 overflow-y-auto py-4",children:at.jsx("div",{className:"space-y-1 "+(o?"px-2":"px-4"),children:c.map(e=>at.jsxs("button",{onClick:()=>h(e.path),className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left transition-all duration-200 group relative "+(d(e.path)?"bg-blue-600/20 text-blue-400 border border-blue-500/30":"text-slate-300 hover:bg-slate-700/50 hover:text-white"),title:o?e.label:void 0,children:[at.jsx("div",{className:"flex-shrink-0 "+(d(e.path)?"text-blue-400":"text-slate-400 group-hover:text-white"),children:e.icon}),!o&&at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("span",{className:"text-sm font-medium truncate",children:e.label}),e.isNew&&at.jsx("span",{className:"px-1.5 py-0.5 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs font-medium",children:"NEW"}),e.badge&&at.jsx("span",{className:"px-1.5 py-0.5 bg-slate-600 rounded-full text-xs",children:e.badge})]}),at.jsx("p",{className:"text-xs text-slate-500 group-hover:text-slate-300 truncate",children:e.description})]}),o&&at.jsx("div",{className:"absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50",children:e.label})]},e.id))})}),at.jsx("div",{className:"p-4 border-t border-slate-700/50 "+(o?"px-2":""),children:at.jsxs("button",{onClick:u,className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-700/50 hover:text-white transition-all duration-200 "+(o?"justify-center":""),title:o?"Sign Out":void 0,children:[at.jsx(De,{className:"w-5 h-5"}),!o&&at.jsx("span",{className:"text-sm font-medium",children:"Sign Out"})]})})]}),at.jsxs("div",{className:"md:hidden",children:[at.jsx("div",{className:"bg-slate-800/90 backdrop-blur-sm border-b border-slate-700/50 p-4",children:at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:at.jsx(fe,{className:"w-5 h-5 text-white"})}),at.jsx("span",{className:"text-lg font-bold text-white",children:"MythSeeker"})]}),at.jsx("button",{onClick:()=>a(!r),className:"p-2 text-slate-400 hover:text-white",children:r?at.jsx(pe,{className:"w-6 h-6"}):at.jsx(ke,{className:"w-6 h-6"})})]})}),r&&at.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 backdrop-blur-sm",children:at.jsxs("div",{className:"absolute top-0 left-0 right-0 bg-slate-800/95 border-b border-slate-700/50 max-h-96 overflow-y-auto",children:[at.jsx("div",{className:"p-4 border-b border-slate-700/50",children:at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center",children:(null==e?void 0:e.photoURL)?at.jsx("img",{src:e.photoURL,alt:e.displayName,className:"w-10 h-10 rounded-full"}):at.jsx(we,{className:"w-5 h-5 text-white"})}),at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsx("p",{className:"text-sm font-medium text-white truncate",children:(null==e?void 0:e.displayName)||"Adventurer"}),at.jsx("p",{className:"text-xs text-slate-400 truncate",children:null==e?void 0:e.email})]})]})}),at.jsx("div",{className:"p-4 space-y-1",children:c.map(e=>at.jsxs("button",{onClick:()=>h(e.path),className:"w-full flex items-center space-x-3 px-3 py-3 rounded-lg text-left transition-all duration-200 "+(d(e.path)?"bg-blue-600/20 text-blue-400 border border-blue-500/30":"text-slate-300 hover:bg-slate-700/50 hover:text-white"),children:[at.jsx("div",{className:"flex-shrink-0 "+(d(e.path)?"text-blue-400":"text-slate-400"),children:e.icon}),at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("span",{className:"text-sm font-medium",children:e.label}),e.isNew&&at.jsx("span",{className:"px-1.5 py-0.5 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full text-xs font-medium",children:"NEW"})]}),at.jsx("p",{className:"text-xs text-slate-500",children:e.description})]})]},e.id))}),at.jsx("div",{className:"p-4 border-t border-slate-700/50",children:at.jsxs("button",{onClick:u,className:"w-full flex items-center space-x-3 px-3 py-3 rounded-lg text-slate-300 hover:bg-slate-700/50 hover:text-white transition-all duration-200",children:[at.jsx(De,{className:"w-5 h-5"}),at.jsx("span",{className:"text-sm font-medium",children:"Sign Out"})]})})]})}),at.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-slate-800/95 backdrop-blur-sm border-t border-slate-700/50 z-40",children:at.jsxs("div",{className:"flex justify-around p-2",children:[c.slice(0,5).map(e=>at.jsxs("button",{onClick:()=>h(e.path),className:"flex flex-col items-center space-y-1 px-3 py-2 rounded-lg transition-all duration-200 "+(d(e.path)?"text-blue-400 bg-blue-600/20":"text-slate-400 hover:text-white"),children:[at.jsx("div",{className:"w-5 h-5",children:e.icon}),at.jsx("span",{className:"text-xs font-medium",children:e.label})]},e.id)),at.jsxs("button",{onClick:()=>a(!r),className:"flex flex-col items-center space-y-1 px-3 py-2 rounded-lg text-slate-400 hover:text-white transition-all duration-200",children:[at.jsx(ke,{className:"w-5 h-5"}),at.jsx("span",{className:"text-xs font-medium",children:"More"})]})]})})]})]})},VM=({character:e,calculateStats:t,onUpdateCharacter:i})=>{var s,r,a,o;const[l,c]=n.useState(!1),[h,u]=n.useState(null),[d,p]=n.useState(""),[m,f]=n.useState(!1),g=n.useRef(null);if(!e)return at.jsx("div",{className:"h-full flex items-center justify-center text-white",children:at.jsxs("div",{className:"text-center",children:[at.jsx(Oe,{size:48,className:"mx-auto mb-4 text-blue-400"}),at.jsx("h2",{className:"text-xl font-bold mb-2",children:"No Character Selected"}),at.jsx("p",{className:"text-blue-200",children:"Create a character to view their sheet"})]})});const v=t?t(e):e.baseStats,x=()=>e.portrait?e.portrait:{Warrior:"⚔️",Rogue:"🗡️",Mage:"🔮",Cleric:"⚡",Ranger:"🏹",Bard:"🎵"}[e.class]||"👤",y=t=>{var n,i;const s=null==(n=e.equipment)?void 0:n[t];return s?(null==(i={weapon:{"Iron Sword":"⚔️","Steel Blade":"🗡️","Enchanted Sword":"✨⚔️","Dragon Slayer":"🔥⚔️","Basic Staff":"🔮","Crystal Staff":"💎🔮","War Bow":"🏹","Elven Bow":"🌿🏹"},armor:{"Leather Armor":"🛡️","Chain Mail":"⛓️🛡️","Plate Armor":"⚔️🛡️","Dragon Scale":"🐉🛡️","Mage Robes":"🔮👘","Archmage Robes":"✨🔮👘"}}[t])?void 0:i[s.name])||"📦":null},_=e=>e.toLowerCase().includes("legendary")?"text-yellow-400":e.toLowerCase().includes("rare")?"text-purple-400":e.toLowerCase().includes("uncommon")?"text-blue-400":"text-gray-400";return at.jsxs("div",{className:"h-full overflow-auto p-6 text-white",children:[at.jsxs("div",{className:"bg-white/10 rounded-xl p-6 mb-6 border border-white/20",children:[at.jsxs("div",{className:"flex items-start justify-between mb-4",children:[at.jsxs("div",{className:"flex items-center space-x-4",children:[at.jsxs("div",{className:"relative",children:[at.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center text-3xl border-4 border-white/20",children:"string"==typeof x()&&x().startsWith("data:")?at.jsx("img",{src:x(),alt:"Character Portrait",className:"w-full h-full rounded-full object-cover"}):at.jsx("span",{children:x()})}),at.jsx("button",{onClick:()=>f(!0),className:"absolute -bottom-1 -right-1 bg-blue-600 hover:bg-blue-700 rounded-full p-1 transition-colors",title:"Change portrait",children:at.jsx(Ue,{size:12})})]}),at.jsxs("div",{children:[at.jsx("div",{className:"flex items-center space-x-2 mb-1",children:l&&"name"===h?at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"text",value:d,onChange:e=>p(e.target.value),className:"bg-black/30 text-white px-2 py-1 rounded text-2xl font-bold",autoFocus:!0}),at.jsx("button",{onClick:()=>{h&&i&&(i({[h]:d}),u(null),p(""))},className:"text-green-400 hover:text-green-300",children:at.jsx(Fe,{size:16})}),at.jsx("button",{onClick:()=>u(null),className:"text-red-400 hover:text-red-300",children:at.jsx(pe,{size:16})})]}):at.jsxs("h1",{className:"text-3xl font-bold flex items-center space-x-2",children:[at.jsx("span",{children:e.name}),l&&at.jsx("button",{onClick:()=>{return t=e.name,u("name"),void p(t);var t},className:"text-blue-400 hover:text-blue-300",children:at.jsx(Be,{size:16})})]})}),at.jsxs("p",{className:"text-blue-200 text-lg",children:["Level ",e.level," ",e.class]}),at.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-blue-200",children:[at.jsxs("div",{className:"flex items-center space-x-1",children:[at.jsx(ze,{size:12}),at.jsx("span",{children:e.location||"Unknown"})]}),at.jsxs("div",{className:"flex items-center space-x-1",children:[at.jsx(se,{size:12}),at.jsxs("span",{children:[Math.floor(e.totalPlayTime/6e4),"m played"]})]}),at.jsxs("div",{className:"flex items-center space-x-1",children:[at.jsx(ie,{size:12}),at.jsxs("span",{children:[e.campaignsJoined||0," campaigns"]})]})]})]})]}),at.jsxs("div",{className:"text-right",children:[at.jsx("div",{className:"text-yellow-400 text-sm",children:"Experience"}),at.jsxs("div",{className:"text-2xl font-bold",children:[e.experience," XP"]}),at.jsxs("div",{className:"text-green-400 text-sm",children:[e.gold||0," Gold"]}),at.jsx("button",{onClick:()=>c(!l),className:"mt-2 px-3 py-1 rounded text-sm transition-colors "+(l?"bg-green-600 hover:bg-green-700":"bg-blue-600 hover:bg-blue-700"),children:l?"Save":"Edit"})]})]}),at.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[at.jsxs("div",{children:[at.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[at.jsx(Ve,{size:16,className:"text-red-400"}),at.jsx("span",{className:"text-sm",children:"Health"}),at.jsxs("span",{className:"text-sm text-red-400",children:[e.health,"/",e.maxHealth+((null==v?void 0:v.health)||0)]})]}),at.jsx("div",{className:"w-full bg-red-900 rounded-full h-2",children:at.jsx("div",{className:"bg-red-500 h-2 rounded-full transition-all duration-300",style:{width:e.health/(e.maxHealth+((null==v?void 0:v.health)||0))*100+"%"}})})]}),void 0!==e.mana&&at.jsxs("div",{children:[at.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[at.jsx(me,{size:16,className:"text-blue-400"}),at.jsx("span",{className:"text-sm",children:"Mana"}),at.jsxs("span",{className:"text-sm text-blue-400",children:[e.mana,"/",e.maxMana+((null==v?void 0:v.mana)||0)]})]}),at.jsx("div",{className:"w-full bg-blue-900 rounded-full h-2",children:at.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:e.mana/(e.maxMana+((null==v?void 0:v.mana)||0))*100+"%"}})})]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-xl p-6 mb-6 border border-white/20",children:[at.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[at.jsx(He,{size:20,className:"text-purple-400"}),at.jsx("span",{children:"Character Model"})]}),at.jsx("div",{className:"flex justify-center",children:at.jsxs("div",{className:"relative w-32 h-48 bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg border-2 border-white/20 flex flex-col items-center justify-center",children:[at.jsx("div",{className:"text-4xl mb-2",children:x()}),at.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center pointer-events-none",children:[(null==(s=e.equipment)?void 0:s.weapon)&&at.jsx("div",{className:"absolute -right-4 top-1/2 transform -translate-y-1/2 text-2xl",children:y("weapon")}),(null==(r=e.equipment)?void 0:r.armor)&&at.jsx("div",{className:"absolute top-2 text-xl",children:y("armor")})]}),at.jsx("div",{className:"absolute bottom-2 text-xs text-center text-white bg-black/50 px-2 py-1 rounded",children:e.name})]})})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[at.jsxs("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20",children:[at.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[at.jsx(ne,{size:20,className:"text-green-400"}),at.jsx("span",{children:"Core Stats"})]}),at.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("div",{className:"text-sm text-blue-200",children:"Strength"}),at.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.strength)||0}),at.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.strength)||0)-10)/2)]})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("div",{className:"text-sm text-blue-200",children:"Dexterity"}),at.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.dexterity)||0}),at.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.dexterity)||0)-10)/2)]})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("div",{className:"text-sm text-blue-200",children:"Intelligence"}),at.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.intelligence)||0}),at.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.intelligence)||0)-10)/2)]})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("div",{className:"text-sm text-blue-200",children:"Charisma"}),at.jsx("div",{className:"text-2xl font-bold",children:(null==v?void 0:v.charisma)||0}),at.jsxs("div",{className:"text-xs text-green-400",children:["+",Math.floor((((null==v?void 0:v.charisma)||0)-10)/2)]})]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20",children:[at.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[at.jsx(le,{size:20,className:"text-red-400"}),at.jsx("span",{children:"Combat Stats"})]}),at.jsxs("div",{className:"space-y-3",children:[at.jsxs("div",{className:"flex justify-between items-center",children:[at.jsx("span",{className:"text-blue-200",children:"Attack Bonus"}),at.jsxs("span",{className:"text-white font-semibold",children:["+",(null==v?void 0:v.attack)||0]})]}),at.jsxs("div",{className:"flex justify-between items-center",children:[at.jsx("span",{className:"text-blue-200",children:"Defense"}),at.jsx("span",{className:"text-white font-semibold",children:(null==v?void 0:v.defense)||0})]}),at.jsxs("div",{className:"flex justify-between items-center",children:[at.jsx("span",{className:"text-blue-200",children:"Magic Power"}),at.jsxs("span",{className:"text-white font-semibold",children:["+",(null==v?void 0:v.magic)||0]})]}),at.jsxs("div",{className:"flex justify-between items-center",children:[at.jsx("span",{className:"text-blue-200",children:"Critical Chance"}),at.jsxs("span",{className:"text-white font-semibold",children:[(null==v?void 0:v.crit)||0,"%"]})]})]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-xl p-6 mb-6 border border-white/20",children:[at.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[at.jsx(We,{size:20,className:"text-yellow-400"}),at.jsx("span",{children:"Equipment"})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(null==(a=e.equipment)?void 0:a.weapon)&&at.jsx("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"text-2xl",children:y("weapon")}),at.jsxs("div",{className:"flex-1",children:[at.jsx("div",{className:`font-semibold ${_(e.equipment.weapon.name)}`,children:e.equipment.weapon.name}),at.jsx("div",{className:"text-sm text-blue-200",children:"Weapon"}),e.equipment.weapon.stats&&at.jsxs("div",{className:"text-xs text-green-400 mt-1",children:["+",e.equipment.weapon.stats.attack||0," Attack"]})]})]})}),(null==(o=e.equipment)?void 0:o.armor)&&at.jsx("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"text-2xl",children:y("armor")}),at.jsxs("div",{className:"flex-1",children:[at.jsx("div",{className:`font-semibold ${_(e.equipment.armor.name)}`,children:e.equipment.armor.name}),at.jsx("div",{className:"text-sm text-blue-200",children:"Armor"}),e.equipment.armor.stats&&at.jsxs("div",{className:"text-xs text-green-400 mt-1",children:["+",e.equipment.armor.stats.defense||0," Defense"]})]})]})})]})]}),e.unlockedSkills&&e.unlockedSkills.length>0&&at.jsxs("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20",children:[at.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center space-x-2",children:[at.jsx(ee,{size:20,className:"text-purple-400"}),at.jsx("span",{children:"Unlocked Skills"})]}),at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.unlockedSkills.map(e=>at.jsxs("div",{className:"bg-black/20 rounded-lg p-4 border border-white/10",children:[at.jsxs("div",{className:"text-sm text-purple-400 mb-1",children:["Level ",e," Skill"]}),at.jsx("div",{className:"text-lg font-semibold",children:"Skill Name"}),at.jsx("div",{className:"text-sm text-blue-200",children:"Skill description would go here"})]},e))})]}),m&&at.jsx("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:at.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20 max-w-md w-full mx-4",children:[at.jsx("h3",{className:"text-xl font-bold mb-4",children:"Upload Character Portrait"}),at.jsx("p",{className:"text-blue-200 mb-4",children:"Choose an image to represent your character"}),at.jsx("input",{ref:g,type:"file",accept:"image/*",onChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];if(n&&i){const e=new FileReader;e.onload=e=>{var t;i({portrait:null==(t=e.target)?void 0:t.result})},e.readAsDataURL(n),f(!1)}},className:"hidden"}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsxs("button",{onClick:()=>{var e;return null==(e=g.current)?void 0:e.click()},className:"flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors flex items-center justify-center space-x-2",children:[at.jsx(Ge,{size:16}),at.jsx("span",{children:"Choose File"})]}),at.jsx("button",{onClick:()=>f(!1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors",children:"Cancel"})]})]})})]})},HM=({user:e,onClose:t,onCampaignCreated:i})=>{hn();const[s,r]=n.useState("simple"),[a,o]=n.useState(null),[l,c]=n.useState(""),[h,u]=n.useState(!0),[d,p]=n.useState(6),[m,f]=n.useState({dmStyle:"balanced",descriptionStyle:"immersive",difficulty:"medium",combatIntensity:"moderate",puzzleComplexity:"medium",roleplayDepth:"deep"}),[g,v]=n.useState({xpGain:"standard",lootRarity:"balanced",deathPenalty:"moderate",savePoints:"frequent",fastTravel:!0,crafting:!1}),[x,y]=n.useState({weatherSystem:!0,dayNightCycle:!0,npcSchedules:!0,dynamicEvents:!0,worldPersistence:!0}),_=()=>{o(null),c(""),u(!0),p(6),r("simple"),f({dmStyle:"balanced",descriptionStyle:"immersive",difficulty:"medium",combatIntensity:"moderate",puzzleComplexity:"medium",roleplayDepth:"deep"}),v({xpGain:"standard",lootRarity:"balanced",deathPenalty:"moderate",savePoints:"frequent",fastTravel:!0,crafting:!1}),y({weatherSystem:!0,dayNightCycle:!0,npcSchedules:!0,dynamicEvents:!0,worldPersistence:!0})};return at.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4",children:at.jsxs("div",{className:"bg-slate-800 rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto",children:[at.jsx("div",{className:"p-6 border-b border-slate-700/50",children:at.jsxs("div",{className:"flex justify-between items-center",children:[at.jsx("h2",{className:"text-2xl font-bold text-white",children:"Create New Campaign"}),at.jsx("button",{onClick:()=>{_(),t()},className:"text-slate-400 hover:text-white",children:"✕"})]})}),at.jsxs("div",{className:"p-6 space-y-6",children:[at.jsxs("div",{className:"flex space-x-4",children:[at.jsx("button",{onClick:()=>r("simple"),className:"px-4 py-2 rounded-lg font-medium transition-colors "+("simple"===s?"bg-green-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"),children:"🚀 Quick Start"}),at.jsx("button",{onClick:()=>r("advanced"),className:"px-4 py-2 rounded-lg font-medium transition-colors "+("advanced"===s?"bg-purple-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"),children:"⚙️ Advanced Setup"})]}),at.jsxs("div",{children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Choose Your Adventure"}),at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[{id:"fantasy-epic",name:"The Lost Crown of Eldoria",category:"Fantasy",icon:"👑",difficulty:"Medium",duration:"20-30 hours",description:"A classic fantasy epic where players must recover the stolen crown and restore peace to the kingdom.",setting:"Medieval fantasy kingdom with magic and dragons",themes:["Quest","Politics","Magic","Combat"],features:["Multiple endings","Faction system","Magic schools","Dragon encounters"],aiPrompt:"You are a wise and experienced Dungeon Master running a classic fantasy epic. The world is rich with magic, political intrigue, and ancient secrets. Focus on immersive storytelling, meaningful choices, and epic battles.",recommendedLevel:"1-10"},{id:"sci-fi-exploration",name:"Stellar Drift: The Void Between",category:"Sci-Fi",icon:"🚀",difficulty:"Hard",duration:"25-35 hours",description:"Explore the vast reaches of space, discover alien civilizations, and uncover the mystery of the cosmic void.",setting:"Far-future space exploration with advanced technology",themes:["Exploration","Diplomacy","Technology","Mystery"],features:["Space combat","Alien races","Tech upgrades","Multiple planets"],aiPrompt:"You are a master of science fiction storytelling, creating a vast universe filled with wonder and danger. Focus on exploration, technological advancement, and the unknown.",recommendedLevel:"1-15"},{id:"mystery-detective",name:"Shadows of the Old City",category:"Mystery",icon:"🔍",difficulty:"Medium",duration:"15-25 hours",description:"Solve a series of connected murders in a noir-style city filled with corruption and secrets.",setting:"Gritty urban environment with supernatural elements",themes:["Investigation","Corruption","Supernatural","Social"],features:["Clue system","Multiple suspects","Moral choices","Hidden areas"],aiPrompt:"You are a master of mystery and intrigue, creating complex plots with multiple layers. Focus on investigation, character development, and moral ambiguity.",recommendedLevel:"1-8"},{id:"horror-survival",name:"The Haunting of Blackwood Manor",category:"Horror",icon:"👻",difficulty:"Hard",duration:"10-20 hours",description:"Survive a night in a haunted mansion while uncovering the dark history of the Blackwood family.",setting:"Gothic mansion with supernatural horrors",themes:["Survival","Horror","Investigation","Psychological"],features:["Sanity system","Limited resources","Multiple endings","Hidden lore"],aiPrompt:"You are a master of horror and suspense, creating an atmosphere of dread and tension. Focus on psychological horror, resource management, and survival.",recommendedLevel:"1-6"},{id:"post-apocalyptic",name:"Wasteland Wanderers",category:"Post-Apocalyptic",icon:"🌆",difficulty:"Medium",duration:"20-30 hours",description:"Navigate a dangerous post-apocalyptic world, build settlements, and fight for survival.",setting:"Post-nuclear wasteland with scattered communities",themes:["Survival","Community","Exploration","Conflict"],features:["Base building","Faction wars","Scavenging","Radiation system"],aiPrompt:"You are a master of post-apocalyptic storytelling, creating a harsh but hopeful world. Focus on survival, community building, and moral choices.",recommendedLevel:"1-12"},{id:"steampunk-adventure",name:"Clockwork Revolution",category:"Steampunk",icon:"⚙️",difficulty:"Medium",duration:"18-28 hours",description:"Join a revolution against the oppressive clockwork empire in a world of steam and brass.",setting:"Victorian-era city with advanced steam technology",themes:["Revolution","Technology","Social","Adventure"],features:["Steam-powered gadgets","Underground resistance","Social classes","Political intrigue"],aiPrompt:"You are a master of steampunk aesthetics and revolutionary storytelling. Focus on social justice, technological wonder, and political intrigue.",recommendedLevel:"1-10"},{id:"western-frontier",name:"The Lawless Frontier",category:"Western",icon:"🤠",difficulty:"Easy",duration:"12-20 hours",description:"Become a legendary gunslinger in the untamed American frontier.",setting:"Wild West with supernatural elements",themes:["Justice","Freedom","Adventure","Supernatural"],features:["Gunfights","Horse riding","Ghost towns","Native spirits"],aiPrompt:"You are a master of Western storytelling, creating a world of freedom, danger, and adventure. Focus on justice, personal freedom, and the frontier spirit.",recommendedLevel:"1-8"},{id:"cyberpunk-heist",name:"Neon Dreams",category:"Cyberpunk",icon:"🌃",difficulty:"Hard",duration:"15-25 hours",description:"Pull off the ultimate heist in a neon-lit cyberpunk city controlled by megacorporations.",setting:"Futuristic city with cybernetic enhancements",themes:["Heist","Corruption","Technology","Identity"],features:["Cybernetics","Hacking","Corporate espionage","Multiple approaches"],aiPrompt:"You are a master of cyberpunk aesthetics and heist storytelling. Focus on corporate corruption, technological advancement, and high-stakes action.",recommendedLevel:"1-10"}].map(e=>at.jsxs("div",{onClick:()=>o(e),className:"p-4 rounded-lg border-2 cursor-pointer transition-all "+((null==a?void 0:a.id)===e.id?"border-blue-500 bg-blue-900/20":"border-slate-600 bg-slate-700/30 hover:border-slate-500 hover:bg-slate-700/50"),children:[at.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[at.jsx("span",{className:"text-2xl",children:e.icon}),at.jsxs("div",{children:[at.jsx("h4",{className:"text-white font-medium",children:e.name}),at.jsx("p",{className:"text-slate-400 text-sm",children:e.category})]})]}),at.jsx("p",{className:"text-slate-300 text-sm mb-3",children:e.description}),at.jsxs("div",{className:"flex justify-between text-xs text-slate-400",children:[at.jsxs("span",{children:["Difficulty: ",e.difficulty]}),at.jsx("span",{children:e.duration})]})]},e.id))})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Campaign Type"}),at.jsxs("div",{className:"space-y-2",children:[at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"radio",checked:h,onChange:()=>u(!0),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"Multiplayer Campaign"})]}),at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"radio",checked:!h,onChange:()=>u(!1),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"Solo Adventure"})]})]})]}),h&&at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Max Players"}),at.jsxs("select",{value:d,onChange:e=>p(Number(e.target.value)),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:2,children:"2 Players"}),at.jsx("option",{value:3,children:"3 Players"}),at.jsx("option",{value:4,children:"4 Players"}),at.jsx("option",{value:5,children:"5 Players"}),at.jsx("option",{value:6,children:"6 Players"})]})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Custom Instructions (Optional)"}),at.jsx("textarea",{value:l,onChange:e=>c(e.target.value),placeholder:"Add any specific instructions or modifications to your adventure...",rows:3,className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400"})]}),"advanced"===s&&at.jsxs("div",{className:"space-y-6",children:[at.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[at.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"🤖 AI Dungeon Master Settings"}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"DM Style"}),at.jsxs("select",{value:m.dmStyle,onChange:e=>f(t=>({...t,dmStyle:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"balanced",children:"Balanced"}),at.jsx("option",{value:"narrative",children:"Narrative-Focused"}),at.jsx("option",{value:"combat",children:"Combat-Heavy"}),at.jsx("option",{value:"puzzle",children:"Puzzle-Master"}),at.jsx("option",{value:"roleplay",children:"Roleplay-Intensive"})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Description Style"}),at.jsxs("select",{value:m.descriptionStyle,onChange:e=>f(t=>({...t,descriptionStyle:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"immersive",children:"Immersive & Detailed"}),at.jsx("option",{value:"concise",children:"Concise & Fast"}),at.jsx("option",{value:"atmospheric",children:"Atmospheric & Moody"}),at.jsx("option",{value:"cinematic",children:"Cinematic & Dynamic"})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Difficulty"}),at.jsxs("select",{value:m.difficulty,onChange:e=>f(t=>({...t,difficulty:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"easy",children:"Easy"}),at.jsx("option",{value:"medium",children:"Medium"}),at.jsx("option",{value:"hard",children:"Hard"}),at.jsx("option",{value:"brutal",children:"Brutal"})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Combat Intensity"}),at.jsxs("select",{value:m.combatIntensity,onChange:e=>f(t=>({...t,combatIntensity:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"light",children:"Light"}),at.jsx("option",{value:"moderate",children:"Moderate"}),at.jsx("option",{value:"intense",children:"Intense"}),at.jsx("option",{value:"deadly",children:"Deadly"})]})]})]})]}),at.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[at.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"🎮 Gameplay Rules"}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"XP Gain"}),at.jsxs("select",{value:g.xpGain,onChange:e=>v(t=>({...t,xpGain:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"slow",children:"Slow & Steady"}),at.jsx("option",{value:"standard",children:"Standard"}),at.jsx("option",{value:"fast",children:"Fast Progression"}),at.jsx("option",{value:"epic",children:"Epic Advancement"})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Loot Rarity"}),at.jsxs("select",{value:g.lootRarity,onChange:e=>v(t=>({...t,lootRarity:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"scarce",children:"Scarce"}),at.jsx("option",{value:"balanced",children:"Balanced"}),at.jsx("option",{value:"generous",children:"Generous"}),at.jsx("option",{value:"legendary",children:"Legendary"})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Death Penalty"}),at.jsxs("select",{value:g.deathPenalty,onChange:e=>v(t=>({...t,deathPenalty:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"none",children:"No Penalty"}),at.jsx("option",{value:"light",children:"Light"}),at.jsx("option",{value:"moderate",children:"Moderate"}),at.jsx("option",{value:"severe",children:"Severe"})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Save Points"}),at.jsxs("select",{value:g.savePoints,onChange:e=>v(t=>({...t,savePoints:e.target.value})),className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400",children:[at.jsx("option",{value:"frequent",children:"Frequent"}),at.jsx("option",{value:"moderate",children:"Moderate"}),at.jsx("option",{value:"rare",children:"Rare"}),at.jsx("option",{value:"checkpoint",children:"Checkpoint Only"})]})]})]})]}),at.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4",children:[at.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"🌍 World Environment"}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"checkbox",checked:x.weatherSystem,onChange:e=>y(t=>({...t,weatherSystem:e.target.checked})),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"Dynamic Weather System"})]}),at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"checkbox",checked:x.dayNightCycle,onChange:e=>y(t=>({...t,dayNightCycle:e.target.checked})),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"Day/Night Cycle"})]}),at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"checkbox",checked:x.npcSchedules,onChange:e=>y(t=>({...t,npcSchedules:e.target.checked})),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"NPC Schedules"})]}),at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"checkbox",checked:x.dynamicEvents,onChange:e=>y(t=>({...t,dynamicEvents:e.target.checked})),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"Dynamic Events"})]}),at.jsxs("label",{className:"flex items-center space-x-2",children:[at.jsx("input",{type:"checkbox",checked:x.worldPersistence,onChange:e=>y(t=>({...t,worldPersistence:e.target.checked})),className:"text-blue-600"}),at.jsx("span",{className:"text-white",children:"World Persistence"})]})]})]})]}),at.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t border-slate-700/50",children:[at.jsx("button",{onClick:()=>{_(),t()},className:"px-6 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Cancel"}),at.jsx("button",{onClick:async()=>{try{const e={theme:(null==a?void 0:a.name)||"Custom Adventure",background:(null==a?void 0:a.id)||"custom",customPrompt:l||(null==a?void 0:a.aiPrompt)||"",maxPlayers:h?d:1,players:[],aiSettings:m,gameplaySettings:g,environmentSettings:x,adventureType:(null==a?void 0:a.id)||"custom"},{gameId:n,code:s}=await Jn.createGameSession(e);i(n,s),t()}catch(e){alert("Failed to create campaign. Please try again.")}},disabled:!a,className:"px-6 py-2 bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white rounded-lg transition-colors",children:"Create Campaign"})]})]})]})})};n.lazy(()=>ht(()=>import("./NavBar-b4fead00.js"),["assets/NavBar-b4fead00.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),n.lazy(()=>ht(()=>import("./TopBar-3bc5dd3b.js"),["assets/TopBar-3bc5dd3b.js","assets/ui-vendor-1b8d788c.js","assets/react-vendor-132e4a4f.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"]));const WM=n.lazy(()=>ht(()=>import("./WelcomeOverlay-f0bfafd1.js"),["assets/WelcomeOverlay-f0bfafd1.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),GM=n.lazy(()=>ht(()=>import("./CombatSystem-65babd1c.js"),["assets/CombatSystem-65babd1c.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),qM=n.lazy(()=>ht(()=>import("./RightDrawer-1293dcf9.js"),["assets/RightDrawer-1293dcf9.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),XM=n.lazy(()=>ht(()=>import("./FloatingActionButton-8fa41d97.js"),["assets/FloatingActionButton-8fa41d97.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),YM=n.lazy(()=>ht(()=>import("./SimpleHelp-50f9577b.js"),["assets/SimpleHelp-50f9577b.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),$M=n.lazy(()=>ht(()=>import("./HelpSystem-a5b8defe.js"),["assets/HelpSystem-a5b8defe.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),ZM=n.lazy(()=>ht(()=>import("./DMCenter-8e9027dd.js"),["assets/DMCenter-8e9027dd.js","assets/react-vendor-132e4a4f.js","assets/ui-vendor-1b8d788c.js","assets/firebase-auth-07649063.js","assets/firebase-core-a7cb50f5.js","assets/firebase-firestore-e3da4556.js","assets/firebase-database-b022e4c6.js","assets/firebase-functions-7c25f05b.js"])),KM=()=>at.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-950 via-indigo-950 to-purple-950 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsxs("div",{className:"relative",children:[at.jsx("div",{className:"w-16 h-16 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("div",{className:"w-12 h-12 border-4 border-purple-300/30 border-t-purple-400 rounded-full animate-spin absolute top-2 left-1/2 transform -translate-x-1/2 -rotate-45",style:{animationDuration:"1.5s"}})]}),at.jsxs("div",{className:"space-y-2",children:[at.jsx("h3",{className:"text-white font-semibold text-lg",children:"Loading MythSeeker"}),at.jsx("p",{className:"text-blue-200 text-sm",children:"Preparing your adventure..."})]}),at.jsxs("div",{className:"flex justify-center space-x-1",children:[at.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full animate-bounce"}),at.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),at.jsx("div",{className:"w-2 h-2 bg-indigo-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})]})}),JM=({initialScreen:e="welcome"})=>{const t=a.useMemo(()=>new Vo,[]);n.useState(null);const[i,s]=n.useState([]),[r,o]=n.useState(!1),[l,c]=n.useState(!1),[h,u]=n.useState("welcome"),[d,p]=n.useState(null),[m,f]=n.useState([]),[g,v]=n.useState(!0),[x,y]=n.useState(!1);n.useState(!1),n.useState("dashboard"),n.useState("gameplay");const[_,b]=n.useState(!1);n.useState(!1);const[w,S]=n.useState(!1),[M,T]=n.useState(e),[E,C]=n.useState(""),[A,N]=n.useState(null),[R,P]=n.useState(null),[I,j]=n.useState([]),[D,k]=n.useState([]),[L,O]=n.useState(""),[U,F]=n.useState(!1),[B,z]=n.useState("default");n.useState({});const[V,H]=n.useState(null),[W,G]=n.useState("");n.useState(null),n.useState(null);const[q,X]=n.useState(null);n.useState([]),n.useState(null),n.useState(null),n.useState(null),n.useState(null),n.useState({});const[Y,$]=n.useState({locations:{},npcs:{},factions:{},events:[],weather:"clear",timeOfDay:"day",currentLocation:null,playerReputation:{},discoveredSecrets:[],activeQuests:[],completedQuests:[],worldEvents:[]});n.useState({ruleSystem:"dnd5e",contentLibrary:{encounters:[],npcs:[],locations:[],plotHooks:[],customRules:[]},campaignTemplates:[],dmTools:{initiativeTracker:[],sessionNotes:"",playerAnalytics:{}}}),n.useState(!1),n.useState([]);const[Z,K]=n.useState([]);n.useState(!1);const J=n.useRef(null),Q=n.useRef(null),[ee,te]=n.useState(!1),[ie,se]=n.useState({players:[],isHost:!1,lastSync:null}),[re,ae]=n.useState("chat");n.useState(0);const[oe,le]=n.useState({playerActions:[],npcInteractions:{},combatHistory:[],explorationHistory:[],playerPreferences:{},storyThreads:[],consequences:[]}),[ce,he]=n.useState(400),ue=()=>!JSON.parse(localStorage.getItem("mythseeker_skipped_intros")||"[]").includes("welcomeOverlay"),de=(e,t)=>{if(["characterCreated","campaignCreated","campaignJoined","levelUp","achievementUnlocked","firstMessage","combatStarted","questCompleted","itemFound","npcInteraction","explorationMilestone"].includes(e)&&!["error","info","warning","success","goodbye","characterLoaded","campaignDeleted","ftueSkipped"].includes(e)){if(JSON.parse(localStorage.getItem("mythseeker_skipped_intros")||"[]").includes(e))return;const n=((e,t)=>{const n=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i={characterCreated:{message:"Character created successfully!",type:"success"},campaignCreated:{message:"Campaign created successfully!",type:"success"},campaignPaused:{message:"Campaign paused",type:"info"},campaignResumed:{message:"Campaign resumed",type:"success"},welcomeBack:{message:"Welcome back to your adventure!",type:"success"},ftueSkipped:{message:"Tutorial skipped",type:"info"},npcInteraction:{message:(null==t?void 0:t.npcName)?`${t.npcName} is ${t.disposition} (${t.emotionalSummary})`:"NPC interaction recorded",type:"info"}}[e]||{message:"Action completed",type:"success"};return{id:n,message:i.message,type:i.type}})(e,t);["characterCreated","campaignCreated","firstMessage","combatStarted"].includes(e)&&(n.showIntroControls=!0,n.onSkipIntro=()=>{},n.onDontShowAgain=()=>{const t=JSON.parse(localStorage.getItem("mythseeker_skipped_intros")||"[]");t.includes(e)||(t.push(e),localStorage.setItem("mythseeker_skipped_intros",JSON.stringify(t)))}),s(e=>[...e,n]),setTimeout(()=>pe(n.id),5e3)}},pe=e=>{s(t=>t.filter(t=>t.id!==e))};n.useEffect(()=>{V||H(Date.now().toString(36)+Math.random().toString(36).substr(2))},[V]),n.useEffect(()=>{zo.trackSessionStart(),zo.trackDeviceInfo(),zo.trackPageView("welcome","MythSeeker - Welcome");const e=performance.now(),t=()=>{const t=performance.now()-e;zo.trackPerformance("app_load_time",t)};"complete"===document.readyState?t():window.addEventListener("load",t);const n=()=>{const t=Date.now()-e;zo.trackSessionEnd(t)};window.addEventListener("beforeunload",n);const i=Jn.onAuthStateChange(async e=>{var t;if(e)try{await new Promise(e=>setTimeout(e,500)),zo.trackUserAction("user_authenticated",{user_id:e.uid,display_name:e.displayName}),zo.setUserId(e.uid),zo.setUserProperties({user_type:e.displayName?"authenticated":"anonymous",account_created:(null==(t=e.metadata)?void 0:t.creationTime)||"unknown"});let i=0,s=null;for(;i<3&&!s;)try{s=await Jn.getUserProfile(e.uid);break}catch(n){i++,i<3&&await new Promise(e=>setTimeout(e,1e3*i))}if(s){p(s),C(s.displayName),y(!0);let t=[];for(i=0;i<3;)try{t=await Jn.getUserCharacters(e.uid);break}catch(n){i++,i<3&&await new Promise(e=>setTimeout(e,1e3*i))}f(t),zo.trackUserAction("profile_loaded",{characters_count:t.length,has_characters:t.length>0}),"/"===location.pathname&&(t.length>0?(T("dashboard"),fe("/dashboard"),zo.trackPageView("dashboard","MythSeeker - Dashboard"),ue()&&o(!0)):(T("welcome"),fe("/"),zo.trackPageView("welcome","MythSeeker - Welcome")))}else T("welcome"),zo.trackPageView("welcome","MythSeeker - Welcome")}catch(i){const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");e.length>0?(f(e),T("character-select"),zo.trackPageView("character-select","MythSeeker - Character Selection")):(T("welcome"),zo.trackPageView("welcome","MythSeeker - Welcome")),p(null),y(!1)}else{zo.trackUserAction("user_signed_out");const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");e.length>0?(f(e),T("character-select"),zo.trackPageView("character-select","MythSeeker - Character Selection")):(T("welcome"),zo.trackPageView("welcome","MythSeeker - Welcome")),p(null),y(!1)}v(!1)});return()=>{window.removeEventListener("load",t),window.removeEventListener("beforeunload",n),i()}},[]),n.useEffect(()=>{(async()=>{try{await Jn.handleRedirectSignIn()}catch(e){de("error",{message:"Failed to sign in. Please try again."})}})()},[]),n.useEffect(()=>{"undefined"==typeof window||window.claude||(window.claude={complete:e=>ii.complete(e)})},[]);const me=async()=>{try{v(!0),await Jn.signInWithGoogle()}catch(e){const t=e;"auth/popup-blocked"===t.code?de("error",{message:"Popup was blocked. Trying alternative sign-in method..."}):"auth/popup-closed-by-user"===t.code?(de("info",{message:"Sign-in was cancelled."}),v(!1)):("auth/cancelled-popup-request"===t.code||de("error",{message:"Failed to sign in. Please try again."}),v(!1))}};n.useEffect(()=>{const e=()=>{S(window.innerWidth<1024)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{if(null==R?void 0:R.id){const e=Ra.subscribeToCampaign(R.id,e=>{P(e),k(e.messages||[]),se({players:e.players||[],isHost:Ra.isHost(e),lastSync:new Date}),te(!0)}),t=Ra.startHeartbeat(R.id);return()=>{e(),t()}}},[null==R?void 0:R.id]),n.useEffect(()=>{var e;null==(e=J.current)||e.scrollIntoView({behavior:"smooth"})},[D]),n.useEffect(()=>{!U&&Q.current&&Q.current.focus()},[U]);const fe=hn(),ge=async e=>{if(null==e?void 0:e.id)try{const n=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]"),i=n.findIndex(t=>t.id===e.id);if(i>=0?n[i]=e:n.push(e),localStorage.setItem("mythseeker_campaigns",JSON.stringify(n)),j(t=>t.map(t=>t.id===e.id?e:t)),e.isMultiplayer&&x&&d)try{await Ra.updateCampaignState(e.id,{messages:e.messages||[],systemMessages:e.systemMessages||[],started:e.started,worldState:e.worldState,currentEnvironment:e.currentEnvironment,combatState:e.combatState,lastActivity:new Date})}catch(t){}}catch(n){try{const t=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]"),n=t.findIndex(t=>t.id===e.id);n>=0?t[n]=e:t.push(e),localStorage.setItem("mythseeker_campaigns",JSON.stringify(t))}catch(i){}}},ye=async()=>{try{const t=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]"),n=t.map(e=>({...e,status:e.status||(e.started?"active":void 0)}));if(j(n),x&&d)try{const e=await Ra.getUserCampaigns(),n=t.map(t=>e.find(e=>e.id===t.id)||t);e.forEach(e=>{n.find(t=>t.id===e.id)||n.push(e)}),j(n),localStorage.setItem("mythseeker_campaigns",JSON.stringify(n))}catch(e){}}catch(t){j([])}};n.useEffect(()=>{if(R&&R.started){const e=setTimeout(()=>{ge(R)},3e4);return()=>clearTimeout(e)}},[R]),n.useEffect(()=>{ye()},[A,x]),n.useEffect(()=>{const e=JSON.parse(localStorage.getItem("mythseeker_campaigns")||"[]");e.length>0&&j(e)},[]),n.useEffect(()=>{if(R&&D.length>0){const e={...R,messages:D};ge(e)}},[D]);const _e=[{name:"Warrior",icon:"⚔️",stats:{strength:16,dexterity:12,intelligence:10,charisma:8},actionPoints:{move:6,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Power Strike",description:"Deal +50% damage on next attack",cost:"Action",type:"attack",range:1},3:{name:"Shield Wall",description:"Reduce all damage by 3 for 3 turns",cost:"Action",type:"defense",range:0},5:{name:"Berserker Rage",description:"Double damage but take +50% damage for 3 turns",cost:"Bonus Action",type:"buff",range:0},7:{name:"Intimidating Shout",description:"Fear nearby enemies for 2 turns",cost:"Action",type:"control",range:3,aoe:!0},10:{name:"Legendary Strike",description:"Guaranteed critical hit",cost:"Action",type:"attack",range:1}}},{name:"Rogue",icon:"🗡️",stats:{strength:10,dexterity:16,intelligence:12,charisma:8},actionPoints:{move:8,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Sneak Attack",description:"Deal double damage if target is unaware",cost:"Free",type:"attack",range:1},3:{name:"Shadow Step",description:"Teleport behind enemy and gain advantage",cost:"Movement",type:"movement",range:6},5:{name:"Poison Blade",description:"Next 3 attacks apply poison (3 damage/turn)",cost:"Bonus Action",type:"buff",range:0},7:{name:"Smoke Bomb",description:"Become invisible for 2 turns",cost:"Action",type:"stealth",range:0,aoe:!0,radius:2},10:{name:"Assassinate",description:"Instant kill if target below 25% health",cost:"Action",type:"attack",range:1}}},{name:"Mage",icon:"🔮",stats:{strength:8,dexterity:10,intelligence:16,charisma:12},actionPoints:{move:5,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Magic Missile",description:"Deal 1d4+1 force damage, never misses",cost:"1 Spell Slot",type:"attack",range:8},3:{name:"Shield Spell",description:"Gain +5 AC until start of next turn",cost:"Reaction",type:"defense",range:0},5:{name:"Fireball",description:"Deal 3d6 fire damage in large area",cost:"1 Spell Slot",type:"aoe",range:10,radius:3},7:{name:"Counterspell",description:"Cancel enemy spell or ability",cost:"Reaction",type:"control",range:8},10:{name:"Meteor Storm",description:"Devastate entire battlefield",cost:"2 Spell Slots",type:"aoe",range:15,radius:5}}},{name:"Cleric",icon:"⚡",stats:{strength:12,dexterity:8,intelligence:12,charisma:16},actionPoints:{move:5,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Healing Word",description:"Restore 1d4+CHA mod HP to ally",cost:"1 Spell Slot",type:"heal",range:8},3:{name:"Turn Undead",description:"Force undead creatures to flee",cost:"Action",type:"control",range:6,aoe:!0},5:{name:"Sacred Flame",description:"Divine damage that ignores armor",cost:"1 Spell Slot",type:"attack",range:8},7:{name:"Mass Healing",description:"Heal all allies for 2d4+CHA",cost:"2 Spell Slots",type:"heal",range:6,aoe:!0},10:{name:"Divine Intervention",description:"Call upon divine aid in dire situations",cost:"3 Spell Slots",type:"special",range:0}}},{name:"Ranger",icon:"🏹",stats:{strength:14,dexterity:14,intelligence:10,charisma:8},actionPoints:{move:7,action:1,bonus:1,reaction:1},reach:10,skills:{1:{name:"Hunter's Mark",description:"Mark target for +1d6 damage on attacks",cost:"Bonus Action",type:"buff",range:10},3:{name:"Multi-Shot",description:"Attack up to 3 enemies with ranged weapon",cost:"Action",type:"attack",range:10},5:{name:"Animal Companion",description:"Summon beast ally for entire combat",cost:"Action",type:"summon",range:3},7:{name:"Explosive Shot",description:"Ranged attack that damages nearby enemies",cost:"Action",type:"aoe",range:10,radius:2},10:{name:"Rain of Arrows",description:"Attack all enemies in large area",cost:"Action",type:"aoe",range:12,radius:4}}},{name:"Bard",icon:"🎵",stats:{strength:8,dexterity:12,intelligence:10,charisma:16},actionPoints:{move:6,action:1,bonus:1,reaction:1},reach:1,skills:{1:{name:"Inspiration",description:"Give ally advantage on next roll",cost:"Bonus Action",type:"support",range:6},3:{name:"Cutting Words",description:"Reduce enemy attack/damage by 1d6",cost:"Reaction",type:"debuff",range:6},5:{name:"Song of Rest",description:"Party heals +1d6 HP during short rest",cost:"Short Rest",type:"heal",range:0},7:{name:"Mass Suggestion",description:"Control multiple enemies for 1 turn",cost:"Action",type:"control",range:8,aoe:!0},10:{name:"Power Word Kill",description:"Instantly kill enemy below 100 HP",cost:"Action",type:"attack",range:8}}}],be=[{name:"Classic Fantasy",description:"Dragons, magic, and heroic quests in a medieval world",icon:"🏰",bg:"fantasy"},{name:"Sci-Fi Adventure",description:"Space exploration, alien encounters, and futuristic technology",icon:"🚀",bg:"scifi"},{name:"Horror Mystery",description:"Dark secrets, supernatural threats, and psychological tension",icon:"👻",bg:"horror"},{name:"Urban Fantasy",description:"Magic hidden in the modern world, supernatural creatures in cities",icon:"🌃",bg:"urban"},{name:"Post-Apocalyptic",description:"Surviving in a world after civilization has collapsed",icon:"☢️",bg:"apocalypse"},{name:"Pirate Adventure",description:"High seas, treasure hunting, and swashbuckling action",icon:"🏴‍☠️",bg:"pirate"}],Se=e=>{const t=_e.find(t=>t.name===e.class);t?((async e=>{if(!d){const t={id:Date.now().toString(),userId:"local",name:e.name,class:e.class,level:1,experience:0,health:100,maxHealth:100,mana:50,maxMana:50,gold:100,inventory:{"Healing Potion":3,"Iron Ore":2,Herb:5},equipment:{weapon:{name:"Iron Sword",type:"weapon"},armor:{name:"Leather Armor",type:"armor"}},stats:e.baseStats,skills:e.skills||{},achievements:[],createdAt:Date.now(),lastPlayed:Date.now(),totalPlayTime:0},n=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");return n.push(t),localStorage.setItem("mythseeker_characters",JSON.stringify(n)),de("characterCreated",{character:e}),f(e=>[t,...e]),N(t),void T("lobby")}const t={userId:d.uid,name:e.name,class:e.class,level:1,experience:0,health:100,maxHealth:100,mana:50,maxMana:50,gold:100,inventory:{"Healing Potion":3,"Iron Ore":2,Herb:5},equipment:{weapon:{name:"Iron Sword",type:"weapon"},armor:{name:"Leather Armor",type:"armor"}},stats:e.baseStats,skills:e.skills||{},achievements:[],createdAt:Date.now(),lastPlayed:Date.now(),totalPlayTime:0};try{const n=await Jn.saveCharacter(t),i={...t,id:n};f(e=>[i,...e]),N(i),de("characterCreated",{character:e}),T("lobby")}catch(n){const i={...t,id:Date.now().toString(),userId:d.uid},s=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");s.push(i),localStorage.setItem("mythseeker_characters",JSON.stringify(s)),f(e=>[i,...e]),N(i),de("characterCreated",{character:e}),de("warning",{message:"Character saved locally. Will sync when connection is restored."}),T("lobby")}})({...e,baseStats:t.stats,skills:t.skills,health:100,maxHealth:100,mana:50,maxMana:50,level:1,experience:0,gold:100,inventory:{"Healing Potion":3,"Iron Ore":2,Herb:5},equipment:{weapon:{name:"Iron Sword",type:"weapon"},armor:{name:"Leather Armor",type:"armor"}},unlockedSkills:[1],id:V,playerId:V}),ue()&&o(!0)):de("error",{message:"Invalid character class"})},Me=async e=>{var t;if(e&&e.id){F(!0);try{const n=be.find(t=>t.name===e.theme)||be[0],i=`Begin the adventure. The party consists of: ${(null==(t=e.players)?void 0:t.map(e=>{var t,n;return`${(null==(t=e.character)?void 0:t.name)||"Unknown"} the ${(null==(n=e.character)?void 0:n.class)||"Adventurer"}`}).join(", "))||"the party"}. Setting: ${n.description}. Present an immersive opening scene with 3 action choices.`,s=await oi.processPlayerInput({message:i,playerId:V,campaignId:e.id,character:A,timestamp:new Date}),r={id:Date.now(),type:"dm",content:s.narrative_text+(s.npc_dialogue?`\n\n${s.npc_dialogue}`:""),choices:s.choices||["Explore","Investigate","Ask questions"],timestamp:new Date,atmosphere:s.mood_adjustment||{mood:"dynamic",tension:"medium"}};s.game_state_updates&&je(s.game_state_updates),k([r]);const a={...e,started:!0,status:"active"};P(a),j(t=>t.map(t=>t.id===e.id?a:t)),T("game"),fe(`/campaigns/${e.id}`)}catch(n){de("error",{message:"Failed to start campaign. Please try again."})}F(!1)}else de("error",{message:"Campaign data is invalid"})},[Te,Ee]=n.useState(null),Ce=a.useMemo(()=>new ja(10,6e4),[]),Ae=async()=>{const e=(e=>{if(!e||0===e.trim().length)return{isValid:!1,error:"Message cannot be empty"};const t=Pa(e.trim());return t.length>500?{isValid:!1,error:"Message must be 500 characters or less"}:(e=>{const t=e.toLowerCase();return Ia.some(e=>t.includes(e))})(t)?{isValid:!1,error:"Message contains inappropriate content"}:{isValid:!0}})(L);if(!e.isValid)return void Ee(e.error||"Invalid message");const t=V||"anonymous";if(!Ce.isAllowed(t)){const e=Ce.getTimeUntilReset(t);return void Ee(`Please wait ${Math.ceil(e/1e3)} seconds before sending another message`)}if(Ee(null),U)return;if(!A)return void Ee("No character selected. Please create or select a character first.");const n=Pa(L),i={id:Date.now(),type:"player",content:n,character:A.name,playerId:V,playerName:E,timestamp:new Date},s=[...D,i];k(s),O(""),F(!0);try{const e=await oi.processPlayerInput({message:n,playerId:V,campaignId:(null==R?void 0:R.id)||"single-player",character:A,timestamp:new Date}),t={narrative:e.narrative_text,choices:e.follow_up_prompts||["Explore","Investigate","Ask questions"],atmosphere:{mood:"dynamic",tension:"medium",environmentalDetails:"The world responds to your actions"}};e.npc_dialogue&&(t.narrative+=`\n\n${e.npc_dialogue}`),e.system_actions&&e.system_actions.length>0&&e.system_actions.forEach(e=>{if("dice_roll"===e.type){const e=((e=20)=>Math.floor(Math.random()*e)+1)(20);t.narrative+=`\n\n[Roll: ${e}]`}}),t.worldStateUpdates&&je(t.worldStateUpdates),t.environment&&z(t.environment),t.characterUpdates&&t.characterUpdates.forEach(e=>{e.playerId===V&&(N(t=>{var n,i;return t?{...t,experience:t.experience+(e.xpGain||0),health:Math.max(1,Math.min(t.maxHealth,t.health+((null==(n=e.statChanges)?void 0:n.health)||0))),mana:Math.max(0,Math.min(t.maxMana,t.mana+((null==(i=e.statChanges)?void 0:i.mana)||0))),inventory:{...t.inventory,...e.newItems}}:null}),e.reputationChanges&&$(t=>({...t,playerReputation:{...t.playerReputation,...e.reputationChanges}})))});const i={id:Date.now()+1,type:"dm",content:t.narrative,choices:t.choices,timestamp:new Date,atmosphere:t.atmosphere,worldStateUpdates:t.worldStateUpdates};k(e=>[...e,i]),t.combatEncounter&&Re(t.combatEncounter.enemies)}catch(r){const e={id:Date.now()+1,type:"dm",content:"The story continues to unfold... (AI temporarily unavailable)",timestamp:new Date};k(t=>[...t,e])}F(!1)},Ne=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Ae())},Re=e=>{var n,i,s,r;if(!A)return;const a=[{id:A.id||V||"player",name:A.name,type:"player",character:A,position:{x:0,y:0},health:A.health,maxHealth:A.maxHealth,mana:A.mana,maxMana:A.maxMana,actionPoints:A.actionPoints||{move:6,action:1,bonus:1,reaction:1},currentActionPoints:{move:6,action:1,bonus:1,reaction:1},stats:{strength:(null==(n=A.baseStats)?void 0:n.strength)||10,dexterity:(null==(i=A.baseStats)?void 0:i.dexterity)||10,intelligence:(null==(s=A.baseStats)?void 0:s.intelligence)||10,charisma:(null==(r=A.baseStats)?void 0:r.charisma)||10,armorClass:10},statusEffects:[],isActive:!1,hasActed:!1,reach:1,skills:A.skills||{}},...e.map((e,t)=>({id:`enemy-${t}`,name:e.name||`Enemy ${t+1}`,type:"enemy",position:{x:0,y:0},health:e.health||25,maxHealth:e.health||25,actionPoints:{move:4,action:1,bonus:0,reaction:1},currentActionPoints:{move:4,action:1,bonus:0,reaction:1},stats:{strength:e.strength||12,dexterity:e.dexterity||10,intelligence:e.intelligence||8,charisma:e.charisma||8,armorClass:e.armorClass||12},statusEffects:[],isActive:!1,hasActed:!1,reach:1,skills:{}}))],o=t.startCombat(a);X(o),T("combat")},Pe=e=>{const n=t.executeAction(e);if(n.success&&n.newState){X(n.newState);const e=t.checkCombatEnd();e.ended&&("players"===e.winner?(alert("Victory! You have defeated your enemies!"),N(e=>e?{...e,experience:e.experience+50,health:Math.min(e.maxHealth,e.health+20)}:null)):(alert("Defeat! Your party has been defeated..."),N(e=>e?{...e,health:Math.max(1,e.health-10)}:null)),t.endCombat(),X(null),T("game"))}else alert(n.message)},Ie=()=>{t.endCombat(),X(null),T("game")},je=e=>{e&&($(t=>{const n={...t};return e.newLocation&&(n.currentLocation=e.newLocation),e.newNPCs&&e.newNPCs.forEach(e=>{const t=n.npcs[e.name];if(t){const i=ri.updateEmotionalState(t,e.emotionalImpact||{});n.npcs[e.name]={...i,...e,lastSeen:new Date,interactionCount:(t.interactionCount||0)+1,knownSecrets:[...t.knownSecrets||[],...e.knownSecrets||[]],currentLocation:n.currentLocation}}else{const t=ri.createNPC({...e,id:Date.now().toString(),firstEncounter:new Date,lastSeen:new Date,interactionCount:1,relationship:0,knownSecrets:[],currentLocation:n.currentLocation});n.npcs[e.name]=t}}),e.factionChanges&&e.factionChanges.forEach(e=>{n.factions[e.faction]||(n.factions[e.faction]={name:e.faction,influence:10,goals:[],members:[]}),e.change.includes("influence")&&(n.factions[e.faction].influence+=5)}),e.questUpdates&&e.questUpdates.forEach(e=>{const t=n.activeQuests.findIndex(t=>t.title===e.quest);t>=0&&(n.activeQuests[t]={...n.activeQuests[t],progress:e.progress,currentObjective:e.newObjective})}),n}),le(t=>({...t,playerActions:[...t.playerActions,{description:`Player action: ${L}`,timestamp:new Date,location:Y.currentLocation}],consequences:[...t.consequences,...e.consequences||[]]})))},De=({campaign:e,messages:t,inputMessage:i,setInputMessage:s,sendMessage:r,handleKeyPress:a,isAIThinking:o,messagesEndRef:l,onStartCombat:c,worldState:h,aiMemory:u,inputRef:d})=>{const[p,m]=n.useState(!1),[f,g]=n.useState(!1),[v,x]=n.useState(!1),[y,_]=n.useState(null),[b,w]=n.useState("all"),[S,M]=n.useState(!1),[T,E]=n.useState(!0),C=n.useRef(null);n.useEffect(()=>{!o&&d.current&&d.current.focus()},[o,d]);const N=t.filter(e=>"all"===b||e.type===b);return n.useEffect(()=>{const e=C.current;if(!e)return;const t=()=>{const{scrollTop:t,scrollHeight:n,clientHeight:i}=e;g(!(n-t-i<100))};return e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)},[]),at.jsxs("div",{className:"h-full flex flex-col transition-all duration-500 "+(S?"fixed inset-0 z-50":""),children:[at.jsxs("div",{className:"relative bg-gradient-to-r from-slate-900/95 via-purple-900/95 to-slate-900/95 backdrop-blur-lg border-b border-purple-500/30",children:[at.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-purple-900/20 via-transparent to-transparent"}),at.jsxs("div",{className:"relative flex items-center justify-between p-4",children:[at.jsxs("div",{className:"flex items-center space-x-4",children:[at.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg",children:"🗺️"}),at.jsxs("div",{children:[at.jsx("h2",{className:"text-xl font-bold text-white",children:(null==e?void 0:e.theme)||"Adventure"}),at.jsxs("div",{className:"flex items-center space-x-4 text-sm text-purple-200",children:[at.jsx("span",{children:"•"}),at.jsxs("span",{children:[N.length," messages"]}),at.jsx("span",{children:"•"}),at.jsx("span",{className:"text-green-400",children:"Active Campaign"}),(null==h?void 0:h.currentLocation)&&at.jsxs(at.Fragment,{children:[at.jsx("span",{children:"•"}),at.jsx("span",{className:"text-yellow-400",children:h.currentLocation})]})]})]})]}),at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsxs("select",{value:b,onChange:e=>w(e.target.value),className:"px-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:outline-none focus:border-purple-400",children:[at.jsx("option",{value:"all",children:"All Messages"}),at.jsx("option",{value:"dm",children:"DM Only"}),at.jsx("option",{value:"player",children:"Player Only"}),at.jsx("option",{value:"system",children:"System Only"})]}),at.jsx("button",{onClick:()=>m(!p),className:"p-2 rounded-lg transition-all "+(p?"bg-purple-600 text-white":"bg-white/10 text-purple-200 hover:bg-white/20"),title:"Quick Actions",children:"⚡"}),at.jsx("button",{onClick:()=>x(!0),className:"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-purple-200",title:"Roll Dice",children:"🎲"}),at.jsx("button",{onClick:()=>E(!T),className:"p-2 rounded-lg transition-all "+(T?"bg-green-600 text-white":"bg-white/10 text-purple-200 hover:bg-white/20"),title:"Atmospheric Sounds",children:"🔊"}),at.jsx("button",{onClick:()=>M(!S),className:"p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-purple-200",title:"Toggle Fullscreen",children:S?"🗗":"🗖"})]})]})]}),p&&at.jsx("div",{className:"bg-gradient-to-r from-purple-900/30 to-blue-900/30 border-b border-purple-500/30 backdrop-blur-sm",children:at.jsxs("div",{className:"p-4",children:[at.jsxs("h3",{className:"text-white font-semibold mb-3 flex items-center space-x-2",children:[at.jsx("span",{children:"⚡"}),at.jsx("span",{children:"Quick Actions"})]}),at.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:["I examine my surroundings carefully for clues","I search for hidden passages or secret doors","I listen carefully for any sounds or voices","I check my equipment and inventory","I try to communicate with any nearby NPCs","I cast a detection spell","I move stealthily forward","I prepare for combat"].map((e,t)=>at.jsx("button",{onClick:()=>(e=>{s(e),m(!1),setTimeout(()=>r(),100)})(e),className:"text-left p-3 bg-white/10 hover:bg-white/20 rounded-lg border border-white/20 transition-all text-sm text-purple-100 hover:text-white transform hover:scale-105",disabled:o,children:e},t))})]})}),at.jsxs("div",{ref:C,className:"flex-1 overflow-y-auto bg-gradient-to-br from-slate-950/90 via-purple-950/90 to-slate-950/90 relative",children:[at.jsxs("div",{className:"absolute inset-0 opacity-5",children:[at.jsx("div",{className:"absolute top-1/4 left-1/4 w-64 h-64 bg-purple-500 rounded-full filter blur-3xl"}),at.jsx("div",{className:"absolute bottom-1/4 right-1/4 w-48 h-48 bg-blue-500 rounded-full filter blur-3xl"})]}),at.jsxs("div",{className:"relative p-6 space-y-6",children:[N.map((e,t)=>{var n,i,a;return at.jsx("div",{className:"group relative transform transition-all duration-300 hover:scale-[1.01] "+("player"===e.type?"ml-8":"dm"===e.type?"mr-8":""),children:at.jsx("div",{className:"relative p-6 rounded-2xl backdrop-blur-sm border shadow-xl "+("player"===e.type?"bg-gradient-to-br from-blue-600/20 to-cyan-600/20 border-blue-400/30 shadow-blue-500/10":"dm"===e.type?"bg-gradient-to-br from-purple-600/20 to-pink-600/20 border-purple-400/30 shadow-purple-500/10":"bg-gradient-to-br from-gray-600/20 to-slate-600/20 border-gray-400/30 shadow-gray-500/10"),children:at.jsxs("div",{className:"flex items-start space-x-4 mb-4",children:[at.jsx("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold shadow-lg "+("player"===e.type?"bg-gradient-to-br from-blue-500 to-cyan-600":"dm"===e.type?"bg-gradient-to-br from-purple-500 to-pink-600":"bg-gradient-to-br from-gray-500 to-slate-600"),children:"player"===e.type?(null==(n=null==A?void 0:A.name)?void 0:n.charAt(0))||"P":"dm"===e.type?"🎭":"⚙️"}),at.jsxs("div",{className:"flex-1 min-w-0",children:[at.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[at.jsx("span",{className:"font-bold text-white text-lg",children:"player"===e.type?(null==A?void 0:A.name)||"You":"dm"===e.type?"Dungeon Master":e.playerName||"System"}),at.jsx("span",{className:"text-xs text-gray-400 bg-black/30 px-2 py-1 rounded-full",children:new Date(e.timestamp).toLocaleTimeString()}),(null==(i=e.atmosphere)?void 0:i.mood)&&at.jsx("span",{className:"text-xs px-3 py-1 rounded-full font-medium "+("tense"===e.atmosphere.mood?"bg-red-500/30 text-red-300 border border-red-500/50":"mysterious"===e.atmosphere.mood?"bg-purple-500/30 text-purple-300 border border-purple-500/50":"peaceful"===e.atmosphere.mood?"bg-green-500/30 text-green-300 border border-green-500/50":"bg-blue-500/30 text-blue-300 border border-blue-500/50"),children:e.atmosphere.mood})]}),at.jsx("div",{className:"text-gray-100 leading-relaxed text-lg",dangerouslySetInnerHTML:{__html:(a=e.content,a?a.replace(/\*\*(.*?)\*\*/g,'<strong class="text-yellow-300">$1</strong>').replace(/\*(.*?)\*/g,'<em class="text-blue-300">$1</em>').replace(/"(.*?)"/g,'<span class="text-green-300">"$1"</span>'):"")}}),e.choices&&e.choices.length>0&&at.jsxs("div",{className:"mt-6 space-y-3",children:[at.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-300",children:[at.jsx("span",{className:"w-2 h-2 bg-yellow-400 rounded-full animate-pulse"}),at.jsx("span",{className:"font-medium",children:"Choose your path:"})]}),at.jsx("div",{className:"grid gap-3",children:e.choices.map((e,t)=>at.jsx("button",{onClick:()=>{s(e),setTimeout(()=>r(),100)},className:"group text-left p-4 bg-gradient-to-r from-white/10 to-white/5 hover:from-white/20 hover:to-white/10 rounded-xl border border-white/20 hover:border-white/40 transition-all duration-300 transform hover:scale-105 hover:shadow-lg",disabled:o,children:at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("span",{className:"w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-lg flex items-center justify-center text-sm font-bold text-white group-hover:scale-110 transition-transform",children:t+1}),at.jsx("span",{className:"text-gray-200 group-hover:text-white transition-colors font-medium",children:e})]})},t))})]}),e.atmosphere&&at.jsxs("div",{className:"mt-4 p-3 bg-black/20 rounded-xl border border-white/10",children:[at.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Atmosphere"}),at.jsxs("div",{className:"text-sm text-gray-300",children:["🌡️ ",e.atmosphere.mood," • 🌤️ ",e.atmosphere.lighting||"Normal"," • 🔊 ",e.atmosphere.sounds||"Quiet"]})]})]})]})})},e.id||t)}),o&&at.jsx("div",{className:"group transform transition-all duration-300",children:at.jsx("div",{className:"relative p-6 rounded-2xl bg-gradient-to-br from-purple-600/20 to-pink-600/20 border border-purple-400/30 backdrop-blur-sm shadow-xl",children:at.jsxs("div",{className:"flex items-center space-x-4",children:[at.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center text-white shadow-lg",children:"🎭"}),at.jsxs("div",{className:"flex-1",children:[at.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[at.jsx("span",{className:"font-bold text-white text-lg",children:"Dungeon Master"}),at.jsxs("div",{className:"flex space-x-1",children:[at.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-pulse"}),at.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),at.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]})]}),at.jsx("div",{className:"text-purple-200 text-lg italic",children:"The Dungeon Master weaves the threads of fate..."})]})]})})}),at.jsx("div",{ref:l})]})]}),f&&at.jsx("div",{className:"absolute bottom-24 right-6 z-10",children:at.jsx("button",{onClick:()=>{var e;return null==(e=l.current)?void 0:e.scrollIntoView({behavior:"smooth"})},className:"p-3 bg-gradient-to-br from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-full text-white shadow-lg transition-all transform hover:scale-110",children:"↓"})}),at.jsx("div",{className:"bg-gradient-to-r from-slate-900/95 via-purple-900/95 to-slate-900/95 backdrop-blur-lg border-t border-purple-500/30 p-6",children:at.jsxs("div",{className:"flex space-x-4",children:[at.jsxs("div",{className:"flex-1 relative",children:[at.jsx("input",{ref:d,type:"text",value:i,onChange:e=>s(e.target.value),onKeyDown:a,placeholder:"What do you do? (Be specific and creative!)",className:"w-full px-6 py-4 bg-white/10 text-white placeholder-purple-200 rounded-2xl border border-white/20 focus:outline-none focus:border-purple-400 focus:ring-2 focus:ring-purple-400/50 transition-all text-lg backdrop-blur-sm",disabled:o,maxLength:500}),i.length>0&&at.jsxs("div",{className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-sm text-gray-400 bg-black/30 px-2 py-1 rounded-full",children:[i.length,"/500"]})]}),at.jsx("button",{onClick:r,disabled:o||!i.trim(),className:"px-8 py-4 bg-gradient-to-br from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed rounded-2xl transition-all text-white font-bold text-lg shadow-lg transform hover:scale-105 disabled:transform-none",children:o?"⏳":"🚀"})]})}),v&&at.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",children:at.jsxs("div",{className:"bg-gradient-to-br from-purple-900/90 to-blue-900/90 backdrop-blur-lg rounded-2xl p-8 border border-purple-400/30 shadow-2xl max-w-md w-full mx-4",children:[at.jsx("h3",{className:"text-2xl font-bold mb-6 text-white text-center",children:"🎲 Dice Roller"}),at.jsx("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[4,6,8,10,12,20].map(e=>at.jsxs("button",{onClick:()=>(e=>{const t=Math.floor(Math.random()*e)+1;_(t),s(`I roll a d${e} and get ${t}`),setTimeout(()=>_(null),3e3)})(e),className:"p-4 bg-white/10 hover:bg-white/20 rounded-xl transition-all text-white font-bold text-lg transform hover:scale-105 border border-white/20 hover:border-white/40",children:["d",e]},e))}),y&&at.jsxs("div",{className:"text-center mb-6 p-4 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-xl border border-yellow-400/30",children:[at.jsxs("div",{className:"text-3xl font-bold text-yellow-400 mb-2",children:["🎯 ",y]}),at.jsx("div",{className:"text-yellow-200",children:"Great roll!"})]}),at.jsx("button",{onClick:()=>x(!1),className:"w-full px-6 py-3 bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 rounded-xl transition-all text-white font-bold",children:"Close"})]})})]})};return"welcome"===M?at.jsx("div",{className:`min-h-screen bg-gradient-to-br ${{default:"from-purple-900 via-blue-900 to-indigo-900",fantasy:"from-emerald-900 via-green-800 to-teal-900",dungeon:"from-gray-900 via-slate-800 to-stone-900",forest:"from-green-900 via-emerald-800 to-lime-900",tavern:"from-amber-900 via-orange-800 to-yellow-900",scifi:"from-cyan-900 via-blue-800 to-indigo-900",horror:"from-red-900 via-purple-900 to-black",urban:"from-slate-900 via-gray-800 to-zinc-900",apocalypse:"from-orange-900 via-red-800 to-yellow-900",pirate:"from-blue-900 via-teal-800 to-cyan-900"}[B]} flex items-center justify-center p-4 transition-all duration-1000`,children:at.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20",children:[at.jsxs("div",{className:"text-center mb-8",children:[at.jsx("h1",{className:"text-4xl font-bold text-white mb-2",children:"⚔️ AI Dungeon Master"}),at.jsx("p",{className:"text-blue-200",children:"Advanced RPG with real consequences"}),at.jsxs("div",{className:"flex justify-center space-x-4 mt-4 text-sm",children:[at.jsxs("div",{className:"flex items-center space-x-1 text-yellow-400",children:[at.jsx(xe,{size:16}),at.jsx("span",{children:"Tactical Combat"})]}),at.jsxs("div",{className:"flex items-center space-x-1 text-green-400",children:[at.jsx(ne,{size:16}),at.jsx("span",{children:"Character Growth"})]}),at.jsxs("div",{className:"flex items-center space-x-1 text-purple-400",children:[at.jsx(ve,{size:16}),at.jsx("span",{children:"Living World"})]})]}),at.jsx(Ea,{content:"Interactive tutorial and help guide",ariaLabel:"Help tutorial",children:at.jsxs("button",{onClick:()=>{c(!0),u("welcome")},className:"mt-4 px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all flex items-center space-x-2 mx-auto","aria-label":"Open interactive tutorial and help guide",children:[at.jsx(Le,{size:16}),at.jsx("span",{children:"Interactive Tutorial"})]})})]}),g?at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"}),at.jsx("p",{className:"text-blue-200",children:"Loading..."})]}):x?at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"text-center mb-4",children:[at.jsxs("p",{className:"text-white",children:["Welcome back, ",null==d?void 0:d.displayName,"!"]}),at.jsx(Ea,{content:"Continue your adventure with existing characters",ariaLabel:"Continue adventure",children:at.jsx("button",{onClick:async()=>{try{if(await ye(),I&&I.length>0){const e=I.find(e=>"active"===e.status)||I[0];e?(P(e),T("game"),fe("/game",{state:{campaignId:e.id}})):(T("character-select"),fe("/characters"))}else T("character-select"),fe("/characters")}catch(e){T("character-select"),fe("/characters")}},className:"w-full px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all","aria-label":"Continue your adventure with existing characters",children:"Continue Adventure"})})]}),at.jsx(Ea,{content:"Sign out of your account",ariaLabel:"Sign out",children:at.jsx("button",{onClick:async()=>{try{await Jn.signOut(),N(null),P(null),f([]),p(null),y(!1),T("welcome"),de("goodbye",{message:"See you next time, adventurer!"})}catch(e){}},className:"w-full px-6 py-3 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all","aria-label":"Sign out of your account",children:"Sign Out"})})]}):at.jsxs("div",{className:"space-y-4",children:[at.jsx(Ea,{content:"Sign in with your Google account to save progress",ariaLabel:"Sign in with Google",children:at.jsxs("button",{onClick:me,disabled:g,className:"w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center space-x-2","aria-label":"Sign in with your Google account to save progress","aria-describedby":"signin-description",children:[at.jsx(we,{size:20}),at.jsx("span",{children:"Sign in with Google"})]})}),at.jsx("div",{id:"signin-description",className:"sr-only",children:"Sign in to save your progress and access multiplayer features"}),at.jsxs("div",{className:"text-center",children:[at.jsx("p",{className:"text-blue-200 text-sm mb-3",children:"Or join an existing campaign:"}),at.jsxs("div",{className:"flex space-x-2",children:[at.jsx("input",{type:"text",placeholder:"Campaign Code",value:W,onChange:e=>G(e.target.value.toUpperCase()),className:"flex-1 px-3 py-2 rounded-lg bg-white/20 text-white placeholder-blue-200 border border-white/30 focus:outline-none focus:border-blue-400 text-center","aria-label":"Enter campaign code to join existing game",maxLength:6}),at.jsx(Ea,{content:"Join an existing campaign using the 6-character code",ariaLabel:"Join campaign",children:at.jsx("button",{onClick:()=>{E.trim()&&W.trim()&&(A?alert("Join campaign feature coming soon!"):T("character"))},disabled:!E.trim()||!W.trim(),className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-all","aria-label":"Join campaign with entered code",children:"Join"})})]})]})]})]})}):("character-select"===M&&m.forEach((e,t)=>{}),at.jsxs("div",{className:"h-full overflow-hidden",children:[at.jsxs(Ca,{children:[at.jsx(Aa,{messages:i,onDismiss:pe}),r&&at.jsx(n.Suspense,{fallback:at.jsx(KM,{}),children:at.jsx(WM,{character:A,onStart:async()=>{try{const e={id:`tutorial_${Date.now()}`,name:"Apprentice",class:"Mage",level:1,health:16,maxHealth:16,mana:20,maxMana:20,experience:0,gold:25,inventory:{Staff:1,Spellbook:1,"Mana Potion":2},baseStats:{strength:8,dexterity:12,intelligence:16,charisma:14},skills:["Arcana","Investigation"],backstory:"A young apprentice learning the ways of magic and adventure.",totalPlayTime:0,lastPlayed:new Date,achievements:[]};N(e);const t={id:`tutorial_campaign_${Date.now()}`,name:"Learning Adventure",theme:"Fantasy",description:"A guided tutorial to learn MythSeeker mechanics",isMultiplayer:!1,started:!1,status:"active",isTutorial:!0,players:[{id:V,name:(null==d?void 0:d.displayName)||"Player",character:e}],customPrompt:"You are a patient, educational DM teaching a new player. This is a tutorial campaign designed to teach MythSeeker mechanics through play.\n\nTUTORIAL OBJECTIVES:\n1. Teach basic movement and exploration\n2. Introduce NPC interaction and dialogue\n3. Demonstrate simple combat mechanics\n4. Show inventory and character management\n5. Explain quest and objective systems\n\nGUIDELINES:\n- Be encouraging and supportive\n- Explain mechanics naturally through story\n- Provide clear choices that teach different systems\n- Keep challenges easy and educational\n- Celebrate player successes\n- Use simple, clear language\n- Reference the tutorial nature when helpful\n\nStart with a welcoming scene that introduces the magical academy setting and the player's role as an apprentice.",createdAt:new Date,lastActivity:new Date};await Me(t),de("success",{message:"Tutorial started! Learn the ropes of MythSeeker!"})}catch(e){de("error",{message:"Failed to start tutorial. Please try again."})}},onDismiss:()=>{o(!1)}})}),at.jsx("div",{className:"h-full overflow-hidden",children:at.jsx("main",{className:"h-full overflow-hidden",children:at.jsx("div",{className:"h-full",children:at.jsx("div",{className:"h-full overflow-hidden",children:(()=>{switch(M){case"character":return x?at.jsxs("div",{className:"h-full p-6",children:[at.jsxs("div",{className:"flex justify-between items-center mb-6",children:[at.jsx("h2",{className:"text-3xl font-bold text-white",children:"Create Your Hero"}),at.jsx("button",{onClick:()=>T("character-select"),className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"← Back to Characters"})]}),at.jsx(QM,{playerName:(null==d?void 0:d.displayName)||"",classes:_e,onCreateCharacter:Se,joinCode:W})]}):at.jsx("div",{className:"h-full flex items-center justify-center p-4",children:at.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 text-center",children:[at.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Authentication Required"}),at.jsx("p",{className:"text-blue-200 mb-6",children:"Please sign in to create a character"}),at.jsx("button",{onClick:me,className:"px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Sign in with Google"})]})});case"waiting":return at.jsx(eT,{campaign:R,onStart:Me,onBack:()=>T("lobby")});case"game":return at.jsx(De,{campaign:R,messages:D,inputMessage:L,setInputMessage:O,sendMessage:Ae,handleKeyPress:Ne,isAIThinking:U,messagesEndRef:J,onStartCombat:Re,worldState:Y,aiMemory:oe,inputRef:Q});case"combat":return q&&at.jsx(n.Suspense,{fallback:at.jsx(KM,{}),children:at.jsx(GM,{combatants:q.combatants,battleMap:q.battleMap,currentTurn:q.currentTurn,activeCombatantId:q.turnOrder[q.currentCombatantIndex],onAction:Pe,onEndCombat:Ie,isPlayerTurn:t.isPlayerTurn()})});case"world":return at.jsxs("div",{className:"h-full p-6",children:[at.jsx("h2",{className:"text-2xl font-bold text-white mb-6",children:"World Map & Exploration"}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[at.jsx("p",{className:"text-blue-200 mb-4",children:"Interactive world map coming soon!"}),at.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[at.jsxs("div",{className:"bg-black/20 rounded-lg p-4",children:[at.jsx("h3",{className:"text-white font-semibold mb-2",children:"Current Location"}),at.jsx("p",{className:"text-blue-200",children:(null==Y?void 0:Y.currentLocation)||"Unknown"})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-4",children:[at.jsx("h3",{className:"text-white font-semibold mb-2",children:"Weather"}),at.jsx("p",{className:"text-blue-200",children:(null==Y?void 0:Y.weather)||"Clear"})]})]})]})]});case"characters":case"character-select":return at.jsxs("div",{className:"h-full p-6",children:[at.jsxs("div",{className:"flex justify-between items-center mb-6",children:[at.jsxs("div",{children:[at.jsx("h2",{className:"text-3xl font-bold text-white",children:"Choose Your Character"}),at.jsxs("p",{className:"text-blue-200",children:["Welcome back, ",null==d?void 0:d.displayName,"!"]})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsx("button",{onClick:()=>T("dashboard"),className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"← Back to Dashboard"}),at.jsx("button",{onClick:()=>T("character"),className:"px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Create New Character"})]})]}),0===m.length?at.jsxs("div",{className:"text-center py-12",children:[at.jsx("div",{className:"text-6xl mb-4",children:"🏰"}),at.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No Characters Yet"}),at.jsx("p",{className:"text-blue-200 mb-6",children:"Create your first character to begin your adventure!"}),at.jsx("button",{onClick:()=>T("character"),className:"px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl font-semibold hover:from-green-700 hover:to-blue-700 transition-all",children:"Create Your First Character"})]}):at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[m.map(e=>at.jsx("div",{className:"bg-white/10 rounded-xl p-6 border border-white/20 hover:border-blue-400 hover:bg-white/20 cursor-pointer transition-all",onClick:()=>(async e=>{try{const t=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]").find(t=>t.id===e);if(t)return N(t),void de("characterLoaded",{character:t.name});if(d){const t=await Jn.getCharacter(e);t?(N(t),de("characterLoaded",{character:t.name})):de("error",{message:"Character not found in database"})}else de("error",{message:"Character not found"})}catch(t){de("error",{message:`Failed to load character: ${t.message||"Unknown error"}`})}})(e.id),children:at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-4xl mb-3",children:"Warrior"===e.class?"⚔️":"Rogue"===e.class?"🗡️":"Mage"===e.class?"🔮":"Cleric"===e.class?"⚡":"Ranger"===e.class?"🏹":"🎵"}),at.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:e.name}),at.jsxs("p",{className:"text-blue-200 mb-3",children:["Level ",e.level," ",e.class]}),at.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm text-blue-200",children:[at.jsxs("div",{children:["HP: ",e.health,"/",e.maxHealth]}),at.jsxs("div",{children:["XP: ",e.experience]}),at.jsxs("div",{children:["Gold: ",e.gold]}),at.jsxs("div",{children:["Play Time: ",Math.floor(e.totalPlayTime/6e4),"m"]})]}),at.jsxs("div",{className:"mt-3 text-xs text-green-400",children:["Last played: ",new Date(e.lastPlayed).toLocaleDateString()]})]})},e.id)),at.jsx("div",{onClick:()=>T("character"),className:"bg-gradient-to-br from-green-500/20 to-blue-500/20 rounded-xl p-6 border-2 border-dashed border-white/30 hover:border-white/50 hover:from-green-500/30 hover:to-blue-500/30 cursor-pointer transition-all",children:at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-4xl mb-3",children:"✨"}),at.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Create New Character"}),at.jsx("p",{className:"text-blue-200",children:"Start a new adventure with a fresh hero"})]})})]})]});case"profile":return x?at.jsxs("div",{className:"h-full p-6",children:[at.jsxs("div",{className:"flex justify-between items-center mb-6",children:[at.jsx("h2",{className:"text-3xl font-bold text-white",children:"Player Profile"}),at.jsx("button",{onClick:()=>T("dashboard"),className:"px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-all",children:"← Back to Dashboard"})]}),at.jsx("div",{className:"h-[calc(100vh-200px)]",children:at.jsx(Qn,{})})]}):at.jsx("div",{className:"h-full flex items-center justify-center p-4",children:at.jsxs("div",{className:"bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 text-center",children:[at.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Authentication Required"}),at.jsx("p",{className:"text-blue-200 mb-6",children:"Please sign in to view your profile"}),at.jsx("button",{onClick:me,className:"px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all",children:"Sign in with Google"})]})});default:return null}})()})})})}),"dm-center"!==M&&at.jsx(n.Suspense,{fallback:at.jsx(KM,{}),children:at.jsx(qM,{isOpen:_,onClose:()=>b(!1),activeTab:re,onTabChange:ae,isMobile:w,campaign:R,messages:D,players:ie.players,worldState:Y,achievements:Z,onSendMessage:async e=>{if(e.trim()&&(null==R?void 0:R.id))try{await Ra.sendMessage(R.id,{type:"player",content:e,character:null==A?void 0:A.name,playerId:V,playerName:E}),de("messageSent")}catch(t){}},onUpdateSettings:e=>{},drawerWidth:ce,setDrawerWidth:he,minWidth:320,maxWidth:600})})]}),at.jsx(n.Suspense,{fallback:at.jsx(KM,{}),children:at.jsx(YM,{isOpen:l,onClose:()=>c(!1)})}),at.jsx(n.Suspense,{fallback:at.jsx(KM,{}),children:at.jsx($M,{isOpen:l,onClose:()=>c(!1),currentScreen:h,onAction:(e,t)=>{switch(e){case"close":c(!1);break;case"navigate":u(t.screen)}zo.trackUserAction("help_action",{action:e,data:t})}})})]}))},QM=({playerName:e,classes:t,onCreateCharacter:i,joinCode:s})=>{const[r,a]=n.useState(null),[o,l]=n.useState(e),[c,h]=n.useState(""),[u,d]=n.useState(null),[p,m]=n.useState({}),[f,g]=n.useState(!1),[v,x]=n.useState(1),[y,_]=n.useState(!1),b=["fuck","shit","bitch","asshole","bastard","dick","cunt","piss","cock","fag","slut","whore"],w=e=>{if(!e)return!1;const t=e.toLowerCase();return b.some(e=>t.includes(e))},S=()=>{let e=0;return o.trim()&&(e+=40),r&&(e+=40),c.trim()&&(e+=20),e},M=u||r,T=o.trim().length>0&&!p.name,E=null!==r&&!p.class,C=0===c.length||!p.backstory&&c.trim().length>0;return at.jsxs("div",{className:"space-y-6 character-creation",children:[at.jsxs("div",{className:"bg-white/10 rounded-xl p-4 mb-6",children:[at.jsxs("div",{className:"flex items-center justify-between mb-3",children:[at.jsx("h3",{className:"text-white font-semibold",children:"Character Creation Progress"}),at.jsxs("span",{className:"text-blue-300 text-sm",children:[S(),"% Complete"]})]}),at.jsx("div",{className:"w-full bg-white/20 rounded-full h-2 mb-4",children:at.jsx("div",{className:"bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500 ease-out",style:{width:`${S()}%`}})}),at.jsxs("div",{className:"flex items-center justify-between text-sm",children:[at.jsxs("div",{className:"flex items-center space-x-2 "+(T?"text-green-400":o.trim()?"text-yellow-400":"text-gray-400"),children:[at.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold "+(T?"bg-green-500":o.trim()?"bg-yellow-500":"bg-gray-500"),children:T?"✓":"1"}),at.jsx("span",{children:"Name"})]}),at.jsxs("div",{className:"flex items-center space-x-2 "+(E?"text-green-400":r?"text-yellow-400":"text-gray-400"),children:[at.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold "+(E?"bg-green-500":r?"bg-yellow-500":"bg-gray-500"),children:E?"✓":"2"}),at.jsx("span",{children:"Class"})]}),at.jsxs("div",{className:"flex items-center space-x-2 "+(C?"text-green-400":c.trim()?"text-yellow-400":"text-gray-400"),children:[at.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold "+(C?"bg-green-500":c.trim()?"bg-yellow-500":"bg-gray-500"),children:C?"✓":"3"}),at.jsx("span",{children:"Story"})]})]})]}),y&&at.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center",children:at.jsxs("div",{className:"bg-gradient-to-br from-purple-900/90 to-blue-900/90 rounded-2xl p-8 max-w-md mx-4 text-center border border-purple-500/50",children:[at.jsx("div",{className:"text-6xl mb-4 animate-bounce",children:null==r?void 0:r.icon}),at.jsx("h3",{className:"text-2xl font-bold text-white mb-2",children:"Character Created!"}),at.jsxs("p",{className:"text-purple-200 mb-4",children:[o," the ",null==r?void 0:r.name," is ready for adventure!"]}),at.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-300/30 border-t-purple-400 rounded-full mx-auto"})]})}),at.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8",children:[at.jsxs("div",{className:"space-y-4 lg:space-y-6",children:[at.jsxs("div",{className:"transition-all duration-300 "+(1===v?"ring-2 ring-blue-400 rounded-xl p-4":""),children:[at.jsxs("label",{className:"block text-white font-semibold mb-2 lg:mb-3 text-sm lg:text-base flex items-center space-x-2",children:[at.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold",children:"1"}),at.jsx("span",{children:"Character Name"}),T&&at.jsx("span",{className:"text-green-400",children:"✓"})]}),at.jsx("input",{type:"text",placeholder:"Enter your hero's name...",value:o,onChange:e=>{l(e.target.value),1===v&&e.target.value.trim()&&setTimeout(()=>x(2),500)},onFocus:()=>x(1),className:"w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl bg-white/20 text-white placeholder-blue-200 border transition-all duration-300 focus:outline-none text-sm lg:text-base "+(p.name?"border-red-400 focus:border-red-400":T?"border-green-400 focus:border-green-400":"border-white/30 focus:border-blue-400")}),p.name&&at.jsx("div",{className:"text-red-400 text-xs mt-1 animate-pulse",children:p.name}),T&&!p.name&&at.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[at.jsx("span",{children:"✓"}),at.jsx("span",{children:"Great name choice!"})]})]}),at.jsxs("div",{className:"transition-all duration-300 "+(2===v?"ring-2 ring-blue-400 rounded-xl p-4":""),children:[at.jsxs("label",{className:"block text-white font-semibold mb-2 lg:mb-3 text-sm lg:text-base flex items-center space-x-2",children:[at.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold",children:"2"}),at.jsx("span",{children:"Choose Your Class"}),E&&at.jsx("span",{className:"text-green-400",children:"✓"})]}),at.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4 class-grid",children:t&&t.length>0?t.map(e=>at.jsx("div",{onClick:()=>{a(e),2===v&&setTimeout(()=>x(3),500)},onFocus:()=>x(2),onMouseEnter:()=>d(e),onMouseLeave:()=>d(null),className:"class-card p-3 lg:p-4 rounded-xl border-2 cursor-pointer transition-all duration-300 transform "+((null==r?void 0:r.name)===e.name?"border-green-400 bg-green-500/30 shadow-lg scale-105 selected":(null==u?void 0:u.name)===e.name?"border-blue-400 bg-blue-500/20 shadow-md scale-102":"border-white/30 bg-white/10 hover:border-white/50 hover:scale-102"),children:at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-2xl lg:text-3xl mb-2 transition-transform duration-300 hover:scale-110",children:e.icon}),at.jsx("h3",{className:"text-white font-semibold text-sm lg:text-base mb-2",children:e.name}),at.jsxs("div",{className:"text-xs text-blue-200 space-y-1 mb-2",children:[at.jsxs("div",{className:"flex justify-between",children:[at.jsxs("span",{children:["STR: ",e.stats.strength]}),at.jsx("span",{className:"text-yellow-300",children:"Attack Power"})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsxs("span",{children:["DEX: ",e.stats.dexterity]}),at.jsx("span",{className:"text-green-300",children:"Agility"})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsxs("span",{children:["INT: ",e.stats.intelligence]}),at.jsx("span",{className:"text-purple-300",children:"Magic"})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsxs("span",{children:["CHA: ",e.stats.charisma]}),at.jsx("span",{className:"text-pink-300",children:"Social"})]})]}),(null==r?void 0:r.name)===e.name&&at.jsxs("div",{className:"flex items-center justify-center space-x-1 text-green-400 text-xs animate-pulse",children:[at.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full"}),at.jsx("span",{children:"Selected"})]})]})},e.name)):at.jsxs("div",{className:"col-span-2 text-center py-8 text-gray-400",children:[at.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full mx-auto mb-4"}),at.jsx("p",{children:"Loading character classes..."})]})}),p.class&&at.jsx("div",{className:"text-red-400 text-xs mt-1 animate-pulse",children:p.class}),E&&!p.class&&at.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[at.jsx("span",{children:"✓"}),at.jsxs("span",{children:["Excellent choice! ",r.name," is a powerful class."]})]})]}),at.jsxs("div",{className:"transition-all duration-300 "+(3===v?"ring-2 ring-blue-400 rounded-xl p-4":""),children:[at.jsxs("label",{className:"block text-white font-semibold mb-2 lg:mb-3 text-sm lg:text-base flex items-center space-x-2",children:[at.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold",children:"3"}),at.jsx("span",{children:"Character Backstory"}),at.jsx("span",{className:"text-blue-300 text-xs",children:"(Optional)"}),C&&at.jsx("span",{className:"text-green-400",children:"✓"})]}),at.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:["What is your character's greatest fear?","Where did they grow up?","What brought them to adventure?","Who is their closest friend?","What do they value most?"].map((e,t)=>at.jsx("button",{onClick:()=>{h(t=>t?`${t}\n\n${e}`:e),x(3)},className:"px-2 py-1 bg-blue-600/30 text-blue-200 text-xs rounded hover:bg-blue-600/50 transition-all transform hover:scale-105",children:e},t))}),at.jsx("textarea",{value:c,onChange:e=>{h(e.target.value),x(3)},onFocus:()=>x(3),placeholder:"Describe your character's background, motivations, and personality... (Click prompts above for inspiration)",className:"w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl bg-white/20 text-white placeholder-blue-200 border transition-all duration-300 focus:outline-none h-24 lg:h-32 resize-none text-sm lg:text-base "+(p.backstory?"border-red-400 focus:border-red-400":C&&c.trim()?"border-green-400 focus:border-green-400":"border-white/30 focus:border-blue-400")}),p.backstory&&at.jsx("div",{className:"text-red-400 text-xs mt-1 animate-pulse",children:p.backstory}),C&&c.trim()&&!p.backstory&&at.jsxs("div",{className:"text-green-400 text-xs mt-1 flex items-center space-x-1",children:[at.jsx("span",{children:"✓"}),at.jsx("span",{children:"Great backstory! This will enhance your roleplay experience."})]})]}),at.jsx("button",{onClick:()=>{(()=>{g(!0);const e={};return o.trim()?o.length>50?e.name="Character name must be 50 characters or less.":w(o)&&(e.name="Please choose a more appropriate name."):e.name="Character name is required.",r||(e.class="Character class is required."),c.length>0&&w(c)?e.backstory="Please remove inappropriate language from the backstory.":c.length>500&&(e.backstory="Backstory must be 500 characters or less."),m(e),setTimeout(()=>g(!1),500),0===Object.keys(e).length})()&&(_(!0),setTimeout(()=>{i({name:o.trim(),class:r.name,backstory:c.trim()})},1500))},disabled:!r||!o.trim()||f,className:"w-full px-4 lg:px-6 py-3 rounded-xl font-semibold transition-all duration-300 text-sm lg:text-base transform "+(r&&o.trim()&&!f?"bg-gradient-to-r from-green-600 to-blue-600 text-white hover:from-green-700 hover:to-blue-700 shadow-lg hover:scale-105 hover:shadow-xl":"bg-gray-600 text-gray-300 cursor-not-allowed opacity-50"),children:f?at.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[at.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full"}),at.jsx("span",{children:"Validating..."})]}):r&&o.trim()?`Create ${o} the ${r.name}`:"Complete required fields to create character"})]}),at.jsxs("div",{className:"bg-white/10 rounded-xl p-4 lg:p-6 transition-all duration-300",children:[at.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:M?`Class Preview: ${M.name}`:"Select a Class"}),M?at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[at.jsx("div",{className:"text-4xl animate-pulse",children:M.icon}),at.jsxs("div",{children:[at.jsx("h4",{className:"text-lg font-semibold text-white",children:M.name}),at.jsx("p",{className:"text-blue-200 text-sm",children:"Master of tactical combat"})]})]}),o.trim()&&at.jsxs("div",{className:"bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-lg p-4 border border-purple-500/30",children:[at.jsxs("h5",{className:"text-white font-semibold mb-2 flex items-center space-x-2",children:[at.jsx("span",{children:"✨"}),at.jsx("span",{children:"Character Preview"})]}),at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:"text-3xl mb-2",children:M.icon}),at.jsx("p",{className:"text-lg font-bold text-white",children:o}),at.jsxs("p",{className:"text-blue-300",children:["Level 1 ",M.name]}),at.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[at.jsx("div",{className:"bg-red-500/20 rounded px-2 py-1",children:at.jsx("span",{className:"text-red-300",children:"❤️ Health: 100"})}),at.jsx("div",{className:"bg-blue-500/20 rounded px-2 py-1",children:at.jsx("span",{className:"text-blue-300",children:"✨ Mana: 50"})})]})]})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("h5",{className:"text-white font-semibold mb-2",children:"Class Description"}),at.jsxs("p",{className:"text-blue-200 text-sm leading-relaxed",children:["Warrior"===M.name&&"A mighty warrior skilled in close combat, wielding powerful weapons and wearing heavy armor. Your strength and endurance make you the frontline defender of your party.","Rogue"===M.name&&"A stealthy rogue who excels at sneaking, lockpicking, and dealing devastating sneak attacks. Your agility and cunning allow you to strike from the shadows.","Mage"===M.name&&"A powerful spellcaster who harnesses the arcane arts to cast devastating spells. Your intelligence and magical prowess make you a force to be reckoned with.","Cleric"===M.name&&"A divine spellcaster who channels the power of the gods to heal allies and smite enemies. Your faith and charisma make you an invaluable support.","Ranger"===M.name&&"A skilled hunter and tracker who excels at ranged combat and wilderness survival. Your dexterity and knowledge of nature make you a versatile adventurer.","Bard"===M.name&&"A charismatic performer who uses music and magic to inspire allies and charm enemies. Your creativity and social skills make you the heart of any party."]})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("h5",{className:"text-white font-semibold mb-2",children:"Starting Equipment"}),at.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("span",{className:"text-yellow-400",children:"⚔️"}),at.jsx("span",{className:"text-blue-200",children:"Iron Sword"})]}),at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("span",{className:"text-brown-400",children:"🛡️"}),at.jsx("span",{className:"text-blue-200",children:"Leather Armor"})]}),at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("span",{className:"text-red-400",children:"🧪"}),at.jsx("span",{className:"text-blue-200",children:"3x Healing Potions"})]}),at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("span",{className:"text-yellow-400",children:"💰"}),at.jsx("span",{className:"text-blue-200",children:"100 Gold Pieces"})]})]})]}),at.jsxs("div",{className:"bg-black/20 rounded-lg p-3",children:[at.jsx("h5",{className:"text-white font-semibold mb-2",children:"Class Abilities"}),at.jsx("div",{className:"space-y-2 text-sm",children:M.skills&&Object.entries(M.skills).slice(0,3).map(([e,t])=>at.jsxs("div",{className:"flex justify-between items-center",children:[at.jsx("span",{className:"text-blue-200 capitalize",children:e.replace(/([A-Z])/g," $1").trim()}),at.jsx("div",{className:"flex items-center space-x-1",children:[...Array(5)].map((e,n)=>at.jsx("div",{className:"w-2 h-2 rounded-full "+(n<t?"bg-yellow-400":"bg-gray-600")},n))})]},e))})]})]}):at.jsxs("div",{className:"text-center text-blue-200 py-8",children:[at.jsx("div",{className:"text-4xl mb-4 opacity-50",children:"🎭"}),at.jsx("p",{children:"Select a class to see detailed information"})]})]})]})]})},eT=({campaign:e,onStart:t,onBack:i})=>{var s,r,a;const[o,l]=n.useState(0),[c,h]=n.useState(1);n.useEffect(()=>{if(null==e?void 0:e.players){const t=e.players.filter(e=>"ready"===e.status).length;l(t),h(e.players.length)}},[e]);const u=(null==(r=null==(s=null==e?void 0:e.players)?void 0:s[0])?void 0:r.isHost)||!1;return at.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white p-6",children:at.jsxs("div",{className:"w-full",children:[at.jsxs("div",{className:"text-center mb-8",children:[at.jsx("h2",{className:"text-4xl font-bold mb-4",children:"Campaign Lobby"}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-4 inline-block",children:[at.jsx("p",{className:"text-lg mb-2",children:"Campaign Code:"}),at.jsx("div",{className:"font-mono text-3xl bg-white/20 px-6 py-3 rounded-lg border border-white/30",children:(null==e?void 0:e.code)||"LOADING"}),at.jsx("p",{className:"text-blue-200 text-sm mt-2",children:"Share this code with other players"})]})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8",children:[at.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[at.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Campaign Details"}),at.jsxs("div",{className:"space-y-2",children:[at.jsxs("p",{children:[at.jsx("span",{className:"text-blue-200",children:"Theme:"})," ",(null==e?void 0:e.theme)||"Unknown"]}),at.jsxs("p",{children:[at.jsx("span",{className:"text-blue-200",children:"Max Players:"})," ",(null==e?void 0:e.maxPlayers)||6]}),at.jsxs("p",{children:[at.jsx("span",{className:"text-blue-200",children:"Type:"})," ",(null==e?void 0:e.isMultiplayer)?"Multiplayer":"Solo"]}),(null==e?void 0:e.customPrompt)&&at.jsxs("p",{children:[at.jsx("span",{className:"text-blue-200",children:"Custom Story:"})," ",e.customPrompt]})]})]}),at.jsxs("div",{className:"bg-white/10 rounded-lg p-6 border border-white/20",children:[at.jsxs("h3",{className:"text-xl font-semibold mb-4",children:["Players (",c,"/",(null==e?void 0:e.maxPlayers)||6,")"]}),at.jsx("div",{className:"space-y-3",children:(null==(a=null==e?void 0:e.players)?void 0:a.map((e,t)=>{var n,i;return at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-3 h-3 rounded-full "+("ready"===e.status?"bg-green-400":"bg-yellow-400")}),at.jsxs("div",{className:"flex-1",children:[at.jsx("p",{className:"font-medium",children:(null==(n=e.character)?void 0:n.name)||e.name}),at.jsxs("p",{className:"text-sm text-blue-200",children:[(null==(i=e.character)?void 0:i.class)||"Unknown Class"," ",e.isHost?"(Host)":""]})]}),at.jsx("div",{className:"px-3 py-1 rounded-full text-xs "+("ready"===e.status?"bg-green-600 text-white":"bg-yellow-600 text-white"),children:"ready"===e.status?"Ready":"Not Ready"})]},e.id||t)}))||at.jsx("div",{className:"text-center text-blue-200 py-4",children:at.jsx("p",{children:"Loading players..."})})})]})]}),at.jsx("div",{className:"bg-gradient-to-r from-orange-600/20 to-yellow-600/20 rounded-lg p-6 border border-orange-400/30 mb-6",children:at.jsxs("div",{className:"flex items-start space-x-4",children:[at.jsx("div",{className:"text-3xl",children:"🎯"}),at.jsxs("div",{className:"flex-1",children:[at.jsx("h3",{className:"text-xl font-semibold text-orange-200 mb-2",children:"Turn-Based Multiplayer"}),at.jsx("p",{className:"text-orange-100 mb-3",children:"You can start this multiplayer campaign solo! Other players can join during the game when it's their turn. Perfect for turn-based gameplay where friends hop in and out as needed."}),at.jsxs("div",{className:"flex items-center space-x-2 text-sm text-orange-200",children:[at.jsx("span",{children:"✨"}),at.jsx("span",{children:"Players can join mid-game using the campaign code"})]})]})]})}),at.jsxs("div",{className:"flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4",children:[u&&at.jsxs("button",{onClick:()=>{t(e)},className:"flex-1 px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg",children:["🚀 Start Adventure",1===c?" Solo":` (${o}/${c} Ready)`]}),!u&&at.jsx("div",{className:"flex-1 px-8 py-4 bg-blue-600/50 text-white rounded-xl font-bold text-lg text-center",children:"Waiting for host to start..."}),at.jsx("button",{onClick:i,className:"px-8 py-4 bg-gray-600 hover:bg-gray-700 text-white rounded-xl font-bold text-lg transition-all",children:"← Back to Lobby"})]}),at.jsxs("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-4",children:[at.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[at.jsx("h4",{className:"font-semibold mb-2",children:"💡 For Hosts"}),at.jsx("p",{className:"text-sm text-blue-200",children:"You can start the campaign anytime! Other players can join later using the campaign code, making it perfect for flexible scheduling."})]}),at.jsxs("div",{className:"bg-white/5 rounded-lg p-4 border border-white/10",children:[at.jsx("h4",{className:"font-semibold mb-2",children:"🎮 For Players"}),at.jsx("p",{className:"text-sm text-blue-200",children:"Even if the campaign has started, you can still join! Just use the campaign code and jump in when it's your turn or during a break in the action."})]})]})]})})};function tT(){const[e,t]=n.useState(null),[i,s]=n.useState(!1);n.useEffect(()=>{const e=p(Zn,e=>{t(e),s(!0)});return()=>e()},[]);return i?e?at.jsxs(Hn,{children:[at.jsx("a",{href:"#main-content",className:"sr-only focus:not-sr-only absolute top-2 left-2 bg-blue-700 text-white px-4 py-2 rounded z-50",children:"Skip to main content"}),at.jsx(Ca,{children:at.jsxs(Mn,{children:[at.jsx(wn,{path:"/",element:at.jsx(bn,{to:"/dashboard",replace:!0})}),at.jsx(wn,{path:"/dashboard",element:at.jsx(nT,{user:e})}),at.jsx(wn,{path:"/game/*",element:at.jsx(iT,{user:e})}),at.jsx(wn,{path:"/characters",element:at.jsx(sT,{user:e})}),at.jsx(wn,{path:"/characters/create",element:at.jsx(rT,{user:e})}),at.jsx(wn,{path:"/campaigns",element:at.jsx(aT,{user:e})}),at.jsx(wn,{path:"/campaigns/:id",element:at.jsx(oT,{user:e})}),at.jsx(wn,{path:"/campaigns/:id/waiting",element:at.jsx(lT,{user:e})}),at.jsx(wn,{path:"/party",element:at.jsx(cT,{user:e})}),at.jsx(wn,{path:"/world",element:at.jsx(hT,{user:e})}),at.jsx(wn,{path:"/combat",element:at.jsx(uT,{user:e})}),at.jsx(wn,{path:"/magic",element:at.jsx(dT,{user:e})}),at.jsx(wn,{path:"/dm-center",element:at.jsx(pT,{user:e})}),at.jsx(wn,{path:"/profile",element:at.jsx(mT,{user:e})}),at.jsx(wn,{path:"/achievements",element:at.jsx(fT,{user:e})}),at.jsx(wn,{path:"/settings",element:at.jsx(gT,{user:e})}),at.jsx(wn,{path:"/help",element:at.jsx(vT,{user:e})}),at.jsx(wn,{path:"*",element:at.jsx(bn,{to:"/dashboard",replace:!0})})]})})]}):at.jsx(Ho,{onOpenAuth:async()=>{try{await Jn.signInWithGoogle()}catch(e){}}}):at.jsx(KM,{})}const nT=({user:e})=>{const t=hn(),[i,s]=n.useState([]),[r,a]=n.useState([]),[o,l]=n.useState(!1),[c,h]=n.useState(!1),[u,d]=n.useState(!1);return n.useEffect(()=>{const e=()=>{d(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{(async()=>{try{const t=await Jn.getUserCampaigns(e.uid),n=await Jn.getUserCharacters(e.uid);s(t||[]),a(n||[])}catch(t){}})()},[e.uid]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 md:pb-0 pb-20",children:at.jsx(Wo,{user:e,campaigns:i,characters:r,onNavigate:e=>{t(e)},onCreateCampaign:()=>{t("/campaigns")},onCreateCharacter:()=>{t("/characters/create")},onJoinCampaign:()=>{t("/campaigns")},onResumeCampaign:e=>{t(`/campaigns/${e}`)},onOpenDiceRoller:()=>{l(!0)},onOpenProfile:()=>{t("/profile")},onOpenSettings:()=>{t("/settings")},onOpenAchievements:()=>{t("/achievements")},onOpenHelp:()=>{t("/help")}})}),at.jsx(XM,{onToggleDrawer:()=>h(!c),isDrawerOpen:c,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:u,hasNotifications:!1,notificationCount:0}),o&&at.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:at.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[at.jsxs("div",{className:"flex justify-between items-center mb-4",children:[at.jsx("h2",{className:"text-2xl font-bold text-white",children:"Dice Roller"}),at.jsx("button",{onClick:()=>l(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),at.jsx(BM,{})]})})]})},iT=({user:e})=>at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto md:pb-0 pb-20",children:at.jsx(JM,{initialScreen:"game"})})]}),sT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(xT,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},rT=({user:e})=>at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(JM,{initialScreen:"character"})})]}),aT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(yT,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},oT=({user:e})=>at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(JM,{initialScreen:"game"})})]}),lT=({user:e})=>at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(JM,{initialScreen:"waiting"})})]}),cT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(_T,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},hT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(JM,{initialScreen:"world"})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},uT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(JM,{initialScreen:"combat"})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},dT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(JM,{initialScreen:"magic"})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},pT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(bT,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},mT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(wT,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},fT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(ST,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},gT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(MT,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},vT=({user:e})=>{const t=hn(),[i,s]=n.useState(!1),[r,a]=n.useState(!1);return n.useEffect(()=>{const e=()=>{a(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),at.jsxs("div",{className:"flex h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsx(zM,{user:e,onSignOut:()=>{}}),at.jsx("div",{className:"flex-1 overflow-auto",children:at.jsx(TT,{user:e})}),at.jsx(XM,{onToggleDrawer:()=>s(!i),isDrawerOpen:i,onQuickAction:e=>{switch(e){case"chat":t("/game");break;case"party":t("/party");break;case"inventory":case"character":t("/characters");break;case"map":t("/world");break;case"settings":t("/settings")}},isMobile:r,hasNotifications:!1,notificationCount:0})]})},xT=({user:e})=>{const t=hn(),[i,s]=n.useState([]),[r,a]=n.useState(!0),[o,l]=n.useState(!1),[c,h]=n.useState(null),[u,d]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const t=await Jn.getUserCharacters(e.uid);s(t||[])}catch(t){const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");s(e)}finally{a(!1)}})()},[e.uid]);return r?at.jsx("div",{className:"flex-1 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("p",{className:"text-blue-200",children:"Loading characters..."})]})}):o?at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-4xl mx-auto",children:[at.jsxs("div",{className:"mb-6",children:[at.jsxs("button",{onClick:()=>l(!1),className:"text-blue-400 hover:text-blue-300 flex items-center space-x-2 mb-4",children:[at.jsx(qe,{className:"w-4 h-4"}),at.jsx("span",{children:"Back to Characters"})]}),at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Create Character"}),at.jsx("p",{className:"text-blue-200",children:"Forge your hero and begin your adventure"})]}),at.jsx(QM,{playerName:(null==e?void 0:e.displayName)||"Adventurer",classes:[{name:"Warrior",description:"Mighty fighter with heavy armor and weapons",icon:"⚔️",stats:{strength:16,dexterity:12,intelligence:10,charisma:8}},{name:"Mage",description:"Powerful spellcaster with arcane magic",icon:"🔮",stats:{strength:8,dexterity:10,intelligence:16,charisma:12}},{name:"Ranger",description:"Skilled archer and wilderness expert",icon:"🏹",stats:{strength:14,dexterity:14,intelligence:10,charisma:8}},{name:"Cleric",description:"Divine healer and protector",icon:"⛪",stats:{strength:12,dexterity:8,intelligence:12,charisma:16}},{name:"Rogue",description:"Stealthy assassin and thief",icon:"🗡️",stats:{strength:10,dexterity:16,intelligence:12,charisma:8}},{name:"Paladin",description:"Holy warrior with divine powers",icon:"🛡️",stats:{strength:14,dexterity:10,intelligence:8,charisma:14}}],onCreateCharacter:t=>{const n={...t,id:Date.now().toString(),createdAt:(new Date).toISOString(),lastPlayed:(new Date).toISOString(),experience:0,level:1,health:100,maxHealth:100,mana:50,maxMana:50,inventory:[],equipment:{},spells:[],abilities:[],status:"active"};if(s(e=>[...e,n]),l(!1),e)Jn.saveCharacter(e.uid,n);else{const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]");e.push(n),localStorage.setItem("mythseeker_characters",JSON.stringify(e))}},joinCode:""})]})}):u&&c?at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-4xl mx-auto",children:[at.jsxs("div",{className:"mb-6",children:[at.jsxs("button",{onClick:()=>d(!1),className:"text-blue-400 hover:text-blue-300 flex items-center space-x-2 mb-4",children:[at.jsx(qe,{className:"w-4 h-4"}),at.jsx("span",{children:"Back to Characters"})]}),at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Character Sheet"}),at.jsx("p",{className:"text-blue-200",children:"Manage your character's details and progression"})]}),at.jsx(VM,{character:c,onSave:e=>{s(t=>t.map(t=>t.id===e.id?e:t)),d(!1)},onClose:()=>d(!1)})]})}):at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-6xl mx-auto",children:[at.jsxs("div",{className:"mb-8 flex justify-between items-center",children:[at.jsxs("div",{children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Characters"}),at.jsx("p",{className:"text-blue-200",children:"Manage your heroes and companions"})]}),at.jsxs("button",{onClick:()=>l(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2",children:[at.jsx(Me,{className:"w-5 h-5"}),at.jsx("span",{children:"Create Character"})]})]}),0===i.length?at.jsxs("div",{className:"text-center py-12",children:[at.jsx("div",{className:"w-24 h-24 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4",children:at.jsx(we,{className:"w-12 h-12 text-slate-400"})}),at.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No Characters Yet"}),at.jsx("p",{className:"text-blue-200 mb-6",children:"Create your first character to begin your adventure"}),at.jsx("button",{onClick:()=>l(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Create Character"})]}):at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:i.map(n=>{var i;return at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50 hover:border-blue-500/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-4 mb-4",children:[at.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:at.jsx("span",{className:"text-white font-bold text-lg",children:null==(i=n.name)?void 0:i.charAt(0)})}),at.jsxs("div",{className:"flex-1",children:[at.jsx("h3",{className:"text-lg font-semibold text-white",children:n.name}),at.jsx("p",{className:"text-blue-200 text-sm",children:n.class})]}),at.jsx("button",{onClick:()=>(async t=>{if(window.confirm("Are you sure you want to delete this character? This action cannot be undone."))if(s(e=>e.filter(e=>e.id!==t)),e)try{await Jn.deleteCharacter(e.uid,t)}catch(n){}else{const e=JSON.parse(localStorage.getItem("mythseeker_characters")||"[]").filter(e=>e.id!==t);localStorage.setItem("mythseeker_characters",JSON.stringify(e))}})(n.id),className:"text-slate-400 hover:text-red-400 transition-colors p-1",title:"Delete character",children:at.jsx(Xe,{className:"w-4 h-4"})})]}),at.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-400",children:"Level"}),at.jsx("span",{className:"text-white",children:n.level||1})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-400",children:"XP"}),at.jsx("span",{className:"text-white",children:n.experience||0})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-400",children:"Health"}),at.jsxs("span",{className:"text-white",children:[n.health||100,"/",n.maxHealth||100]})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-400",children:"Last Played"}),at.jsx("span",{className:"text-white text-xs",children:n.lastPlayed?new Date(n.lastPlayed).toLocaleDateString():"Never"})]})]}),at.jsxs("div",{className:"flex space-x-2",children:[at.jsx("button",{onClick:()=>(e=>{h(e),t("/campaigns")})(n),className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors",children:"Play"}),at.jsx("button",{onClick:()=>(e=>{h(e),d(!0)})(n),className:"flex-1 bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-sm font-medium transition-colors",children:"Edit"})]})]},n.id)})})]})})},yT=({user:e})=>{const t=hn(),[i,s]=n.useState([]),[r,a]=n.useState(!0),[o,l]=n.useState(!1),[c,h]=n.useState(!1);n.useState(null);const[u,d]=n.useState(""),p=[{name:"Classic Fantasy",description:"Dragons, magic, and heroic quests in a medieval world",icon:"🏰",bg:"fantasy"},{name:"Sci-Fi Adventure",description:"Space exploration, alien encounters, and futuristic technology",icon:"🚀",bg:"scifi"},{name:"Horror Mystery",description:"Dark secrets, supernatural threats, and psychological tension",icon:"👻",bg:"horror"},{name:"Urban Fantasy",description:"Magic hidden in the modern world, supernatural creatures in cities",icon:"🌃",bg:"urban"},{name:"Post-Apocalyptic",description:"Surviving in a world after civilization has collapsed",icon:"☢️",bg:"apocalypse"},{name:"Pirate Adventure",description:"High seas, treasure hunting, and swashbuckling action",icon:"🏴‍☠️",bg:"pirate"}];n.useEffect(()=>{m()},[]);const m=async()=>{try{a(!0);const t=(await Jn.getUserCampaigns(e.uid)).map(e=>({id:e.id,theme:e.theme,description:`${e.theme} campaign`,status:e.started?"active":"paused",players:e.players||[],joinCode:e.code,createdAt:e.createdAt,customPrompt:e.customPrompt||""}));s(t||[])}catch(t){}finally{a(!1)}},f=e=>{switch(e.status){case"active":return"🟢";case"paused":return"🟡";case"completed":return"🏁";default:return"⚪"}},g=e=>{switch(e.status){case"active":return"text-green-400";case"paused":return"text-yellow-400";case"completed":return"text-blue-400";default:return"text-gray-400"}},v={total:i.length,active:i.filter(e=>"active"===e.status).length,paused:i.filter(e=>"paused"===e.status).length,completed:i.filter(e=>"completed"===e.status).length};return r?at.jsx("div",{className:"flex-1 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsx("div",{className:"w-12 h-12 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("p",{className:"text-blue-200",children:"Loading campaigns..."})]})}):at.jsxs("div",{className:"flex-1 overflow-auto bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900",children:[at.jsxs("div",{className:"p-6 space-y-6",children:[at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Campaigns"}),at.jsx("p",{className:"text-blue-200",children:"Manage your adventures and join new campaigns"})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsxs("button",{onClick:()=>h(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[at.jsx("span",{children:"🔗"}),at.jsx("span",{children:"Join Campaign"})]}),at.jsxs("button",{onClick:()=>l(!0),className:"px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[at.jsx("span",{children:"➕"}),at.jsx("span",{children:"Create Campaign"})]})]})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[at.jsx("div",{className:"bg-blue-900/50 backdrop-blur-sm rounded-lg p-4 border border-blue-700/50",children:at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("p",{className:"text-blue-200 text-sm",children:"Total Campaigns"}),at.jsx("p",{className:"text-2xl font-bold text-white",children:v.total})]}),at.jsx("div",{className:"text-3xl",children:"📚"})]})}),at.jsx("div",{className:"bg-green-900/50 backdrop-blur-sm rounded-lg p-4 border border-green-700/50",children:at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("p",{className:"text-green-200 text-sm",children:"Active"}),at.jsx("p",{className:"text-2xl font-bold text-white",children:v.active})]}),at.jsx("div",{className:"text-3xl",children:"🟢"})]})}),at.jsx("div",{className:"bg-yellow-900/50 backdrop-blur-sm rounded-lg p-4 border border-yellow-700/50",children:at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("p",{className:"text-yellow-200 text-sm",children:"Paused"}),at.jsx("p",{className:"text-2xl font-bold text-white",children:v.paused})]}),at.jsx("div",{className:"text-3xl",children:"🟡"})]})}),at.jsx("div",{className:"bg-purple-900/50 backdrop-blur-sm rounded-lg p-4 border border-purple-700/50",children:at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("p",{className:"text-purple-200 text-sm",children:"Completed"}),at.jsx("p",{className:"text-2xl font-bold text-white",children:v.completed})]}),at.jsx("div",{className:"text-3xl",children:"🏁"})]})})]}),at.jsxs("div",{className:"space-y-4",children:[at.jsx("h2",{className:"text-xl font-semibold text-white",children:"Your Campaigns"}),0===i.length?at.jsxs("div",{className:"text-center py-12",children:[at.jsx("div",{className:"text-6xl mb-4",children:"📚"}),at.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No campaigns yet"}),at.jsx("p",{className:"text-blue-200 mb-6",children:"Create your first campaign or join an existing one to start your adventure!"}),at.jsxs("div",{className:"flex justify-center space-x-4",children:[at.jsxs("button",{onClick:()=>l(!0),className:"px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[at.jsx("span",{children:"➕"}),at.jsx("span",{children:"Create Campaign"})]}),at.jsxs("button",{onClick:()=>h(!0),className:"px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center space-x-2 transition-colors",children:[at.jsx("span",{children:"🔗"}),at.jsx("span",{children:"Join Campaign"})]})]})]}):at.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:i.map(e=>{var n,i;return at.jsxs("div",{className:"bg-slate-800/50 backdrop-blur-sm rounded-lg p-6 border border-slate-700/50 hover:border-blue-500/50 transition-all hover:shadow-lg hover:shadow-blue-500/20",children:[at.jsxs("div",{className:"flex items-start justify-between mb-4",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("span",{className:"text-2xl",children:(null==(n=p.find(t=>t.name===e.theme))?void 0:n.icon)||"📚"}),at.jsxs("div",{children:[at.jsx("h3",{className:"text-lg font-semibold text-white",children:e.theme}),at.jsx("p",{className:"text-sm text-blue-200",children:e.description})]})]}),at.jsx("div",{className:`text-lg ${g(e)}`,children:f(e)})]}),at.jsxs("div",{className:"space-y-3 mb-4",children:[at.jsxs("div",{className:"flex items-center justify-between text-sm",children:[at.jsx("span",{className:"text-gray-300",children:"Status:"}),at.jsx("span",{className:`font-medium ${g(e)}`,children:e.status.charAt(0).toUpperCase()+e.status.slice(1)})]}),at.jsxs("div",{className:"flex items-center justify-between text-sm",children:[at.jsx("span",{className:"text-gray-300",children:"Players:"}),at.jsx("span",{className:"text-white",children:(null==(i=e.players)?void 0:i.length)||1})]}),at.jsxs("div",{className:"flex items-center justify-between text-sm",children:[at.jsx("span",{className:"text-gray-300",children:"Join Code:"}),at.jsx("span",{className:"text-white font-mono",children:e.joinCode})]}),at.jsxs("div",{className:"flex items-center justify-between text-sm",children:[at.jsx("span",{className:"text-gray-300",children:"Created:"}),at.jsx("span",{className:"text-white",children:new Date(e.createdAt).toLocaleDateString()})]})]}),at.jsxs("div",{className:"flex space-x-2",children:["active"===e.status&&at.jsx("button",{onClick:()=>window.location.href=`/campaigns/${e.id}`,className:"flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors",children:"Continue"}),"paused"===e.status&&at.jsx("button",{onClick:()=>(async e=>{try{t("/game",{state:{campaignId:e}})}catch(n){}})(e.id),className:"flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm transition-colors",children:"Resume"}),"active"===e.status&&at.jsx("button",{onClick:()=>(async e=>{try{s(t=>t.map(t=>t.id===e?{...t,status:"paused"}:t))}catch(t){}})(e.id),className:"px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm transition-colors",children:"Pause"}),at.jsx("button",{onClick:()=>(async e=>{if(confirm("Are you sure you want to delete this campaign? This action cannot be undone."))try{s(t=>t.filter(t=>t.id!==e))}catch(t){}})(e.id),className:"px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition-colors",children:"Delete"})]})]},e.id)})})]})]}),o&&at.jsx(HM,{user:e,onClose:()=>l(!1),onCampaignCreated:async(e,n)=>{await m(),l(!1),t("/game",{state:{campaignId:e,joinCode:n}})}}),c&&at.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:at.jsxs("div",{className:"bg-slate-800 rounded-lg p-6 w-full max-w-md space-y-4",children:[at.jsx("h3",{className:"text-xl font-semibold text-white",children:"Join Campaign"}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-blue-200 mb-2",children:"Campaign Join Code"}),at.jsx("input",{type:"text",value:u,onChange:e=>d(e.target.value.toUpperCase()),placeholder:"Enter 6-character code",className:"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500",maxLength:6})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsx("button",{onClick:()=>h(!1),className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors",children:"Cancel"}),at.jsx("button",{onClick:async()=>{if(u.trim())try{const n=await Jn.getUserCharacters(e.uid);if(!n||0===n.length)return alert("You need to create a character first before joining a campaign."),void t("/characters");const{gameId:i,gameData:s}=await Jn.joinGameSession(u.trim(),n[0].id);await m(),h(!1),d(""),t("/game",{state:{campaignId:i,joinCode:u.trim()}})}catch(n){alert("Failed to join campaign. Please check the join code and try again.")}},disabled:!u.trim(),className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded transition-colors",children:"Join Campaign"})]})]})})]})},_T=({user:e})=>{var t,i,s,r;const a=hn(),[o,l]=n.useState([]),[c,h]=n.useState([]),[u,d]=n.useState(!0),[p,m]=n.useState(!1),[f,g]=n.useState(!1),[v,x]=n.useState(""),[y,_]=n.useState(""),[b,w]=n.useState(null),[S,M]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const t=JSON.parse(localStorage.getItem(`mythseeker_party_${e.uid}`)||"[]");l(t);const n=JSON.parse(localStorage.getItem(`mythseeker_invites_${e.uid}`)||"[]");h(n)}catch(t){}finally{d(!1)}})()},[e.uid]);const T=()=>{(()=>{const e=Math.random().toString(36).substr(2,6).toUpperCase();x(e)})(),m(!0)},E=t=>{const n=o.filter(e=>e.id!==t);l(n),localStorage.setItem(`mythseeker_party_${e.uid}`,JSON.stringify(n))},C=e=>{switch(null==e?void 0:e.toLowerCase()){case"warrior":return"⚔️";case"rogue":return"🗡️";case"mage":return"🔮";case"cleric":return"⚡";case"ranger":return"🏹";case"bard":return"🎵";default:return"👤"}};return u?at.jsx("div",{className:"flex-1 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("p",{className:"text-blue-200",children:"Loading party data..."})]})}):at.jsxs("div",{className:"flex-1 p-6 overflow-y-auto",children:[at.jsxs("div",{className:"max-w-6xl mx-auto",children:[at.jsxs("div",{className:"mb-8 flex justify-between items-center",children:[at.jsxs("div",{children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Party"}),at.jsx("p",{className:"text-blue-200",children:"Manage your adventuring companions and friends"})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsx("button",{onClick:()=>g(!0),className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Join Party"}),at.jsx("button",{onClick:T,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Invite Friend"})]})]}),at.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[at.jsx("div",{className:"lg:col-span-2",children:at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsxs("div",{className:"flex justify-between items-center mb-6",children:[at.jsxs("h3",{className:"text-xl font-semibold text-white",children:["Party Members (",o.length,")"]}),at.jsx("button",{onClick:T,className:"bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors",children:"+ Add Member"})]}),0===o.length?at.jsxs("div",{className:"text-center py-12",children:[at.jsx("div",{className:"w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4",children:at.jsx(ie,{className:"w-8 h-8 text-slate-400"})}),at.jsx("p",{className:"text-blue-200 mb-2",children:"No party members yet"}),at.jsx("p",{className:"text-slate-400 text-sm mb-4",children:"Invite friends to start your adventuring party"}),at.jsx("button",{onClick:T,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition-colors",children:"Invite First Member"})]}):at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:o.map(e=>{var t,n,i,s;return at.jsxs("div",{className:"bg-slate-700/30 rounded-lg p-4 hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-start justify-between mb-3",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:at.jsx("span",{className:"text-white text-lg",children:C(null==(t=e.character)?void 0:t.class)})}),at.jsxs("div",{children:[at.jsx("h4",{className:"text-white font-medium",children:e.name}),at.jsxs("p",{className:"text-blue-200 text-sm",children:[null==(n=e.character)?void 0:n.name," • Level ",null==(i=e.character)?void 0:i.level," ",null==(s=e.character)?void 0:s.class]})]})]}),at.jsxs("div",{className:"flex items-center space-x-2",children:[at.jsx("div",{className:"w-2 h-2 rounded-full "+(e.isOnline?"bg-green-400":"bg-slate-400")}),at.jsx("button",{onClick:()=>{w(e),M(!0)},className:"text-slate-400 hover:text-white",children:at.jsx(Ye,{className:"w-4 h-4"})})]})]}),e.notes&&at.jsxs("p",{className:"text-slate-300 text-sm mb-3 italic",children:['"',e.notes,'"']}),at.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-400",children:[at.jsxs("span",{children:["Joined ",new Date(e.joinedAt).toLocaleDateString()]}),at.jsx("button",{onClick:()=>E(e.id),className:"text-red-400 hover:text-red-300 transition-colors",children:"Remove"})]})]},e.id)})})]})}),at.jsxs("div",{className:"space-y-6",children:[at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Pending Invites"}),c.length>0?at.jsx("div",{className:"space-y-3",children:c.map(t=>at.jsxs("div",{className:"p-3 bg-slate-700/30 rounded",children:[at.jsxs("div",{className:"flex justify-between items-start mb-2",children:[at.jsxs("div",{children:[at.jsx("p",{className:"text-white font-medium",children:t.hostName}),at.jsx("p",{className:"text-blue-200 text-sm",children:t.partyName})]}),at.jsx("span",{className:"text-slate-400 text-xs",children:new Date(t.timestamp).toLocaleDateString()})]}),at.jsxs("div",{className:"flex space-x-2",children:[at.jsx("button",{onClick:()=>(e=>{_(e.code),g(!0)})(t),className:"flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors",children:"Accept"}),at.jsx("button",{onClick:()=>(t=>{const n=c.filter(e=>e.id!==t);h(n),localStorage.setItem(`mythseeker_invites_${e.uid}`,JSON.stringify(n))})(t.id),className:"flex-1 bg-slate-600 hover:bg-slate-500 text-white px-3 py-1 rounded text-sm transition-colors",children:"Decline"})]})]},t.id))}):at.jsx("div",{className:"text-center py-4",children:at.jsx("p",{className:"text-slate-400 text-sm",children:"No pending invites"})})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Party Stats"}),at.jsxs("div",{className:"space-y-3",children:[at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-300",children:"Total Members"}),at.jsx("span",{className:"text-white font-semibold",children:o.length})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-300",children:"Online Now"}),at.jsx("span",{className:"text-white font-semibold",children:o.filter(e=>e.isOnline).length})]}),at.jsxs("div",{className:"flex justify-between",children:[at.jsx("span",{className:"text-slate-300",children:"Average Level"}),at.jsx("span",{className:"text-white font-semibold",children:o.length>0?Math.round(o.reduce((e,t)=>{var n;return e+((null==(n=t.character)?void 0:n.level)||1)},0)/o.length):0})]})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Quick Actions"}),at.jsxs("div",{className:"space-y-3",children:[at.jsxs("button",{onClick:()=>a("/game"),className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(le,{className:"w-4 h-4 text-green-400"}),at.jsx("span",{className:"text-sm",children:"Start Adventure"})]}),at.jsx(Re,{className:"w-4 h-4 text-slate-400"})]}),at.jsxs("button",{onClick:()=>a("/characters"),className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(we,{className:"w-4 h-4 text-blue-400"}),at.jsx("span",{className:"text-sm",children:"Manage Characters"})]}),at.jsx(Re,{className:"w-4 h-4 text-slate-400"})]}),at.jsxs("button",{onClick:()=>a("/campaigns"),className:"w-full flex items-center justify-between p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx(be,{className:"w-4 h-4 text-purple-400"}),at.jsx("span",{className:"text-sm",children:"View Campaigns"})]}),at.jsx(Re,{className:"w-4 h-4 text-slate-400"})]})]})]})]})]})]}),p&&at.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:at.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4",children:[at.jsxs("div",{className:"flex justify-between items-center mb-4",children:[at.jsx("h2",{className:"text-xl font-bold text-white",children:"Invite Friend"}),at.jsx("button",{onClick:()=>m(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Invite Code"}),at.jsxs("div",{className:"flex space-x-2",children:[at.jsx("input",{type:"text",value:v,readOnly:!0,className:"flex-1 px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600"}),at.jsx("button",{onClick:()=>{navigator.clipboard.writeText(v),alert("Invite code copied to clipboard!")},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Copy"})]}),at.jsx("p",{className:"text-slate-400 text-xs mt-2",children:"Share this code with your friend to invite them to your party"})]}),at.jsx("div",{className:"flex space-x-3",children:at.jsx("button",{onClick:()=>m(!1),className:"flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Close"})})]})]})}),f&&at.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:at.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4",children:[at.jsxs("div",{className:"flex justify-between items-center mb-4",children:[at.jsx("h2",{className:"text-xl font-bold text-white",children:"Join Party"}),at.jsx("button",{onClick:()=>g(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Invite Code"}),at.jsx("input",{type:"text",value:y,onChange:e=>_(e.target.value.toUpperCase()),placeholder:"Enter 6-character code",maxLength:6,className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400"})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsx("button",{onClick:()=>g(!1),className:"flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Cancel"}),at.jsx("button",{onClick:async()=>{if(y.trim())try{const t={id:Date.now().toString(),name:e.displayName||"Adventurer",email:e.email,character:{name:"Your Character",class:"Adventurer",level:1},joinedAt:(new Date).toISOString(),notes:"",isOnline:!0},n=[...o,t];l(n),localStorage.setItem(`mythseeker_party_${e.uid}`,JSON.stringify(n)),g(!1),_(""),alert("Successfully joined the party!")}catch(t){alert("Failed to join party. Please check the code and try again.")}},disabled:!y.trim(),className:"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-slate-600 text-white rounded-lg transition-colors",children:"Join Party"})]})]})]})}),S&&b&&at.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80",children:at.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4",children:[at.jsxs("div",{className:"flex justify-between items-center mb-4",children:[at.jsx("h2",{className:"text-xl font-bold text-white",children:"Party Member"}),at.jsx("button",{onClick:()=>M(!1),className:"text-slate-400 hover:text-white",children:"✕"})]}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center",children:at.jsx("span",{className:"text-white text-xl",children:C(null==(t=b.character)?void 0:t.class)})}),at.jsxs("div",{children:[at.jsx("h3",{className:"text-white font-medium",children:b.name}),at.jsxs("p",{className:"text-blue-200 text-sm",children:[null==(i=b.character)?void 0:i.name," • Level ",null==(s=b.character)?void 0:s.level," ",null==(r=b.character)?void 0:r.class]})]})]}),at.jsxs("div",{children:[at.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Notes"}),at.jsx("textarea",{value:b.notes||"",onChange:t=>((t,n)=>{const i=o.map(e=>e.id===t?{...e,notes:n}:e);l(i),localStorage.setItem(`mythseeker_party_${e.uid}`,JSON.stringify(i))})(b.id,t.target.value),placeholder:"Add notes about this party member...",rows:3,className:"w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-400"})]}),at.jsxs("div",{className:"text-sm text-slate-400",children:[at.jsxs("p",{children:["Joined: ",new Date(b.joinedAt).toLocaleDateString()]}),at.jsxs("p",{children:["Status: ",b.isOnline?"Online":"Offline"]})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsx("button",{onClick:()=>M(!1),className:"flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors",children:"Close"}),at.jsx("button",{onClick:()=>{E(b.id),M(!1)},className:"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"Remove from Party"})]})]})]})})]})},bT=({user:e})=>{hn();const[t,i]=n.useState({aiSettings:{dmStyle:"balanced",difficulty:6,descriptionLength:"detailed",improvisationLevel:7,npcComplexity:"detailed",conflictFrequency:5,continuityStrictness:"moderate",worldReactivity:8},dmPersona:{tone:"friendly",humor_level:"medium",descriptiveness:"moderate",challenge_level:"moderate",narrative_focus:"balanced",improvisation_style:"moderate"},aiTraining:{learningEnabled:!0,feedbackCollection:!0,personalityAdaptation:!0,memoryRetention:30,contextWindow:10,longTermMemory:!0,emotionalMemory:!0,crossCampaignLearning:!1}}),[s,r]=n.useState(null),[a,o]=n.useState(!0);return n.useEffect(()=>{(async()=>{try{const t=await Jn.getUserCampaigns(e.uid);t&&t.length>0&&r(t[0]);const n=localStorage.getItem(`mythseeker_dmcenter_${e.uid}`);n&&i(JSON.parse(n))}catch(t){}finally{o(!1)}})()},[e.uid]),a?at.jsx("div",{className:"flex-1 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("p",{className:"text-blue-200",children:"Loading DM Center..."})]})}):at.jsx("div",{className:"flex-1 overflow-y-auto",children:at.jsx(ZM,{dmCenterData:t,onUpdateDMCenter:t=>{i(t),localStorage.setItem(`mythseeker_dmcenter_${e.uid}`,JSON.stringify(t))},currentCampaign:s})})},wT=({user:e})=>{var t;return at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-4xl mx-auto",children:[at.jsxs("div",{className:"mb-8",children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Profile"}),at.jsx("p",{className:"text-blue-200",children:"Your account settings and preferences"})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsxs("div",{className:"flex items-center space-x-6 mb-8",children:[at.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center",children:(null==e?void 0:e.photoURL)?at.jsx("img",{src:e.photoURL,alt:e.displayName,className:"w-20 h-20 rounded-full"}):at.jsx(we,{className:"w-10 h-10 text-white"})}),at.jsxs("div",{children:[at.jsx("h2",{className:"text-2xl font-bold text-white",children:(null==e?void 0:e.displayName)||"Adventurer"}),at.jsx("p",{className:"text-blue-200",children:null==e?void 0:e.email}),at.jsxs("p",{className:"text-slate-400 text-sm",children:["Member since ",(null==(t=null==e?void 0:e.metadata)?void 0:t.creationTime)?new Date(e.metadata.creationTime).toLocaleDateString():"Unknown"]})]})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[at.jsxs("div",{children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Account Settings"}),at.jsxs("div",{className:"space-y-3",children:[at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Edit Profile"})}),at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Change Password"})}),at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Privacy Settings"})})]})]}),at.jsxs("div",{children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Game Statistics"}),at.jsxs("div",{className:"space-y-3",children:[at.jsxs("div",{className:"p-3 bg-slate-700/50 rounded-lg",children:[at.jsx("span",{className:"text-slate-400 text-sm",children:"Campaigns Played"}),at.jsx("p",{className:"text-white font-semibold",children:"0"})]}),at.jsxs("div",{className:"p-3 bg-slate-700/50 rounded-lg",children:[at.jsx("span",{className:"text-slate-400 text-sm",children:"Characters Created"}),at.jsx("p",{className:"text-white font-semibold",children:"0"})]}),at.jsxs("div",{className:"p-3 bg-slate-700/50 rounded-lg",children:[at.jsx("span",{className:"text-slate-400 text-sm",children:"Total Play Time"}),at.jsx("p",{className:"text-white font-semibold",children:"0 hours"})]})]})]})]})]})]})})},ST=({user:e})=>{const[t,i]=n.useState([]),[s,r]=n.useState([]),[a,o]=n.useState([]),[l,c]=n.useState({}),[h,u]=n.useState(!0);n.useEffect(()=>{(async()=>{try{const t=await Jn.getUserCharacters(e.uid);i(t||[]);const n=await Jn.getUserCampaigns(e.uid);r(n||[]);const s=JSON.parse(localStorage.getItem("mythseeker_game_stats")||"{}");c(s);const a=JSON.parse(localStorage.getItem("mythseeker_achievements")||"[]");o(a)}catch(t){}finally{u(!1)}})()},[e.uid]);const d=[{id:"first_character",title:"First Steps",description:"Create your first character",icon:at.jsx(we,{className:"w-8 h-8"}),color:"from-blue-500 to-cyan-500"},{id:"first_campaign",title:"Adventure Begins",description:"Start your first campaign",icon:at.jsx(be,{className:"w-8 h-8"}),color:"from-green-500 to-emerald-500"},{id:"first_combat_win",title:"Warrior",description:"Win your first combat",icon:at.jsx(le,{className:"w-8 h-8"}),color:"from-red-500 to-pink-500"},{id:"character_level_5",title:"Experienced Hero",description:"Reach level 5 with any character",icon:at.jsx(ne,{className:"w-8 h-8"}),color:"from-purple-500 to-indigo-500"},{id:"complete_campaign",title:"Storyteller",description:"Complete a campaign",icon:at.jsx(re,{className:"w-8 h-8"}),color:"from-yellow-500 to-orange-500"},{id:"multiplayer_party",title:"Party Leader",description:"Play in a multiplayer campaign",icon:at.jsx(ie,{className:"w-8 h-8"}),color:"from-indigo-500 to-purple-500"}];return h?at.jsx("div",{className:"flex-1 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("p",{className:"text-blue-200",children:"Loading achievements..."})]})}):at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-6xl mx-auto",children:[at.jsxs("div",{className:"mb-8",children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Achievements"}),at.jsx("p",{className:"text-blue-200",children:"Track your progress and accomplishments"})]}),at.jsxs("div",{className:"mb-8 grid grid-cols-1 md:grid-cols-4 gap-4",children:[at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[at.jsx("div",{className:"text-2xl font-bold text-white",children:a.length}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Achievements Unlocked"})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[at.jsx("div",{className:"text-2xl font-bold text-white",children:t.length}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Characters Created"})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[at.jsx("div",{className:"text-2xl font-bold text-white",children:s.length}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Campaigns Started"})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 text-center",children:[at.jsx("div",{className:"text-2xl font-bold text-white",children:l.combatsWon||0}),at.jsx("div",{className:"text-blue-200 text-sm",children:"Combats Won"})]})]}),at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:d.map(e=>{const n=(e=>{switch(e){case"first_character":return t.length>0?100:0;case"first_campaign":return s.length>0?100:0;case"first_combat_win":return l.combatsWon>0?100:0;case"character_level_5":return t.some(e=>e.level>=5)?100:0;case"complete_campaign":return s.some(e=>"completed"===e.status)?100:0;case"multiplayer_party":return s.some(e=>{var t;return e.isMultiplayer&&(null==(t=e.players)?void 0:t.length)>1})?100:0;default:return 0}})(e.id),i=(r=e.id,a.some(e=>e.id===r));var r;return at.jsx("div",{className:"bg-slate-800/50 rounded-lg p-6 border transition-all duration-300 "+(i?"border-yellow-500/50 shadow-lg shadow-yellow-500/20":"border-slate-700/50"),children:at.jsxs("div",{className:"text-center",children:[at.jsx("div",{className:`w-16 h-16 bg-gradient-to-br ${e.color} rounded-full flex items-center justify-center mx-auto mb-4 ${i?"animate-pulse":"opacity-50"}`,children:at.jsx("div",{className:"text-white",children:e.icon})}),at.jsx("h3",{className:"text-lg font-semibold mb-2 "+(i?"text-white":"text-slate-400"),children:e.title}),at.jsx("p",{className:"text-blue-200 text-sm mb-4",children:e.description}),at.jsx("div",{className:"w-full bg-slate-700 rounded-full h-2 mb-2",children:at.jsx("div",{className:"h-2 rounded-full transition-all duration-500 "+(i?"bg-gradient-to-r from-yellow-400 to-orange-500":"bg-blue-600"),style:{width:`${n}%`}})}),at.jsx("p",{className:"text-xs "+(i?"text-yellow-400":"text-slate-400"),children:i?"Unlocked!":`${n}% Complete`})]})},e.id)})}),a.length>0&&at.jsxs("div",{className:"mt-8",children:[at.jsx("h2",{className:"text-xl font-semibold text-white mb-4",children:"Recent Achievements"}),at.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.slice(0,3).map(e=>at.jsx("div",{className:"bg-slate-800/50 rounded-lg p-4 border border-yellow-500/30",children:at.jsxs("div",{className:"flex items-center space-x-3",children:[at.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full flex items-center justify-center",children:at.jsx(re,{className:"w-5 h-5 text-white"})}),at.jsxs("div",{children:[at.jsx("p",{className:"text-white font-medium",children:e.title}),at.jsx("p",{className:"text-blue-200 text-sm",children:new Date(e.unlockedAt).toLocaleDateString()})]})]})},e.id))})]})]})})},MT=({user:e})=>{var t,i,s,r,a,o,l,c,h,u,d,p;const[m,f]=n.useState({}),[g,v]=n.useState(!0);n.useEffect(()=>{(()=>{try{const e=JSON.parse(localStorage.getItem("mythseeker_settings")||"{}");f({soundEffects:!0,music:!1,notifications:!0,theme:"dark",fontSize:"medium",autoSave:!0,showTutorials:!0,diceRoller:{soundEnabled:!0,hapticEnabled:!0,shakeToRoll:!0,showHistory:!0},game:{autoRoll:!1,showDamageNumbers:!0,showHealthBars:!0,confirmActions:!0},...e})}catch(e){}finally{v(!1)}})()},[]);const x=(e,t,n)=>{const i={...m,[e]:{...m[e],[t]:n}};f(i),localStorage.setItem("mythseeker_settings",JSON.stringify(i))},y=(e,t)=>{const n={...m,[e]:t};f(n),localStorage.setItem("mythseeker_settings",JSON.stringify(n))};return g?at.jsx("div",{className:"flex-1 flex items-center justify-center",children:at.jsxs("div",{className:"text-center space-y-4",children:[at.jsx("div",{className:"w-8 h-8 border-4 border-blue-300/30 border-t-blue-400 rounded-full animate-spin mx-auto"}),at.jsx("p",{className:"text-blue-200",children:"Loading settings..."})]})}):at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-4xl mx-auto",children:[at.jsxs("div",{className:"mb-8 flex justify-between items-center",children:[at.jsxs("div",{children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Settings"}),at.jsx("p",{className:"text-blue-200",children:"App preferences and configuration"})]}),at.jsxs("div",{className:"flex space-x-3",children:[at.jsx("button",{onClick:()=>{const e=JSON.stringify(m,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download="mythseeker-settings.json",i.click(),URL.revokeObjectURL(n)},className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Export"}),at.jsxs("label",{className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer",children:["Import",at.jsx("input",{type:"file",accept:".json",onChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];if(n){const e=new FileReader;e.onload=e=>{var t;try{const n=JSON.parse(null==(t=e.target)?void 0:t.result);f(n),localStorage.setItem("mythseeker_settings",JSON.stringify(n)),alert("Settings imported successfully!")}catch(n){alert("Error importing settings. Please check the file format.")}},e.readAsText(n)}},className:"hidden"})]}),at.jsx("button",{onClick:()=>{window.confirm("Are you sure you want to reset all settings to default?")&&(localStorage.removeItem("mythseeker_settings"),window.location.reload())},className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Reset"})]})]}),at.jsxs("div",{className:"space-y-6",children:[at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Audio Settings"}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Sound Effects"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Enable sound effects and audio feedback"})]}),at.jsx("button",{onClick:()=>y("soundEffects",!m.soundEffects),className:"w-12 h-6 rounded-full relative transition-colors "+(m.soundEffects?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.soundEffects?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Music"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Enable background music"})]}),at.jsx("button",{onClick:()=>y("music",!m.music),className:"w-12 h-6 rounded-full relative transition-colors "+(m.music?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.music?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Notifications"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Show toast notifications"})]}),at.jsx("button",{onClick:()=>y("notifications",!m.notifications),className:"w-12 h-6 rounded-full relative transition-colors "+(m.notifications?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.notifications?"right-1":"left-1")})})]})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Display Settings"}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Theme"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Choose your preferred theme"})]}),at.jsxs("select",{value:m.theme,onChange:e=>y("theme",e.target.value),className:"bg-slate-700 text-white px-3 py-2 rounded border border-slate-600",children:[at.jsx("option",{value:"dark",children:"Dark"}),at.jsx("option",{value:"light",children:"Light"}),at.jsx("option",{value:"auto",children:"Auto"})]})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Font Size"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Adjust text size for readability"})]}),at.jsxs("select",{value:m.fontSize,onChange:e=>y("fontSize",e.target.value),className:"bg-slate-700 text-white px-3 py-2 rounded border border-slate-600",children:[at.jsx("option",{value:"small",children:"Small"}),at.jsx("option",{value:"medium",children:"Medium"}),at.jsx("option",{value:"large",children:"Large"})]})]})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Game Settings"}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Auto Save"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Automatically save game progress"})]}),at.jsx("button",{onClick:()=>y("autoSave",!m.autoSave),className:"w-12 h-6 rounded-full relative transition-colors "+(m.autoSave?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.autoSave?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Show Tutorials"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Display helpful tutorial tips"})]}),at.jsx("button",{onClick:()=>y("showTutorials",!m.showTutorials),className:"w-12 h-6 rounded-full relative transition-colors "+(m.showTutorials?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+(m.showTutorials?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Show Damage Numbers"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Display damage numbers in combat"})]}),at.jsx("button",{onClick:()=>{var e;return x("game","showDamageNumbers",!(null==(e=m.game)?void 0:e.showDamageNumbers))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(t=m.game)?void 0:t.showDamageNumbers)?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(i=m.game)?void 0:i.showDamageNumbers)?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Confirm Actions"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Ask for confirmation before important actions"})]}),at.jsx("button",{onClick:()=>{var e;return x("game","confirmActions",!(null==(e=m.game)?void 0:e.confirmActions))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(s=m.game)?void 0:s.confirmActions)?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(r=m.game)?void 0:r.confirmActions)?"right-1":"left-1")})})]})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Dice Roller Settings"}),at.jsxs("div",{className:"space-y-4",children:[at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Sound Effects"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Play sounds when rolling dice"})]}),at.jsx("button",{onClick:()=>{var e;return x("diceRoller","soundEnabled",!(null==(e=m.diceRoller)?void 0:e.soundEnabled))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(a=m.diceRoller)?void 0:a.soundEnabled)?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(o=m.diceRoller)?void 0:o.soundEnabled)?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Haptic Feedback"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Vibrate device when rolling dice"})]}),at.jsx("button",{onClick:()=>{var e;return x("diceRoller","hapticEnabled",!(null==(e=m.diceRoller)?void 0:e.hapticEnabled))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(l=m.diceRoller)?void 0:l.hapticEnabled)?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(c=m.diceRoller)?void 0:c.hapticEnabled)?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Shake to Roll"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Roll dice by shaking your device"})]}),at.jsx("button",{onClick:()=>{var e;return x("diceRoller","shakeToRoll",!(null==(e=m.diceRoller)?void 0:e.shakeToRoll))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(h=m.diceRoller)?void 0:h.shakeToRoll)?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(u=m.diceRoller)?void 0:u.shakeToRoll)?"right-1":"left-1")})})]}),at.jsxs("div",{className:"flex items-center justify-between",children:[at.jsxs("div",{children:[at.jsx("span",{className:"text-blue-200",children:"Show History"}),at.jsx("p",{className:"text-slate-400 text-sm",children:"Display roll history in drawer"})]}),at.jsx("button",{onClick:()=>{var e;return x("diceRoller","showHistory",!(null==(e=m.diceRoller)?void 0:e.showHistory))},className:"w-12 h-6 rounded-full relative transition-colors "+((null==(d=m.diceRoller)?void 0:d.showHistory)?"bg-blue-600":"bg-slate-600"),children:at.jsx("div",{className:"w-4 h-4 bg-white rounded-full absolute top-1 transition-transform "+((null==(p=m.diceRoller)?void 0:p.showHistory)?"right-1":"left-1")})})]})]})]})]})]})})},TT=({user:e})=>at.jsx("div",{className:"flex-1 p-6 overflow-y-auto",children:at.jsxs("div",{className:"max-w-4xl mx-auto",children:[at.jsxs("div",{className:"mb-8",children:[at.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Help & Support"}),at.jsx("p",{className:"text-blue-200",children:"Support & documentation"})]}),at.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Getting Started"}),at.jsxs("div",{className:"space-y-3",children:[at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Quick Start Guide"})}),at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Character Creation"})}),at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"First Campaign"})})]})]}),at.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-6 border border-slate-700/50",children:[at.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Support"}),at.jsxs("div",{className:"space-y-3",children:[at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"FAQ"})}),at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Contact Support"})}),at.jsx("button",{className:"w-full text-left p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors",children:at.jsx("span",{className:"text-white",children:"Bug Report"})})]})]})]})]})}),ET=console.warn;console.warn=(...e)=>{const t=e[0];"string"==typeof t&&t.includes("Cross-Origin-Opener-Policy")||ET.apply(console,e)},ot.createRoot(document.getElementById("root")).render(at.jsx(a.StrictMode,{children:at.jsx(tT,{})}));export{Ea as T,Qn as U,at as j};
